<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-04-28 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 55: giteaのコードを読んだメモ</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 55: giteaのコードを読んだメモ</h1>
<p>
<a href="https://github.com/go-gitea/gitea">go-gitea/gitea</a>を読んだメモ。バックエンドは<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>で書かれている。
</p>

<div id="outline-container-org750da60" class="outline-2">
<h2 id="org750da60"><a href="#org750da60">memo</a></h2>
<div class="outline-text-2" id="text-org750da60">
</div>
<div id="outline-container-orgf0aac20" class="outline-3">
<h3 id="orgf0aac20"><a href="#orgf0aac20">コンパイル</a></h3>
<div class="outline-text-3" id="text-orgf0aac20">
<p>
コンパイルしている部分。タスク名が動的になっていてわかりにくい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/Makefile#L788-L789
</pre>
</div>

<div class="results" id="org98917df">
<p>
$(EXECUTABLE): $(GO_SOURCES) \((TAGS_PREREQ)
	CGO_CFLAGS="\)(CGO_CFLAGS)&ldquo; $(GO) build $(GOFLAGS) \((EXTRA_GOFLAGS) -tags '\)(TAGS)&rsquo; -ldflags &lsquo;-s -w $(LDFLAGS)&rsquo; -o $@
</p>

</div>
</div>
</div>

<div id="outline-container-org441c9ef" class="outline-3">
<h3 id="org441c9ef"><a href="#org441c9ef">routerを起動している部分</a></h3>
<div class="outline-text-3" id="text-org441c9ef">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/web.go#L211
</pre>
</div>

<div class="results" id="org1cbf2e0">
<p>
webRoutes := routers.NormalRoutes()
</p>

</div>
</div>
</div>

<div id="outline-container-org1ec4d60" class="outline-3">
<h3 id="org1ec4d60"><a href="#org1ec4d60">DB設定部分</a></h3>
<div class="outline-text-3" id="text-org1ec4d60">
<p>
setting packageにまとめられている。パッケージで変数化されている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>database</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/0999721c7b4d124c1f14bbd067acdcf767542abb/modules/setting/database.go#L27-L28
</pre>
</div>

<div class="results" id="org2b3ccee">
<p>
// Database holds the database settings
Database = struct {
</p>

</div>

<p>
変数はグローバル変数にしつつ↑、セットはパッケージ内の関数でやる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/setting/database.go#L59-L65
</pre>
</div>

<div class="results" id="org170d61a">
<p>
func loadDBSetting(rootCfg ConfigProvider) {
	sec := rootCfg.Section(&ldquo;database&rdquo;)
	Database.Type = DatabaseType(sec.Key(&ldquo;DB_TYPE&rdquo;).String())
</p>

<p>
Database.Host = sec.Key(&ldquo;HOST&rdquo;).String()
Database.Name = sec.Key(&ldquo;NAME&rdquo;).String()
Database.User = sec.Key(&ldquo;USER&rdquo;).String()
</p>

</div>
</div>
</div>

<div id="outline-container-org84e6793" class="outline-3">
<h3 id="org84e6793"><a href="#org84e6793">DB初期化部分</a></h3>
<div class="outline-text-3" id="text-org84e6793">
<p>
routerでのDBの初期化は↓でやっている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L132-L133
</pre>
</div>

<div class="results" id="orgc9a8903">
<p>
// InitEngine initializes the xorm.Engine and sets it as db.DefaultContext
func InitEngine(ctx context.Context) error {
</p>

</div>

<p>
InitEngineの中でデータベースを初期化する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>InitEngine(ctx context.Context) error 内で実行する</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L134
</pre>
</div>

<div class="results" id="org8bcb186">
<p>
xormEngine, err := newXORMEngine()
</p>

</div>

<p>
InitEngineの中でSetDefaultEngine()して初期化したデータベースをDefaultContextに設定する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<div class="results" id="org1738810">
<p>
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</p>

</div>

<p>
セットできているかの確認文。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/init.go#L136
</pre>
</div>

<div class="results" id="orgc788e04">
<p>
mustInitCtx(ctx, common.InitDBEngine)
</p>

</div>
</div>
</div>

<div id="outline-container-org92aa054" class="outline-3">
<h3 id="org92aa054"><a href="#org92aa054">変数default contextに設定する</a></h3>
<div class="outline-text-3" id="text-org92aa054">
<p>
設定している部分。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<div class="results" id="orga475182">
<p>
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</p>

</div>

<p>
テストとかではdefault contextを使って、dbを簡単に起動している。そうでない部分では、起動時に明示して上書きしているようだ。
</p>
</div>
</div>

<div id="outline-container-orgbd73546" class="outline-3">
<h3 id="orgbd73546"><a href="#orgbd73546">APIContextをセットしている部分</a></h3>
<div class="outline-text-3" id="text-orgbd73546">
<p>
DBのデータなどはcontext.APIContextで伝達している。APIContextにはBaseが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>APIContextの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L28-L43
</pre>
</div>

<div class="results" id="org5dd0ace">
<p>
// APIContext is a specific context for API service
type APIContext struct {
	*Base
</p>

<p>
Cache cache.Cache
</p>

<p>
Doer        *user_model.User // current signed-in user
IsSigned    bool
IsBasicAuth bool
</p>

<p>
ContextUser *user_model.User // the user which is being visited, in most cases it differs from Doer
</p>

<p>
	Repo    *Repository
	Org     *APIOrganization
	Package *Package
}
</p>

</div>

<p>
Baseにはcontext.Contextが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Baseの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/base.go#L31-L44
</pre>
</div>

<div class="results" id="orgd37fd25">
<p>
type Base struct {
	originCtx     context.Context
	contextValues []contextValuePair
</p>

<p>
Resp ResponseWriter
Req  *http.Request
</p>

<p>
<i>/ Data is prepared by ContextDataStore middleware, this field only refers to the pre-created/prepared ContextData.
/</i> Although it&rsquo;s mainly used for MVC templates, sometimes it&rsquo;s also used to pass data between middlewares/handler
Data middleware.ContextData
</p>

<p>
	// Locale is mainly for Web context, although the API context also uses it in some cases: message response, form validation
	Locale translation.Locale
}
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L223
</pre>
</div>

<div class="results" id="orgde06998">
<p>
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
</p>

</div>
</div>
</div>

<div id="outline-container-orge9262b6" class="outline-3">
<h3 id="orge9262b6"><a href="#orge9262b6">contextからdbインスタンスを取り出す</a></h3>
<div class="outline-text-3" id="text-orge9262b6">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/admin/task.go#L56
</pre>
</div>

<div class="results" id="org7d6064e">
<p>
has, err := db.GetEngine(ctx).ID(task.RepoID).Get(&amp;repo)
</p>

</div>
</div>
</div>

<div id="outline-container-org56f35e8" class="outline-3">
<h3 id="org56f35e8"><a href="#org56f35e8">DBコンテキストは異なる</a></h3>
<div class="outline-text-3" id="text-org56f35e8">
<p>
DBのためだけにありそう。defaultContextが入るのはこれ。contextを構造体に埋め込むのはよくないとされている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L29-L34
</pre>
</div>

<div class="results" id="org79a035f">
<p>
// Context represents a db context
type Context struct {
	context.Context
	e           Engine
	transaction bool
}
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>クエリを走らせるためのcontext</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L14-L16
</pre>
</div>

<div class="results" id="org785196d">
<p>
<i>/ DefaultContext is the default context to run xorm queries in
/</i> will be overwritten by Init with HammerContext
var DefaultContext context.Context
</p>

</div>

<p>
context.Contextはインターフェースなので、DefaultContextにはdb.Contextが入る。
</p>

<p>
このDBコンテキストは、Engine()を実装しているのでEnginedインターフェースを満たす。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L67-L90
</pre>
</div>

<div class="results" id="org57e6a35">
<p>
// Engined structs provide an Engine
type Engined interface {
	Engine() Engine
}
</p>

<p>
// GetEngine will get a db Engine from this context or return an Engine restricted to this context
func GetEngine(ctx context.Context) Engine {
	if e := getEngine(ctx); e != nil {
		return e
	}
	return x.Context(ctx)
}
</p>

<p>
// getEngine will get a db Engine from this context or return nil
func getEngine(ctx context.Context) Engine {
	if engined, ok := ctx.(Engined); ok {
		return engined.Engine()
	}
	enginedInterface := ctx.Value(enginedContextKey)
	if enginedInterface != nil {
		return enginedInterface.(Engined).Engine()
	}
	return nil
}
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L49-L52
</pre>
</div>

<div class="results" id="org8d20623">
<p>
// Engine returns db engine
func (ctx *Context) Engine() Engine {
	return ctx.e
}
</p>

</div>
</div>
</div>

<div id="outline-container-orgd684800" class="outline-3">
<h3 id="orgd684800"><a href="#orgd684800">DBオブジェクト宣言</a></h3>
<div class="outline-text-3" id="text-orgd684800">
<p>
xormのオブジェクト作成はxorm.NewEngine()で行う。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>func newXORMEngine() (*xorm.Engine, error) で実行している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L107
</pre>
</div>

<div class="results" id="org2a9a93e">
<p>
engine, err = xorm.NewEngine(&ldquo;postgresschema&rdquo;, connStr)
</p>

</div>
</div>
</div>

<div id="outline-container-org8c5e137" class="outline-3">
<h3 id="org8c5e137"><a href="#org8c5e137">テストで、どうやってDefaultContextをセットしているか</a></h3>
<div class="outline-text-3" id="text-org8c5e137">
<p>
テストでたくさん使っている。便利だ。これはいつセットされているか。
</p>

<p>
最初にunittest.PrepareTestDatabase()する。この中でDefaultContextに対してクエリが実行されている。そのあとDefaultContextを直に取得して実行する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/actions/runner_token_test.go#L16-L18
</pre>
</div>

<div class="results" id="org0cbe49d">
<p>
assert.NoError(t, unittest.PrepareTestDatabase())
token := unittest.AssertExistsAndLoadBean(t, &amp;ActionRunnerToken{ID: 3})
expectedToken, err := GetLatestRunnerToken(db.DefaultContext, 1, 0)
</p>

</div>

<p>
dbはcontextのvalueで持つべきじゃないらしい。リクエストスコープでないから。ダメじゃんと思ったけれども、contextの内部で持ってるわけではなく構造体で持ってるからいいのか。
</p>
</div>
</div>

<div id="outline-container-org86018a1" class="outline-3">
<h3 id="org86018a1"><a href="#org86018a1">APIコンテキストはどうやって生成しているか</a></h3>
<div class="outline-text-3" id="text-org86018a1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>リクエスト時の普通のcontextから、APIContextを生成している部分</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L243
</pre>
</div>

<div class="results" id="orga947c94">
<p>
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
			defer baseCleanUp()
</p>

<p>
ctx.Base.AppendContextValue(apiContextKey, ctx)
ctx.Base.AppendContextValueFunc(git.RepositoryContextKey, func() any { return ctx.Repo.GitRepo })
</p>

<p>
// If request sends files, parse them here otherwise the Query() can&rsquo;t be parsed and the CsrfToken will be invalid.
if ctx.Req.Method <code>= "POST" &amp;&amp; strings.Contains(ctx.Req.Header.Get("Content-Type"), "multipart/form-data") {
				if err :</code> ctx.Req.ParseMultipartForm(setting.Attachment.MaxSize &lt;&lt; 20); err != nil &amp;&amp; !strings.Contains(err.Error(), &ldquo;EOF&rdquo;) { // 32MB max size
		ctx.InternalServerError(err)
		return
	}
}
</p>

<p>
httpcache.SetCacheControlInHeader(ctx.Resp.Header(), 0, &ldquo;no-transform&rdquo;)
ctx.Resp.Header().Set(`X-Frame-Options`, setting.CORSConfig.XFrameOptions)
</p>

<p>
			next.ServeHTTP(ctx.Resp, ctx.Req)
		})
	}
}
</p>

</div>

<p>
ミドルウェアとして登録されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/api/v1/api.go#L807
</pre>
</div>

<div class="results" id="orgcad2425">
<p>
m.Use(context.APIContexter())
</p>

</div>

<p>
DB関係なくないか。どこでセットされているか。
</p>

<p>
トランザクションコンテキストは必要。なぜ。
</p>
</div>
</div>

<div id="outline-container-orgcfceff5" class="outline-3">
<h3 id="orgcfceff5"><a href="#orgcfceff5">マイグレーションコマンド</a></h3>
<div class="outline-text-3" id="text-orgcfceff5">
<p>
マイグレーションはタスクで行う。あるいは、Webの起動時にも関数が用意されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/migrate.go#L25
</pre>
</div>

<div class="results" id="org9f08e94">
<p>
func runMigrate(ctx *cli.Context) error {
</p>

</div>
</div>
</div>

<div id="outline-container-orgf49cb46" class="outline-3">
<h3 id="orgf49cb46"><a href="#orgf49cb46">テスト時にどうやってDB初期化されているか</a></h3>
<div class="outline-text-3" id="text-orgf49cb46">
<ul class="org-ul">
<li>マイグレーション</li>
<li>DefaultContext初期化</li>
</ul>

<p>
が必要なはずだが見当たらない。
</p>

<p>
unittest.PrepareTestDatabase() を見るが、そのときにはすでにDefaultContextからDBが取得できている。
</p>

<p>
各test packageにあるtest_main.goにある、TestMain関数内でunittest.MainTest()している。MainTest内でDBを初期化してる。テスト時に必ず実行される。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>初期化している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/unittest/testdb.go#L73
</pre>
</div>

<div class="results" id="orgb9bbbce">
<p>
func MainTest(m *testing.M, testOpts &#x2026;*TestOptions) {
</p>

</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
