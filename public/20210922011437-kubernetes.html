<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-05-30 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kubernetes</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">Kubernetes</h1>
<div id="outline-container-org1256f38" class="outline-2">
<h2 id="org1256f38"><a href="#org1256f38">概要</a></h2>
<div class="outline-text-2" id="text-org1256f38">
<p>
Kubernetesは複数の<a href="20210805005543-docker.html#ID-1658782a-d331-464b-9fd7-1f8233b8b7f8">Docker</a>コンテナを連携させるためのシステム。
</p>
</div>
</div>
<div id="outline-container-org006dd52" class="outline-2">
<h2 id="org006dd52"><a href="#org006dd52">Memo</a></h2>
<div class="outline-text-2" id="text-org006dd52">
</div>
<div id="outline-container-org1c4e2d9" class="outline-3">
<h3 id="org1c4e2d9"><a href="#org1c4e2d9">命令的な記述から宣言的な記述に移行する</a></h3>
<div class="outline-text-3" id="text-org1c4e2d9">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>エクスポートできる</label><pre class="src src-shell">kubectl run newdemo --image=cloudnatived/demo:hello --port=8888--labels <span class="org-variable-name">app</span>=newdemo <span class="org-comment-delimiter"># </span><span class="org-comment">&#12371;&#12398;&#12424;&#12358;&#12394;&#35373;&#23450;&#12364;&#12354;&#12427;&#12392;&#12377;&#12427;</span>
kubectl get deployments newdemo -o yaml --export &gt;deployment.yaml
</pre>
</div>
<p>
現在の設定をファイルにエクスポートして、それを<a href="20210901104129-git.html#ID-90c6b715-9324-46ce-a354-63d09403b066">Git</a>管理するとすばやく移行できる。
</p>
</div>
</div>
<div id="outline-container-org79a06dc" class="outline-3">
<h3 id="org79a06dc"><a href="#org79a06dc">差分チェック</a></h3>
<div class="outline-text-3" id="text-org79a06dc">
<div class="org-src-container">
<pre class="src src-shell">kubectl diff -f deployment.yaml
</pre>
</div>

<pre class="example">
-  replicas: 10
+  replicas: 5
</pre>
</div>
</div>
<div id="outline-container-org80405e2" class="outline-3">
<h3 id="org80405e2"><a href="#org80405e2">minikubeでlocalhost8080エラーが出たときの対応</a></h3>
<div class="outline-text-3" id="text-org80405e2">
<p>
kubectl runを実行すると実行できないときがある。
</p>
<pre class="example">
$ kubectl run ...
The connection to the server localhost:8080 was refused - did you specify the right host or port?
</pre>

<p>
落ち着いてstatusを確認する。
</p>
<pre class="example">
$ kubectl status

minikube
type: Control Plane
host: Stopped
kubelet: Stopped
apiserver: Stopped
kubeconfig: Stopped
</pre>

<p>
単に動いてないことがわかったので、起動する。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>起動する</label><pre class="src src-shell">$ minikube start
</pre>
</div>

<p>
再度kubectl runする。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>無事podが作成される</label><pre class="src src-shell">$ kubectl run ...
pod/demo created
</pre>
</div>
</div>
</div>

<div id="outline-container-org866ca1f" class="outline-3">
<h3 id="org866ca1f"><a href="#org866ca1f">kubectlでcontextを確認する</a></h3>
<div class="outline-text-3" id="text-org866ca1f">
<p>
kubectlが、どのコンテキストにいるか確認できる。
</p>
<div class="org-src-container">
<pre class="src src-shell">kubectl config current-context
</pre>
</div>

<div class="results" id="orgbdd53ac">
<p>
minikube
</p>

</div>

<p>
これは、minikube、つまりローカル環境のcontextにいて、Kubernetesとの通信のcontextにはなっていないことを示す。
</p>
</div>
</div>
<div id="outline-container-orgf9baa9b" class="outline-3">
<h3 id="orgf9baa9b"><a href="#orgf9baa9b">基本コマンド類</a></h3>
<div class="outline-text-3" id="text-orgf9baa9b">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>起動しているIPアドレスを調べる</label><pre class="src src-shell">minikube ip
</pre>
</div>

<div class="results" id="org145c9b6">
<p>
172.17.0.2
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>起動状況確認</label><pre class="src src-shell">minikube dashboard
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>作ったPod(postgres)を確認</label><pre class="src src-shell">kubectl describe deployment postgres
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>podsの情報確認</label><pre class="src src-shell">kubectl get Pods
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>起動サービスを開く。webappはサービス名</label><pre class="src src-shell">minikube service webapp
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>詳細情報</label><pre class="src src-shell">kubectl describe service webapp
</pre>
</div>

<div class="results" id="org328545b">
<p>
Name:                     webapp
Namespace:                default
Labels:                   app=webapp
Annotations:              &lt;none&gt;
Selector:                 app=webapp,tier=frontend
Type:                     NodePort
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.109.7.196
IPs:                      10.109.7.196
Port:                     &lt;unset&gt;  80/TCP
TargetPort:               80/TCP
NodePort:                 &lt;unset&gt;  30020/TCP
Endpoints:                172.18.0.6:80,172.18.0.7:80,172.18.0.8:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;
</p>

</div>

<p>
チェックしたIPアドレスにpostしてみて、データベースに値を保存・登録できるのを確認する。
</p>
</div>
</div>
<div id="outline-container-org19bfed3" class="outline-3">
<h3 id="org19bfed3"><a href="#org19bfed3">minikubeで試す</a></h3>
<div class="outline-text-3" id="text-org19bfed3">
<p>
Kubernetesをローカルで動かすことは難しいので、代替手段が必要。
minikubeによってローカルで試したり、開発に使うことができる。
</p>

<p>
<a href="https://github.com/kubernetes/minikube">kubernetes/minikube: Run Kubernetes locally</a>
</p>

<p>
導入手順。
<a href="https://minikube.sigs.k8s.io/docs/start/">minikube start | minikube</a>
</p>

<p>
kubectlも動かすために必要。
<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux">Install and Set Up kubectl on Linux | Kubernetes</a>
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>実行</label><pre class="src src-shell">minikube start
</pre>
</div>

<blockquote>
<p>
🏄  Done! kubectl is now configured to use &ldquo;minikube&rdquo; cluster and &ldquo;default&rdquo; namespace by default
</p>
</blockquote>

<p>
AWS上で動かすためにはまた別のインストールが必要。
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">KUBERNETES_PROVIDER</span>=aws; curl -sS https://get.k8s.io | bash
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7e7330c" class="outline-2">
<h2 id="org7e7330c"><a href="#org7e7330c">Tasks</a></h2>
<div class="outline-text-2" id="text-org7e7330c">
</div>
<div id="outline-container-orga7de9b4" class="outline-3">
<h3 id="orga7de9b4"><a href="#orga7de9b4"><span class="todo TODO">TODO</span> <a href="https://tech.drecom.co.jp/migrate-rails-app-to-container/">古き良きRailsアプリケーションをコンテナ化してKubernetes上で動かす - Tech Inside Drecom</a></a></h3>
</div>
</div>
<div id="outline-container-org19dbfce" class="outline-2">
<h2 id="org19dbfce"><a href="#org19dbfce">Reference</a></h2>
<div class="outline-text-2" id="text-org19dbfce">
</div>
<div id="outline-container-org9ac0fa9" class="outline-3">
<h3 id="org9ac0fa9"><a href="#org9ac0fa9"><a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">kelseyhightower/kubernetes-the-hard-way: Bootstrap Kubernetes the hard way on Google Cloud Platform. No scripts.</a></a></h3>
<div class="outline-text-3" id="text-org9ac0fa9">
<p>
kubernetesの仕組みから学ぶ。
</p>
</div>
</div>
<div id="outline-container-org44c6de9" class="outline-3">
<h3 id="org44c6de9"><a href="#org44c6de9"><a href="https://kubernetes.io/ja/docs/home/">Kubernetesドキュメント | Kubernetes</a></a></h3>
<div class="outline-text-3" id="text-org44c6de9">
<p>
公式ドキュメント。
</p>
</div>
</div>
<div id="outline-container-org288f8ce" class="outline-3">
<h3 id="org288f8ce"><a href="#org288f8ce"><a href="https://ja.wikipedia.org/wiki/Kubernetes">Kubernetes - Wikipedia</a></a></h3>
</div>
</div>
<div id="outline-container-orgefa50bf" class="outline-2">
<h2 id="orgefa50bf"><a href="#orgefa50bf">Archives</a></h2>
<div class="outline-text-2" id="text-orgefa50bf">
</div>
<div id="outline-container-org8dd4819" class="outline-3">
<h3 id="org8dd4819"><a href="#org8dd4819"><span class="done DONE">DONE</span> <a href="https://www.oreilly.co.jp/books/9784873119014/">O&rsquo;Reilly Japan - Kubernetesで実践するクラウドネイティブDevOps</a></a></h3>
<div class="outline-text-3" id="text-org8dd4819">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>説明に使うデモアプリをcloneする</label><pre class="src src-shell">git clone git://github.com/cloudnativedevops/demo.git
</pre>
</div>

<p>
マネージドkubernetesが絶対にいい。差別化につながらない面倒な作業は、アウトソーシングするべき。
リソースを解放してコアビジネスへ投入できるようになるから。
</p>

<p>
メトリクスは「なぜか」という疑問の解決に役立つ。動作している/してないの単純な判断を超えて、監視の新しい次元を切り開く。スピードメータや温度計のように、現在の状況に関する数値情報を与える。
メトリクスは、内部から監視する。従来のブラックボックス監視と異なる。
</p>

<p>
ソフトウェアはデフォルトで不透明である。ソフトウェア自体を測定できるようにして、何を実行しているかについて人間が推論できるよう情報を生成させることが必要。
</p>

<p>
4大シグナル。
</p>

<ul class="org-ul">
<li>リクエスト</li>
<li>エラー</li>
<li>持続期間</li>
<li>飽和度</li>
</ul>

<p>
<a href="https://github.com/prometheus/prometheus">prometheus/prometheus: The Prometheus monitoring system and time series database.</a> OSSの監視ツール。
</p>

<p>
クラウドネイティブの世界では、適切なメトリクスとオブザーバビリティデータがなければ、現在の状況を的確に把握するのは極めて難しくなる。
</p>

<p>
<a href="https://kubernetespodcast.com/">Kubernetes Podcast from Google</a> kubernetesのポッドキャスト。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
