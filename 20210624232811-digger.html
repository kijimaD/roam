<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-11-22 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ローグライク作り</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">ローグライク作り</h1>
<div id="outline-container-org00f2642" class="outline-2">
<h2 id="org00f2642"><a href="#org00f2642">概要</a></h2>
<div class="outline-text-2" id="text-org00f2642">
<p>
<a href="https://github.com/kijimaD/digger">https://github.com/kijimaD/digger</a>
<a href="https://github.com/kijimaD/digger_rs">https://github.com/kijimaD/digger_rs</a>
diggerはシンボルエンカウント/ローグライクな要素を持った<a href="20210926145504-game.html#ID-8b79aef9-1073-4788-9e81-68cc63e4f997">game</a>である。<a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a>バージョンは開発途中でやめた。<a href="20210901101339-rust.html#ID-ddc21510-6693-4c1e-9070-db0dd2a8160b">Rust</a>で別のコードをベースに再開した。ゲーム開発は静的型付けでないと厳しそう。
</p>

<ul class="org-ul">
<li>反省
<ul class="org-ul">
<li>機能追加が大変で挫折した</li>
<li>データがオブジェクトの入った配列で管理が大変だった。バケツリレーが発生</li>
<li>UIと機能が一体化</li>
<li>参考になるコードがなかった</li>
<li>自動テストで検知できない</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org99d1e25" class="outline-2">
<h2 id="org99d1e25"><a href="#org99d1e25">Goal</a></h2>
<div class="outline-text-2" id="text-org99d1e25">
<ul class="org-ul">
<li>ゲーム投稿サイト or Steamでリリースすること。</li>
</ul>
</div>
</div>
<div id="outline-container-orgf425276" class="outline-2">
<h2 id="orgf425276"><a href="#orgf425276">Design Doc</a></h2>
<div class="outline-text-2" id="text-orgf425276">
</div>
<div id="outline-container-org3be55be" class="outline-3">
<h3 id="org3be55be"><a href="#org3be55be">Characters</a></h3>
<div class="outline-text-3" id="text-org3be55be">
<ul class="org-ul">
<li>主人公</li>
<li>パーティメンバー</li>
<li>モンスター
<ul class="org-ul">
<li>シンボルが種族を示す。ロボット、戦車、珠、ドラゴン、ライム</li>
<li>種族・レベルごとの敵</li>
<li>ダンジョンのボス</li>
</ul></li>
<li>NPC
<ul class="org-ul">
<li>アイテム屋、装備屋、市民、合成屋</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgaa8d44b" class="outline-3">
<h3 id="orgaa8d44b"><a href="#orgaa8d44b">Story</a></h3>
<div class="outline-text-3" id="text-orgaa8d44b">
<ul class="org-ul">
<li>街を拠点に、遺跡の3つの珠を手に入れる</li>
</ul>
</div>
</div>
<div id="outline-container-org6959c1d" class="outline-3">
<h3 id="org6959c1d"><a href="#org6959c1d">Story progression</a></h3>
<div class="outline-text-3" id="text-org6959c1d">
<ul class="org-ul">
<li>ゲームは街からスタートする。街では売買でき、会話からヒントを得られる</li>
<li>遺跡のボスを倒すと珠を手に入れ、次の遺跡が選択できるようになる
<ul class="org-ul">
<li>ゾンビも考えたが、目標が生き残ることなので、方向付けの手間が増えそう。遺跡はわかりやすい</li>
</ul></li>
<li>3つ手に入れるとラスボスと戦いゲームクリア</li>
<li>クリア後は100階ダンジョン</li>
</ul>
</div>
</div>
<div id="outline-container-orge566cbc" class="outline-3">
<h3 id="orge566cbc"><a href="#orge566cbc">Gameplay</a></h3>
<div class="outline-text-3" id="text-orge566cbc">
<ul class="org-ul">
<li>ローグライク</li>
<li>シンボルエンカウント</li>
<li>RPG的戦闘</li>
<li>合成</li>
</ul>
</div>
</div>
<div id="outline-container-org3a312c2" class="outline-3">
<h3 id="org3a312c2"><a href="#org3a312c2">Goals</a></h3>
<div class="outline-text-3" id="text-org3a312c2">
<ul class="org-ul">
<li>全体: 3つの珠を集める</li>
<li>短期: 敵を倒して先に進む、出口を探す</li>
<li>落ちているアイテムを拾ったり合成することでより強くする</li>
<li>キャラを成長させる</li>
</ul>
</div>
</div>
<div id="outline-container-orgcba0918" class="outline-3">
<h3 id="orgcba0918"><a href="#orgcba0918">User Skills</a></h3>
<div class="outline-text-3" id="text-orgcba0918">
<ul class="org-ul">
<li>種類の異なるダンジョンを進む</li>
<li>戦略的な動き。AIの挙動や地形を理解して、生存可能性を高める</li>
<li>数値を管理する。装備品や行動のボーナスをうまく使って生存可能性を高める</li>
<li>資源を管理する。重さ、装備品の制約があるなかで、生存可能性を高める</li>
</ul>
</div>
</div>
<div id="outline-container-org495236e" class="outline-3">
<h3 id="org495236e"><a href="#org495236e">Items and Power-Ups</a></h3>
<div class="outline-text-3" id="text-org495236e">
<p>
ゲームは様々なアイテムを含む。
</p>

<ul class="org-ul">
<li>防具。アーマー、服、帽子、靴</li>
<li>装飾品。指輪、お守り</li>
<li>盾</li>
<li>近接武器</li>
<li>銃器</li>
<li>消耗品。回復薬、栄養剤、ロケット弾</li>
<li>素材、売却物</li>
<li>食料</li>
<li>キーアイテム。珠、鍵</li>
</ul>

<p>
アイテムには重さがある。
アイテムはテーブルにより決定する。
</p>
</div>
</div>
<div id="outline-container-org15ed987" class="outline-3">
<h3 id="org15ed987"><a href="#org15ed987">Progression and challenge</a></h3>
<div class="outline-text-3" id="text-org15ed987">
<ul class="org-ul">
<li>敵を倒すと経験値を得てレベルアップする</li>
<li>レベルアップして能力が上がったり、生存に役立つより強力な方法を使えるようになる</li>
<li>階を降りるごとにレベルと難易度が上がる。たまにレベルより強い敵に出会うことがある</li>
<li>理不尽な偶然でプレイヤーを殺さない</li>
</ul>
</div>
</div>
<div id="outline-container-org9989fd7" class="outline-3">
<h3 id="org9989fd7"><a href="#org9989fd7">Losing</a></h3>
<div class="outline-text-3" id="text-org9989fd7">
<ul class="org-ul">
<li>ゲームオーバーになった場合、得たアイテムやキャラクターを失う</li>
</ul>
</div>
</div>
<div id="outline-container-org94dfa6e" class="outline-3">
<h3 id="org94dfa6e"><a href="#org94dfa6e">Art Style</a></h3>
<div class="outline-text-3" id="text-org94dfa6e">
<ul class="org-ul">
<li>ASCII</li>
</ul>
</div>
</div>
<div id="outline-container-org980adbc" class="outline-3">
<h3 id="org980adbc"><a href="#org980adbc">Music and Sound</a></h3>
<div class="outline-text-3" id="text-org980adbc">
<ul class="org-ul">
<li>一切ない</li>
</ul>
</div>
</div>
<div id="outline-container-org51cc49c" class="outline-3">
<h3 id="org51cc49c"><a href="#org51cc49c">Technical Description</a></h3>
<div class="outline-text-3" id="text-org51cc49c">
<ul class="org-ul">
<li><a href="20210901101339-rust.html#ID-ddc21510-6693-4c1e-9070-db0dd2a8160b">Rust</a>, rltk</li>
<li>OpenGL, Web Assemblyに変換しブラウザでプレイできる</li>
<li>ローカルでの実行形式もサポートする</li>
</ul>
</div>
</div>
<div id="outline-container-org5146f6a" class="outline-3">
<h3 id="org5146f6a"><a href="#org5146f6a">Marketing and Funding</a></h3>
<div class="outline-text-3" id="text-org5146f6a">
<ul class="org-ul">
<li>無料で公開する</li>
</ul>
</div>
</div>
<div id="outline-container-orgd6341b3" class="outline-3">
<h3 id="orgd6341b3"><a href="#orgd6341b3">Localization</a></h3>
<div class="outline-text-3" id="text-orgd6341b3">
<ul class="org-ul">
<li>プレイは英語</li>
<li>ソースコードや開発用ドキュメントに日本語を含む</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5c60c1d" class="outline-2">
<h2 id="org5c60c1d"><a href="#org5c60c1d">仕様</a></h2>
<div class="outline-text-2" id="text-org5c60c1d">
<ul class="org-ul">
<li>プレイヤーの目的: 3つのダンジョンをクリアすること。</li>
<li>メッセージシーン、フィールド、戦闘で構成
<ul class="org-ul">
<li>フィールド上はローグライク</li>
</ul></li>
<li>空腹度が存在し、ゼロになるとダメージを受ける</li>
<li>4人パーティ構成
<ul class="org-ul">
<li>4つのスロットで武器・防具を選択できる</li>
<li>キャラはスキル、レベルを持つ</li>
</ul></li>
<li>3つのダンジョン
<ul class="org-ul">
<li>5階ごとの脱出機能を使う・遺跡のボスを倒すと帰れ、アイテムを持ち帰れる</li>
<li>ダンジョンによって敵・アイテム・マップのセットが変わる</li>
<li>後半のダンジョンは敵が強くなる</li>
</ul></li>
<li>ダンジョンは20階で構成される。最下層にはボスがいて、倒すとクリア</li>
<li>アイテム
<ul class="org-ul">
<li>通貨によってアイテムを購入できる</li>
<li>素材によってアイテムを作成できる</li>
<li>アイテムを入手できるタイミング: マップで拾う、購入、戦闘に勝利</li>
</ul></li>
<li>シンボルエンカウントの戦闘</li>
</ul>
</div>
</div>
<div id="outline-container-org1e71c9a" class="outline-2">
<h2 id="org1e71c9a"><a href="#org1e71c9a">Story</a></h2>
<div class="outline-text-2" id="text-org1e71c9a">
<ul class="org-ul">
<li>時代設定
<ul class="org-ul">
<li>世紀末</li>
<li>エネルギー単位マナ</li>
<li>マナを利用する古代技術と、現実的な科学技術</li>
<li>滅亡後に生き残った人類は、廃墟を捨て、「遺跡」に寄り集まって暮らしはじめた。遺跡周辺のオーパーツ、エネルギーをあてにして、探索者産業が生まれ、発展した</li>
<li>3つの遺跡が集中するSasuboの街</li>
<li>3つの珠を集めたあとどうするか問題。イベント面倒そうなんだよな。</li>
</ul></li>
<li>人物
<ul class="org-ul">
<li>主人公
<ul class="org-ul">
<li>どうして遺跡に来ることになったのか</li>
</ul></li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgf6f44b6" class="outline-3">
<h3 id="orgf6f44b6"><a href="#orgf6f44b6">章</a></h3>
<div class="outline-text-3" id="text-orgf6f44b6">
<p>
1章と2章に分ける。
</p>

<ul class="org-ul">
<li>1章: ストーリー性のある、低層の複数のダンジョン
<ul class="org-ul">
<li>ストーリー重視</li>
<li>時間制限がある
<ul class="org-ul">
<li>条件を満たしていないとゲームオーバー</li>
<li>条件を満たしているとボス戦、勝利すると2章に突入</li>
</ul></li>
<li>仲間を増やせる</li>
<li>仲間キャラクターに対する掘り下げ</li>
<li>各ダンジョンではイベントによって進行する</li>
</ul></li>
<li>2章: ストーリー性のない、1つの100階ダンジョン
<ul class="org-ul">
<li>やりこみ要素</li>
<li>より多様なアイテム、モンスター</li>
<li>ボス・イベントは存在しない</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb398e78" class="outline-2">
<h2 id="orgb398e78"><a href="#orgb398e78">ロードマップ</a></h2>
<div class="outline-text-2" id="text-orgb398e78">
</div>
<div id="outline-container-org29ccd70" class="outline-3">
<h3 id="org29ccd70"><a href="#org29ccd70">2022</a></h3>
<div class="outline-text-3" id="text-org29ccd70">
</div>
<div id="outline-container-orgfc7b53b" class="outline-4">
<h4 id="orgfc7b53b"><a href="#orgfc7b53b">7月</a></h4>
<div class="outline-text-4" id="text-orgfc7b53b">
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> すべてのチュートリアルを終了</li>
<li>hands-on Rustから持ってくる → 延期</li>
</ul>
</div>
</div>
<div id="outline-container-org2969acc" class="outline-4">
<h4 id="org2969acc"><a href="#org2969acc">8月</a></h4>
<div class="outline-text-4" id="text-org2969acc">
<ul class="org-ul">
<li>クリアまでいけるようにする</li>
<li>hands-on rustから持ってくる</li>
<li>タイル画像の変更</li>
<li>日本語表示
<ul class="org-ul">
<li>むりそう</li>
</ul></li>
<li>スキルシステム、パーティシステム
<ul class="org-ul">
<li>オリジナル部分</li>
</ul></li>
<li>ストーリー実装</li>
</ul>
</div>
</div>
<div id="outline-container-org7313839" class="outline-4">
<h4 id="org7313839"><a href="#org7313839">9月</a></h4>
</div>
<div id="outline-container-org8037af1" class="outline-4">
<h4 id="org8037af1"><a href="#org8037af1">10月</a></h4>
</div>
<div id="outline-container-org65e1f56" class="outline-4">
<h4 id="org65e1f56"><a href="#org65e1f56">11月</a></h4>
<div class="outline-text-4" id="text-org65e1f56">
<ul class="org-ul">
<li>仮完成。一通りプレイしてもらえるようにする</li>
<li>プレイしてもらって、フィードバックをもらう</li>
</ul>
</div>
</div>
<div id="outline-container-org83c35b0" class="outline-4">
<h4 id="org83c35b0"><a href="#org83c35b0">12月</a></h4>
</div>
</div>
<div id="outline-container-org5c5321f" class="outline-3">
<h3 id="org5c5321f"><a href="#org5c5321f">2023</a></h3>
<div class="outline-text-3" id="text-org5c5321f">
</div>
<div id="outline-container-orgcacc7c7" class="outline-4">
<h4 id="orgcacc7c7"><a href="#orgcacc7c7">1月</a></h4>
<div class="outline-text-4" id="text-orgcacc7c7">
<ul class="org-ul">
<li>リリース</li>
<li>プレスリリースを送る</li>
<li>ローグライクのユーザグループに投稿する</li>
<li>ついでに何か選考に送ってみる</li>
<li>人に紹介する</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org7b57287" class="outline-2">
<h2 id="org7b57287"><a href="#org7b57287">開発記録</a></h2>
<div class="outline-text-2" id="text-org7b57287">
<ul class="org-ul">
<li>難しいものと構えすぎてる気はする。よく見ていけばすべて単純で、それくらいは理解できるコードだ</li>
<li>実績システム、effectシステムすごい。汎用性高く、コードが整理される</li>
<li>毎回書いてるが、何も見ずに開発できてるわけじゃないことに危機感を感じている。また、今までと同じようにサンプルが出られずにやめてしまうのでは、何も残らないのではないか、と</li>
<li>重要なのはステップを踏むことだ。いきなり書けるようにはならないので、読む段階があるのは正しい。それから書く、修正しようとする流れをはさんで、身についてから書けるようになる</li>
<li>やっと理解できるようになってきた。しかし読むだけで、書けと言われれば出てこないし、スクラッチで書くのは全然わからない。まっさらな状態で考えてみると、どれだけ身になっているか試せる。今は全然ダメだが、段階的にすすめていけば問題ない。ただ、自覚することだ</li>
<li>チュートリアルから持ってきてる時間が長すぎて辛いな。自作パートに入らないと理解できてる感じがしないし、実際できてない</li>
<li>自分で修正できるようになるのか、使いこなせるようになるのか、という不安。実際ほとんどの場合は、見るだけでは理解できてない。何も見ずに考える状況にしないと、身につかないことが多かった</li>
<li>コーディングで役立つ重要な概念
<ul class="org-ul">
<li>モジュールを組み合わせてオブジェクトの性質を決める方法</li>
<li>継承を一切使わず、独立性高くゲームを組み立てていく方法</li>
<li>with関数で組み合わせて、一気にbuildする方法。とくにマップエンジン</li>
<li>フィルター。フィルターで複数のビルダーを組み合わせることができる</li>
<li>enumによる安全な分岐</li>
<li>jsonでデータを定義してビルドする方法</li>
</ul></li>
<li>読むときに明確にこれを理解する、と決めて読むとよさそうだ。これで洞窟を生成できる、これでもっとも大きい建物を求めることができる、とか</li>
<li>理解できることが増えたが、何も見ずに新しい機能追加できるとは到底言えない。どこか似たような箇所を探しながら、書いていくことしかできない</li>
</ul>
</div>
</div>
<div id="outline-container-org2e093b4" class="outline-2">
<h2 id="org2e093b4"><a href="#org2e093b4">memo</a></h2>
<div class="outline-text-2" id="text-org2e093b4">
</div>
<div id="outline-container-orgbe1e321" class="outline-3">
<h3 id="orgbe1e321"><a href="#orgbe1e321">コンポーネントを持っているか判定をスマートに書く</a></h3>
<div class="outline-text-3" id="text-orgbe1e321">
<p>
is_some() が便利。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>sourceがPlayer Componentを持っているときだけ実行する</label><pre class="src src-rust">if ecs.read_storage::&lt;Player&gt;().get(source).is_some() {
  ...
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org931192f" class="outline-3">
<h3 id="org931192f"><a href="#org931192f">RLTKの並列実行</a></h3>
<div class="outline-text-3" id="text-org931192f">
<p>
RLTKは同時に同じリソースを読み書きすることがないので、競合を心配する必要がない。read, writeが分かれているので、readだけだと並列実行して高速化したりもする。
</p>
</div>
</div>
<div id="outline-container-org350c9d1" class="outline-3">
<h3 id="org350c9d1"><a href="#org350c9d1">シグナルに徹する</a></h3>
<div class="outline-text-3" id="text-org350c9d1">
<p>
ステータスを返し、単にシグナルに徹する関数がある。本処理はシグナルを元に別でやる、というような分け方。そうすることで責務の分離ができ、かつシグナル側で共通化しやすい。本処理は全く別だが、シグナル自体は共通のことは多い。たとえば、使う、捨てるなどのアイテム画面。各種アイテム画面で表示する中身は異なるが、返したい内容は選択アイテムで同じ。キーボードハンドルも共通。違いはアクションだけ。
</p>
</div>
</div>
<div id="outline-container-org83fe1d1" class="outline-3">
<h3 id="org83fe1d1"><a href="#org83fe1d1">誤字</a></h3>
<div class="outline-text-3" id="text-org83fe1d1">
<ul class="org-ul">
<li>gui/cheat_menur.rs file is an easy refactor:</li>
</ul>
</div>
</div>
<div id="outline-container-org9230ce7" class="outline-3">
<h3 id="org9230ce7"><a href="#org9230ce7">systemからstateを変更する</a></h3>
<div class="outline-text-3" id="text-org9230ce7">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/amethyst/rustrogueliketutorial/blob/33872fe582f226178436847e1f74eafcbf9c0d1a/chapter-61-townportal/src/movement_system.rs#L32
</pre>
</div>

<div class="results" id="orgb82fec5">
<p>
*runstate = RunState::TeleportingToOtherLevel{ x: teleport.dest_x, y: teleport.dest_y, depth: teleport.dest_depth };
</p>

</div>
</div>
</div>

<div id="outline-container-org4eb2ee2" class="outline-3">
<h3 id="org4eb2ee2"><a href="#org4eb2ee2">なぜfetchでplayer_entityが取れるのか</a></h3>
<div class="outline-text-3" id="text-org4eb2ee2">
<p>
なぜできるかわからない。特定できないように見える。
</p>

<div class="org-src-container">
<pre class="src src-rust">let player_entity = ecs.fetch::&lt;Entity&gt;();
</pre>
</div>
</div>
</div>
<div id="outline-container-orge13a722" class="outline-3">
<h3 id="orge13a722"><a href="#orge13a722">component取得</a></h3>
<div class="outline-text-3" id="text-orge13a722">
<p>
getで特定のpoolを取得できる。
</p>

<div class="org-src-container">
<pre class="src src-rust">let target_pools = pools.get(wants_melee.target).unwrap(); # targetにはEntityが入ってる
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdfc68eb" class="outline-3">
<h3 id="orgdfc68eb"><a href="#orgdfc68eb">entity削除の方法</a></h3>
<div class="outline-text-3" id="text-orgdfc68eb">
<p>
entityを削除する。
</p>

<div class="org-src-container">
<pre class="src src-rust">ecs.delete_entity(entity).expect("Unable to delete");;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust">entities.delete(entity).expect("Delete failed")
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd09f249" class="outline-3">
<h3 id="orgd09f249"><a href="#orgd09f249">component削除の方法</a></h3>
<div class="outline-text-3" id="text-orgd09f249">
<p>
entityに付属したcomponentを削除する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>component削除</label><pre class="src src-rust">let entity = ecs.fetch::&lt;Entity&gt;();
combatants.remove(*entity);
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>component削除</label><pre class="src src-rust">let mut battle = ecs.write_storage::&lt;Battle&gt;();
battle.clear();
</pre>
</div>
</div>
</div>
<div id="outline-container-org12bf102" class="outline-3">
<h3 id="org12bf102"><a href="#org12bf102">entityを取得する2つの方法</a></h3>
<div class="outline-text-3" id="text-org12bf102">
<p>
fetchを使って取得すると、個別に取るのでイテレーションできない。entitiesだとイテレーションできる。
</p>
<div class="org-src-container">
<pre class="src src-rust">let entity = ecs.fetch::&lt;Entity&gt;();

let entities = ecs.entities();
</pre>
</div>
</div>
</div>
<div id="outline-container-org7cbd6e4" class="outline-3">
<h3 id="org7cbd6e4"><a href="#org7cbd6e4">entityをアイテム化</a></h3>
<div class="outline-text-3" id="text-org7cbd6e4">
<p>
position componentをremove + InBackPackをinsertで、落ちているアイテムをインベントリへ入れた扱いにする。自由にcomponentを付け外せる。
</p>

<div class="org-src-container">
<pre class="src src-rust">for pickup in wants_pickup.join() {
    positions.remove(pickup.item);
    backpack
        .insert(pickup.item, InBackpack { owner: pickup.collected_by })
        .expect("Unable to insert backpack entry");

    if pickup.collected_by == *player_entity {
        gamelog
            .entries
            .push(format!("You pick up the {}.", names.get(pickup.item).unwrap().name));
    }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org7d0a2fc" class="outline-3">
<h3 id="org7d0a2fc"><a href="#org7d0a2fc">モジュールを組み合わせる</a></h3>
<div class="outline-text-3" id="text-org7d0a2fc">
<p>
モジュールを組み合わせる方式でプログラムを設計する。
</p>

<p>
例えば、あまりよくないのは、敵という属性があってエンカウント可能にしたり、移動方法を決めることだ。それを、敵という属性、エンカウント可能という属性、移動方法の属性を作り、組み合わせて生成できるようにする。各機構は独立していて、変更しやすい。さらに、組み合わせることで新しい動きができる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>プレイヤーをスポーンするときの例 rust roguelike tutorialから</label><pre class="src src-rust">let player = ecs
    .create_entity()
    .with(Position { x: player_x, y: player_y })
    .with(Renderable {
        glyph: rltk::to_cp437('@'),
        fg: RGB::named(rltk::YELLOW),
        bg: RGB::named(rltk::BLACK),
        render_order: 0
    })
    .with(Player{})
    .with(Viewshed{ visible_tiles : Vec::new(), range: 8, dirty: true })
    .with(Name{name: "Player".to_string() })
    .build();
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>モンスターをスポーンするときの例。コンポーネントを組み合わせて、生成する</label><pre class="src src-rust">let monster = ecs
    .create_entity()
    .with(Position { x: x, y: y })
    .with(Renderable {
        glyph: rltk::to_cp437('g'),
        fg: RGB::named(rltk::YELLOW),
        bg: RGB::named(rltk::BLACK),
        render_order: 0
    })
    .with(Monster {})
    .with(Name{name: "Goblin".to_string() })
    .with(AiMove{})
    .build();
</pre>
</div>
</div>
</div>
<div id="outline-container-org52b0f2d" class="outline-3">
<h3 id="org52b0f2d"><a href="#org52b0f2d">jsonファイルからエンティティを生成する</a></h3>
<div class="outline-text-3" id="text-org52b0f2d">
<p>
ファイルから読み取った値を元に生成できると、データとロジックを分割できる。
</p>
</div>
</div>
<div id="outline-container-orgf53c3a8" class="outline-3">
<h3 id="orgf53c3a8"><a href="#orgf53c3a8">dispatcher model, message-passing system</a></h3>
<div class="outline-text-3" id="text-orgf53c3a8">
<p>
キューイング、リクエストと実装の分離。ダメージ発生、アニメーション発生、アイテム使用、をイベントとして同じように扱う。トリガー、対象、効果の組み合わせることで再利用性しやすくなる。リクエスト側は詳細を知ることなく扱えるため、コードが読みやすくなる。
</p>

<p>
なんらかのパラメータ変更を即座、何ターンかに渡ってもたらすものはeffect。永続的な属性、容れものを表すものはcomponent。がよさそう。
</p>
</div>
</div>
</div>
<div id="outline-container-org41309ff" class="outline-2">
<h2 id="org41309ff"><a href="#org41309ff">todo</a></h2>
<div class="outline-text-2" id="text-org41309ff">
</div>
<div id="outline-container-org61e0ce1" class="outline-3">
<h3 id="org61e0ce1"><a href="#org61e0ce1"><span class="todo TODO">TODO</span> 戦闘システム <code>[18/25]</code></a></h3>
<div class="outline-text-3" id="text-org61e0ce1">
</div>
<div id="outline-container-org505a2f6" class="outline-4">
<h4 id="org505a2f6"><a href="#org505a2f6"><span class="done DONE">DONE</span> 設計</a></h4>
<div class="outline-text-4" id="text-org505a2f6">
<p>
戦闘の実装を曖昧にしか考えてないので、図にまとめて実装できる状態にする。戦闘関連のリファクタの後に実装する。攻撃の属性。
</p>

<ul class="org-ul">
<li>攻撃方法選択メニュー</li>
<li>(↑によって)攻撃対象選択メニュー</li>
</ul>

<p>
戦闘用エンティティと分けたほうがいいのだろうか。
</p>

<p>
UIモックから考えてみよう。
</p>
</div>
</div>
<div id="outline-container-orgccfbca4" class="outline-4">
<h4 id="orgccfbca4"><a href="#orgccfbca4"><span class="done DONE">DONE</span> 攻撃方法選択UI作成</a></h4>
<div class="outline-text-4" id="text-orgccfbca4">
<p>
外側から作ってみる。ダミーで攻撃方法を選択できるようにした。
</p>
</div>
</div>

<div id="outline-container-org560b147" class="outline-4">
<h4 id="org560b147"><a href="#org560b147"><span class="done DONE">DONE</span> プレイヤーの攻撃方法の反映(かぎづめ、剣、パンチ)</a></h4>
<div class="outline-text-4" id="text-org560b147">
<p>
今はプレイヤーがダミーで選べるだけ。ダメージへの反映とログへ出せるようにする。
</p>

<p>
wants_to_meleeに攻撃方法の情報を追加するか。従来の方式は装備している武器をダメージの計算に使っている。これは望む挙動ではない。装備しているかではなく、コマンドで選択した攻撃方法を計算に使いたいし、ログに出したい。
</p>

<p>
攻撃方法はだいたい武器だが、モンスターは固有の「かぎづめ」とか使うので武器という名前にはしない。攻撃方法。weaponを指定しない場合はnatural attackで上書きすればよいか。
</p>

<p>
今の問題点。
</p>
<ul class="org-ul">
<li>敵が攻撃方法を選択できない</li>
<li>naturalやskillをエンティティに記載できない。シンボルと戦闘用が分離してないので</li>
</ul>
</div>
</div>
<div id="outline-container-org0c63fe1" class="outline-4">
<h4 id="org0c63fe1"><a href="#org0c63fe1"><span class="done DONE">DONE</span> シンボルエンティティと戦闘エンティティの分離(敵エンティティ)</a></h4>
<div class="outline-text-4" id="text-org0c63fe1">
<p>
シンボルエンティティと戦闘エンティティは1対多なので、戦闘関係をシンボルに書くことはできない。これが分離できれば、エンカウント時にランダム選択してモンスターを出せる。また、戦闘関係の記載ができるので、natural attack, skillを記載してデフォルトの攻撃手段を実装できる。
</p>

<p>
rawを別にすればいいのかな。新しい戦闘用entityの項目を作って、名前でspawnできるようにする。
</p>

<ul class="org-ul">
<li>味方キャラはcombatantを付け替えて戦闘対応している。同様に付け替えで主人公以外はrenderしない、positionを持たない、でいけそう
<ul class="org-ul">
<li>ややこしいから分けたい</li>
</ul></li>
<li>敵キャラは戦闘時にcombatant付きentityを生成して戦闘にしている</li>
<li>できれば敵味方で同じ生成にしたいのだが、ライフサイクルが異なる。敵は戦闘のたびに死に体力その他を保持する必要はないが、味方は保持している。いや、いけそうか。単にrawに味方フラグを追加すれば良いのでは</li>
</ul>
</div>
</div>
<div id="outline-container-org29724cd" class="outline-4">
<h4 id="org29724cd"><a href="#org29724cd"><span class="done DONE">DONE</span> god modeを移動</a></h4>
<div class="outline-text-4" id="text-org29724cd">
<p>
現在はpoolsのフィールドとして存在する。戦闘用なので、シンボルエンティティからpoolsは抜くので、別の場所に移動する
。
</p>
<ul class="org-ul">
<li>gold, initiative, weightも位置がおかしくなるな。だるい</li>
<li>戦闘以外のシンボルエンティティにつくフィールドを入れる構造体</li>
</ul>
</div>
</div>

<div id="outline-container-orga73d39c" class="outline-4">
<h4 id="orga73d39c"><a href="#orga73d39c"><span class="done DONE">DONE</span> goldを移動</a></h4>
<div class="outline-text-4" id="text-orga73d39c">
<p>
goldもpoolsが持ってる。
</p>

<p>
パーティの所持金(party.gold)と、モンスターそれぞれが持つ金(ドロップする金、pools.gold)を別にする。
</p>

<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> HUD</li>
<li class="on"><input type='checkbox' checked='checked' /> 売買</li>
<li class="on"><input type='checkbox' checked='checked' /> ドロップ</li>
</ul>
</div>
</div>

<div id="outline-container-org6951cab" class="outline-4">
<h4 id="org6951cab"><a href="#org6951cab"><span class="done DONE">DONE</span> initiative systemをpartyに移行</a></h4>
<div class="outline-text-4" id="text-org6951cab">
<p>
poolsの中にinitiative用のフィールドがあって邪魔。
</p>

<p>
これは戦闘用エンティティにつくのか、移動エンティティにつくのか。インベントリはpartyだが、装備は各戦闘entityだ。重さ制限はインベントリ限定にするしかなさそう。装備品の重さペナルティは各戦闘エンティティのステータスに反映することで完結でき、initiative systemは関係ない。
</p>

<p>
インベントリ+装備品の重さ制限の機構はよくできていて惜しいけどなあ。
</p>

<ul class="org-ul">
<li>戦闘用の装備品の重量/ペナルティは削除しよう</li>
<li>移動用の所持品の重量/ペナルティは保持</li>
</ul>
</div>
</div>

<div id="outline-container-org23c1661" class="outline-4">
<h4 id="org23c1661"><a href="#org23c1661"><span class="done DONE">DONE</span> シンボルエンティティと戦闘エンティティの分離(味方エンティティ)</a></h4>
<div class="outline-text-4" id="text-org23c1661">
<p>
計画。
</p>

<ul class="org-ul">
<li>@から戦闘関連を抜く。装備品関連も。装備品など、個人にかかるものはすべて戦闘用エンティティ対応になるのが大変そう</li>
<li>エンカウント時の戦闘処理を修正する。combatantの付け替えをやめる</li>
<li>ゲーム開始時に、味方の戦闘用エンティティを生成して、それを戦闘に使う。体力などは戦闘用エンティティが持つ</li>
</ul>

<p>
メモ。
</p>

<ul class="org-ul">
<li>戦闘関連を抜いてみたらhudでエラー。体力関連だろう</li>
<li>戦闘エンティティから対応するシンボルエンティティを引くのをどうするか。Partyに入れてもよさそう。うん、基本戦闘エンティティを直に持ってくるのでなく、シンボルエンティティのParty経由のほうがアクセスもしやすそう</li>
<li>味方以外はエンカウント時に逐次生成なので、考えなくてよい</li>
<li>componentでベクタを定義すると、saveloadマクロでダメといわれる。なので保持させられない</li>
<li>battle -&gt; field と field -&gt; battleを両方辿れるようにしたいが</li>
</ul>
</div>
</div>

<div id="outline-container-orgfbc1083" class="outline-4">
<h4 id="orgfbc1083"><a href="#orgfbc1083"><span class="done DONE">DONE</span> アイテム使用が効かなくなっている</a></h4>
<div class="outline-text-4" id="text-orgfbc1083">
<p>
選択した戦闘エンティティに適用する。
</p>

<ul class="org-ul">
<li>itemにtarget typeを持たせて、戦闘用、シンボルエンティティ用、と分けるようにする</li>
<li>targetはアイテムというよりはeffectに従属してるな</li>
<li>consumableに入れたら、武器とかがおかしくなるな。装備品は常に戦闘用targetを取る。いや、むしろconsumableがターゲット違う可能性があって特殊なので良さそうな気もする</li>
<li>アイテム個別に付与するというよりカテゴリに対して分岐させたい。が、コンポーネント形式なのでカテゴリに相当するものはない。組み合わせの自由から得られるメリットの負の側面</li>
<li>Target componentを作ったほうがいいのかな。中身にenumを入れて</li>
<li>せめて状態にenumを使うべきだな</li>
</ul>
</div>
</div>

<div id="outline-container-orgd0180b7" class="outline-4">
<h4 id="orgd0180b7"><a href="#orgd0180b7"><span class="done DONE">DONE</span> Attributesをbattle entityに移行</a></h4>
<div class="outline-text-4" id="text-orgd0180b7">
</div>
</div>

<div id="outline-container-orgef8d260" class="outline-4">
<h4 id="orgef8d260"><a href="#orgef8d260"><span class="done DONE">DONE</span> 装備品をbattle entityに移行</a></h4>
<div class="outline-text-4" id="text-orgef8d260">
</div>
</div>

<div id="outline-container-orgd4a90c3" class="outline-4">
<h4 id="orgd4a90c3"><a href="#orgd4a90c3"><span class="done DONE">DONE</span> naturalをbattle entityに移行</a></h4>
<div class="outline-text-4" id="text-orgd4a90c3">
</div>
</div>

<div id="outline-container-org4d7e30f" class="outline-4">
<h4 id="org4d7e30f"><a href="#org4d7e30f"><span class="done DONE">DONE</span> loot tableをどうするか</a></h4>
<div class="outline-text-4" id="text-org4d7e30f">
<p>
戦闘エンティティのlootと、フィールドエンティティのloot両方にする。
</p>

<ul class="org-ul">
<li>戦闘では素材を落とし、自動格納される</li>
<li>フィールドでは確率で使用アイテムをマップに落とす(すでに実装ずみのをそのまま使う)</li>
</ul>
</div>
</div>

<div id="outline-container-orga531811" class="outline-4">
<h4 id="orga531811"><a href="#orga531811"><span class="done DONE">DONE</span> 敵を倒した後に情報を見られるようにする</a></h4>
<div class="outline-text-4" id="text-orga531811">
<p>
現在はHPが0になった瞬間、経験値追加してる。レベルアップがわからないし、戦闘の勝利に対して経験値を発行するようにしたい。battle自体に取得予定の経験値を保存して、戦闘が終了したときに確定すればよさそうか。また、戦闘勝利以外でレベルア
ップすることはないので、そのへんの表示も変更する。
</p>
</div>
</div>

<div id="outline-container-orgfd04cbe" class="outline-4">
<h4 id="orgfd04cbe"><a href="#orgfd04cbe"><span class="done DONE">DONE</span> 仲間GUIを作る</a></h4>
<div class="outline-text-4" id="text-orgfd04cbe">
<p>
装備品とか、ステータスは各キャラごとなので、見られるように画面を追加する。装備品、ステータスウィンドウは共通にする。マウスオーバーは汎用性が高そうだが、カーソル位置と対応させるのが難しい。できた。
</p>
</div>
</div>

<div id="outline-container-orgb5d877f" class="outline-4">
<h4 id="orgb5d877f"><a href="#orgb5d877f"><span class="todo TODO">TODO</span> エンカウント時のモンスター決定</a></h4>
<div class="outline-text-4" id="text-orgb5d877f">
<p>
現在は固定している。
</p>

<ul class="org-ul">
<li>戦闘の難易度を決める要素
<ul class="org-ul">
<li>レベル
<ul class="org-ul">
<li>敵のレベルが上がると攻撃、防御に補正がかかり倒しにくくなる。基本ステータスは変わらない</li>
</ul></li>
<li>敵の種類
<ul class="org-ul">
<li>浅い階層では軽戦車だが、深い階層では重戦車といった具合</li>
<li>基本ステータスが高くなる</li>
<li>行動パターンが変わり、より強力な技を使うようになる。技にはダメージのほかに属性、状態異常付きがある</li>
</ul></li>
</ul></li>

<li>階層
<ul class="org-ul">
<li>深くなるほど強くなる</li>
<li>シンボルの割合が変わる。ドラゴンのシンボルは後半にしか出ない</li>
</ul></li>
<li>接触したmapエンティティ
<ul class="org-ul">
<li>シンボルによってテーブルが変わる</li>
</ul></li>
<li>ダンジョン種別
<ul class="org-ul">
<li>後半のダンジョンになるほど、難易度が高くなる</li>
<li>シンボルの割合が変わる</li>
<li>森の遺跡</li>
<li>塔の遺跡</li>
<li>山の遺跡</li>
<li>地下基地
<ul class="org-ul">
<li>100階ダンジョン</li>
</ul></li>
</ul></li>
</ul>

<p>
から、エンカウントモンスターを決定する。2体出るときもある。map生成時のエンティティ配置と似たような感じでいけそうか。
</p>

<p>
何によって難易度が高くなるかということで、重要な箇所の気がするな。とりあえずはシンボルに基づいて戦闘モンスターを決定できるようにする。フロア関係なく。
</p>

<ul class="org-ul">
<li>戦闘エンティティのrawにカテゴリを追加する</li>
<li>戦闘エンティティをカテゴリ内からランダムに選べるようにする</li>
</ul>
</div>
</div>

<div id="outline-container-orga650e0d" class="outline-4">
<h4 id="orga650e0d"><a href="#orga650e0d"><span class="done DONE">DONE</span> 人数分のコマンド選択</a></h4>
<div class="outline-text-4" id="text-orga650e0d">
<p>
それぞれのキャラクターでコマンドを選択できるようにする。
</p>
</div>
</div>
<div id="outline-container-orga88cb64" class="outline-4">
<h4 id="orga88cb64"><a href="#orga88cb64"><span class="done DONE">DONE</span> 味方戦闘エンティティをrawから生成</a></h4>
<div class="outline-text-4" id="text-orga88cb64">
<p>
すべて同じステータスだと切り替わっているかわかりづらい。
</p>
</div>
</div>

<div id="outline-container-orgf7d849c" class="outline-4">
<h4 id="orgf7d849c"><a href="#orgf7d849c"><span class="todo TODO">TODO</span> 装備のスロット制限追加</a></h4>
<div class="outline-text-4" id="text-orgf7d849c">
<ul class="org-ul">
<li>部位ごとに1つ装備できる</li>
<li>装飾品、武器は部位制限がない</li>
<li>スロットは全部で4つ</li>
<li>装備してないときは空きスロットとして表示する</li>
</ul>
</div>
</div>

<div id="outline-container-orgb210ec3" class="outline-4">
<h4 id="orgb210ec3"><a href="#orgb210ec3"><span class="todo TODO">TODO</span> 戦闘loot処理追加</a></h4>
<div class="outline-text-4" id="text-orgb210ec3">
<ul class="org-ul">
<li>戦闘後素材アイテム獲得処理を追加する
<ul class="org-ul">
<li>とりあえず消費アイテムをインベントリに入れる</li>
</ul></li>
<li>戦闘のリザルト画面で処理と表示を追加する
<ul class="org-ul">
<li>獲得素材一覧</li>
<li>各仲間の経験値</li>
<li>獲得gold</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org5389c0f" class="outline-4">
<h4 id="org5389c0f"><a href="#org5389c0f"><span class="todo TODO">TODO</span> SP…武器やスキルの使用にはスタミナが必要</a></h4>
<div class="outline-text-4" id="text-org5389c0f">
<ul class="org-ul">
<li>アイテムに消費SPフィールドを追加する</li>
<li>攻撃時に消費する処理を追加する</li>
</ul>
</div>
</div>

<div id="outline-container-org21f7c54" class="outline-4">
<h4 id="org21f7c54"><a href="#org21f7c54"><span class="done DONE">DONE</span> 戦闘終了時にgold, xpを確定する</a></h4>
<div class="outline-text-4" id="text-org21f7c54">
<p>
現在、複数の敵がいた場合、倒した瞬間にgold, xpを入手している状態。戦闘勝利時に確定してリザルト画面に表示したい。
</p>
</div>
</div>
<div id="outline-container-org4950ee8" class="outline-4">
<h4 id="org4950ee8"><a href="#org4950ee8"><span class="todo TODO">TODO</span> 防御力のcomponent化</a></h4>
<div class="outline-text-4" id="text-org4950ee8">
<p>
防御力の値をステータス画面で表示できるようにしたい。
</p>
</div>
</div>
<div id="outline-container-orgb12cc6d" class="outline-4">
<h4 id="orgb12cc6d"><a href="#orgb12cc6d"><span class="todo TODO">TODO</span> 装備外しできるようにする</a></h4>
<div class="outline-text-4" id="text-orgb12cc6d">
<p>
装備外しができない状態。キー操作以外の表示は装備画面と同じで、外す画面を作成する。
</p>
</div>
</div>
<div id="outline-container-orgad942cb" class="outline-4">
<h4 id="orgad942cb"><a href="#orgad942cb"><span class="todo TODO">TODO</span> 1人死ぬだけでゲームオーバーになる</a></h4>
<div class="outline-text-4" id="text-orgad942cb">
<p>
全滅したらゲームオーバーにしたい。
</p>
</div>
</div>
</div>

<div id="outline-container-org1483218" class="outline-3">
<h3 id="org1483218"><a href="#org1483218"><span class="todo TODO">TODO</span> 複数のダンジョンに対応する</a></h3>
<div class="outline-text-3" id="text-org1483218">
<p>
今はすべて1つのダンジョンになっていて、B2は森、B3は洞窟、というように固定されている。ダンジョンを選択して入るタイプとは合わないので、対応させる。
</p>

<ul class="org-ul">
<li>街</li>
<li>ダンジョンA(B20)</li>
<li>ダンジョンB(B10)</li>
<li>ダンジョンC(B100)</li>
</ul>

<p>
というように最大階層も変えたい。街の出口で選択できるようにすれば良いか。クリアするごとに選択肢が増える。今のマップ関係の実装がよくわかってないんだよな。depthはあるものの、内部的なものっぽい。
</p>
</div>
</div>

<div id="outline-container-orgaa90546" class="outline-3">
<h3 id="orgaa90546"><a href="#orgaa90546"><span class="todo TODO">TODO</span> パーティシステム</a></h3>
<div class="outline-text-3" id="text-orgaa90546">
<p>
現在のコマンドのstate遷移は複数の味方キャラに対応してない。
</p>
</div>
</div>

<div id="outline-container-orgc23bed0" class="outline-3">
<h3 id="orgc23bed0"><a href="#orgc23bed0"><span class="todo TODO">TODO</span> アイテム合成</a></h3>
<div class="outline-text-3" id="text-orgc23bed0">
</div>
<div id="outline-container-org9dee14e" class="outline-4">
<h4 id="org9dee14e"><a href="#org9dee14e"><span class="todo TODO">TODO</span> 素材アイテムを追加</a></h4>
</div>
<div id="outline-container-org1ac37b4" class="outline-4">
<h4 id="org1ac37b4"><a href="#org1ac37b4"><span class="todo TODO">TODO</span> UI作成</a></h4>
</div>
</div>
<div id="outline-container-orga632ad8" class="outline-3">
<h3 id="orga632ad8"><a href="#orga632ad8"><span class="todo TODO">TODO</span> スキル設計</a></h3>
<div class="outline-text-3" id="text-orga632ad8">
<p>
戦闘や行動によってスキルが上がり、生存に有利な補正がかかる。
</p>
</div>
</div>
<div id="outline-container-org1b0876f" class="outline-3">
<h3 id="org1b0876f"><a href="#org1b0876f"><span class="todo TODO">TODO</span> スロット・部位ごとの装備</a></h3>
<div class="outline-text-3" id="text-org1b0876f">
<p>
4つのスロットがあり自由に装備できる。同じ部位の装備はできない。
</p>
</div>
</div>
<div id="outline-container-orgc4b2eb4" class="outline-3">
<h3 id="orgc4b2eb4"><a href="#orgc4b2eb4"><span class="todo TODO">TODO</span> アイテム欄のペジネーション</a></h3>
<div class="outline-text-3" id="text-orgc4b2eb4">
<p>
たくさん拾ったときに表示があふれるので。複数あるアイテム系で共通の処理・表示・操作にしたい。
</p>
</div>
</div>
<div id="outline-container-orgfde7de2" class="outline-3">
<h3 id="orgfde7de2"><a href="#orgfde7de2"><span class="todo TODO">TODO</span> マップのシード値を取れるようにする</a></h3>
<div class="outline-text-3" id="text-orgfde7de2">
<p>
シードを指定すると同じマップを生成できる。デバッグで便利。
</p>
</div>
</div>
<div id="outline-container-org1996761" class="outline-3">
<h3 id="org1996761"><a href="#org1996761"><span class="todo TODO">TODO</span> エンカウント時のアニメーション</a></h3>
<div class="outline-text-3" id="text-org1996761">
<p>
アニメーションを入れる。とくに戦闘に背景画像を設定してから、急に明度が変わるので目にも悪い。
</p>
</div>
</div>
<div id="outline-container-orgcbab39e" class="outline-3">
<h3 id="orgcbab39e"><a href="#orgcbab39e"><span class="todo TODO">TODO</span> 最低限のテストを作成、CI実行する</a></h3>
<div class="outline-text-3" id="text-orgcbab39e">
<p>
自動テストをやりたいが、どうやったらいいのかわからない。ログをテキストファイルに書き出すようにすれば、チェックできるのでは。結局正しく挙動しているかはわからないが、実行時エラーにならないのはわかる。
</p>
</div>
</div>

<div id="outline-container-orgebd9806" class="outline-3">
<h3 id="orgebd9806"><a href="#orgebd9806"><span class="todo TODO">TODO</span> cargoに登録する</a></h3>
<div class="outline-text-3" id="text-orgebd9806">
<p>
cargo installでもすぐ実行できるようにする。
</p>
</div>
</div>
<div id="outline-container-orgeda7c67" class="outline-3">
<h3 id="orgeda7c67"><a href="#orgeda7c67"><span class="todo TODO">TODO</span> 画面エフェクト追加</a></h3>
<div class="outline-text-3" id="text-orgeda7c67">
<p>
追加はchapter63が参考になりそう。
</p>

<p>
<a href="https://bfnightly.bracketproductions.com/chapter_63.html">https://bfnightly.bracketproductions.com/chapter_63.html</a>
</p>
</div>
</div>
<div id="outline-container-org01d8aa7" class="outline-3">
<h3 id="org01d8aa7"><a href="#org01d8aa7"><span class="todo TODO">TODO</span> ミニマップ表示</a></h3>
<div class="outline-text-3" id="text-org01d8aa7">
<p>
周囲の概略を表示する。アイテム、敵、階段だけを視界内に限定すれば。
</p>

<p>
視野限定をやめれば、実装しなくてよさそう。
</p>
</div>
</div>
<div id="outline-container-orgb698039" class="outline-3">
<h3 id="orgb698039"><a href="#orgb698039"><span class="todo TODO">TODO</span> カメラをどう実装しているか</a></h3>
<div class="outline-text-3" id="text-orgb698039">
<p>
いまいち理解してないままだ。
</p>
</div>
</div>
<div id="outline-container-org7e1df9f" class="outline-3">
<h3 id="org7e1df9f"><a href="#org7e1df9f"><span class="todo TODO">TODO</span> ランダムテーブルの重み付けの方法</a></h3>
<div class="outline-text-3" id="text-org7e1df9f">
<p>
ピンと来てない。
</p>
</div>
</div>
<div id="outline-container-org95a2067" class="outline-3">
<h3 id="org95a2067"><a href="#org95a2067"><span class="todo TODO">TODO</span> アイテムのレア度で色を変える</a></h3>
<div class="outline-text-3" id="text-org95a2067">
<ul class="org-ul">
<li>レア度の実装</li>
<li>色を変える</li>
</ul>
</div>
</div>
<div id="outline-container-org81ec17c" class="outline-3">
<h3 id="org81ec17c"><a href="#org81ec17c"><span class="todo TODO">TODO</span> 最初から視界オープン状態にする</a></h3>
<div class="outline-text-3" id="text-org81ec17c">
<p>
探索がだるいので、可視状態にする。アイテムや敵は視界内でないと見えない。
</p>
</div>
</div>
<div id="outline-container-org78a3835" class="outline-3">
<h3 id="org78a3835"><a href="#org78a3835"><span class="todo TODO">TODO</span> アイテムと階段が重なって見えなくなるときがある</a></h3>
<div class="outline-text-3" id="text-org78a3835">
<p>
アイテムを拾えない+階段が発見できなくなるので、階段上に生成しなくするか、常に階段を上に表示する。
</p>
</div>
</div>
<div id="outline-container-org4fef548" class="outline-3">
<h3 id="org4fef548"><a href="#org4fef548"><span class="todo TODO">TODO</span> Partyに楽にアクセスするAPIがほしい</a></h3>
<div class="outline-text-3" id="text-org4fef548">
<p>
いちいちentitiesから取り出すのが面倒。だいたいの場合戦闘用エンティティも絡むのでコードが複雑化する。簡単にアクセスできるようにしたい。
</p>
</div>
</div>
<div id="outline-container-org010a56d" class="outline-3">
<h3 id="org010a56d"><a href="#org010a56d"><span class="todo TODO">TODO</span> オープニング画面</a></h3>
<div class="outline-text-3" id="text-org010a56d">
<p>
ロゴ表示とかするとそれっぽい。
</p>
</div>
</div>

<div id="outline-container-orgaa829da" class="outline-3">
<h3 id="orgaa829da"><a href="#orgaa829da"><span class="todo TODO">TODO</span> 逃げた回数の実績カウンタ追加</a></h3>
<div class="outline-text-3" id="text-orgaa829da">
<p>
ドラクエ8にあったような感じで。
</p>
</div>
</div>
<div id="outline-container-orgf6de97c" class="outline-3">
<h3 id="orgf6de97c"><a href="#orgf6de97c"><span class="todo TODO">TODO</span> バッジ型実績追加</a></h3>
<div class="outline-text-3" id="text-orgf6de97c">
<p>
カウンタに追加して、何かを達成した or 達成してない のバッジ型の実績を実装する。
</p>
</div>
</div>
<div id="outline-container-org8cfee70" class="outline-3">
<h3 id="org8cfee70"><a href="#org8cfee70"><span class="todo TODO">TODO</span> ゲームオーバーになったあと再開すると味方battle entityがない状態でスタートする</a></h3>
<div class="outline-text-3" id="text-org8cfee70">
<p>
死ぬと味方でもbattle entityが消えてしまうので、再生成しないといけない。味方は消さないようにしたいが。
</p>
</div>
</div>

<div id="outline-container-org85fe7aa" class="outline-3">
<h3 id="org85fe7aa"><a href="#org85fe7aa"><span class="todo TODO">TODO</span> gitバージョンごとにビルドしてデプロイして、バージョン間の動作確認をしやすくする</a></h3>
<div class="outline-text-3" id="text-org85fe7aa">
<p>
動作確認用。いくつか前に戻って確認したいことが割とある。WASMを同じページに展開すればよさそう。
</p>
</div>
</div>

<div id="outline-container-orgae384e4" class="outline-3">
<h3 id="orgae384e4"><a href="#orgae384e4"><span class="todo TODO">TODO</span> 武器のカテゴリを追加</a></h3>
<div class="outline-text-3" id="text-orgae384e4">
<p>
刀とかライフルとか。
</p>
</div>
</div>

<div id="outline-container-orgd4d5d82" class="outline-3">
<h3 id="orgd4d5d82"><a href="#orgd4d5d82"><span class="todo TODO">TODO</span> デバッグ用の体力全回復が壊れている</a></h3>
<div class="outline-text-3" id="text-orgd4d5d82">
<p>
実行すると強制終了する。
</p>
</div>
</div>
</div>
<div id="outline-container-org39d48d3" class="outline-2">
<h2 id="org39d48d3"><a href="#org39d48d3">References</a></h2>
<div class="outline-text-2" id="text-org39d48d3">
<blockquote>
<dl class="org-dl">
<dt><a href="http://www.roguebasin.com/index.php/Articles">http://www.roguebasin.com/index.php/Articles</a></dt><dd>ローグライクに関する情報が集約されている。</dd>
<dt><a href="http://www.roguebasin.com/index.php?title=How_to_Write_a_Roguelike_in_15_Steps">http://www.roguebasin.com/index.php?title=How_to_Write_a_Roguelike_in_15_Steps</a></dt><dd>ローグライクの作り方のヒント。</dd>
<dt><a href="https://countable.hatenablog.com/entry/20120717/1342505647">https://countable.hatenablog.com/entry/20120717/1342505647</a></dt><dd>↑ページの和訳</dd>
<dt><a href="https://techblog.sega.jp/entry/2018/08/27/100000">https://techblog.sega.jp/entry/2018/08/27/100000</a></dt><dd>ゲームのテスト</dd>
<dt><a href="https://www.amazon.co.jp/Programming-Patterns-%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%96%8B%E7%99%BA%E3%81%AE%E5%95%8F%E9%A1%8C%E8%A7%A3%E6%B1%BA%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC-impress-gear%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-ebook/dp/B015R0M8W0/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;dchild=1&amp;keywords=%E3%82%B2%E3%83%BC%E3%83%A0+%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3&amp;qid=1627347211&amp;sr=8-1">https://www.amazon.co.jp/Programming-Patterns-%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%96%8B%E7%99%BA%E3%81%AE%E5%95%8F%E9%A1%8C%E8%A7%A3%E6%B1%BA%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC-impress-gear%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-ebook/dp/B015R0M8W0/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;dchild=1&amp;keywords=%E3%82%B2%E3%83%BC%E3%83%A0+%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3&amp;qid=1627347211&amp;sr=8-1</a></dt><dd>ゲームデザインパターン</dd>
<dt><a href="https://www.amazon.co.jp/Hands-Rust-English-Herbert-Wolverson-ebook/dp/B09BK8Q6GY/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;crid=26DQRMWP5RQIE&amp;keywords=hands-on+rust&amp;qid=1651655347&amp;sprefix=hands-on+ru%2Caps%2C196&amp;sr=8-1">https://www.amazon.co.jp/Hands-Rust-English-Herbert-Wolverson-ebook/dp/B09BK8Q6GY/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;crid=26DQRMWP5RQIE&amp;keywords=hands-on+rust&amp;qid=1651655347&amp;sprefix=hands-on+ru%2Caps%2C196&amp;sr=8-1</a></dt><dd>2Dゲームのハンズオン</dd>
</dl>
</blockquote>
</div>
</div>
<div id="outline-container-orgb27fad5" class="outline-2">
<h2 id="orgb27fad5"><a href="#orgb27fad5">Archives</a></h2>
<div class="outline-text-2" id="text-orgb27fad5">
</div>
<div id="outline-container-orga20d606" class="outline-3">
<h3 id="orga20d606"><a href="#orga20d606"><span class="done DONE">DONE</span> 移動システム</a></h3>
<div class="outline-text-3" id="text-orga20d606">
<ul class="org-ul">
<li>地形判定</li>
</ul>
</div>
</div>
<div id="outline-container-org26c1a45" class="outline-3">
<h3 id="org26c1a45"><a href="#org26c1a45"><span class="done DONE">DONE</span> マップをtxtファイルから読み込む</a></h3>
<div class="outline-text-3" id="text-org26c1a45">
</div>
</div>
<div id="outline-container-org5e6dfd2" class="outline-3">
<h3 id="org5e6dfd2"><a href="#org5e6dfd2"><span class="done DONE">DONE</span> mainファイル分割</a></h3>
<div class="outline-text-3" id="text-org5e6dfd2">
<p>
同じ形にした。
</p>
</div>
</div>
<div id="outline-container-orgfc4f44f" class="outline-3">
<h3 id="orgfc4f44f"><a href="#orgfc4f44f"><span class="done DONE">DONE</span> テスト追加</a></h3>
<div class="outline-text-3" id="text-orgfc4f44f">
</div>
</div>
<div id="outline-container-orgac6ba76" class="outline-3">
<h3 id="orgac6ba76"><a href="#orgac6ba76"><span class="done DONE">DONE</span> テスト環境構築</a></h3>
<div class="outline-text-3" id="text-orgac6ba76">
<ul class="org-ul">
<li>単独RSpec</li>
<li>カバレッジ</li>
</ul>
</div>
</div>
<div id="outline-container-org7e45a17" class="outline-3">
<h3 id="org7e45a17"><a href="#org7e45a17"><span class="done DONE">DONE</span> 複数ウィンドウエリア</a></h3>
<div class="outline-text-3" id="text-org7e45a17">
<p>
メッセージエリア、ステータスエリアなどウィンドウにエリアを追加する。
</p>
</div>
</div>
<div id="outline-container-orgb798252" class="outline-3">
<h3 id="orgb798252"><a href="#orgb798252"><span class="done DONE">DONE</span> component追加</a></h3>
<div class="outline-text-3" id="text-orgb798252">
<p>
game_objectを構成するもの。直に起動されることはなく、object_poolにもaddされない。
</p>
</div>
</div>
<div id="outline-container-org6344ffe" class="outline-3">
<h3 id="org6344ffe"><a href="#org6344ffe"><span class="done DONE">DONE</span> inputに分割</a></h3>
<div class="outline-text-3" id="text-org6344ffe">
<p>
今はすべてfield_stateでやっているが、characterのcomponentでやるようにする。
</p>
</div>
</div>
<div id="outline-container-orgdd71698" class="outline-3">
<h3 id="orgdd71698"><a href="#orgdd71698"><span class="done DONE">DONE</span> 別入力</a></h3>
<div class="outline-text-3" id="text-orgdd71698">
<p>
とりあえず敵をランダム移動できるようにする。
</p>
</div>
</div>
<div id="outline-container-org804af51" class="outline-3">
<h3 id="org804af51"><a href="#org804af51"><span class="done DONE">DONE</span> message_displayとmessageの分割</a></h3>
<div class="outline-text-3" id="text-org804af51">
<p>
statsを作ってそこにmessageを入れることで対応した。
</p>
</div>
</div>
<div id="outline-container-org74bfcf0" class="outline-3">
<h3 id="org74bfcf0"><a href="#org74bfcf0"><span class="done DONE">DONE</span> テストrequireを自動化する</a></h3>
<div class="outline-text-3" id="text-org74bfcf0">
<p>
めんどいので。
</p>
</div>
</div>
<div id="outline-container-orgde8ec48" class="outline-3">
<h3 id="orgde8ec48"><a href="#orgde8ec48"><span class="done DONE">DONE</span> RSpec lintを追加した</a></h3>
<div class="outline-text-3" id="text-orgde8ec48">
<p>
その日の気分で書きがちなところに基準ができた。必須だな。
</p>
</div>
</div>
<div id="outline-container-org41f2539" class="outline-3">
<h3 id="org41f2539"><a href="#org41f2539"><span class="done DONE">DONE</span> object_poolオブジェクト間の接触判定</a></h3>
<div class="outline-text-3" id="text-org41f2539">
<p>
地形判定とは異なる。オブジェクト層で起こる反応。
game_objectとmapではやり方が異なる。
</p>
</div>
</div>
<div id="outline-container-orgb84cc2a" class="outline-3">
<h3 id="orgb84cc2a"><a href="#orgb84cc2a"><span class="done DONE">DONE</span> boxつけるとずれる問題</a></h3>
<div class="outline-text-3" id="text-orgb84cc2a">
<p>
範囲がわかりづらいのでつけたいが、横方向がずれてる。
最初の一行だけ正しくて、改行以降はインデントがセットされてない、みたいな状況か。
</p>
<pre class="example">
 aaa
aaa
aaa
</pre>
<p>
かな。
</p>

<p>
一行ずつ出力することで解決した。
</p>
</div>
</div>
<div id="outline-container-orgd4d21f0" class="outline-3">
<h3 id="orgd4d21f0"><a href="#orgd4d21f0"><span class="done DONE">DONE</span> 基地メニュー</a></h3>
<div class="outline-text-3" id="text-orgd4d21f0">
<p>
2つ目state。
まだ内容はない。
</p>
</div>
</div>
<div id="outline-container-org4684a6e" class="outline-3">
<h3 id="org4684a6e"><a href="#org4684a6e"><span class="done DONE">DONE</span> ウィンドウ分割</a></h3>
<div class="outline-text-3" id="text-org4684a6e">
<p>
対応の必要なし。
</p>

<p>
メインウィンドウにすべて表示してたが、分割したほうがやりやすそうなので分割する。
マップウィンドウ、メッセージウィンドウとか。
</p>

<p>
その場合、ウィンドウ構成がモードによって変わる。どうやって表現すればよいだろう。
うーん、やっぱり面倒なのでメインウィンドウに座標挿入でよさそう。
</p>

<p>
stateによって使い回せるしな。
</p>
</div>
</div>
<div id="outline-container-org7fb67b6" class="outline-3">
<h3 id="org7fb67b6"><a href="#org7fb67b6"><span class="done DONE">DONE</span> ゲームのおおまかな計画をやる</a></h3>
<div class="outline-text-3" id="text-org7fb67b6">
<p>
バトルディッガーにしようとうっすら考えてたが、さすがに丸パクはできないので、混ぜよう。
そろそろどういう仕様にするか決めないといけない段階。
</p>

<p>
合成システムはカンタンに実装できて奥深そうなんだよな。
なのでシステム的にはディッガーよりハタ人間。
</p>

<ul class="org-ul">
<li>アイテム合成</li>
</ul>
</div>
</div>
<div id="outline-container-org5e51d3c" class="outline-3">
<h3 id="org5e51d3c"><a href="#org5e51d3c"><span class="done DONE">DONE</span> フォント</a></h3>
<div class="outline-text-3" id="text-org5e51d3c">
<dl class="org-dl">
<dt>Press Start 2p</dt><dd>横幅的には一番</dd>
<dt>misaki font</dt><dd>日本語対応</dd>
</dl>
</div>
</div>
<div id="outline-container-org8aa7605" class="outline-3">
<h3 id="org8aa7605"><a href="#org8aa7605"><span class="done DONE">DONE</span> AIキャラが消える問題</a></h3>
<div class="outline-text-3" id="text-org8aa7605">
<p>
updateはAIキャラが動かない。
drawは全員消える。
</p>

<p>
game_objectにupdate, drawメソッドがあると、componentのdraw, updateが上書きされるため起こる。
ai_inputはcomponentでupdateを使って入力を生成してるが、player_inputはbutton_downのため、問題が起きたり起きなかったりする。
</p>

<p>
drawでは機能しないのはなぜだ。処理の順番か。field_stateの処理の順番を並べ替えるとできた。
object_pool.draw
map.draw
の順番にしないといけない。
</p>
</div>
</div>
<div id="outline-container-orgbe211fb" class="outline-3">
<h3 id="orgbe211fb"><a href="#orgbe211fb"><span class="done DONE">DONE</span> カメラ追加</a></h3>
<div class="outline-text-3" id="text-orgbe211fb">
</div>
</div>
<div id="outline-container-orgdfdfb80" class="outline-3">
<h3 id="orgdfdfb80"><a href="#orgdfdfb80"><span class="done DONE">DONE</span> アイテム追加する</a></h3>
<div class="outline-text-3" id="text-orgdfdfb80">
<p>
game_objectのアイテムと、所持品としてのアイテムをどう分ければよいだろう。
少なくとも単語を分けることが必要そう。
</p>

<p>
pickupはいいセンいってるが、動作っぽい。
まあいいか。後からどうするか明確になってからで。
</p>
</div>
</div>
<div id="outline-container-org79decfa" class="outline-3">
<h3 id="org79decfa"><a href="#org79decfa"><span class="done DONE">DONE</span> プレイヤーキャラ以外を追加する</a></h3>
<div class="outline-text-3" id="text-org79decfa">
<p>
表示文字をキャラによって変える必要がある。
inputによって分岐するようにした。
</p>
</div>
</div>
<div id="outline-container-orgc0a0b5e" class="outline-3">
<h3 id="orgc0a0b5e"><a href="#orgc0a0b5e"><span class="done DONE">DONE</span> メニュー追加する</a></h3>
<div class="outline-text-3" id="text-orgc0a0b5e">
<p>
画面追加だけできした。あとはカーソル移動とかか。
</p>
</div>
</div>
<div id="outline-container-org05276a9" class="outline-3">
<h3 id="org05276a9"><a href="#org05276a9"><span class="done DONE">DONE</span> 設定のファイル化</a></h3>
<div class="outline-text-3" id="text-org05276a9">
<p>
CDDAみたいに、設定類はすべてjsonかymlにする。
キャラクターは完了。とはいえシルエットだけなのでそんなにパラメータはない。
一応はできたが、これがtype objectと自信がもてない。characterはマップのシルエットとして使うくらいだからあまり必要性ないんだよな。
</p>
</div>
</div>
<div id="outline-container-org038a64a" class="outline-3">
<h3 id="org038a64a"><a href="#org038a64a"><span class="done DONE">DONE</span> ターン実装</a></h3>
<div class="outline-text-3" id="text-org038a64a">
<p>
getchでなんとなくターンぽくなっているが、移動以外でもターンが進んでしまう。
ターンが進むのは移動だけでよさそう。ローグライクだったら攻撃でも進むが、このゲームにはない。
</p>

<p>
player_inputかつ、移動ができたときだけexecuteフラグをオンにする。
</p>
</div>
</div>
<div id="outline-container-orgaa12dd5" class="outline-3">
<h3 id="orgaa12dd5"><a href="#orgaa12dd5"><span class="done DONE">DONE</span> characterをphysicsに分割する</a></h3>
<div class="outline-text-3" id="text-orgaa12dd5">
</div>
</div>
<div id="outline-container-org9e6bcf7" class="outline-3">
<h3 id="org9e6bcf7"><a href="#org9e6bcf7"><span class="done DONE">DONE</span> メニュー画面でカーソル移動できるようにする</a></h3>
<div class="outline-text-3" id="text-org9e6bcf7">
<p>
カーソル移動はメンドイのでしない。
</p>
</div>
</div>
<div id="outline-container-orgcea9e1a" class="outline-3">
<h3 id="orgcea9e1a"><a href="#orgcea9e1a"><span class="done DONE">DONE</span> Terrainクラスを作る(flyweightパターン)</a></h3>
<div class="outline-text-3" id="text-orgcea9e1a">
<p>
コードで直に地形判定をしているため。
地形用のクラスに切り分ける。
Terrainオブジェクトは状況非依存。つまり草地タイルはすべて同一。
なので、Terrainオブジェクトの格子にするのではなく、Terrainオブジェクトへのポインタにする。
</p>

<ul class="org-ul">
<li>地形情報にアクセスするために、worldから取る必要がなくなる。</li>
<li>タイルから直にアクセスできるように。</li>
</ul>

<p>
まず文字列のマップをオブジェクトのマップにする。
どうやってやればいいんだ。
</p>
</div>
</div>
<div id="outline-container-org46d9062" class="outline-3">
<h3 id="org46d9062"><a href="#org46d9062"><span class="done DONE">DONE</span> item_type</a></h3>
<div class="outline-text-3" id="text-org46d9062">
<p>
作ろうと思ったがどうしよう。どういったプロパティを持つか。
</p>
<ul class="org-ul">
<li>アイテムの中身</li>
</ul>

<p>
とりあえずイメージしやすいように名前を取り出せるようにする。
フィールドオブジェクトしては名前くらいしか必要でない。
</p>
</div>
</div>
<div id="outline-container-org4af3f7b" class="outline-3">
<h3 id="org4af3f7b"><a href="#org4af3f7b"><span class="done DONE">DONE</span> インベントリ</a></h3>
<div class="outline-text-3" id="text-org4af3f7b">
<p>
アイテムを拾ったとき、インベントリに追加する。
フィールドのはアイテムだが、それから別のオブジェクトにするか。
</p>

<p>
消費物、素材は単なる数値だが、装備はさまざまなパラメータを持った別オブジェクトだ。
</p>

<p>
単にオブジェクトを配列に追加するだけだが、仮で完了。
</p>
</div>
</div>
<div id="outline-container-org4a7ea96" class="outline-3">
<h3 id="org4a7ea96"><a href="#org4a7ea96"><span class="done DONE">DONE</span> 衝突テスト</a></h3>
<div class="outline-text-3" id="text-org4a7ea96">
<p>
衝突関係がややこしくなってきたのでテストで確かめることにする。
アイテム、キャラクタ(Ai, Player)
</p>
</div>
</div>
<div id="outline-container-org3871cc3" class="outline-3">
<h3 id="org3871cc3"><a href="#org3871cc3"><span class="done DONE">DONE</span> 自動操作テスト</a></h3>
<div class="outline-text-3" id="text-org3871cc3">
<p>
オートプレイさせたい。
system spec的な。
実際のキーボード入力をシミュレートする。
</p>

<p>
今はgetchで止まるのでできない。直にbutton_downを受け付けるようにするとかできないか。
そもそもgetchがよくない説もある。アニメーションは一切できないからな。
入力は任意でよくしたい。入力しなくてもゲームループは進む。
ターンベースだろうと、ゲームループは回すほうが表現豊か。
</p>

<p>
テストのときはゲームループを手動で進めればよいのでは。
キーボード入力はできないが、直に入力すればいい。一応できた。
</p>
</div>
</div>
<div id="outline-container-orge70b331" class="outline-3">
<h3 id="orge70b331"><a href="#orge70b331"><span class="done DONE">DONE</span> utilsのload_jsonをデフォルト拡張子jsonにする</a></h3>
<div class="outline-text-3" id="text-orge70b331">
</div>
</div>
<div id="outline-container-orgab5da50" class="outline-3">
<h3 id="orgab5da50"><a href="#orgab5da50"><span class="done DONE">DONE</span> コンパイル(断念)</a></h3>
<div class="outline-text-3" id="text-orgab5da50">
<p>
プレイヤーがいちいちbundle installとかしなくていいようにexeとか実行形式にしたいが、どうすればいいんだろう。
ruby-packerというのがあるらしい。
これで各環境用にコンパイルするようにすればいい。
</p>

<p>
大変そうなので断念。
</p>
</div>
</div>
<div id="outline-container-org0b3cd28" class="outline-3">
<h3 id="org0b3cd28"><a href="#org0b3cd28"><span class="done DONE">DONE</span> インベントリに入れたときの挙動を変える</a></h3>
<div class="outline-text-3" id="text-org0b3cd28">
<p>
素材系のときは、オブジェクトは保持せず単にカウントアップするだけにする。
武器とか消費アイテムはオブジェクトとして保持する。
</p>

<p>
item_typeにcountを保持することにした。やや不自然だが、itemから直に数を増やす操作ができたり、問い合わせがカンタンだ。いちいち初期化しておく必要もない。
</p>
</div>
</div>
<div id="outline-container-org1018f63" class="outline-3">
<h3 id="org1018f63"><a href="#org1018f63"><span class="done DONE">DONE</span> アイテムをflyweightにする → item_typeを共通にする</a></h3>
<div class="outline-text-3" id="text-org1018f63">
<p>
今はそれぞれ別のオブジェクトになっているので、共通オブジェクトにする。
jsonで読んでそれを各自インスタンス変数に入れるみたいなことってできるのかな。一気に全インスタンスを配列に入れ、配列をインスタンス変数にするとできる。
</p>

<p>
正確にいうと、item_typeが共通である。itemオブジェクト自体はユニークである。取得して消えたり座標を持ってるから。
</p>
</div>
</div>
<div id="outline-container-org00bf50e" class="outline-3">
<h3 id="org00bf50e"><a href="#org00bf50e"><span class="done DONE">DONE</span> 各state共通のinputを継承元に書く</a></h3>
<div class="outline-text-3" id="text-org00bf50e">
<p>
たとえば&rsquo;c&rsquo;はどのstateでも終了にしたい。
</p>

<p>
抽象クラスに移動した。
</p>
</div>
</div>
<div id="outline-container-org7be387f" class="outline-3">
<h3 id="org7be387f"><a href="#org7be387f"><span class="done DONE">DONE</span> 移動AI</a></h3>
<div class="outline-text-3" id="text-org7be387f">
<p>
経路選択をどうすればよいのだろう。斜めにターゲットがあるときどうやってジグザグを判定するか。
</p>
</div>
</div>
<div id="outline-container-orge6fba57" class="outline-3">
<h3 id="orge6fba57"><a href="#orge6fba57"><span class="done DONE">DONE</span> エンカウント追加</a></h3>
<div class="outline-text-3" id="text-orge6fba57">
<p>
戦闘モードへ遷移する。
</p>
</div>
</div>
<div id="outline-container-orgeef9ae8" class="outline-3">
<h3 id="orgeef9ae8"><a href="#orgeef9ae8"><span class="done DONE">DONE</span> パーティ状況を表示する</a></h3>
<div class="outline-text-3" id="text-orgeef9ae8">
<p>
まず戦闘のまえにこっちからやろう。
連れてる仲間、HP,SPを表示する。
</p>
</div>
</div>
<div id="outline-container-orge5ea584" class="outline-3">
<h3 id="orge5ea584"><a href="#orge5ea584"><span class="done CLOSE">CLOSE</span> Todo</a></h3>
<div class="outline-text-3" id="text-orge5ea584">
</div>
<div id="outline-container-org16ac7b1" class="outline-4">
<h4 id="org16ac7b1"><a href="#org16ac7b1">戦闘後の移動</a></h4>
<div class="outline-text-4" id="text-org16ac7b1">
<p>
AIとは移動が競合するので、移動前のものになっている。
戦闘になった瞬間ゲームオブジェクトを消すので、移動できてもよさそう。あーでもそうすると逃げることができないのか。逃げたときは前の位置に移動したいところ。
勝利: 自分が動こうとしていた場所へ移動する。
逃走: 自分が動く前の場所へ移動する。
</p>
</div>
</div>
<div id="outline-container-org29492ca" class="outline-4">
<h4 id="org29492ca"><a href="#org29492ca">非同期キーボードイベント</a></h4>
<div class="outline-text-4" id="text-org29492ca">
<p>
Gosuのキーボードだけ拝借できるかなと思ったが、Gosuのウィンドウにフォーカスが当たらないと検知できない。そりゃそうか。なのでncurses部分を書き換える必要がある。
</p>

<p>
現状ncurseの問題点。
</p>
<ul class="org-ul">
<li>アニメーションが一切できない。</li>
<li>フォントが変えられない。</li>
<li>描画単位が1マス。</li>
</ul>

<p>
CLIでも表現力が上がる。
</p>

<p>
テスト関係を変えないといけなそう。CIでgosu実行するとどうなるんだろう。
単体テストはOKそうだが、結合はどうなるんだろう。ゲームループ内で操作できるのか。
魅力的だが、別にあとでもよさそう。
</p>
</div>
</div>
<div id="outline-container-org9ae09a4" class="outline-4">
<h4 id="org9ae09a4"><a href="#org9ae09a4">地図ファイルから敵やアイテム生成する</a></h4>
<div class="outline-text-4" id="text-org9ae09a4">
<p>
ランダムに加えて固定でも配置できるようにする。
地図と思ったが、移動パターンとか指定したいので結局テキストでやらないといけないか。
</p>
</div>
</div>
<div id="outline-container-org46582c3" class="outline-4">
<h4 id="org46582c3"><a href="#org46582c3">mapとcameraを分離</a></h4>
<div class="outline-text-4" id="text-org46582c3">
<p>
すべてのベースはmapの配列。
</p>
<ul class="org-ul">
<li>character,itemを埋め込む。</li>
<li>cameraのメソッドで配列を切り取って、描画している。</li>
<li>毎ターンリセット</li>
</ul>
<p>
よくないのは、すべてmapの配列操作で密結合していることだ。
</p>

<p>
書き換えるので、キャラがいると地形データが取れなくなる。別レイヤで処理したい。
banbandonではどうしてるのだろう。カメラとマップは分離しているように見える。
</p>

<p>
bbdではマップ上に描画しているのに対して、diggerでは画面のピクセルを指定して描画しないといけない違い。
</p>

<p>
結局地形判定はflyweightのworld配列でやってるので、関係なくなった。描画だけに使われる文字列配列。
</p>
</div>
</div>
<div id="outline-container-org7b1b3ab" class="outline-4">
<h4 id="org7b1b3ab"><a href="#org7b1b3ab">戦闘モード追加する</a></h4>
<div class="outline-text-4" id="text-org7b1b3ab">
<p>
とりあえずstate切り替えだけ追加した。
戦闘のためにはいくつかのクラス、パラメータを用意してやる必要がある。
</p>

<ul class="org-ul">
<li>party</li>
<li>member</li>
<li>enemy</li>
</ul>

<blockquote>
<p>
<a href="http://www.lancarse.co.jp/blog/?p=194">http://www.lancarse.co.jp/blog/?p=194</a>
</p>
</blockquote>
<p>
actorからパラメータをコピーして、1ターン分の結果を先に計算。
して、演出用メッセージを生成する。
コードの見通しがよくなる。
</p>
</div>
</div>
<div id="outline-container-org545d891" class="outline-4">
<h4 id="org545d891"><a href="#org545d891">singletonを減らす</a></h4>
<div class="outline-text-4" id="text-org545d891">
<p>
inventoryとかは似たような状況で、singletonになっている。
乱立するのが嫌なので1つのsingletonに、inventoryとかpartyとかを含むようにしたいな。
メッセージなどもそっちに保持させる。characterごとでなく。
</p>
</div>
</div>
<div id="outline-container-org1ed908d" class="outline-4">
<h4 id="org1ed908d"><a href="#org1ed908d">永続値をどこで持つか</a></h4>
<div class="outline-text-4" id="text-org1ed908d">
<p>
ステートを切り替えても持ってないといけないものがある。
仲間のHPとか装備とか。そういうのをどこで保持すればいいんだろう。
</p>

<p>
とりあえずsignletonにしておけば良いかな。
</p>
</div>
</div>
<div id="outline-container-org72483e2" class="outline-4">
<h4 id="org72483e2"><a href="#org72483e2">戦闘の方はmemberにする</a></h4>
<div class="outline-text-4" id="text-org72483e2">
<p>
エンカウント型にすると、map上のシンボルが複数のキャラクターを持つことがありうる。
現状のCharacterと合わなくなるような気がする。
map上とbattle上のcharacterは別物だ。
</p>

<p>
=&gt;マップの方はpartyにする。
戦闘の方をcharacterに。
あまり直感的ではないな。
</p>

<p>
戦闘の方はmemberにするとか。属してるニュアンスは出る。
</p>

<p>
いろいろ違うので敵と仲間は別にしよう。かなり共通しているところもあるので組み合わせながら。
</p>
</div>
</div>
<div id="outline-container-org082c8b0" class="outline-4">
<h4 id="org082c8b0"><a href="#org082c8b0">スキルはmemberで共通</a></h4>
<div class="outline-text-4" id="text-org082c8b0">
<p>
敵もスキルを持ってる。
</p>
</div>
</div>
<div id="outline-container-org8ac534c" class="outline-4">
<h4 id="org8ac534c"><a href="#org8ac534c">コマンドパターンについて考える</a></h4>
<div class="outline-text-4" id="text-org8ac534c">
<p>
今の状況は、キーボードイべントとメソッドが直に結びついてる。
</p>
</div>
</div>
<div id="outline-container-org6a0edf5" class="outline-4">
<h4 id="org6a0edf5"><a href="#org6a0edf5">達成バッジ</a></h4>
<div class="outline-text-4" id="text-org6a0edf5">
<p>
オブザーバパターン。
統計情報…移動した回数、経過ターン、倒した敵の数。
動機づけになる。
</p>
</div>
</div>
<div id="outline-container-org51c067d" class="outline-4">
<h4 id="org51c067d"><a href="#org51c067d">不可視にする</a></h4>
<div class="outline-text-4" id="text-org51c067d">
<p>
視界が難しそう。AIにできるならプレイヤーにも追加すると面白そう。cataclysmみたいに、壁の向こう側は不可視にする。
</p>

<p>
気づくまでは、固定の動きをする。T字で左折する法則。
</p>
</div>
</div>
</div>
<div id="outline-container-orgfc6b9eb" class="outline-3">
<h3 id="orgfc6b9eb"><a href="#orgfc6b9eb"><span class="done CLOSE">CLOSE</span> Todo(リファクタ)</a></h3>
<div class="outline-text-3" id="text-orgfc6b9eb">
</div>
<div id="outline-container-org4bda1ef" class="outline-4">
<h4 id="org4bda1ef"><a href="#org4bda1ef">カーソル系画面表示をリファクタリングする</a></h4>
<div class="outline-text-4" id="text-org4bda1ef">
<p>
カーソル、タブがだるい。
何かユーティリティを作ってもいい。
</p>
</div>
</div>
<div id="outline-container-orgd95ff18" class="outline-4">
<h4 id="orgd95ff18"><a href="#orgd95ff18">Inventoryシングルトンをやめる</a></h4>
<div class="outline-text-4" id="text-orgd95ff18">
<p>
inventoryをシングルトンにするのはやめよう。テストがだるい。
とはいえ、stateを限定しないデータなので、それなりの理由はある。
</p>
</div>
</div>
<div id="outline-container-org9cbc11d" class="outline-4">
<h4 id="org9cbc11d"><a href="#org9cbc11d">メッセージシステム</a></h4>
<div class="outline-text-4" id="text-org9cbc11d">
<p>
statsが持ってるのはおかしい気がする。
プレイヤーだけが知っていればいいことなので。
いちいちcharacterから辿るのはメンドイし、直感的でない。
</p>
</div>
</div>
</div>
<div id="outline-container-orgf2b2ced" class="outline-3">
<h3 id="orgf2b2ced"><a href="#orgf2b2ced"><span class="done CLOSE">CLOSE</span> 設計</a></h3>
<div class="outline-text-3" id="text-orgf2b2ced">
</div>
<div id="outline-container-org29e709c" class="outline-4">
<h4 id="org29e709c"><a href="#org29e709c">戦闘モード</a></h4>
<div class="outline-text-4" id="text-org29e709c">
<pre class="example">

  oo`'._..---.___..-   oo`'._..---.___..-
 (_,-.        ,..'`  (_,-.        ,..'`
      `'.    ;            `'.    ;
         : :`                : :`
        _;_;                _;_;
ティラノ              ティラノ

ティラノ&gt; 体当たりした
白瀬&gt; 10のダメージを受けた
椿&gt; 対物ライフル → ティラノに30のダメージ
石原&gt; 木刀 → ティラノに5のダメージ

--------------------------------
→戦う　　|白瀬 HP: 55/20 SP: 40/30 **--- ****-
 逃げる　|椿　 HP: 90/84 SP: 50/20 ****- ***--
 アイテム|石原 HP: 80/80 SP: 50/24 ***** **---
 　　　　|
</pre>
</div>
</div>
<div id="outline-container-orgb2c4c6b" class="outline-4">
<h4 id="orgb2c4c6b"><a href="#orgb2c4c6b">拠点メニューモード</a></h4>
<div class="outline-text-4" id="text-orgb2c4c6b">
<p>
拠点。
</p>
<pre class="example">
→休憩
 合成
 アイテム
 仲間
 装備
 セーブ
 ロード
</pre>

<p>
フィールドではメニューにはアクセスしない。
ステータスやアイテムへのショートカットキーを用意する。
</p>
</div>
</div>
<div id="outline-container-orge80275c" class="outline-4">
<h4 id="orge80275c"><a href="#orge80275c">フィールドモード</a></h4>
<div class="outline-text-4" id="text-orge80275c">
<ul class="org-ul">
<li>ターンベース</li>
<li>イベントオブジェクトに接触して、別モードに遷移する</li>
</ul>

<p>
ステータス、アイテム、装備へのショートカットキーを用意する。
</p>
</div>
</div>
</div>
<div id="outline-container-org20ff8ef" class="outline-3">
<h3 id="org20ff8ef"><a href="#org20ff8ef"><span class="done DONE">DONE</span> 戦闘モード追加</a></h3>
<div class="outline-text-3" id="text-org20ff8ef">
<p>
接触したときにフラグを立てて、stateに入る。
wants_to_{}系か。
直にstateを変更するというより、フラグを使ってstateを間接的に移動する。
wants_to_meleeの個別要素にアクセスできない。
</p>

<p>
wants_to_attackを入れておいて、systemを一度回せばいいかな。
一度実行するたびにメッセージを表示して、enterの入力待ちにする。
</p>
</div>
</div>
<div id="outline-container-org32403c8" class="outline-3">
<h3 id="org32403c8"><a href="#org32403c8"><span class="done DONE">DONE</span> GitHub Pagesにデプロイ</a></h3>
<div class="outline-text-3" id="text-org32403c8">
</div>
</div>
<div id="outline-container-org5873ad6" class="outline-3">
<h3 id="org5873ad6"><a href="#org5873ad6"><span class="done DONE">DONE</span> 遭遇中の敵の情報を出す</a></h3>
<div class="outline-text-3" id="text-org5873ad6">
</div>
</div>
<div id="outline-container-org75200d0" class="outline-3">
<h3 id="org75200d0"><a href="#org75200d0"><span class="done DONE">DONE</span> 1エンカウント対複数の敵に対応する</a></h3>
<div class="outline-text-3" id="text-org75200d0">
<p>
今はエンカウントシンボルと敵が1対1なので、自由度が低い。
battle_entityを作って戦闘は完全にそっちに移す。
</p>
</div>
</div>
<div id="outline-container-org2f45ee4" class="outline-3">
<h3 id="org2f45ee4"><a href="#org2f45ee4"><span class="done DONE">DONE</span> 戦闘終了後にマップentityを削除する</a></h3>
<div class="outline-text-3" id="text-org2f45ee4">
<p>
wants_to_encounterで元entityを保持してるので、そこから削除できないか。
</p>
</div>
</div>
<div id="outline-container-org584c2fd" class="outline-3">
<h3 id="org584c2fd"><a href="#org584c2fd"><span class="done DONE">DONE</span> 使わない部分を消す</a></h3>
<div class="outline-text-3" id="text-org584c2fd">
<ul class="org-ul">
<li>既存の戦闘部分は使わないので消す</li>
<li>遠距離アイテムは消す</li>
</ul>
</div>
</div>
<div id="outline-container-orgdec1f52" class="outline-3">
<h3 id="orgdec1f52"><a href="#orgdec1f52"><span class="done DONE">DONE</span> 勝利したときに戦闘結果を表示する</a></h3>
<div class="outline-text-3" id="text-orgdec1f52">
</div>
</div>
<div id="outline-container-org4a77872" class="outline-3">
<h3 id="org4a77872"><a href="#org4a77872"><span class="done DONE">DONE</span> 逃げるときの確率分岐</a></h3>
<div class="outline-text-3" id="text-org4a77872">
<p>
今は100％なので、確率で失敗してターンを進行させる。
</p>
</div>
</div>
<div id="outline-container-org4f81b03" class="outline-3">
<h3 id="org4f81b03"><a href="#org4f81b03"><span class="done DONE">DONE</span> 敵一覧を真ん中寄せにする</a></h3>
<div class="outline-text-3" id="text-org4f81b03">
<p>
2体いるときは2体で真ん中に、倒して1体になったら1体で真ん中寄せにする。
</p>
</div>
</div>
<div id="outline-container-orgb04d760" class="outline-3">
<h3 id="orgb04d760"><a href="#orgb04d760"><span class="done DONE">DONE</span> 1体倒してから逃げるとエラー</a></h3>
<div class="outline-text-3" id="text-orgb04d760">
<p>
wants_to_meleeが残っていて、おかしくなっていたよう。
ターンごとに、リセットするようにした。
確実に前の状態を残さないようにするとバグになりにくそう。
</p>
</div>
</div>
<div id="outline-container-orgb7acdde" class="outline-3">
<h3 id="orgb7acdde"><a href="#orgb7acdde"><span class="done DONE">DONE</span> 戦闘用エンティティであることを明示する</a></h3>
<div class="outline-text-3" id="text-orgb7acdde">
<p>
現在は、combat_stats, monsterコンポーネントを持つものを敵の戦闘エンティティとしている…みたいな感じ。
わかりにくいので直したい。
</p>

<p>
combat_stats を持つ=戦闘エンティティで問題ない。monster, playerがあるのは区別が必要なので仕方ない。
なのでOK。
</p>
</div>
</div>
<div id="outline-container-org07fcf9e" class="outline-3">
<h3 id="org07fcf9e"><a href="#org07fcf9e"><span class="done DONE">DONE</span> パーティクル追加</a></h3>
<div class="outline-text-3" id="text-org07fcf9e">
<p>
チュートリアルのパーティクルはマップ用。
positionにライフタイムのあるentityを配置して、擬似的にアニメーションにしている。
entityにすることで、map描画システムを使い、map上を上書きする形で表示できる。
戦闘ではprintしてるので、そのまま使うことはできない。printごとに座標計算して指定してるので、重ねるためにはロジックをコピペしないといけない。
</p>

<p>
builderの実装方法は参考になりそうなので、とりあえずコピペ追加。
</p>
</div>
</div>
<div id="outline-container-org1121072" class="outline-3">
<h3 id="org1121072"><a href="#org1121072"><span class="done DONE">DONE</span> フィールドでHPがリアルタイムに反映されてない</a></h3>
<div class="outline-text-3" id="text-org1121072">
<p>
戦闘に入るとダメージが反映される。
field_stateでdamage_systemが動いてないためだった。
</p>
</div>
</div>
<div id="outline-container-org369bde3" class="outline-3">
<h3 id="org369bde3"><a href="#org369bde3"><span class="done DONE">DONE</span> 食料追加</a></h3>
<div class="outline-text-3" id="text-org369bde3">
</div>
</div>
<div id="outline-container-org27e71be" class="outline-3">
<h3 id="org27e71be"><a href="#org27e71be"><span class="done CLOSE">CLOSE</span> 画像背景</a></h3>
<div class="outline-text-3" id="text-org27e71be">
<p>
チュートリアルの内容。
LEX paintがWINEでうまく実行できない。
変換ツールもうまく機能してないので、いったんチュートリアルのを流用して後回しか。システムだけ入れてコメントアウト。
</p>
</div>
</div>
<div id="outline-container-org3a2d60d" class="outline-3">
<h3 id="org3a2d60d"><a href="#org3a2d60d"><span class="done DONE">DONE</span> プレイヤーと戦闘エンティティを分離する</a></h3>
<div class="outline-text-3" id="text-org3a2d60d">
<p>
分離した。影響範囲が広い。
</p>
</div>
</div>
<div id="outline-container-orgc2f4af9" class="outline-3">
<h3 id="orgc2f4af9"><a href="#orgc2f4af9"><span class="done DONE">DONE</span> 再装備するとアイテムが消える</a></h3>
<div class="outline-text-3" id="text-orgc2f4af9">
<p>
装備品のownerがキャラになっていたため、インベントリに表示されてないというものだった。
装備中のものはownerが各戦闘用entityになり、装備してないとownerはplayer_entityになる。
party_entityとかにしたほうがいいかもな。
ややこしい。
</p>
</div>
</div>
<div id="outline-container-orgb4c92ed" class="outline-3">
<h3 id="orgb4c92ed"><a href="#orgb4c92ed"><span class="done DONE">DONE</span> Design Doc</a></h3>
<div class="outline-text-3" id="text-orgb4c92ed">
</div>
</div>
<div id="outline-container-org20af9bf" class="outline-3">
<h3 id="org20af9bf"><a href="#org20af9bf"><span class="done DONE">DONE</span> mapをリファクタ(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org20af9bf">
</div>
</div>
<div id="outline-container-orgefdf40d" class="outline-3">
<h3 id="orgefdf40d"><a href="#orgefdf40d"><span class="done DONE">DONE</span> mapフィルタ</a></h3>
<div class="outline-text-3" id="text-orgefdf40d">
</div>
</div>
<div id="outline-container-org4dfa5c0" class="outline-3">
<h3 id="org4dfa5c0"><a href="#org4dfa5c0"><span class="done DONE">DONE</span> ドア追加(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org4dfa5c0">
</div>
</div>
<div id="outline-container-orgfc73646" class="outline-3">
<h3 id="orgfc73646"><a href="#orgfc73646"><span class="done DONE">DONE</span> Warningつぶし</a></h3>
<div class="outline-text-3" id="text-orgfc73646">
</div>
</div>
<div id="outline-container-org4eb6342" class="outline-3">
<h3 id="org4eb6342"><a href="#org4eb6342"><span class="done DONE">DONE</span> builder理解</a></h3>
<div class="outline-text-3" id="text-org4eb6342">
</div>
</div>
<div id="outline-container-org13a3d58" class="outline-3">
<h3 id="org13a3d58"><a href="#org13a3d58"><span class="done DONE">DONE</span> カメラ導入(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org13a3d58">
</div>
</div>
<div id="outline-container-orgb1336f5" class="outline-3">
<h3 id="orgb1336f5"><a href="#orgb1336f5"><span class="done DONE">DONE</span> getで取れるところのリファクタ</a></h3>
<div class="outline-text-3" id="text-orgb1336f5">
<div class="org-src-container">
<pre class="src src-rust">hc = hunger_clock.get(entity);
</pre>
</div>
<p>
のように、entityさえわかっていればgetで属性をコンポーネントを取得できる。いちいちforに長く書く必要がない。
</p>
</div>
</div>
<div id="outline-container-orgecd0edb" class="outline-3">
<h3 id="orgecd0edb"><a href="#orgecd0edb"><span class="done DONE">DONE</span> データのjsonファイル化(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgecd0edb">
</div>
</div>
<div id="outline-container-org0564a77" class="outline-3">
<h3 id="org0564a77"><a href="#org0564a77"><span class="done DONE">DONE</span> 街追加(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org0564a77">
</div>
</div>
<div id="outline-container-org2fab457" class="outline-3">
<h3 id="org2fab457"><a href="#org2fab457"><span class="done DONE">DONE</span> 戦闘が終了しないバグ</a></h3>
<div class="outline-text-3" id="text-org2fab457">
<p>
戦闘関連のリファクタをした。あまりよくないな…。
</p>
</div>
</div>
<div id="outline-container-orgfbeff28" class="outline-3">
<h3 id="orgfbeff28"><a href="#orgfbeff28"><span class="done DONE">DONE</span> 複数の能力(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgfbeff28">
</div>
</div>
<div id="outline-container-org1569429" class="outline-3">
<h3 id="org1569429"><a href="#org1569429"><span class="done DONE">DONE</span> 画面サイズを大きくする</a></h3>
<div class="outline-text-3" id="text-org1569429">
<p>
コンパイル後のブラウザ表示。何回か試したが、うまくいってない。
</p>
</div>
</div>
<div id="outline-container-orgb00935e" class="outline-3">
<h3 id="orgb00935e"><a href="#orgb00935e"><span class="done DONE">DONE</span> Battleリファクタ</a></h3>
<div class="outline-text-3" id="text-orgb00935e">
</div>
</div>
<div id="outline-container-org603ee5d" class="outline-3">
<h3 id="org603ee5d"><a href="#org603ee5d"><span class="done DONE">DONE</span> 装備品追加(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org603ee5d">
</div>
</div>
<div id="outline-container-orgdea23a9" class="outline-3">
<h3 id="orgdea23a9"><a href="#orgdea23a9"><span class="done DONE">DONE</span> UI(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgdea23a9">
</div>
</div>
<div id="outline-container-orged33dd5" class="outline-3">
<h3 id="orged33dd5"><a href="#orged33dd5"><span class="done DONE">DONE</span> ゲームオーバーになったあと再開するとHP表示がUIから消える</a></h3>
<div class="outline-text-3" id="text-orged33dd5">
</div>
</div>
<div id="outline-container-org8ea0853" class="outline-3">
<h3 id="org8ea0853"><a href="#org8ea0853"><span class="done DONE">DONE</span> 森をつくる(チュートリアル)</a></h3>
</div>
<div id="outline-container-org773b80d" class="outline-3">
<h3 id="org773b80d"><a href="#org773b80d"><span class="done DONE">DONE</span> 経験値とレベル(チュートリアル)</a></h3>
</div>
<div id="outline-container-orgcf816fa" class="outline-3">
<h3 id="orgcf816fa"><a href="#orgcf816fa"><span class="done DONE">DONE</span> 家に戻る(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgcf816fa">
</div>
</div>
<div id="outline-container-orgabcca81" class="outline-3">
<h3 id="orgabcca81"><a href="#orgabcca81"><span class="done DONE">DONE</span> 石灰岩の洞窟(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgabcca81">
</div>
</div>
<div id="outline-container-orgf712cc0" class="outline-3">
<h3 id="orgf712cc0"><a href="#orgf712cc0"><span class="done DONE">DONE</span> AIモジュール化(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgf712cc0">
</div>
</div>
<div id="outline-container-org82b6b71" class="outline-3">
<h3 id="org82b6b71"><a href="#org82b6b71"><span class="done DONE">DONE</span> spatial mapping(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org82b6b71">
</div>
</div>
<div id="outline-container-org2938772" class="outline-3">
<h3 id="org2938772"><a href="#org2938772"><span class="done DONE">DONE</span> アイテム追加(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org2938772">
</div>
</div>
<div id="outline-container-org22ccd22" class="outline-3">
<h3 id="org22ccd22"><a href="#org22ccd22"><span class="done DONE">DONE</span> 深い洞窟(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org22ccd22">
</div>
</div>
<div id="outline-container-orgfb6b207" class="outline-3">
<h3 id="orgfb6b207"><a href="#orgfb6b207"><span class="done DONE">DONE</span> 洞窟からDwarf Fortress(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgfb6b207">
</div>
</div>
<div id="outline-container-org20702c3" class="outline-3">
<h3 id="org20702c3"><a href="#org20702c3"><span class="done DONE">DONE</span> タウンポータル(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org20702c3">
</div>
</div>
<div id="outline-container-org7cb5975" class="outline-3">
<h3 id="org7cb5975"><a href="#org7cb5975"><span class="done DONE">DONE</span> WASMビルドが失敗する</a></h3>
<div class="outline-text-3" id="text-org7cb5975">
</div>
</div>
<div id="outline-container-org2b588a1" class="outline-3">
<h3 id="org2b588a1"><a href="#org2b588a1"><span class="done DONE">DONE</span> 魔法のアイテムと鑑定(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org2b588a1">
<p>
ゲーム内容と関係しないので、追加しない。
</p>

<ul class="org-ul">
<li>アイテムの色</li>
</ul>
</div>
</div>
<div id="outline-container-org248a084" class="outline-3">
<h3 id="org248a084"><a href="#org248a084"><span class="done DONE">DONE</span> 効果(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org248a084">
<p>
dispatcher modelの導入。長い章。
</p>
</div>
</div>
<div id="outline-container-orgc53c0bd" class="outline-3">
<h3 id="orgc53c0bd"><a href="#orgc53c0bd"><span class="done DONE">DONE</span> 呪われたアイテムと解呪(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgc53c0bd">
<p>
呪い装備機能は追加しないので、ざっと見るだけ。
</p>
</div>
</div>
<div id="outline-container-org9f97a34" class="outline-3">
<h3 id="org9f97a34"><a href="#org9f97a34"><span class="done DONE">DONE</span> ステータスに効果を与えるアイテム(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org9f97a34">
<p>
chapter65。回数や効果ターンは実装しない。効果のターン数は、後の戦闘でいりそう。フィールド画面ではいらないので、スルー。
</p>
</div>
</div>
<div id="outline-container-org282a963" class="outline-3">
<h3 id="org282a963"><a href="#org282a963"><span class="done DONE">DONE</span> ゲームオーバーになったときにエラーになる</a></h3>
<div class="outline-text-3" id="text-org282a963">
<p>
原因不明。
</p>
<pre class="example">
thread 'main' panicked at 'Tried to fetch data of type "alloc::boxed::Box&lt;dyn shred::world::Resource&gt;", but it was already borrowed mutably.', /home/green/.cargo/registry/src/github.com-1ecc6299db9ec823/shred-0.10.2/src/cell.rs:268:33
</pre>

<p>
スタックトレースを出して、怪しいところをスコープに入れると解決した。なぜコンパイラで検知できないのかはよくわからない。
</p>
</div>
</div>

<div id="outline-container-org45a6c79" class="outline-3">
<h3 id="org45a6c79"><a href="#org45a6c79"><span class="done DONE">DONE</span> 魔法追加(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org45a6c79">
<p>
Chapter66。アイテムなしで使用できる魔法を追加する章。覚えるアイテムを使うと、魔法が使えるようになるタイプ。これも後回しになりそう。今のところフィールドで何か使えるようにする予定はないが、戦闘で似たようなことをやるはず。
</p>

<p>
武器による状態異常なども実装している。
</p>
</div>
</div>
<div id="outline-container-orgaa00478" class="outline-3">
<h3 id="orgaa00478"><a href="#orgaa00478"><span class="done DONE">DONE</span> ドラゴンに入る(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgaa00478">
<ul class="org-ul">
<li>マップを作成</li>
<li>スポーンを改良(MasterTable)</li>
<li>複数タイルを専有するボス。当たり判定やAI調整</li>
<li>レベルアップ時のステータス調整</li>
</ul>

<p>
該当しなさそうなので、ほぼ実装なし。
</p>
</div>
</div>
<div id="outline-container-org9fd8356" class="outline-3">
<h3 id="org9fd8356"><a href="#org9fd8356"><span class="done DONE">DONE</span> マッシュルームの森(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org9fd8356">
<ul class="org-ul">
<li>近寄ったときの自爆攻撃</li>
<li>アイテム追加</li>
</ul>
</div>
</div>
<div id="outline-container-org9413cff" class="outline-3">
<h3 id="org9413cff"><a href="#org9413cff"><span class="done DONE">DONE</span> 深いマッシュルームの森(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org9413cff">
<ul class="org-ul">
<li>Chapter69</li>
<li>武器の拡張が参考になる</li>
<li>アイテムのテンプレート。+1とか+2を別アイテムとしていちいち追加しなくていいようにする</li>
<li>武器のeffectを別にしてトレイトとしてまとめる。たとえばname: venomous, effect: [damage_over_time: 2&ldquo;]と定義しておく</li>
<li>トレイトとテンプレートを組み合わせて、多くのバリエーションを生み出す</li>
</ul>
</div>
</div>
<div id="outline-container-orgc608235" class="outline-3">
<h3 id="orgc608235"><a href="#orgc608235"><span class="done DONE">DONE</span> ミサイルと範囲攻撃(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgc608235">
<ul class="org-ul">
<li>Chapter70</li>
<li>飛び道具</li>
</ul>

<p>
ターゲット周りがあまりよくわからない。あまり利用できそうなところはなかった。
</p>
</div>
</div>
<div id="outline-container-org9fea62d" class="outline-3">
<h3 id="org9fea62d"><a href="#org9fea62d"><span class="done DONE">DONE</span> ゲームログと実績カウント(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org9fea62d">
<p>
ここでいうログは実績のやつ。セーブにも保存されるようにする。シンプルで参考になる。
</p>
</div>
</div>
<div id="outline-container-org7d3d43c" class="outline-3">
<h3 id="org7d3d43c"><a href="#org7d3d43c"><span class="done DONE">DONE</span> テキストレイヤー(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org7d3d43c">
<ul class="org-ul">
<li>現在のフォントでは長い文章を読みづらいので、ログだけ別のフォントにする</li>
<li>まずrltkの全機能を知らないと、よりよい機能を選択できなそう</li>
<li>フォント変えるとだいぶ印象が変わった。工夫のしがいがあるところに気づかないので、既存のものをプレイしてみる必要がありそう</li>
<li>巨大なguiファイルをモジュール分割</li>
</ul>
</div>
</div>
<div id="outline-container-org9f47b3c" class="outline-3">
<h3 id="org9f47b3c"><a href="#org9f47b3c"><span class="done DONE">DONE</span> マルチスレッドによる高速化(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org9f47b3c">
<p>
73章。systemをマルチスレッド対応にして高速化する。あとでやる。
</p>
</div>
</div>
<div id="outline-container-org490bc24" class="outline-3">
<h3 id="org490bc24"><a href="#org490bc24"><span class="done DONE">DONE</span> 夜の街(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org490bc24">
<p>
マップ追加だけ。とくに見るところはないのでスキップ。
</p>
</div>
</div>
<div id="outline-container-org7e2a503" class="outline-3">
<h3 id="org7e2a503"><a href="#org7e2a503"><span class="done DONE">DONE</span> 戦闘終了後1ターン経過しないと敵シンボルが消えないバグ</a></h3>
<div class="outline-text-3" id="text-org7e2a503">
<p>
1ターン離れないと、敵が消えない。もう一度エンカウントすることはないので、何かしら違うのだが。
</p>

<ul class="org-ul">
<li>run_systemを一度実行すると敵シンボルは消えドロップアイテムが見えるのだが、その座標に1ターン経過しないと移動できない状態になる</li>
<li>run_systemsを2度実行すると自然な状態になる。よくわからない</li>
<li>delete_the_deadがターンの関係で敵が消えてないのでは</li>
</ul>
</div>
</div>
<div id="outline-container-orga18f493" class="outline-3">
<h3 id="orga18f493"><a href="#orga18f493"><span class="done DONE">DONE</span> 戦闘系コード整理</a></h3>
<div class="outline-text-3" id="text-orga18f493">
<p>
生死判定、勝利判定でごちゃついていて、どこにあるかわからない。かつ、フィールドでのそれらと混ざっていて危険。
</p>

<p>
それぞれsystemに分割したが、うまく動かない。1ターン進めないと、死体が消えない、戦闘勝利判定が入らない。困った。ステートも切り替わらないな。ほかのシステムとの連動が、イメージと異なるようだ。
</p>

<ul class="org-ul">
<li>逃げるのは機構が別なのでできる。mainファイルから正しくstateが切り替わっている</li>
<li>プレイヤーの体力判定も動いてない</li>
<li>サンプルのdelete_the_deadもsystemになっていないことはヒントか。run_systemで実行せず、state共通で毎ループ実行するようになっている</li>
<li>とはいえあとちょっとでできそうなんだよな。問題は死体が消えず体力が1ターンマイナスになることだけだ。ecs.maintain()をすると削除できるようになった。system内でのentity削除は、ecs.maintain()を実行しないと削除されないようだ</li>
<li>とはいえ、アイテムドロップにecsが必要でsystemでどういう対応すれば良いかわからず</li>
</ul>

<blockquote>
<p>
use super::{
    gamelog::BattleLog, Attributes, Combatant, Equipped, InBackpack, LootTable, Map, Monster, Name,
    OnBattle, Player, Pools, Position, RunState,
};
use specs::prelude::*;
</p>

<p>
pub struct DamageSystem {}
</p>

<p>
impl&lt;&rsquo;a&gt; System&lt;&rsquo;a&gt; for DamageSystem {
    type SystemData = (
        ReadStorage&lt;&rsquo;a, Pools&gt;,
        ReadStorage&lt;&rsquo;a, Player&gt;,
        ReadStorage&lt;&rsquo;a, Name&gt;,
        ReadStorage&lt;&rsquo;a, Combatant&gt;,
        Entities&lt;&rsquo;a&gt;,
        WriteExpect&lt;&rsquo;a, BattleLog&gt;,
        WriteExpect&lt;&rsquo;a, RunState&gt;,
    );
</p>

<p>
fn run(&amp;mut self, data: Self::SystemData) {
    let (
	pools,
	players,
	names,
	combatant,
	entities,
	mut log,
	mut runstate,
    ) = data;
</p>

<p>
let mut dead: Vec&lt;Entity&gt; = Vec::new();
// Using a scope to make the borrow checker happy
</p>

<p>
for (entity, pools, <span class="underline">combatant) in (&amp;entities, &amp;pools, &amp;combatant).join() {
    if pools.hit_points.current &lt; 1 {
	let player = players.get(entity);
	match player {
	    None =&gt; {
		let victim_name = names.get(entity);
		if let Some(victim_name) = victim_name {
		    log.entries.push(format!(&ldquo;{} is dead&rdquo;, &amp;victim_name.name));
		}
		dead.push(entity);
	    }
	    Some(</span>) =&gt; {
		*runstate = RunState::GameOver;
	    }
	}
    }
}
</p>

<p>
<i>/ HPが0になったentityの削除
/</i> entity削除をしても存在し続けているように見える
for victim in dead {
    entities.delete(victim).expect(&ldquo;Delete failed&rdquo;);
}
</p>

<p>
        <i>/ 勝利判定
        /</i> if maybe_win {
        <i>/     check_battle_win(ecs);
        /</i> }
    }
}
</p>

<p>
pub struct WinSystem {}
</p>

<p>
impl&lt;&rsquo;a&gt; System&lt;&rsquo;a&gt; for WinSystem {
    type SystemData = (
        Entities&lt;&rsquo;a&gt;,
        ReadStorage&lt;&rsquo;a, Pools&gt;,
        ReadStorage&lt;&rsquo;a, Monster&gt;,
        ReadStorage&lt;&rsquo;a, Combatant&gt;,
        WriteStorage&lt;&rsquo;a, OnBattle&gt;,
        WriteStorage&lt;&rsquo;a, Equipped&gt;,
        WriteStorage&lt;&rsquo;a, InBackpack&gt;,
        WriteStorage&lt;&rsquo;a, Position&gt;,
        ReadStorage&lt;&rsquo;a, LootTable&gt;,
        WriteExpect&lt;&rsquo;a, rltk::RandomNumberGenerator&gt;,
        WriteExpect&lt;&rsquo;a, BattleLog&gt;,
        WriteExpect&lt;&rsquo;a, RunState&gt;,
    );
</p>

<p>
fn run(&amp;mut self, data: Self::SystemData) {
    let (
	entities,
	pools,
	monster,
	combatant,
	mut on_battle,
	mut equipped,
	mut carried,
	mut positions,
	loot_tables,
	rng,
	mut log,
	mut runstate
    ) = data;
</p>

<p>
let mut dead: Vec&lt;Entity&gt; = Vec::new();
</p>

<p>
if (&amp;entities, &amp;pools, &amp;monster, &amp;combatant).join().count() == 0 {
    for (_entity, on_battle) in (&amp;entities, &amp;on_battle).join() {
	dead.push(on_battle.monster);
    }
}
</p>

<p>
        for victim in dead {
            log.entries.push(format!(&ldquo;You win!&rdquo;));
            entities.delete(victim).expect(&ldquo;Delete failed&rdquo;);
            *runstate = RunState::BattleResult;
            on_battle.clear();
        }
    }
}
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orga0f25b8" class="outline-3">
<h3 id="orga0f25b8"><a href="#orga0f25b8"><span class="done DONE">DONE</span> battle用を分ける</a></h3>
<div class="outline-text-3" id="text-orga0f25b8">
<p>
stateがごっちゃになっているので別にする。systemは別でやる。
</p>

<ul class="org-ul">
<li>複数の型をとりうるとき、orってどうするんだ。enumで。</li>
<li>stateのenumをネストしたenumにすればよいのでは、と考えたがうまくいかず</li>
</ul>
</div>
</div>
<div id="outline-container-org0dae41d" class="outline-3">
<h3 id="org0dae41d"><a href="#org0dae41d"><span class="done DONE">DONE</span> 逃走コード分離</a></h3>
<div class="outline-text-3" id="text-org0dae41d">
<p>
GUI部分に書いている。全体的に分離されてないので、分離。
</p>

<ul class="org-ul">
<li>systemにしたところ、また逃走成功時のエンティティ削除がうまくいかない</li>
<li>エンティティ削除部分が実行されてないようで、逃走成功メッセージが出ない + 次の戦闘時に2体表示される</li>
<li>逃走では即stateが切り替わるようになってるから、そのへんな気もする。systemを使う場合だと、wants_run_away生成→ターン処理→逃走となり実行タイミングがよくわからないことになる。delete_the_deadと同じように、ターン処理を待たずに即実行したい感じなのでsystemにしない</li>
</ul>
</div>
</div>
<div id="outline-container-org191d453" class="outline-3">
<h3 id="org191d453"><a href="#org191d453"><span class="done DONE">DONE</span> 腹減りでHPが減らないのを修正する</a></h3>
<div class="outline-text-3" id="text-org191d453">
<p>
なぜかダメージが通らなくなっている。
</p>

<p>
攻撃主と対象が同じのため、ダメージが通らなくなっていた。腹減り時のeffectの攻撃主をNoneに設定して完了。
</p>
</div>
</div>
<div id="outline-container-org0746916" class="outline-3">
<h3 id="org0746916"><a href="#org0746916"><span class="done DONE">DONE</span> systemをmoduleにする</a></h3>
<div class="outline-text-3" id="text-org0746916">
<p>
多くてディレクトリがわかりづらくなっている。チュートリアルの最終盤にあったがまだやってない。
</p>
</div>
</div>
<div id="outline-container-org9ed49c4" class="outline-3">
<h3 id="org9ed49c4"><a href="#org9ed49c4"><span class="done DONE">DONE</span> 戦闘ログとフィールドログを共通の仕組みにする</a></h3>
<div class="outline-text-3" id="text-org9ed49c4">
<p>
表示データが異なるだけで、操作は同じなので。引数でデータを選択できるようにした。
</p>
</div>
</div>
<div id="outline-container-org899030d" class="outline-3">
<h3 id="org899030d"><a href="#org899030d"><span class="done DONE">DONE</span> 戦闘メッセージボックスをバッチ化</a></h3>
<div class="outline-text-3" id="text-org899030d">
<p>
フィールドUIと同じ形式で文字を表示する。フィールドUIはチュートリアルのリファクタで共通化されている。はずなのだが、旧の部分が残っている気がする。
</p>

<p>
ターゲット選択部分は同じ関数なのに、フィールドと戦闘で結果に差が出る。戦闘の選択肢がBから表示され、若干表示が乱れている。対象をプレイヤーに限定したらおかしくなくなった。どうせ今は味方にしか意味のあるアイテムだけなので良い。
</p>

<p>
将来的にはアイテムに対象を味方単体、敵単体、味方全体、敵全体という風にもたせて、アイテムごとでそれらのターゲット選択画面を出す出さないを決めたい。
</p>
</div>
</div>
<div id="outline-container-org4d70efb" class="outline-3">
<h3 id="org4d70efb"><a href="#org4d70efb"><span class="done DONE">DONE</span> 戦闘用GUIを分割する</a></h3>
<div class="outline-text-3" id="text-org4d70efb">
<p>
一緒くたにbattle.rsへ入っていてわかりづらいので、フィールドと同様に分割する。とりあえずフィールドとの共通化は考えないが、すでにアイテム使用は同じ関数になっている。
</p>

<p>
guiディレクトリをbattle用、フィールド用でさらに分けてもいいのだが、そんなに意味なさそうな感じもする。battleはそんなに多くないからな。
</p>
</div>
</div>
<div id="outline-container-org5cab9f2" class="outline-3">
<h3 id="org5cab9f2"><a href="#org5cab9f2"><span class="done DONE">DONE</span> デバッグ用の敵召喚</a></h3>
<div class="outline-text-3" id="text-org5cab9f2">
<p>
いちいち敵を探すのがだるいので目の前へ召喚できるようにする。
</p>
</div>
</div>
<div id="outline-container-org4432961" class="outline-3">
<h3 id="org4432961"><a href="#org4432961"><span class="done DONE">DONE</span> MP → SPに変更</a></h3>
<div class="outline-text-3" id="text-org4432961">
<p>
単に名前を変えるだけ。魔法は出てこない。
</p>
</div>
</div>
<div id="outline-container-orge799c6c" class="outline-3">
<h3 id="orge799c6c"><a href="#orge799c6c"><span class="done DONE">DONE</span> スクショ更新</a></h3>
<div class="outline-text-3" id="text-orge799c6c">
</div>
</div>
<div id="outline-container-org60a17ea" class="outline-3">
<h3 id="org60a17ea"><a href="#org60a17ea"><span class="done DONE">DONE</span> ゲーム画面を画像に埋め込む</a></h3>
<div class="outline-text-3" id="text-org60a17ea">
<p>
ブラウザ版。ブラウン管の背景画像を設定し、透過させたらすごくそれっぽくなった。
</p>
</div>
</div>
<div id="outline-container-org1b98ad4" class="outline-3">
<h3 id="org1b98ad4"><a href="#org1b98ad4"><span class="done DONE">DONE</span> 画像設定</a></h3>
<div class="outline-text-3" id="text-org1b98ad4">
<p>
メインメニューと戦闘の画面を設定する。戦闘の背景はステージによって変化させたい。
</p>
</div>
</div>
<div id="outline-container-orge1092f9" class="outline-3">
<h3 id="orge1092f9"><a href="#orge1092f9"><span class="done DONE">DONE</span> バイナリビルド</a></h3>
<div class="outline-text-3" id="text-orge1092f9">
<p>
主要OSでビルドしてリリースに添付する。
</p>

<ul class="org-ul">
<li>Linuxではwayland関係で実行エラーになる。Windows(wine)はうまくいった。クロスビルド用のライブラリを使えばよいらしい</li>
<li>Macではうまくいかなかったので無視。crossのビルド対象になかった</li>
</ul>
</div>
</div>
<div id="outline-container-org663ee70" class="outline-3">
<h3 id="org663ee70"><a href="#org663ee70"><span class="done DONE">DONE</span> 画像フォントを設定する</a></h3>
<div class="outline-text-3" id="text-org663ee70">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>画像フォントを設定する。重ね合わせて表示するものは上側がno_bgでないといけない</label><pre class="src src-rust">use rltk::BTermBuilder;

const SCREEN_WIDTH: i32 = 80;
const SCREEN_HEIGHT: i32 = 60;
const DISPLAY_WIDTH: i32 = SCREEN_WIDTH / 2;
const DISPLAY_HEIGHT: i32 = SCREEN_HEIGHT / 2;

let context = BTermBuilder::new()
    .with_title("Dungeon Crawler")
    .with_fps_cap(30.0)
    .with_dimensions(DISPLAY_WIDTH, DISPLAY_HEIGHT)
    .with_tile_dimensions(8, 8)
    .with_resource_path("resources/")
    .with_font("dungeonfont.png", 32, 32)
    .with_simple_console(DISPLAY_WIDTH, DISPLAY_HEIGHT, "dungeonfont.png")
    .with_simple_console_no_bg(DISPLAY_WIDTH, DISPLAY_HEIGHT, "dungeonfont.png")
    .build()?;
</pre>
</div>
<ul class="org-ul">
<li>複数のフォントを設定することで、敵をアイコンにしつつ、UIのアルファベットはそのままにできるようだがわからない</li>
<li>日本語表示は数が多すぎるため厳しいよう。フォントと画像をマッピングしている仕組みはどうなっているのだろう。ひらがなカタカナでも難しいように見える</li>
<li>開始ディレクトリが変わるためか、ビルドがエディタからできなくなる。シェルからやらないと、ファイルが見つからないエラーになる</li>
<li>ハンズオンを見る限り、フォントは単一のサイズというわけではない。アイコンフォントはでかくして、普通の文字フォントは小さくすることができる</li>
<li>consoleごとにfontを設定し、入力対象のconsoleを切り替えることで複数のfontを両立できる。重なり順がある</li>
<li>エディタビルドはcompile時にプロジェクトトップに移動することでできる。cdしないとresourceを見つけられずビルドエラーになる</li>
<li>wasmをreleaseビルドして、ブラウザで確認すると空白になっている。ビルドは成功する</li>
<li>jsのエラーを見ると、やはりfont関係のよう</li>
<li>解決できそうにない+レイヤーの複雑化を避けるために画像はあきらめる。もともとマストでやりたいことは戦闘時の敵キャラの表示だったが、これはデフォルトで入ってるフォントを小さくしたうえでxpファイルを表示することで達成できる
<ul class="org-ul">
<li>とはいえこうすると、透過ができない。背景はぴったり表示するので問題ないが、敵画像でこれやるとかなりださい</li>
</ul></li>
<li>あるいは、バイナリ実行のほうがうまくいくのであれば一時的にwasmは放棄するのもありか。先にバイナリビルドを実行できる体制を整えたい</li>
<li>with_sprite_sheet が使えそうな予感</li>
<li>exampleを参考にして、ディレクトリ指定を調整すると解決した</li>
<li>WASMビルド以外で横線が入るのが気になる。EXWMでだけ発生するようだ。cinnamon環境のwineとバイナリ起動だと、横線は入らない</li>
</ul>
</div>
</div>
<div id="outline-container-orgfa56a16" class="outline-3">
<h3 id="orgfa56a16"><a href="#orgfa56a16"><span class="done DONE">DONE</span> want_to_meleeに攻撃方法を渡す</a></h3>
<div class="outline-text-3" id="text-orgfa56a16">
<p>
味方のコマンド選択結果、敵の自動選択の攻撃方法の2つの可能性がある。計算に使いつつ、ログに表示する。
</p>
</div>
</div>
<div id="outline-container-org8be6c6d" class="outline-3">
<h3 id="org8be6c6d"><a href="#org8be6c6d"><span class="done DONE">DONE</span> パーティのHP表示対応</a></h3>
<div class="outline-text-3" id="text-org8be6c6d">
<p>
最初の一人分しか表示されなくて、何人いるのかわかりにくいので。
</p>
</div>
</div>
<div id="outline-container-orgb866fd1" class="outline-3">
<h3 id="orgb866fd1"><a href="#orgb866fd1"><span class="done DONE">DONE</span> アイテムの説明を見られるようにする</a></h3>
<div class="outline-text-3" id="text-orgb866fd1">
<p>
キーボードで選択できるのは素晴らしいが、アイテムの説明を見られないのに気づいた。カーソル移動を実装しないといけなそう。アイテムの効果に加えて、フレーバーテキストも入れたい。
</p>
</div>
</div>
<div id="outline-container-org75eb561" class="outline-3">
<h3 id="org75eb561"><a href="#org75eb561"><span class="done DONE">DONE</span> アイテム詳細ツールチップ</a></h3>
<div class="outline-text-3" id="text-org75eb561">
<p>
アイテム詳細の共通ツールチップを追加する。
</p>

<ul class="org-ul">
<li>x, y, entityをmenusで入れる。guiで表示処理する。menuでitemsを使って使用したx, yが重要になる。</li>
<li>マップのtooltipの場合は、直に渡さなくてもpositionで後から求めることができる。tooltipを常に表示する部分と、tooltipを追加する部分の2つがある</li>
<li>メニューアイテムのtooltipの場合は、x, yは後からわからない。表示しているのと同じ箇所で、tooltipを有効にする必要がある</li>
</ul>
</div>
</div>
<div id="outline-container-org0f7ee16" class="outline-3">
<h3 id="org0f7ee16"><a href="#org0f7ee16"><span class="done DONE">DONE</span> バイナリを配布する</a></h3>
<div class="outline-text-3" id="text-org0f7ee16">
<p>
それぞれのOSですぐ実行できるようにする。
</p>
</div>
</div>
<div id="outline-container-orga278a3d" class="outline-3">
<h3 id="orga278a3d"><a href="#orga278a3d"><span class="done DONE">DONE</span> アイテムの説明文追加</a></h3>
<div class="outline-text-3" id="text-orga278a3d">
<p>
アイテムの説明文。フレーバーテキストというよりは、ちゃんとした説明。
</p>
</div>
</div>
<div id="outline-container-orgbdd7107" class="outline-3">
<h3 id="orgbdd7107"><a href="#orgbdd7107"><span class="done DONE">DONE</span> 店で売買したとき重量の再計算が行われない</a></h3>
<div class="outline-text-3" id="text-orgbdd7107">
<p>
アイテムを拾ったり使うと重量が反映される。が、店で売買したときは変わらない。
</p>

<p>
売買時にdirtyを追加するようにした。が、一歩歩かないと再計算されない。とりあえずこれで良い。
</p>
</div>
</div>
</div>


<div id="outline-container-org57639ec" class="outline-2">
<h2 id="org57639ec"><a href="#org57639ec">Backlinks</a></h2>
<div class="outline-text-2" id="text-org57639ec">
<ul class="org-ul">
<li><a href="./20210615222732-project.html">project</a></li>
<li><a href="./20210703105033-archive.html">Archive</a></li>
<li><a href="./20210817003906-history.html">History</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
