<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-06-10 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>digger</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">digger</h1>
<div id="outline-container-orgc797c1e" class="outline-2">
<h2 id="orgc797c1e"><a href="#orgc797c1e">概要</a></h2>
<div class="outline-text-2" id="text-orgc797c1e">
<p>
<a href="https://github.com/kijimaD/digger">https://github.com/kijimaD/digger</a>
diggerはシンボルエンカウント/ローグライクな要素を持った<a href="20210926145504-game.html#ID-8b79aef9-1073-4788-9e81-68cc63e4f997">game</a>である。<a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a>バージョンは開発途中でやめた。<a href="20210901101339-rust.html#ID-ddc21510-6693-4c1e-9070-db0dd2a8160b">Rust</a>で別のコードをベースに再開した。ゲーム開発は静的型付けでないと厳しそう。
</p>

<ul class="org-ul">
<li>反省
<ul class="org-ul">
<li>機能追加が大変で挫折した</li>
<li>データがオブジェクトの入った配列で管理が大変だった。バケツリレーが発生</li>
<li>UIと機能が一体化</li>
<li>参考になるコードがなかった</li>
<li>自動テストで検知できない</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgec5beb8" class="outline-2">
<h2 id="orgec5beb8"><a href="#orgec5beb8">Goal</a></h2>
<div class="outline-text-2" id="text-orgec5beb8">
<ul class="org-ul">
<li>ゲーム投稿サイト or Steamでリリースすること。</li>
</ul>
</div>
</div>
<div id="outline-container-org70889e5" class="outline-2">
<h2 id="org70889e5"><a href="#org70889e5">Design Doc</a></h2>
<div class="outline-text-2" id="text-org70889e5">
</div>
<div id="outline-container-orge16c7f8" class="outline-3">
<h3 id="orge16c7f8"><a href="#orge16c7f8">Characters</a></h3>
<div class="outline-text-3" id="text-orge16c7f8">
<ul class="org-ul">
<li>主人公</li>
<li>パーティメンバー</li>
<li>モンスター
<ul class="org-ul">
<li>シンボルが種族を示す。ロボット、戦車、珠、ドラゴン、ライム</li>
<li>種族・レベルごとの敵</li>
<li>ダンジョンのボス</li>
</ul></li>
<li>NPC
<ul class="org-ul">
<li>アイテム屋、装備屋、市民、合成屋</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7bfc746" class="outline-3">
<h3 id="org7bfc746"><a href="#org7bfc746">Story</a></h3>
<div class="outline-text-3" id="text-org7bfc746">
<ul class="org-ul">
<li>街を拠点に、遺跡の3つの珠を手に入れる</li>
</ul>
</div>
</div>
<div id="outline-container-org9ce9a6d" class="outline-3">
<h3 id="org9ce9a6d"><a href="#org9ce9a6d">Story progression</a></h3>
<div class="outline-text-3" id="text-org9ce9a6d">
<ul class="org-ul">
<li>ゲームは街からスタートする。街では売買でき、会話からヒントを得られる</li>
<li>遺跡のボスを倒すと珠を手に入れ、次の遺跡が選択できるようになる</li>
<li>3つ手に入れるとラスボスと戦い終了</li>
</ul>
</div>
</div>
<div id="outline-container-orgea512b1" class="outline-3">
<h3 id="orgea512b1"><a href="#orgea512b1">Gameplay</a></h3>
<div class="outline-text-3" id="text-orgea512b1">
<ul class="org-ul">
<li>ローグライク</li>
<li>シンボルエンカウント</li>
<li>RPG的戦闘</li>
<li>合成</li>
</ul>
</div>
</div>
<div id="outline-container-orga685464" class="outline-3">
<h3 id="orga685464"><a href="#orga685464">Goals</a></h3>
<div class="outline-text-3" id="text-orga685464">
<ul class="org-ul">
<li>全体: 3つの珠を集める</li>
<li>短期: 敵を倒して先に進む、出口を探す</li>
<li>落ちているアイテムを拾ったり合成することでより強くする</li>
<li>キャラを成長させる</li>
</ul>
</div>
</div>
<div id="outline-container-orgff427ef" class="outline-3">
<h3 id="orgff427ef"><a href="#orgff427ef">User Skills</a></h3>
<div class="outline-text-3" id="text-orgff427ef">
<ul class="org-ul">
<li>種類の異なるダンジョンを進む</li>
<li>戦略的な動き。AIの挙動や地形を理解して、生存可能性を高める</li>
<li>数値を管理する。装備品や行動のボーナスをうまく使って生存可能性を高める</li>
<li>資源を管理する。重さ、装備品の制約があるなかで、生存可能性を高める</li>
</ul>
</div>
</div>
<div id="outline-container-orgf34d5e0" class="outline-3">
<h3 id="orgf34d5e0"><a href="#orgf34d5e0">Items and Power-Ups</a></h3>
<div class="outline-text-3" id="text-orgf34d5e0">
<p>
ゲームは様々なアイテムを含む。
</p>

<ul class="org-ul">
<li>防具。アーマー、服、帽子、靴</li>
<li>装飾品。指輪、お守り</li>
<li>盾</li>
<li>近接武器</li>
<li>銃器</li>
<li>消耗品。回復薬、栄養剤、ロケット弾</li>
<li>素材、売却物</li>
<li>食料</li>
<li>キーアイテム。珠、鍵</li>
</ul>

<p>
アイテムには重さがある。
アイテムはテーブルにより決定する。
</p>
</div>
</div>
<div id="outline-container-org157a007" class="outline-3">
<h3 id="org157a007"><a href="#org157a007">Progression and challenge</a></h3>
<div class="outline-text-3" id="text-org157a007">
<ul class="org-ul">
<li>敵を倒すと経験値を得てレベルアップする</li>
<li>レベルアップして能力が上がったり、生存に役立つより強力な方法を使えるようになる</li>
<li>階を降りるごとにレベルと難易度が上がる。たまにレベルより強い敵に出会うことがある</li>
<li>理不尽な偶然でプレイヤーを殺さない</li>
</ul>
</div>
</div>
<div id="outline-container-org1198641" class="outline-3">
<h3 id="org1198641"><a href="#org1198641">Losing</a></h3>
<div class="outline-text-3" id="text-org1198641">
<ul class="org-ul">
<li>ゲームオーバーになった場合、得たアイテムやキャラクターを失う</li>
</ul>
</div>
</div>
<div id="outline-container-orgd2b04bb" class="outline-3">
<h3 id="orgd2b04bb"><a href="#orgd2b04bb">Art Style</a></h3>
<div class="outline-text-3" id="text-orgd2b04bb">
<ul class="org-ul">
<li>ASCII</li>
</ul>
</div>
</div>
<div id="outline-container-orgc1a1323" class="outline-3">
<h3 id="orgc1a1323"><a href="#orgc1a1323">Music and Sound</a></h3>
<div class="outline-text-3" id="text-orgc1a1323">
<ul class="org-ul">
<li>一切ない</li>
</ul>
</div>
</div>
<div id="outline-container-orge014d56" class="outline-3">
<h3 id="orge014d56"><a href="#orge014d56">Technical Description</a></h3>
<div class="outline-text-3" id="text-orge014d56">
<ul class="org-ul">
<li><a href="20210901101339-rust.html#ID-ddc21510-6693-4c1e-9070-db0dd2a8160b">Rust</a>, rltk</li>
<li>OpenGL, Web Assemblyに変換しブラウザでプレイできる</li>
<li>ローカルでの実行形式もサポートする</li>
</ul>
</div>
</div>
<div id="outline-container-org6088d2d" class="outline-3">
<h3 id="org6088d2d"><a href="#org6088d2d">Marketing and Funding</a></h3>
<div class="outline-text-3" id="text-org6088d2d">
<ul class="org-ul">
<li>無料で公開する</li>
</ul>
</div>
</div>
<div id="outline-container-org9f3d092" class="outline-3">
<h3 id="org9f3d092"><a href="#org9f3d092">Localization</a></h3>
<div class="outline-text-3" id="text-org9f3d092">
<ul class="org-ul">
<li>プレイは英語</li>
<li>ソースコードや開発用ドキュメントに日本語を含む</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org907178f" class="outline-2">
<h2 id="org907178f"><a href="#org907178f">仕様</a></h2>
<div class="outline-text-2" id="text-org907178f">
<ul class="org-ul">
<li>プレイヤーの目的: 3つのダンジョンをクリアすること。</li>
<li>メッセージシーン、フィールド、戦闘で構成
<ul class="org-ul">
<li>フィールド上はローグライク</li>
</ul></li>
<li>空腹度が存在し、ゼロになるとダメージを受ける</li>
<li>4人パーティ構成
<ul class="org-ul">
<li>4つのスロットで武器・防具を選択できる</li>
<li>キャラはスキル、レベルを持つ</li>
</ul></li>
<li>3つのダンジョン
<ul class="org-ul">
<li>5階ごとの脱出機能を使う・遺跡のボスを倒すと帰れ、アイテムを持ち帰れる</li>
<li>ダンジョンによって敵・アイテム・マップのセットが変わる</li>
<li>後半のダンジョンは敵が強くなる</li>
</ul></li>
<li>ダンジョンは20階で構成される。最下層にはボスがいて、倒すとクリア</li>
<li>アイテム
<ul class="org-ul">
<li>通貨によってアイテムを購入できる</li>
<li>素材によってアイテムを作成できる</li>
<li>アイテムを入手できるタイミング: マップで拾う、購入、戦闘に勝利</li>
</ul></li>
<li>シンボルエンカウントの戦闘</li>
</ul>
</div>
</div>
<div id="outline-container-org45c50e1" class="outline-2">
<h2 id="org45c50e1"><a href="#org45c50e1">ロードマップ</a></h2>
<div class="outline-text-2" id="text-org45c50e1">
</div>
<div id="outline-container-org6309036" class="outline-3">
<h3 id="org6309036"><a href="#org6309036">2022</a></h3>
<div class="outline-text-3" id="text-org6309036">
</div>
<div id="outline-container-orgfecd379" class="outline-4">
<h4 id="orgfecd379"><a href="#orgfecd379">5月</a></h4>
<div class="outline-text-4" id="text-orgfecd379">
<ul class="org-ul">
<li>マップシステムをチュートリアルから拝借 ✓</li>
</ul>
</div>
</div>
<div id="outline-container-orga2b3378" class="outline-4">
<h4 id="orga2b3378"><a href="#orga2b3378">6月</a></h4>
<div class="outline-text-4" id="text-orga2b3378">
<ul class="org-ul">
<li>チュートリアルからのインポート作業</li>
<li>戦闘システムの本格的実装</li>
</ul>
</div>
</div>
<div id="outline-container-orgc39a387" class="outline-4">
<h4 id="orgc39a387"><a href="#orgc39a387">7月</a></h4>
<div class="outline-text-4" id="text-orgc39a387">
<ul class="org-ul">
<li>すべてのチュートリアルを終了</li>
<li>hands-on Rustから持ってくる</li>
<li>タイル画像の変更</li>
<li>スキルシステム、パーティシステム</li>
</ul>
</div>
</div>
<div id="outline-container-org065142a" class="outline-4">
<h4 id="org065142a"><a href="#org065142a">8月</a></h4>
<div class="outline-text-4" id="text-org065142a">
<ul class="org-ul">
<li>クリアまでいけるようにする</li>
<li>ストーリー実装</li>
</ul>
</div>
</div>
<div id="outline-container-orgb0aaf64" class="outline-4">
<h4 id="orgb0aaf64"><a href="#orgb0aaf64">9月</a></h4>
</div>
<div id="outline-container-orgb54a674" class="outline-4">
<h4 id="orgb54a674"><a href="#orgb54a674">10月</a></h4>
</div>
<div id="outline-container-orge4efa78" class="outline-4">
<h4 id="orge4efa78"><a href="#orge4efa78">11月</a></h4>
</div>
<div id="outline-container-org344652d" class="outline-4">
<h4 id="org344652d"><a href="#org344652d">12月</a></h4>
</div>
</div>
<div id="outline-container-org9c537b8" class="outline-3">
<h3 id="org9c537b8"><a href="#org9c537b8">2023</a></h3>
<div class="outline-text-3" id="text-org9c537b8">
</div>
<div id="outline-container-org1ec31d8" class="outline-4">
<h4 id="org1ec31d8"><a href="#org1ec31d8">1月</a></h4>
<div class="outline-text-4" id="text-org1ec31d8">
<ul class="org-ul">
<li>リリース</li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org44d2c30" class="outline-2">
<h2 id="org44d2c30"><a href="#org44d2c30">開発録</a></h2>
<div class="outline-text-2" id="text-org44d2c30">
<ul class="org-ul">
<li>チュートリアルから持ってきてる時間が長すぎて辛いな。自作パートに入らないと理解できてる感じがしないし、実際できてない</li>
<li>自分で修正できるようになるのか、使いこなせるようになるのか、という不安。実際ほとんどの場合は、見るだけでは理解できてない。何も見ずに考える状況にしないと、身につかないことが多かった</li>
<li>コーディングで役立つ重要な概念
<ul class="org-ul">
<li>モジュールを組み合わせてオブジェクトの性質を決める方法</li>
<li>継承を一切使わず、独立性高くゲームを組み立てていく方法</li>
<li>with関数で組み合わせて、一気にbuildする方法。とくにマップエンジン</li>
<li>フィルター。フィルターで複数のビルダーを組み合わせることができる</li>
<li>enumによる安全な分岐</li>
<li>jsonでデータを定義してビルドする方法</li>
</ul></li>
<li>読むときに明確にこれを理解する、と決めて読むとよさそうだ。これで洞窟を生成できる、これで最も大きい建物を求めることができる,とか。</li>
<li>理解できることが増えたが、何も見ずに新しい機能追加できるとは到底言えない。どこか似たような箇所を探しながら、書いていくことしかできない。悲しいことに。</li>
</ul>
</div>
</div>
<div id="outline-container-org8d949ad" class="outline-2">
<h2 id="org8d949ad"><a href="#org8d949ad">memo</a></h2>
<div class="outline-text-2" id="text-org8d949ad">
</div>
<div id="outline-container-org9d5abcb" class="outline-3">
<h3 id="org9d5abcb"><a href="#org9d5abcb">component取得</a></h3>
<div class="outline-text-3" id="text-org9d5abcb">
<div class="org-src-container">
<pre class="src src-rust">let target_pools = pools.get(wants_melee.target).unwrap(); # targetにはEntityが入ってる
</pre>
</div>
</div>
</div>
<div id="outline-container-org8ce5d1c" class="outline-3">
<h3 id="org8ce5d1c"><a href="#org8ce5d1c">entity削除の方法</a></h3>
<div class="outline-text-3" id="text-org8ce5d1c">
<div class="org-src-container">
<pre class="src src-rust">ecs.delete_entity(entity).expect("Unable to delete");;
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust">entities.delete(entity).expect("Delete failed")
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust">let entity = ecs.fetch::&lt;Entity&gt;();
combatants.remove(*entity);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-rust">let mut battle = ecs.write_storage::&lt;Battle&gt;();
battle.clear();
</pre>
</div>
</div>
</div>
<div id="outline-container-org4e878f2" class="outline-3">
<h3 id="org4e878f2"><a href="#org4e878f2">entityを取得する2つの方法</a></h3>
<div class="outline-text-3" id="text-org4e878f2">
<p>
fetchを使って取得すると、イテレーションできない。
entitiesだとイテレーションできる。
</p>
<div class="org-src-container">
<pre class="src src-rust">let entity = ecs.fetch::&lt;Entity&gt;();

let entities = ecs.entities();
</pre>
</div>
</div>
</div>
<div id="outline-container-orgee78c92" class="outline-3">
<h3 id="orgee78c92"><a href="#orgee78c92">entityをアイテム化</a></h3>
<div class="outline-text-3" id="text-orgee78c92">
<p>
position componentをremove + InBackPackをinsertで、落ちているアイテムをインベントリへ入れた扱いにする。自由にcomponentを付け外せる。
</p>

<div class="org-src-container">
<pre class="src src-rust">for pickup in wants_pickup.join() {
    positions.remove(pickup.item);
    backpack
        .insert(pickup.item, InBackpack { owner: pickup.collected_by })
        .expect("Unable to insert backpack entry");

    if pickup.collected_by == *player_entity {
        gamelog
            .entries
            .push(format!("You pick up the {}.", names.get(pickup.item).unwrap().name));
    }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org3566218" class="outline-2">
<h2 id="org3566218"><a href="#org3566218">todo</a></h2>
<div class="outline-text-2" id="text-org3566218">
</div>
<div id="outline-container-orgddb74b4" class="outline-3">
<h3 id="orgddb74b4"><a href="#orgddb74b4"><span class="todo TODO">TODO</span> Battleリファクタ</a></h3>
<div class="outline-text-3" id="text-orgddb74b4">
</div>
</div>
<div id="outline-container-org9faaf44" class="outline-3">
<h3 id="org9faaf44"><a href="#org9faaf44"><span class="todo TODO">TODO</span> ECS(Entity Component System)入門</a></h3>
<div class="outline-text-3" id="text-org9faaf44">
<p>
ゲームライブラリについての理解がないので、本で学ぶ。
</p>

<p>
Entity Component System、MVCのようなものである。
</p>
<ul class="org-ul">
<li>Entityはゲーム内のオブジェクトの識別子。Entityは単体では具体的な機能は持たず、Componentと紐付ける。自キャラクター、敵キャラクター、ステージの障害物</li>
<li>Componentは機能を分解したデータ。ゲーム内の機能を構成するデータ。位置やスケールを定義する機能、画像などの描画機能。Componentは配列的に管理される</li>
<li>Systemは、Componentへの作用を行う。ゲーム内のロジックをComponent単位で考え、Componentを入出力する処理として実装する。Component配列に対して一括で処理を行ってロジックを実現する</li>
</ul>

<p>
Resourceはオブジェクトに紐付かないゲーム中の機能の役割を果たす要素。
Resourceは(Read+Write)、(ReadExpect+WriteExpect)を利用し、Componentは(ReadStorage+WriteStorage)を利用する。Resoource作成はinsert、取得はtry_fetch::&lt;Hoge&gt;{}, try_fetch_mut::&lt;Hoge&gt;{}。
</p>
</div>
</div>
<div id="outline-container-orga5a91c6" class="outline-3">
<h3 id="orga5a91c6"><a href="#orga5a91c6"><span class="todo TODO">TODO</span> 攻撃方法実装&#xa0;&#xa0;&#xa0;<span class="tag"><span class="8">8</span></span></a></h3>
<div class="outline-text-3" id="text-orga5a91c6">
<p>
モンスターとプレイヤーの両方が攻撃方法を選べるようにする。
</p>
</div>
</div>
<div id="outline-container-org670fd35" class="outline-3">
<h3 id="org670fd35"><a href="#org670fd35"><span class="todo TODO">TODO</span> エンカウント時のモンスター決定&#xa0;&#xa0;&#xa0;<span class="tag"><span class="8">8</span></span></a></h3>
<div class="outline-text-3" id="text-org670fd35">
<p>
現在は固定している。
</p>

<ul class="org-ul">
<li>階層</li>
<li>mapエンティティ</li>
<li>ダンジョン種別</li>
<li>レベル</li>
</ul>

<p>
から、エンカウントモンスターを決定する。2体出るときもある。mapの配置選択と似たような感じでいけそう。
</p>
</div>
</div>
<div id="outline-container-org9f7027a" class="outline-3">
<h3 id="org9f7027a"><a href="#org9f7027a"><span class="todo TODO">TODO</span> 敵を倒した後に情報を取れるようにする&#xa0;&#xa0;&#xa0;<span class="tag"><span class="5">5</span></span></a></h3>
<div class="outline-text-3" id="text-org9f7027a">
<p>
現在はHPが0になったら削除してるので、例えば戦闘後に経験値を入れるといったことができない。
もっとも、battle自体に取得予定の経験値を保存しておけばいいので、モンスター自体を保持しておくのは不要か。
</p>
</div>
</div>
<div id="outline-container-org7dabcde" class="outline-3">
<h3 id="org7dabcde"><a href="#org7dabcde"><span class="todo TODO">TODO</span> パーティシステム&#xa0;&#xa0;&#xa0;<span class="tag"><span class="8">8</span></span></a></h3>
<div class="outline-text-3" id="text-org7dabcde">
<p>
現在のプレイヤーは、マップオブジェクト=戦闘オブジェクトになっている。モンスターと同様に、エンティティを分割する。戦闘中のコマンドをどうするか決める。
</p>
</div>
</div>
<div id="outline-container-orgad4ec9c" class="outline-3">
<h3 id="orgad4ec9c"><a href="#orgad4ec9c"><span class="todo TODO">TODO</span> HUD改良&#xa0;&#xa0;&#xa0;<span class="tag"><span class="5">5</span></span></a></h3>
<div class="outline-text-3" id="text-orgad4ec9c">
<p>
メッセージボックスと重なって見にくいので。新たに追加する余地もない。
</p>
</div>
</div>
<div id="outline-container-org7a43113" class="outline-3">
<h3 id="org7a43113"><a href="#org7a43113"><span class="todo TODO">TODO</span> 逃走コード分離&#xa0;&#xa0;&#xa0;<span class="tag"><span class="5">5</span></span></a></h3>
<div class="outline-text-3" id="text-org7a43113">
<p>
全体的に分離されてないので、分離。
</p>
</div>
</div>
<div id="outline-container-org1e1063a" class="outline-3">
<h3 id="org1e1063a"><a href="#org1e1063a"><span class="todo TODO">TODO</span> 戦闘系コード整理&#xa0;&#xa0;&#xa0;<span class="tag"><span class="5">5</span></span></a></h3>
<div class="outline-text-3" id="text-org1e1063a">
<p>
生死判定、勝利判定でごちゃついていて、どこにあるかわからない。
</p>
</div>
</div>
<div id="outline-container-org957ccf9" class="outline-3">
<h3 id="org957ccf9"><a href="#org957ccf9"><span class="todo TODO">TODO</span> メッセージシステム&#xa0;&#xa0;&#xa0;<span class="tag"><span class="13">13</span></span></a></h3>
</div>
<div id="outline-container-org14c0ce8" class="outline-3">
<h3 id="org14c0ce8"><a href="#org14c0ce8"><span class="todo TODO">TODO</span> アイテム合成&#xa0;&#xa0;&#xa0;<span class="tag"><span class="13">13</span></span></a></h3>
<div class="outline-text-3" id="text-org14c0ce8">
</div>
<div id="outline-container-org1a1c37c" class="outline-4">
<h4 id="org1a1c37c"><a href="#org1a1c37c"><span class="todo TODO">TODO</span> 素材アイテムを追加&#xa0;&#xa0;&#xa0;<span class="tag"><span class="5">5</span></span></a></h4>
</div>
<div id="outline-container-org6255d5c" class="outline-4">
<h4 id="org6255d5c"><a href="#org6255d5c"><span class="todo TODO">TODO</span> UI作成</a></h4>
</div>
</div>
<div id="outline-container-org940fa2c" class="outline-3">
<h3 id="org940fa2c"><a href="#org940fa2c"><span class="todo TODO">TODO</span> 戦闘システム&#xa0;&#xa0;&#xa0;<span class="tag"><span class="21">21</span></span></a></h3>
<div class="outline-text-3" id="text-org940fa2c">
</div>
<div id="outline-container-org74ff8a4" class="outline-4">
<h4 id="org74ff8a4"><a href="#org74ff8a4"><span class="todo TODO">TODO</span> モンスターや仲間の攻撃方法の反映(かぎづめ、剣、パンチ)</a></h4>
</div>
<div id="outline-container-org5d46420" class="outline-4">
<h4 id="org5d46420"><a href="#org5d46420"><span class="todo TODO">TODO</span> 装備武器</a></h4>
</div>
<div id="outline-container-org9bcc279" class="outline-4">
<h4 id="org9bcc279"><a href="#org9bcc279"><span class="todo TODO">TODO</span> コマンド…行動を選べる</a></h4>
</div>
<div id="outline-container-org59864d4" class="outline-4">
<h4 id="org59864d4"><a href="#org59864d4"><span class="todo TODO">TODO</span> SP…武器やスキルの使用にはスタミナが必要</a></h4>
</div>
</div>
<div id="outline-container-org11fb72e" class="outline-3">
<h3 id="org11fb72e"><a href="#org11fb72e"><span class="todo TODO">TODO</span> スキル&#xa0;&#xa0;&#xa0;<span class="tag"><span class="13">13</span></span></a></h3>
<div class="outline-text-3" id="text-org11fb72e">
<p>
戦闘や行動によってスキルが上がり、生存に有利な補正がかかる。
</p>
</div>
</div>
<div id="outline-container-org17d1c4a" class="outline-3">
<h3 id="org17d1c4a"><a href="#org17d1c4a"><span class="todo TODO">TODO</span> スロット・部位ごとの装備&#xa0;&#xa0;&#xa0;<span class="tag"><span class="13">13</span></span></a></h3>
<div class="outline-text-3" id="text-org17d1c4a">
<p>
4つのスロットがあり自由に装備できる。同じ部位の装備はできない。
</p>
</div>
</div>
<div id="outline-container-org6e7836f" class="outline-3">
<h3 id="org6e7836f"><a href="#org6e7836f"><span class="todo TODO">TODO</span> 戦闘終了後1ターン経過しないと敵シンボルが死なないバグ</a></h3>
</div>
<div id="outline-container-orgb665b1c" class="outline-3">
<h3 id="orgb665b1c"><a href="#orgb665b1c"><span class="todo WIP">WIP</span> 装備品追加(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgb665b1c">
</div>
</div>
</div>
<div id="outline-container-org0823406" class="outline-2">
<h2 id="org0823406"><a href="#org0823406">いつか</a></h2>
<div class="outline-text-2" id="text-org0823406">
</div>
<div id="outline-container-org9565a16" class="outline-3">
<h3 id="org9565a16"><a href="#org9565a16"><span class="todo TODO">TODO</span> 日本語を表示できるようにする</a></h3>
<div class="outline-text-3" id="text-org9565a16">
<p>
フォントをどうやって変えるのかがわからない。
</p>
</div>
</div>
<div id="outline-container-org4398949" class="outline-3">
<h3 id="org4398949"><a href="#org4398949"><span class="todo TODO">TODO</span> マップのシード値を取れるようにする</a></h3>
<div class="outline-text-3" id="text-org4398949">
<p>
シードを指定すると同じマップを生成できる。デバッグで便利。
</p>
</div>
</div>
<div id="outline-container-org0f75a5e" class="outline-3">
<h3 id="org0f75a5e"><a href="#org0f75a5e"><span class="todo TODO">TODO</span> ゲームオーバーになったあと再開するとHP表示がUIから消える</a></h3>
</div>
</div>
<div id="outline-container-orge2efa0d" class="outline-2">
<h2 id="orge2efa0d"><a href="#orge2efa0d">References</a></h2>
<div class="outline-text-2" id="text-orge2efa0d">
<blockquote>
<dl class="org-dl">
<dt><a href="http://www.roguebasin.com/index.php/Articles">http://www.roguebasin.com/index.php/Articles</a></dt><dd>ローグライクに関する情報が集約されている。</dd>
<dt><a href="http://www.roguebasin.com/index.php?title=How_to_Write_a_Roguelike_in_15_Steps">http://www.roguebasin.com/index.php?title=How_to_Write_a_Roguelike_in_15_Steps</a></dt><dd>ローグライクの作り方のヒント。</dd>
<dt><a href="https://countable.hatenablog.com/entry/20120717/1342505647">https://countable.hatenablog.com/entry/20120717/1342505647</a></dt><dd>↑ページの和訳</dd>
<dt><a href="https://techblog.sega.jp/entry/2018/08/27/100000">https://techblog.sega.jp/entry/2018/08/27/100000</a></dt><dd>ゲームのテスト</dd>
<dt><a href="https://www.amazon.co.jp/Programming-Patterns-%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%96%8B%E7%99%BA%E3%81%AE%E5%95%8F%E9%A1%8C%E8%A7%A3%E6%B1%BA%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC-impress-gear%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-ebook/dp/B015R0M8W0/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;dchild=1&amp;keywords=%E3%82%B2%E3%83%BC%E3%83%A0+%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3&amp;qid=1627347211&amp;sr=8-1">https://www.amazon.co.jp/Programming-Patterns-%E3%82%BD%E3%83%95%E3%83%88%E3%82%A6%E3%82%A7%E3%82%A2%E9%96%8B%E7%99%BA%E3%81%AE%E5%95%8F%E9%A1%8C%E8%A7%A3%E6%B1%BA%E3%83%A1%E3%83%8B%E3%83%A5%E3%83%BC-impress-gear%E3%82%B7%E3%83%AA%E3%83%BC%E3%82%BA-ebook/dp/B015R0M8W0/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;dchild=1&amp;keywords=%E3%82%B2%E3%83%BC%E3%83%A0+%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3&amp;qid=1627347211&amp;sr=8-1</a></dt><dd>ゲームデザインパターン</dd>
<dt><a href="https://www.amazon.co.jp/Hands-Rust-English-Herbert-Wolverson-ebook/dp/B09BK8Q6GY/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;crid=26DQRMWP5RQIE&amp;keywords=hands-on+rust&amp;qid=1651655347&amp;sprefix=hands-on+ru%2Caps%2C196&amp;sr=8-1">https://www.amazon.co.jp/Hands-Rust-English-Herbert-Wolverson-ebook/dp/B09BK8Q6GY/ref=sr_1_1?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;crid=26DQRMWP5RQIE&amp;keywords=hands-on+rust&amp;qid=1651655347&amp;sprefix=hands-on+ru%2Caps%2C196&amp;sr=8-1</a></dt><dd>2Dゲームのハンズオン</dd>
</dl>
</blockquote>
</div>
</div>
<div id="outline-container-org600dbf5" class="outline-2">
<h2 id="org600dbf5"><a href="#org600dbf5">Archives</a></h2>
<div class="outline-text-2" id="text-org600dbf5">
</div>
<div id="outline-container-org1c05ca0" class="outline-3">
<h3 id="org1c05ca0"><a href="#org1c05ca0"><span class="done DONE">DONE</span> 移動システム</a></h3>
<div class="outline-text-3" id="text-org1c05ca0">
<ul class="org-ul">
<li>地形判定</li>
</ul>
</div>
</div>
<div id="outline-container-org8128e60" class="outline-3">
<h3 id="org8128e60"><a href="#org8128e60"><span class="done DONE">DONE</span> マップをtxtファイルから読み込む</a></h3>
<div class="outline-text-3" id="text-org8128e60">
</div>
</div>
<div id="outline-container-org87642ef" class="outline-3">
<h3 id="org87642ef"><a href="#org87642ef"><span class="done DONE">DONE</span> mainファイル分割</a></h3>
<div class="outline-text-3" id="text-org87642ef">
<p>
同じ形にした。
</p>
</div>
</div>
<div id="outline-container-orgf33a853" class="outline-3">
<h3 id="orgf33a853"><a href="#orgf33a853"><span class="done DONE">DONE</span> テスト追加</a></h3>
<div class="outline-text-3" id="text-orgf33a853">
</div>
</div>
<div id="outline-container-org0e090b1" class="outline-3">
<h3 id="org0e090b1"><a href="#org0e090b1"><span class="done DONE">DONE</span> テスト環境構築</a></h3>
<div class="outline-text-3" id="text-org0e090b1">
<ul class="org-ul">
<li>単独RSpec</li>
<li>カバレッジ</li>
</ul>
</div>
</div>
<div id="outline-container-org899ba0b" class="outline-3">
<h3 id="org899ba0b"><a href="#org899ba0b"><span class="done DONE">DONE</span> 複数ウィンドウエリア</a></h3>
<div class="outline-text-3" id="text-org899ba0b">
<p>
メッセージエリア、ステータスエリアなどウィンドウにエリアを追加する。
</p>
</div>
</div>
<div id="outline-container-orga800929" class="outline-3">
<h3 id="orga800929"><a href="#orga800929"><span class="done DONE">DONE</span> component追加</a></h3>
<div class="outline-text-3" id="text-orga800929">
<p>
game_objectを構成するもの。直に起動されることはなく、object_poolにもaddされない。
</p>
</div>
</div>
<div id="outline-container-org4bbcccb" class="outline-3">
<h3 id="org4bbcccb"><a href="#org4bbcccb"><span class="done DONE">DONE</span> inputに分割</a></h3>
<div class="outline-text-3" id="text-org4bbcccb">
<p>
今はすべてfield_stateでやっているが、characterのcomponentでやるようにする。
</p>
</div>
</div>
<div id="outline-container-orgbb84955" class="outline-3">
<h3 id="orgbb84955"><a href="#orgbb84955"><span class="done DONE">DONE</span> 別入力</a></h3>
<div class="outline-text-3" id="text-orgbb84955">
<p>
とりあえず敵をランダム移動できるようにする。
</p>
</div>
</div>
<div id="outline-container-orgd84a96b" class="outline-3">
<h3 id="orgd84a96b"><a href="#orgd84a96b"><span class="done DONE">DONE</span> message_displayとmessageの分割</a></h3>
<div class="outline-text-3" id="text-orgd84a96b">
<p>
statsを作ってそこにmessageを入れることで対応した。
</p>
</div>
</div>
<div id="outline-container-org8474edd" class="outline-3">
<h3 id="org8474edd"><a href="#org8474edd"><span class="done DONE">DONE</span> テストrequireを自動化する</a></h3>
<div class="outline-text-3" id="text-org8474edd">
<p>
めんどいので。
</p>
</div>
</div>
<div id="outline-container-org37e1ecc" class="outline-3">
<h3 id="org37e1ecc"><a href="#org37e1ecc"><span class="done DONE">DONE</span> RSpec lintを追加した</a></h3>
<div class="outline-text-3" id="text-org37e1ecc">
<p>
その日の気分で書きがちなところに基準ができた。必須だな。
</p>
</div>
</div>
<div id="outline-container-org37b91b7" class="outline-3">
<h3 id="org37b91b7"><a href="#org37b91b7"><span class="done DONE">DONE</span> object_poolオブジェクト間の接触判定</a></h3>
<div class="outline-text-3" id="text-org37b91b7">
<p>
地形判定とは異なる。オブジェクト層で起こる反応。
game_objectとmapではやり方が異なる。
</p>
</div>
</div>
<div id="outline-container-org07f774a" class="outline-3">
<h3 id="org07f774a"><a href="#org07f774a"><span class="done DONE">DONE</span> boxつけるとずれる問題</a></h3>
<div class="outline-text-3" id="text-org07f774a">
<p>
範囲がわかりづらいのでつけたいが、横方向がずれてる。
最初の一行だけ正しくて、改行以降はインデントがセットされてない、みたいな状況か。
</p>
<pre class="example">
 aaa
aaa
aaa
</pre>
<p>
かな。
</p>

<p>
一行ずつ出力することで解決した。
</p>
</div>
</div>
<div id="outline-container-orgb35f72c" class="outline-3">
<h3 id="orgb35f72c"><a href="#orgb35f72c"><span class="done DONE">DONE</span> 基地メニュー</a></h3>
<div class="outline-text-3" id="text-orgb35f72c">
<p>
2つ目state。
まだ内容はない。
</p>
</div>
</div>
<div id="outline-container-org1734201" class="outline-3">
<h3 id="org1734201"><a href="#org1734201"><span class="done DONE">DONE</span> ウィンドウ分割</a></h3>
<div class="outline-text-3" id="text-org1734201">
<p>
対応の必要なし。
</p>

<p>
メインウィンドウにすべて表示してたが、分割したほうがやりやすそうなので分割する。
マップウィンドウ、メッセージウィンドウとか。
</p>

<p>
その場合、ウィンドウ構成がモードによって変わる。どうやって表現すればよいだろう。
うーん、やっぱり面倒なのでメインウィンドウに座標挿入でよさそう。
</p>

<p>
stateによって使い回せるしな。
</p>
</div>
</div>
<div id="outline-container-org7687a60" class="outline-3">
<h3 id="org7687a60"><a href="#org7687a60"><span class="done DONE">DONE</span> ゲームのおおまかな計画をやる</a></h3>
<div class="outline-text-3" id="text-org7687a60">
<p>
バトルディッガーにしようとうっすら考えてたが、さすがに丸パクはできないので、混ぜよう。
そろそろどういう仕様にするか決めないといけない段階。
</p>

<p>
合成システムはカンタンに実装できて奥深そうなんだよな。
なのでシステム的にはディッガーよりハタ人間。
</p>

<ul class="org-ul">
<li>アイテム合成</li>
</ul>
</div>
</div>
<div id="outline-container-orgae18a94" class="outline-3">
<h3 id="orgae18a94"><a href="#orgae18a94"><span class="done DONE">DONE</span> フォント</a></h3>
<div class="outline-text-3" id="text-orgae18a94">
<dl class="org-dl">
<dt>Press Start 2p</dt><dd>横幅的には一番</dd>
<dt>misaki font</dt><dd>日本語対応</dd>
</dl>
</div>
</div>
<div id="outline-container-org9863016" class="outline-3">
<h3 id="org9863016"><a href="#org9863016"><span class="done DONE">DONE</span> AIキャラが消える問題</a></h3>
<div class="outline-text-3" id="text-org9863016">
<p>
updateはAIキャラが動かない。
drawは全員消える。
</p>

<p>
game_objectにupdate, drawメソッドがあると、componentのdraw, updateが上書きされるため起こる。
ai_inputはcomponentでupdateを使って入力を生成してるが、player_inputはbutton_downのため、問題が起きたり起きなかったりする。
</p>

<p>
drawでは機能しないのはなぜだ。処理の順番か。field_stateの処理の順番を並べ替えるとできた。
object_pool.draw
map.draw
の順番にしないといけない。
</p>
</div>
</div>
<div id="outline-container-orgc4479c0" class="outline-3">
<h3 id="orgc4479c0"><a href="#orgc4479c0"><span class="done DONE">DONE</span> カメラ追加</a></h3>
<div class="outline-text-3" id="text-orgc4479c0">
</div>
</div>
<div id="outline-container-orgb8363c6" class="outline-3">
<h3 id="orgb8363c6"><a href="#orgb8363c6"><span class="done DONE">DONE</span> アイテム追加する</a></h3>
<div class="outline-text-3" id="text-orgb8363c6">
<p>
game_objectのアイテムと、所持品としてのアイテムをどう分ければよいだろう。
少なくとも単語を分けることが必要そう。
</p>

<p>
pickupはいいセンいってるが、動作っぽい。
まあいいか。後からどうするか明確になってからで。
</p>
</div>
</div>
<div id="outline-container-orgab0a683" class="outline-3">
<h3 id="orgab0a683"><a href="#orgab0a683"><span class="done DONE">DONE</span> プレイヤーキャラ以外を追加する</a></h3>
<div class="outline-text-3" id="text-orgab0a683">
<p>
表示文字をキャラによって変える必要がある。
inputによって分岐するようにした。
</p>
</div>
</div>
<div id="outline-container-orge505707" class="outline-3">
<h3 id="orge505707"><a href="#orge505707"><span class="done DONE">DONE</span> メニュー追加する</a></h3>
<div class="outline-text-3" id="text-orge505707">
<p>
画面追加だけできした。あとはカーソル移動とかか。
</p>
</div>
</div>
<div id="outline-container-org0667348" class="outline-3">
<h3 id="org0667348"><a href="#org0667348"><span class="done DONE">DONE</span> 設定のファイル化</a></h3>
<div class="outline-text-3" id="text-org0667348">
<p>
CDDAみたいに、設定類はすべてjsonかymlにする。
キャラクターは完了。とはいえシルエットだけなのでそんなにパラメータはない。
一応はできたが、これがtype objectと自信がもてない。characterはマップのシルエットとして使うくらいだからあまり必要性ないんだよな。
</p>
</div>
</div>
<div id="outline-container-orgfed6b1d" class="outline-3">
<h3 id="orgfed6b1d"><a href="#orgfed6b1d"><span class="done DONE">DONE</span> ターン実装</a></h3>
<div class="outline-text-3" id="text-orgfed6b1d">
<p>
getchでなんとなくターンぽくなっているが、移動以外でもターンが進んでしまう。
ターンが進むのは移動だけでよさそう。ローグライクだったら攻撃でも進むが、このゲームにはない。
</p>

<p>
player_inputかつ、移動ができたときだけexecuteフラグをオンにする。
</p>
</div>
</div>
<div id="outline-container-orgd7ba7bf" class="outline-3">
<h3 id="orgd7ba7bf"><a href="#orgd7ba7bf"><span class="done DONE">DONE</span> characterをphysicsに分割する</a></h3>
<div class="outline-text-3" id="text-orgd7ba7bf">
</div>
</div>
<div id="outline-container-org2f574f2" class="outline-3">
<h3 id="org2f574f2"><a href="#org2f574f2"><span class="done DONE">DONE</span> メニュー画面でカーソル移動できるようにする</a></h3>
<div class="outline-text-3" id="text-org2f574f2">
<p>
カーソル移動はメンドイのでしない。
</p>
</div>
</div>
<div id="outline-container-org65df91a" class="outline-3">
<h3 id="org65df91a"><a href="#org65df91a"><span class="done DONE">DONE</span> Terrainクラスを作る(flyweightパターン)</a></h3>
<div class="outline-text-3" id="text-org65df91a">
<p>
コードで直に地形判定をしているため。
地形用のクラスに切り分ける。
Terrainオブジェクトは状況非依存。つまり草地タイルはすべて同一。
なので、Terrainオブジェクトの格子にするのではなく、Terrainオブジェクトへのポインタにする。
</p>

<ul class="org-ul">
<li>地形情報にアクセスするために、worldから取る必要がなくなる。</li>
<li>タイルから直にアクセスできるように。</li>
</ul>

<p>
まず文字列のマップをオブジェクトのマップにする。
どうやってやればいいんだ。
</p>
</div>
</div>
<div id="outline-container-org6787436" class="outline-3">
<h3 id="org6787436"><a href="#org6787436"><span class="done DONE">DONE</span> item_type</a></h3>
<div class="outline-text-3" id="text-org6787436">
<p>
作ろうと思ったがどうしよう。どういったプロパティを持つか。
</p>
<ul class="org-ul">
<li>アイテムの中身</li>
</ul>

<p>
とりあえずイメージしやすいように名前を取り出せるようにする。
フィールドオブジェクトしては名前くらいしか必要でない。
</p>
</div>
</div>
<div id="outline-container-org480dd42" class="outline-3">
<h3 id="org480dd42"><a href="#org480dd42"><span class="done DONE">DONE</span> インベントリ</a></h3>
<div class="outline-text-3" id="text-org480dd42">
<p>
アイテムを拾ったとき、インベントリに追加する。
フィールドのはアイテムだが、それから別のオブジェクトにするか。
</p>

<p>
消費物、素材は単なる数値だが、装備はさまざまなパラメータを持った別オブジェクトだ。
</p>

<p>
単にオブジェクトを配列に追加するだけだが、仮で完了。
</p>
</div>
</div>
<div id="outline-container-org86bc8b3" class="outline-3">
<h3 id="org86bc8b3"><a href="#org86bc8b3"><span class="done DONE">DONE</span> 衝突テスト</a></h3>
<div class="outline-text-3" id="text-org86bc8b3">
<p>
衝突関係がややこしくなってきたのでテストで確かめることにする。
アイテム、キャラクタ(Ai, Player)
</p>
</div>
</div>
<div id="outline-container-orgd22fea3" class="outline-3">
<h3 id="orgd22fea3"><a href="#orgd22fea3"><span class="done DONE">DONE</span> 自動操作テスト</a></h3>
<div class="outline-text-3" id="text-orgd22fea3">
<p>
オートプレイさせたい。
system spec的な。
実際のキーボード入力をシミュレートする。
</p>

<p>
今はgetchで止まるのでできない。直にbutton_downを受け付けるようにするとかできないか。
そもそもgetchがよくない説もある。アニメーションは一切できないからな。
入力は任意でよくしたい。入力しなくてもゲームループは進む。
ターンベースだろうと、ゲームループは回すほうが表現豊か。
</p>

<p>
テストのときはゲームループを手動で進めればよいのでは。
キーボード入力はできないが、直に入力すればいい。一応できた。
</p>
</div>
</div>
<div id="outline-container-org3af4721" class="outline-3">
<h3 id="org3af4721"><a href="#org3af4721"><span class="done DONE">DONE</span> utilsのload_jsonをデフォルト拡張子jsonにする</a></h3>
<div class="outline-text-3" id="text-org3af4721">
</div>
</div>
<div id="outline-container-orgecf390a" class="outline-3">
<h3 id="orgecf390a"><a href="#orgecf390a"><span class="done DONE">DONE</span> コンパイル(断念)</a></h3>
<div class="outline-text-3" id="text-orgecf390a">
<p>
プレイヤーがいちいちbundle installとかしなくていいようにexeとか実行形式にしたいが、どうすればいいんだろう。
ruby-packerというのがあるらしい。
これで各環境用にコンパイルするようにすればいい。
</p>

<p>
大変そうなので断念。
</p>
</div>
</div>
<div id="outline-container-orgcf50ddf" class="outline-3">
<h3 id="orgcf50ddf"><a href="#orgcf50ddf"><span class="done DONE">DONE</span> インベントリに入れた時の挙動を変える</a></h3>
<div class="outline-text-3" id="text-orgcf50ddf">
<p>
素材系のときは、オブジェクトは保持せず単にカウントアップするだけにする。
武器とか消費アイテムはオブジェクトとして保持する。
</p>

<p>
item_typeにcountを保持することにした。やや不自然だが、itemから直に数を増やす操作ができたり、問い合わせがカンタンだ。いちいち初期化しておく必要もない。
</p>
</div>
</div>
<div id="outline-container-org6cd712d" class="outline-3">
<h3 id="org6cd712d"><a href="#org6cd712d"><span class="done DONE">DONE</span> アイテムをflyweightにする → item_typeを共通にする</a></h3>
<div class="outline-text-3" id="text-org6cd712d">
<p>
今はそれぞれ別のオブジェクトになっているので、共通オブジェクトにする。
jsonで読んでそれを各自インスタンス変数に入れるみたいなことってできるのかな。一気に全インスタンスを配列に入れ、配列をインスタンス変数にするとできる。
</p>

<p>
正確にいうと、item_typeが共通である。itemオブジェクト自体はユニークである。取得して消えたり座標を持ってるから。
</p>
</div>
</div>
<div id="outline-container-orgcdb6780" class="outline-3">
<h3 id="orgcdb6780"><a href="#orgcdb6780"><span class="done DONE">DONE</span> 各state共通のinputを継承元に書く</a></h3>
<div class="outline-text-3" id="text-orgcdb6780">
<p>
たとえば&rsquo;c&rsquo;はどのstateでも終了にしたい。
</p>

<p>
抽象クラスに移動した。
</p>
</div>
</div>
<div id="outline-container-org576df23" class="outline-3">
<h3 id="org576df23"><a href="#org576df23"><span class="done DONE">DONE</span> 移動AI</a></h3>
<div class="outline-text-3" id="text-org576df23">
<p>
経路選択をどうすればよいのだろう。斜めにターゲットがあるときどうやってジグザグを判定するか。
</p>
</div>
</div>
<div id="outline-container-org74fda68" class="outline-3">
<h3 id="org74fda68"><a href="#org74fda68"><span class="done DONE">DONE</span> エンカウント追加</a></h3>
<div class="outline-text-3" id="text-org74fda68">
<p>
戦闘モードへ遷移する。
</p>
</div>
</div>
<div id="outline-container-orgbc1146f" class="outline-3">
<h3 id="orgbc1146f"><a href="#orgbc1146f"><span class="done DONE">DONE</span> パーティ状況を表示する</a></h3>
<div class="outline-text-3" id="text-orgbc1146f">
<p>
まず戦闘のまえにこっちからやろう。
連れてる仲間、HP,SPを表示する。
</p>
</div>
</div>
<div id="outline-container-orgb6f664e" class="outline-3">
<h3 id="orgb6f664e"><a href="#orgb6f664e"><span class="done CLOSE">CLOSE</span> Todo</a></h3>
<div class="outline-text-3" id="text-orgb6f664e">
</div>
<div id="outline-container-orgedd42a7" class="outline-4">
<h4 id="orgedd42a7"><a href="#orgedd42a7">戦闘後の移動</a></h4>
<div class="outline-text-4" id="text-orgedd42a7">
<p>
AIとは移動が競合するので、移動前のものになっている。
戦闘になった瞬間ゲームオブジェクトを消すので、移動できてもよさそう。あーでもそうすると逃げることができないのか。逃げたときは前の位置に移動したいところ。
勝利: 自分が動こうとしていた場所へ移動する。
逃走: 自分が動く前の場所へ移動する。
</p>
</div>
</div>
<div id="outline-container-orgd6c78bf" class="outline-4">
<h4 id="orgd6c78bf"><a href="#orgd6c78bf">非同期キーボードイベント</a></h4>
<div class="outline-text-4" id="text-orgd6c78bf">
<p>
Gosuのキーボードだけ拝借できるかなと思ったが、Gosuのウィンドウにフォーカスが当たらないと検知できない。そりゃそうか。なのでncurses部分を書き換える必要がある。
</p>

<p>
現状ncurseの問題点。
</p>
<ul class="org-ul">
<li>アニメーションが一切できない。</li>
<li>フォントが変えられない。</li>
<li>描画単位が1マス。</li>
</ul>

<p>
CLIでも表現力が上がる。
</p>

<p>
テスト関係を変えないといけなそう。CIでgosu実行するとどうなるんだろう。
単体テストはOKそうだが、結合はどうなるんだろう。ゲームループ内で操作できるのか。
魅力的だが、別にあとでもよさそう。
</p>
</div>
</div>
<div id="outline-container-org9017bb1" class="outline-4">
<h4 id="org9017bb1"><a href="#org9017bb1">地図ファイルから敵やアイテム生成する</a></h4>
<div class="outline-text-4" id="text-org9017bb1">
<p>
ランダムに加えて固定でも配置できるようにする。
地図と思ったが、移動パターンとか指定したいので結局テキストでやらないといけないか。
</p>
</div>
</div>
<div id="outline-container-orgfd72647" class="outline-4">
<h4 id="orgfd72647"><a href="#orgfd72647">mapとcameraを分離</a></h4>
<div class="outline-text-4" id="text-orgfd72647">
<p>
すべてのベースはmapの配列。
</p>
<ul class="org-ul">
<li>character,itemを埋め込む。</li>
<li>cameraのメソッドで配列を切り取って、描画している。</li>
<li>毎ターンリセット</li>
</ul>
<p>
よくないのは、すべてmapの配列操作で密結合していることだ。
</p>

<p>
書き換えるので、キャラがいると地形データが取れなくなる。別レイヤで処理したい。
banbandonではどうしてるのだろう。カメラとマップは分離しているように見える。
</p>

<p>
bbdではマップ上に描画しているのに対して、diggerでは画面のピクセルを指定して描画しないといけない違い。
</p>

<p>
結局地形判定はflyweightのworld配列でやってるので、関係なくなった。描画だけに使われる文字列配列。
</p>
</div>
</div>
<div id="outline-container-org1a91d7e" class="outline-4">
<h4 id="org1a91d7e"><a href="#org1a91d7e">戦闘モード追加する</a></h4>
<div class="outline-text-4" id="text-org1a91d7e">
<p>
とりあえずstate切り替えだけ追加した。
戦闘のためにはいくつかのクラス、パラメータを用意してやる必要がある。
</p>

<ul class="org-ul">
<li>party</li>
<li>member</li>
<li>enemy</li>
</ul>

<blockquote>
<p>
<a href="http://www.lancarse.co.jp/blog/?p=194">http://www.lancarse.co.jp/blog/?p=194</a>
</p>
</blockquote>
<p>
actorからパラメータをコピーして、1ターン分の結果を先に計算。
して、演出用メッセージを生成する。
コードの見通しがよくなる。
</p>
</div>
</div>
<div id="outline-container-org11f2333" class="outline-4">
<h4 id="org11f2333"><a href="#org11f2333">singletonを減らす</a></h4>
<div class="outline-text-4" id="text-org11f2333">
<p>
inventoryとかは似たような状況で、singletonになっている。
乱立するのが嫌なので1つのsingletonに、inventoryとかpartyとかを含むようにしたいな。
メッセージなどもそっちに保持させる。characterごとでなく。
</p>
</div>
</div>
<div id="outline-container-org4ddab8c" class="outline-4">
<h4 id="org4ddab8c"><a href="#org4ddab8c">永続値をどこで持つか</a></h4>
<div class="outline-text-4" id="text-org4ddab8c">
<p>
ステートを切り替えても持ってないといけないものがある。
仲間のHPとか装備とか。そういうのをどこで保持すればいいんだろう。
</p>

<p>
とりあえずsignletonにしておけば良いかな。
</p>
</div>
</div>
<div id="outline-container-org7c5d54c" class="outline-4">
<h4 id="org7c5d54c"><a href="#org7c5d54c">戦闘の方はmemberにする</a></h4>
<div class="outline-text-4" id="text-org7c5d54c">
<p>
エンカウント型にすると、map上のシンボルが複数のキャラクターを持つことがありうる。
現状のCharacterと合わなくなるような気がする。
map上とbattle上のcharacterは別物だ。
</p>

<p>
=&gt;マップの方はpartyにする。
戦闘の方をcharacterに。
あまり直感的ではないな。
</p>

<p>
戦闘の方はmemberにするとか。属してるニュアンスは出る。
</p>

<p>
いろいろ違うので敵と仲間は別にしよう。かなり共通しているところもあるので組み合わせながら。
</p>
</div>
</div>
<div id="outline-container-orgc45b099" class="outline-4">
<h4 id="orgc45b099"><a href="#orgc45b099">スキルはmemberで共通</a></h4>
<div class="outline-text-4" id="text-orgc45b099">
<p>
敵もスキルを持ってる。
</p>
</div>
</div>
<div id="outline-container-orgba79bc8" class="outline-4">
<h4 id="orgba79bc8"><a href="#orgba79bc8">コマンドパターンについて考える</a></h4>
<div class="outline-text-4" id="text-orgba79bc8">
<p>
今の状況は、キーボードイべントとメソッドが直に結びついてる。
</p>
</div>
</div>
<div id="outline-container-orgdac8305" class="outline-4">
<h4 id="orgdac8305"><a href="#orgdac8305">達成バッジ</a></h4>
<div class="outline-text-4" id="text-orgdac8305">
<p>
オブザーバパターン。
統計情報…移動した回数、経過ターン、倒した敵の数。
動機づけになる。
</p>
</div>
</div>
<div id="outline-container-orge7b2c47" class="outline-4">
<h4 id="orge7b2c47"><a href="#orge7b2c47">不可視にする</a></h4>
<div class="outline-text-4" id="text-orge7b2c47">
<p>
視界が難しそう。AIにできるならプレイヤーにも追加すると面白そう。cataclysmみたいに、壁の向こう側は不可視にする。
</p>

<p>
気づくまでは、固定の動きをする。T字で左折する法則。
</p>
</div>
</div>
</div>
<div id="outline-container-orgf5a0b36" class="outline-3">
<h3 id="orgf5a0b36"><a href="#orgf5a0b36"><span class="done CLOSE">CLOSE</span> Todo(リファクタ)</a></h3>
<div class="outline-text-3" id="text-orgf5a0b36">
</div>
<div id="outline-container-org503bac5" class="outline-4">
<h4 id="org503bac5"><a href="#org503bac5">カーソル系画面表示をリファクタリングする</a></h4>
<div class="outline-text-4" id="text-org503bac5">
<p>
カーソル、タブがだるい。
何かユーティリティを作ってもいい。
</p>
</div>
</div>
<div id="outline-container-orgd543e91" class="outline-4">
<h4 id="orgd543e91"><a href="#orgd543e91">Inventoryシングルトンをやめる</a></h4>
<div class="outline-text-4" id="text-orgd543e91">
<p>
inventoryをシングルトンにするのはやめよう。テストがだるい。
とはいえ、stateを限定しないデータなので、それなりの理由はある。
</p>
</div>
</div>
<div id="outline-container-orgf4de829" class="outline-4">
<h4 id="orgf4de829"><a href="#orgf4de829">メッセージシステム</a></h4>
<div class="outline-text-4" id="text-orgf4de829">
<p>
statsが持ってるのはおかしい気がする。
プレイヤーだけが知っていればいいことなので。
いちいちcharacterから辿るのはメンドイし、直感的でない。
</p>
</div>
</div>
</div>
<div id="outline-container-orgd6cb00c" class="outline-3">
<h3 id="orgd6cb00c"><a href="#orgd6cb00c"><span class="done CLOSE">CLOSE</span> 設計</a></h3>
<div class="outline-text-3" id="text-orgd6cb00c">
</div>
<div id="outline-container-org66745b7" class="outline-4">
<h4 id="org66745b7"><a href="#org66745b7">戦闘モード</a></h4>
<div class="outline-text-4" id="text-org66745b7">
<pre class="example">

  oo`'._..---.___..-   oo`'._..---.___..-
 (_,-.        ,..'`  (_,-.        ,..'`
      `'.    ;            `'.    ;
         : :`                : :`
        _;_;                _;_;
ティラノ              ティラノ

ティラノ&gt; 体当たりした
白瀬&gt; 10のダメージを受けた
椿&gt; 対物ライフル → ティラノに30のダメージ
石原&gt; 木刀 → ティラノに5のダメージ

--------------------------------
→戦う　　|白瀬 HP: 55/20 SP: 40/30 **--- ****-
 逃げる　|椿　 HP: 90/84 SP: 50/20 ****- ***--
 アイテム|石原 HP: 80/80 SP: 50/24 ***** **---
 　　　　|
</pre>
</div>
</div>
<div id="outline-container-org0764c77" class="outline-4">
<h4 id="org0764c77"><a href="#org0764c77">拠点メニューモード</a></h4>
<div class="outline-text-4" id="text-org0764c77">
<p>
拠点。
</p>
<pre class="example">
→休憩
 合成
 アイテム
 仲間
 装備
 セーブ
 ロード
</pre>

<p>
フィールドではメニューにはアクセスしない。
ステータスやアイテムへのショートカットキーを用意する。
</p>
</div>
</div>
<div id="outline-container-orgf4e5dfd" class="outline-4">
<h4 id="orgf4e5dfd"><a href="#orgf4e5dfd">フィールドモード</a></h4>
<div class="outline-text-4" id="text-orgf4e5dfd">
<ul class="org-ul">
<li>ターンベース</li>
<li>イベントオブジェクトに接触して、別モードに遷移する</li>
</ul>

<p>
ステータス、アイテム、装備へのショートカットキーを用意する。
</p>
</div>
</div>
</div>
<div id="outline-container-orgc53c91d" class="outline-3">
<h3 id="orgc53c91d"><a href="#orgc53c91d"><span class="done DONE">DONE</span> 戦闘モード追加</a></h3>
<div class="outline-text-3" id="text-orgc53c91d">
<p>
接触したときにフラグを立てて、stateに入る。
wants_to_{}系か。
直にstateを変更するというより、フラグを使ってstateを間接的に移動する。
wants_to_meleeの個別要素にアクセスできない。
</p>

<p>
wants_to_attackを入れておいて、systemを一度回せばいいかな。
一度実行するたびにメッセージを表示して、enterの入力待ちにする。
</p>
</div>
</div>
<div id="outline-container-org0cf99b7" class="outline-3">
<h3 id="org0cf99b7"><a href="#org0cf99b7"><span class="done DONE">DONE</span> GitHub Pagesにデプロイ</a></h3>
<div class="outline-text-3" id="text-org0cf99b7">
</div>
</div>
<div id="outline-container-orgbff7d99" class="outline-3">
<h3 id="orgbff7d99"><a href="#orgbff7d99"><span class="done DONE">DONE</span> 遭遇中の敵の情報を出す</a></h3>
<div class="outline-text-3" id="text-orgbff7d99">
</div>
</div>
<div id="outline-container-orge0fed08" class="outline-3">
<h3 id="orge0fed08"><a href="#orge0fed08"><span class="done DONE">DONE</span> 1エンカウント対複数の敵に対応する</a></h3>
<div class="outline-text-3" id="text-orge0fed08">
<p>
今はエンカウントシンボルと敵が1対1なので、自由度が低い。
battle_entityを作って戦闘は完全にそっちに移す。
</p>
</div>
</div>
<div id="outline-container-orgbb75dc0" class="outline-3">
<h3 id="orgbb75dc0"><a href="#orgbb75dc0"><span class="done DONE">DONE</span> 戦闘終了後にマップentityを削除する</a></h3>
<div class="outline-text-3" id="text-orgbb75dc0">
<p>
wants_to_encounterで元entityを保持してるので、そこから削除できないか。
</p>
</div>
</div>
<div id="outline-container-org3be1cee" class="outline-3">
<h3 id="org3be1cee"><a href="#org3be1cee"><span class="done DONE">DONE</span> 使わない部分を消す</a></h3>
<div class="outline-text-3" id="text-org3be1cee">
<ul class="org-ul">
<li>既存の戦闘部分は使わないので消す</li>
<li>遠距離アイテムは消す</li>
</ul>
</div>
</div>
<div id="outline-container-org4852208" class="outline-3">
<h3 id="org4852208"><a href="#org4852208"><span class="done DONE">DONE</span> 勝利したときに戦闘結果を表示する</a></h3>
<div class="outline-text-3" id="text-org4852208">
</div>
</div>
<div id="outline-container-orgb5287ef" class="outline-3">
<h3 id="orgb5287ef"><a href="#orgb5287ef"><span class="done DONE">DONE</span> 逃げるときの確率分岐</a></h3>
<div class="outline-text-3" id="text-orgb5287ef">
<p>
今は100％なので、確率で失敗してターンを進行させる。
</p>
</div>
</div>
<div id="outline-container-orgcb12f89" class="outline-3">
<h3 id="orgcb12f89"><a href="#orgcb12f89"><span class="done DONE">DONE</span> 敵一覧を真ん中寄せにする</a></h3>
<div class="outline-text-3" id="text-orgcb12f89">
<p>
2体いるときは2体で真ん中に、倒して1体になったら1体で真ん中寄せにする。
</p>
</div>
</div>
<div id="outline-container-org543064e" class="outline-3">
<h3 id="org543064e"><a href="#org543064e"><span class="done DONE">DONE</span> 1体倒してから逃げるとエラー</a></h3>
<div class="outline-text-3" id="text-org543064e">
<p>
wants_to_meleeが残っていて、おかしくなっていたよう。
ターン毎に、リセットするようにした。
確実に前の状態を残さないようにするとバグになりにくそう。
</p>
</div>
</div>
<div id="outline-container-org39a6872" class="outline-3">
<h3 id="org39a6872"><a href="#org39a6872"><span class="done DONE">DONE</span> 戦闘用エンティティであることを明示する</a></h3>
<div class="outline-text-3" id="text-org39a6872">
<p>
現在は、combat_stats, monsterコンポーネントを持つものを敵の戦闘エンティティとしている…みたいな感じ。
わかりにくいので直したい。
</p>

<p>
combat_stats を持つ=戦闘エンティティで問題ない。monster, playerがあるのは区別が必要なので仕方ない。
なのでOK。
</p>
</div>
</div>
<div id="outline-container-org0400d7a" class="outline-3">
<h3 id="org0400d7a"><a href="#org0400d7a"><span class="done DONE">DONE</span> パーティクル追加</a></h3>
<div class="outline-text-3" id="text-org0400d7a">
<p>
チュートリアルのパーティクルはマップ用。
positionにライフタイムのあるentityを配置して、擬似的にアニメーションにしている。
entityにすることで、map描画システムを使い、map上を上書きする形で表示できる。
戦闘ではprintしてるので、そのまま使うことはできない。printごとに座標計算して指定してるので、重ねるためにはロジックをコピペしないといけない。
</p>

<p>
builderの実装方法は参考になりそうなので、とりあえずコピペ追加。
</p>
</div>
</div>
<div id="outline-container-orgd8908db" class="outline-3">
<h3 id="orgd8908db"><a href="#orgd8908db"><span class="done DONE">DONE</span> フィールドでHPがリアルタイムに反映されてない</a></h3>
<div class="outline-text-3" id="text-orgd8908db">
<p>
戦闘に入るとダメージが反映される。
field_stateでdamage_systemが動いてないためだった。
</p>
</div>
</div>
<div id="outline-container-org235598d" class="outline-3">
<h3 id="org235598d"><a href="#org235598d"><span class="done DONE">DONE</span> 食料追加</a></h3>
<div class="outline-text-3" id="text-org235598d">
</div>
</div>
<div id="outline-container-orgaa567d3" class="outline-3">
<h3 id="orgaa567d3"><a href="#orgaa567d3"><span class="done CLOSE">CLOSE</span> 画像背景</a></h3>
<div class="outline-text-3" id="text-orgaa567d3">
<p>
チュートリアルの内容。
LEX paintがWINEでうまく実行できない。
変換ツールもうまく機能してないので、一旦チュートリアルのを流用して後回しか。システムだけ入れてコメントアウト。
</p>
</div>
</div>
<div id="outline-container-orgc97cda9" class="outline-3">
<h3 id="orgc97cda9"><a href="#orgc97cda9"><span class="done DONE">DONE</span> プレイヤーと戦闘エンティティを分離する</a></h3>
<div class="outline-text-3" id="text-orgc97cda9">
<p>
分離した。影響範囲が広い。
</p>
</div>
</div>
<div id="outline-container-org9089d41" class="outline-3">
<h3 id="org9089d41"><a href="#org9089d41"><span class="done DONE">DONE</span> 再装備するとアイテムが消える</a></h3>
<div class="outline-text-3" id="text-org9089d41">
<p>
装備品のownerがキャラになっていたため、インベントリに表示されてないというものだった。
装備中のものはownerが各戦闘用entityになり、装備してないとownerはplayer_entityになる。
party_entityとかにしたほうがいいかもな。
ややこしい。
</p>
</div>
</div>
<div id="outline-container-org50bfec1" class="outline-3">
<h3 id="org50bfec1"><a href="#org50bfec1"><span class="done DONE">DONE</span> Design Doc</a></h3>
<div class="outline-text-3" id="text-org50bfec1">
</div>
</div>
<div id="outline-container-org46e6a4e" class="outline-3">
<h3 id="org46e6a4e"><a href="#org46e6a4e"><span class="done DONE">DONE</span> mapをリファクタ(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org46e6a4e">
</div>
</div>
<div id="outline-container-orge1e57db" class="outline-3">
<h3 id="orge1e57db"><a href="#orge1e57db"><span class="done DONE">DONE</span> mapフィルタ</a></h3>
<div class="outline-text-3" id="text-orge1e57db">
</div>
</div>
<div id="outline-container-org2bb3f1b" class="outline-3">
<h3 id="org2bb3f1b"><a href="#org2bb3f1b"><span class="done DONE">DONE</span> ドア追加(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-org2bb3f1b">
</div>
</div>
<div id="outline-container-org82c83c1" class="outline-3">
<h3 id="org82c83c1"><a href="#org82c83c1"><span class="done DONE">DONE</span> Warningつぶし</a></h3>
<div class="outline-text-3" id="text-org82c83c1">
</div>
</div>
<div id="outline-container-orga96de5e" class="outline-3">
<h3 id="orga96de5e"><a href="#orga96de5e"><span class="done DONE">DONE</span> builder理解</a></h3>
<div class="outline-text-3" id="text-orga96de5e">
</div>
</div>
<div id="outline-container-orgeb566c9" class="outline-3">
<h3 id="orgeb566c9"><a href="#orgeb566c9"><span class="done DONE">DONE</span> カメラ導入(チュートリアル)</a></h3>
<div class="outline-text-3" id="text-orgeb566c9">
</div>
</div>
<div id="outline-container-org683fd6e" class="outline-3">
<h3 id="org683fd6e"><a href="#org683fd6e"><span class="done DONE">DONE</span> getで取れるところのリファクタ</a></h3>
<div class="outline-text-3" id="text-org683fd6e">
<div class="org-src-container">
<pre class="src src-rust">hc = hunger_clock.get(entity);
</pre>
</div>
<p>
のように、entityさえわかっていればgetで属性をコンポーネントを取得できる。いちいちforに長く書く必要がない。
</p>
</div>
</div>
<div id="outline-container-org2544370" class="outline-3">
<h3 id="org2544370"><a href="#org2544370"><span class="done DONE">DONE</span> データのjsonファイル化(チュートリアル)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="8">8</span></span></a></h3>
<div class="outline-text-3" id="text-org2544370">
</div>
</div>
<div id="outline-container-orga17ab61" class="outline-3">
<h3 id="orga17ab61"><a href="#orga17ab61"><span class="done DONE">DONE</span> 街追加(チュートリアル)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="13">13</span></span></a></h3>
<div class="outline-text-3" id="text-orga17ab61">
</div>
</div>
<div id="outline-container-org54e683a" class="outline-3">
<h3 id="org54e683a"><a href="#org54e683a"><span class="done DONE">DONE</span> 戦闘が終了しないバグ</a></h3>
<div class="outline-text-3" id="text-org54e683a">
<p>
戦闘関連のリファクタをした。あまりよくないな…。
</p>
</div>
</div>
<div id="outline-container-org25ab709" class="outline-3">
<h3 id="org25ab709"><a href="#org25ab709"><span class="done DONE">DONE</span> 複数の能力(チュートリアル)&#xa0;&#xa0;&#xa0;<span class="tag"><span class="5">5</span></span></a></h3>
<div class="outline-text-3" id="text-org25ab709">
</div>
</div>
<div id="outline-container-orgcb58794" class="outline-3">
<h3 id="orgcb58794"><a href="#orgcb58794"><span class="done DONE">DONE</span> 画面サイズを大きくする</a></h3>
<div class="outline-text-3" id="text-orgcb58794">
<p>
コンパイル後のブラウザ表示。何回か試したが、うまくいってない。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
