<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-03-31 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ruby</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">Ruby</h1>
<div id="outline-container-orgbf0dfd9" class="outline-2">
<h2 id="orgbf0dfd9"><a href="#orgbf0dfd9">概要</a></h2>
<div class="outline-text-2" id="text-orgbf0dfd9">
<p>
Rubyはオブジェクト指向の<a href="20210509101246-programming_language.html#ID-868ac56a-2d42-48d7-ab7f-7047c85a8f39">Programming Language</a>である。
Webフレームワークの<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>が有名で、採用されるケースはRailsを使うためが多い。
</p>

<p>
コンパイル不要なスクリプト言語、動的型付け、WEBに使用される、といった点で<a href="20210725134208-python.html#ID-a6c9c9ad-d9b1-4e13-8992-75d8590e464c">Python</a>と競合している。
</p>
</div>
</div>
<div id="outline-container-org3d2b774" class="outline-2">
<h2 id="org3d2b774"><a href="#org3d2b774">Memo</a></h2>
<div class="outline-text-2" id="text-org3d2b774">
</div>
<div id="outline-container-org028be83" class="outline-3">
<h3 id="org028be83"><a href="#org028be83">countにブロックを渡す</a></h3>
<div class="outline-text-3" id="text-org028be83">
<p>
countにブロックを渡して配列の数を調べられる。
↓二行は同じ意味。
</p>
<div class="org-src-container">
<pre class="src src-ruby">expect(item_type_pool.types.select { |t| t.category == <span class="org-constant">:canon</span> }.length).to be &gt; 10
expect(item_type_pool.types.count { |t| t.category == <span class="org-constant">:canon</span> }).to be &gt; 10
</pre>
</div>
</div>
</div>
<div id="outline-container-org4d57980" class="outline-3">
<h3 id="org4d57980"><a href="#org4d57980">継承関係を辿る</a></h3>
<div class="outline-text-3" id="text-org4d57980">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-constant">true</span>.class.ancestors
</pre>
</div>
</div>
</div>
<div id="outline-container-org52db365" class="outline-3">
<h3 id="org52db365"><a href="#org52db365">オブジェクトのメソッド一覧を見る</a></h3>
<div class="outline-text-3" id="text-org52db365">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-constant">true</span>.public_methods
</pre>
</div>

<p>
falseを渡すと祖先のメソッドを表示しない。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-constant">true</span>.public_methods(<span class="org-constant">false</span>)
=<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; [:===, :^, :inspect, :to_s, :&amp;, :|]</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge50bc22" class="outline-3">
<h3 id="orge50bc22"><a href="#orge50bc22">group_by</a></h3>
<div class="outline-text-3" id="text-orge50bc22">
<p>
<code>Enumerable#group_by</code>
ブロックを評価した結果をキー、対応する要素の配列を値とするハッシュを返す。
</p>

<p>
QueryMethodの <code>where</code> で取った値をハッシュにして、後で使いまわせる。N+1問題の回避に使える。QueryMethodぽい名前だが無関係。
</p>
</div>
</div>
<div id="outline-container-org838bb18" class="outline-3">
<h3 id="org838bb18"><a href="#org838bb18">index_by</a></h3>
<div class="outline-text-3" id="text-org838bb18">
<p>
viewで何かモデルに関することをループさせないといけないときに役立つ。モデルを一度にハッシュとして取ることで、パフォーマンスを改善できる。
</p>
</div>
</div>
<div id="outline-container-orgf06a83a" class="outline-3">
<h3 id="orgf06a83a"><a href="#orgf06a83a">インスタンスメソッドを調査する</a></h3>
<div class="outline-text-3" id="text-orgf06a83a">
<p>
<code>String.instance_methods(false).sort</code>
<code>false</code> によってクラスの継承メソッドを表示しないため、クラス単体を調べるのに役立つ。
</p>
</div>
</div>
<div id="outline-container-orgf569b23" class="outline-3">
<h3 id="orgf569b23"><a href="#orgf569b23">トップレベルで実行できる理由</a></h3>
<div class="outline-text-3" id="text-orgf569b23">
<p>
クラスがなくトップレベルで定義されたメソッドのレシーバーは <code>Object</code> クラス。クラスの中にないトップレベルメソッドでさまざまなことが行えるのは、 <code>Object</code> のおかげ。 <code>ruby -e 'p Kernel.private_instance_methods.sort'</code> でチェックできる。
</p>
<ul class="org-ul">
<li><code>puts</code> がレシーバーなしで呼び出せるのは、 <code>Object</code> クラスが <code>puts</code> のある <code>Kernel</code> クラスをincludeしているから。</li>
<li><code>.to_d</code> - BigDecimalに変換する。</li>
<li><code>index</code> - 配列を検索して添字を返す。</li>
</ul>
</div>
</div>
<div id="outline-container-org5e983b7" class="outline-3">
<h3 id="org5e983b7"><a href="#org5e983b7">何のメソッドがわからないとき</a></h3>
<div class="outline-text-3" id="text-org5e983b7">
<ul class="org-ul">
<li><a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs</a>だと <code>robe-doc</code> がとても便利。すでにあるローカルにあるドキュメントを活用するべき。</li>
</ul>
</div>
</div>
<div id="outline-container-org0881967" class="outline-3">
<h3 id="org0881967"><a href="#org0881967">when句</a></h3>
<div class="outline-text-3" id="text-org0881967">
<p>
<a href="https://stackoverflow.com/questions/3908380/ruby-class-types-and-case-statements/3908411">https://stackoverflow.com/questions/3908380/ruby-class-types-and-case-statements/3908411</a>
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">case</span> item
<span class="org-keyword">when</span> <span class="org-type">MyClass</span>
...
<span class="org-keyword">when</span> <span class="org-type">Array</span>
...
<span class="org-keyword">when</span> <span class="org-type">String</span>
...
</pre>
</div>
<p>
is really
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">if</span> <span class="org-type">MyClass</span> === item
...
<span class="org-keyword">elsif</span> <span class="org-type">Array</span> === item
...
<span class="org-keyword">elsif</span> <span class="org-type">String</span> === item
...
</pre>
</div>

<p>
<code>===</code> は内部的に <code>is_a?</code> を使っている。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">if</span> item.is_a?(<span class="org-type">MyClass</span>)
...
<span class="org-keyword">elsif</span> item.is_a?(<span class="org-type">Array</span>)
...
<span class="org-keyword">elsif</span> item.is_a?(<span class="org-type">String</span>)
...
</pre>
</div>
<p>
をcaseに書き換えるには一番上の書き方でよい。たぶん。
</p>
</div>
</div>
<div id="outline-container-orgd2c8a4a" class="outline-3">
<h3 id="orgd2c8a4a"><a href="#orgd2c8a4a">singletonをクリーンにテストする</a></h3>
<div class="outline-text-3" id="text-orgd2c8a4a">
<p>
singletonをそのまま使うと状況依存のテストになるため、毎回newする必要がある。
</p>

<p>
<a href="https://stackoverflow.com/questions/1909181/how-to-test-a-singleton-class">https://stackoverflow.com/questions/1909181/how-to-test-a-singleton-class</a>
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-keyword">self</span>.<span class="org-function-name">instance</span>
  <span class="org-variable-name">@instance</span> ||= new
<span class="org-keyword">end</span>

<span class="org-builtin">private_class_method</span> <span class="org-constant">:new</span>
</pre>
</div>

<p>
So you can bypass the memoization altogether by calling the private method new using send
</p>

<div class="org-src-container">
<pre class="src src-ruby">let(<span class="org-constant">:instance</span>) { <span class="org-type">GlobalClass</span>.send(<span class="org-constant">:new</span>) }
</pre>
</div>
<p>
A nice benefit of this way is that no global state is modified as a result of your tests running.
</p>

<p>
Probably a better way, from this answer:
</p>

<div class="org-src-container">
<pre class="src src-ruby">let(<span class="org-constant">:instance</span>) { <span class="org-type">Class</span>.new(<span class="org-type">GlobalClass</span>).instance }
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd0004b2" class="outline-3">
<h3 id="orgd0004b2"><a href="#orgd0004b2">評価結果アノテーションを付与するxmpfilter</a></h3>
<div class="outline-text-3" id="text-orgd0004b2">
<p>
便利ツールを集めた <a href="https://github.com/rcodetools/rcodetools">https://github.com/rcodetools/rcodetools</a> というgemがある。
そのなかにインラインで実行した結果を表示するスクリプトがある。
<a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs</a>用のコードもある。<a href="https://github.com/rcodetools/rcodetools/blob/master/misc/rcodetools.el">https://github.com/rcodetools/rcodetools/blob/master/misc/rcodetools.el</a> rubykitch氏作成。
</p>
<div class="org-src-container">
<pre class="src src-ruby">1.to_s <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; "1"</span>
</pre>
</div>
<p>
というように、irbのように挿入してくれる。とても便利。
</p>
</div>
</div>
<div id="outline-container-org0308040" class="outline-3">
<h3 id="org0308040"><a href="#org0308040">bundle installの並列数</a></h3>
<div class="outline-text-3" id="text-org0308040">
<p>
<code>bundle install --jobs 4</code> などとして並列処理数を指定できる。
このマックスの数の調べ方。
</p>

<p>
<code>getconf _NPROCESSORS_ONLN</code>
</p>

<p>
なので、マシンごとで最速の設定で実行するためには。
</p>

<p>
<code>bundle install --jobs `getconf _NPROCESSORS_ONLN`</code> とする。
<a href="https://stackoverflow.com/questions/39163758/bundle-how-many-parallel-jobs">https://stackoverflow.com/questions/39163758/bundle-how-many-parallel-jobs</a>
</p>
</div>
</div>
<div id="outline-container-orge41c764" class="outline-3">
<h3 id="orge41c764"><a href="#orge41c764">transform_values</a></h3>
<div class="outline-text-3" id="text-orge41c764">
<p>
<code>map { } .to_h</code> はtransform_valuesで書き直せる。
</p>

<div class="org-src-container">
<pre class="src src-ruby">h = { <span class="org-constant">a:</span> 1, <span class="org-constant">b:</span> 2 }
h.map { |k, v| [k, v.to_s] }.to_h
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby">h = { <span class="org-constant">a:</span> 1, <span class="org-constant">b:</span> 2 }
h.transform_values(&amp;<span class="org-constant">:to_s</span>)
</pre>
</div>

<p>
<a href="https://github.com/rubocop/rubocop-jp/issues/33">https://github.com/rubocop/rubocop-jp/issues/33</a>
</p>
</div>
</div>
<div id="outline-container-org579a602" class="outline-3">
<h3 id="org579a602"><a href="#org579a602">日付計算でのRational</a></h3>
<div class="outline-text-3" id="text-org579a602">
<p>
日付計算でDate同士を計算するときがある。
そのとき返ってくる値を表示すると-1/1みたいに表示される。
これはRational(有理数)オブジェクトである。
.to_iで整数に変換できる。
</p>

<p>
<a href="https://docs.ruby-lang.org/ja/2.4.0/method/Date/i/=2d.html">Date#- (Ruby 2.4.0 リファレンスマニュアル)</a>
</p>
</div>
</div>
<div id="outline-container-org4a8ae73" class="outline-3">
<h3 id="org4a8ae73"><a href="#org4a8ae73">マッチした部分文字列の配列を返すscan</a></h3>
<div class="outline-text-3" id="text-org4a8ae73">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>2文字づつ分割</label><pre class="src src-ruby"><span class="org-string">"foobar"</span>.scan(<span class="org-string">/../</span>)
</pre>
</div>

<div class="results" id="org85a36a0">
<p>
[&ldquo;fo&rdquo;, &ldquo;ob&rdquo;, &ldquo;ar&rdquo;]
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>数字クラスごとで分割</label><pre class="src src-ruby"><span class="org-string">"1 2 3"</span>.scan(<span class="org-string">/\d+/</span>)
</pre>
</div>

<div class="results" id="org0151c47">
<p>
[&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;3&rdquo;]
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>セパレータが違っても↑と同じ結果を返す</label><pre class="src src-ruby"><span class="org-string">"1, 2, 3"</span>.scan(<span class="org-string">/\d+/</span>)
</pre>
</div>

<div class="results" id="org9b3b8a7">
<p>
[&ldquo;1&rdquo;, &ldquo;2&rdquo;, &ldquo;3&rdquo;]
</p>

</div>
</div>
</div>

<div id="outline-container-org1ae40c7" class="outline-3">
<h3 id="org1ae40c7"><a href="#org1ae40c7">メモリ使用量を調べる</a></h3>
<div class="outline-text-3" id="text-org1ae40c7">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>すべてのメモリ使用量を調べる</label><pre class="src src-ruby"><span class="org-builtin">require</span> <span class="org-string">'objspace'</span>
<span class="org-builtin">puts</span> <span class="org-string">"</span><span class="org-variable-name">#{ObjectSpace.memsize_of_all / (1000.0 * 1000.0)}</span><span class="org-string"> MB"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9555549" class="outline-3">
<h3 id="org9555549"><a href="#org9555549">irbでgemを読み込む</a></h3>
<div class="outline-text-3" id="text-org9555549">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">require</span> <span class="org-string">'rspec'</span>
<span class="org-builtin">include</span> <span class="org-type">RSpec</span>::<span class="org-type">Matchers</span>

<span class="org-builtin">include</span> <span class="org-type">ActionView</span>::<span class="org-type">Helpers</span>::<span class="org-type">OutputSafetyHelper</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org675aa97" class="outline-3">
<h3 id="org675aa97"><a href="#org675aa97">クラスの読み込み順</a></h3>
<div class="outline-text-3" id="text-org675aa97">
<p>
親(抽象)クラスは、子(具体)クラスよりも先に読み込む必要がある。
普通に開発していると1つのファイルに入れることはないので気づきにくい、はまりやすい。
</p>

<p>
↓はエラーになる。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Bが名前解決できずエラー</label><pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">A</span> &lt; <span class="org-type">B</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">B</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orged5f6d1" class="outline-3">
<h3 id="orged5f6d1"><a href="#orged5f6d1">親クラスから子クラスの定数にアクセス</a></h3>
<div class="outline-text-3" id="text-orged5f6d1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>具体クラスの定数が入る。子クラスに移譲できる</label><pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Abstruct</span>
  <span class="org-keyword">def</span> <span class="org-function-name">print_child_constant</span>
    <span class="org-keyword">self</span>.class::<span class="org-type">NAME</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">A</span> &lt; <span class="org-type">Abstruct</span>
  <span class="org-type">NAME</span> = <span class="org-string">'AA'</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">B</span> &lt; <span class="org-type">Abstruct</span>
  <span class="org-type">NAME</span> = <span class="org-string">'BB'</span>
<span class="org-keyword">end</span>

<span class="org-builtin">p</span> <span class="org-type">A</span>.new.print_child_constant <span class="org-comment-delimiter"># </span><span class="org-comment">AA</span>
</pre>
</div>

<p>
<a href="https://easyramble.com/access-subclass-constant-from-superclass.html">Rubyで親クラスから子クラスの定数を参照 | EasyRamble</a>
</p>
</div>
</div>
<div id="outline-container-org6b92536" class="outline-3">
<h3 id="org6b92536"><a href="#org6b92536">配列をマージ/結合</a></h3>
<div class="outline-text-3" id="text-org6b92536">
<p>
<code>merge</code> メソッドはHashクラスのメソッドであり、配列では使えない。
</p>

<p>
単純な結合。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>結合</label><pre class="src src-ruby">[<span class="org-string">'a'</span>, <span class="org-string">'b'</span>] + [<span class="org-string">'a'</span>, <span class="org-string">'b'</span>]
</pre>
</div>

<div class="results" id="orgd0e0dee">
<p>
[&ldquo;a&rdquo;, &ldquo;b&rdquo;, &ldquo;a&rdquo;, &ldquo;b&rdquo;]
</p>

</div>

<p>
マージ(=かぶってたら削除)。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>マージ</label><pre class="src src-ruby">[<span class="org-string">'a'</span>, <span class="org-string">'b'</span>] | [<span class="org-string">'a'</span>, <span class="org-string">'b'</span>]
</pre>
</div>

<div class="results" id="org67181af">
<p>
[&ldquo;a&rdquo;, &ldquo;b&rdquo;]
</p>

</div>

<p>
uniqでも同じ。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>uniq</label><pre class="src src-ruby">([<span class="org-string">'a'</span>, <span class="org-string">'b'</span>] + [<span class="org-string">'a'</span>, <span class="org-string">'b'</span>]).uniq
</pre>
</div>

<div class="results" id="org863714a">
<p>
[&ldquo;a&rdquo;, &ldquo;b&rdquo;]
</p>

</div>
</div>
</div>
<div id="outline-container-orgabd2356" class="outline-3">
<h3 id="orgabd2356"><a href="#orgabd2356">Struct(構造体クラス)</a></h3>
<div class="outline-text-3" id="text-orgabd2356">
<p>
structは簡易的なclassのようなもの。
データをまとめるのに使う。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>structで定義する</label><pre class="src src-ruby">user = <span class="org-type">Struct</span>.new(<span class="org-constant">:name</span>, <span class="org-constant">:age</span>)
user.new(<span class="org-string">'taro'</span>, 15)
</pre>
</div>

<div class="results" id="org7f7ad3e">
<p>
#&lt;struct name=&ldquo;taro&rdquo;, age=15&gt;
</p>

</div>

<p>
<a href="https://qiita.com/k-penguin-sato/items/54189d5ed4e5f7463266">【Ruby】Struct(構造体クラス)を理解する - Qiita</a>
</p>
</div>
</div>
<div id="outline-container-orgc9d3510" class="outline-3">
<h3 id="orgc9d3510"><a href="#orgc9d3510">thor</a></h3>
<div class="outline-text-3" id="text-orgc9d3510">
<p>
thorはコマンドを作るgem。
同じようなライブラリにrakeがあるが、rakeは引数を渡す方法が特殊なのでthorが好まれる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">Gemat</span>
  <span class="org-keyword">class</span> <span class="org-type">Cli</span> &lt; <span class="org-type">Thor</span>
    class_options <span class="org-constant">input:</span> <span class="org-constant">:string</span>, <span class="org-constant">output:</span> <span class="org-constant">:string</span>, <span class="org-constant">columns:</span> <span class="org-constant">:array</span>, <span class="org-constant">all:</span> <span class="org-constant">:boolean</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">&#12513;&#12477;&#12483;&#12489;&#20849;&#36890;&#12398;&#12458;&#12503;&#12471;&#12519;&#12531;</span>

    desc <span class="org-string">'csv'</span>, <span class="org-string">'csv command description'</span>
    <span class="org-keyword">def</span> <span class="org-function-name">csv</span>
    <span class="org-keyword">end</span>

    desc md, <span class="org-string">'md command description'</span>
    <span class="org-keyword">def</span> <span class="org-function-name">md</span>
    <span class="org-keyword">end</span>

    no_tasks <span class="org-keyword">do</span>
      <span class="org-keyword">def</span> <span class="org-function-name">command</span>(options, method_name)
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">$ gemat csv
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf0e871e" class="outline-3">
<h3 id="orgf0e871e"><a href="#orgf0e871e">pp</a></h3>
<div class="outline-text-3" id="text-orgf0e871e">
<p>
Hashが見づらいときは、 <code>pp</code> を使うと綺麗に表示できる。
<a href="https://docs.ruby-lang.org/ja/latest/library/pp.html">https://docs.ruby-lang.org/ja/latest/library/pp.html</a>
</p>
</div>
</div>
<div id="outline-container-orgb369d95" class="outline-3">
<h3 id="orgb369d95"><a href="#orgb369d95">map</a></h3>
<div class="outline-text-3" id="text-orgb369d95">
<p>
mapの返り値は、ブロックの最後の値である。
だから↓みたく途中でセットしたい、というときは最後配列に入れたいものを置く必要がある。
</p>
<div class="org-src-container">
<pre class="src src-ruby">options[<span class="org-constant">:columns</span>].map <span class="org-keyword">do</span> |column|
  od = <span class="org-type">OutDsl</span>.new(column)
  od.idx = index
  od <span class="org-comment-delimiter"># </span><span class="org-comment">&#12371;&#12371;</span>
<span class="org-keyword">end</span>
</pre>
</div>
<p>
mapは1行で書くこと多いので忘れがち。
</p>
</div>
</div>
<div id="outline-container-orgc007c53" class="outline-3">
<h3 id="orgc007c53"><a href="#orgc007c53">rubygemsのcredential入手</a></h3>
<div class="outline-text-3" id="text-orgc007c53">
<p>
<a href="https://rubygems.org/">https://rubygems.org/</a> であらかじめログインしておく。
</p>
<div class="org-src-container">
<pre class="src src-ruby">curl -u {user&#21517;} https<span class="org-constant">:/</span>/rubygems.org/api/v1/api_key.yaml &gt; ~<span class="org-string">/.gem/</span>credentials; chmod 0600 ~<span class="org-string">/.gem/</span>credentials
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">rake release
</pre>
</div>
</div>
</div>
<div id="outline-container-org1fc4638" class="outline-3">
<h3 id="org1fc4638"><a href="#org1fc4638">presense</a></h3>
<div class="outline-text-3" id="text-org1fc4638">
<p>
<code>present?</code> の結果がtrueのときレシーバ自身を返す。falseのときはnilを返す。
</p>

<div class="org-src-container">
<pre class="src src-ruby">object.present? ? object : <span class="org-constant">nil</span>
object.presense
</pre>
</div>

<p>
これらは等価である。
</p>

<ul class="org-ul">
<li><a href="https://apidock.com/rails/Object/presence">https://apidock.com/rails/Object/presence</a></li>
</ul>
</div>
</div>
<div id="outline-container-org1a3d795" class="outline-3">
<h3 id="org1a3d795"><a href="#org1a3d795">tap</a></h3>
<div class="outline-text-3" id="text-org1a3d795">
<p>
処理に関わらずselfを返す。
メソッドチェーンへのデバッグに便利。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">p</span> ( 1 .. 5 )
.tap{|obj| <span class="org-builtin">puts</span> obj.class}
.to_a.tap{|obj| <span class="org-builtin">puts</span> obj.class}
</pre>
</div>

<div class="results" id="org50f1712">
<p>
Range
Array
[1, 2, 3, 4, 5]
</p>

</div>

<p>
メソッドチェーンの途中で分岐として使えそう。
</p>
</div>
</div>
<div id="outline-container-org7e079af" class="outline-3">
<h3 id="org7e079af"><a href="#org7e079af">min_by</a></h3>
<div class="outline-text-3" id="text-org7e079af">
<p>
配列から最大/最小の値を取りたいというとき、min_byが便利。
</p>
<div class="org-src-container">
<pre class="src src-ruby">[5, -8, 3, 9].min_by{|num| num.abs }
</pre>
</div>

<pre class="example">
3
</pre>


<p>
order → first と冗長に書いてしまいがち。
</p>
</div>
</div>
<div id="outline-container-org9e0c1bb" class="outline-3">
<h3 id="org9e0c1bb"><a href="#org9e0c1bb">&amp;: 記法</a></h3>
<div class="outline-text-3" id="text-org9e0c1bb">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-string">%w{ a b c }</span>.map(&amp;<span class="org-constant">:capitalize</span>)
</pre>
</div>
<ul class="org-ul">
<li>&amp; -&gt; <code>to_proc</code> trigger</li>
<li>: -&gt; symbol</li>
</ul>
</div>
</div>
<div id="outline-container-orgff19092" class="outline-3">
<h3 id="orgff19092"><a href="#orgff19092">ファイルを作らずにファイルオブジェクトを作ってテストする</a></h3>
<div class="outline-text-3" id="text-orgff19092">
<p>
ファイル入力のあるプログラムがあるとする。
テストするとき、普通はファイルを作って読み込むことになる。
しかしいちいちファイルを用意するほどではない、みたいな場合もある。
そのときは <code>StringIO</code> を使うと気軽に試せる。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">require</span> <span class="org-string">'stringio'</span>
string = <span class="org-string">&lt;&lt;EOM</span>
<span class="org-string">  aaa</span>
<span class="org-string">  "aaa"</span>
<span class="org-string">EOM</span>

file1 = <span class="org-type">StringIO</span>.new(string)
file.read <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; aaa\n"aaa"</span>
file2 = <span class="org-type">StringIO</span>.new(<span class="org-string">''</span>)
file.read <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; ""</span>
</pre>
</div>
<p>
としておいて、あとは普通のFIleオブジェクトにするように、 <code>StringIO</code> オブジェクトに対して各種操作ができる。
</p>
</div>
</div>
</div>
<div id="outline-container-org21c6c84" class="outline-2">
<h2 id="org21c6c84"><a href="#org21c6c84">Mastering Ruby Closure</a></h2>
<div class="outline-text-2" id="text-org21c6c84">
<p>
DEADLINE: <span class="timestamp-wrapper"><span class="timestamp">&lt;2021-11-21 日&gt;</span></span>
</p>
<ul class="org-ul">
<li>10, 15, 20, 36, 38, 55, 57, 61, 68</li>
</ul>
</div>

<div id="outline-container-org5350802" class="outline-3">
<h3 id="org5350802"><a href="#org5350802">定義</a></h3>
<div class="outline-text-3" id="text-org5350802">
<ul class="org-ul">
<li>関数を必要とする</li>
<li>親スコープで定義される変数を参照する</li>
</ul>
</div>
</div>
<div id="outline-container-orgf5eae2a" class="outline-3">
<h3 id="orgf5eae2a"><a href="#orgf5eae2a">レキシカルバインディング</a></h3>
<div class="outline-text-3" id="text-orgf5eae2a">
<div class="org-src-container">
<pre class="src src-ruby">msg = <span class="org-string">"aaa"</span>
3.times <span class="org-keyword">do</span>
  prefix = <span class="org-string">"I"</span>
  <span class="org-builtin">puts</span> <span class="org-string">"</span><span class="org-variable-name">#{prefix}</span><span class="org-string"> </span><span class="org-variable-name">#{msg}</span><span class="org-string">"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="results" id="orgfaf1cb1">
<p>
I aaa
I aaa
I aaa
</p>

</div>

<p>
ブロックの内側から外側にはアクセスできる。
</p>

<div class="org-src-container">
<pre class="src src-ruby">msg = <span class="org-string">"aaa"</span>
3.times <span class="org-keyword">do</span>
  prefix = <span class="org-string">"I"</span>
  <span class="org-builtin">puts</span> <span class="org-string">"</span><span class="org-variable-name">#{prefix}</span><span class="org-string"> </span><span class="org-variable-name">#{msg}</span><span class="org-string">"</span>
<span class="org-keyword">end</span>
prefix
</pre>
</div>

<p>
ブロックの外側から内側にアクセスできない。
</p>
</div>
</div>
<div id="outline-container-orgf39882d" class="outline-3">
<h3 id="orgf39882d"><a href="#orgf39882d">自由変数</a></h3>
<div class="outline-text-3" id="text-orgf39882d">
<div class="org-src-container">
<pre class="src src-ruby">chalkboard_gag = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |msg|
  <span class="org-builtin">lambda</span> <span class="org-keyword">do</span>
    prefix = <span class="org-string">"I will not"</span>
    <span class="org-string">"</span><span class="org-variable-name">#{prefix}</span><span class="org-string"> </span><span class="org-variable-name">#{msg}</span><span class="org-string">"</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
chalkboard_gag
inner_lambda = chalkboard_gag.call(<span class="org-string">"drive the car"</span>)
inner_lambda.call
</pre>
</div>

<div class="results" id="org86e09f5">
<p>
I will not drive the car
</p>

</div>
</div>
</div>
<div id="outline-container-org2721195" class="outline-3">
<h3 id="org2721195"><a href="#org2721195">例) カウンター</a></h3>
<div class="outline-text-3" id="text-org2721195">
<p>
2つ目のlambdaから見ると、 <code>x</code> は注入されてるので自由変数。
</p>
<div class="org-src-container">
<pre class="src src-ruby">counter = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span>
  x = 0
  get_x = <span class="org-builtin">lambda</span> { <span class="org-builtin">p</span> x } <span class="org-comment-delimiter"># </span><span class="org-comment">x is free variable</span>
  incr = <span class="org-builtin">lambda</span> { <span class="org-builtin">p</span> x += 1 }
  decr = <span class="org-builtin">lambda</span> { <span class="org-builtin">p</span> x -= 1 }

  {<span class="org-constant">get_x:</span> get_x, <span class="org-constant">incr:</span> incr, <span class="org-constant">decr:</span> decr}
<span class="org-keyword">end</span>
c1 = counter.call
c1[<span class="org-constant">:incr</span>].call
c1[<span class="org-constant">:incr</span>].call
c1[<span class="org-constant">:incr</span>].call
c1[<span class="org-constant">:get_x</span>].call
c1[<span class="org-constant">:decr</span>].call
c1[<span class="org-constant">:decr</span>].call

c2 = counter.call
c2[<span class="org-constant">:get_x</span>].call
</pre>
</div>

<div class="results" id="orgcbffeeb">
<p>
1
2
3
3
2
1
0
</p>

</div>
</div>
</div>

<div id="outline-container-org98e2e3d" class="outline-3">
<h3 id="org98e2e3d"><a href="#org98e2e3d">コールバック関数</a></h3>
<div class="outline-text-3" id="text-org98e2e3d">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Generator</span>
  <span class="org-builtin">attr_reader</span> <span class="org-constant">:report</span>

  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(report)
    <span class="org-variable-name">@report</span> = report
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">run</span>
    report.to_csv
  <span class="org-keyword">end</span>

<span class="org-type">Notifier</span>.new(<span class="org-type">Generator</span>.new(good_report),
             <span class="org-constant">on_success:</span> <span class="org-builtin">lambda</span> { |r| <span class="org-builtin">puts</span> <span class="org-string">"Send </span><span class="org-variable-name">#{r}</span><span class="org-string"> to boss"</span> },
             <span class="org-constant">on_failure:</span> <span class="org-builtin">lambda</span> { <span class="org-builtin">puts</span> <span class="org-string">"Send to ben"</span> }
            ).tap <span class="org-keyword">do</span> |n|
  n.run
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby">is_even = <span class="org-builtin">lambda</span> { |x| x % 2 == 0 }
is_even.call(3)
</pre>
</div>

<div class="results" id="org8e70992">
<p>
false
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">is_even = <span class="org-builtin">lambda</span> { |x| x % 2 == 0 }
<span class="org-keyword">def</span> <span class="org-function-name">complement</span>(predicate, value)
  <span class="org-keyword">not</span> predicate.call(value)
<span class="org-keyword">end</span>
complement(is_even, 3)
</pre>
</div>

<div class="results" id="org3c3a04f">
<p>
true
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">is_even = <span class="org-builtin">lambda</span> { |x| x % 2 == 0 }
<span class="org-keyword">def</span> <span class="org-function-name">complement</span>(predicate)
  <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |value|
    <span class="org-keyword">not</span> predicate.call(value)
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
complement(is_even).call(4)
complement(is_even).call(5)
</pre>
</div>

<div class="results" id="org424dfbc">
<p>
true
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Generator</span>
  <span class="org-builtin">attr_reader</span> <span class="org-constant">:report</span>

  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(report)
    <span class="org-variable-name">@report</span> = report
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">run</span>
    report.to_csv
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">Notifier</span>
  <span class="org-builtin">attr_reader</span> <span class="org-constant">:generator</span>, <span class="org-constant">:callbacks</span>

  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(generator, callbacks)
    <span class="org-variable-name">@generator</span> = generator
    <span class="org-variable-name">@callbacks</span> = callbacks
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">run</span>
    result = generator.run
    <span class="org-keyword">if</span> result
      callbacks.fetch(<span class="org-constant">:on_success</span>).call(result)
    <span class="org-keyword">else</span>
      callbacks.fetch(<span class="org-constant">:on_failure</span>).call
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

good_report = <span class="org-type">OpenStruct</span>.new(<span class="org-constant">to_csv:</span> <span class="org-string">"59.99, Great Success"</span>)

<span class="org-type">Notifier</span>.new(<span class="org-type">Generator</span>.new(good_report),
             <span class="org-constant">on_success:</span> <span class="org-builtin">lambda</span> { |r| <span class="org-builtin">puts</span> <span class="org-string">"Send </span><span class="org-variable-name">#{r}</span><span class="org-string"> to boss"</span> },
             <span class="org-constant">on_failure:</span> <span class="org-builtin">lambda</span> { <span class="org-builtin">puts</span> <span class="org-string">"Send email to ben"</span> }
            ).tap <span class="org-keyword">do</span> |n|
  n.run <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt; send 59.99, great succes to boss</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby">good_report = <span class="org-type">OpenStruct</span>.new(<span class="org-constant">to_csv:</span> <span class="org-constant">nil</span>)

<span class="org-type">Notifier</span>.new(<span class="org-type">Generator</span>.new(good_report),
             <span class="org-constant">on_success:</span> <span class="org-builtin">lambda</span> { |r| <span class="org-builtin">puts</span> <span class="org-string">"Send </span><span class="org-variable-name">#{r}</span><span class="org-string"> to boss"</span> },
             <span class="org-constant">on_failure:</span> <span class="org-builtin">lambda</span> { <span class="org-builtin">puts</span> <span class="org-string">"Send email to ben"</span> }
            ).tap <span class="org-keyword">do</span> |n|
  n.run <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt; ben</span>
<span class="org-keyword">end</span>
</pre>
</div>
<p>
元のNotifierクラスに手を加えることなく、ログ機能を追加できた。
</p>
</div>
</div>
<div id="outline-container-org8bc8ef8" class="outline-3">
<h3 id="org8bc8ef8"><a href="#org8bc8ef8">reduce</a></h3>
<div class="outline-text-3" id="text-org8bc8ef8">
<p>
既存のreduceの例。
</p>
<div class="org-src-container">
<pre class="src src-ruby">[1, 2, 3, 4, 5].reduce(10) { |acc, x| <span class="org-builtin">p</span> <span class="org-string">"</span><span class="org-variable-name">#{acc}</span><span class="org-string">, </span><span class="org-variable-name">#{x}</span><span class="org-string">"</span>; acc + x }
</pre>
</div>

<div class="results" id="orgcb5a395">
<p>
25
</p>

</div>

<p>
eachを使わずに実装。再帰になる。
</p>

<div class="org-src-container">
<pre class="src src-ruby">adder = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |acc, arr|
  <span class="org-keyword">if</span> arr.empty?
    acc
  <span class="org-keyword">else</span>
    adder.call(acc + arr.first, arr.drop(1))
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
adder.call(10, [1, 2, 3, 4, 5])
</pre>
</div>

<div class="results" id="org5301249">
<p>
25
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">multiplier = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |acc, arr|
  <span class="org-keyword">if</span> arr.empty?
    acc
  <span class="org-keyword">else</span>
    multiplier.call(acc * arr.first, arr.drop(1))
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
multiplier.call(10, [1, 2, 3, 4, 5])
</pre>
</div>

<div class="results" id="org7c5e8a7">
<p>
1200
</p>

</div>

<p>
変わったのは演算子だけで、DRYでない。
抽象化する。
</p>

<div class="org-src-container">
<pre class="src src-ruby">reducer = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |acc, arr, binary_function|
  <span class="org-keyword">if</span> arr.empty?
    acc
  <span class="org-keyword">else</span>
    reducer.call(binary_function.call(acc, arr.first), arr.drop(1), binary_function)
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
reducer.call(1, [1, 2, 3, 4, 5], <span class="org-builtin">lambda</span> { |x, y| x + y })
</pre>
</div>

<div class="results" id="org4a45c3f">
<p>
16
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">reducer = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |acc, arr, binary_function|
  reducer_aux = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |acc, arr|
    <span class="org-keyword">if</span> arr.empty?
      acc
    <span class="org-keyword">else</span>
      reducer_aux.call(binary_function.call(acc, arr.first), arr.drop(1))
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  reducer_aux.call(acc, arr)
<span class="org-keyword">end</span>

reducer.call(1, [1, 2, 3, 4, 5], <span class="org-builtin">lambda</span> { |x, y| x + y })
</pre>
</div>

<div class="results" id="org38ec0fc">
<p>
16
</p>

</div>
</div>
</div>
<div id="outline-container-orgf0f642c" class="outline-3">
<h3 id="orgf0f642c"><a href="#orgf0f642c">ex1</a></h3>
<div class="outline-text-3" id="text-orgf0f642c">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">is_larger_than</span>(amount)
  <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |a|
    a &gt; amount <span class="org-comment-delimiter"># </span><span class="org-comment">amount is free variable</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

larger_than_5 = is_larger_than(5)
larger_than_5.call(7)
larger_than_5.call(3)
</pre>
</div>

<div class="results" id="orgc577f06">
<p>
false
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">new_db = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span>
  db = {}
  insert = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |key, value|
    <span class="org-builtin">p</span> db.store(key, value)
  <span class="org-keyword">end</span>
  dump = <span class="org-builtin">lambda</span> { <span class="org-builtin">p</span> db }
  delete = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |key|
    <span class="org-builtin">p</span> db.delete(key)
  <span class="org-keyword">end</span>
  {<span class="org-constant">insert:</span> insert, <span class="org-constant">dump:</span> dump, <span class="org-constant">delete:</span> delete}
<span class="org-keyword">end</span>
db = new_db.call
db[<span class="org-constant">:insert</span>].call(<span class="org-string">"this is key"</span>, <span class="org-string">"this is value"</span>)
db[<span class="org-constant">:dump</span>].call
db[<span class="org-constant">:delete</span>].call(<span class="org-string">"this is key"</span>)
db[<span class="org-constant">:dump</span>].call
</pre>
</div>

<div class="results" id="orga31d8a4">
<p>
&ldquo;this is value&rdquo;
{&ldquo;this is key&rdquo;=&gt;&ldquo;this is value&rdquo;}
&ldquo;this is value&rdquo;
{}
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">complement = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |function|
  <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |arg|
    <span class="org-keyword">not</span> function.call(arg)
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

is_even = <span class="org-builtin">lambda</span> { |x| x % 2 == 0 }
complement.call(is_even).call(5)
</pre>
</div>

<div class="results" id="orge9d9ae7">
<p>
true
</p>

</div>

<p>
この部分遅延させる感じが本質か。
</p>

<p>
畳み込み演算の配列バージョン。
</p>
<div class="org-src-container">
<pre class="src src-ruby">[1, 2, 3, 4, 5].reduce(<span class="org-type">Array</span>.new()) { |result, item| result &lt;&lt; item * 2 }
</pre>
</div>

<div class="results" id="org38aebff">
<p>
[2, 4, 6, 8, 10]
</p>

</div>
</div>
</div>
<div id="outline-container-org53b5b0c" class="outline-3">
<h3 id="org53b5b0c"><a href="#org53b5b0c">ブロック</a></h3>
<div class="outline-text-3" id="text-org53b5b0c">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">do_it</span>
  <span class="org-keyword">yield</span>
<span class="org-keyword">end</span>
do_it {<span class="org-string">"I'm doing it."</span>}
</pre>
</div>

<div class="results" id="org25e8763">
<p>
I&rsquo;m doing it.
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">do_it</span>
  <span class="org-keyword">yield</span>
<span class="org-keyword">end</span>
do_it { [1, 2, 3] &lt;&lt; 4}
</pre>
</div>

<div class="results" id="orgc734488">
<p>
[1, 2, 3, 4]
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">do_it</span>(x, y)
  <span class="org-keyword">yield</span>(x, y)
<span class="org-keyword">end</span>
do_it(2, 3) { |x, y| x + y }
do_it(<span class="org-string">"Ohai"</span>, <span class="org-string">"Dictator"</span>) <span class="org-keyword">do</span> |greeting, title|
    <span class="org-string">"</span><span class="org-variable-name">#{greeting}</span><span class="org-string">, </span><span class="org-variable-name">#{title}</span><span class="org-string">!!!"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="results" id="org7ce6260">
<p>
Ohai, Dictator!!!
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">do_it</span>(x)
  <span class="org-keyword">yield</span> x
<span class="org-keyword">end</span>
do_it(42) { |num, line| <span class="org-string">"</span><span class="org-variable-name">#{num}</span><span class="org-string">: </span><span class="org-variable-name">#{line}</span><span class="org-string">"</span> }
</pre>
</div>

<div class="results" id="org6d23b82">
<p>
42:
</p>

</div>

<p>
ブロックは無名関数に似ている。名前がかぶると外側にあっても上書きする。
</p>

<div class="org-src-container">
<pre class="src src-ruby">x = <span class="org-string">"outside x"</span>
1.times { x = <span class="org-string">"modified from the outside block"</span> }
x
</pre>
</div>

<div class="results" id="orgbe9f93c">
<p>
modified from the outside block
</p>

</div>

<p>
ブロック変数を使うとブロック外を上書きしない。
</p>
<div class="org-src-container">
<pre class="src src-ruby">x = <span class="org-string">"outside x"</span>
1.times { |;x| x = <span class="org-string">"modified from the outside block"</span> }
x
</pre>
</div>

<div class="results" id="org23fe93b">
<p>
outside x
</p>

</div>
</div>
</div>
<div id="outline-container-orgfaa87c4" class="outline-3">
<h3 id="orgfaa87c4"><a href="#orgfaa87c4">Fixnum#times</a></h3>
<div class="outline-text-3" id="text-orgfaa87c4">
<p>
↓みたいなことができるのはどうしてか。
</p>
<div class="org-src-container">
<pre class="src src-ruby">3.times { <span class="org-builtin">puts</span> <span class="org-string">"D'oh!"</span> }
</pre>
</div>

<div class="results" id="org28f0ac5">
<p>
D&rsquo;oh!
D&rsquo;oh!
D&rsquo;oh!
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Fixnum</span>
  <span class="org-keyword">def</span> <span class="org-function-name">times</span>
    <span class="org-builtin">puts</span> <span class="org-string">"This does nothing yet!"</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
3.times { <span class="org-builtin">puts</span> <span class="org-string">"D'oh!"</span> }
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Array</span>
  <span class="org-keyword">def</span> <span class="org-function-name">each</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
<span class="org-string">%w(look ma no for loops)</span>.each <span class="org-keyword">do</span> |x|
  <span class="org-builtin">puts</span> x
<span class="org-keyword">end</span>
</pre>
</div>

<p>
eachを作ってみる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Array</span>
  <span class="org-keyword">def</span> <span class="org-function-name">each</span>
    x = 0
    <span class="org-keyword">while</span> x &lt; <span class="org-keyword">self</span>.length
      <span class="org-keyword">yield</span> <span class="org-keyword">self</span>[x]
      x += 1
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-string">%w(look me no for loops)</span>.each <span class="org-keyword">do</span> |x|
  <span class="org-builtin">puts</span> x
<span class="org-keyword">end</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">look</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">me</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">no</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">for</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">loops</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org885dd4d" class="outline-3">
<h3 id="org885dd4d"><a href="#org885dd4d">IO close利用</a></h3>
<div class="outline-text-3" id="text-org885dd4d">
<p>
ブロックはファイルクローズのし忘れ防止にも使える。これはどうやって実装しているか。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">File</span>.open() <span class="org-keyword">do</span> |f|
  f &lt;&lt; <span class="org-string">"aaa"</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
実装してみる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">File</span>
  <span class="org-keyword">def</span> <span class="org-keyword">self</span>.<span class="org-function-name">open</span>(name, mode)
    file = new(name, mode)
    <span class="org-keyword">return</span> file <span class="org-keyword">unless</span> <span class="org-builtin">block_given?</span>
    <span class="org-keyword">yield</span>(file)
  <span class="org-keyword">ensure</span>
    file.close
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb3dbf8d" class="outline-3">
<h3 id="orgb3dbf8d"><a href="#orgb3dbf8d">オブジェクトの初期化</a></h3>
<div class="outline-text-3" id="text-orgb3dbf8d">
<p>
ブロックはオブジェクトの初期化にも使える。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">Twitter</span>
  <span class="org-keyword">module</span> <span class="org-type">REST</span>
    <span class="org-keyword">class</span> <span class="org-type">Client</span>
      <span class="org-builtin">attr_accessor</span> <span class="org-constant">:consumer_key</span>, <span class="org-constant">:consumer_secret</span>,
                    <span class="org-constant">:access_token</span>, <span class="org-constant">:access_token_secret</span>
      <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>
        <span class="org-keyword">yield</span> <span class="org-keyword">self</span> <span class="org-keyword">if</span> <span class="org-builtin">block_given?</span>
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

client = <span class="org-type">Twitter</span>::<span class="org-type">REST</span>::<span class="org-type">Client</span>.new <span class="org-keyword">do</span> |config|
  config.consumer_key        = <span class="org-string">"YOUR_CONSUMER_KEY"</span>
  config.consumer_secret     = <span class="org-string">"YOUR_CONSUMER_SECRET"</span>
  config.access_token        = <span class="org-string">"YOUR_ACCESS_TOKEN"</span>
  config.access_token_secret = <span class="org-string">"YOUR_ACCESS_SECRET"</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter">#</span><span class="org-comment">&lt;Twitter::REST::Client:0x000056204ff8f410 @consumer_key="YOUR_CONSUMER_KEY", @consumer_secret="YOUR_CONSUMER_SECRET", @access_token="YOUR_ACCESS_TOKEN", @access_token_secret="YOUR_ACCESS_SECRET"&gt;</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Router</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>
    <span class="org-keyword">yield</span> <span class="org-keyword">self</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">match</span>(route)
    <span class="org-builtin">puts</span> route
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

routes = <span class="org-type">Router</span>.new <span class="org-keyword">do</span> |r|
  r.match <span class="org-string">'/about'</span> =&gt; <span class="org-string">'home#about'</span>
  r.match <span class="org-string">'/users'</span> =&gt; <span class="org-string">'users#index'</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>のrouterでやっているように、ここからどうやってレシーバーの <code>r</code> を使わずに指定できるのか。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">foo</span>
  <span class="org-keyword">yield</span> <span class="org-keyword">self</span>
<span class="org-keyword">end</span>

foo <span class="org-keyword">do</span>
  <span class="org-builtin">puts</span> <span class="org-keyword">self</span>
<span class="org-keyword">end</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; main</span>
</pre>
</div>

<p>
ブロック内のselfはブロックが定義されたところのselfになる。ということで、selfを変えたければブロックが定義されるコンテキストを変えなければならない。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Router</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(&amp;block)
    instance_eval &amp;block
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">match</span>(route)
    <span class="org-builtin">puts</span> route
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

routes = <span class="org-type">Router</span>.new <span class="org-keyword">do</span>
  match <span class="org-string">'/about'</span> =&gt; <span class="org-string">'home#about'</span>
<span class="org-keyword">end</span>
</pre>
</div>
<p>
Routerコンテキストになるので、デフォルトレシーバーでmatchが呼べる。
</p>

<p>
オプションをハッシュで受け取る。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">Twitter</span>
  <span class="org-keyword">module</span> <span class="org-type">REST</span>
    <span class="org-keyword">class</span> <span class="org-type">Client</span>
      <span class="org-builtin">attr_accessor</span> <span class="org-constant">:consumer_key</span>, <span class="org-constant">:consumer_secret</span>,
                    <span class="org-constant">:access_token</span>, <span class="org-constant">:access_token_secret</span>

      <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(options = {}, &amp;block)
        options.each { |k, v| send(<span class="org-string">"</span><span class="org-variable-name">#{k}</span><span class="org-string">="</span>, v) }
        instance_eval(&amp;block) <span class="org-keyword">if</span> <span class="org-builtin">block_given?</span>
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

client = <span class="org-type">Twitter</span>::<span class="org-type">REST</span>::<span class="org-type">Client</span>.new({<span class="org-constant">consumer_key:</span> <span class="org-string">"YOUR_CONSUMER_KEY"</span>}) <span class="org-keyword">do</span>
  consumer_secret     = <span class="org-string">"YOUR_CONSUMER_SECRET"</span>
  access_token        = <span class="org-string">"YOUR_ACCESS_TOKEN"</span>
  access_token_secret = <span class="org-string">"YOUR_ACCESS_SECRET"</span>
<span class="org-keyword">end</span>
</pre>
</div>
<p>
オプションハッシュを使うか、ブロックを使うか、あるいは両方を使うか選択できる。
</p>
</div>
</div>
<div id="outline-container-org9307692" class="outline-3">
<h3 id="org9307692"><a href="#org9307692">ex2</a></h3>
<div class="outline-text-3" id="text-org9307692">
<p>
eachを使ってmapを実装する。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Array</span>
  <span class="org-keyword">def</span> <span class="org-function-name">map</span>
    array = []
    each <span class="org-keyword">do</span> |x|
      array.push(<span class="org-keyword">yield</span> x)
    <span class="org-keyword">end</span>
    array
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
goal = <span class="org-string">%w(look ma no for loops)</span>.map <span class="org-keyword">do</span> |x|
  x.upcase
<span class="org-keyword">end</span>
<span class="org-builtin">p</span> goal

</pre>
</div>

<p>
each_wordを実装する。
例えば↓みたいな動作イメージ。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-string">"Nothing lasts forever but cold November Rain"</span>.each_word <span class="org-keyword">do</span> |x|
  <span class="org-builtin">puts</span> x
<span class="org-keyword">end</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; Nothing</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; lasts</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; forever ...</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">String</span>
  <span class="org-keyword">def</span> <span class="org-function-name">each_word</span>
    split.each <span class="org-keyword">do</span> |x|
      <span class="org-keyword">yield</span> x
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-string">"Nothing lasts forever but cold November Rain"</span>.each_word <span class="org-keyword">do</span> |x|
  <span class="org-builtin">puts</span> x
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Active RecordのDSLを実装する。
例えば。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">ActiveRecord</span>::<span class="org-type">Schema</span>.define(<span class="org-constant">version:</span> 20130314230445) <span class="org-keyword">do</span>
  create_table <span class="org-string">"microposts"</span>, <span class="org-constant">force:</span> <span class="org-constant">true</span> <span class="org-keyword">do</span> |t|
    t.string <span class="org-string">"content"</span>
    t.integer <span class="org-string">"user_id"</span>
    t.datetime <span class="org-string">"created_at"</span>
    t.datetime <span class="org-string">"updated_at"</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">ActiveRecord</span>
  <span class="org-keyword">class</span> <span class="org-type">Schema</span>
    <span class="org-keyword">def</span> <span class="org-keyword">self</span>.<span class="org-function-name">define</span>(version, &amp;block)
      version
      instance_eval(&amp;block) <span class="org-keyword">if</span> <span class="org-builtin">block_given?</span>
    <span class="org-keyword">end</span>

    <span class="org-keyword">def</span> <span class="org-keyword">self</span>.<span class="org-function-name">create_table</span>(table_name, options = {}, &amp;block)
      t = <span class="org-type">Table</span>.new(table_name, options)
      <span class="org-keyword">yield</span> t <span class="org-keyword">if</span> <span class="org-builtin">block_given?</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">Table</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(name, options)
    <span class="org-variable-name">@name</span> = name
    <span class="org-variable-name">@options</span> = options
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">string</span>(value)
    <span class="org-builtin">puts</span> <span class="org-string">"Creating column of type string named </span><span class="org-variable-name">#{value}</span><span class="org-string">"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">integer</span>(value)
    <span class="org-builtin">puts</span> <span class="org-string">"Creating column of type integer named </span><span class="org-variable-name">#{value}</span><span class="org-string">"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">datetime</span>(value)
    <span class="org-builtin">puts</span> <span class="org-string">"Creating column of type datetime named </span><span class="org-variable-name">#{value}</span><span class="org-string">"</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-type">ActiveRecord</span>::<span class="org-type">Schema</span>.define(<span class="org-constant">version:</span> 20130315230445) <span class="org-keyword">do</span>
  create_table <span class="org-string">"microposts"</span>, <span class="org-constant">force:</span> <span class="org-constant">true</span> <span class="org-keyword">do</span> |t|
    t.string <span class="org-string">"content"</span>
    t.integer <span class="org-string">"user_id"</span>
    t.datetime <span class="org-string">"created_at"</span>
    t.datetime <span class="org-string">"updated_at"</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">Output</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Creating column of type string named content</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Creating column of type string named user_id</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Creating column of type string named created_at</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">Creating column of type string named updated_at</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd8689a6" class="outline-3">
<h3 id="orgd8689a6"><a href="#orgd8689a6">Proc</a></h3>
<div class="outline-text-3" id="text-orgd8689a6">
<p>
ブロックは単体で存在できないが、ProcとLambdaは単体でオブジェクトとして存在できる。
</p>

<div class="org-src-container">
<pre class="src src-ruby">p = <span class="org-builtin">proc</span> { |x, y| x + y }
</pre>
</div>

<div class="results" id="org8982c6e">
<p>
#&lt;Proc:0x000055b7801c80d0 -:3&gt;
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">p = <span class="org-type">Kernel</span>.proc { |x, y| x + y }
</pre>
</div>

<div class="results" id="org060f6e9">
<p>
#&lt;Proc:0x0000557970bb7a58 -:3&gt;
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">p = <span class="org-builtin">proc</span> { |x, y| <span class="org-builtin">p</span> x + y }
p.call(<span class="org-string">"oh"</span>, <span class="org-string">"ai"</span>)
p.call(4, 2)
</pre>
</div>

<div class="results" id="org0a73c2f">
<p>
&ldquo;ohai&rdquo;
6
</p>

</div>

<p>
短縮記法もある。
</p>
<div class="org-src-container">
<pre class="src src-ruby">p = <span class="org-builtin">proc</span> { |x, y| <span class="org-builtin">p</span> x + y }
p.(<span class="org-string">"oh"</span>, <span class="org-string">"ai"</span>)
p.(1, 2)
</pre>
</div>

<div class="results" id="orgebb205b">
<p>
&ldquo;ohai&rdquo;
3
</p>

</div>

<p>
この記法は、call()が実装されているクラスならどこでも使用できる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Carly</span>
  <span class="org-keyword">def</span> <span class="org-function-name">call</span>(who)
    <span class="org-string">"call </span><span class="org-variable-name">#{who}</span><span class="org-string">, maybe"</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
c = <span class="org-type">Carly</span>.new
c.(<span class="org-string">"me"</span>)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby">even = <span class="org-builtin">proc</span> { |x| x % 2 == 0 }
<span class="org-builtin">p</span> even === 11
<span class="org-builtin">p</span> even === 10
</pre>
</div>

<div class="results" id="orga353770">
<p>
false
true
</p>

</div>
</div>
</div>
<div id="outline-container-orgc55366f" class="outline-3">
<h3 id="orgc55366f"><a href="#orgc55366f">Lambda</a></h3>
<div class="outline-text-3" id="text-orgc55366f">
<p>
lambdaのクラスはProcである。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">lambda</span> {}.class
</pre>
</div>

<div class="results" id="org9f76da7">
<p>
Proc
</p>

</div>

<p>
procのクラスはProcである。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">proc</span> {}.class
</pre>
</div>

<div class="results" id="orgc3e0dbb">
<p>
Proc
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">lambda</span> { |x, y| x + y }.call(x, y)
<span class="org-builtin">lambda</span> { |x, y| x + y }[x, y]
<span class="org-builtin">lambda</span> { |x, y| x + y }.(x, y)
<span class="org-builtin">lambda</span> { |x, y| x + y } === [x, y]

-&gt; (x, y){ x + y }.call(x, y)
-&gt; (x, y){ x + y }[x, y]
-&gt; (x, y){ x + y }.(x, y)
-&gt; (x, y){ x + y } === [x, y]
</pre>
</div>

<div class="results" id="orge455c75">

</div>

<p>
-&gt;がよくラムダ計算表記に使われるのは、λに似てるかららしい。まじか。
</p>

<p>
procは引数の数が合ってなくてもエラーにならない。
</p>
<div class="org-src-container">
<pre class="src src-ruby">l = <span class="org-builtin">lambda</span> { |x, y| <span class="org-builtin">puts</span> <span class="org-string">"x: </span><span class="org-variable-name">#{x}</span><span class="org-string">, y: </span><span class="org-variable-name">#{y}</span><span class="org-string">"</span> }
l.call(<span class="org-string">"Ohai"</span>, <span class="org-string">"Gentle Reader"</span>)
p = <span class="org-builtin">proc</span> { |x, y| <span class="org-builtin">puts</span> <span class="org-string">"x: </span><span class="org-variable-name">#{x}</span><span class="org-string">, y: </span><span class="org-variable-name">#{y}</span><span class="org-string">"</span> }
p.call(<span class="org-string">"Ohai"</span>, <span class="org-string">"Gentle Reader"</span>)
p.call(<span class="org-string">"Ohai"</span>)
</pre>
</div>

<div class="results" id="org6124da3">
<p>
x: Ohai, y: Gentle Reader
x: Ohai, y: Gentle Reader
x: Ohai, y:
</p>

</div>

<p>
lambdaは引数の数が合ってないとエラーになる。
</p>
<div class="org-src-container">
<pre class="src src-ruby">l = <span class="org-builtin">lambda</span> { |x, y| <span class="org-builtin">puts</span> <span class="org-string">"x: </span><span class="org-variable-name">#{x}</span><span class="org-string">, y: </span><span class="org-variable-name">#{y}</span><span class="org-string">"</span> }
l.call(<span class="org-string">"Ohai"</span>)
</pre>
</div>

<div class="results" id="orgff662cb">
<p>
-:3:in `block in main&rsquo;: wrong number of arguments (given 1, expected 2) (ArgumentError)
	from -:4:in `main&rsquo;
	from -:6:in `&lt;main&gt;&rsquo;
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">SomeClass</span>
  <span class="org-keyword">def</span> <span class="org-function-name">method_that_calls_proc_or_lambda</span>(procy)
    <span class="org-builtin">puts</span> <span class="org-string">"calling </span><span class="org-variable-name">#{proc_or_lambda(procy)}</span><span class="org-string"> now!"</span>
    procy.call
    <span class="org-builtin">puts</span> <span class="org-string">"</span><span class="org-variable-name">#{proc_or_lambda(procy)}</span><span class="org-string"> gets called!"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">proc_or_lambda</span>(proc_like_thing)
    proc_like_thing.lambda? ? <span class="org-string">"lambda"</span> : <span class="org-string">"Proc"</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

c = <span class="org-type">SomeClass</span>.new
c.method_that_calls_proc_or_lambda <span class="org-builtin">lambda</span> { <span class="org-keyword">return</span> } <span class="org-comment-delimiter"># </span><span class="org-comment">OK</span>
c.method_that_calls_proc_or_lambda <span class="org-builtin">proc</span> { <span class="org-keyword">return</span> } <span class="org-comment-delimiter"># </span><span class="org-comment">gets called&#12414;&#12391;&#21040;&#36948;&#12375;&#12394;&#12356;&#12290;proc&#12399;main&#12467;&#12531;&#12486;&#12461;&#12473;&#12488;&#12391;&#20316;&#12425;&#12428;&#12427;&#12290;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd3d4f3f" class="outline-3">
<h3 id="orgd3d4f3f"><a href="#orgd3d4f3f">Symbol#to_proc</a></h3>
<div class="outline-text-3" id="text-orgd3d4f3f">
<p>
Rubyでは、 <code>&amp;</code> があるとprocに変換しようとする。
なので↓は。
</p>
<div class="org-src-container">
<pre class="src src-ruby">[<span class="org-string">"a"</span>, <span class="org-string">"i"</span>, <span class="org-string">"u"</span>].map { |s| s.length }
</pre>
</div>

<div class="results" id="org0f6a8d4">
<p>
[1, 1, 1]
</p>

</div>

<p>
省略記法で書ける。
</p>
<div class="org-src-container">
<pre class="src src-ruby">[<span class="org-string">"a"</span>, <span class="org-string">"i"</span>, <span class="org-string">"u"</span>].map(&amp;<span class="org-constant">:length</span>)
</pre>
</div>

<div class="results" id="orgbc67d26">
<p>
[1, 1, 1]
</p>

</div>

<p>
これは引数がProcでないのでエラーになる。
Objectクラスがprocへの変換のやり方を知らないため。
</p>
<div class="org-src-container">
<pre class="src src-ruby">obj = <span class="org-type">Object</span>.new
[1, 2, 3].map &amp;obj
</pre>
</div>

<p>
↓こうするとエラーにはならない。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Object</span>
  <span class="org-keyword">def</span> <span class="org-function-name">to_proc</span>
    <span class="org-builtin">proc</span> {}
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
obj = <span class="org-type">Object</span>.new
<span class="org-builtin">p</span> [1, 2, 3].map &amp;obj <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; [nil, nil, nil]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Object</span>
  <span class="org-keyword">def</span> <span class="org-function-name">to_proc</span>
    <span class="org-builtin">proc</span> { |x| <span class="org-string">"Here's </span><span class="org-variable-name">#{x}</span><span class="org-string">!"</span> }
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
obj = <span class="org-type">Object</span>.new
<span class="org-builtin">p</span> [1, 2, 3].map(&amp;obj) <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; ["Here's 1!", "Here's 2!", "Here's 3!"]</span>
</pre>
</div>

<p>
汎用化させる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Symbol</span>
  <span class="org-keyword">def</span> <span class="org-function-name">to_proc</span>
    <span class="org-builtin">proc</span> { |obj| obj.send(<span class="org-keyword">self</span>) }
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
<span class="org-builtin">p</span> [<span class="org-string">"ai"</span>, <span class="org-string">"iue"</span>, <span class="org-string">"u"</span>].map(&amp;<span class="org-constant">:length</span>)
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; [2, 3, 1]</span>
<span class="org-builtin">p</span> [<span class="org-string">"ai"</span>, <span class="org-string">"iue"</span>, <span class="org-string">"u"</span>].map(&amp;<span class="org-constant">:upcase</span>)
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; ["AI", "IUE", "U"]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">p</span> [1, 2, 3].inject(0) { |result, element| result + element }
<span class="org-builtin">p</span> [1, 2, 3].inject(&amp;<span class="org-constant">:+</span>)
</pre>
</div>

<div class="results" id="org8f0ee7e">
<p>
6
6
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Symbol</span>
  <span class="org-keyword">def</span> <span class="org-function-name">to_proc</span>
    <span class="org-builtin">lambda</span> { |obj, args| obj.send(<span class="org-keyword">self</span>, *args) }
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
<span class="org-builtin">p</span> [1, 2, 3].inject(&amp;<span class="org-constant">:+</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-org0e350a4" class="outline-3">
<h3 id="org0e350a4"><a href="#org0e350a4">カリー化</a></h3>
<div class="outline-text-3" id="text-org0e350a4">
<p>
評価を遅延させること。
</p>
<div class="org-src-container">
<pre class="src src-ruby">discriminant = <span class="org-builtin">lambda</span> { |a| <span class="org-builtin">lambda</span> { |b| <span class="org-builtin">lambda</span> { |c| b **2 - 4*a*c } } }
discriminant.call(5).call(6).call(7)
</pre>
</div>

<div class="results" id="orgf24eae3">
<p>
-104
</p>

</div>

<p>
同じ意味で、簡潔に書ける。
</p>
<div class="org-src-container">
<pre class="src src-ruby">discriminant = <span class="org-builtin">lambda</span> { |a, b, c| b**2 - 4*a*c }.curry
discriminant.call(5).call(6).call(7)
</pre>
</div>

<div class="results" id="orgbe65493">
<p>
-104
</p>

</div>

<p>
これが利用できるシチュエーションを考える。
↓は重複がたくさんある。
</p>
<div class="org-src-container">
<pre class="src src-ruby">sum_ints = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |start,stop|
  (start..stop).inject{ |sum,x| sum + x }
<span class="org-keyword">end</span>

sum_of_squares= <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |start,stop|
  (start..stop).inject{ |sum,x| sum + x*x }
<span class="org-keyword">end</span>

sum_of_cubes = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |start,stop|
  (start..stop).inject{ |sum,x| sum + x*x*x}
<span class="org-keyword">end</span>
</pre>
</div>

<p>
共通化できる。
</p>
<div class="org-src-container">
<pre class="src src-ruby">sum = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |fun, start, stop|
  (start..stop).inject { |sum, x| sum + fun.call(x) }
<span class="org-keyword">end</span>

<span class="org-builtin">p</span> sum_of_ints = sum.(<span class="org-builtin">lambda</span> { |x| x }, 1, 10)
<span class="org-builtin">p</span> sum_of_square = sum.(<span class="org-builtin">lambda</span> { |x| x*x }, 1, 10)
<span class="org-builtin">p</span> sum_of_cubes = sum.(<span class="org-builtin">lambda</span> { |x| x*x*x }, 1, 10)
</pre>
</div>

<div class="results" id="org2ef981f">
<p>
55
385
3025
</p>

</div>

<p>
さらにカリー化。
</p>

<div class="org-src-container">
<pre class="src src-ruby">sum = <span class="org-builtin">lambda</span> <span class="org-keyword">do</span> |fun, start, stop|
  (start..stop).inject { |sum, x| sum + fun.call(x) }
<span class="org-keyword">end</span>

sum_of_squares = sum.curry.(<span class="org-builtin">lambda</span> { |x| x*x })
sum_of_squares.(1).(10)
sum_of_squares.(50).(100)
</pre>
</div>

<div class="results" id="orgac82496">
<p>
295475
</p>

</div>
</div>
</div>
<div id="outline-container-orgf2a8e17" class="outline-3">
<h3 id="orgf2a8e17"><a href="#orgf2a8e17">ex3</a></h3>
<div class="outline-text-3" id="text-orgf2a8e17">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Symbol</span>
  <span class="org-keyword">def</span> <span class="org-function-name">to_proc</span>
    <span class="org-builtin">proc</span> { |obj, args| obj.send(<span class="org-keyword">self</span>, *args) }
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-string">"aaaa"</span>.send(<span class="org-constant">:length</span>)
</pre>
</div>

<div class="results" id="org9147c32">
<p>
4
</p>

</div>

<p>
to_procを初期化に使うことができる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">SpiceGirl</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(name, nick)
    <span class="org-variable-name">@name</span> = name
    <span class="org-variable-name">@nick</span> = nick
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">inspect</span>
    <span class="org-string">"</span><span class="org-variable-name">#{@name}</span><span class="org-string"> (</span><span class="org-variable-name">#{@nick}</span><span class="org-string"> Spice)"</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-keyword">self</span>.<span class="org-function-name">to_proc</span>
    <span class="org-builtin">proc</span> { |obj| <span class="org-keyword">self</span>.new(obj[0], obj[1]) }
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

spice_girls = [[<span class="org-string">"tarou"</span>, <span class="org-string">"T"</span>], [<span class="org-string">"jirou"</span>, <span class="org-string">"J"</span>]]
<span class="org-builtin">p</span> spice_girls.map(&amp;<span class="org-type">SpiceGirl</span>)
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; [tarou (T Spice), jirou (J Spice)]</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">p</span> <span class="org-builtin">proc</span> {}.class
<span class="org-builtin">p</span> <span class="org-builtin">proc</span> {}.lambda?
<span class="org-builtin">p</span> <span class="org-builtin">lambda</span> {}.class
<span class="org-builtin">p</span> <span class="org-builtin">lambda</span> {}.lambda?
<span class="org-builtin">p</span> -&gt; {}.class
<span class="org-builtin">p</span> <span class="org-builtin">lambda</span> {}.lambda?
</pre>
</div>

<div class="results" id="org90dea5f">
<p>
Proc
false
Proc
true
Proc
true
</p>

</div>

<p>
lambdaは引数の数が合わないとエラーになる。
</p>
<div class="org-src-container">
<pre class="src src-ruby">j1 = <span class="org-builtin">proc</span>   { |x,y,z| <span class="org-string">"</span><span class="org-variable-name">#{x}</span><span class="org-string">, </span><span class="org-variable-name">#{y}</span><span class="org-string">, </span><span class="org-variable-name">#{z}</span><span class="org-string">"</span> }
j2 = <span class="org-builtin">lambda</span> { |x,y,z| <span class="org-string">"</span><span class="org-variable-name">#{x}</span><span class="org-string">, </span><span class="org-variable-name">#{y}</span><span class="org-string">, </span><span class="org-variable-name">#{z}</span><span class="org-string">"</span> }
j1.call(<span class="org-string">"hello"</span>, <span class="org-string">"world"</span>)
<span class="org-comment-delimiter"># </span><span class="org-comment">j2.call("hello", "world") # argument error</span>
</pre>
</div>

<div class="results" id="orgd1e2286">
<p>
hello, world,
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">j1 = <span class="org-builtin">proc</span> { |x,y,z| x + y + z }
j2 = <span class="org-builtin">lambda</span> { |x,y,z| x + y + z }
<span class="org-comment-delimiter"># </span><span class="org-comment">j1.call(1, 2) # -:3:in `+': nil can't be coerced into Integer (TypeError)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">j2.call(1, 2) # -:4:in `block in main': wrong number of arguments (given 2, expected 3) (ArgumentError)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfdd43e2" class="outline-3">
<h3 id="orgfdd43e2"><a href="#orgfdd43e2">enumerable</a></h3>
<div class="outline-text-3" id="text-orgfdd43e2">
<ul class="org-ul">
<li>enumerable: 機能を持ったモジュール(ArrayとかHashと同列)。include先のクラスが持つ each メソッドを元に、様々なメソッドを提供する。</li>
<li>enumerator: 実際にenumerateするオブジェクト。each 以外のメソッドにも Enumerable の機能を提供するためのラッパークラス。外部イテレータとしても使える。</li>
</ul>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>) <span class="org-comment-delimiter"># </span><span class="org-comment">&#35413;&#20385;&#12379;&#12378;&#12458;&#12502;&#12472;&#12455;&#12463;&#12488;&#12434;&#36820;&#12377;</span>
<span class="org-builtin">p</span> 1.upto(5).to_a <span class="org-comment-delimiter"># </span><span class="org-comment">&#35413;&#20385;&#12377;&#12427;</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">p 1.upto(Float::INFINITY).to_a # &#20966;&#29702;&#12399;&#32066;&#12431;&#12425;&#12394;&#12356;</span>
</pre>
</div>

<div class="results" id="org0f809b7">
<p>
#&lt;Enumerator: 1:upto(Infinity)&gt;
[1, 2, 3, 4, 5]
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lazy.map { |x| x * x }
<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lazy.map { |x| x * x }.take(10)
<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lazy.map { |x| x * x }.take(10).to_a
</pre>
</div>

<div class="results" id="org979de85">
<p>
#&lt;Enumerator::Lazy: #&lt;Enumerator::Lazy: #&lt;Enumerator: 1:upto(Infinity)&gt;&gt;:map&gt;
#&lt;Enumerator::Lazy: #&lt;Enumerator::Lazy: #&lt;Enumerator::Lazy: #&lt;Enumerator: 1:upto(Infinity)&gt;&gt;:map&gt;:take(10)&gt;
[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]
</p>

</div>
</div>
</div>
<div id="outline-container-orge18e759" class="outline-3">
<h3 id="orge18e759"><a href="#orge18e759">internal iterationとexternal iteration</a></h3>
<div class="outline-text-3" id="text-orge18e759">
<p>
internalは、Arrayオブジェクトがiterateをコントロールする。戻れない。
externalは、包んでいる外部のオブジェクトがiterateをコントロールする。状態を持っているので戻ったり止めたりできる。
</p>

<p>
EnumeratorはEnumerableを包んでいる。
Arrayを入れてみる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-builtin">p</span> e = <span class="org-type">Enumerator</span>.new([1, 2, 3])
<span class="org-builtin">p</span> e.next
<span class="org-builtin">p</span> e.next
<span class="org-builtin">p</span> e.next
</pre>
</div>

<div class="results" id="org0878123">
<p>
#&lt;Enumerator: [1, 2, 3]:each&gt;
1
2
3
</p>

</div>

<div class="org-src-container">
<pre class="src src-ruby">e = <span class="org-type">Enumerator</span>.new <span class="org-keyword">do</span> |yielder|
  [1, 2, 3].each <span class="org-keyword">do</span> |val|
    yielder &lt;&lt; val
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
fiberクラスは内部iteratorを外部iteratorに変換する。
</p>

<div class="org-src-container">
<pre class="src src-ruby">f = <span class="org-type">Fiber</span>.new <span class="org-keyword">do</span>
  x = 0
  <span class="org-builtin">loop</span> <span class="org-keyword">do</span>
    <span class="org-type">Fiber</span>.yield x
    x += 1
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-builtin">p</span> f.resume
<span class="org-builtin">p</span> f.resume
<span class="org-builtin">p</span> f.resume
</pre>
</div>

<div class="results" id="org335a7b9">
<p>
0
1
2
</p>

</div>
</div>
</div>
<div id="outline-container-orgb186098" class="outline-3">
<h3 id="orgb186098"><a href="#orgb186098">EnumerableとEnumerator</a></h3>
<div class="outline-text-3" id="text-orgb186098">
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">Enumerable</span>
  <span class="org-keyword">def</span> <span class="org-function-name">lax</span>
    <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>)
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">Lax</span> &lt; <span class="org-type">Enumerator</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(receiver)
    <span class="org-keyword">super</span>() <span class="org-keyword">do</span> |yielder|
      receiver.each <span class="org-keyword">do</span> |val|
        yielder &lt;&lt; val
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

e = 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lax
<span class="org-builtin">p</span> e.next <span class="org-comment-delimiter"># </span><span class="org-comment">1</span>
<span class="org-builtin">p</span> e.next <span class="org-comment-delimiter"># </span><span class="org-comment">2</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">Enumerable</span>
  <span class="org-keyword">def</span> <span class="org-function-name">lax</span>
    <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>)
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">Lax</span> &lt; <span class="org-type">Enumerator</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(receiver)
    <span class="org-keyword">super</span>() <span class="org-keyword">do</span> |yielder|
      receiver.each <span class="org-keyword">do</span> |val|
        <span class="org-builtin">puts</span> <span class="org-string">"add: </span><span class="org-variable-name">#{val}</span><span class="org-string">"</span>
        yielder &lt;&lt; val
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

lax = <span class="org-type">Lax</span>.new([1, 2, 3])
lax.map { |x| <span class="org-builtin">puts</span> <span class="org-string">"map: </span><span class="org-variable-name">#{x}</span><span class="org-string">; x"</span> }

<span class="org-comment-delimiter"># </span><span class="org-comment">add: 1</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">map: 1; x</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">add: 2</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">map: 2; x</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">add: 3</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">map: 3; x</span>
</pre>
</div>

<p>
lazy mapの実装。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">Enumerable</span>
  <span class="org-keyword">def</span> <span class="org-function-name">lax</span>
    <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>)
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">Lax</span> &lt; <span class="org-type">Enumerator</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(receiver)
    <span class="org-keyword">super</span>() <span class="org-keyword">do</span> |yielder|
      receiver.each <span class="org-keyword">do</span> |val|
        <span class="org-keyword">if</span> <span class="org-builtin">block_given?</span>
          <span class="org-keyword">yield</span>(yielder, val)
        <span class="org-keyword">else</span>
          yielder &lt;&lt; val
        <span class="org-keyword">end</span>
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">map</span>(&amp;block)
    <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>) <span class="org-keyword">do</span> |yielder, val|
      yielder &lt;&lt; block.call(val)
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lax.map { |x| x*x }.map { |x| x+1 }.first(5)
<span class="org-comment-delimiter"># </span><span class="org-comment">[2, 5, 10, 17, 26]</span>
</pre>
</div>

<p>
lazy takeの実装。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">take</span>(n)
  taken = 0
  <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>) <span class="org-keyword">do</span> |yielder, val|
    <span class="org-keyword">if</span> taken &lt; n
      yielder &lt;&lt; val
      taken += 1
    <span class="org-keyword">else</span>
      <span class="org-builtin">raise</span> <span class="org-type">StopIteration</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lax.take(5).first(5)
<span class="org-comment-delimiter"># </span><span class="org-comment">[1, 2, 3, 4, 5]</span>
</pre>
</div>

<p>
まとめ。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Lax</span> &lt; <span class="org-type">Enumerator</span>
  <span class="org-keyword">def</span> <span class="org-function-name">initialize</span>(receiver)
    <span class="org-keyword">super</span>() <span class="org-keyword">do</span> |yielder|
      receiver.each <span class="org-keyword">do</span> |val|
        <span class="org-keyword">if</span> <span class="org-builtin">block_given?</span>
          <span class="org-keyword">yield</span>(yielder, val)
        <span class="org-keyword">else</span>
          yielder &lt;&lt; val
        <span class="org-keyword">end</span>
      <span class="org-keyword">end</span>
    <span class="org-keyword">rescue</span> <span class="org-type">StopIteration</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">map</span>(&amp;block)
    <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>) <span class="org-keyword">do</span> |yielder, val|
      yielder &lt;&lt; block.call(val)
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">take</span>(n)
    taken = 0
    <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>) <span class="org-keyword">do</span> |yielder, val|
      <span class="org-keyword">if</span> taken &lt; n
        yielder &lt;&lt; val
        taken += 1
      <span class="org-keyword">else</span>
        <span class="org-builtin">raise</span> <span class="org-type">StopIteration</span>
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lax.map { |x| x*x }.map { |x| x+1 }.first(5)
<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lax.map { |x| x*x }.map { |x| x+1 }.take(5).to_a <span class="org-comment-delimiter"># </span><span class="org-comment">&#8593;&#12392;&#32080;&#26524;&#12399;&#21516;&#12376;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd054f2e" class="outline-3">
<h3 id="orgd054f2e"><a href="#orgd054f2e">ex4</a></h3>
<div class="outline-text-3" id="text-orgd054f2e">
<p>
selectのlazy版。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">select</span>(&amp;block)
  <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>) <span class="org-keyword">do</span> |yielder, val|
    <span class="org-keyword">if</span> block.call(val)
      yielder &lt;&lt; val
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lax.take(5).select { |x| x % 2 == 0 }.to_a
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; [2, 4]</span>
</pre>
</div>

<p>
dropのlazy版。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">drop</span>(n)
  dropped = 0
  <span class="org-type">Lax</span>.new(<span class="org-keyword">self</span>) <span class="org-keyword">do</span> |yielder, val|
    <span class="org-keyword">if</span> dropped &lt; n
      dropped += 1
    <span class="org-keyword">else</span>
      yielder &lt;&lt; val
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-builtin">p</span> 1.upto(<span class="org-type">Float</span>::<span class="org-type">INFINITY</span>).lax.take(5).drop(3).to_a
<span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; [4, 5]</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcd19da2" class="outline-2">
<h2 id="orgcd19da2"><a href="#orgcd19da2">Ruby kaigi 2021</a></h2>
<div class="outline-text-2" id="text-orgcd19da2">
</div>
<div id="outline-container-orgc03c931" class="outline-3">
<h3 id="orgc03c931"><a href="#orgc03c931">VSCode extension for ruby type</a></h3>
<div class="outline-text-3" id="text-orgc03c931">
<p>
<a href="https://www.slideshare.net/mametter/typeprof-for-ide-enrich-development-experience-without-annotations">https://www.slideshare.net/mametter/typeprof-for-ide-enrich-development-experience-without-annotations</a>
</p>

<ul class="org-ul">
<li>言語自体を変えなくても、現代的なIDEの恩恵を受けられる。</li>
<li>特に静的型付け言語だと引数の型などを表示できる。</li>
<li id="RBS">ruby official type definition language</li>
<li>型レベルに抽象化して情報を解析する。</li>

<li><a href="https://github.com/usaito">https://github.com/usaito</a> Special Thanksに載ってた人。年下だ…。本物の工学の人。</li>
<li>あまり専門的な内容には触れなかった。</li>
</ul>
</div>
</div>
<div id="outline-container-org0ab3bb4" class="outline-3">
<h3 id="org0ab3bb4"><a href="#org0ab3bb4">Why Ruby&rsquo;s JIT was slow</a></h3>
<div class="outline-text-3" id="text-org0ab3bb4">
<ul class="org-ul">
<li>RubyのJITの状況、高速化。</li>
<li>方式の違い。</li>
</ul>
</div>
</div>
<div id="outline-container-orge2f5618" class="outline-3">
<h3 id="orge2f5618"><a href="#orge2f5618">RuboCop in 2021: Stable and Beyond</a></h3>
<div class="outline-text-3" id="text-orge2f5618">
<ul class="org-ul">
<li>Rubocopの状況。過去、現在、未来。</li>
<li>autocorrectが安全な修正をするように設計。</li>
</ul>
</div>
</div>
<div id="outline-container-orgb0d09a2" class="outline-3">
<h3 id="orgb0d09a2"><a href="#orgb0d09a2">The Art of Execution Control for Ruby&rsquo;s Debugger</a></h3>
<div class="outline-text-3" id="text-orgb0d09a2">
<ul class="org-ul">
<li>歯のメンテナンス</li>
<li>新しいデバッガ: <code>debug.gem</code> Rails7からこれを使うようになるよう</li>
<li>rubyにおけるデバッガーの状況、ツール作った理由、使い方。</li>
<li>gem <code>rdbg</code></li>
<li><code>info</code> コマンド</li>
<li>一部分だけトレースできる。</li>
<li>PostMortem debugging…検死、なぜプログラムが終了したか調べる。</li>
<li>Record and play debug…戻れる。</li>
</ul>
</div>
</div>
<div id="outline-container-orgf72542d" class="outline-3">
<h3 id="orgf72542d"><a href="#orgf72542d">Toycol: Define your own application protocol</a></h3>
<div class="outline-text-3" id="text-orgf72542d">
<ul class="org-ul">
<li>プロトコルの各レイヤーが責任を持つ</li>
<li>プロトコルをサーバとクライアントが知っているものであれば、なんだって通信。自作プロトコルでも。</li>
<li>自作プロトコルの使い方と動作の仕組み</li>
</ul>
</div>
</div>
<div id="outline-container-orgc33923e" class="outline-3">
<h3 id="orgc33923e"><a href="#orgc33923e">dRuby in the real-world embedded systems</a></h3>
<div class="outline-text-3" id="text-orgc33923e">
<ul class="org-ul">
<li>CT装置</li>
<li>胆石</li>
</ul>
</div>
</div>
<div id="outline-container-org12cebe7" class="outline-3">
<h3 id="org12cebe7"><a href="#org12cebe7">Regular Expressions: Amazing and Dangerous</a></h3>
<div class="outline-text-3" id="text-org12cebe7">
<p>
なぜ危険か。
</p>
<ul class="org-ul">
<li><code>+?</code> によって非常に時間がかかる<a href="20210910104106-regular_expression.html#ID-f054b2d4-c7f9-4bf2-be9c-e29a7f97cb45">Regular Expression</a>になる可能性がある。文字列が非常に長い場合、組み合わせ数が爆発的に増えるため。</li>
<li>サービスがダウンすることもある。Stack Overflow, Cloudflare, Atom&#x2026;であったインシデントのいくつか&#x2026;はRubyの<a href="20210910104106-regular_expression.html#ID-f054b2d4-c7f9-4bf2-be9c-e29a7f97cb45">Regular Expression</a>由来のものだった</li>
<li>gemの中から危険な表現が使われているところを検索する。多くヒットした</li>
</ul>

<p>
対策。
</p>
<ul class="org-ul">
<li><code>//x</code> を使う</li>
<li>正規表現のテストを書く。カバレッジは正規表現の中までは見ない…</li>
<li>入力の長さを制限する</li>
</ul>
</div>
</div>
<div id="outline-container-orge80cdc8" class="outline-3">
<h3 id="orge80cdc8"><a href="#orge80cdc8">Demystifying DSLs for better analysis and understanding</a></h3>
<div class="outline-text-3" id="text-orge80cdc8">
<ul class="org-ul">
<li>Domain Specific Language</li>
<li><a href="20210910104106-regular_expression.html#ID-f054b2d4-c7f9-4bf2-be9c-e29a7f97cb45">Regular Expression</a>, Rakefile, RSpec&#x2026;</li>
<li><a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a> provide many DSL</li>
<li>Tapioca gem</li>
<li>generate rbi file from Model</li>
</ul>
</div>
</div>
<div id="outline-container-orgcdf58c6" class="outline-3">
<h3 id="orgcdf58c6"><a href="#orgcdf58c6">The Future Shape of Ruby Objects</a></h3>
<div class="outline-text-3" id="text-orgcdf58c6">
<ul class="org-ul">
<li>Rubyのオブジェクトの実装を見ながら解説。</li>
<li>オブジェクト指向言語<a href="20210910102223-smalltalk.html#ID-2a420174-482b-4a3e-868a-3a447572f1be">Smalltalk</a>のselfオブジェクト</li>
<li>classとshape</li>
<li><a href="20210509100112-javascript.html#ID-a6980e15-ecee-466e-9ea7-2c0210243c0d">JavaScript</a>とかのプロトタイプ言語的アプローチ。</li>
<li><a href="https://github.com/Shopify/truffleruby">Shopify/truffleruby</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgc830815" class="outline-3">
<h3 id="orgc830815"><a href="#orgc830815">PRK Firmware: Keyboard is Essentially Ruby</a></h3>
<div class="outline-text-3" id="text-orgc830815">
<ul class="org-ul">
<li>自作キーボードを制御するfirmwareをRubyで書く</li>
</ul>
</div>
</div>
<div id="outline-container-org08fdb0f" class="outline-3">
<h3 id="org08fdb0f"><a href="#org08fdb0f">The newsletter of RBS updates</a></h3>
<div class="outline-text-3" id="text-org08fdb0f">
<ul class="org-ul">
<li><a href="https://github.com/ruby/rbs">ruby/rbs</a></li>
<li>RBS → Rubyで型を定義するためのDSL</li>
<li>サードパーティgemのRBSコレクションを作成している</li>
<li>Railsに導入する方法</li>
</ul>
</div>
</div>
<div id="outline-container-org0fe34a3" class="outline-3">
<h3 id="org0fe34a3"><a href="#org0fe34a3">Parsing Ruby</a></h3>
<div class="outline-text-3" id="text-org0fe34a3">
<ul class="org-ul">
<li>Rubyの記法の変遷。パーサの変遷</li>
<li>コアに追従することは難しい</li>
<li>少しの文法の変更でも大きな影響範囲がある</li>
<li>少しの変更も拡張が難しい</li>
</ul>
</div>
</div>
<div id="outline-container-org511a8ff" class="outline-3">
<h3 id="org511a8ff"><a href="#org511a8ff">Use Macro all the time ~ マクロを使いまくろ ~</a></h3>
<div class="outline-text-3" id="text-org511a8ff">
<ul class="org-ul">
<li>ASTレベルでRubyコードを置き換える</li>
<li>パッケージの紹介</li>
</ul>
</div>
</div>
<div id="outline-container-orga5f4578" class="outline-3">
<h3 id="orga5f4578"><a href="#orga5f4578">Charty: Statistical data visualization in Ruby</a></h3>
<div class="outline-text-3" id="text-orga5f4578">
<ul class="org-ul">
<li>Rubyでのグラフ描画ツール、charty</li>
<li>パッケージの紹介</li>
</ul>
</div>
</div>
<div id="outline-container-orgf6010d0" class="outline-3">
<h3 id="orgf6010d0"><a href="#orgf6010d0">Dive into Encoding</a></h3>
<div class="outline-text-3" id="text-orgf6010d0">
<ul class="org-ul">
<li>Relineのバグ修正で文字コードを深く知るきっかけ</li>
<li>文字コードを実装して学ぶ</li>
<li>Coded Charcter Set</li>
<li>Character Encoding Scheme</li>
<li>Conversion table</li>
<li>Encoding constant</li>
</ul>
</div>
</div>
<div id="outline-container-org6089449" class="outline-3">
<h3 id="org6089449"><a href="#org6089449">How to develop the Standard Libraries of Ruby</a></h3>
<div class="outline-text-3" id="text-org6089449">
<ul class="org-ul">
<li>標準ライブラリの作り方</li>
<li>gemification - 本体添付からgemに切り離す</li>
<li><a href="https://github.com/rubygems/rubygems">rubygems/rubygems</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd251ec0" class="outline-3">
<h3 id="orgd251ec0"><a href="#orgd251ec0">Ruby, Ractor, QUIC</a></h3>
<div class="outline-text-3" id="text-orgd251ec0">
<ul class="org-ul">
<li>QUICはGoogleによって開発された高速なプロトコル。</li>
<li>クラウドゲーミングでは高速性が必要</li>
<li>TCPとUDPの特性の違い</li>
</ul>
</div>
</div>
<div id="outline-container-org7ba9fca" class="outline-3">
<h3 id="org7ba9fca"><a href="#org7ba9fca">10 years of Ruby-powered citizen science</a></h3>
<div class="outline-text-3" id="text-org7ba9fca">
<ul class="org-ul">
<li><a href="https://github.com/Safecast/safecastapi">Safecast/safecastapi: The app that powers api.safecast.org</a></li>
<li>放射線の観測デバイス</li>
<li>デバイスが送信する観測データを各クラウドにキャストする</li>
<li>Dashboardで加工、アクセスできるようにする</li>
<li>マップ、グラフ、UI/UX、データバリデーション…課題はまだまだある</li>
</ul>
</div>
</div>
<div id="outline-container-org2e03e15" class="outline-3">
<h3 id="org2e03e15"><a href="#org2e03e15">Matz Keynote</a></h3>
<div class="outline-text-3" id="text-org2e03e15">
<ul class="org-ul">
<li>Ruby 3.0</li>
<li>互換性大事</li>
<li>静的型付け言語が流行している。ほかの動的言語にも導入されている。Rubyにはどうか、答えはNo。</li>
<li>言語仕様としては型を実装することはない。周辺ツールで行う</li>
<li>型,LSP,チェッカ,&#x2026;ツールを応援する</li>
<li>パフォーマンスは重要。動機づけになる、問題を解決する</li>
<li>パフォーマンスは評判に直結する</li>
<li>マイクロベンチマーク(素数解析とか、単純な計算をもとにパフォーマンスを示す)は現実世界に影響するか → 実際にはしないけど、人々は信用しがちなので重要ではある</li>
<li id="Ruby3x3">Ruby3.XはRuby3.0より3倍早い</li>
</ul>
</div>
</div>
<div id="outline-container-orgaeff380" class="outline-3">
<h3 id="orgaeff380"><a href="#orgaeff380">Graphical Terminal User Interface of Ruby 3.1</a></h3>
<div class="outline-text-3" id="text-orgaeff380">
<ul class="org-ul">
<li>沢登り</li>
<li>irbに補完機能をつける</li>
</ul>
</div>
</div>
<div id="outline-container-orgefbca4f" class="outline-3">
<h3 id="orgefbca4f"><a href="#orgefbca4f">Ruby Committers vs the World</a></h3>
<div class="outline-text-3" id="text-orgefbca4f">
<ul class="org-ul">
<li>Rubyコミッターの人たちによる座談会</li>
<li>cool</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd53754c" class="outline-2">
<h2 id="orgd53754c"><a href="#orgd53754c">Source code</a></h2>
<div class="outline-text-2" id="text-orgd53754c">
<p>
本体コードで気になったところのメモ。
</p>
</div>
<div id="outline-container-orgb1e0764" class="outline-3">
<h3 id="orgb1e0764"><a href="#orgb1e0764">概要</a></h3>
<div class="outline-text-3" id="text-orgb1e0764">
<ul class="org-ul">
<li>文法規則ファイル parse.y</li>
<li>実際に字句解析する関数 parser_yylex</li>
<li>予約語の一覧 ./defs/keywords</li>
<li>Rubyは<a href="20210911104632-c_language.html#ID-656a0aa4-e5d3-416f-82d5-f909558d0639">C language</a>で用いられるLex字句解析ツールは使用しない。パフォーマンス、特殊なルールが必要だったために字句解析のコードを自前で用意している</li>
<li>字句解析-&gt;(トークン列)-&gt;構文解析-&gt;(ASTノード)-&gt;コンパイル。構文解析の段階でシンタックスチェックを行う</li>
<li>Rubyをビルドする過程で、<a href="20220508115739-bison.html#ID-3466af69-175d-4c59-977a-7b8216514999">Bison</a>という<a href="20220508115155-parser_generator.html#ID-df0c9fc5-2c5c-4026-b451-b8485bbd26cd">parser generator</a>を使ってパーサコードを生成する。Bisonは文法規則ルール(parse.y)からパーサコード(parse.c)を生成する</li>
</ul>
</div>
</div>
<div id="outline-container-orge3744a1" class="outline-3">
<h3 id="orge3744a1"><a href="#orge3744a1">Ripper</a></h3>
<div class="outline-text-3" id="text-orge3744a1">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>字句解析ライブラリRipperによって、ソースコードに対して生成するトークン列を確認できる。[0.コード位置、1.シンボルとして表示したトークン、2.対応したテキスト文字列、3.元の値]。</label><pre class="src src-ruby">  <span class="org-builtin">require</span> <span class="org-string">'ripper'</span>
  <span class="org-builtin">require</span> <span class="org-string">'pp'</span>
  code = <span class="org-string">&lt;&lt;STR</span>
<span class="org-string">10.times do |n|</span>
<span class="org-string">  puts n</span>
<span class="org-string">end</span>
<span class="org-string">STR</span>
  <span class="org-builtin">puts</span> code
  pp <span class="org-type">Ripper</span>.lex(code)
</pre>
</div>

<div class="results" id="org0065fbd">
<p>
10.times do |n|
  puts n
end
[[[1, 0], :on_int, &ldquo;10&rdquo;, END],
 [[1, 2], :on_period, &ldquo;.&rdquo;, DOT],
 [[1, 3], :on_ident, &ldquo;times&rdquo;, ARG],
 [[1, 8], :on_sp, &ldquo; &rdquo;, ARG],
 [[1, 9], :on_kw, &ldquo;do&rdquo;, BEG],
 [[1, 11], :on_sp, &ldquo; &rdquo;, BEG],
 [[1, 12], :on_op, &ldquo;|&rdquo;, BEG|LABEL],
 [[1, 13], :on_ident, &ldquo;n&rdquo;, ARG],
 [[1, 14], :on_op, &ldquo;|&rdquo;, BEG|LABEL],
 [[1, 15], :on_ignored_nl, &ldquo;\n&rdquo;, BEG|LABEL],
 [[2, 0], :on_sp, &ldquo;  &rdquo;, BEG|LABEL],
 [[2, 2], :on_ident, &ldquo;puts&rdquo;, CMDARG],
 [[2, 6], :on_sp, &ldquo; &rdquo;, CMDARG],
 [[2, 7], :on_ident, &ldquo;n&rdquo;, END|LABEL],
 [[2, 8], :on_nl, &ldquo;\n&rdquo;, BEG],
 [[3, 0], :on_kw, &ldquo;end&rdquo;, END],
 [[3, 3], :on_nl, &ldquo;\n&rdquo;, BEG]]
</p>

</div>
</div>
</div>

<div id="outline-container-orge9e9e26" class="outline-3">
<h3 id="orge9e9e26"><a href="#orge9e9e26">attr_accessor</a></h3>
<div class="outline-text-3" id="text-orge9e9e26">
<ul class="org-ul">
<li><a href="https://github.com/kd-collective/ruby/blob/f5829e293583aa6ba6a1f1314ee22881d58a5f96/object.c#L2204">https://github.com/kd-collective/ruby/blob/f5829e293583aa6ba6a1f1314ee22881d58a5f96/object.c#L2204</a></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgebe142d" class="outline-2">
<h2 id="orgebe142d"><a href="#orgebe142d">Tasks</a></h2>
<div class="outline-text-2" id="text-orgebe142d">
</div>
<div id="outline-container-org01fc916" class="outline-3">
<h3 id="org01fc916"><a href="#org01fc916"><span class="todo TODO">TODO</span> <a href="https://gihyo.jp/book/2016/978-4-7741-7802-8">APIデザインケーススタディ ――Rubyの実例から学ぶ。問題に即したデザインと普遍の考え方：書籍案内｜技術評論社</a></a></h3>
<div class="outline-text-3" id="text-org01fc916">
<p>
RubyライブラリをテーマにしたAPI設計の本。
</p>
</div>
</div>
<div id="outline-container-org6232816" class="outline-3">
<h3 id="org6232816"><a href="#org6232816"><span class="todo TODO">TODO</span> Rubyのしくみ: Ruby Under a microscope</a></h3>
<div class="outline-text-3" id="text-org6232816">
<ul class="org-ul">
<li>JavaコードをJVM命令列にコンパイルするように、Rubyコード(ASTノード)をYARV命令列&#x2026;Rubyコードを実行する仮想マシンにコンパイルする
<ul class="org-ul">
<li>コンパイルして、C言語と機械語になる</li>
</ul></li>
<li>RubyVM::InstructionSequence で、Rubyでコードをどうコンパイルするかを確認できる</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>YARVバイトコードを出力する</label><pre class="src src-ruby">code = <span class="org-string">"a = 1+2; a"</span>
<span class="org-type">RubyVM</span>::<span class="org-type">InstructionSequence</span>.compile(code).disasm
</pre>
</div>

<div class="results" id="org862feaa">
<p>
== disasm: #&lt;ISeq:&lt;compiled&gt;@&lt;compiled&gt;:1 (1,0)-(1,10)&gt; (catch: FALSE)
local table (size: 1, argc: 0 [opts: 0, rest: -1, post: 0, block: -1, kw: -1@-1, kwrest: -1])
[ 1] a@0
0000 putobject_INT2FIX_1_                                             (   1)[Li]
0001 putobject                              2
0003 opt_plus                               &lt;calldata!mid:+, argc:1, ARGS_SIMPLE&gt;[CcCr]
0005 setlocal_WC_0                          a@0
0007 getlocal_WC_0                          a@0
0009 leave
</p>

</div>

<p>
計算に必要な1と2をpushしたあと、足し算している。
</p>

<div class="org-src-container">
<pre class="src src-ruby">code = <span class="org-string">"a = 'hello' + 'world'; a"</span>
<span class="org-type">RubyVM</span>::<span class="org-type">InstructionSequence</span>.compile(code).disasm
</pre>
</div>

<div class="results" id="org5a0876b">
<p>
== disasm: #&lt;ISeq:&lt;compiled&gt;@&lt;compiled&gt;:1 (1,0)-(1,24)&gt; (catch: FALSE)
local table (size: 1, argc: 0 [opts: 0, rest: -1, post: 0, block: -1, kw: -1@-1, kwrest: -1])
[ 1] a@0
0000 putstring                              &ldquo;hello&rdquo;                   (   1)[Li]
0002 putstring                              &ldquo;world&rdquo;
0004 opt_plus                               &lt;calldata!mid:+, argc:1, ARGS_SIMPLE&gt;[CcCr]
0006 setlocal_WC_0                          a@0
0008 getlocal_WC_0                          a@0
0010 leave
</p>

</div>

<p>
文字列でも同様。
</p>

<div class="org-src-container">
<pre class="src src-ruby">code = <span class="org-string">"a=[1, 2, 3]; a[0]=100;"</span>
<span class="org-type">RubyVM</span>::<span class="org-type">InstructionSequence</span>.compile(code).disasm
</pre>
</div>

<div class="results" id="org9b1a8c1">
<p>
== disasm: #&lt;ISeq:&lt;compiled&gt;@&lt;compiled&gt;:1 (1,0)-(1,22)&gt; (catch: FALSE)
local table (size: 1, argc: 0 [opts: 0, rest: -1, post: 0, block: -1, kw: -1@-1, kwrest: -1])
[ 1] a@0
0000 duparray                               [1, 2, 3]                 (   1)[Li]
0002 setlocal_WC_0                          a@0
0004 putnil
0005 getlocal_WC_0                          a@0
0007 putobject_INT2FIX_0_
0008 putobject                              100
0010 setn                                   3
0012 opt_aset                               &lt;calldata!mid:[]=, argc:2, ARGS_SIMPLE&gt;[CcCr]
0014 pop
0015 leave
</p>

</div>
</div>
</div>

<div id="outline-container-orgb3bc047" class="outline-3">
<h3 id="orgb3bc047"><a href="#orgb3bc047"><span class="todo TODO">TODO</span> Refactoring: Rubyエディション</a></h3>
<div class="outline-text-3" id="text-orgb3bc047">
</div>
</div>
<div id="outline-container-org3b343fb" class="outline-3">
<h3 id="org3b343fb"><a href="#org3b343fb"><span class="todo TODO">TODO</span> <a href="https://danieljamescolson.com/blog/meta-factory">Metaprogramming All The Way Down</a></a></h3>
<div class="outline-text-3" id="text-org3b343fb">
<p>
FactoryBotの詳細な説明。
</p>
</div>
</div>
<div id="outline-container-org88f1d4e" class="outline-3">
<h3 id="org88f1d4e"><a href="#org88f1d4e"><span class="todo TODO">TODO</span> <a href="https://docs.ruby-lang.org/ja/latest/method/Enumerable/i/inject.html">Enumerable#inject (Ruby 3.0.0 リファレンスマニュアル)</a></a></h3>
<div class="outline-text-3" id="text-org88f1d4e">
<p>
使えるようにしておく。まとめる。
</p>
</div>
</div>
<div id="outline-container-org19c11c7" class="outline-3">
<h3 id="org19c11c7"><a href="#org19c11c7"><span class="todo TODO">TODO</span> <a href="http://ruby-operators.herokuapp.com/rose_memoization">Ruby Operators</a></a></h3>
<div class="outline-text-3" id="text-org19c11c7">
<p>
Rubyの特殊な演算子の名前と説明。
</p>
</div>
</div>
<div id="outline-container-org8d6de67" class="outline-3">
<h3 id="org8d6de67"><a href="#org8d6de67"><span class="todo TODO">TODO</span> Practical Ruby Project</a></h3>
<div class="outline-text-3" id="text-org8d6de67">
<ul class="org-ul">
<li>254, 265, 272, 283</li>
</ul>

<p>
Rubyでのちょっと変わった、面白いプロジェクトを紹介している。
</p>
<ul class="org-ul">
<li>経済ゲームを作る</li>
<li>Lispを実装</li>
<li>パーサを実装</li>
</ul>
</div>
</div>
<div id="outline-container-orgd16f637" class="outline-3">
<h3 id="orgd16f637"><a href="#orgd16f637"><span class="todo TODO">TODO</span> <a href="https://magazine.rubyist.net/articles/0061/0061-ForeWord.html">0061号 コンピュータサイエンスが気になるプログラマに勧める書籍リスト</a></a></h3>
<div class="outline-text-3" id="text-orgd16f637">
<p>
書籍リスト。
</p>
</div>
</div>
<div id="outline-container-org6618cd3" class="outline-3">
<h3 id="org6618cd3"><a href="#org6618cd3"><span class="todo TODO">TODO</span> <a href="https://i.loveruby.net/ja/rhg/book/">Rubyソースコード完全解説</a></a></h3>
<div class="outline-text-3" id="text-org6618cd3">
<p>
Rubyのコードの解説。
</p>
</div>
</div>
</div>
<div id="outline-container-org3370a7f" class="outline-2">
<h2 id="org3370a7f"><a href="#org3370a7f">Archives</a></h2>
<div class="outline-text-2" id="text-org3370a7f">
</div>
<div id="outline-container-org7f66083" class="outline-3">
<h3 id="org7f66083"><a href="#org7f66083"><span class="done DONE">DONE</span> The well-grounded rubyist <code>[100%]</code></a></h3>
<div class="outline-text-3" id="text-org7f66083">
</div>
<div id="outline-container-org751cdce" class="outline-4">
<h4 id="org751cdce"><a href="#org751cdce"><span class="done DONE">DONE</span> 420</a></h4>
<div class="outline-text-4" id="text-org751cdce">
</div>
</div>
<div id="outline-container-org1b1a8ba" class="outline-4">
<h4 id="org1b1a8ba"><a href="#org1b1a8ba"><span class="done DONE">DONE</span> 430</a></h4>
<div class="outline-text-4" id="text-org1b1a8ba">
</div>
</div>
<div id="outline-container-org4b6f437" class="outline-4">
<h4 id="org4b6f437"><a href="#org4b6f437"><span class="done DONE">DONE</span> 440</a></h4>
<div class="outline-text-4" id="text-org4b6f437">
</div>
</div>
<div id="outline-container-org7a5165d" class="outline-4">
<h4 id="org7a5165d"><a href="#org7a5165d"><span class="done DONE">DONE</span> 450</a></h4>
<div class="outline-text-4" id="text-org7a5165d">
<p>

</p>
</div>
</div>
<div id="outline-container-orge7d14f3" class="outline-4">
<h4 id="orge7d14f3"><a href="#orge7d14f3"><span class="done DONE">DONE</span> 460</a></h4>
<div class="outline-text-4" id="text-orge7d14f3">
<p>

</p>
</div>
</div>
<div id="outline-container-orgcbda5be" class="outline-4">
<h4 id="orgcbda5be"><a href="#orgcbda5be"><span class="done DONE">DONE</span> 470</a></h4>
<div class="outline-text-4" id="text-orgcbda5be">
<p>

</p>
</div>
</div>
<div id="outline-container-orgd21e80f" class="outline-4">
<h4 id="orgd21e80f"><a href="#orgd21e80f"><span class="done DONE">DONE</span> 480</a></h4>
<div class="outline-text-4" id="text-orgd21e80f">
<p>

</p>
</div>
</div>
<div id="outline-container-orgd55da5b" class="outline-4">
<h4 id="orgd55da5b"><a href="#orgd55da5b"><span class="done DONE">DONE</span> 490</a></h4>
<div class="outline-text-4" id="text-orgd55da5b">
<p>

</p>
</div>
</div>
</div>
<div id="outline-container-orgc517757" class="outline-3">
<h3 id="orgc517757"><a href="#orgc517757"><span class="done CLOSE">CLOSE</span> 見てみるgemを選ぶ</a></h3>
<div class="outline-text-3" id="text-orgc517757">
<p>
まず探すのが大変なので、読んでみるgemを選ぶ。
手軽にできるのが良い。
</p>

<p>
曖昧なタスクなのでcloseする。
</p>
</div>
</div>
<div id="outline-container-orga36291e" class="outline-3">
<h3 id="orga36291e"><a href="#orga36291e"><span class="done DONE">DONE</span> Rubyの公式リファレンスが読めるようになる本</a></h3>
<div class="outline-text-3" id="text-orga36291e">
<ul class="org-ul">
<li><a href="https://zenn.dev/jnchito/books/how-to-read-ruby-reference">https://zenn.dev/jnchito/books/how-to-read-ruby-reference</a></li>
</ul>
</div>
</div>
<div id="outline-container-org2391e13" class="outline-3">
<h3 id="org2391e13"><a href="#org2391e13"><span class="done CLOSE">CLOSE</span> おみくじ作り</a></h3>
<div class="outline-text-3" id="text-org2391e13">
<p>
Ruby上で<a href="20210911183844-lisp.html#ID-18fbe00f-4ec8-4ca0-adfa-2d1381669642">LISP</a>を実装しておみくじを作ってみる。
</p>

<p>
funcallを実装しようとして詰まる。単純な例だとできるようになったが、ネストしたときにうまく動いてない。
テストをちゃんと書くことと、デバッグ方法をちゃんとしないと厳しい。
</p>

<p>
1週間でできそうということではじめたが、時間がかかるので後回し。
言語実装に取り組むのはもっとも抽象的で難しい。だが無限の可能性を持っていてめちゃくちゃ楽しい。
もっとも難しいことをしたおかげで、ほかのことに自信をもって取り組みやすくなったように思える。ほとんどのことは言語を実装することに比べれば、簡単だ。
</p>
</div>
</div>
<div id="outline-container-org088a122" class="outline-3">
<h3 id="org088a122"><a href="#org088a122"><span class="done DONE">DONE</span> 誤字修正</a></h3>
<div class="outline-text-3" id="text-org088a122">
<p>
るりまの誤字を発見した。いくつか発見してまとめてPRを送ろう。
</p>

<ul class="org-ul">
<li>同じにように(Proc)</li>
</ul>
</div>
</div>
<div id="outline-container-org78b86a0" class="outline-3">
<h3 id="org78b86a0"><a href="#org78b86a0"><span class="done DONE">DONE</span> <a href="https://softantenna.com/blog/gem-codesearch/">gem-codesearch – rubygemsをフルテキストサーチすることができる豪快なソフト | ソフトアンテナ</a></a></h3>
<div class="outline-text-3" id="text-org78b86a0">
<p>
面白そう。
</p>
</div>
</div>
<div id="outline-container-org5e4eb18" class="outline-3">
<h3 id="org5e4eb18"><a href="#org5e4eb18"><span class="done DONE">DONE</span> <a href="https://techracho.bpsinc.jp/hachi8833/2020_11_06/59639">Ruby: eachよりもmapなどのコレクションを積極的に使おう（社内勉強会）｜TechRacho by BPS株式会社</a></a></h3>
<div class="outline-text-3" id="text-org5e4eb18">
</div>
</div>
<div id="outline-container-orgdf1d757" class="outline-3">
<h3 id="orgdf1d757"><a href="#orgdf1d757"><span class="done CLOSE">CLOSE</span> rubocop issue(allow multiline)</a></h3>
<div class="outline-text-3" id="text-orgdf1d757">
<p>
<a href="https://github.com/rubocop/rubocop/issues/9365">https://github.com/rubocop/rubocop/issues/9365</a>
どうにかなりそうではある。コメントルールをマルチラインに対応させる。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-comment-delimiter"># </span><span class="org-comment">&#12371;&#12428;&#12399;&#26908;&#30693;&#12373;&#12428;&#12427;</span>
foo(
  <span class="org-comment-delimiter"># </span><span class="org-comment">aaaa</span>

  22
)

<span class="org-comment-delimiter"># </span><span class="org-comment">&#12371;&#12428;&#12399;&#12475;&#12540;&#12501;&#12290;&#12371;&#12428;&#12391;&#38291;&#12395;&#21512;&#12358;&#12424;&#12358;&#12395;&#24863;&#12376;&#12427;&#12290;</span>
foo(
  <span class="org-comment-delimiter"># </span><span class="org-comment">bbbb</span>
  22
)
</pre>
</div>

<p>
コメントのあとは空白行を無視したいらしいが、あまり意味を感じない。実装はできるが、目的があまりよくないように思える。
</p>
</div>
</div>
<div id="outline-container-org4d4e71d" class="outline-3">
<h3 id="org4d4e71d"><a href="#org4d4e71d"><span class="done CLOSE">CLOSE</span> rubocop issue(yoda expression)</a></h3>
<div class="outline-text-3" id="text-org4d4e71d">
<p>
<a href="https://github.com/rubocop/rubocop/issues/9222">https://github.com/rubocop/rubocop/issues/9222</a>
New cop for yoda expressions.
</p>

<p>
TSLintにすでにあるので、実装の参考にすればいい。
<a href="https://palantir.github.io/tslint/rules/binary-expression-operand-order/">Rule: binary-expression-operand-order</a>
</p>

<dl class="org-dl">
<dt>二項演算子(Binary Operator)</dt><dd>式を書いたときに、被演算子（変数とか値）が2つ登場する演算子</dd>
</dl>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">on_send</span>(node)
  method = node.method_name
  lhs = node.receiver
  rhs = node.first_argument

  <span class="org-comment-delimiter"># </span><span class="org-comment">a.+(b)</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">a -&gt; lhs</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">+ -&gt; method</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">b -&gt; rhs</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
conditionの方と合体させてもよさそう。TSLintはそうしてる。共通しているところは多い。全く別のcopにする方針で一応書けたが、本質的にcondition operatorとやってることは同じだ。
</p>

<p>
方式が違うので難しいな。明らかにTSLintのやり方が簡潔に書かれているように見える。rubocopの方はゴテゴテと条件が多い。単に対応オペレータを増やすだけだが、よくわからない。conditionを前提に書かれているところも難しい。
</p>

<p>
ちょっとやってどうにかなるものでなさそう。追加されないのには、理由があった。まず既存のがごちゃついてるので、それを整理する必要がある。
</p>
</div>
</div>
</div>
<div id="outline-container-orgfa06791" class="outline-2">
<h2 id="orgfa06791"><a href="#orgfa06791">References</a></h2>
<div class="outline-text-2" id="text-orgfa06791">
</div>
<div id="outline-container-orgdedad65" class="outline-3">
<h3 id="orgdedad65"><a href="#orgdedad65"><a href="https://rurema.clear-code.com/3.0.0/doc/glossary.html">Ruby用語集 (Ruby 3.0.0)</a></a></h3>
<div class="outline-text-3" id="text-orgdedad65">
<p>
おもしろい。
</p>
</div>
</div>
<div id="outline-container-orgf0806ce" class="outline-3">
<h3 id="orgf0806ce"><a href="#orgf0806ce"><a href="http://franzejr.github.io/best-ruby/">Introduction | Ruby Tricks, Idiomatic Ruby, Refactorings and Best Practices</a></a></h3>
<div class="outline-text-3" id="text-orgf0806ce">
<p>
Rubyのベストプラクティス集。
</p>
</div>
</div>
<div id="outline-container-orgeeaf45a" class="outline-3">
<h3 id="orgeeaf45a"><a href="#orgeeaf45a"><a href="https://practicingruby.com/articles/building-enumerable-and-enumerator">Building Enumerable &amp; Enumerator in Ruby</a></a></h3>
<div class="outline-text-3" id="text-orgeeaf45a">
<p>
Enumerableの詳しい解説。
</p>
</div>
</div>
<div id="outline-container-orgfb471be" class="outline-3">
<h3 id="orgfb471be"><a href="#orgfb471be"><a href="https://blog.freedom-man.com/try-rubygem-codereading">RubyGemコードリーディングのすすめ</a></a></h3>
</div>
<div id="outline-container-org9c35568" class="outline-3">
<h3 id="org9c35568"><a href="#org9c35568"><a href="http://www.aoky.net/articles/why_poignant_guide_to_ruby/index.html">ホワイの(感動的)Rubyガイド</a></a></h3>
<div class="outline-text-3" id="text-org9c35568">
<p>
ちょっと変わったRuby入門。
</p>
</div>
</div>
<div id="outline-container-org329bf6d" class="outline-3">
<h3 id="org329bf6d"><a href="#org329bf6d"><a href="https://docs.ruby-lang.org/ja/">プログラミング言語 Ruby リファレンスマニュアル</a></a></h3>
<div class="outline-text-3" id="text-org329bf6d">
<p>
rubyのドキュメント。
</p>
</div>
</div>
<div id="outline-container-orgf24a620" class="outline-3">
<h3 id="orgf24a620"><a href="#orgf24a620"><a href="https://rubular.com/">Rubular: a Ruby regular expression editor</a></a></h3>
<div class="outline-text-3" id="text-orgf24a620">
<p>
Rubyの正規表現チェッカ。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
