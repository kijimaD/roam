<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-04-28 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 138: Goプロファイラの使いかた</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 138: Goプロファイラの使いかた</h1>

<div id="outline-container-org032e2d5" class="outline-2">
<h2 id="org032e2d5"><a href="#org032e2d5">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-org032e2d5">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-04-28 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="off"><input type='checkbox' /> &lt;署名&gt;</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orge2e30b0" class="outline-2">
<h2 id="orge2e30b0"><a href="#orge2e30b0">概要</a></h2>
<div class="outline-text-2" id="text-orge2e30b0">
<p>
Goのプロファイラ、 <code>pprof</code> を使う手順を書く。
</p>
</div>
</div>

<div id="outline-container-org33eb7dc" class="outline-2">
<h2 id="org33eb7dc"><a href="#org33eb7dc">背景</a></h2>
<div class="outline-text-2" id="text-org33eb7dc">
<p>
<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>でゲーム開発する過程で、いつのまにかメモリリークしていたのを発見した。原因を探るために、プロファイラを使って原因箇所を特定できた。強力な調査方法なので、また使えるようにメモしておく。
</p>
</div>
</div>

<div id="outline-container-orgcdf6402" class="outline-2">
<h2 id="orgcdf6402"><a href="#orgcdf6402">手順</a></h2>
<div class="outline-text-2" id="text-orgcdf6402">
<p>
<code>pprof</code> の起動や取得方法にはいくつかの組み合わせがある。組み合わせる自由度が高いのがよいが、ややとっつきづらい。もっともシンプルに見える組み合わせだけを書く。
</p>
</div>

<div id="outline-container-org200ef04" class="outline-3">
<h3 id="org200ef04"><a href="#org200ef04">1. コードにプロファイラを埋め込む</a></h3>
<div class="outline-text-3" id="text-org200ef04">
<p>
無名インポートすることで、デフォルトサーバにプロファイラのエンドポイントが追加される。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>無名インポートとサーバの起動</label><pre class="src src-go">package main
import _ "net/http/pprof"

func main() {
        _ = http.ListenAndServe("localhost:6060", nil)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb063c4c" class="outline-3">
<h3 id="orgb063c4c"><a href="#orgb063c4c">2. 実行する</a></h3>
<div class="outline-text-3" id="text-orgb063c4c">
<p>
埋め込んだコードをコンパイルして実行すると、↓のようなパスにアクセスしてプロファイルを取得できるようになる。
</p>

<ul class="org-ul">
<li><a href="http://localhost:6060/debug/pprof/">http://localhost:6060/debug/pprof/</a>
<ul class="org-ul">
<li><a href="http://localhost:6060/debug/pprof/allocs?debug=1">http://localhost:6060/debug/pprof/allocs?debug=1</a></li>
<li><a href="http://localhost:6060/debug/pprof/block?debug=1">http://localhost:6060/debug/pprof/block?debug=1</a></li>
<li><a href="http://localhost:6060/debug/pprof/cmdline?debug=1">http://localhost:6060/debug/pprof/cmdline?debug=1</a></li>
<li><a href="http://localhost:6060/debug/pprof/goroutine?debug=1">http://localhost:6060/debug/pprof/goroutine?debug=1</a></li>
<li><a href="http://localhost:6060/debug/pprof/heap?debug=1">http://localhost:6060/debug/pprof/heap?debug=1</a></li>
<li><a href="http://localhost:6060/debug/pprof/mutex?debug=1">http://localhost:6060/debug/pprof/mutex?debug=1</a></li>
<li><a href="http://localhost:6060/debug/pprof/profile?debug=1">http://localhost:6060/debug/pprof/profile?debug=1</a></li>
<li><a href="http://localhost:6060/debug/pprof/threadcreate?debug=1">http://localhost:6060/debug/pprof/threadcreate?debug=1</a></li>
</ul></li>
</ul>

<pre class="example">
heap profile: 51: 49689536 [177: 61751432] @ heap/8192
4: 21135360 [4: 21135360] @ 0x76ba45 0x86a96f 0x8b24e5 0x8b1fa5 0x8b1e2f 0x8bbba8 0x8bf9d2 0x913465 0x7578fd 0x757b4e 0x75423b 0x9132b0 0x913294 0x913c8d 0x4423db 0x475481
#	0x76ba44	image.NewAlpha+0x64								/usr/local/go/src/image/image.go:711
#	0x86a96e	github.com/golang/freetype/truetype.NewFace+0x38e				/home/orange/go/pkg/mod/github.com/golang/freetype@v0.0.0-20170609003504-e2365dfdc4a0/truetype/face.go:206
#	0x8b24e4	github.com/kijimaD/ruins/lib/engine/loader.processTextData+0x1a4		/home/orange/Project/ruins/lib/engine/loader/entity.go:231
#	0x8b1fa4	github.com/kijimaD/ruins/lib/engine/loader.processComponentsListData+0x84	/home/orange/Project/ruins/lib/engine/loader/entity.go:110
#	0x8b1e2e	github.com/kijimaD/ruins/lib/engine/loader.LoadEngineComponents+0x20e		/home/orange/Project/ruins/lib/engine/loader/entity.go:101
#	0x8bbba7	github.com/kijimaD/ruins/lib/loader.PreloadEntities+0xe7			/home/orange/Project/ruins/lib/loader/loader.go:49
#	0x8bf9d1	github.com/kijimaD/ruins/lib/game.InitWorld+0x471				/home/orange/Project/ruins/lib/game/game.go:97
#	0x913464	github.com/kijimaD/ruins/lib/cmd.runPlay+0x124					/home/orange/Project/ruins/lib/cmd/play.go:43
#	0x7578fc	github.com/urfave/cli/v2.(*Command).Run+0x9dc					/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/command.go:279
#	0x757b4d	github.com/urfave/cli/v2.(*Command).Run+0xc2d					/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/command.go:272
#	0x75423a	github.com/urfave/cli/v2.(*App).RunContext+0x5da				/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/app.go:337
#	0x9132af	github.com/urfave/cli/v2.(*App).Run+0x2f					/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/app.go:311
#	0x913293	github.com/kijimaD/ruins/lib/cmd.RunMainApp+0x13				/home/orange/Project/ruins/lib/cmd/cmd.go:39
#	0x913c8c	main.main+0x2c									/home/orange/Project/ruins/main.go:19
#	0x4423da	runtime.main+0x2ba
</pre>
</div>
</div>

<div id="outline-container-org694d77c" class="outline-3">
<h3 id="org694d77c"><a href="#org694d77c">3. プロファイルを収集する</a></h3>
<div class="outline-text-3" id="text-org694d77c">
<p>
生のプロファイルは人が見るものではない。 <code>pprof</code> の収集コマンドを実行して可視化する。よくわからないポイントだが、起動中のコマンドと同じバイナリが必要。このバイナリからコード位置などの情報を取得しているのだろうか。
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">&#12499;&#12523;&#12489;</span>
$ go build . -o aaaa
<span class="org-comment-delimiter"># </span><span class="org-comment">&#12503;&#12525;&#12501;&#12449;&#12452;&#12523;&#21454;&#38598;&#12434;&#23455;&#34892;&#12377;&#12427;</span>
$ go tool pprof aaaa <span class="org-string">"http://localhost:6060/debug/pprof/profile?seconds=10"</span>
</pre>
</div>

<p>
↑例では10秒間、起動中のコマンドから情報を収集する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>実行結果</label><pre class="src src-shell">Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?<span class="org-variable-name">seconds</span>=10
Saved profile<span class="org-keyword"> in</span> /home/orange/pprof/pprof.ruins.samples.cpu.008.pb.gz
File: ruins
Build ID: ab4fa2d3d6018e82aed20efe4b4d08193ee45510
Type: cpu
Time: Apr 27, 2024 at 4:00pm (JST)
Duration: 10.16s, Total samples = 1.64s (16.15%)
Entering interactive mode (<span class="org-builtin">type</span> <span class="org-string">"help"</span> for commands, <span class="org-string">"o"</span> for options)
(pprof) <span class="org-comment-delimiter"># </span><span class="org-comment">&#128072;&#12503;&#12525;&#12531;&#12503;&#12488;</span>
</pre>
</div>

<p>
10秒間待って、 <code>pprof</code> のプロンプトが出れば成功。入力待ちになる。オプションによっては、ここでグラフ画像で表示できたりする。
</p>
</div>
</div>

<div id="outline-container-orge3f74de" class="outline-3">
<h3 id="orge3f74de"><a href="#orge3f74de">4. プロファイルを見る</a></h3>
<div class="outline-text-3" id="text-orge3f74de">
<p>
<code>pprof</code> プロンプトが出ている状態で、コマンドを実行して結果を得る。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>大きい順に表示する</label><pre class="src src-shell">  (pprof) top
Showing nodes accounting for 1070ms, 65.24% of 1640ms total
Showing top 10 nodes out of 236
      flat  flat%   sum%        cum   cum%
     520ms 31.71% 31.71%      560ms 34.15%  runtime.cgocall
     320ms 19.51% 51.22%      320ms 19.51%  runtime.futex
      30ms  1.83% 53.05%       30ms  1.83%  github.com/golang/freetype/truetype.(*Font).scale (inline)
      30ms  1.83% 54.88%      130ms  7.93%  github.com/golang/freetype/truetype.(*GlyphBuf).Load
      30ms  1.83% 56.71%      120ms  7.32%  github.com/hajimehoshi/ebiten/v2/internal/atlas.(*Image).drawTriangles
      30ms  1.83% 58.54%       30ms  1.83%  github.com/hajimehoshi/ebiten/v2/internal/shaderir.(*Program).FilterUniformVariables
      30ms  1.83% 60.37%      240ms 14.63%  runtime.findRunnable
      30ms  1.83% 62.20%       30ms  1.83%  runtime.pMask.read (inline)
      30ms  1.83% 64.02%       30ms  1.83%  runtime/internal/syscall.Syscall6
      20ms  1.22% 65.24%       20ms  1.22%  github.com/golang/freetype/truetype.(*GlyphBuf).loadSimple
</pre>
</div>

<p>
これによって、コードのどの部分でリソースを消費しているかがわかる。
</p>
</div>
</div>
</div>

<div id="outline-container-org7c8361d" class="outline-2">
<h2 id="org7c8361d"><a href="#org7c8361d">関連</a></h2>
<div class="outline-text-2" id="text-org7c8361d">
<ul class="org-ul">
<li><a href="20240420T224401--kdoc-137-簡単にプロセスの使用メモリを確認する__code.html#ID-20240420T224401">KDOC 137: 簡単にプロセスの使用メモリを確認する</a>。で確かにリークしていることをざっくり調べた。さらに原因を絞る</li>
<li><a href="20231128T074518--kdoc-59-ecsを使ってサンプルゲームを作る__memo.html#ID-20231128T074518">KDOC 59: ECSを使ってサンプルゲームを作る</a>。の過程で調べるのに使った</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
