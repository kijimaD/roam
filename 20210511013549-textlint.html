<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-02-03 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TextLint</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">TextLint</h1>
<div id="outline-container-org5cd7d92" class="outline-2">
<h2 id="org5cd7d92"><a href="#org5cd7d92">概要</a></h2>
<div class="outline-text-2" id="text-org5cd7d92">
<p>
textlintは自然言語用の<a href="20211107104950-linter.html#ID-e5663529-8095-4fc8-8fb5-500dd4471a73">lint</a>の1つ。<a href="20210509100112-javascript.html#ID-a6980e15-ecee-466e-9ea7-2c0210243c0d">JavaScript</a>で書かれている。
<a href="https://github.com/textlint/textlint">https://github.com/textlint/textlint</a>
</p>

<p>
文章を読みやすくするためのルールが充実している。たとえば一文が〜文字以上だとエラーが出るとか、主語の「が」が連続してはいけないとか、「、」はいくつまでにしないといけないとか。表記ゆれ検知の設定もできる。プロジェクトでドキュメントの質を保たせることはもちろん、個人の文章の練習にも使える。プログラミング言語でそうなっていくように、見やすい文章がエラーなしで書けるようになってくる。最初はイライラさせられるが。
</p>
</div>
</div>
<div id="outline-container-org85b071c" class="outline-2">
<h2 id="org85b071c"><a href="#org85b071c">Memo</a></h2>
<div class="outline-text-2" id="text-org85b071c">
</div>
<div id="outline-container-orgf47a75c" class="outline-3">
<h3 id="orgf47a75c"><a href="#orgf47a75c">しくみ: AST変換</a></h3>
<div class="outline-text-3" id="text-orgf47a75c">
<p>
<a href="https://azu.github.io/JavaScript-Plugin-Architecture/JavaScript-Plugin-Architecture.pdf">https://azu.github.io/JavaScript-Plugin-Architecture/JavaScript-Plugin-Architecture.pdf</a>
</p>
<ul class="org-ul">
<li>lintは直に文字列を比較しているわけではない。ASTを比較してる。確かに文字列比較している箇所はなかった。</li>
</ul>

<div class="org-src-container">
<pre class="src src-emacs-lisp">const ast = parse(code)<span class="org-comment-delimiter">;</span>
</pre>
</div>
<p>
の部分だ。ルールではなく、ASTのparseをorgに対応させる。それくらいすでにありそうだけどな。
</p>

<blockquote>
<p>
ルールの実装の方を見てみると、直接オブジェクトをexportしないで、
contextとしてRuleContextのインスタンスを受け取っていることが分かると思
います。
</p>
</blockquote>

<div class="org-src-container">
<pre class="src src-js">module.exports = {
    meta: { <span class="org-comment-delimiter">/* </span><span class="org-comment">&#12523;&#12540;&#12523;&#12398;&#12513;&#12479;&#24773;&#22577;</span><span class="org-comment-delimiter"> */</span> },
    <span class="org-function-name">create</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">context</span>) {
        <span class="org-keyword">return</span> {
            <span class="org-string">"MemberExpression"</span>: <span class="org-keyword">function</span> (<span class="org-variable-name">node</span>) {
                <span class="org-keyword">if</span> (node.object.name === <span class="org-string">"console"</span>) {
                    context.report({
                        node,
                        message: <span class="org-string">"Unexpected console statement."</span>
                    });
                }
            }
        };
    }
};
</pre>
</div>

<blockquote>
<p>
このようにして、ルールは context という与えられたものだけを使うので、ルー
ルがMyLinter本体の実装の詳細を知らなくても良くなります。
</p>
</blockquote>

<blockquote>
<p>
このプラグインアーキテクチャはPub/Subパターンを上手く使い、 ESLintのよ
うに与えられたコードを読み取ってチェックするような使い方に向いています。
</p>
</blockquote>

<ul class="org-ul">
<li>read向け。writeは競合変更などに対応しにくい。</li>
<li>走査が1回なので性能がよい</li>
</ul>
</div>
</div>
<div id="outline-container-orgb9188cc" class="outline-3">
<h3 id="orgb9188cc"><a href="#orgb9188cc">plugin-org</a></h3>
<div class="outline-text-3" id="text-orgb9188cc">
<p>
作成した。
単にテキストからのAST変換…構文解析してオブジェクトに変換する…の部分ができればすべてうまくいくはずだ。
</p>

<p>
ああ、すでにある、思ってcloneして動かしてみる…動かない…4年前のWIPだった。
1コミットだけのをフォークしてしまった。
実行・テスト何もできない状態。importすらできず、地獄。
それでも1からやるよりはマシだった可能性はある…ほぼサンプルのコピペはされてたので。
</p>

<p>
type: &ldquo;module&rdquo;にすればよいとの意見多数だったが、依存パッケージが壊れるのでできなかった。
コンパイルすることに。babel。バージョンの違いで苦しみ、なんとかすべて最新の状態に(自分のグローバルインストールのnodeなんかも超古かった)。
</p>

<p>
そして…とりあえず単体で動くように。本体のtext-lintの中では動かないが、とりあえずプラグイン認識はしてくれてる。
どこが悪いのか判別つかないのでとりあえず単体テストをやる。
テストもめちゃくちゃで、とりあえず全部消してコンパイル設定とかやって一応動きはするように。
</p>

<p>
無テストでCIだけ立ち上げる。今までの困難とは裏腹に成功。
パッケージ管理メンドいけど、こういうところがメリットだとわかる。
</p>
</div>
</div>
<div id="outline-container-org827bb8a" class="outline-3">
<h3 id="org827bb8a"><a href="#org827bb8a">htmlのASTとの比較</a></h3>
<div class="outline-text-3" id="text-org827bb8a">
<p>
html-to-astとorgaの出力の比較。
けっこう違うな。
</p>

<div class="org-src-container">
<pre class="src src-json">{
    type: 'Document',
    children: [
        {
            type: 'Html',
            tagName: 'h2',
            properties: {},
            children: [Array],
            loc: [Object],
            range: [Array],
            raw: '&lt;h2&gt;hello&lt;/h2&gt;'
        },
        type: 'UNKNOWN'
    ],
    loc: { start: { line: 1, column: 0 }, end: { line: 1, column: 14 } },
    range: [ 0, 14 ],
    raw: '&lt;h2&gt;hello&lt;/h2&gt;'
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-json">s&lt;ref *1&gt; {
  type: 'document',
  properties: {},
  children: [
    {
      type: 'paragraph',
      children: [Array],
      attributes: {},
      position: [Object],
      parent: [Circular *1]
    }
  ],
  position: { start: { line: 1, column: 1 }, end: { line: 1, column: 13 } }
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org472c8cc" class="outline-3">
<h3 id="org472c8cc"><a href="#org472c8cc">Converting circular structure to JSON</a></h3>
<div class="outline-text-3" id="text-org472c8cc">
<p>
循環参照が含まれているのがだめらしい。
↑でいうとparent: [Circular *1]のところか。
</p>

<p>
Note how [Circular ~] shows the path to the referenced object.
なるほど。
</p>
</div>
</div>
<div id="outline-container-org3f00dc7" class="outline-3">
<h3 id="org3f00dc7"><a href="#org3f00dc7">power-assertの出力がかっこいい</a></h3>
<div class="outline-text-3" id="text-org3f00dc7">
<p>
テストの出力がかっこいい。わかりやすいし。
power-assert
<a href="https://github.com/power-assert-js/power-assert">https://github.com/power-assert-js/power-assert</a>
</p>

<pre class="example">
1) Array #indexOf() should return index when the value is present:
   AssertionError: # path/to/test/mocha_node.js:10

assert(ary.indexOf(zero) === two)
       |   |       |     |   |
       |   |       |     |   2
       |   -1      0     false
       [1,2,3]

[number] two
=&gt; 2
[number] ary.indexOf(zero)
=&gt; -1
</pre>

<pre class="example">
OrgProcessor-test
  #parse
    ✓ should return AST
    ✓ begin_src should CodeBlock
    ✓ text should Paragraph
    ✓ begin_comment should block
    ✓ ~~ should text.code
  OrgPlugin
    when target file is a Org
      ✓ should report lint error
      ✓ should not comma check inside the code block.
</pre>
</div>
</div>
<div id="outline-container-org0ea4131" class="outline-3">
<h3 id="org0ea4131"><a href="#org0ea4131">マッピング</a></h3>
<div class="outline-text-3" id="text-org0ea4131">
<p>
<code>* header</code>
はorgaだと(section) =&gt; (star) + (headline) みたいになる。
だから1階層下ってheadlineにマッピングしてやる必要がある。
</p>
</div>
</div>
</div>
<div id="outline-container-orgafa5fe5" class="outline-2">
<h2 id="orgafa5fe5"><a href="#orgafa5fe5">textlint-plugin-org</a></h2>
<div class="outline-text-2" id="text-orgafa5fe5">
<p>
<a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs </a>org-modeに対応してなかったので対応させた。
<a href="https://github.com/kijimaD/textlint-plugin-org">https://github.com/kijimaD/textlint-plugin-org</a>
</p>
</div>
<div id="outline-container-org4ba3ac0" class="outline-3">
<h3 id="org4ba3ac0"><a href="#org4ba3ac0"><span class="todo TODO">TODO</span> <code>?</code> を誤検出してしまう問題</a></h3>
<div class="outline-text-3" id="text-org4ba3ac0">
<p>
リンクの <code>?</code> にtextlintが反応してしまう。
mdでは反応しないのでtext-lint-orgに原因がある。
orgaが対応してない模様。コードに生URLのテストはなかった。そもそもorg的にはそういう文法の可能性。
だるいのでルールをオフにするか、PR送るかだな。
</p>
</div>
</div>
<div id="outline-container-org7bab758" class="outline-3">
<h3 id="org7bab758"><a href="#org7bab758"><span class="todo TODO">TODO</span> 返り値の型をつけていない</a></h3>
<div class="outline-text-3" id="text-org7bab758">
<p>
Typescriptなのにanyのままにしている。
あきらかにTxtNodeなので↓指定するのだが、エラー。
</p>
<div class="org-src-container">
<pre class="src src-typescript">export function parse(org: string): TxtNode {
</pre>
</div>

<blockquote>
<p>
src/org-to-ast.ts:52:5 - error TS2739: Type &rsquo;Document&rsquo; is missing the following properties from type &rsquo;TxtNode&rsquo;: raw, range, loc
</p>
</blockquote>

<p>
astオブジェクト。
</p>

<div class="org-src-container">
<pre class="src src-json">{
  type: 'Document',
  properties: {},
  children: [
    {
      type: 'UNKNOWN',
      level: 1,
      properties: {},
      children: [Array],
      loc: [Object],
      range: [Array],
      raw: '* Max comma check\n' +
        '#+begin_src\n' +
        'aaaaa,aaaaa,aaaaa,aaaaa,aaaaa,aaaaa\n' +
        '#+end_src\n'
    },
    type: 'UNKNOWN'
  ],
  loc: { start: { line: 1, column: 0 }, end: { line: 4, column: 10 } },
  range: [ 0, 76 ],
  raw: '* Max comma check\n' +
    '#+begin_src\n' +
    'aaaaa,aaaaa,aaaaa,aaaaa,aaaaa,aaaaa\n' +
    '#+end_src\n'
}
</pre>
</div>

<p>
うむむ。
Type &rsquo;Document&rsquo;がプロパティを持ってないとのことだが、必要な値を持っているように見える。
ast-testでもパスするし、何よりプラグインとしてうまく動いてるのだが。
</p>
</div>
</div>
<div id="outline-container-orgff22318" class="outline-3">
<h3 id="orgff22318"><a href="#orgff22318"><span class="todo TODO">TODO</span> ファイルが空のときエラー</a></h3>
<div class="outline-text-3" id="text-orgff22318">
<p>
ファイルが空のとき、エラーになるような。positionがないエラー。
</p>
</div>
</div>
<div id="outline-container-org806781e" class="outline-3">
<h3 id="org806781e"><a href="#org806781e"><span class="todo TODO">TODO</span> 日付指定が含まれているとエラー</a></h3>
<div class="outline-text-3" id="text-org806781e">
<p>
日本語で挿入されたときにだめなようだ。
アップデート前はできてたが対応しなくなったと。
</p>
<blockquote>
<p>
Cannot destructure property &rsquo;value&rsquo; of &rsquo;eat(&#x2026;)&rsquo; as it is undefined.
</p>
</blockquote>

<p>
これはorgファイルの側を英語にして解決させた。
</p>

<p>
新たなエラーが出現。todoアイテムが見出しの直後にあると発生する。
</p>
<blockquote>
<p>
TypeError: Cannot redefine property: parent
at /home/kijima/Project/textlint-plugin-org/test/fixtures/lint-error.org
    at Function.defineProperty (&lt;anonymous&gt;)
    at Controller.enter (/home/kijima/Project/textlint-plugin-org/node_modules/@textlint/kernel/lib/src/task/textlint-core-task.js:125:24)
    at Controller.__execute (/home/kijima/Project/textlint-plugin-org/node_modules/@textlint/ast-traverse/lib/src/index.js:43:31)
    at Controller.traverse (/home/kijima/Project/textlint-plugin-org/node_modules/@textlint/ast-traverse/lib/src/index.js:114:28)
    at TextLintCoreTask.startTraverser (/home/kijima/Project/textlint-plugin-org/node_modules/@textlint/kernel/lib/src/task/textlint-core-task.js:122:28)
    at TextLintCoreTask.start (/home/kijima/Project/textlint-plugin-org/node_modules/@textlint/kernel/lib/src/task/linter-task.js:22:14)
    at /home/kijima/Project/textlint-plugin-org/node_modules/@textlint/kernel/lib/src/task/task-runner.js:27:18
</p>
</blockquote>

<p>
ASTからtimestampを消すとテスト用のtextlint-kernelではエラーが出なくなった。
前後で比較したから間違いない。
が、本番のtextlintでは以前として出たままで、解決できない。のですべてrevertした。
</p>
</div>
</div>
</div>
<div id="outline-container-org216f701" class="outline-2">
<h2 id="org216f701"><a href="#org216f701">Reference</a></h2>
<div class="outline-text-2" id="text-org216f701">
</div>
<div id="outline-container-orga868681" class="outline-3">
<h3 id="orga868681"><a href="#orga868681"><a href="https://efcl.info/">Web Scratch</a></a></h3>
<div class="outline-text-3" id="text-orga868681">
<p>
<a href="20210511013549-textlint.html#ID-d3394774-aba5-4167-bd18-f194eb2bd9ed">TextLint</a>の作者の人のブログ。
</p>
</div>
</div>
</div>
<div id="outline-container-org422e78b" class="outline-2">
<h2 id="org422e78b"><a href="#org422e78b">Archives</a></h2>
<div class="outline-text-2" id="text-org422e78b">
</div>
<div id="outline-container-orgac098ef" class="outline-3">
<h3 id="orgac098ef"><a href="#orgac098ef"><span class="done DONE">DONE</span> アップデートしたら動かなくなった</a></h3>
<div class="outline-text-3" id="text-orgac098ef">
<p>
いつのまにかbuildしても、jsが出力されない状態になっていた。コンパイラの設定ファイルの、出力先ディレクトリの指定方法が変わったぽい。それで空のままnpm publishして、textlintがライブラリ読み込めない状態になっていた。
</p>
</div>
</div>
<div id="outline-container-orgb114809" class="outline-3">
<h3 id="orgb114809"><a href="#orgb114809"><span class="done DONE">DONE</span> バージョンアップ</a></h3>
<div class="outline-text-3" id="text-orgb114809">
<p>
テストでエラーが出てるのを直す。
</p>

<p>
ちょっとエラーをググったら治った。インポート関連と、依存パッケージが増えたことによるものだった。
</p>
</div>
</div>
<div id="outline-container-orge8c303b" class="outline-3">
<h3 id="orge8c303b"><a href="#orge8c303b"><span class="done DONE">DONE</span> Dockerイメージ</a></h3>
<div class="outline-text-3" id="text-orge8c303b">
<p>
試しやすいように、依存のないDockerイメージで実行できるようにする。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
