:PROPERTIES:
:ID:       81b73757-21b3-438c-ab65-680b5ad88a1b
:header-args+: :wrap :results raw
:END:
#+title: Kubernetes
* æ¦‚è¦
Kubernetesã¯è¤‡æ•°ã®[[id:1658782a-d331-464b-9fd7-1f8233b8b7f8][Docker]]ã‚³ãƒ³ãƒ†ãƒŠã‚’é€£æºã•ã›ã‚‹ãŸã‚ã®ã‚·ã‚¹ãƒ†ãƒ ã€‚
* Memo
** å‘½ä»¤çš„ãªè¨˜è¿°ã‹ã‚‰å®£è¨€çš„ãªè¨˜è¿°ã«ç§»è¡Œã™ã‚‹
#+caption: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ãã‚‹
#+begin_src shell
  kubectl run newdemo --image=cloudnatived/demo:hello --port=8888--labels app=newdemo # ã“ã®ã‚ˆã†ãªè¨­å®šãŒã‚ã‚‹ã¨ã™ã‚‹
  kubectl get deployments newdemo -o yaml --export >deployment.yaml
#+end_src
ç¾åœ¨ã®è¨­å®šã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã€ãã‚Œã‚’[[id:90c6b715-9324-46ce-a354-63d09403b066][Git]]ç®¡ç†ã™ã‚‹ã¨ã™ã°ã‚„ãç§»è¡Œã§ãã‚‹ã€‚
** å·®åˆ†ãƒã‚§ãƒƒã‚¯
#+begin_src shell
kubectl diff -f deployment.yaml
#+end_src

#+begin_src
-  replicas: 10
+  replicas: 5
#+end_src
** minikubeã§localhost8080ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã¨ãã®å¯¾å¿œ
kubectl runã‚’å®Ÿè¡Œã™ã‚‹ã¨å®Ÿè¡Œã§ããªã„ã¨ããŒã‚ã‚‹ã€‚
#+begin_src
$ kubectl run ...
The connection to the server localhost:8080 was refused - did you specify the right host or port?
#+end_src

è½ã¡ç€ã„ã¦statusã‚’ç¢ºèªã™ã‚‹ã€‚
#+caption: statusã§ç¢ºèªã™ã‚‹ã€‚å‹•ã„ã¦ãªã‹ã£ãŸ
#+begin_src
$ kubectl status

minikube
type: Control Plane
host: Stopped
kubelet: Stopped
apiserver: Stopped
kubeconfig: Stopped
#+end_src

å˜ã«å‹•ã„ã¦ãªã„ã“ã¨ãŒã‚ã‹ã£ãŸã®ã§ã€èµ·å‹•ã™ã‚‹ã€‚
#+caption: èµ·å‹•ã™ã‚‹
#+begin_src shell
$ minikube start
#+end_src

å†åº¦kubectl runã™ã‚‹ã€‚
#+caption: ç„¡äº‹podãŒä½œæˆã•ã‚Œã‚‹
#+begin_src shell
$ kubectl run ...
pod/demo created
#+end_src

** kubectlã§contextã‚’ç¢ºèªã™ã‚‹
kubectlãŒã€ã©ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«ã„ã‚‹ã‹ç¢ºèªã§ãã‚‹ã€‚
#+begin_src shell
kubectl config current-context
#+end_src

#+RESULTS:
#+begin_results
minikube
#+end_results

ã“ã‚Œã¯ã€minikubeã€ã¤ã¾ã‚Šãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®contextã«ã„ã¦ã€Kubernetesã¨ã®é€šä¿¡ã®contextã«ã¯ãªã£ã¦ã„ãªã„ã“ã¨ã‚’ç¤ºã™ã€‚
** åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰é¡
#+caption: èµ·å‹•ã—ã¦ã„ã‚‹IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’èª¿ã¹ã‚‹
#+begin_src shell
minikube ip
#+end_src

#+RESULTS:
#+begin_results
172.17.0.2
#+end_results

#+caption: èµ·å‹•çŠ¶æ³ç¢ºèª
#+begin_src shell
minikube dashboard
#+end_src

#+caption: ä½œã£ãŸPod(postgres)ã‚’ç¢ºèª
#+begin_src shell
kubectl describe deployment postgres
#+end_src

#+caption: podsã®æƒ…å ±ç¢ºèª
#+begin_src shell
kubectl get Pods
#+end_src

#+caption: èµ·å‹•ã‚µãƒ¼ãƒ“ã‚¹ã‚’é–‹ãã€‚webappã¯ã‚µãƒ¼ãƒ“ã‚¹å
#+begin_src shell
minikube service webapp
#+end_src

#+caption: è©³ç´°æƒ…å ±
#+begin_src shell
kubectl describe service webapp
#+end_src

#+RESULTS:
#+begin_results
Name:                     webapp
Namespace:                default
Labels:                   app=webapp
Annotations:              <none>
Selector:                 app=webapp,tier=frontend
Type:                     NodePort
IP Family Policy:         SingleStack
IP Families:              IPv4
IP:                       10.109.7.196
IPs:                      10.109.7.196
Port:                     <unset>  80/TCP
TargetPort:               80/TCP
NodePort:                 <unset>  30020/TCP
Endpoints:                172.18.0.6:80,172.18.0.7:80,172.18.0.8:80
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
#+end_results

ãƒã‚§ãƒƒã‚¯ã—ãŸIPã‚¢ãƒ‰ãƒ¬ã‚¹ã«postã—ã¦ã¿ã¦ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å€¤ã‚’ä¿å­˜ãƒ»ç™»éŒ²ã§ãã‚‹ã®ã‚’ç¢ºèªã™ã‚‹ã€‚
** minikubeã§è©¦ã™
Kubernetesã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å‹•ã‹ã™ã“ã¨ã¯é›£ã—ã„ã®ã§ã€ä»£æ›¿æ‰‹æ®µãŒå¿…è¦ã€‚
minikubeã«ã‚ˆã£ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã§è©¦ã—ãŸã‚Šã€é–‹ç™ºã«ä½¿ã†ã“ã¨ãŒã§ãã‚‹ã€‚

[[https://github.com/kubernetes/minikube][kubernetes/minikube: Run Kubernetes locally]]

å°å…¥æ‰‹é †ã€‚
[[https://minikube.sigs.k8s.io/docs/start/][minikube start | minikube]]

kubectlã‚‚å‹•ã‹ã™ãŸã‚ã«å¿…è¦ã€‚
[[https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux][Install and Set Up kubectl on Linux | Kubernetes]]

#+caption: å®Ÿè¡Œ
#+begin_src shell
minikube start
#+end_src

#+caption: ã“ã‚ŒãŒå‡ºã‚Œã°æˆåŠŸ
#+begin_quote
ğŸ„  Done! kubectl is now configured to use "minikube" cluster and "default" namespace by default
#+end_quote

AWSä¸Šã§å‹•ã‹ã™ãŸã‚ã«ã¯ã¾ãŸåˆ¥ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…è¦ã€‚
#+begin_src shell
export KUBERNETES_PROVIDER=aws; curl -sS https://get.k8s.io | bash
#+end_src
* Tasks
** TODO [[https://www.amazon.co.jp/Kubernetes%E5%AE%8C%E5%85%A8%E3%82%AC%E3%82%A4%E3%83%89-%E7%AC%AC2%E7%89%88-Top-Gear-%E9%9D%92%E5%B1%B1/dp/4295009792][Kuberneteså®Œå…¨ã‚¬ã‚¤ãƒ‰ ç¬¬2ç‰ˆ (Top Gear) | é’å±± çœŸä¹Ÿ |æœ¬ | é€šè²© | Amazon]]
:LOGBOOK:
CLOCK: [2023-04-02 Sun 23:31]--[2023-04-02 Sun 23:56] =>  0:25
CLOCK: [2023-04-02 Sun 23:05]--[2023-04-02 Sun 23:30] =>  0:25
CLOCK: [2023-04-02 Sun 19:26]--[2023-04-02 Sun 19:51] =>  0:25
CLOCK: [2023-04-01 Sat 10:47]--[2023-04-01 Sat 11:12] =>  0:25
:END:
æœ¬ã€‚

** TODO [[https://tech.drecom.co.jp/migrate-rails-app-to-container/][å¤ãè‰¯ãRailsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã—ã¦Kubernetesä¸Šã§å‹•ã‹ã™ - Tech Inside Drecom]]
* Reference
** [[https://github.com/kelseyhightower/kubernetes-the-hard-way][kelseyhightower/kubernetes-the-hard-way: Bootstrap Kubernetes the hard way on Google Cloud Platform. No scripts.]]
kubernetesã®ä»•çµ„ã¿ã‹ã‚‰å­¦ã¶ã€‚
** [[https://kubernetes.io/ja/docs/home/][Kubernetesãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | Kubernetes]]
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚
** [[https://ja.wikipedia.org/wiki/Kubernetes][Kubernetes - Wikipedia]]
* Archives
** DONE [[https://www.oreilly.co.jp/books/9784873119014/][O'Reilly Japan - Kubernetesã§å®Ÿè·µã™ã‚‹ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–DevOps]]
CLOSED: [2022-03-01 Tue 10:18]
:LOGBOOK:
CLOCK: [2022-03-01 Tue 09:47]--[2022-03-01 Tue 10:12] =>  0:25
CLOCK: [2022-02-28 Mon 23:32]--[2022-02-28 Mon 23:57] =>  0:25
CLOCK: [2022-02-27 Sun 23:19]--[2022-02-27 Sun 23:44] =>  0:25
CLOCK: [2022-02-27 Sun 22:43]--[2022-02-27 Sun 23:08] =>  0:25
CLOCK: [2022-02-27 Sun 20:34]--[2022-02-27 Sun 20:59] =>  0:25
CLOCK: [2022-02-27 Sun 19:57]--[2022-02-27 Sun 20:22] =>  0:25
CLOCK: [2022-02-27 Sun 19:12]--[2022-02-27 Sun 19:37] =>  0:25
CLOCK: [2022-02-27 Sun 18:46]--[2022-02-27 Sun 19:11] =>  0:25
CLOCK: [2022-02-26 Sat 19:39]--[2022-02-26 Sat 20:04] =>  0:25
CLOCK: [2022-02-26 Sat 18:46]--[2022-02-26 Sat 19:11] =>  0:25
CLOCK: [2022-02-24 Thu 09:58]--[2022-02-24 Thu 10:23] =>  0:25
CLOCK: [2022-02-24 Thu 09:29]--[2022-02-24 Thu 09:54] =>  0:25
CLOCK: [2022-02-23 Wed 20:57]--[2022-02-23 Wed 21:22] =>  0:25
CLOCK: [2022-02-23 Wed 20:21]--[2022-02-23 Wed 20:46] =>  0:25
CLOCK: [2022-02-12 Sat 18:49]--[2022-02-12 Sat 19:14] =>  0:25
CLOCK: [2022-02-12 Sat 18:11]--[2022-02-12 Sat 18:36] =>  0:25
CLOCK: [2022-02-12 Sat 17:45]--[2022-02-12 Sat 18:10] =>  0:25
CLOCK: [2022-02-11 Fri 09:05]--[2022-02-11 Fri 09:30] =>  0:25
:END:

#+caption: èª¬æ˜ã«ä½¿ã†ãƒ‡ãƒ¢ã‚¢ãƒ—ãƒªã‚’cloneã™ã‚‹
#+begin_src shell
git clone git://github.com/cloudnativedevops/demo.git
#+end_src

ãƒãƒãƒ¼ã‚¸ãƒ‰kubernetesãŒçµ¶å¯¾ã«ã„ã„ã€‚å·®åˆ¥åŒ–ã«ã¤ãªãŒã‚‰ãªã„é¢å€’ãªä½œæ¥­ã¯ã€ã‚¢ã‚¦ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã™ã‚‹ã¹ãã€‚
ãƒªã‚½ãƒ¼ã‚¹ã‚’è§£æ”¾ã—ã¦ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹ã¸æŠ•å…¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‹ã‚‰ã€‚

ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ã€Œãªãœã‹ã€ã¨ã„ã†ç–‘å•ã®è§£æ±ºã«å½¹ç«‹ã¤ã€‚å‹•ä½œã—ã¦ã„ã‚‹/ã—ã¦ãªã„ã®å˜ç´”ãªåˆ¤æ–­ã‚’è¶…ãˆã¦ã€ç›£è¦–ã®æ–°ã—ã„æ¬¡å…ƒã‚’åˆ‡ã‚Šé–‹ãã€‚ã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ¡ãƒ¼ã‚¿ã‚„æ¸©åº¦è¨ˆã®ã‚ˆã†ã«ã€ç¾åœ¨ã®çŠ¶æ³ã«é–¢ã™ã‚‹æ•°å€¤æƒ…å ±ã‚’ä¸ãˆã‚‹ã€‚
ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¯ã€å†…éƒ¨ã‹ã‚‰ç›£è¦–ã™ã‚‹ã€‚å¾“æ¥ã®ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç›£è¦–ã¨ç•°ãªã‚‹ã€‚

ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä¸é€æ˜ã§ã‚ã‚‹ã€‚ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢è‡ªä½“ã‚’æ¸¬å®šã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€ä½•ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ã«ã¤ã„ã¦äººé–“ãŒæ¨è«–ã§ãã‚‹ã‚ˆã†æƒ…å ±ã‚’ç”Ÿæˆã•ã›ã‚‹ã“ã¨ãŒå¿…è¦ã€‚

4å¤§ã‚·ã‚°ãƒŠãƒ«ã€‚

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
- ã‚¨ãƒ©ãƒ¼
- æŒç¶šæœŸé–“
- é£½å’Œåº¦

[[https://github.com/prometheus/prometheus][prometheus/prometheus: The Prometheus monitoring system and time series database.]] OSSã®ç›£è¦–ãƒ„ãƒ¼ãƒ«ã€‚

ã‚¯ãƒ©ã‚¦ãƒ‰ãƒã‚¤ãƒ†ã‚£ãƒ–ã®ä¸–ç•Œã§ã¯ã€é©åˆ‡ãªãƒ¡ãƒˆãƒªã‚¯ã‚¹ã¨ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ã€ç¾åœ¨ã®çŠ¶æ³ã‚’çš„ç¢ºã«æŠŠæ¡ã™ã‚‹ã®ã¯æ¥µã‚ã¦é›£ã—ããªã‚‹ã€‚

[[https://kubernetespodcast.com/][Kubernetes Podcast from Google]] kubernetesã®ãƒãƒƒãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã€‚
