<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-06-10 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Web API</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">Web API</h1>
<div id="outline-container-org0658914" class="outline-2">
<h2 id="org0658914"><a href="#org0658914">概要</a></h2>
<div class="outline-text-2" id="text-org0658914">
<p>
幅広いAPIという概念のなかで、とくにWebのこと、Web APIについてまとめる。
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>などWEBアプリケーションを開発する場合、必ず使う。
</p>
</div>
</div>
<div id="outline-container-org7c52806" class="outline-2">
<h2 id="org7c52806"><a href="#org7c52806">Memo</a></h2>
<div class="outline-text-2" id="text-org7c52806">
</div>
<div id="outline-container-org386de89" class="outline-3">
<h3 id="org386de89"><a href="#org386de89">400エラーでは理由を返す</a></h3>
<div class="outline-text-3" id="text-org386de89">
<p>
ほかのレスポンスステータスでは理由を返す必要はないが、400エラーではリクエストに問題があるということなので、フィードバックしたほうがよい。
</p>
</div>
</div>
<div id="outline-container-org2cdf221" class="outline-3">
<h3 id="org2cdf221"><a href="#org2cdf221">リソースに改変を加えるエンドポイントでは、そのリソースを返す</a></h3>
<div class="outline-text-3" id="text-org2cdf221">
<p>
フロンエンドと、バックエンドのテストで便利なので。リソースを返さないとDBを見てチェックしないといけない。
</p>
</div>
</div>
<div id="outline-container-org446b8b5" class="outline-3">
<h3 id="org446b8b5"><a href="#org446b8b5">Bearerトークン</a></h3>
<div class="outline-text-3" id="text-org446b8b5">
<ul class="org-ul">
<li><a href="https://ja.wikipedia.org/wiki/Bearer%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3">Bearerトークン - Wikipedia</a></li>
</ul>

<p>
Bearerトークンは、セキュリティトークンのうちその利用可否が「トークンの所有」のみで決定されるもの。持参人トークン・署名なしトークンとも呼ばれる。
</p>

<blockquote>
<p>
Bearerトークンはしばしば切符に例えられる。切符は乗り物への乗車=アクセスを制御するトークンである。切符の利用権利は単純に「切符を持ってきた人=Bearer」に付与される。誰が切符を購入し管理していたかは関係がない。極端な例では拾った切符であっても（切符の権利者でなくても）持ってきた人=Bearerに乗車権利が付与される。このように切符はBearerトークンと同じ性質を持っている。
</p>

<p>
Bearerトークンの対比としてproof-of-possessionトークン（PoPトークン、「所有の証明」トークン、記名式トークン）が挙げられる。PoPトークンはトークンの所有に追加してトークン権利を所有することの証明を必要とする[1]。Bearerトークンは切符に例えられるが、PoPトークンは国際線飛行機チケットに例えられる。国際線飛行機はチケットを提示するだけではなく、チケットに記された氏名の確認、すなわち権利所有者であることの証明が必要である（パスポートを利用する）。Bearerトークンは単純にトークンの所有のみが求められる点でPoPトークンと異なる。
</p>
</blockquote>
</div>
</div>

<div id="outline-container-orgf2a99fe" class="outline-3">
<h3 id="orgf2a99fe"><a href="#orgf2a99fe">CORSの簡単な仕組み</a></h3>
<div class="outline-text-3" id="text-orgf2a99fe">
<p>
異なるドメインからのAPI呼び出しを制御して安全にする仕組み。なのでバックエンド、フロントエンドが別ドメインになっているときに考慮しないといけない。
</p>

<p>
フロントエンド側にバックエンド呼び出しが書かれているとき、バックエンド側で許可ドメインのヘッダーを入れてレスポンスを返して一致しないと、許可されない。通信する前にバックエンドに対してプリフライトリクエストを行って、許可されているかチェックする。
</p>

<ul class="org-ul">
<li>FE -(FEのドメインを入れたプリフライトリクエスト)&gt; BE -(BEの許可ドメインを入れたプリフライトレスポンス)&gt;
<ul class="org-ul">
<li>BEの許可ドメインにFEドメインが含まれる場合、本題リクエスト。 FE -(本題リクエスト)&gt; BE -(レスポンス)&gt; FE</li>
</ul></li>
</ul>

<p>
という感じ。
</p>
</div>
</div>
<div id="outline-container-orgafc8c1f" class="outline-3">
<h3 id="orgafc8c1f"><a href="#orgafc8c1f">バックエンドにクッキーの情報を渡す</a></h3>
<div class="outline-text-3" id="text-orgafc8c1f">
<p>
認証をセッションによって行っているとする。ありがちな流れ↓だとする。
</p>

<ol class="org-ol">
<li>ログイン成功時にセッションキーを発行し、DB・クライアントブラウザのCookieに保存する</li>
<li>ログインが必要なページでは毎回、Cookieの値とDBの値が合致するかチェックしてログインしているか判定する</li>
</ol>

<p>
バックエンドとフロントエンドが同じ場合、クライアントは常にブラウザのためCookieをチェックできる。が、異なる場合は、クライアントはバックエンドへ直接アクセスしないために、バックエンドからクライアントCookieにアクセスできない。結果、常にセッションキーが一致しないのでログイン行為そのものは成功するが、再度ログイン画面に戻される挙動となる。
</p>

<ul class="org-ul">
<li>クライアント →(○ Cookie)→ FE →(✗ Cookie)→ BE</li>
</ul>

<p>
解決策は、クッキーが渡されるようにすればよい。
FE → BE間のリクエストヘッダーに、クッキーをそのままつけるようにする。
</p>

<pre class="example">
Access-Control-Allow-Credentials: true
</pre>

<p>
あるいはプロキシを使ってFE → BEをFE → FEに見せかけることでも可能。
</p>
</div>
</div>

<div id="outline-container-orgdd78c4f" class="outline-3">
<h3 id="orgdd78c4f"><a href="#orgdd78c4f">クエリパラメータを使うとき</a></h3>
<div class="outline-text-3" id="text-orgdd78c4f">
<p>
<a href="https://qiita.com/mserizawa/items/b833e407d89abd21ee72">翻訳: WebAPI 設計のベストプラクティス - Qiita</a>
</p>

<p>
フィルタ・ソート・検索はクエリパラメータを使う。ベースとなるURLはできるだけシンプルにリソースを示したものにする。機能はクエリパラメータで指定する。
</p>
</div>
</div>
<div id="outline-container-orgdb5488d" class="outline-3">
<h3 id="orgdb5488d"><a href="#orgdb5488d">URLとURIの違い</a></h3>
<div class="outline-text-3" id="text-orgdb5488d">
<p>
<a href="https://qiita.com/NagaokaKenichi/items/6298eb8960570c7ad2e9">RESTful APIのURI設計(エンドポイント設計) - Qiita</a>
</p>

<ul class="org-ul">
<li>URI
<ul class="org-ul">
<li>URL &#x2013; 位置を示す -&gt; アドレス</li>
<li>URN &#x2013; 名前を示す</li>
</ul></li>
</ul>

<p>
URLの方がより制限された用法。
</p>
</div>
</div>
<div id="outline-container-org13684a9" class="outline-3">
<h3 id="org13684a9"><a href="#org13684a9">Swagger</a></h3>
<div class="outline-text-3" id="text-org13684a9">
<p>
SwaggerはAPIドキュメントツールである。ymlやjsonを記述して、ブラウザで閲覧できる。
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>でのラッパーライブラリはrswagで、自然に扱うことができる。
</p>

<ul class="org-ul">
<li>リポジトリ
<a href="https://github.com/rswag/rswag">rswag/rswag: Seamlessly adds a Swagger to Rails-based API&rsquo;s</a></li>
<li>コードの例
<a href="https://github.com/ruslantolstov/rswag-example">ruslantolstov/rswag-example: Demo how to use rswag-api, rswag-specs.</a></li>
<li>記法例
<a href="https://techblog.zozo.com/entry/swagger_yaml">開発効率を上げる！Swaggerの記法まとめ - ZOZO TECH BLOG</a></li>
</ul>

<p>
まとまっているサイト。<a href="https://qiita.com/disc99/items/37228f5d687ad2969aa2">SwaggerでRESTful APIの管理を楽にする - Qiita</a>
</p>
</div>
</div>
</div>

<div id="outline-container-org4038ea8" class="outline-2">
<h2 id="org4038ea8"><a href="#org4038ea8">Tasks</a></h2>
</div>
<div id="outline-container-orgf64a98f" class="outline-2">
<h2 id="orgf64a98f"><a href="#orgf64a98f">Reference</a></h2>
<div class="outline-text-2" id="text-orgf64a98f">
</div>
<div id="outline-container-orgdfae3cd" class="outline-3">
<h3 id="orgdfae3cd"><a href="#orgdfae3cd"><a href="https://programmingpercy.tech/blog/mastering-websockets-with-go/">ProgrammingPercy</a></a></h3>
<div class="outline-text-3" id="text-orgdfae3cd">
<p>
WebSocketのわかりやすい説明。
</p>
</div>
</div>
<div id="outline-container-orge6b9341" class="outline-3">
<h3 id="orge6b9341"><a href="#orge6b9341"><a href="https://qiita.com/Shokorep/items/b7697a146cbb1c3e9f0b">[RESTful API]パスパラメータ、クエリパラメータ、リクエストボディの違いと設計 - Qiita</a></a></h3>
<div class="outline-text-3" id="text-orge6b9341">
<ul class="org-ul">
<li>パスパラメータ</li>
<li>クエリパラメータ</li>
<li>リクエストボディ</li>
</ul>

<p>
の使い分け。
</p>
</div>
</div>
<div id="outline-container-org7881461" class="outline-3">
<h3 id="org7881461"><a href="#org7881461"><a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS">オリジン間リソース共有 (CORS) - HTTP | MDN</a></a></h3>
<div class="outline-text-3" id="text-org7881461">
<p>
CORSのドキュメント。
</p>
</div>
</div>
<div id="outline-container-org0c5f4e3" class="outline-3">
<h3 id="org0c5f4e3"><a href="#org0c5f4e3"><a href="https://qiita.com/att55/items/2154a8aad8bf1409db2b">なんとなく CORS がわかる&#x2026;はもう終わりにする。 - Qiita</a></a></h3>
<div class="outline-text-3" id="text-org0c5f4e3">
<p>
ドメイン間でのポリシー。
</p>
</div>
</div>
<div id="outline-container-org8c2112e" class="outline-3">
<h3 id="org8c2112e"><a href="#org8c2112e"><a href="https://railsguides.jp/routing.html">Rails のルーティング - Railsガイド</a></a></h3>
<div class="outline-text-3" id="text-org8c2112e">
<p>
ルーティングの公式ドキュメント。
</p>
</div>
</div>
<div id="outline-container-orgd906093" class="outline-3">
<h3 id="orgd906093"><a href="#orgd906093"><a href="https://d4192.hatenablog.com/entry/2019/04/10/190800">Railsルーティングのあれこれ(routes.rb) - プログラミングのメモ帳</a></a></h3>
</div>
<div id="outline-container-orgc8b8889" class="outline-3">
<h3 id="orgc8b8889"><a href="#orgc8b8889"><a href="https://techracho.bpsinc.jp/baba/2020_11_20/15619">Railsのルーティングを極める (後編)｜TechRacho by BPS株式会社</a></a></h3>
</div>
<div id="outline-container-org8cc9f28" class="outline-3">
<h3 id="org8cc9f28"><a href="#org8cc9f28"><a href="https://qiita.com/mserizawa/items/b833e407d89abd21ee72">翻訳: WebAPI 設計のベストプラクティス - Qiita</a></a></h3>
</div>
<div id="outline-container-org234ce45" class="outline-3">
<h3 id="org234ce45"><a href="#org234ce45"><a href="https://qiita.com/ryo88c/items/0a3c7861015861026e00">「WebAPI 設計のベストプラクティス」に対する所感 - Qiita</a></a></h3>
</div>
<div id="outline-container-org4d2f334" class="outline-3">
<h3 id="org4d2f334"><a href="#org4d2f334"><a href="https://www.programmableweb.com/apis">APIs Dashboard | ProgrammableWeb</a></a></h3>
<div class="outline-text-3" id="text-org4d2f334">
<p>
パブリックAPI集。設計の例としても使える。
</p>
</div>
</div>
</div>
<div id="outline-container-orga3ef62c" class="outline-2">
<h2 id="orga3ef62c"><a href="#orga3ef62c">Archives</a></h2>
<div class="outline-text-2" id="text-orga3ef62c">
</div>
<div id="outline-container-org3aa8a27" class="outline-3">
<h3 id="org3aa8a27"><a href="#org3aa8a27"><span class="done DONE">DONE</span> <a href="https://www.amazon.co.jp/Web-API-Parts-%E6%B0%B4%E9%87%8E-%E8%B2%B4%E6%98%8E/dp/4873116864/ref=sr_1_2?__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;crid=176CX1TFR474&amp;keywords=web+api&amp;qid=1640733660&amp;sprefix=web%2Caps%2C1017&amp;sr=8-2">Web API: The Good Parts | 水野 貴明 |本 | 通販 | Amazon</a></a></h3>
<div class="outline-text-3" id="text-org3aa8a27">
<ul class="org-ul">
<li>90</li>

<li>URIとメソッドの関係は、操作するもの(リソース)と操作方法(何をするか)の関係であるといえる。</li>
<li>だから名詞と動詞</li>
<li>webページの通常のリンクはGETを使ってアクセスするものとみなされる。formを使うとpostとgetを選択できる。</li>
</ul>

<p>
HTTPのメソッドはHTTPリクエストヘッダの先頭行の最初に以下のようにつけられて、サーバに送信される。
</p>
<pre class="example">
GET /v1/users/123 HTTP/1.1
Host: api.example.com
</pre>

<p>
POSTメソッドは指定したURIに属する新しいリソースを送信する、新しい情報を登録するのが本来の目的。
</p>

<ul class="org-ul">
<li>POSTは指定したURIの配下にデータを登録する。</li>
<li>PUTはリソースがすでにあって、それを更新する。</li>
<li>PUTは完全に上書きし、PATCHは一部を上書きする。</li>
<li>他のサイトを参考にしながら単語を決める</li>
<li>APIがバックエンドのテーブル構造を反映する必要はない</li>
<li>すべてのAPIが同じデータ構造を返すために実際のデータをくるむための構造をエンベロープという。ステータスはHTTPヘッダにやらせればよいことで、冗長な表現となる。</li>
<li>JSON構造はなるべくフラットにすべきだけど階層化したほうが絶対によい場合は階層化もあり</li>
<li>多くのAPIで同じ意味に利用されている一般的な単語を用いる</li>
<li>なるべく少ない単語数で表現する</li>
<li>複数の単語を連結する場合、その連結方法はAPI全体を通して統一する</li>
<li>変な省略形は極力利用しない</li>
<li>単数形/複数形に気をつける</li>
<li>性別をどうするか
<ul class="org-ul">
<li>文字列保持のケースが多い</li>
<li>生物学的な性別が必要な場合はsex</li>
<li>そうでない場合…社会的・文化的な性別の場合はgender</li>
</ul></li>
<li>エラーの形式を統一し、クライアント側でエラー詳細を機械的に理解可能にする</li>
<li>認証と認可の違い。
<ul class="org-ul">
<li>認証(Authentication)とは、「アクセスしてきたのが誰であるのかを識別すること」</li>
<li>認可(Authorization)とは、「特定のユーザに対してある操作の権限を許可すること」</li>
</ul></li>
<li>XSSは別のサイトでjavascriptを走らせることで情報を盗んだり不正な操作をさせること。対策はサニタイズして、外部のjavascriptを評価しないこと</li>
<li>CSRF(XSRF)はpostなどのHTTPメソッドで別のサイトからURLアクセスさせること。対策はトークン、変更を加える操作はGET以外でやらないこと</li>
<li>クライアントを信用せず、値を必ず検証する</li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
