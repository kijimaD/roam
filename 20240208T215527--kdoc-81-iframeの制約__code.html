<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-02-24 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 81: iframeの制約</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 81: iframeの制約</h1>

<div id="outline-container-org46e3a94" class="outline-2">
<h2 id="org46e3a94"><a href="#org46e3a94">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-org46e3a94">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-08 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-12 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9b47341" class="outline-2">
<h2 id="org9b47341"><a href="#org9b47341">概要</a></h2>
<div class="outline-text-2" id="text-org9b47341">
<p>
iframeの制約について関して勘違いがあった。iframeの<a href="20210509100112-javascript.html#ID-a6980e15-ecee-466e-9ea7-2c0210243c0d">JavaScript</a>の制約はCORSを設定しても緩和できないということ。それについて書く。
</p>
</div>
</div>
<div id="outline-container-orgd6d64be" class="outline-2">
<h2 id="orgd6d64be"><a href="#orgd6d64be">イントロ</a></h2>
<div class="outline-text-2" id="text-orgd6d64be">
<p>
iframeはHTMLの要素の1つで、Webページ内にページを表示するのに使う。別のサイトへ干渉する可能性があるため、セキュリティ上の制約が厳しい。たとえば子要素として開いたiframeが親のウィンドウを操作したり中身が読み取れると、簡単に情報を抜き取ったり、改変ができてしまうだろう。
</p>


<div id="org41bd28d" class="figure">
<p><object type="image/svg+xml" data="./images/20240209-iframe.drawio.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>
</div>
</div>

<div id="outline-container-org474dc8b" class="outline-2">
<h2 id="org474dc8b"><a href="#org474dc8b">制約</a></h2>
<div class="outline-text-2" id="text-org474dc8b">
<p>
iframeからは、同一オリジンの場合を除いて、ほとんどのwindowプロパティにアクセスできない制約がある。
</p>

<blockquote>
<p>
フレームの内容にアクセスするスクリプトは、同一オリジンポリシーに従います。別なオリジンから読み込まれたスクリプトは、フレーム内のスクリプトがフレームの親にアクセスする場合を含め、他の window オブジェクトのほとんどのプロパティにアクセスできません。オリジンをまたいだやりとりは Window.postMessage() を使用して実現できます。
</p>

<p>
<a href="https://developer.mozilla.org/ja/docs/Web/HTML/Element/iframe">https://developer.mozilla.org/ja/docs/Web/HTML/Element/iframe</a>
</p>
</blockquote>

<p>
つまり。
</p>

<ul class="org-ul">
<li>windowにアクセスできる
<ul class="org-ul">
<li>iframe外 → localhost</li>
<li>iframe内 → localhost</li>
</ul></li>
<li>windowにアクセスできない
<ul class="org-ul">
<li>iframe外 → localhost</li>
<li>iframe内 → example.com</li>
</ul></li>
</ul>

<p>
同一オリジンポリシーとは何か。
</p>

<blockquote>
<p>
同一オリジンポリシーは重要なセキュリティの仕組みであり、あるオリジンによって読み込まれた文書やスクリプトが、他のオリジンにあるリソースにアクセスできる方法を制限するものです。
</p>

<p>
<a href="https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy">https://developer.mozilla.org/ja/docs/Web/Security/Same-origin_policy</a>
</p>
</blockquote>

<p>
説明はだいたいかぶっているが、こっちの説明は文書やスクリプトといった静的リソースへの言及になっている。windowオブジェクトとかコードの一部分の話ではなく、実行そのものができないニュアンスだ。
</p>

<p>
ところで、同一オリジンと聞いたときにセットで出てくるのは、CORSである。
</p>

<blockquote>
<p>
オリジン間リソース共有 (Cross-Origin Resource Sharing, CORS) は、追加の HTTP ヘッダーを使用して、あるオリジンで動作しているウェブアプリケーションに、異なるオリジンにある選択されたリソースへのアクセス権を与えるようブラウザーに指示するための仕組みです。
</p>

<p>
<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS">https://developer.mozilla.org/ja/docs/Web/HTTP/CORS</a>
</p>
</blockquote>

<p>
ベースとして同一オリジンポリシーがあるけど、それだと困るケースもあるので、CORSによって特定のパスにアクセス権を与えて許可できる、というわけ。そうするとサーバ側で許可リソースを管理できる。
</p>

<p>
オレが勘違いしていたのは、iframeの挙動もすべてCORSで許可できる、と考えていた点だ。それは違うようだ。またMDNドキュメントを見る。
</p>

<blockquote>
<p>
この cross-origin sharing standard では、以下についてオリジン間の HTTP リクエストができるようにしています。
</p>

<ul class="org-ul">
<li>前述のような XMLHttpRequest または Fetch API の呼び出し。</li>
<li>ウェブフォント (CSS の @font-face で別ドメインのフォントを利用するため)。これによりサーバーは、許可したウェブサイトのみからオリジンをまたがって読み込んで利用できる TrueType フォントを提供することができます。</li>
<li>WebGL テクスチャ。</li>
<li>drawImage() を使用してキャンバスへ描かれた画像や映像のフレーム</li>
<li>画像から生成した CSS シェイプ。</li>
</ul>

<p>
<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/CORS">https://developer.mozilla.org/ja/docs/Web/HTTP/CORS</a>
</p>
</blockquote>

<p>
明確にiframeへの影響はないと書かれているわけではないのだが、どうもできなさそう。CORSはHTTPリクエストによるリソース権限管理の話であって、ブラウザの実装レベルの話ではない。↓オリジンをまたいだやりとりはJSのAPI使用を推奨している。
</p>

<blockquote>
<p>
オリジンをまたいだやりとりは Window.postMessage() を使用して実現できます。
</p>

<p>
<a href="https://developer.mozilla.org/ja/docs/Web/HTML/Element/iframe">https://developer.mozilla.org/ja/docs/Web/HTML/Element/iframe</a>
</p>
</blockquote>

<p>
X-Frame-Optionsは有望そうだったが、許可はできなかった。拒否するためのもの。過去存在したようだが、最近のブラウザでは動作しないとのこと。
</p>

<blockquote>
<p>
X-Frame-Options には 2 つの有効なディレクティブがあります。
</p>

<p>
X-Frame-Options: DENY
X-Frame-Options: SAMEORIGIN
</p>

<p>
<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Frame-Options">https://developer.mozilla.org/ja/docs/Web/HTTP/Headers/X-Frame-Options</a>
</p>
</blockquote>

<p>
調べた限り、制限を回避するにはブラウザの同一オリジン制限を外す💀、Window.postMessage()を使うという手段が多そうだった。あとは同一オリジンにフロントを置くか、ネイティブアプリを使う、くらいか。
</p>

<p>
ひとつ言えることは、iframeを使わなければいけない状況がおかしい、ということ。
</p>
</div>
</div>

<div id="outline-container-org80562a7" class="outline-2">
<h2 id="org80562a7"><a href="#org80562a7">関連</a></h2>
<div class="outline-text-2" id="text-org80562a7">
<ul class="org-ul">
<li><a href="20240130T235419--kdoc-66-通知ビューワを作る__memo.html#ID-20240130T235419">KDOC 66: 通知ビューワを作る</a>。では、iframeの制約を避けるためElectronを使って作った</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
