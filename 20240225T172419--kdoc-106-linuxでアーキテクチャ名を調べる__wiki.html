<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-05-18 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 106: Linuxでアーキテクチャ名を調べる</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 106: Linuxでアーキテクチャ名を調べる</h1>
<div id="outline-container-orge05758b" class="outline-2">
<h2 id="orge05758b"><a href="#orge05758b">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-orge05758b">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-26 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-03-17 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd6f8fba" class="outline-2">
<h2 id="orgd6f8fba"><a href="#orgd6f8fba">概要</a></h2>
<div class="outline-text-2" id="text-orgd6f8fba">
<p>
<a href="20220108110637-linux.html#ID-7a81eb7c-8e2b-400a-b01a-8fa597ea527a">Linux</a>でアーキテクチャ名を調べる方法。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>アーキテクチャ名を調べる</label><pre class="src src-shell">uname -i
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">x86_64
</pre>
</div>

<p>
これはLinuxカーネルのビルド時に決まるとのこと<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup>。 <code>UTS-MACHINE</code> という定義でアーキテクチャの文字列が定義されるという。
</p>
</div>
</div>
<div id="outline-container-org46dd26b" class="outline-2">
<h2 id="org46dd26b"><a href="#org46dd26b">何が起きているか</a></h2>
<div class="outline-text-2" id="text-org46dd26b">
<p>
結局わからず。
</p>

<p>
実際、どこを参照しているのだろうか。本には具体的な場所の記載がなかったので調べる。
</p>

<p>
まずドキュメントを見るが記載はない。<a href="https://manpages.ubuntu.com/manpages/trusty/ja/man2/uname.2.html">Ubuntu Manpage: uname - 現在稼働中のカーネルについての名前と情報を得る</a>。そんな実装のことまでは書いてないだろうことは想像に難くない。
</p>

<p>
実際の場所を調べる。straceで見ると、unameシステムコールが発行されている↓。ので、システムコールの定義を見ればよいと考えた。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>nameシステムコールが発行されている。2&gt;&amp;1はorg-babel用</label><pre class="src src-shell">strace uname -i 2&gt;&amp;1 | tail
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">mmap(NULL, 6784496, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7f6e037af000
close(3)                                = 0
uname({sysname="Linux", nodename="orange-ThinkPad-X1-Carbon-Gen-10", ...}) = 0 👈
newfstatat(1, "", {st_mode=S_IFIFO|0600, st_size=0, ...}, AT_EMPTY_PATH) = 0
write(1, "x86_64\n", 7x86_64
)                 = 7
close(1)                                = 0
close(2)                                = 0
exit_group(0)                           = ?
+++ exited with 0 +++
</pre>
</div>

<p>
しかし、↓ソースコードを見てもよくわからない。別の関数まで辿らないといけない。uts_name()から返される構造体をコピーしているのか。uts_name()がどこで定義されているかわからない。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>unameの定義</label><pre class="src src-git-permalink">https://github.com/torvalds/linux/blob/1f874787ed9a2d78ed59cb21d0d90ac0178eceb0/kernel/sys.c#L1327-L1345
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span class="org-function-name">SYSCALL_DEFINE1</span>(uname, <span class="org-keyword">struct</span> <span class="org-type">old_utsname</span> <span class="org-variable-name">__user</span> *, name)
{
        <span class="org-keyword">struct</span> <span class="org-type">old_utsname</span> <span class="org-variable-name">tmp</span>;

        <span class="org-keyword">if</span> (<span class="org-negation-char">!</span>name)
                <span class="org-keyword">return</span> -EFAULT;

        down_read(&amp;uts_sem);
        memcpy(&amp;tmp, utsname(), <span class="org-keyword">sizeof</span>(tmp));
        up_read(&amp;uts_sem);
        <span class="org-keyword">if</span> (copy_to_user(name, &amp;tmp, <span class="org-keyword">sizeof</span>(tmp)))
                <span class="org-keyword">return</span> -EFAULT;

        <span class="org-keyword">if</span> (override_release(name-&gt;release, <span class="org-keyword">sizeof</span>(name-&gt;release)))
                <span class="org-keyword">return</span> -EFAULT;
        <span class="org-keyword">if</span> (override_architecture(name))
                <span class="org-keyword">return</span> -EFAULT;
        <span class="org-keyword">return</span> 0;
}
</pre>
</div>

<p>
動いているマシン上で、/proc/sys/kernel にunameで出るリリース日とか、アーキテクチャ名があるのを確認した。が、どう利用しているのかはわからない。/procはオンメモリ、動的なディレクトリなはずなのでそれを制御しているコードもどこかにあるはずだが。
</p>
</div>
</div>
<div id="outline-container-org58ffdb1" class="outline-2">
<h2 id="org58ffdb1"><a href="#org58ffdb1">関連</a></h2>
<div class="outline-text-2" id="text-org58ffdb1">
<ul class="org-ul">
<li><a href="20240105T215847--kdoc-63-『私はどのようにしてlinuxカーネルを学んだか』__book.html#ID-20240105T215847">KDOC 63: 『私はどのようにしてLinuxカーネルを学んだか』</a>。を読んで、ここから知ろうと考えた</li>
</ul>
</div>
</div>
<div id="outline-container-orgc71708e" class="outline-2">
<h2 id="orgc71708e"><a href="#orgc71708e">Backlinks</a></h2>
<div class="outline-text-2" id="text-orgc71708e">
<ul class="org-ul">
<li><a href="./20240317T101828--kdoc-125-procのマニュアルを調べる__wiki.html">KDOC 125: /procのマニュアルを調べる</a></li>
</ul>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1" role="doc-backlink">1</a></sup> <div class="footpara" role="doc-footnote"><p class="footpara">
<a href="https://amzn.to/3I8xXtT">私はどのようにしてLinuxカーネルを学んだか</a>から。
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
