:PROPERTIES:
:ID:       2709c815-cd38-4679-86e8-ff2d3b8817e4
:END:
#+title: Insomnia

#+caption: ページ間のリンクを示す
#+BEGIN_EXPORT html
<script defer src='https://cdnjs.cloudflare.com/ajax/libs/d3/7.2.1/d3.min.js' integrity='sha512-wkduu4oQG74ySorPiSRStC0Zl8rQfjr/Ty6dMvYTmjZw6RS5bferdx8TR7ynxeh79ySEp/benIFFisKofMjPbg==' crossorigin='anonymous' referrerpolicy='no-referrer'></script>
<script defer src='js/graph.js'></script>

<div id="main-graph">
  <svg>
  <defs>
    <filter x="0" y="0" width="1" height="1" id="solid">
      <feflood flood-color="#f7f7f7" flood-opacity="0.9"></feflood>
      <fecomposite in="SourceGraphic" operator="xor"></fecomposite>
    </filter>
  </defs>
  <rect id="base_rect" width="100%" height="100%" fill="#ffffff"></rect>
  </svg>
</div>
#+END_EXPORT

ドキュメントのリンク関係を示すグラフ。[fn:1]

[fn:1]
1. org-roamが各orgファイルを解釈して、sqliteデータベースを作成する。
2. 出力したsqliteデータベースをjsonに加工する。
3. d3.jsにデータを入れて、グラフを描画する。
* 概要
プログラム関連の記録。

- [[id:a0f58a2a-e92d-496e-9c81-dc5401ab314f][Author History]]
* Repository stat
期間ごとのファイル数と行数。Gitリポジトリをコミットごとに調査するスクリプトでデータ取得。GNU Plotでグラフ画像を描画している。

#+CAPTION: Number of files(.org only)
#+ATTR_HTML: :alt Number of files image :title Files :align right
[[./git-file.png]]

#+CAPTION: Number of lines(.org only)
#+ATTR_HTML: :alt Number of lines image :title Lines :align right
[[./git-line.png]]
* Recent activity
[[id:1ad8c3d5-97ba-4905-be11-e6f2626127ad][Emacs]] [[id:7e85e3f3-a6b9-447e-9826-307a3618dac8][org-mode]](標準機能)により時刻記録。clock-tableとorg-agendaで出力した。
** Pomodoro
 #+BEGIN_EXPORT html
 <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
 <script type="text/javascript">
 google.charts.load("current", {packages:["calendar"]});
 google.charts.setOnLoadCallback(drawChart);

 function drawChart() {
  scores = csvToArray("js/pmd.csv").map(function (value) {
   return [new Date(value[0]), Number(value[1])];
  })

  var dataTable = new google.visualization.DataTable();
  dataTable.addColumn({ type: 'date', id: 'Date' });
  dataTable.addColumn({ type: 'number', id: 'Score' });
  dataTable.addRows(scores);

  var chart = new google.visualization.Calendar(document.getElementById('calendar_basic'));

  var options = {
    title: "Pomodoro stats",
  };

  chart.draw(dataTable, options);
 }

 function csvToArray(filename) {

   // CSVファイルを文字列として取得
   var srt = new XMLHttpRequest();
   srt.open("GET", filename, false);
   try {
     srt.send(null);
   } catch (err) {
     console.log(err)
   }

   // 配列を用意
   var csvArr = [];

   // 改行ごとに配列化
   var lines = srt.responseText.split("\n");

   // 1行ごとに処理
   for (var i = 0; i < lines.length; ++i) {
     var cells = lines[i].split(",");
     if (cells.length != 1) {
       csvArr.push(cells);
     }
   }
   return csvArr;
 }
 </script>

 <body>
 <div id="calendar_basic" style="width: 1000px; height: 350px;"></div>
 </body>
 #+END_EXPORT
** This Week by Day
#+BEGIN: clocktable :maxlevel 3 :scope agenda :tags "" :block thisweek :step day :stepskip0 true :fileskip0 true :link true :maxlevel 2 :timestamp true :indent true
#+END:
** This Month
#+BEGIN: clocktable :maxlevel 3 :scope agenda :tags "" :block thismonth :step month :stepskip0 true :fileskip0 true :link true :maxlevel 2 :timestamp true :indent true
#+END:
** COMMENT Last 30 days log
# あまり意味がない気がするので非表示にしている。
#+BEGIN_EXPORT html
<iframe src="./agenda.html"
        style="width: 100%;"></iframe>
#+END_EXPORT
** COMMENT columnview
:OUTPUT_CONFIG:
#+COLUMNS: %35ITEM(Goals/Activities) %TODO(Status){C+} %STARTED(Started) %CLOSED(Completed)
:END:

#+BEGIN: columnview :hlines 1 :indent t :id global

#+END:
* Tasks
** _
文書全体、サイトビルドに関するタスクを記述する。
** TODO コミットグラフをd3.jsで書き直す
GNU Plotで描画していてよくわからない、かつださいので変える。
** TODO gitグラフのスクリプトを共通化する
同じ内容が重複しているのでまとめる。共通化すればもっといろんなことに使えるはず。
** TODO 更新してないファイルを検知してissue化させる
[[id:6b889822-21f1-4a3e-9755-e3ca52fa0bc4][GitHub]] Actionで定期タスクを実行して、issue化させる。
一定期間過ぎてるファイルリストを出して、それらをまとめたIssueを作らせるとよさそう。
** TODO LintをCIで実行する
** TODO Makefileをリファクタリング
:LOGBOOK:
:END:
サイトのビルドは[[id:375ccc99-c86e-4d3e-9367-550286dccba4][Make]]でしている。

全然使いこなせてないので、ちゃんとしたMakefileの書き方で書く。
[[id:5ba43a42-93cb-48fa-8578-0558c757493f][magit]]のMakefileが参考になりそう。
https://github.com/kd-collective/magit/blob/877c389ca0161959081fa2c77045ce1ae9463be4/Documentation/Makefile#L1
* Archives                                                         :noexport:
** DONE サイトindexにstatカードを表示する
CLOSED: [2021-09-25 Sat 00:19]
- https://qiita.com/zizi4n5/items/f8076cb25bbf64a9bc1c
** DONE ファイル数グラフを追加する
いい感じに増加しているのを見たい。
[[id:90c6b715-9324-46ce-a354-63d09403b066][Git]]から、各期間での数を抽出すればいい。
** DONE ファイルサイズで並べる
CLOSED: [2021-09-10 Fri 17:49]
ファイルを並べた。
** DONE clock table作成
CLOSED: [2021-09-23 Thu 14:50]
:LOGBOOK:
CLOCK: [2021-09-23 Thu 13:48]--[2021-09-23 Thu 13:56] =>  0:08
CLOCK: [2021-09-23 Thu 12:26]--[2021-09-23 Thu 13:28] =>  1:02
CLOCK: [2021-09-23 Thu 11:29]--[2021-09-23 Thu 11:57] =>  0:28
CLOCK: [2021-09-23 Thu 11:14]--[2021-09-23 Thu 11:17] =>  0:03
:END:
スケジュール表示よりこっちのほうが見やすい。
** CLOSE ファイルサイズの棒グラフを作成する
CLOSED: [2021-09-23 Thu 22:26]
:LOGBOOK:
CLOCK: [2021-09-23 Thu 22:06]--[2021-09-23 Thu 22:26] =>  0:20
CLOCK: [2021-09-23 Thu 21:16]--[2021-09-23 Thu 21:41] =>  0:25
:END:

ファイルごとで棒グラフみたくしたかったのだが、ファイルの数が多すぎてうまくいかなかった。
また、一部の割合が大きくそのほかは0.1%代なのでグラフとしてあまり意味をもたなかった。

#+begin_src shell
set terminal dumb feed 80 50

set datafile separator ","
set noxtics

plot "character-count.dat" using 2:0:ytic(1) with lines notitle
#+end_src
** DONE コマンド整理
CLOSED: [2021-12-28 Tue 20:08]
:LOGBOOK:
CLOCK: [2021-12-28 Tue 18:38]--[2021-12-28 Tue 20:08] =>  1:30
:END:
ディレクトリを移動してrootを綺麗にした。
** DONE ファイルグラフの表示項目を増やす
CLOSED: [2022-01-04 Tue 12:46]
- ページランク, タイトル, 文字数カウント, 変更回数、最終変更日(相対日付)、変更回数
** DONE Docker環境作成する
CLOSED: [2022-01-04 Tue 12:46]
:LOGBOOK:
CLOCK: [2021-12-30 Thu 21:35]--[2021-12-30 Thu 23:01] =>  1:26
:END:
複数の依存環境があり、環境構築が面倒なので。

- Ruby
- Python
- sqlite
- Emacs
** DONE org-roam.dbを使って有用な情報取得
CLOSED: [2022-01-04 Tue 12:46]
:LOGBOOK:
:END:
ファイルの名前、接続してるファイルの数(ページランクができる)を表にできそうな感じ。今はlsでやってる部分。
** CLOSE Write self introduction in English
CLOSED: [2022-01-29 Sat 17:06]
** DONE イメージ作成する
CLOSED: [2022-02-03 Thu 10:02]
:LOGBOOK:
CLOCK: [2022-01-29 Sat 20:20]--[2022-01-29 Sat 20:45] =>  0:25
CLOCK: [2022-01-29 Sat 19:07]--[2022-01-29 Sat 19:32] =>  0:25
:END:
開発・ビルドを[[id:1658782a-d331-464b-9fd7-1f8233b8b7f8][Docker]]でできるようにする。

- [[id:1ad8c3d5-97ba-4905-be11-e6f2626127ad][Emacs]]とsqliteがうまく動かない。GitHub ActionでやっているEmacsイメージ的なのでは起こらない。
- マルチステージビルドがうまくいかない。依存は、主に[[id:1ad8c3d5-97ba-4905-be11-e6f2626127ad][Emacs]], [[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]], [[id:a6c9c9ad-d9b1-4e13-8992-75d8590e464c][Python]]の3つ(他にもある)。

[[id:6b889822-21f1-4a3e-9755-e3ca52fa0bc4][GitHub]] Actionがないとビルドできない状態なので、手元で一通り実行できるようにして、同じ方法で本番ビルドも行えるようにしたい。
** DONE デプロイをdockerでやる
CLOSED: [2022-02-03 Thu 10:03]
作ったイメージでデプロイするように。高速。
** DONE イメージ改良
CLOSED: [2022-02-06 Sun 00:31] DEADLINE: <2022-02-05 Sat 23:59>
:LOGBOOK:
CLOCK: [2022-02-05 Sat 10:25]--[2022-02-05 Sat 10:50] =>  0:25
:END:
遅いので改良する。
** DONE テスト追加する
CLOSED: [2022-02-06 Sun 10:52]
ビルドのテストがない。

実行テストが成功したら、タグをつけてpushしたい。
新しいビルド内容でpublishできるか試すようにした。
** DONE lint追加
CLOSED: [2022-02-11 Fri 17:46]
:LOGBOOK:
CLOCK: [2022-02-09 Wed 22:22]--[2022-02-09 Wed 22:47] =>  0:25
CLOCK: [2022-02-06 Sun 10:54]--[2022-02-06 Sun 11:19] =>  0:25
:END:
- dockerfile
- image内容
- github actions
いつでも実行できるようにしたが、まだエラーが多くCIで実行できない。
** DONE pomodoroグラフを記録・表示する
CLOSED: [2022-02-26 Sat 00:13]
:LOGBOOK:
CLOCK: [2022-02-13 Sun 11:57]--[2022-02-13 Sun 12:22] =>  0:25
CLOCK: [2022-02-13 Sun 11:17]--[2022-02-13 Sun 11:42] =>  0:25
CLOCK: [2022-02-13 Sun 10:50]--[2022-02-13 Sun 11:15] =>  0:25
:END:
デイリーで測ってるやつをファイルに保存しておいて、描画すればよさそう。
** DONE dockerジョブを改良
CLOSED: [2022-02-27 Sun 14:34]
:LOGBOOK:
CLOCK: [2022-02-26 Sat 20:06]--[2022-02-26 Sat 20:31] =>  0:25
CLOCK: [2022-02-26 Sat 19:13]--[2022-02-26 Sat 19:38] =>  0:25
CLOCK: [2022-02-26 Sat 14:23]--[2022-02-26 Sat 14:48] =>  0:25
CLOCK: [2022-02-26 Sat 13:25]--[2022-02-26 Sat 13:50] =>  0:25
CLOCK: [2022-02-26 Sat 11:06]--[2022-02-26 Sat 11:31] =>  0:25
CLOCK: [2022-02-26 Sat 00:14]--[2022-02-26 Sat 00:39] =>  0:25
:END:
- herokuのコンテナデプロイがおかしい
- イメージサイズがでかくてビルドに時間がかかる
** CLOSE stagingビルドが終わったらPRにコメントする
CLOSED: [2022-02-28 Mon 23:05]
:LOGBOOK:
CLOCK: [2022-02-28 Mon 22:29]--[2022-02-28 Mon 22:54] =>  0:25
CLOCK: [2022-02-28 Mon 21:59]--[2022-02-28 Mon 22:24] =>  0:25
:END:
UI上できたかわからないので。

あまりよくわからないのでやらない。
** DONE Upptimeで死活監視してみる
CLOSED: [2022-02-28 Mon 23:06]
:LOGBOOK:
CLOCK: [2022-02-28 Mon 10:27]--[2022-02-28 Mon 10:52] =>  0:25
:END:
サイレントにデプロイ失敗していることが多い。
[[id:6b889822-21f1-4a3e-9755-e3ca52fa0bc4][GitHub]] Actionsだけでできるらしい。
