<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-02-27 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 25: docker progress を読む</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 25: docker progress を読む</h1>
<p>
<a href="20210805005543-docker.html#ID-1658782a-d331-464b-9fd7-1f8233b8b7f8">Docker</a>でimage pullをするときに出る、プログレスバーをどうやっているのか調べる。
</p>

<div id="outline-container-orgdec0fa0" class="outline-2">
<h2 id="orgdec0fa0"><a href="#orgdec0fa0">Tasks</a></h2>
<div class="outline-text-2" id="text-orgdec0fa0">
</div>
<div id="outline-container-orgd1c71de" class="outline-3">
<h3 id="orgd1c71de"><a href="#orgd1c71de"><span class="done DONE">DONE</span> Progressのコードを読む</a></h3>
<div class="outline-text-3" id="text-orgd1c71de">
<ul class="org-ul">
<li><a href="https://github.com/moby/moby/pull/45602/files">[backport 24.0] c8d/pull: Use same progress action as distribution by vvoland · Pull Request #45602 · moby/moby</a></li>
</ul>

<p>
を見て、progressという箇所があることを知る。ここを読んでみる。
</p>

<ul class="org-ul">
<li>インターフェースprogressUpdaterは更新するインターフェース
<ul class="org-ul">
<li>構造体pullProgressはインターフェースを満たす。こいつはStore, ShowExistsを持っていて情報を保持してる</li>
</ul></li>
<li>構造体jobsはミューテックスとdescを持つ。descsは何に使われている
<ul class="org-ul">
<li>イメージの情報が入ってるんだろうな</li>
</ul></li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>Descriptor</label><pre class="src src-git-permalink">https://github.com/opencontainers/image-spec/blob/9615142d016838b5dfe7453f80af0be74feb5c7c/specs-go/v1/descriptor.go#L22-L50
</pre>
</div>

<pre class="example" id="org661bd47">
type Descriptor struct {
	// MediaType is the media type of the object this schema refers to.
	MediaType string `json:"mediaType,omitempty"`

	// Digest is the digest of the targeted content.
	Digest digest.Digest `json:"digest"`

	// Size specifies the size in bytes of the blob.
	Size int64 `json:"size"`

	// URLs specifies a list of URLs from which this object MAY be downloaded
	URLs []string `json:"urls,omitempty"`

	// Annotations contains arbitrary metadata relating to the targeted content.
	Annotations map[string]string `json:"annotations,omitempty"`

	// Data is an embedding of the targeted content. This is encoded as a base64
	// string when marshalled to JSON (automatically, by encoding/json). If
	// present, Data can be used directly to avoid fetching the targeted content.
	Data []byte `json:"data,omitempty"`

	// Platform describes the platform which the image in the manifest runs on.
	//
	// This should only be used when referring to a manifest.
	Platform *Platform `json:"platform,omitempty"`

	// ArtifactType is the IANA media type of this artifact.
	ArtifactType string `json:"artifactType,omitempty"`
}
</pre>

<ul class="org-ul">
<li>表示するのはshowProgress。こいつはupdater interfaceを受け取って、更新する方法を抽象化している
<ul class="org-ul">
<li>データはレシーバのjobsに保持している</li>
</ul></li>
</ul>


<div id="org9ca5aac" class="figure">
<p><object type="image/svg+xml" data="./images/20230527-progress.drawio.svg" class="org-svg">
Sorry, your browser does not support SVG.</object>
</p>
</div>

<ul class="org-ul">
<li>UpdateProgressは何をしているか
<ul class="org-ul">
<li>storeの中のstatusを更新する(アクティブなものだけにする)</li>
<li>引数のjobsでループ</li>
<li>アクティブなjobのときだけWriteProgress()で進捗を書き込む</li>
<li>条件によって、「ダウンロード完了」とか、「すでに存在」とかメッセージを分ける</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org409886d" class="outline-3">
<h3 id="org409886d"><a href="#org409886d"><span class="done DONE">DONE</span> Pullのコードを読む</a></h3>
<div class="outline-text-3" id="text-org409886d">
<ul class="org-ul">
<li>daemon/containerd/image_pull.go</li>
<li>レシーバはImageService。イメージに関するアクションを一手に引き受けるインターフェース及び構造体
<ul class="org-ul">
<li>インターフェース <a href="https://github.com/kd-collective/moby/blob/c030f7f40d62ecabfedd1cf96fbb734ce051ce73/daemon/image_service.go#L25">https://github.com/kd-collective/moby/blob/c030f7f40d62ecabfedd1cf96fbb734ce051ce73/daemon/image_service.go#L25</a></li>
<li>構造体 <a href="https://github.com/kd-collective/moby/blob/c030f7f40d62ecabfedd1cf96fbb734ce051ce73/daemon/containerd/service.go#L20">https://github.com/kd-collective/moby/blob/c030f7f40d62ecabfedd1cf96fbb734ce051ce73/daemon/containerd/service.go#L20</a></li>
</ul></li>
<li>platformを読み取ってオプションに追加する</li>
<li>image名をパースしてrefオブジェクトを作成する</li>
<li>tagOrDigestをパースして分離する</li>
<li>パースした結果はrefに入れる</li>
<li>リゾルバーを作成してオプションに追加する</li>
<li>ハンドル関数をオプションに追加する
<ul class="org-ul">
<li>ハンドル関数の中身でjobsを追加している</li>
</ul></li>
<li>ここのハンドラは何をするのだろう</li>
<li>JSONProgressOutputオブジェクトを作成</li>
<li>finishProgressを作成</li>
<li>deferでfinishProgress()を実行する</li>
<li>オプションにWithPullUnpack, WithPullSnapshotterを追加する
<ul class="org-ul">
<li>展開とかスナップショット&#x2026;</li>
</ul></li>
<li>Pullを実行する。これが本質か。Pull自体はrefがあれば実行できる。コードの途中は本質ではない。
<ul class="org-ul">
<li>imageService.client.Pull なので、普通にdocker clientのpullを実行するんだろう</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
