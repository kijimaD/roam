<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-10-08 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>create-link</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css'><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">create-link</h1>
<div id="outline-container-orgdb7f240" class="outline-2">
<h2 id="orgdb7f240"><a href="#orgdb7f240">概要</a></h2>
<div class="outline-text-2" id="text-orgdb7f240">
<p>
create-linkは簡単にリンクを各形式に変換する、自作<a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs</a> package。<a href="20210509122633-emacs_lisp.html#ID-c7e81fac-9f8b-4538-9851-21d4ff3c2b08">Emacs Lisp</a>で書かれている。元ネタはChromeアドオンの<a href="https://chrome.google.com/webstore/detail/create-link/gcmghdmnkfdbncmnmlkkglmnnhagajbm?hl=ja">Create Link</a>。
</p>
</div>
</div>
<div id="outline-container-orgd78a89e" class="outline-2">
<h2 id="orgd78a89e"><a href="#orgd78a89e">Memo</a></h2>
<div class="outline-text-2" id="text-orgd78a89e">
</div>
<div id="outline-container-org7bde0e8" class="outline-3">
<h3 id="org7bde0e8"><a href="#org7bde0e8">アクセスを待つ必要がある</a></h3>
<div class="outline-text-3" id="text-org7bde0e8">
<p>
ブラウザでのテストは、(sit-for) で待つ必要がある。
ewwでは待たなくてもOK、w3mでは待つ必要がある、というのは同期、非同期が違うからか。
</p>
</div>
</div>
<div id="outline-container-org7476b49" class="outline-3">
<h3 id="org7476b49"><a href="#org7476b49">letで抜けられない</a></h3>
<div class="outline-text-3" id="text-org7476b49">
<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">let</span> (result)
  (request
    <span class="org-builtin">:success</span> (function*
      (<span class="org-keyword">progn</span>
        (<span class="org-keyword">setq</span> result <span class="org-string">"aaaa"</span>))))
result) <span class="org-comment-delimiter">; </span><span class="org-comment">nil</span>
</pre>
</div>
<p>
みたいなとき、返り値resultがnilになる。
ほかの普通の関数だとOKだが、requestの特殊な形で、ちょっと違う。
</p>
</div>
</div>
<div id="outline-container-orgff34093" class="outline-3">
<h3 id="orgff34093"><a href="#orgff34093">CI</a></h3>
<div class="outline-text-3" id="text-orgff34093">
<p>
依存パッケージを読みこむ必要がある。
Emacs package以外にも、たとえばw3mは外部プログラムが必要なのでapt-getするなど。
</p>
</div>
</div>
<div id="outline-container-org5e7c0d1" class="outline-3">
<h3 id="org5e7c0d1"><a href="#org5e7c0d1">CIやバッチテストでcl-libが読み込まれない</a></h3>
<div class="outline-text-3" id="text-org5e7c0d1">
<p>
caskに書いてもインストールされない。
最初から入っているようだ。ただし、(require &rsquo;cl-lib)しないといけない。
また、function* はcl-functionのaliasだと書かれているが、CIやEmacsバッチモードだと認識しなかった。何か別のパッケージな可能性。
</p>
</div>
</div>
<div id="outline-container-orgfeebdb6" class="outline-3">
<h3 id="orgfeebdb6"><a href="#orgfeebdb6">依存パッケージ</a></h3>
<div class="outline-text-3" id="text-orgfeebdb6">
<p>
elisp-checkでの依存パッケージの読み込み方がわからない。
テストだけはcaskで別にやっている。
</p>
</div>
</div>
<div id="outline-container-org617fe75" class="outline-3">
<h3 id="org617fe75"><a href="#org617fe75">冗長なcustom</a></h3>
<div class="outline-text-3" id="text-org617fe75">
<p>
冗長なcustomをうまく指定するように。
customを設定するときにbm.elが参考になった。
</p>
</div>
</div>
<div id="outline-container-org8eb722d" class="outline-3">
<h3 id="org8eb722d"><a href="#org8eb722d">helmソースの定義</a></h3>
<div class="outline-text-3" id="text-org8eb722d">
<p>
最小構成ぽいhelm-miscが参考になった。
</p>
</div>
</div>
<div id="outline-container-org1433eb6" class="outline-3">
<h3 id="org1433eb6"><a href="#org1433eb6">completion</a></h3>
<div class="outline-text-3" id="text-org1433eb6">
<p>
デフォルトのcompletionもすぐできた。
要するにリストを渡せば選択肢になる。で、出てきた値は文字列なのでinternすれば良い。
</p>
</div>
</div>
<div id="outline-container-orgdbc46d5" class="outline-3">
<h3 id="orgdbc46d5"><a href="#orgdbc46d5">ヘルパー作らないとやばい</a></h3>
</div>
<div id="outline-container-org18e04d2" class="outline-3">
<h3 id="org18e04d2"><a href="#org18e04d2">mapcarを使って書き直せないか</a></h3>
<div class="outline-text-3" id="text-org18e04d2">
<p>
あとクロージャとかも。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">test1</span> (default)
  `(<span class="org-keyword">lambda</span> (optional) (<span class="org-keyword">if</span> optional optional ,default)))

(funcall (test1 create-link-default-format) <span class="org-string">"aaa"</span>)
(<span class="org-keyword">setq</span> test2 (test1 <span class="org-string">"aaa"</span>))
test2
(funcall test2 create-link-default-format)

(<span class="org-keyword">defun</span> <span class="org-function-name">make-adder</span> (n)
  `(<span class="org-keyword">lambda</span> (x) (+ x ,n)))
(<span class="org-keyword">setq</span> add2 (make-adder 2))
(funcall add2 5)

(funcall (<span class="org-keyword">lambda</span> (a b c) (+ a b c))
         1 2 3)

(funcall (<span class="org-keyword">lambda</span> (n) (1+ n))        <span class="org-comment-delimiter">; </span><span class="org-comment">One required:</span>
         1)
</pre>
</div>
</div>
</div>

<div id="outline-container-org2b34c6d" class="outline-3">
<h3 id="org2b34c6d"><a href="#org2b34c6d">モード別に分岐する関数の参考になる</a></h3>
<div class="outline-text-3" id="text-org2b34c6d">
<p>
ace-link.el は参考になるな。
buffer-nameで判別してたが、modeのほうがよさそう。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(<span class="org-keyword">cond</span> ((eq major-mode 'Info-mode)
       (ace-link-info))
      ((member major-mode '(help-mode
                            package-menu-mode geiser-doc-mode elbank-report-mode
                            elbank-overview-mode slime-trace-dialog-mode helpful-mode))
       (ace-link-help))
      ((eq major-mode 'Man-mode)
       (ace-link-man))
      ((eq major-mode 'woman-mode)
       (ace-link-woman))
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdd0fb6c" class="outline-3">
<h3 id="orgdd0fb6c"><a href="#orgdd0fb6c">ace-linkを参考に</a></h3>
<div class="outline-text-3" id="text-orgdd0fb6c">
<p>
info用とか、custom用のリンク抽出も考えられる。
ファイルでなくて、関数の集合体を生成できないか。
</p>

<p>
たとえばinfoの特定のページを開くのを実行するリストを生成する。
(info &ldquo;ivy&rdquo;)する。みたいな。
ファイルだと依存するからな。Emacsで実行するのが前提のを生成するというわけだ。
</p>

<div class="org-src-container">
<pre class="src src-shell">npm install date-fns @types/date-fns
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7bd3d1f" class="outline-2">
<h2 id="org7bd3d1f"><a href="#org7bd3d1f">Tasks</a></h2>
<div class="outline-text-2" id="text-org7bd3d1f">
</div>
<div id="outline-container-org2c62623" class="outline-3">
<h3 id="org2c62623"><a href="#org2c62623"><span class="todo TODO">TODO</span> シェルだったらカレントディレクトリを取る</a></h3>
<div class="outline-text-3" id="text-org2c62623">
<p>
ブラウザみたく、変数が用意されてはない模様。まあこれについてはあまりいらないか。
パスを取得したいときはあるけど、それをhtmlリンクにしたいってあまりないしな。
</p>

<p>
パスはdefault-directoryで取れる。
</p>
</div>
</div>
<div id="outline-container-org7f5d149" class="outline-3">
<h3 id="org7f5d149"><a href="#org7f5d149"><span class="todo TODO">TODO</span> タイトルはないときバージョンを作るか</a></h3>
<div class="outline-text-3" id="text-org7f5d149">
<p>
つまりパスだけ。
主題とはずれる気がする。シェルとかだとタイトルの取りようがないのでこれを追加するのが必要。
</p>
</div>
</div>
<div id="outline-container-orgfd1ccd7" class="outline-3">
<h3 id="orgfd1ccd7"><a href="#orgfd1ccd7"><span class="todo TODO">TODO</span> Gitリポジトリのときは、相対ディレクトリを取得するオプション</a></h3>
<div class="outline-text-3" id="text-orgfd1ccd7">
<p>
リポジトリからリンクを辿れるようになる。でも<a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs</a>上でどうなんだろう。
辿れないけど、人にディレクトリを示すときには使える。今は絶対パスで取って前のを削除している。めんど
い。
うむむ。リモートリポジトリのURLがわかるなら意味はありそう。git-linkとあまり変わらないけどな。
git-linkのコードを見てるけど、まだあまりよくわからない。
</p>
</div>
</div>
<div id="outline-container-orga495f98" class="outline-3">
<h3 id="orga495f98"><a href="#orga495f98"><span class="todo TODO">TODO</span> ホームディレクトリを~で出すようにする</a></h3>
<div class="outline-text-3" id="text-orga495f98">
<p>
今は <code>/home/kijima...</code> で出てるからな。汎用性があまりよくない。あとで絶対変わるし、ほかで使えない。
</p>
</div>
</div>
<div id="outline-container-org20b5904" class="outline-3">
<h3 id="org20b5904"><a href="#org20b5904"><span class="todo TODO">TODO</span> 実行関数を出力</a></h3>
<div class="outline-text-3" id="text-org20b5904">
<p>
たとえばivyのinfoページにいたとする。(info &ldquo;ivy&rdquo;) を出力する。
これを実行するとivyに飛べるので、リンクといえそう。環境も関係ない。
</p>

<p>
infoバッファからの検索キーワードの割り出し方…
実行ディレクトリをdefault-directoryか何かで取る。(.*).infoというファイルがあるはずなのでそのファイル名をinfoの引数に渡す。
</p>
</div>
</div>
</div>
<div id="outline-container-org660de13" class="outline-2">
<h2 id="org660de13"><a href="#org660de13">Archives</a></h2>
<div class="outline-text-2" id="text-org660de13">
</div>
<div id="outline-container-orge26c2d8" class="outline-3">
<h3 id="orge26c2d8"><a href="#orge26c2d8"><span class="done DONE">DONE</span> フックを追加…たとえばリンク生成 → {フック} → コピー前としておく。</a></h3>
<div class="outline-text-3" id="text-orge26c2d8">
<p>
フックでは式が使えるのでなんでもできる。動的にタイムスタンプを加えたり、連番を振ったりとか。単なる文字列フィルターよりはるかに強力。誰かがもっと便利な使い方を編み出してくれる。
</p>

<p>
make-formatと、message+killの前にフックを差し込むか。
でも、文字列を受け取れないからあまり意味ない気がしてきた。
フックはその処理に追加するというより、別の処理を差し込むためのものだ(ある関数を実行すると、別の全く関係ない)モードをオンにするとか。その意味でいうと、フックする処理はまったく思いつかない。
</p>
</div>
</div>
<div id="outline-container-orge97f6db" class="outline-3">
<h3 id="orge97f6db"><a href="#orge97f6db"><span class="done DONE">DONE</span> リンク変換</a></h3>
<div class="outline-text-3" id="text-orge97f6db">
<p>
別のフォーマットに変換するのもあっていいな。
すでに書式があるから、そこからURL, Titleを取り出せればいい。
</p>
<ul class="org-ul">
<li>判定関数</li>
</ul>
<p>
thing-at-pointの拡張だな。フォーマットリンク上にカーソルがある場合、タイトルとURLを取得して変換…。
どのフォーマットか判定できれば、タイトルとURLを取れる。
markdown-mode.elの(markdown-kill-thing-at-point)が参考になりそう。
</p>

<p>
別に独自実装しなくても、各modeのregexpを使えばいいかな。いや、フル装備でめちゃくちゃ複雑だし、いろんな依存(5つも増えるのはさすがに…)があるので独自でやろう。
<a href="https://ayatakesi.github.io/emacs/25.1/Regexps.html">https://ayatakesi.github.io/emacs/25.1/Regexps.html</a>
</p>
</div>
</div>
<div id="outline-container-org620f608" class="outline-3">
<h3 id="org620f608"><a href="#org620f608"><span class="done DONE">DONE</span> フォーマットごとの特殊ルールを追加する</a></h3>
<div class="outline-text-3" id="text-org620f608">
<p>
たとえばlatexの場合、ファイルリンクにはプレフィクスrun:がつくらしい。
今のコードだとファイルリンクだという検知はget-informationでしかできないのでそこに書くしかない。
一般的関数に特定のファイルフォーマットの処理が挟まれると非常に醜い。
なので、最終的な個別変換を分離する。そうするとhtmlがついてないときはrunをつけるとか、好きに追加できるだろう。
</p>
</div>
</div>
<div id="outline-container-org5d1da9d" class="outline-3">
<h3 id="org5d1da9d"><a href="#org5d1da9d"><span class="done DONE">DONE</span> テキスト選択中だと、タイトルに選択したところを入れる</a></h3>
<div class="outline-text-3" id="text-org5d1da9d">
</div>
</div>
<div id="outline-container-orgc442d7d" class="outline-3">
<h3 id="orgc442d7d"><a href="#orgc442d7d"><span class="done DONE">DONE</span> 選択URLにアクセスして、Titleをスクレイピング。リンクを完成させる</a></h3>
<div class="outline-text-3" id="text-orgc442d7d">
</div>
</div>
<div id="outline-container-org6d11fe6" class="outline-3">
<h3 id="org6d11fe6"><a href="#org6d11fe6"><span class="done DONE">DONE</span> 手動で形式選択できるように</a></h3>
<div class="outline-text-3" id="text-org6d11fe6">
<p>
helmから選べたらベスト。選択をどうやってやればいいのかよくわからない
org-roamのファイル選択で出てくるhelmなど参考になりそう。
</p>
</div>
</div>
<div id="outline-container-org79dcf04" class="outline-3">
<h3 id="org79dcf04"><a href="#org79dcf04"><span class="done DONE">DONE</span> とりあえず標準のcompletionだけ追加</a></h3>
<div class="outline-text-3" id="text-org79dcf04">
</div>
</div>
<div id="outline-container-orgf5cc187" class="outline-3">
<h3 id="orgf5cc187"><a href="#orgf5cc187"><span class="done DONE">DONE</span> checkdocをCIで走らせるようにする</a></h3>
<div class="outline-text-3" id="text-orgf5cc187">
<p>
elisp-checkはcask環境のためうまくできない。
なので、elisp-check.elを直に読み込んで実行するようにすればよさそう。
</p>

<p>
elisp-lintというパッケージに同梱されてたのでそれで一気にできるようになった。
</p>
</div>
</div>
<div id="outline-container-orga74d1ad" class="outline-3">
<h3 id="orga74d1ad"><a href="#orga74d1ad"><span class="done DONE">DONE</span> テスト追加 + CI</a></h3>
<div class="outline-text-3" id="text-orga74d1ad">
</div>
</div>
<div id="outline-container-org65c3adb" class="outline-3">
<h3 id="org65c3adb"><a href="#org65c3adb"><span class="done DONE">DONE</span> エクスポート形式増加 HTML,LaTeX,Markdown,MediaWiki,Org-mode</a></h3>
<div class="outline-text-3" id="text-org65c3adb">
</div>
</div>
<div id="outline-container-org10ee67f" class="outline-3">
<h3 id="org10ee67f"><a href="#org10ee67f"><span class="done DONE">DONE</span> ユーザ定義のフィルター … chromeの拡張の方にはある</a></h3>
<div class="outline-text-3" id="text-org10ee67f">
</div>
</div>
<div id="outline-container-org2a0def5" class="outline-3">
<h3 id="org2a0def5"><a href="#org2a0def5"><span class="done DONE">DONE</span> PDF(ページを取ることはできそう。リンクでページ番号を表現できるか)</a></h3>
<div class="outline-text-3" id="text-org2a0def5">
<p>
やらない。
</p>
</div>
</div>
<div id="outline-container-org144789d" class="outline-3">
<h3 id="org144789d"><a href="#org144789d"><span class="done DONE">DONE</span> magit-status-modeのPR/Issueへのリンクを取得</a></h3>
<div class="outline-text-3" id="text-org144789d">
</div>
</div>
<div id="outline-container-org662e782" class="outline-3">
<h3 id="org662e782"><a href="#org662e782"><span class="done DONE">DONE</span> Magit(Gitクライアント)の場合。</a></h3>
<div class="outline-text-3" id="text-org662e782">
<p>
<code>git-link</code> の整形バージョン。
そこまではちょっとやりすぎ感。依存が増えすぎるのも微妙な感じか。でも欲しいよな…。
各PRまではいいけど、少なくともリポジトリのホームページくらいならいいかな。
</p>

<p>
これができるとメモるとき便利なんだよな。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
