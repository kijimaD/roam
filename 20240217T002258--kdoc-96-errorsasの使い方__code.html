<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-04-10 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 96: errors.As()の使い方</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 96: errors.As()の使い方</h1>

<div id="outline-container-org3b89128" class="outline-2">
<h2 id="org3b89128"><a href="#org3b89128">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-org3b89128">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-17 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-25 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga72faea" class="outline-2">
<h2 id="orga72faea"><a href="#orga72faea">概要</a></h2>
<div class="outline-text-2" id="text-orga72faea">
<p>
以前<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>のerrors.Is()を調べたので、今度はerrors.As()を調べる。違いは何だろうか。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>シグネチャ</label><pre class="src src-go">func As(err error, target any) bool
</pre>
</div>

<ul class="org-ul">
<li><a href="https://pkg.go.dev/errors#As">errors package - errors - Go Packages</a></li>
</ul>
</div>
</div>

<div id="outline-container-org1eabc09" class="outline-2">
<h2 id="org1eabc09"><a href="#org1eabc09">ユースケース</a></h2>
<div class="outline-text-2" id="text-org1eabc09">
<p>
まずユースケースを見る。fs.PathErrorはUnwrap()、As()を実装してないので、エラーツリーを辿らず独自判定ロジックで実行しない。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>exampleから</label><pre class="src src-go">if _, err := os.Open("non-existing"); err != nil {
        var pathError *fs.PathError
        if errors.As(err, &amp;pathError) {
                fmt.Println("Failed at path:", pathError.Path)
        } else {
                fmt.Println(err)
        }
}
</pre>
</div>

<pre class="example">
Failed at path: non-existing
</pre>

<p>
errをpathErrorに代入しているように見える。それによって、変数pathErrorのフィールドに値が入って、使えるようになっている。エラーの中身を使いたいとき用ということか。
</p>

<p>
直接取り出せばいいのでは、と考えたがerr.Path
errはos.Open()が返したインターフェース型 <code>error</code> なので、まだ型が未確定。なのでerr.PathはUndefinedになる。型アサーションしてからだとフィールドへアクセスできるようになる。現在コードの状況に限定して、同じようなコードを型アサーションを使って書いた。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>型アサーションで書いた</label><pre class="src src-go">if _, err := os.Open("non-existing"); err != nil {
        var pathError *fs.PathError
        pathError, _ = err.(*fs.PathError)
        if pathError != nil {
                fmt.Println("Failed at path:", pathError.Path)
        } else {
                fmt.Println(err)
        }
}
</pre>
</div>

<pre class="example">
Failed at path: non-existing
</pre>

<p>
↑エラーツリーを辿らない、入力が限定されたもっともシンプルなケースでは、型アサーションでも同じ意味に見える。ただ、見やすさはよくなさそうだ。errors.As()は型アサーションと結果ブーリンアンの返却をシンプルにやってくれる関数、といえそうだ。
</p>

<p>
errors.Is()との違いは、代入を使っていることだ。errの中身を取り出すには、本質的にerrorインターフェースの型を確定して、ターゲットの型を持つ別な変数に代入する必要がある。errors.Is()では <code>==</code> を使って多くの場合ポインタによって、つまりメモリアドレスでエラーの種類を判断していた。したがってIs()で型は全く出てこなかった。As()では代入が関連するので型が重要そうに見える。
</p>

<p>
↓実装を見てみよう。本質的な部分はこのあたりか。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/b8ac61e6e64c92f23d8cf868a92a70d13e20a124/src/errors/wrap.go#L118-L121
</pre>
</div>

<pre class="example">
if reflectlite.TypeOf(err).AssignableTo(targetType) {
	targetVal.Elem().Set(reflectlite.ValueOf(err))
	return true
}
</pre>

<p>
素朴に、err(Asの第1引数)の型がtarget(Asの第2引数)の型へ代入可能であれば、targetの値にerrの値をセットする、に見える。
</p>

<p>
では代入可能とはなにか、なぜ代入時に見慣れない書き方をしているのか、ということになるのだが、深遠なテーマになりそうなのでここでは進まない。
</p>
</div>
</div>

<div id="outline-container-org07e046b" class="outline-2">
<h2 id="org07e046b"><a href="#org07e046b">まとめ</a></h2>
<div class="outline-text-2" id="text-org07e046b">
<p>
Is()とAs()の違いをまとめる。
</p>

<ul class="org-ul">
<li>errors.Is()は単純にエラーを区別する関数。同値性によって判定。どうやって同値とするかは型によって異なるがおおむねポインタ型によるメモリアドレス判定が使われる</li>
<li>errors.As()はエラーを区別しつつ、型アサーションする関数。型の代入可能性によって判定。エラーのフィールドを利用したいときに使う</li>
</ul>
</div>
</div>

<div id="outline-container-org2f12065" class="outline-2">
<h2 id="org2f12065"><a href="#org2f12065">関連</a></h2>
<div class="outline-text-2" id="text-org2f12065">
<ul class="org-ul">
<li><a href="20240210T220439--kdoc-86-errorsisの比較ロジック__code.html#ID-20240210T220439">KDOC 86: errors.Is()の比較ロジック</a>。IsとAsがあるのはなぜか疑問を持ったので調べた</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
