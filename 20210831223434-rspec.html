<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-02-10 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RSpec</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">RSpec</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org661dd4b">概要</a></li>
<li><a href="#orgbacbe49">Memo</a>
<ul>
<li><a href="#orgf2b3da9">within</a></li>
<li><a href="#orgbd20f06">ENVをテストするためのヘルパー</a></li>
<li><a href="#org81ae83d">テスト結果にSQLを出力する</a></li>
<li><a href="#org3729e44">request specでsessionメソッドを使う</a></li>
<li><a href="#org727f1f1">simplecovカバレッジ</a></li>
</ul>
</li>
<li><a href="#orga89d669">たまに失敗するパターン</a>
<ul>
<li><a href="#org9fdd75c">読み込み前に検証して失敗する</a></li>
<li><a href="#orgef9e3cd">並び順に依存したテスト</a></li>
<li><a href="#org08c3bc7">チェックボックス</a></li>
</ul>
</li>
<li><a href="#org7ab6920">Tasks</a></li>
<li><a href="#orgc75a24f">Archives</a></li>
<li><a href="#org85dd9cd">Reference</a>
<ul>
<li><a href="#org410bd3a">ruby on rails - What is the purpose of a `transient do` block in FactoryBot factories? - Stack Overflow</a></li>
<li><a href="#orgf0d0d54">ruby on rails - Check the dimensions of an img with RSpec/Capybara? - Stack Overflow</a></li>
<li><a href="#org0e1dc1c">Better Specs. Testing Guidelines for Developers.</a></li>
<li><a href="#org6f3a9d9">Introduction - rspec-style-guide</a></li>
<li><a href="#org37b67ec">[Ruby] よく使うRspecのレシピ集（Rspec3.3） | DevelopersIO</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org661dd4b" class="outline-2">
<h2 id="org661dd4b"><a href="#org661dd4b">概要</a></h2>
<div class="outline-text-2" id="text-org661dd4b">
<p>
RSpecは<a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a>のテストフレームワーク。<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>開発でよく使われる。
</p>
</div>
</div>
<div id="outline-container-orgbacbe49" class="outline-2">
<h2 id="orgbacbe49"><a href="#orgbacbe49">Memo</a></h2>
<div class="outline-text-2" id="text-orgbacbe49">
</div>
<div id="outline-container-orgf2b3da9" class="outline-3">
<h3 id="orgf2b3da9"><a href="#orgf2b3da9">within</a></h3>
<div class="outline-text-3" id="text-orgf2b3da9">
<p>
セレクトボックスをクリックしてから選択、というような場合capybaraは不安定になることがある。
まだ表示されてないのに、クリックするためにクリックするポイントがずれたりする。
</p>

<p>
安直なのはsleepすることだが、いい方法もある。
親要素全体が表示されてから、クリックする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>withinで親要素が表示されるのを待つ</label><pre class="src src-ruby">within <span class="org-string">'&#35242;&#35201;&#32032;'</span> <span class="org-keyword">do</span>
  find(<span class="org-string">'li'</span>, <span class="org-constant">text:</span> <span class="org-string">'&#12475;&#12524;&#12463;&#12488;&#12508;&#12483;&#12463;&#12473;&#12398;&#20013;&#36523;'</span>).click
<span class="org-keyword">end</span>
</pre>
</div>

<p>
<a href="https://koheisg.dreamin.cc/system_spec/random-failures">system specとそのrandom落ち (flaky test) との戦い</a>
</p>
</div>
</div>
<div id="outline-container-orgbd20f06" class="outline-3">
<h3 id="orgbd20f06"><a href="#orgbd20f06">ENVをテストするためのヘルパー</a></h3>
<div class="outline-text-3" id="text-orgbd20f06">
<p>
ENVを変えてテストしたいときがある。
<a href="https://github.com/rspec/rspec-rails/issues/1279#issuecomment-70275896">https://github.com/rspec/rspec-rails/issues/1279#issuecomment-70275896</a>
ヘルパーを追加する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>helper</label><pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">EnvHelpers</span>
  <span class="org-keyword">def</span> <span class="org-function-name">with_env_vars</span>(vars)
    original = <span class="org-type">ENV</span>.to_hash
    vars.each { |k, v| <span class="org-type">ENV</span>[k] = v }

    <span class="org-keyword">begin</span>
      <span class="org-keyword">yield</span>
    <span class="org-keyword">ensure</span>
      <span class="org-type">ENV</span>.replace(original)
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>rails_helper</label><pre class="src src-ruby"><span class="org-type">RSpec</span>.configure <span class="org-keyword">do</span> |c|
  c.include <span class="org-type">EnvHelpers</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>rspec</label><pre class="src src-ruby">it <span class="org-string">'does something with the FOO environment variable'</span> <span class="org-keyword">do</span>
  with_env_vars <span class="org-string">'FOO'</span> =&gt; <span class="org-string">'bar'</span> <span class="org-keyword">do</span>
    <span class="org-comment-delimiter"># </span><span class="org-comment">logic that depends upon ENV['FOO'] goes here</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org81ae83d" class="outline-3">
<h3 id="org81ae83d"><a href="#org81ae83d">テスト結果にSQLを出力する</a></h3>
<div class="outline-text-3" id="text-org81ae83d">
<p>
どのようなSQLが発行されるか確認できると便利。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>発行クエリを出力する</label><pre class="src src-ruby"><span class="org-type">RSpec</span>.describe <span class="org-keyword">do</span>
  before <span class="org-keyword">do</span>
    <span class="org-type">ActiveRecord</span>::<span class="org-type">Base</span>.logger = <span class="org-type">Logger</span>.new(<span class="org-type">STDOUT</span>)
  <span class="org-keyword">end</span>

  it <span class="org-keyword">do</span>
    ...
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3729e44" class="outline-3">
<h3 id="org3729e44"><a href="#org3729e44">request specでsessionメソッドを使う</a></h3>
<div class="outline-text-3" id="text-org3729e44">
<div class="org-src-container">
<pre class="src src-ruby">allow_any_instance_of(<span class="org-type">ActionDispatch</span>::<span class="org-type">Request</span>).to receive(<span class="org-constant">:session</span>).and_return({})
</pre>
</div>
</div>
</div>
<div id="outline-container-org727f1f1" class="outline-3">
<h3 id="org727f1f1"><a href="#org727f1f1">simplecovカバレッジ</a></h3>
<div class="outline-text-3" id="text-org727f1f1">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-variable-name">COVERAGE</span>=true bundle exec rspec spec/requests/user_spec.rb
open coverage/index.html
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga89d669" class="outline-2">
<h2 id="orga89d669"><a href="#orga89d669">たまに失敗するパターン</a></h2>
<div class="outline-text-2" id="text-orga89d669">
<p>
system specではよくある。
</p>
</div>
<div id="outline-container-org9fdd75c" class="outline-3">
<h3 id="org9fdd75c"><a href="#org9fdd75c">読み込み前に検証して失敗する</a></h3>
<div class="outline-text-3" id="text-org9fdd75c">
<div class="org-src-container">
<pre class="src src-ruby">expect(page).to have_text <span class="org-string">'aaa'</span>, <span class="org-constant">wait:</span> 5 <span class="org-comment-delimiter">#</span><span class="org-comment">&#30330;&#35211;&#12391;&#12365;&#12394;&#12363;&#12387;&#12383;&#12392;&#12365;&#12398;&#26368;&#22823;&#24453;&#12385;&#26178;&#38291;&#12434;&#20280;&#12400;&#12377;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgef9e3cd" class="outline-3">
<h3 id="orgef9e3cd"><a href="#orgef9e3cd">並び順に依存したテスト</a></h3>
<div class="outline-text-3" id="text-orgef9e3cd">
<p>
同じ秒数に作成されたとき、createした順番に並ばない可能性がある。
</p>
<div class="org-src-container">
<pre class="src src-ruby">model1 = create(<span class="org-constant">:model</span>)
model2 = create(<span class="org-constant">:model</span>)
</pre>
</div>
<p>
created_atでソートして表示しているとして、この作成順にソートされるわけではない。
秒数が同じときはidなどがソートに使われるだろう。
1つcreateするのにはわずかな時間なので、たまに失敗するだけで気づきにくい。
</p>
</div>
</div>
<div id="outline-container-org08c3bc7" class="outline-3">
<h3 id="org08c3bc7"><a href="#org08c3bc7">チェックボックス</a></h3>
<div class="outline-text-3" id="text-org08c3bc7">
<p>
チェックに少し時間がかかるのでたまにチェックせずに送信して失敗する。
</p>
<div class="org-src-container">
<pre class="src src-ruby">check aaa
expect(page).to have_checked_field(aaa), wait 5 <span class="org-comment-delimiter"># </span><span class="org-comment">&#12481;&#12455;&#12483;&#12463;&#12434;&#30906;&#35469;&#12377;&#12427;</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org7ab6920" class="outline-2">
<h2 id="org7ab6920"><a href="#org7ab6920">Tasks</a></h2>
</div>
<div id="outline-container-orgc75a24f" class="outline-2">
<h2 id="orgc75a24f"><a href="#orgc75a24f">Archives</a></h2>
</div>
<div id="outline-container-org85dd9cd" class="outline-2">
<h2 id="org85dd9cd"><a href="#org85dd9cd">Reference</a></h2>
<div class="outline-text-2" id="text-org85dd9cd">
</div>
<div id="outline-container-org410bd3a" class="outline-3">
<h3 id="org410bd3a"><a href="#org410bd3a"><a href="https://stackoverflow.com/questions/38573131/what-is-the-purpose-of-a-transient-do-block-in-factorybot-factories">ruby on rails - What is the purpose of a `transient do` block in FactoryBot factories? - Stack Overflow</a></a></h3>
<div class="outline-text-3" id="text-org410bd3a">
<p>
FactoryBotのtransientの使い方。
</p>
</div>
</div>
<div id="outline-container-orgf0d0d54" class="outline-3">
<h3 id="orgf0d0d54"><a href="#orgf0d0d54"><a href="https://stackoverflow.com/questions/20196146/check-the-dimensions-of-an-img-with-rspec-capybara">ruby on rails - Check the dimensions of an img with RSpec/Capybara? - Stack Overflow</a></a></h3>
<div class="outline-text-3" id="text-orgf0d0d54">
<p>
jqueryを使って存在チェックする方法。
</p>
</div>
</div>
<div id="outline-container-org0e1dc1c" class="outline-3">
<h3 id="org0e1dc1c"><a href="#org0e1dc1c"><a href="https://www.betterspecs.org/">Better Specs. Testing Guidelines for Developers.</a></a></h3>
<div class="outline-text-3" id="text-org0e1dc1c">
<p>
RSpecのベストプラクティス集。
</p>
</div>
</div>
<div id="outline-container-org6f3a9d9" class="outline-3">
<h3 id="org6f3a9d9"><a href="#org6f3a9d9"><a href="https://qian-dao-zhen-yi.gitbook.io/rspec-style-guide/">Introduction - rspec-style-guide</a></a></h3>
<div class="outline-text-3" id="text-org6f3a9d9">
<p>
可読性の高いテストコードを書くためのRSpecのスタイルガイド。
</p>
</div>
</div>
<div id="outline-container-org37b67ec" class="outline-3">
<h3 id="org37b67ec"><a href="#org37b67ec"><a href="https://dev.classmethod.jp/articles/rspec-recipe/">[Ruby] よく使うRspecのレシピ集（Rspec3.3） | DevelopersIO</a></a></h3>
<div class="outline-text-3" id="text-org37b67ec">
<p>
RSpec。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
