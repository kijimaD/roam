<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-11-15 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 28: 交通シミュレーションゲームを作る</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 28: 交通シミュレーションゲームを作る</h1>

<div id="outline-container-org7c3107a" class="outline-2">
<h2 id="org7c3107a"><a href="#org7c3107a"><span class="done CLOSE">CLOSE</span> プロジェクトステータス</a></h2>
<div class="outline-text-2" id="text-org7c3107a">
<p>
プロジェクトは終了した。
</p>

<p>
未完成で放置した。
</p>
</div>
</div>

<div id="outline-container-org4097523" class="outline-2">
<h2 id="org4097523"><a href="#org4097523">概要</a></h2>
<div class="outline-text-2" id="text-org4097523">
<p>
<a href="20211107110444-simutrans.html#ID-7c01d791-1479-4727-b076-280034ab6a40">Simutrans</a>のような交通シミュレーションゲームを作成する。
</p>
</div>
</div>
<div id="outline-container-org2b29a52" class="outline-2">
<h2 id="org2b29a52"><a href="#org2b29a52">導入</a></h2>
<div class="outline-text-2" id="text-org2b29a52">
<p>
都市と交通に着目したゲームを作る。
</p>
</div>
</div>
<div id="outline-container-orgc0bd6ef" class="outline-2">
<h2 id="orgc0bd6ef"><a href="#orgc0bd6ef">Tasks</a></h2>
<div class="outline-text-2" id="text-orgc0bd6ef">
</div>
<div id="outline-container-orga744d99" class="outline-3">
<h3 id="orga744d99"><a href="#orga744d99"><span class="todo TODO">TODO</span> 建物をエンティティ化する</a></h3>
<div class="outline-text-3" id="text-orga744d99">
<p>
建物をエンティティとして描画させる。
</p>

<p>
まずECSを導入した。
</p>
</div>
</div>
<div id="outline-container-orgbbaba96" class="outline-3">
<h3 id="orgbbaba96"><a href="#orgbbaba96"><span class="todo TODO">TODO</span> ebiten UIを使う</a></h3>
<div class="outline-text-3" id="text-orgbbaba96">
<p>
扱いづらい方法でやっているので変える。UIというか、別の箇所にも及んでいるので大変そうだ。
</p>

<ul class="org-ul">
<li>ゲームステートによって常時描画するもの(メニュー・アイコンとか)と、動的に変わるもの(デバッグ表示)がある。</li>
<li>デバッグメニューは頻繁に文字が書き換わるわけだが、それをいい感じにやる方法がわからないな
<ul class="org-ul">
<li>再作成すると更新できるが、メモリリークして急速に重くなっていく</li>
<li>Update()でテキストを更新するようなフックが必要</li>
<li>デバッグ表示があったのでそれにした</li>
</ul></li>
<li>日付を書き換える方法がわからない。ボタンはクリック時のハンドラがあるが、時間経過のハンドラはない</li>
</ul>
</div>
</div>

<div id="outline-container-orgf8e7946" class="outline-3">
<h3 id="orgf8e7946"><a href="#orgf8e7946"><span class="todo TODO">TODO</span> UIまわりをECSっぽくする</a></h3>
<div class="outline-text-3" id="text-orgf8e7946">
<p>
UIは全部構造体のフィールドとして持っている項目を描画しているという感じ。ECSっぽくないので変える。
</p>

<p>
前のローグライクでは、コンポーネントをかなり使っていた。UI描画はスタティックメソッドで、mainから呼び出す感じ。mainにあるグローバルなゲームステートによって変わるから、systemにはなくmainから呼び出す感じか。systemだと常時実行という感じ。
</p>
</div>
</div>

<div id="outline-container-org365d8f4" class="outline-3">
<h3 id="org365d8f4"><a href="#org365d8f4"><span class="todo TODO">TODO</span> タイルを1次元配列にする</a></h3>
<div class="outline-text-3" id="text-org365d8f4">
<ul class="org-ul">
<li>3次元は必要ない</li>
<li>2次元もループを回す手間がかかるので、1次元に入れる。ヘルパーを用意すれば扱いやすくなる</li>
</ul>
</div>
</div>
<div id="outline-container-org9fcf3f0" class="outline-3">
<h3 id="org9fcf3f0"><a href="#org9fcf3f0"><span class="todo TODO">TODO</span> 連続建設と単体建設を分ける</a></h3>
<div class="outline-text-3" id="text-org9fcf3f0">
<p>
道路系は範囲建設だが、建物系は単体建設になる。
</p>
</div>
</div>
<div id="outline-container-org136ea99" class="outline-3">
<h3 id="org136ea99"><a href="#org136ea99"><span class="todo TODO">TODO</span> バス停の詳細情報を見られるようにする</a></h3>
<div class="outline-text-3" id="text-org136ea99">
<p>
建設物の情報を保存する。
</p>

<p>
エンティティ化したあとにやる。
</p>
</div>
</div>
<div id="outline-container-org79db836" class="outline-3">
<h3 id="org79db836"><a href="#org79db836"><span class="todo TODO">TODO</span> 地形に付随したものをチェックできるようにする</a></h3>
<div class="outline-text-3" id="text-org79db836">
<p>
デバッグしやすくする。
</p>
</div>
</div>
<div id="outline-container-org7ec3fa0" class="outline-3">
<h3 id="org7ec3fa0"><a href="#org7ec3fa0"><span class="todo TODO">TODO</span> バス停に名前がつくようにする</a></h3>
<div class="outline-text-3" id="text-org7ec3fa0">
</div>
</div>

<div id="outline-container-org9a0ad26" class="outline-3">
<h3 id="org9a0ad26"><a href="#org9a0ad26"><span class="todo TODO">TODO</span> ebitenUIを使う</a></h3>
<div class="outline-text-3" id="text-org9a0ad26">
<p>
オレオレUIだからあまり綺麗じゃない。
</p>
</div>
</div>
<div id="outline-container-org9114dbc" class="outline-3">
<h3 id="org9114dbc"><a href="#org9114dbc"><span class="todo TODO">TODO</span> オブジェクトを道路上に走らせる</a></h3>
<div class="outline-text-3" id="text-org9114dbc">
<p>
つながっている道路だけ走れる。
</p>
</div>
</div>
<div id="outline-container-org1c17aa3" class="outline-3">
<h3 id="org1c17aa3"><a href="#org1c17aa3"><span class="todo TODO">TODO</span> 高さについて考える</a></h3>
<div class="outline-text-3" id="text-org1c17aa3">
<p>
どうすればいいのか見当もつかない。
</p>
</div>
</div>
<div id="outline-container-orgdd8c1e1" class="outline-3">
<h3 id="orgdd8c1e1"><a href="#orgdd8c1e1"><span class="todo TODO">TODO</span> つながっているを表現する(平面)</a></h3>
<div class="outline-text-3" id="text-orgdd8c1e1">
<ul class="org-ul">
<li>経路探索ライブラリがあるので、そんなに難しくない可能性がある</li>
<li>毎回道路に走るたびに乗り物に計算させてつながっているかは判定させればよさそう。つながっているかはベースの座標によって変わるので。</li>
</ul>
</div>
</div>
<div id="outline-container-org2269218" class="outline-3">
<h3 id="org2269218"><a href="#org2269218"><span class="todo TODO">TODO</span> つながっているを表現する(立体)</a></h3>
<div class="outline-text-3" id="text-org2269218">
<p>
異なる高さの道路は接続できない。スロープでしかつながらない。
</p>
</div>
</div>
<div id="outline-container-org030e0eb" class="outline-3">
<h3 id="org030e0eb"><a href="#org030e0eb"><span class="todo TODO">TODO</span> 道路の方向を自動決定する</a></h3>
<div class="outline-text-3" id="text-org030e0eb">
<p>
エンティティ化した後にやる。
</p>

<p>
設置したときに周囲8マスの状態に応じて画像を変化させる。横にあれば曲がるアイコンになるだろう。
</p>
</div>
</div>
</div>

<div id="outline-container-org50791c7" class="outline-2">
<h2 id="org50791c7"><a href="#org50791c7">参考</a></h2>
<div class="outline-text-2" id="text-org50791c7">
<p>
参考になりそうなリンクを書いておく。
</p>

<p>
タイルマップパーサ。
<a href="https://github.com/lafriks/go-tiled">lafriks/go-tiled: Go library to parse Tiled map editor file format (TMX) and render map to image</a>
</p>

<p>
都市ゲーム。
<a href="https://code.rocket9labs.com/tslocum/citylimits">tslocum/citylimits: City-building simulation video game - citylimits - Rocket Nine Labs</a>
</p>

<p>
経路探索ライブラリ。
<a href="https://github.com/beefsack/go-astar">beefsack/go-astar: Go implementation of the A* search algorithm</a>
</p>
</div>
</div>
<div id="outline-container-org0203cdb" class="outline-2">
<h2 id="org0203cdb"><a href="#org0203cdb">Archives</a></h2>
<div class="outline-text-2" id="text-org0203cdb">
</div>
<div id="outline-container-orgfac604e" class="outline-3">
<h3 id="orgfac604e"><a href="#orgfac604e"><span class="done DONE">DONE</span> ベースを作る</a></h3>
<div class="outline-text-3" id="text-orgfac604e">
<p>
参考コードを元にする。不要そうなところを削除していく。
</p>

<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> タイルセットを変えた</li>
</ul>
</div>
</div>
<div id="outline-container-orgf030523" class="outline-3">
<h3 id="orgf030523"><a href="#orgf030523"><span class="done DONE">DONE</span> 道路画像を登録する</a></h3>
<div class="outline-text-3" id="text-orgf030523">
<ul class="org-ul">
<li>後から追加する方法がわからない</li>
<li>描いたほうがはやそう
<ul class="org-ul">
<li>gimpで追加した</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7e50577" class="outline-3">
<h3 id="org7e50577"><a href="#org7e50577"><span class="done DONE">DONE</span> ブルドーザーアイコンが消えた</a></h3>
<div class="outline-text-3" id="text-org7e50577">
<p>
タイルセットの更新を忘れていたっぽい。Tilesで保存し直したら差分が出て直った。
</p>
</div>
</div>
<div id="outline-container-org2f039d7" class="outline-3">
<h3 id="org2f039d7"><a href="#org2f039d7"><span class="done DONE">DONE</span> バス停を作る</a></h3>
<div class="outline-text-3" id="text-org2f039d7">
<p>
とりあえず画像は後回しにして、追加してみる。
</p>
</div>
</div>
<div id="outline-container-org2f2e1ed" class="outline-3">
<h3 id="org2f2e1ed"><a href="#org2f2e1ed"><span class="done DONE">DONE</span> コード整理</a></h3>
<div class="outline-text-3" id="text-org2f2e1ed">
<p>
全体ざっくり読んでみる。
</p>
</div>
</div>
<div id="outline-container-orgec56142" class="outline-3">
<h3 id="orgec56142"><a href="#orgec56142"><span class="done DONE">DONE</span> 自動リリース</a></h3>
<div class="outline-text-3" id="text-orgec56142">
<p>
設定する。
</p>
</div>
</div>
<div id="outline-container-org9f333c8" class="outline-3">
<h3 id="org9f333c8"><a href="#org9f333c8"><span class="done DONE">DONE</span> CIチェック</a></h3>
<div class="outline-text-3" id="text-org9f333c8">
<p>
ライブラリの依存関係が多いので、イメージを作成する。
</p>
</div>
</div>
<div id="outline-container-org9ff5eb2" class="outline-3">
<h3 id="org9ff5eb2"><a href="#org9ff5eb2"><span class="done DONE">DONE</span> バス停の位置がずれている</a></h3>
<div class="outline-text-3" id="text-org9ff5eb2">
<p>
設置時にカーソルとずれているのを直す。
</p>

<p>
建物は高さが違う。描画時に高く表示されていた。
</p>
</div>
</div>
<div id="outline-container-orgefa691c" class="outline-3">
<h3 id="orgefa691c"><a href="#orgefa691c"><span class="done DONE">DONE</span> バス停を道路と重ねられるようにする</a></h3>
<div class="outline-text-3" id="text-orgefa691c">
<p>
透過して重ねる。
</p>

<ul class="org-ul">
<li>TilesとTilesImage</li>
</ul>
</div>
</div>
<div id="outline-container-org238a662" class="outline-3">
<h3 id="org238a662"><a href="#org238a662"><span class="done DONE">DONE</span> セルの大きさを統一する</a></h3>
<div class="outline-text-3" id="text-org238a662">
<p>
今はスナップの精度が違うのでずれる。同じように建設してもずれる。
</p>

<ul class="org-ul">
<li>道路を4マスから1マスにした。自分で建てる建物は1マスでいいだろう。</li>
</ul>
</div>
</div>
<div id="outline-container-orgd21d652" class="outline-3">
<h3 id="orgd21d652"><a href="#orgd21d652"><span class="done DONE">DONE</span> タイル画像を直接触っている部分があり扱いにくい</a></h3>
<div class="outline-text-3" id="text-orgd21d652">
<p>
タイル画像が平原なら〜という箇所が大量に存在する。タイル画像ではなくオブジェクトで判定したいよな。
</p>

<ul class="org-ul">
<li>地形もオブジェクトとする(エンティティではない)</li>
<li>建物もエンティティとする
<ul class="org-ul">
<li>Renderコンポートネントを登録して描画する</li>
</ul></li>
<li>diggerではタイルは配列で表現されていた。2次元配列ではない。そうだ、タイルに関しては3次元でなくてよい。各座標に1つしかないのだから</li>
<li>タイルは配列にする</li>
<li>描画エンティティが座標と高さを持つようにする</li>
</ul>
</div>
</div>
<div id="outline-container-org64885f0" class="outline-3">
<h3 id="org64885f0"><a href="#org64885f0"><span class="done CLOSE">CLOSE</span> マップと同じにできないのか</a></h3>
<div class="outline-text-3" id="text-org64885f0">
<p>
属性とマップの画像を別々に持っている。いちいちfor文で取り出している。
</p>
</div>
</div>
<div id="outline-container-org23dfe9a" class="outline-3">
<h3 id="org23dfe9a"><a href="#org23dfe9a"><span class="done DONE">DONE</span> バス停を道路上だけに建設できるようにする</a></h3>
<div class="outline-text-3" id="text-org23dfe9a">
<p>
tiletype分岐させることで、バス停を道路上へ建設できるようになった。
</p>
</div>
</div>
<div id="outline-container-orgfd2bb00" class="outline-3">
<h3 id="orgfd2bb00"><a href="#orgfd2bb00"><span class="done DONE">DONE</span> デプロイする</a></h3>
<div class="outline-text-3" id="text-orgfd2bb00">
<p>
先例があるので簡単にできそう。
</p>
</div>
</div>
<div id="outline-container-org437b3b3" class="outline-3">
<h3 id="org437b3b3"><a href="#org437b3b3"><span class="done DONE">DONE</span> ECSまわりのコードを読む</a></h3>
<div class="outline-text-3" id="text-org437b3b3">
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
