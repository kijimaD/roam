<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-11-27T23:05:58Z -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 69: 『Go compiler intrinsics』</title>
<meta name="author" content="kijimaD" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 69: 『Go compiler intrinsics』</h1>
<div id="outline-container-org914de9f" class="outline-2">
<h2 id="org914de9f"><a href="#org914de9f">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-org914de9f">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-04 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-06 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org46a3ea1" class="outline-2">
<h2 id="org46a3ea1"><a href="#org46a3ea1">概要</a></h2>
<div class="outline-text-2" id="text-org46a3ea1">
<p>
<a href="https://dave.cheney.net/2019/08/20/go-compiler-intrinsics">Go compiler intrinsics | Dave Cheney</a>を読んだメモ。
</p>

<p>
コンパイラには、intrinsic(組み込み関数)という機能がある。組み込みで用意された関数によって高速に処理できる。アセンブラのレベルでCPUに最適化されたアルゴリズムを用いることで、高速化できる。Goではアセンブラで関数の本体を書くのをサポートしている。しかし、アセンブラを直に書くのは大変なので、コンパイラが組み込み関数として用意してくれている。
</p>
</div>
</div>
<div id="outline-container-org44ee8f9" class="outline-2">
<h2 id="org44ee8f9"><a href="#org44ee8f9">メモ</a></h2>
<div class="outline-text-2" id="text-org44ee8f9">
<ul class="org-ul">
<li><a href="20230321002724-assembly_language.html#ID-e9a608aa-8545-42be-90bb-303097800a85">assembly language</a>で書いてもインライン展開されないので遅い。アセンブラで書く代わりに、組み込み関数が用意されている
<ul class="org-ul">
<li><a href="https://ja.wikipedia.org/wiki/%E3%82%A4%E3%83%B3%E3%83%A9%E3%82%A4%E3%83%B3%E5%B1%95%E9%96%8B">インライン展開 - Wikipedia</a></li>
</ul></li>
<li>組み込み関数はGoで書かれている</li>
<li>特定分野に重要な演算はCPUネイティブな命令がサポートされている。それを使うことで高速になる
<ul class="org-ul">
<li>暗号とか圧縮分野</li>
</ul></li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>組み込み関数</label><pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/2eca0b1e1663d826893b6b1fd8bd89da98e65d1e/src/math/bits/bits.go#L116-L122
</pre>
</div>

<div class="results" id="org9ffb052">
<p>
// OnesCount returns the number of one bits (&ldquo;population count&rdquo;) in x.
func OnesCount(x uint) int {
	if UintSize == 32 {
		return OnesCount32(uint32(x))
	}
	return OnesCount64(uint64(x))
}
</p>

</div>

<ul class="org-ul">
<li>OnesCount組み込み関数を使ったとき発行されるアセンブラを見ると、POPCNT命令があるのを確認できる。これがCPUネイティブの命令である</li>
<li>CMPB命令で、CPUがPOPCNT命令をネイティブサポートしているか事前チェックしている</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>アトミックインクリメント</label><pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/2eca0b1e1663d826893b6b1fd8bd89da98e65d1e/src/sync/atomic/type.go#L87-L88
</pre>
</div>

<div class="results" id="org5a95a52">
<p>
// Add atomically adds delta to x and returns the new value.
func (x *Int32) Add(delta int32) (new int32) { return AddInt32(&amp;x.v, delta) }
</p>

</div>

<ul class="org-ul">
<li>CPUのアトミックインクリメントは、競合を回避するために設計された操作。同じ変数を同時にインクリメントしようとしても正確にインクリメントできる。CPUの命令セットで用意されているため安全かつコストを少なく操作できる</li>
<li>アトミックカウンタのコードを書くとLOCK命令が発行されることを確認できる</li>
<li>コンパイラはCPUネイティブの命令がサポートされてないときは、フォールバックしてピュアGoコードの操作を使う</li>
</ul>
</div>
</div>
<div id="outline-container-org8802eef" class="outline-2">
<h2 id="org8802eef"><a href="#org8802eef">関連</a></h2>
<div class="outline-text-2" id="text-org8802eef">
<ul class="org-ul">
<li><a href="20231014T125935--kdoc-45-プログラミング言語の内部的な違いをアセンブリから調べる__wiki.html#ID-20231014T125935">KDOC 45: プログラミング言語の内部的な違いをアセンブリから調べる</a>。発行する命令を確認する方法は正しそう</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
