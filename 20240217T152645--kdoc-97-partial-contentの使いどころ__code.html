<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-04-09 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 97: Partial Contentの使いどころ</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 97: Partial Contentの使いどころ</h1>

<div id="outline-container-org347f9f4" class="outline-2">
<h2 id="org347f9f4"><a href="#org347f9f4">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-org347f9f4">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-17 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-02-25 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org4028883" class="outline-2">
<h2 id="org4028883"><a href="#org4028883">概要</a></h2>
<div class="outline-text-2" id="text-org4028883">
<p>
CDNのリクエストログを見ていて、HTTPステータスが <code>200</code> に混じって <code>206</code> があった。これが何かを教えてもらったのでメモする。
</p>
</div>
</div>

<div id="outline-container-org81b1c56" class="outline-2">
<h2 id="org81b1c56"><a href="#org81b1c56">イントロ</a></h2>
<div class="outline-text-2" id="text-org81b1c56">
<p>
ドキュメントを見る。
</p>

<p>
<a href="https://developer.mozilla.org/ja/docs/Web/HTTP/Status/206">206 Partial Content - HTTP | MDN</a>
</p>

<blockquote>
<p>
HTTP 206 Partial Content は成功ステータスレスポンスコードで、そのリクエストが成功したこと、そしてリクエストの Range ヘッダーに記述された通り、要求された範囲のデータが本文に含まれていることを示します。
</p>
</blockquote>

<p>
このユースケースはどういうときか。
</p>

<ul class="org-ul">
<li><p>
URLが画像だった場合にプレビュー画像を表示したいとき
</p>

<p>
Slackなんかにある機能。先にそのURLへアクセスして、一部だけ取得する(画像の場合バイナリ)。一部取得したファイルを、ファイルヘッダをチェックして判定する。プレビューできるとなったら、もう一度リクエストしてファイル全体を取得して、プレビュー画像としてセットする。1回めのチェックリクエストの段階ですべて取得する意味はないので、ファイルの一部だけを取得してくる。
</p></li>

<li><p>
動画再生
</p>

<p>
途中から再生しているのに、動画ファイルの最初からダウンロードを開始するのは意味がない。ファイルのある範囲を指定することで、一部だけダウンロードしている。再生位置から20秒間分ダウンロードする、みたいな感じでダウンロードを断続的に走らせることでリソースの無駄をなくし、どこからでも再生できる。
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org14bb73c" class="outline-2">
<h2 id="org14bb73c"><a href="#org14bb73c">検証</a></h2>
<div class="outline-text-2" id="text-org14bb73c">
<p>
実際の動きを<a href="20240210130812-curl.html#ID-b11fb9a4-0a26-4354-bc60-6c755c256b21">curl</a>で確かめる。リンク先のバイナリのファイルヘッダを確認するシチュエーション。対応してないサーバでやってもRange指定は無視されるだけなので、<a href="20210926100207-wikipedia.html#ID-39f0af27-f685-4ce5-beac-a3398f648ba4">Wikipedia</a>のメディアサーバで確かめる。
</p>

<p>
まず、範囲指定しない場合。画像ファイル全体をダウンロードする。種別を確認したいだけなのにもったいない。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>画像バイナリを取得してチェックする</label><pre class="src src-shell"><span class="org-variable-name">tmpfile</span>=$(mktemp)
<span class="org-variable-name">result</span>=<span class="org-sh-quoted-exec">`curl -v --output $tmpfile https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Wikipedia-logo-v2.svg/100px-Wikipedia-logo-v2.svg.png`</span>
file -b --mime-type $<span class="org-variable-name">tmpfile</span>
rm $<span class="org-variable-name">tmpfile</span>
</pre>
</div>

<pre class="example">
image/png
</pre>

<p>
↓このときのリクエスト+レスポンスはこうなる。
</p>

<pre class="example">
&gt; GET /wikipedia/commons/thumb/8/80/Wikipedia-logo-v2.svg/100px-Wikipedia-logo-v2.svg.png HTTP/2
&gt; Host: upload.wikimedia.org
&gt; User-Agent: curl/8.4.0
&gt; Accept: */*
&gt;

&lt; HTTP/2 200 👈
&lt; date: Sat, 17 Feb 2024 02:23:17 GMT
&lt; etag: c4e5e81aa0475e2f1dae37acfadacd6c
&lt; server: ATS/9.1.4
&lt; content-type: image/png
&lt; content-disposition: inline;filename*=UTF-8''Wikipedia-logo-v2.svg.png
&lt; last-modified: Sun, 10 Sep 2023 12:27:10 GMT
&lt; content-length: 14729 👈
&lt; age: 16405
&lt; x-cache: cp5032 miss, cp5032 hit/117
&lt; x-cache-status: hit-front
&lt; server-timing: cache;desc="hit-front", host;desc="cp5032"
&lt; strict-transport-security: max-age=106384710; includeSubDomains; preload
&lt; report-to: { "group": "wm_nel", "max_age": 604800, "endpoints": [{ "url": "https://intake-logging.wikimedia.org/v1/events?stream=w3c.reportingapi.network_error&amp;schema_uri=/w3c/reportingapi/network_error/1.0.0" }] }
&lt; nel: { "report_to": "wm_nel", "max_age": 604800, "failure_fraction": 0.05, "success_fraction": 0.0}
&lt; x-client-ip: 240b:10:91c1:d500:877b:f95b:ff57:d2fc
&lt; x-content-type-options: nosniff
&lt; access-control-allow-origin: *
&lt; access-control-expose-headers: Age, Date, Content-Length, Content-Range, X-Content-Duration, X-Cache
&lt; timing-allow-origin: *
&lt; accept-ranges: bytes
&lt;
</pre>

<ul class="org-ul">
<li>HTTPステータス200を返している</li>
<li>content-lengthは1万を超えている</li>
</ul>

<p>
次に、Rangeを指定して結果を比較する。一部だけ取得するので無駄な資源を使わず環境に優しい。curlでは <code>r</code> オプションを使って指定する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>範囲を指定する</label><pre class="src src-shell"><span class="org-variable-name">tmpfile</span>=$(mktemp)
<span class="org-variable-name">result</span>=<span class="org-sh-quoted-exec">`curl -v --output $tmpfile -r 0-100 https://upload.wikimedia.org/wikipedia/commons/thumb/8/80/Wikipedia-logo-v2.svg/100px-Wikipedia-logo-v2.svg.png`</span>
file -b --mime-type $<span class="org-variable-name">tmpfile</span>
rm $<span class="org-variable-name">tmpfile</span>
</pre>
</div>

<pre class="example">
image/png
</pre>

<p>
↑ファイルタイプはファイルヘッダーにあるので、バイナリが一部だけでも判定できるのを確認できた。
</p>

<p>
↓このときのリクエスト+レスポンスはこうなる。
</p>

<pre class="example">
&gt; GET /wikipedia/commons/thumb/8/80/Wikipedia-logo-v2.svg/100px-Wikipedia-logo-v2.svg.png HTTP/2
&gt; Host: upload.wikimedia.org
&gt; Range: bytes=0-100 👈
&gt; User-Agent: curl/8.4.0
&gt; Accept: */*
&gt;
&lt; HTTP/2 206 👈
&lt; date: Sat, 17 Feb 2024 02:23:17 GMT
&lt; etag: c4e5e81aa0475e2f1dae37acfadacd6c
&lt; server: ATS/9.1.4
&lt; content-type: image/png
&lt; content-disposition: inline;filename*=UTF-8''Wikipedia-logo-v2.svg.png
&lt; last-modified: Sun, 10 Sep 2023 12:27:10 GMT
&lt; age: 18113
&lt; x-cache: cp5032 miss, cp5032 hit/128
&lt; x-cache-status: hit-front
&lt; server-timing: cache;desc="hit-front", host;desc="cp5032"
&lt; strict-transport-security: max-age=106384710; includeSubDomains; preload
&lt; report-to: { "group": "wm_nel", "max_age": 604800, "endpoints": [{ "url": "https://intake-logging.wikimedia.org/v1/events?stream=w3c.reportingapi.network_error&amp;schema_uri=/w3c/reportingapi/network_error/1.0.0" }] }
&lt; nel: { "report_to": "wm_nel", "max_age": 604800, "failure_fraction": 0.05, "success_fraction": 0.0}
&lt; x-client-ip: 240b:10:91c1:d500:877b:f95b:ff57:d2fc
&lt; x-content-type-options: nosniff
&lt; access-control-allow-origin: *
&lt; access-control-expose-headers: Age, Date, Content-Length, Content-Range, X-Content-Duration, X-Cache
&lt; timing-allow-origin: *
&lt; accept-ranges: bytes
&lt; content-range: bytes 0-100/14729
&lt; content-length: 101 👈
&lt;
</pre>

<ul class="org-ul">
<li>リクエストヘッダーにRangeヘッダーが追加された</li>
<li>HTTPステータス206を返している</li>
<li>content-lengthが指定したサイズになっている</li>
</ul>

<p>
ということで、リソースの一部だけ必要なときは206を使う。
</p>
</div>
</div>

<div id="outline-container-org29a73b9" class="outline-2">
<h2 id="org29a73b9"><a href="#org29a73b9">関連</a></h2>
<div class="outline-text-2" id="text-org29a73b9">
<ul class="org-ul">
<li><a href="20240209T111023--kdoc-83-corsを確認する__code.html#ID-20240209T111023">KDOC 83: CORSを確認する方法</a>。curlで調べるつながり</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
