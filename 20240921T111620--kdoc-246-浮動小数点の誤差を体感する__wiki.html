<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-11-13 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 246: 浮動小数点の誤差を体感する</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../roam/css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 246: 浮動小数点の誤差を体感する</h1>

<div id="outline-container-org0db2431" class="outline-2">
<h2 id="org0db2431"><a href="#org0db2431">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-org0db2431">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-09-21 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-10-05 貴島</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org6c1110a" class="outline-2">
<h2 id="org6c1110a"><a href="#org6c1110a">概要</a></h2>
<div class="outline-text-2" id="text-org6c1110a">
<p>
本を読んでいて、浮動小数点数で数値比較してはいけない、とあった。代数的に等しくても、誤差によってビット全体を比較すると等しくならないことがある。確かめてみる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>誤差を確かめる</label><pre class="src src-C"><span class="org-type">void</span> <span class="org-function-name">calc</span>(<span class="org-type">double</span> <span class="org-variable-name">original</span>, <span class="org-type">double</span> <span class="org-variable-name">d1</span>, <span class="org-type">char</span> <span class="org-variable-name">ope</span>, <span class="org-type">double</span> <span class="org-variable-name">d2</span>) {
  <span class="org-type">double</span> <span class="org-variable-name">result</span>;
  <span class="org-keyword">switch</span> (ope) {
  <span class="org-keyword">case</span> <span class="org-string">'+'</span>:
    result = d1 + d2;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">'-'</span>:
    result = d1 - d2;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">'*'</span>:
    result = d1 * d2;
    <span class="org-keyword">break</span>;
  <span class="org-keyword">case</span> <span class="org-string">'/'</span>:
    result = d1 / d2;
    <span class="org-keyword">break</span>;
  };

  printf(<span class="org-string">"%s"</span>, <span class="org-string">"&#9487; &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; &#9491;\n"</span>);
  printf(<span class="org-string">"original: \t%.55f\nresult: \t%.55f\n  - d1: \t%.55f\n  - ope: \t%c\n  - d2: \t%.55f\n"</span>, original, result, d1, ope, d2);
  printf(<span class="org-string">"equal? =&gt; %d\n"</span>, (original == result));
  printf(<span class="org-string">"%s"</span>, <span class="org-string">"&#9495; &#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472;&#9472; &#9499;\n\n"</span>);
};

calc(0.1, 0.05, <span class="org-string">'+'</span>, 0.05);
calc(1, 0.5, <span class="org-string">'+'</span>, 0.5);
calc(0.3, 0.1, <span class="org-string">'+'</span>, 0.2);
calc(0.1, 0.09, <span class="org-string">'+'</span>, 0.01);
calc(0.01, 0.23, <span class="org-string">'-'</span>, 0.22);
calc(0.1, 1.0, <span class="org-string">'-'</span>, 0.9);
</pre>
</div>

<pre class="example">
┏ ─────────────────────────────────────────────────────────────────── ┓
original: 	0.1000000000000000055511151231257827021181583404541015625
result: 	0.1000000000000000055511151231257827021181583404541015625
  - d1: 	0.0500000000000000027755575615628913510590791702270507812
  - ope: 	+
  - d2: 	0.0500000000000000027755575615628913510590791702270507812
equal? =&gt; 1
┗ ─────────────────────────────────────────────────────────────────── ┛

┏ ─────────────────────────────────────────────────────────────────── ┓
original: 	1.0000000000000000000000000000000000000000000000000000000
result: 	1.0000000000000000000000000000000000000000000000000000000
  - d1: 	0.5000000000000000000000000000000000000000000000000000000
  - ope: 	+
  - d2: 	0.5000000000000000000000000000000000000000000000000000000
equal? =&gt; 1
┗ ─────────────────────────────────────────────────────────────────── ┛

┏ ─────────────────────────────────────────────────────────────────── ┓
original: 	0.2999999999999999888977697537484345957636833190917968750
result: 	0.3000000000000000444089209850062616169452667236328125000
  - d1: 	0.1000000000000000055511151231257827021181583404541015625
  - ope: 	+
  - d2: 	0.2000000000000000111022302462515654042363166809082031250
equal? =&gt; 0
┗ ─────────────────────────────────────────────────────────────────── ┛

┏ ─────────────────────────────────────────────────────────────────── ┓
original: 	0.1000000000000000055511151231257827021181583404541015625
result: 	0.0999999999999999916733273153113259468227624893188476562
  - d1: 	0.0899999999999999966693309261245303787291049957275390625
  - ope: 	+
  - d2: 	0.0100000000000000002081668171172168513294309377670288086
equal? =&gt; 0
┗ ─────────────────────────────────────────────────────────────────── ┛

┏ ─────────────────────────────────────────────────────────────────── ┓
original: 	0.0100000000000000002081668171172168513294309377670288086
result: 	0.0100000000000000088817841970012523233890533447265625000
  - d1: 	0.2300000000000000099920072216264088638126850128173828125
  - ope: 	-
  - d2: 	0.2200000000000000011102230246251565404236316680908203125
equal? =&gt; 0
┗ ─────────────────────────────────────────────────────────────────── ┛

┏ ─────────────────────────────────────────────────────────────────── ┓
original: 	0.1000000000000000055511151231257827021181583404541015625
result: 	0.0999999999999999777955395074968691915273666381835937500
  - d1: 	1.0000000000000000000000000000000000000000000000000000000
  - ope: 	-
  - d2: 	0.9000000000000000222044604925031308084726333618164062500
equal? =&gt; 0
┗ ─────────────────────────────────────────────────────────────────── ┛

</pre>

<p>
末尾付近にある数値によって桁上がりした場合に、大きな誤差となることがあるのだが、末尾の数値はなぜ出てくるのだろうか。2進数で表現できないというのはわかるのだが、小数第20位まで辿らないと見えないような値なのはなぜなのだろう。
</p>

<p>
0.5は2^(-1)なので、正確に表現できる。小数以下の数字は現れない。
</p>
</div>
</div>

<div id="outline-container-orgf50080b" class="outline-2">
<h2 id="orgf50080b"><a href="#orgf50080b">関連</a></h2>
<div class="outline-text-2" id="text-orgf50080b">
<ul class="org-ul">
<li><a href="20240617T152502--kdoc-192-『write-great-code-vol1』__draft_book.html#ID-20240617T152502">KDOC 192: 『Write Great Code Vol.1』</a>。例を確かめた</li>
<li><a href="20240827T003657--kdoc-229-浮動小数点を手計算する__wiki.html#ID-20240827T003657">KDOC 229: 浮動小数点を手計算する</a>。浮動小数点で関連している</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
