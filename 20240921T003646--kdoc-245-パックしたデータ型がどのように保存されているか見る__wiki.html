<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-06-14 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 245: パックしたデータ型がどのように保存されているか見る</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 245: パックしたデータ型がどのように保存されているか見る</h1>
<div id="outline-container-org7f4e964" class="outline-2">
<h2 id="org7f4e964"><a href="#org7f4e964">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-org7f4e964">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-09-21 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-10-28 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org1217853" class="outline-2">
<h2 id="org1217853"><a href="#org1217853">概要</a></h2>
<div class="outline-text-2" id="text-org1217853">
<p>
<a href="20210911104632-c_language.html#ID-656a0aa4-e5d3-416f-82d5-f909558d0639">C言語</a>では、構造体のフィールドにビットフィールドを指定することで、ビット単位の最小サイズを指定しメモリ領域を節約できる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>通常20バイトになる構造体が、詰めて4バイトになる</label><pre class="src src-C"><span class="org-keyword">struct</span> <span class="org-type">normal</span> {
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits0_3</span>;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits4_11</span>;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits12_15</span>;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits16_23</span>;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits24_31</span>;
};

<span class="org-comment-delimiter">// </span><span class="org-comment">&#12467;&#12531;&#12497;&#12452;&#12521;&#12364;&#21106;&#12426;&#24403;&#12390;&#12427;&#26368;&#23567;&#12499;&#12483;&#12488;&#25968;&#12434;&#25351;&#23450;&#12377;&#12427;</span>
<span class="org-keyword">struct</span> <span class="org-type">packed</span> {
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits0_3</span> :4;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits4_11</span> :8;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits12_15</span> :4;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits16_23</span> :8;
  <span class="org-type">unsigned</span> <span class="org-variable-name">bits24_31</span> :8;
};

<span class="org-keyword">struct</span> <span class="org-type">normal</span> <span class="org-variable-name">nor</span> = {1, 2, 3, 4, 5};
<span class="org-keyword">struct</span> <span class="org-type">packed</span> <span class="org-variable-name">pac</span> = {1, 2, 3, 4, 5};

printf(<span class="org-string">"nor: %zu byte\n"</span>,<span class="org-keyword">sizeof</span>(nor));
printf(<span class="org-string">"pac: %zu byte\n"</span>,<span class="org-keyword">sizeof</span>(pac));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">nor: 20 byte
pac: 4 byte
</pre>
</div>

<p>
アセンブリでどのように保存されているか見る。
</p>

<iframe width="800px" height="400px" src="https://godbolt.org/e#z:OYLghAFBqd5QCxAYwPYBMCmBRdBLAF1QCcAaPECAMzwBtMA7AQwFtMQByARg9KtQYEAysib0QXACx8BBAKoBnTAAUAHpwAMvAFYTStJg1AB9U8lJL6yAngGVG6AMKpaAVxYMJANlIOAMngMmABy7gBGmMQSABykAA6oCoS2DM5uHt7xickCAUGhLBFRXLGWmNYpQgRMxARp7p5cPmUVAlU1BHkh4ZExFtW19RlN/R1dBUUxAJQWqK7EyOwcgQQA1CxMgRBTqwCkAOwAQrsaAIKrqwoExK7WqwwkG7R7RyfnF6uuDEnAQeirYUICg0xgAzLtQcczh9Pt88L9MP9AQQFJJjFwuBCoe8Ll8fn8AUCuAAmdEAVixbxhePhBORCiaxmJ4MhVI%2BNIRSKBxLRoMxrOhLwAIpSzmyrjc7nEmMgANaIl7Y6lwzmElEg0GrECSUU42H4hX0tEYrXRXXKg1clEk8lanUCvUculErxMzUgM0Oi20w3c3lcU3m4W68XXW5rB7EJ6rJh7UFCxVcUirYnJ0HJ6SrCn7EVey5hqUy%2BVIuMJg6HJMptMZ5PZ3PYg5CjgzWicMm8TzcXioTiOS5zBaYPbMnikAiaZszWUgMkafScSQdiekHscXgKEBz8ccLQzOCwJBoFhxOiRciUI8n%2BhRZDIAxGLj7DRJmi0AiRDcQMLLwHMYgAT04Udfxqf8AHkwm0cpt1HI82EEMCGFoQCd14LAwlcYBHDEWgNy7UgsA2IxxFQgi8GIaC8AAN0wPCtF8VRylcd8gN4FZMFbfDaDwMJiFA5wsGXa48BYZcaOIMJEkwIVMCI4BuKMCcZioAxgAUAA1PBMAAdzAuJGFYmRBBEMR2CkIz5CUNRl10JN7xMMx9B4jdIBmVA4hsAQ8O7cTiDwLAXO2CwOMouwIAcIZGl8Bh0HGHpiiyJJPNSFwGj0BIkpSOLCl6JMWmS9pBlS4ZgqsAqBk6QJuhyhKrg6SK9Dq2pssmLgZgUAdFgkFs2yXUjV1WVRoi8ABaLxJFWO9DGAVZHwAOg0OaAwgXBCBIYc%2BSmXht13KcZznTjF1ITt6NXddNzHJSeo4Yk%2BtOzhtqu0hxKSOxJCAA%3D%3D"></iframe>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>データ部分</label><pre class="src src-asm"><span class="org-comment-delimiter">;; </span><span class="org-comment">a: &#36890;&#24120;</span>
<span class="org-keyword">.L__const</span>.main.a:
  <span class="org-keyword">.long</span> 1
  <span class="org-keyword">.long</span> 2
  <span class="org-keyword">.long</span> 3
  <span class="org-keyword">.long</span> 4
  <span class="org-keyword">.long</span> 5

<span class="org-comment-delimiter">;; </span><span class="org-comment">b: &#12499;&#12483;&#12488;&#12501;&#12451;&#12540;&#12523;&#12489;&#25351;&#23450;</span>
<span class="org-keyword">.L__const</span>.main.b:
  <span class="org-keyword">.byte</span> 33
  <span class="org-keyword">.byte</span> 48
  <span class="org-keyword">.byte</span> 4
  <span class="org-keyword">.byte</span> 5
</pre>
</div>

<p>
通常の構造体では、すべてlong型で、 <code>1, 2, 3, 4, 5</code> と格納されているのがわかる。これは、直感に合っている。4バイト(long)にそれぞれ数値がそのまま入っていて、それが5フィールドあるので、合計20バイトを使っているというわけだ。
</p>

<p>
いっぽう、ビットフィールドを指定すると <code>33, 48, 4, 5</code> と奇妙な数値が並んでいる。これは何だろうか。
</p>

<p>
データセクションのサイズは1バイトが4つで4バイトであり、これは先ほど調べた構造体のサイズと一致している。問題はこの値がどこからきたのか、ということだ。5フィールド分のエントリがないので、明らかに1バイトに複数のフィールドの値が詰められている。
</p>

<p>
このようにして変換できる(処理系に依る)。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>初期化した値から、保存されているバイト列に変換する方法</label><pre class="src src-nil">- ↓ 構造体のサイズに基づいて値を配置する{1, 2, 3, 4, 5}
- 0d1     0d2    0d3     0d4       0d5
- |--| |-------| |--| |-------| |-------|
- 0001 0000 0010 0011 0000 0100 0000 0101

- 入れ替え1 構造体の区切りで、上位下位を入れ替える
- |--| |-------| |--| |-------| |-------|
- 0001 0010 0000 0011 0100 0000 0101 0000

- 入れ替え2 1バイトごとで、上位下位を入れ替える
- |-------| |-------| |-------| |-------|
- 0010 0001 0011 0000 0000 0100 0000 0101
- |-0d33--| |-0d48--| |-0d4---| |-0d5---|
</pre>
</div>

<p>
このように、ビットフィールドを指定した型を使うことでメモリの使用効率が高まるが、たとえば大小比較がそのままできなくなり元に戻すオーバーヘッドかかるなど計算で不利になるトレードオフがある。
</p>
</div>
</div>
<div id="outline-container-org52c35d0" class="outline-2">
<h2 id="org52c35d0"><a href="#org52c35d0">関連</a></h2>
<div class="outline-text-2" id="text-org52c35d0">
<ul class="org-ul">
<li><a href="20240617T152502--kdoc-192-『write-great-code-vol1』__draft_book.html#ID-20240617T152502">KDOC 192: 『Write Great Code Vol.1』</a>。の解説を確かめた</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
