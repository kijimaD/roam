<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-01-08 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Emacs Caskのコードを読む</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">Emacs Caskのコードを読む</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgfa39c4e">memo</a>
<ul>
<li><a href="#org0d898ec">機能</a></li>
<li><a href="#orgc9870e2">helpの出力</a></li>
<li><a href="#org2406c3a">eplって何</a></li>
<li><a href="#orgb807955">cask&#x2013;exit-error</a></li>
<li><a href="#org5d5ec3f">signal</a></li>
<li><a href="#orgdd37ce5">cl-flet</a></li>
<li><a href="#orge742e67">declare</a></li>
<li><a href="#orgccf8062">cask&#x2013;with-file</a></li>
<li><a href="#orga5c9fe6">commander</a></li>
<li><a href="#orgab984e5"><span class="todo TODO">TODO</span> どうやってinstallしているか</a></li>
<li><a href="#org3dee78f"><span class="todo TODO">TODO</span> cask-printの仕組み</a></li>
<li><a href="#org3693e79"><span class="todo TODO">TODO</span> どこでcask structをセットしているか</a></li>
<li><a href="#org71dd809"><span class="todo TODO">TODO</span> fetcherとは何か</a></li>
<li><a href="#org4027c34"><span class="todo TODO">TODO</span> recipeとは何か</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
CaskはEmacsのプロジェクト管理ツール。ファイルに依存ライブラリを列挙し、同じ環境を再現できる。Caskの仕組みを知る。
</p>

<div id="outline-container-orgfa39c4e" class="outline-2">
<h2 id="orgfa39c4e"><a href="#orgfa39c4e">memo</a></h2>
<div class="outline-text-2" id="text-orgfa39c4e">
</div>
<div id="outline-container-org0d898ec" class="outline-3">
<h3 id="org0d898ec"><a href="#org0d898ec">機能</a></h3>
<div class="outline-text-3" id="text-org0d898ec">
<p>
そもそもどんな機能があるか。
</p>

<p>
<code>define-error</code> 各エラーの定義。
</p>

<p>
<code>defstruct</code> は構造体を定義する Common Lisp の関数。使い方がわからない。
</p>

<p>
<code>check-parens</code> カッコの対応をチェックする関数。
</p>
</div>
</div>
<div id="outline-container-orgc9870e2" class="outline-3">
<h3 id="orgc9870e2"><a href="#orgc9870e2">helpの出力</a></h3>
<div class="outline-text-3" id="text-orgc9870e2">
<p>
そもそもinstall以外の機能を知らない。
</p>

<pre class="example">
  USAGE: cask [COMMAND] [OPTIONS]

Emacs dependency management made easy

COMMANDS:

 pkg-file                                Write a ‘define-package’ file.

                                         The file is written to the Cask project root path with name
                                         {project-name}-pkg.el.
 install                                 Install all packages specified in the Cask-file.

                                         The dependencies to packages are also installed.  If a package
                                         already is installed, it will not be installed again.
 update                                  Update package versions.

                                         All packages that are specified in the Cask-file will be updated
                                         including their dependencies.
 upgrade                                 Upgrade Cask itself and its dependencies.

                                         This command requires that Cask is installed using Git and that
                                         Git is available in ‘exec-path’.
 upgrade-cask                            Upgrade Cask itself and its dependencies.

                                         This command requires that Cask is installed using Git and that
                                         Git is available in ‘exec-path’.
 exec [*]                                Execute ARGS with correct ‘exec-path’ and ‘load-path’.
 version                                 Print version for the current project.
 list                                    List this package dependencies.
 info                                    Show info about the current package.
 help [command]                          Display usage information or documentation for COMMAND-NAME.
 load-path                               Print ‘load-path’ for all packages and dependencies.

                                         The output is formatted as a colon path.
 exec-path                               Print ‘exec-path’ for all packages and dependencies.

                                         A dependency will be included in this list of the package has a
                                         directory called bin in the root directory.

                                         The output is formatted as a colon path.
 eval &lt;form&gt;                             Eval FORM with the ‘load-path’ set according to the project.
 path                                    Print ‘exec-path’ for all packages and dependencies.

                                         A dependency will be included in this list of the package has a
                                         directory called bin in the root directory.

                                         The output is formatted as a colon path.
 package-directory                       Print current package installation directory.
 outdated                                Print list of outdated packages.

                                         That is packages that have a more recent version available for
                                         installation.
 files                                   Print list of files specified in the files directive.
                                         If no files directive or no files, do nothing.
 build                                   Build all Elisp files in the files directive.
 clean-elc                               Remove all byte compiled Elisp files in the files directive.
 link [*]                                Manage links.

                                         A link is just that, a symbolic link.  The purpose of the link
                                         command is that you should be able to work with local
                                         dependencies.

                                         For example, let’s say you are developing an Emacs package that
                                         depends on f.el. Consider what happens if you need to extend f.el
                                         with some function that your package requires.

                                         With the link command, you can checkout f.el locally, add it as a
                                         link in your local package.  That means that when you require
                                         f.el, you will require the local package instead of the one
                                         fetched from the ELPA mirror.  Now you add the desired function
                                         to f.el and use your library to try it out.

                                         COMMAND-OR-NAME can be one of: delete, list or a link name.
                                         ARG is sent to some of the commands.

                                         Commands:

                                          $ cask link list

                                           List all project links.

                                          $ cask link name path

                                           Add local link with NAME to PATH.

                                          $ cask link delete name

                                           Delete local link with NAME.
 package [target-dir]                    Build package and put in TARGET-DIR or dist if not specified.
 emacs [*]                               Execute emacs with the appropriate environment.

OPTIONS:

 --proxy &lt;host&gt;                          Set Emacs proxy for HTTP and HTTPS to HOST.
 --http-proxy &lt;host&gt;                     Set Emacs proxy for HTTP to HOST.
 --https-proxy &lt;host&gt;                    Set Emacs proxy for HTTPS to HOST.
 --no-proxy &lt;host&gt;                       Set Emacs no-proxy to HOST.
 --version                               Print Cask’s version.
 -h [command], --help [command]          Display usage information or documentation for COMMAND-NAME.
 --debug                                 Turn on debug output.
 --path &lt;path&gt;                           Run command in this PATH instead of in ‘default-directory’.
 --verbose                               Be verbose and show debug output.
 --silent                                Be silent and do not print anything.
</pre>
</div>
</div>
<div id="outline-container-org2406c3a" class="outline-3">
<h3 id="org2406c3a"><a href="#org2406c3a">eplって何</a></h3>
<div class="outline-text-3" id="text-org2406c3a">
<p>
パッケージ関連のライブラリ。
</p>

<ul class="org-ul">
<li><a href="https://github.com/cask/epl">cask/epl: Emacs Package Library</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgb807955" class="outline-3">
<h3 id="orgb807955"><a href="#orgb807955">cask&#x2013;exit-error</a></h3>
<div class="outline-text-3" id="text-orgb807955">
<p>
渡されたエラーの種類によって正しいメッセージを返す。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/kd-collective/cask/blob/467979414c85bb2ce83f5c6ab9f95721164e9efa/cask.el#L237
</pre>
</div>

<div class="results" id="orgcf7d313">
<p>
(defun cask&#x2013;exit-error (bundle err)
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>read は読み進める関数</label><pre class="src src-emacs-lisp">(read (current-buffer))
</pre>
</div>
</div>
</div>
<div id="outline-container-org5d5ec3f" class="outline-3">
<h3 id="org5d5ec3f"><a href="#org5d5ec3f">signal</a></h3>
<div class="outline-text-3" id="text-org5d5ec3f">
<p>
エラーをシグナルする関数。
</p>
</div>
</div>
<div id="outline-container-orgdd37ce5" class="outline-3">
<h3 id="orgdd37ce5"><a href="#orgdd37ce5">cl-flet</a></h3>
<div class="outline-text-3" id="text-orgdd37ce5">
<p>
ローカル定義関数を作る。
</p>
</div>
</div>
<div id="outline-container-orge742e67" class="outline-3">
<h3 id="orge742e67"><a href="#orge742e67">declare</a></h3>
<div class="outline-text-3" id="text-orge742e67">
<p>
<a href="https://ayatakesi.github.io/emacs/24.5/elisp_html/Declare-Form.html">Declare Form (GNU Emacs Lisp Reference Manual)</a>
</p>

<p>
関数やマクロにメタプロパティを付与するのに使う。陳腐化マークをつけたり、TABインデント規則をつけたりできる。たとえば通常defunでは第3引数に来るdoc stringを、ほかのマクロで定義するのに使う。
</p>
</div>
</div>

<div id="outline-container-orgccf8062" class="outline-3">
<h3 id="orgccf8062"><a href="#orgccf8062">cask&#x2013;with-file</a></h3>
<div class="outline-text-3" id="text-orgccf8062">
<p>
引数のcaskが存在すれば、bodyを評価するマクロ。
</p>

<dl class="org-dl">
<dt>f-file?</dt><dd>file-regular-p  のエイリアス。regular file って何</dd>
</dl>
</div>
</div>

<div id="outline-container-orga5c9fe6" class="outline-3">
<h3 id="orga5c9fe6"><a href="#orga5c9fe6">commander</a></h3>
<div class="outline-text-3" id="text-orga5c9fe6">
<p>
CLIの実行には、commanderというパーサーライブラリを使っているようだ。これを使ってEmacs Lispで書かれた関数をシェルから呼び出せるようにしている。サブコマンド・オプション・ヘルプ表示などをommanderでしている。
</p>
</div>
</div>
<div id="outline-container-orgab984e5" class="outline-3">
<h3 id="orgab984e5"><a href="#orgab984e5"><span class="todo TODO">TODO</span> どうやってinstallしているか</a></h3>
<div class="outline-text-3" id="text-orgab984e5">
<ul class="org-ul">
<li>cask-install
<ul class="org-ul">
<li>cask&#x2013;with-environment
<ul class="org-ul">
<li>cl-destructuring-bind 実行結果で変数をバインドする
<ul class="org-ul">
<li>cask&#x2013;dependencies-and-missing 依存関係を集める</li>
<li>cask&#x2013;install-dependency 個別にインストールを実行</li>
<li>missing-dependencies のときはエラーを吐く</li>
</ul></li>
</ul></li>
</ul></li>
</ul>

<p>
bundle構造体に対して、さまざまなアクセサがある感じか。bundleがよくわかってなくてピンときてない感じ。ほとんどの関数はbundleを引数にとる。
</p>

<ul class="org-ul">
<li>cask&#x2013;install-dependency
<ul class="org-ul">
<li>print関係やってる</li>
<li>本質的にはepl-install-file か epl-package-install を使ってインストール
<ul class="org-ul">
<li>install-fileはファイルからインストールし、package installは名前からダウンロードか</li>
<li>fetcherによって分岐するようだ。fetcherとは</li>
</ul></li>
<li>epl-refresh package descriptionを更新するs</li>
<li>cask&#x2013;checkout-and-package-dependency パッケージのパスを返す</li>
<li>cask-dependency 系は何をやっているのだろう</li>
<li>cask&#x2013;with-package 引数がパッケージであればbodyを評価し、パッケージでなければ例外を返す</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org3dee78f" class="outline-3">
<h3 id="org3dee78f"><a href="#org3dee78f"><span class="todo TODO">TODO</span> cask-printの仕組み</a></h3>
<div class="outline-text-3" id="text-org3dee78f">
<p>
cask-print内でgreen関数を使って出力を色付けできる。直接green関数は中でないと利用できない。これはどういう仕組みになっているのだろう。
</p>

<div class="org-src-container">
<pre class="src src-emacs-lisp">(cask-print <span class="org-string">"----"</span> (green <span class="org-string">"green"</span>) <span class="org-string">"----"</span>)
</pre>
</div>

<div class="results" id="orgbb24be0">
<p>
-&#x2014;[32mgreen[0m-&#x2014;
</p>

</div>
</div>
</div>

<div id="outline-container-org3693e79" class="outline-3">
<h3 id="org3693e79"><a href="#org3693e79"><span class="todo TODO">TODO</span> どこでcask structをセットしているか</a></h3>
<div class="outline-text-3" id="text-org3693e79">
<p>
テストを見ればよさそうに見える。
</p>
</div>
</div>

<div id="outline-container-org71dd809" class="outline-3">
<h3 id="org71dd809"><a href="#org71dd809"><span class="todo TODO">TODO</span> fetcherとは何か</a></h3>
<div class="outline-text-3" id="text-org71dd809">
<p>
どのバージョン管理を使うかということに見える。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>デフォルト値</label><pre class="src src-emacs-lisp">(<span class="org-builtin">:git</span> <span class="org-builtin">:bzr</span> <span class="org-builtin">:hg</span> <span class="org-builtin">:darcs</span> <span class="org-builtin">:svn</span> <span class="org-builtin">:cvs</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org4027c34" class="outline-3">
<h3 id="org4027c34"><a href="#org4027c34"><span class="todo TODO">TODO</span> recipeとは何か</a></h3>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
