<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-02-04 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ertを読む</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">ertを読む</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3892b2e">Tasks</a>
<ul>
<li><a href="#orgb1bd5e5"><span class="done DONE">DONE</span> deftestを実行するとどうなるか</a></li>
<li><a href="#orgfe456d7"><span class="done DONE">DONE</span> 実行テストリストをどうやって表示しているか</a></li>
<li><a href="#orgd1afd86"><span class="todo TODO">TODO</span> テストを実行するとき何が起きているか</a></li>
<li><a href="#org10c25de"><span class="todo TODO">TODO</span> 成功・非成功はどうやって検証しているか</a></li>
<li><a href="#orge3875f3"><span class="todo TODO">TODO</span> shouldはどうやって検証しているか</a></li>
<li><a href="#orgf5d091a"><span class="todo TODO">TODO</span> 失敗時の値の比較表示はどうやっているか</a></li>
<li><a href="#org4cb681e"><span class="todo TODO">TODO</span> 統計記録をどうやっているか</a></li>
<li><a href="#org19737d1"><span class="todo TODO">TODO</span> 結果バッファの表示をどうやっているか</a></li>
<li><a href="#org7e982e2"><span class="todo TODO">TODO</span> <code>cl-defmacro</code> と <code>defmacro</code> の違い</a></li>
<li><a href="#org61250c2"><span class="todo TODO">TODO</span> run-test-at-pointを作ってみる</a></li>
</ul>
</li>
<li><a href="#orgb329560">Memo</a>
<ul>
<li><a href="#org7212c2d">ertの全体像</a></li>
<li><a href="#org398f84c">デバッグ情報を定義する</a></li>
<li><a href="#org00a6342">エラーを定義する</a></li>
<li><a href="#orgf3023a3">UI用の関数</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
ertはEmacs組み込みのテストフレームワーク。
</p>

<div id="outline-container-org3892b2e" class="outline-2">
<h2 id="org3892b2e"><a href="#org3892b2e">Tasks</a></h2>
<div class="outline-text-2" id="text-org3892b2e">
</div>
<div id="outline-container-orgb1bd5e5" class="outline-3">
<h3 id="orgb1bd5e5"><a href="#orgb1bd5e5"><span class="done DONE">DONE</span> deftestを実行するとどうなるか</a></h3>
<div class="outline-text-3" id="text-orgb1bd5e5">
<ul class="org-ul">
<li>ert-deftest 構造体に必要な情報を収集
<ul class="org-ul">
<li>ert-set-test make-ert-testで作った構造体でシンボルを登録する
<ul class="org-ul">
<li>make-ert-test テスト実行に必要なスロットを用意したオブジェクトを作る。test name, body, doc, file name &#x2026;</li>
</ul></li>
</ul></li>
</ul>

<p>
ということで、テスト構造体がシンボルとして登録される、という感じか。単純。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>メインの関数</label><pre class="src src-git-permalink">https://github.com/kd-collective/emacs/blob/30cf1f34c583d6ed16bdc5b9578370f30c95fe1b/lisp/emacs-lisp/ert.el#L191
</pre>
</div>

<div class="results" id="org592208d">
<p>
(cl-defmacro ert-deftest (name () &amp;body docstring-keys-and-body)
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>テスト構造体を作る関数</label><pre class="src src-git-permalink">https://github.com/kd-collective/emacs/blob/30cf1f34c583d6ed16bdc5b9578370f30c95fe1b/lisp/emacs-lisp/ert.el#L140
</pre>
</div>

<div class="results" id="orgfb4286c">
<p>
(defun ert-set-test (symbol definition)
</p>

</div>
</div>
</div>

<div id="outline-container-orgfe456d7" class="outline-3">
<h3 id="orgfe456d7"><a href="#orgfe456d7"><span class="done DONE">DONE</span> 実行テストリストをどうやって表示しているか</a></h3>
<div class="outline-text-3" id="text-orgfe456d7">
<p>
実行できる実行の一覧から選んで実行することになる。このリストはどうやって表示しているのだろうか。
</p>

<ul class="org-ul">
<li>obarray シンボルテーブル</li>
<li>seq-filter リストをフィルタする</li>
<li>obarray の中から、ert-test に割り当てられたものをフィルタリングして、ert-deftestで定義されたテストオブジェクトを取り出している</li>
<li>取り出したリストをcompleting-readに渡して選択肢表示する</li>
</ul>
</div>
</div>

<div id="outline-container-orgd1afd86" class="outline-3">
<h3 id="orgd1afd86"><a href="#orgd1afd86"><span class="todo TODO">TODO</span> テストを実行するとき何が起きているか</a></h3>
<div class="outline-text-3" id="text-orgd1afd86">
<ul class="org-ul">
<li>ert-run-tests-interactively 実行可能なテストのリストを選択、バッファ表示、実行
<ul class="org-ul">
<li>listenerはevent-typeを受け取る無名関数</li>
<li>ert-run-tests 特定したテストを実行する
<ul class="org-ul">
<li>結果を取得し、変数most-recent-resultに保存する</li>
</ul></li>
</ul></li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>テスト実行関数</label><pre class="src src-git-permalink">https://github.com/kd-collective/emacs/blob/30cf1f34c583d6ed16bdc5b9578370f30c95fe1b/lisp/emacs-lisp/ert.el#L2254
</pre>
</div>

<div class="results" id="org589ac1b">
<p>
(defun ert-run-tests-interactively (selector)
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>関数評価で実行するときは引数を渡す必要がある</label><pre class="src src-emacs-lisp">(ert-run-tests-interactively 'cl-remove-if-not-test)
</pre>
</div>

<ul class="org-ul">
<li>ert-run-tests-interactively
<ul class="org-ul">
<li>テストそのものというより、ユーザ入力とバッファで見せる部分が多くを占める</li>
<li>interactive関数によって、M-xで呼んだときにはcompletionの値が入る</li>
<li>この引数の名前はselectorという名前がついている</li>
<li>listerはどういう意味か。関数なのは確か
<ul class="org-ul">
<li>event-typeによって処理が変わる関数</li>
<li>run-startedのときは準備バッファを表示する</li>
<li>run-endedのとき成功してたら統計バッファを表示する</li>
<li>test-startedのとき
<ul class="org-ul">
<li>ewocって何だ
<ul class="org-ul">
<li>ewoc関係の関数は組み込みで入っている</li>
</ul></li>
</ul></li>
<li>test-endedのときは統計バッファを更新する</li>
</ul></li>
</ul></li>

<li>ert-run-tests
<ul class="org-ul">
<li>ert-run-or-rerun-test</li>
<li>ert-run-test
<ul class="org-ul">
<li>ert&#x2013;run-test-internal
<ul class="org-ul">
<li>デバッグ関連の情報を付加する</li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org10c25de" class="outline-3">
<h3 id="org10c25de"><a href="#org10c25de"><span class="todo TODO">TODO</span> 成功・非成功はどうやって検証しているか</a></h3>
<div class="outline-text-3" id="text-org10c25de">
<p>
テストに含まれるshouldが正しいかによって、テストが成功しているかを判定している。
</p>
</div>
</div>
<div id="outline-container-orge3875f3" class="outline-3">
<h3 id="orge3875f3"><a href="#orge3875f3"><span class="todo TODO">TODO</span> shouldはどうやって検証しているか</a></h3>
<div class="outline-text-3" id="text-orge3875f3">
<p>
ertで定義された関数では、shouldで検証している。名前的にertに含まれないように見えるが、ertファイルで定義されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/kd-collective/emacs/blob/30cf1f34c583d6ed16bdc5b9578370f30c95fe1b/lisp/emacs-lisp/ert.el#L378
</pre>
</div>

<div class="results" id="orgfcc874d">
<p>
(cl-defmacro should (form)
</p>

</div>
</div>
</div>

<div id="outline-container-orgf5d091a" class="outline-3">
<h3 id="orgf5d091a"><a href="#orgf5d091a"><span class="todo TODO">TODO</span> 失敗時の値の比較表示はどうやっているか</a></h3>
<div class="outline-text-3" id="text-orgf5d091a">
<p>
expectedとresultの値を表示して、どこがおかしいのかを表示してくれる。
</p>
</div>
</div>
<div id="outline-container-org4cb681e" class="outline-3">
<h3 id="org4cb681e"><a href="#org4cb681e"><span class="todo TODO">TODO</span> 統計記録をどうやっているか</a></h3>
<div class="outline-text-3" id="text-org4cb681e">
<p>
実行テストは選択できる。実行したテストについて、成功数や時間を表示する。
</p>
</div>
</div>
<div id="outline-container-org19737d1" class="outline-3">
<h3 id="org19737d1"><a href="#org19737d1"><span class="todo TODO">TODO</span> 結果バッファの表示をどうやっているか</a></h3>
<div class="outline-text-3" id="text-org19737d1">
<p>
テスト結果が表示される。
</p>
</div>
</div>
<div id="outline-container-org7e982e2" class="outline-3">
<h3 id="org7e982e2"><a href="#org7e982e2"><span class="todo TODO">TODO</span> <code>cl-defmacro</code> と <code>defmacro</code> の違い</a></h3>
<div class="outline-text-3" id="text-org7e982e2">
<p>
使い分けているように見えるが、何が違うのかわからない。
</p>
</div>
</div>
<div id="outline-container-org61250c2" class="outline-3">
<h3 id="org61250c2"><a href="#org61250c2"><span class="todo TODO">TODO</span> run-test-at-pointを作ってみる</a></h3>
<div class="outline-text-3" id="text-org61250c2">
<p>
リストから選ぶのが面倒なので、実行できるようにする。
</p>
</div>
</div>
</div>
<div id="outline-container-orgb329560" class="outline-2">
<h2 id="orgb329560"><a href="#orgb329560">Memo</a></h2>
<div class="outline-text-2" id="text-orgb329560">
</div>
<div id="outline-container-org7212c2d" class="outline-3">
<h3 id="org7212c2d"><a href="#org7212c2d">ertの全体像</a></h3>
<div class="outline-text-3" id="text-org7212c2d">
<p>
テストフレームワークの全体像をソースコードから把握する。
</p>

<ul class="org-ul">
<li>テスト定義</li>
<li>マッチャ関数</li>
<li>テスト実行</li>
<li>エラー時の値表示</li>
<li>テストセレクタ</li>
<li>テストのサマリー表示
<ul class="org-ul">
<li>成功数</li>
<li>失敗数</li>
<li>開始時間</li>
</ul></li>
<li>バッチ実行</li>
<li>JUnit形式出力</li>
<li>実行テスト登録・削除</li>
<li>プログレスバー</li>
<li>モードライン表示</li>
<li>成功時・失敗時のface設定</li>
<li><code>ert-results-mode</code> の各種機能・キーバインド</li>
</ul>
</div>
</div>

<div id="outline-container-org398f84c" class="outline-3">
<h3 id="org398f84c"><a href="#org398f84c">デバッグ情報を定義する</a></h3>
<div class="outline-text-3" id="text-org398f84c">
<p>
defmacroにメタ情報を定義するときは、declareを使う。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>デバッグ情報の定義</label><pre class="src src-git-permalink">https://github.com/kd-collective/emacs/blob/30cf1f34c583d6ed16bdc5b9578370f30c95fe1b/lisp/emacs-lisp/ert.el#L215-L217
</pre>
</div>

<div class="results" id="org1e8cc5a">
<p>
(declare (debug (&amp;define [&amp;name &ldquo;test@&rdquo; symbolp]
			 sexp [&amp;optional stringp]
			 [&amp;rest keywordp sexp] def-body))
</p>

</div>
</div>
</div>
<div id="outline-container-org00a6342" class="outline-3">
<h3 id="org00a6342"><a href="#org00a6342">エラーを定義する</a></h3>
<div class="outline-text-3" id="text-org00a6342">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>エラーを定義する</label><pre class="src src-emacs-lisp">(define-error 'my-failed <span class="org-string">"failed"</span>)
</pre>
</div>

<p>
プロパティにmy-failedを登録する。
</p>
</div>
</div>
<div id="outline-container-orgf3023a3" class="outline-3">
<h3 id="orgf3023a3"><a href="#orgf3023a3">UI用の関数</a></h3>
<div class="outline-text-3" id="text-orgf3023a3">
<ul class="org-ul">
<li>insert-text-button
<ul class="org-ul">
<li>ボタンを追加する</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
