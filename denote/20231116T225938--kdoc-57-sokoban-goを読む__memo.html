<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-02-03 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 57: sokoban-goを読む</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 57: sokoban-goを読む</h1>
<p>
ゲームを作るけど最後までうまくいった試しがない。人のコードを見る。
</p>

<ul class="org-ul">
<li>タイル空間の定石を探る
<ul class="org-ul">
<li>移動</li>
</ul></li>
<li>コンポーネントシステムの定石を探る</li>
</ul>

<div id="outline-container-org4041518" class="outline-2">
<h2 id="org4041518"><a href="#org4041518">タイル - スプライト</a></h2>
<div class="outline-text-2" id="text-org4041518">
<p>
タイルの上にあるものはスプライトとしているよう。<sup><a id="fnr.1" class="footref" href="#fn.1">1</a></sup>
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L23-L30
</pre>
</div>

<div class="results" id="orgc92a660">
<p>
const (
	exteriorSpriteNumber = 0
	wallSpriteNumber     = 1
	floorSpriteNumber    = 2
	goalSpriteNumber     = 3
	boxSpriteNumber      = 4
	playerSpriteNumber   = 5
)
</p>

</div>
</div>
</div>

<div id="outline-container-org8298e62" class="outline-2">
<h2 id="org8298e62"><a href="#org8298e62">タイルに対する操作</a></h2>
<div class="outline-text-2" id="text-org8298e62">
<p>
タイルに対する操作一覧。論理演算で判断しているな。Set関数では自身を書き換える。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L54-L84
</pre>
</div>

<div class="results" id="orgff2a5cb">
<p>
// Tile is a game tile
type Tile uint8
</p>

<p>
// List of game tiles
const (
	TilePlayer Tile = 1 &lt;&lt; iota
	TileBox
	TileGoal
	TileWall
	TileEmpty Tile = 0
)
</p>

<p>
// Contains checks if a game tile contains the provided tile
func (t *Tile) Contains(other Tile) bool {
	return (*t &amp; other) == other
}
</p>

<p>
// ContainsAny checks if a game tile contains any of the provided tiles
func (t *Tile) ContainsAny(other Tile) bool {
	return (*t &amp; other) != 0
}
</p>

<p>
// Set adds the provided tile to a game tile
func (t *Tile) Set(other Tile) {
	*t |= other
}
</p>

<p>
// Remove removes the provided tile to a game tile
func (t *Tile) Remove(other Tile) {
	*t &amp;= 0xFF ^ other
}
</p>

</div>
</div>
</div>

<div id="outline-container-orgef94392" class="outline-2">
<h2 id="orgef94392"><a href="#orgef94392">読み込み</a></h2>
<div class="outline-text-2" id="text-orgef94392">
<p>
タイルはファイルから読み込んでいるようだ。よくわからない。タイルの縦×横の集合体がグリッドだ。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>func normalizeLevel(lines []string) ([][]byte, error)</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L165
</pre>
</div>

<div class="results" id="orgd86e005">
<p>
grid := make([][]byte, len(lines))
</p>

</div>

<p>
コンポーネントを追加している↓。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>func createFloorEntity(componentList *loader.EntityComponentList, gameSpriteSheet)</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/level.go#L319-L327
</pre>
</div>

<div class="results" id="orga615bac">
<p>
func createFloorEntity(componentList *loader.EntityComponentList, gameSpriteSheet *ec.SpriteSheet, line, col int) {
	componentList.Engine = append(componentList.Engine, loader.EngineComponentList{
		SpriteRender: &amp;ec.SpriteRender{SpriteSheet: gameSpriteSheet, SpriteNumber: floorSpriteNumber},
		Transform:    &amp;ec.Transform{},
	})
	componentList.Game = append(componentList.Game, gameComponentList{
		GridElement: &amp;gc.GridElement{Line: line, Col: col},
	})
}
</p>

</div>
</div>
</div>

<div id="outline-container-org42770f0" class="outline-2">
<h2 id="org42770f0"><a href="#org42770f0">コンポーネントの定義</a></h2>
<div class="outline-text-2" id="text-org42770f0">
<p>
コンポーネントの種類の定義↓。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/loader/lib.go#L13-L19
</pre>
</div>

<div class="results" id="org3ca1c1e">
<p>
type gameComponentList struct {
	GridElement *gc.GridElement
	Player      *gc.Player
	Box         *gc.Box
	Goal        *gc.Goal
	Wall        *gc.Wall
}
</p>

</div>

<p>
保持している構造体↓。コンポーネントを入れる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/components/lib.go#L5-L12
</pre>
</div>

<div class="results" id="org809de65">
<p>
// Components contains references to all game components
type Components struct {
	GridElement *ecs.SliceComponent
	Player      *ecs.NullComponent
	Box         *ecs.NullComponent
	Goal        *ecs.NullComponent
	Wall        *ecs.NullComponent
}
</p>

</div>
</div>
</div>

<div id="outline-container-org5163283" class="outline-2">
<h2 id="org5163283"><a href="#org5163283">resources</a></h2>
<div class="outline-text-2" id="text-org5163283">
<p>
アクションが定数として表現されている。アクションmapのキーとして利用する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>定数</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/controls.go#L3-L7
</pre>
</div>

<div class="results" id="org90efb0f">
<p>
const (
	// MoveUpAction is the action for moving up
	MoveUpAction = &ldquo;MoveUp&rdquo;
	// MoveUpFastAction is the action for moving up fast
	MoveUpFastAction = &ldquo;MoveUpFast&rdquo;
</p>

</div>

<p>
アクションを初期化している部分(ライブラリ)↓。TOMLファイルから読み取って設定するよう。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>func LoadControls(controlsConfigPath string, axes []string, actions []string) (resources.Controls, resources.InputHandler)</label><pre class="src src-git-permalink">inputHandler.Actions = make(map[string]bool)
</pre>
</div>

<p>
TOMLファイル。対応関係がわかりやすい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/config/controls.toml#L1-L6
</pre>
</div>

<div class="org-src-container">
<pre class="src src-toml">[controls.actions.MoveUp]
combinations = [[{ key = "Up" }]]
once = true

[controls.actions.MoveUpFast]
combinations = [[{ key = "ShiftLeft" }, { key = "Up" }], [{ key = "ShiftRight" }, { key = "Up" }]]
</pre>
</div>
</div>
</div>


<div id="outline-container-orge6e1111" class="outline-2">
<h2 id="orge6e1111"><a href="#orge6e1111">prefab</a></h2>
<div class="outline-text-2" id="text-orge6e1111">
<p>
prefabが具体的にどういうことをするのかわからない。メニュー画面それぞれを保持しているぽい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/prefab.go#L5-L13
</pre>
</div>

<div class="results" id="orgcd37f28">
<p>
// MenuPrefabs contains menu prefabs
type MenuPrefabs struct {
	MainMenu          loader.EntityComponentList
	ChoosePackageMenu loader.EntityComponentList
	PauseMenu         loader.EntityComponentList
	LevelCompleteMenu loader.EntityComponentList
	HighscoresMenu    loader.EntityComponentList
	SolutionsMenu     loader.EntityComponentList
}
</p>

</div>
</div>
</div>

<div id="outline-container-orgd94cb52" class="outline-2">
<h2 id="orgd94cb52"><a href="#orgd94cb52">UI更新</a></h2>
<div class="outline-text-2" id="text-orgd94cb52">
<p>
UIもコンポーネントである。↓UIコンポーネントを書き換えて表示する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>UIコンポーネント更新</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/pause_menu.go#L123-L137
</pre>
</div>

<div class="results" id="orgdc1ca58">
<p>
// Update text components
world.Manager.Join(world.Components.Engine.Text, world.Components.Engine.UITransform).Visit(ecs.Visit(func(entity ecs.Entity) {
	text := world.Components.Engine.Text.Get(entity).(*ec.Text)
</p>

<p>
	switch text.ID {
	case "view_highscore&rdquo;:
		if st.invalidHighscore {
			text.Color = color.RGBA{0, 0, 0, 120}
		}
	case &ldquo;view_solution&rdquo;:
		if st.invalidSolution {
			text.Color = color.RGBA{0, 0, 0, 120}
		}
	}
}))
</p>

</div>

<p>
↓コンポーネントはTOMLで定義されているようだ。各メニューごとにファイルがあるな。translationは配置する座標だな。なぜこの単語が使われているのかわからない。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/assets/metadata/entities/ui/main_menu.toml#L27-L34
</pre>
</div>

<div class="results" id="orgeb8d4b1">
<p>
[entity.components.Text]
id = &ldquo;cursor_view_highscores&rdquo;
text = &ldquo;\u25ba&rdquo;
font_face = { font = &ldquo;hack&rdquo;, options.size = 60.0 }
color = [255, 255, 255, 255]
</p>

<p>
[entity.components.UITransform]
translation = { x = 40, y = 400 }
</p>

</div>

<ul class="org-ul">
<li><a href="https://developer.mozilla.org/ja/docs/Web/CSS/transform"> transform - CSS: カスケーディングスタイルシート | MDN</a></li>
</ul>

<p>
画像を移動や拡大縮小など変化させるのをtransformというようだ。
</p>
</div>
</div>

<div id="outline-container-org6ed949f" class="outline-2">
<h2 id="org6ed949f"><a href="#org6ed949f">メニューコンポーネントのマウスオーバーイベント</a></h2>
<div class="outline-text-2" id="text-org6ed949f">
<p>
↓メニューコンポーネントそれぞれで、マウスが上にあるかを判定する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>func updateMenu(menu menu, world w.World) states.Transition {</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L41-L46
</pre>
</div>

<div class="results" id="orgf63c42d">
<p>
// Handle mouse events only if mouse is moved or clicked
x, y := ebiten.CursorPosition()
if x != menuLastCursorPosition.X || y != menuLastCursorPosition.Y || inpututil.IsMouseButtonJustPressed(ebiten.MouseButtonLeft) {
	menuLastCursorPosition = m.VectorInt2{X: x, Y: y}
</p>

<p>
for iElem, id := range menu.getMenuIDs() {
</p>

</div>

<p>
↓コンポーネントのクエリ。レンダーできる、変形可能、マウスが反応可能、といった性質を持つものを対象にする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>func updateMenu(menu menu, world w.World) states.Transition {</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L47
</pre>
</div>

<div class="results" id="orga579810">
<p>
if world.Manager.Join(world.Components.Engine.SpriteRender, world.Components.Engine.Transform, world.Components.Engine.MouseReactive).Visit(
</p>

</div>

<p>
↓コンポーネントを特定して、stateの <code>selection</code> (選択中の項目)を変える。クリックされていた場合は、遷移する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>func updateMenu(menu menu, world w.World) states.Transition {</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L48-L59
</pre>
</div>

<div class="results" id="orgdfb0849">
<p>
func(index int) (skip bool) {
	mouseReactive := world.Components.Engine.MouseReactive.Get(ecs.Entity(index)).(*ec.MouseReactive)
	if mouseReactive.ID == id &amp;&amp; mouseReactive.Hovered {
		menu.setSelection(iElem)
		if mouseReactive.JustClicked {
			transition = menu.confirmSelection(world)
			return true
		}
	}
	return false
}) {
return transition
</p>

</div>
</div>
</div>

<div id="outline-container-orge7c05ad" class="outline-2">
<h2 id="orge7c05ad"><a href="#orge7c05ad">GridElementとは何か</a></h2>
<div class="outline-text-2" id="text-orge7c05ad">
<p>
↓グリッドを置き換えるシステムがある。グリッドは座標を持つことを示す。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_transform.go#L16-L17
</pre>
</div>

<div class="results" id="org97efc9d">
<p>
// GridTransformSystem sets transform for grid elements
func GridTransformSystem(world w.World) {
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_transform.go#L20
</pre>
</div>

<div class="results" id="orgf1cb16d">
<p>
world.Manager.Join(gameComponents.GridElement, world.Components.Engine.SpriteRender, world.Components.Engine.Transform).Visit(ecs.Visit(func(entity ecs.Entity) {
</p>

</div>

<ul class="org-ul">
<li>GridElement &#x2013; 座標を持つことを示す</li>
<li>SpriteRender &#x2013; 描画可能なことを示す</li>
<li>Transform &#x2013; 何かわからない
<ul class="org-ul">
<li>壁、箱、プレイヤー、UI…など描画されるものについている</li>
<li>画像変換か</li>
</ul></li>
</ul>

<p>
このシステムはタイルの変化をEntityに及ぼす、という感じか。
</p>

<p>
↓タイルの中からプレイヤー、箱を探す。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>プレイヤー、箱を探す</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_update.go#L18-L25
</pre>
</div>

<div class="results" id="org443df3b">
<p>
for iTile, tile := range gameResources.Level.Grid.Data {
	switch {
	case tile.Contains(resources.TilePlayer):
		playerIndex = iTile
	case tile.Contains(resources.TileBox):
		boxIndices = append(boxIndices, iTile)
	}
}
</p>

</div>

<p>
プレイヤーコンポーネント、箱コンポーネントのgridElementを更新する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>コンポーネントによって分岐</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/grid_update.go#L33-L47
</pre>
</div>

<div class="results" id="org1072b87">
<p>
world.Manager.Join(gameComponents.GridElement).Visit(ecs.Visit(func(entity ecs.Entity) {
	switch {
	case entity.HasComponent(gameComponents.Player):
		gridElement := gameComponents.GridElement.Get(entity).(*gc.GridElement)
		gridElement.Line = paddingRow + playerIndex/levelWidth
		gridElement.Col = paddingCol + playerIndex%levelWidth
</p>

<p>
	case entity.HasComponent(gameComponents.Box):
		gridElement := gameComponents.GridElement.Get(entity).(*gc.GridElement)
		boxIndex := boxIndices[0]
		boxIndices = boxIndices[1:]
		gridElement.Line = paddingRow + boxIndex/levelWidth
		gridElement.Col = paddingCol + boxIndex%levelWidth
	}
}))
</p>

</div>
</div>
</div>

<div id="outline-container-org29618cc" class="outline-2">
<h2 id="org29618cc"><a href="#org29618cc">InfoSystemとは何か</a></h2>
<div class="outline-text-2" id="text-org29618cc">
<p>
GridElementと同様に、タイルの状態をエンティティに反映する。今回はUIエンティティ。
</p>

<p>
↓箱の数、正しく配置されている箱の数をカウントする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>func InfoSystem(world w.World, solutionMode bool) {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/info.go#L21-L29
</pre>
</div>

<div class="results" id="org1874b5a">
<p>
for _, tile := range gameResources.Level.Grid.Data {
	if tile.Contains(resources.TileBox) {
		boxCount += 1
</p>

<p>
		if tile.Contains(resources.TileGoal) {
			boxOnGoalCount += 1
		}
	}
}
</p>

</div>

<p>
↓テキストコンポーネントを更新する。IDで分岐する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/info.go#L31-L51
</pre>
</div>

<div class="results" id="org44dd282">
<p>
// Set text info
world.Manager.Join(world.Components.Engine.Text, world.Components.Engine.UITransform).Visit(ecs.Visit(func(entity ecs.Entity) {
	text := world.Components.Engine.Text.Get(entity).(*ec.Text)
</p>

<p>
	switch text.ID {
	case "level":
		text.Text = fmt.Sprintf("LEVEL %d/%d", gameResources.Level.CurrentNum+1, len(gameResources.Package.Levels))
		if !solutionMode &amp;&amp; gameResources.Level.Modified {
			text.Text += "(*)"
		}
	case "box":
		text.Text = fmt.Sprintf("BOX: %d/%d", boxOnGoalCount, boxCount)
	case "step":
		text.Text = fmt.Sprintf("STEPS: %d", len(gameResources.Level.Movements))
	case "package":
		text.Text = fmt.Sprintf("Package: %s", gameResources.Package.Name)
		if solutionMode {
			text.Text += " - Replaying solution&#x2026;"
		}
	}
}))
</p>

</div>
</div>
</div>

<div id="outline-container-orgab99f3e" class="outline-2">
<h2 id="orgab99f3e"><a href="#orgab99f3e">Resourceとは何か</a></h2>
<div class="outline-text-2" id="text-orgab99f3e">
<p>
ECS用語におけるリソースとは何か。エンティティに関係ないデータのこと。マップデータとかかな。
</p>

<div class="org-src-container">
<pre class="src src-go">// Resources contains references to data not related to any entity
type Resources struct {
</pre>
</div>

<p>
↓ゲームリソース。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/game.go#L128-L135
</pre>
</div>

<div class="results" id="org9b31260">
<p>
// Game contains game resources
type Game struct {
	StateEvent StateEvent
	Package    PackageData
	Level      Level
	GridLayout GridLayout
	SaveConfig SaveConfig
}
</p>

</div>

<dl class="org-dl">
<dt>StateEvent</dt><dd>完了したかどうか</dd>
<dt>PackageData</dt><dd>読み込んだPackageのデータ。Packageはステージのセット</dd>
<dt>Level</dt><dd>現在の階層(難易度)。階層数、移動履歴、グリッド情報を持つ</dd>
</dl>
</div>
</div>

<div id="outline-container-org3b9895d" class="outline-2">
<h2 id="org3b9895d"><a href="#org3b9895d">タイル</a></h2>
<div class="outline-text-2" id="text-org3b9895d">
<p>
↓タイルの状態一覧。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/resources/game.go#L105-L112
</pre>
</div>

<div class="results" id="org68166b7">
<p>
// List of game tiles
const (
	TilePlayer = gloader.TilePlayer
	TileBox    = gloader.TileBox
	TileGoal   = gloader.TileGoal
	TileWall   = gloader.TileWall
	TileEmpty  = gloader.TileEmpty
)
</p>

</div>
</div>
</div>

<div id="outline-container-org86f7c0f" class="outline-2">
<h2 id="org86f7c0f"><a href="#org86f7c0f">stateとsystemの関係</a></h2>
<div class="outline-text-2" id="text-org86f7c0f">
<p>
stateによって適用systemが異なる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/gameplay.go#L65-L72
</pre>
</div>

<div class="results" id="org140dfc8">
<p>
func (st *GameplayState) Update(world w.World) states.Transition {
	g.SwitchLevelSystem(world)
	g.UndoSystem(world)
	g.MoveSystem(world)
	g.SaveSystem(world)
	g.InfoSystem(world, false)
	g.GridUpdateSystem(world)
	g.GridTransformSystem(world)
</p>

</div>
</div>
</div>

<div id="outline-container-org7931b0c" class="outline-2">
<h2 id="org7931b0c"><a href="#org7931b0c">移動はどうやっているか</a></h2>
<div class="outline-text-2" id="text-org7931b0c">
<p>
↓systemではこうしている。シンプルにリソースの値に応じてMove()を呼んでいる。ボタン押下に応じて、Actionsがセットされてるはず。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/move.go#L9-L11
</pre>
</div>

<div class="results" id="org9b5f8c9">
<p>
// MoveSystem moves player
func MoveSystem(world w.World) {
	moveUpAction := world.Resources.InputHandler.Actions[resources.MoveUpAction]
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/move.go#L21-L23
</pre>
</div>

<div class="results" id="orgffe80d1">
<p>
switch {
case moveUpAction || moveUpFastAction:
	resources.Move(world, resources.MovementUp)
</p>

</div>

<p>
↓Actionsの中身は、アクション文字列とboolのマップである。
</p>

<div class="org-src-container">
<pre class="src src-go">// InputHandler contains input axis values and actions corresponding to specified controls
type InputHandler struct {
	// Axes contains input axis values
	Axes map[string]float64
	// Actions contains input actions
	Actions map[string]bool
}
</pre>
</div>

<p>
↓このように、キーボード押下時Actionsにセットする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>func (st *LevelCompleteState) Update(world w.World) states.Transition {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/level_complete_menu.go#L121-L123
</pre>
</div>

<div class="results" id="orgb35158e">
<p>
if inpututil.IsKeyJustPressed(ebiten.KeyEnter) || inpututil.IsKeyJustPressed(ebiten.KeySpace) {
	world.Resources.InputHandler.Actions[resources.RestartAction] = true
}
</p>

</div>

<p>
↓そのあとsystemで処理する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>func SwitchLevelSystem(world w.World) bool {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/switch_level.go#L17
</pre>
</div>

<div class="results" id="orgf15c42b">
<p>
restartAction := world.Resources.InputHandler.Actions[resources.RestartAction]
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>func SwitchLevelSystem(world w.World) bool {}</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/systems/switch_level.go#L25-L28
</pre>
</div>

<div class="results" id="orgdfd6488">
<p>
case restartAction:
	gameResources.Level.Movements = []resources.MovementType{}
	gameResources.Level.Modified = true
	newLevel = gameResources.Level.CurrentNum
</p>

</div>
</div>
</div>

<div id="outline-container-org02a6e6e" class="outline-2">
<h2 id="org02a6e6e"><a href="#org02a6e6e">InputHandlerのリセットはどこでやっているか</a></h2>
<div class="outline-text-2" id="text-org02a6e6e">
<p>
world.Resources.InputHandlerはさまざまなところで使われている。これはボタンの押下状態に応じて値が変わるように見える。リセットが必要だが、どこでやっているか。
</p>

<p>
↓ECSライブラリのなかでやっている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>func InputSystem(world w.World) {}</label><pre class="src src-go">for k, v := range world.Resources.Controls.Actions {
	world.Resources.InputHandler.Actions[k] = isActionDone(v)
}
</pre>
</div>

<p>
↑InputSyste関数は、StateMachineのUpdateで呼ばれる。なので、毎回リセットされているのだろう。
</p>

<p>
この設計にすることで、キーボード押下を1箇所で管理できる。直接それぞれの箇所でキーボード押下を検知するよりも見通しやすい。キー検知は具体的すぎるコードだ。
</p>
</div>
</div>

<div id="outline-container-org52575e0" class="outline-2">
<h2 id="org52575e0"><a href="#org52575e0">メニューの抽象化</a></h2>
<div class="outline-text-2" id="text-org52575e0">
<p>
↓複数あるメニューは、このように抽象化されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/lib/states/menu.go#L16-L22
</pre>
</div>

<div class="results" id="org48f5467">
<p>
type menu interface {
	getSelection() int
	setSelection(selection int)
	confirmSelection(world w.World) states.Transition
	getMenuIDs() []string
	getCursorMenuIDs() []string
}
</p>

</div>
</div>
</div>

<div id="outline-container-orgded77ff" class="outline-2">
<h2 id="orgded77ff"><a href="#orgded77ff">どうやって描画しているか</a></h2>
<div class="outline-text-2" id="text-orgded77ff">
<ul class="org-ul">
<li>読み込み時にコンポーネントを初期化する
<ul class="org-ul">
<li>初期化 = Prefabをセットする</li>
<li>tomlから読み込む</li>
<li>主なコンポーネントはtext。idやtextなどを持つ</li>
<li>あるいはマウスに反応するコンポーネントもある</li>
</ul></li>
<li>各stateでsystemを実行し、コンポーネントに変更を加える</li>
<li>stateMachineの内でSystemを実行している。どのステートでも描画する</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>stateが描画している部分</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/goecsengine/blob/be27b724d4c8f46b9d31959fe91c4ecf188429ea/states/lib.go#L98-L103
</pre>
</div>

<div class="results" id="org1bfda78">
<p>
// Draw draws the screen after a state update
func (sm *StateMachine) Draw(world w.World, screen *ebiten.Image) {
	// Run drawing systems
	s.RenderSpriteSystem(world, screen)
	u.RenderUISystem(world, screen)
}
</p>

</div>

<p>
↓呼び出されているRenderSpriteSystemの抜粋。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>コンポーネントを描画する</label><pre class="src src-git-permalink">https://github.com/x-hgg-x/goecsengine/blob/be27b724d4c8f46b9d31959fe91c4ecf188429ea/systems/sprite/render.go#L21-L25
</pre>
</div>

<div class="results" id="orge759aa6">
<p>
<i>/ RenderSpriteSystem draws images.
/</i> Images are drawn in ascending order of depth.
// Images with higher depth are thus drawn above images with lower depth.
func RenderSpriteSystem(world w.World, screen *ebiten.Image) {
	sprites := world.Manager.Join(world.Components.Engine.SpriteRender, world.Components.Engine.Transform)
</p>

</div>
</div>
</div>

<div id="outline-container-org923c757" class="outline-2">
<h2 id="org923c757"><a href="#org923c757">StateMachineがどういう感じになっているか</a></h2>
<div class="outline-text-2" id="text-org923c757">
<p>
ステートのスタック構造を持っているが、これはどういう感じで推移するか。
</p>

<ul class="org-ul">
<li>おそらくスタック構造があるために、メニュー画面を出したあとに元のステートに戻れる</li>
<li>貯まり続けないことを保証するには</li>
</ul>
</div>
</div>

<div id="outline-container-orgfb1a2a6" class="outline-2">
<h2 id="orgfb1a2a6"><a href="#orgfb1a2a6">スプライトを動的に追加する</a></h2>
<div class="outline-text-2" id="text-orgfb1a2a6">
<p>
真っ黒な画像をスプライト画像として登録して、フェードアウトとしている。スプライトをファイルで読み込むほかに、こういったこともできる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/x-hgg-x/sokoban-go/blob/e9d204aeebe393d730fb4bdcb060d249f1470485/main.go#L73-L75
</pre>
</div>

<div class="results" id="orge157658">
<p>
textureImage := ebiten.NewImage(minGameWidth, minGameHeight)
textureImage.Fill(color.RGBA{A: 120})
spriteSheets[&ldquo;fadeOut&rdquo;] = ec.SpriteSheet{Texture: ec.Texture{Image: textureImage}, Sprites: []ec.Sprite{{Width: minGameWidth, Height: minGameHeight}}}
</p>

</div>
</div>
</div>

<div id="outline-container-orgf19df2c" class="outline-2">
<h2 id="orgf19df2c"><a href="#orgf19df2c">stateとentity</a></h2>
<div class="outline-text-2" id="text-orgf19df2c">
<p>
stateごとでファイルからentityを生成し直している。そこから、systemでいろいろentityを操作している。
</p>
</div>
</div>

<div id="outline-container-orgf3969d9" class="outline-2">
<h2 id="orgf3969d9"><a href="#orgf3969d9">Tasks</a></h2>
</div>
<div id="outline-container-orgaa49887" class="outline-2">
<h2 id="orgaa49887"><a href="#orgaa49887">Archives</a></h2>
<div class="outline-text-2" id="text-orgaa49887">
</div>
<div id="outline-container-org0b37c62" class="outline-3">
<h3 id="org0b37c62"><a href="#org0b37c62"><span class="done DONE">DONE</span> 読む</a></h3>
<div class="outline-text-3" id="text-org0b37c62">
<p>
コードを読む。
</p>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" class="footnum" href="#fnr.1">1</a></sup> <div class="footpara"><p class="footpara">
ゲームづくりの定石知識が足りてない。
</p></div></div>


</div>
</div></div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
