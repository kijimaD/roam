<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-08-12 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Docker</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">Docker</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org3199eec">概要</a></li>
<li><a href="#orgba5e46c">Memo</a>
<ul>
<li><a href="#org2904b34">GitHub Actionsでビルドする</a></li>
<li><a href="#orgecb8188">RUN &#x2013;mount=type=&#x2026;オプション</a></li>
<li><a href="#org41dc056">rake assets:precompile高速化</a></li>
<li><a href="#orgd453757">ビルドキャッシュをレジストリに保存し、CI環境でキャッシュを使ってビルドする</a></li>
<li><a href="#org7f8b023">本番用yarn buildの例</a></li>
<li><a href="#orgba0cb8c">Rails開発のMy docker-compose</a></li>
<li><a href="#orgbee6a89">docker service再起動</a></li>
<li><a href="#org0aadadc">コンテナ掃除関係</a></li>
<li><a href="#org4b27ccd">ディスク使用率がとんでもないことになっていたとき</a></li>
<li><a href="#org2009081">entrypoint.sh</a></li>
<li><a href="#orge902806">docker-composeとdocker</a></li>
<li><a href="#org03a9501">よく使うdockerオプション</a></li>
<li><a href="#orgcb10434">buildkitをオンにする</a></li>
<li><a href="#orgd0fdf30">docker-composeでマウントしたときにnode_modulesが消える問題</a></li>
<li><a href="#org0c19574">dockleでセキュリティチェック</a></li>
<li><a href="#orgbe74f32">pushスクリプト</a></li>
<li><a href="#orgaafa97e">実行後にコンテナ削除</a></li>
<li><a href="#org284d134">コンテナ間の接続はサービス名を用いる</a></li>
<li><a href="#org2e48235">rootユーザでファイル作成しないようにする</a></li>
<li><a href="#org26f891a">Docker Hub</a></li>
<li><a href="#org0059070">マルチステージビルドとは</a></li>
<li><a href="#org089ce72">Dockerfileは何か</a></li>
<li><a href="#org57a6123">コンテナ内でコマンド実行する</a></li>
<li><a href="#orgd0d8342">キャッシュを使わずにbuildする</a></li>
<li><a href="#orgc227697">立ち上げと停止</a></li>
<li><a href="#orgffac63c">docker外に公開する</a></li>
<li><a href="#orgea677c6">ポート指定する</a></li>
<li><a href="#org6aefec4">ログを確認する</a></li>
<li><a href="#orgdd6a4bc">イメージを削除する</a></li>
</ul>
</li>
<li><a href="#orgf43f5f1">Tasks</a>
<ul>
<li><a href="#org940de49"><span class="todo TODO">TODO</span> コンテナはどういう仕組みか</a></li>
<li><a href="#orgdf87960"><span class="todo TODO">TODO</span> Golang UK Conf. 2016 - Liz Rice - What is a container, really? Let&rsquo;s write one in Go from scratch - YouTube</a></li>
<li><a href="#orgaaafb40"><span class="todo TODO">TODO</span> イラストでわかる DockerとKubernetes：書籍案内｜技術評論社</a></li>
<li><a href="#org0286855"><span class="todo TODO">TODO</span> 「コンテナジャーニー」〜明日から速攻始めるAWSでのコンテナ導入運用〜 #cmdevio2018 | DevelopersIO</a></li>
<li><a href="#org59cee83"><span class="todo TODO">TODO</span> BuildKitによりDockerとDocker Composeで外部キャッシュを使った効率的なビルドをする方法 - Qiita</a></li>
<li><a href="#org3782506"><span class="todo TODO">TODO</span> Dockerfileを改善するためのBest Practice 2019年版</a></li>
<li><a href="#orgc40808c"><span class="todo TODO">TODO</span> ゴミファイルができないようにする</a></li>
<li><a href="#orgad9b3ed"><span class="todo TODO">TODO</span> Nginx, UnicornをDocker化</a></li>
<li><a href="#org1c1c628">Rails開発 Docker環境化<code>[7/9]</code></a>
<ul>
<li><a href="#org607ef90"><span class="todo TODO">TODO</span> rails c内で日本語が含まれると失敗する</a></li>
<li><a href="#orge520c59"><span class="todo TODO">TODO</span> CapybaraでJavascriptをオンにしたときsystem specが失敗する</a></li>
<li><a href="#orgd8ccdcd"><span class="done DONE">DONE</span> migration時にschemaに変な差分が出る</a></li>
<li><a href="#org706a6e8"><span class="done DONE">DONE</span> 非同期処理の動作確認</a></li>
<li><a href="#orge92b4d1"><span class="done DONE">DONE</span> dockerがrootユーザでファイルを生成する問題</a></li>
<li><a href="#org140f243"><span class="done DONE">DONE</span> 基本コマンド</a></li>
<li><a href="#org1dbd49c"><span class="done DONE">DONE</span> docker-compose.ymlのオーバーライド</a></li>
<li><a href="#org53dce76"><span class="done DONE">DONE</span> DBのGUIツールとの接続</a></li>
<li><a href="#orgc3ae525"><span class="done DONE">DONE</span> yarnができてない</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgc7c784d">Archives</a>
<ul>
<li><a href="#org27e3b83"><span class="done DONE">DONE</span> 社内のDockerfileのベストプラクティスを公開します│FORCIA CUBE│フォルシア株式会社</a></li>
<li><a href="#orgf868ff5"><span class="done DONE">DONE</span> タスクを簡単に実行する方法を調べる</a></li>
</ul>
</li>
<li><a href="#org8e6bf5c">References</a>
<ul>
<li><a href="#org0ac826a">Build Containers the Hard Way (WIP) - Build Containers the Hard Way</a></li>
<li><a href="#org2cadab7">docker-slim/docker-slim: DockerSlim (docker-slim): Don&rsquo;t change anything in your Docker container image and minify it by up to 30x (and for compiled languages even more) making it secure too! (free and open source)</a></li>
<li><a href="#orgea07ae8">wagoodman/dive: A tool for exploring each layer in a docker image</a></li>
<li><a href="#org559d42b">Docker とは - 解説、メリット、できること | Red Hat</a></li>
<li><a href="#org47ffaab">Docker - Wikipedia</a></li>
<li><a href="#org5fa4fad">phusion/passenger-docker: Docker base images for Ruby, Python, Node.js and Meteor web apps</a></li>
<li><a href="#orge2d7719">The Twelve-Factor App</a></li>
<li><a href="#orgca42fe9">Docker ドキュメント日本語版 PDF ダウンロード — Docker-docs-ja 19.03 ドキュメント</a></li>
<li><a href="#orgb760297">キャッシュのためにDockerビルドで中間イメージをタグ付けしレジストリにPushする - 🤖</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org3199eec" class="outline-2">
<h2 id="org3199eec"><a href="#org3199eec">概要</a></h2>
<div class="outline-text-2" id="text-org3199eec">
<p>
Dockerはパフォーマンスに優れた仮想環境を作るプログラム。
得られる可搬性によって、作成したイメージを開発における各ステージ(テスト、ビルド、リリース…)で適用できるようになる。
その意味で<a href="20220212141124-ci.html#ID-eaf6ed04-7927-4a16-ba94-fbb9f6e76166">CI</a>, <a href="20220212141243-cd.html#ID-2c4cb3a7-7a8a-4a3b-88c2-2c5e69515764">CD</a>の基礎的な技術となっている。
</p>
</div>
</div>
<div id="outline-container-orgba5e46c" class="outline-2">
<h2 id="orgba5e46c"><a href="#orgba5e46c">Memo</a></h2>
<div class="outline-text-2" id="text-orgba5e46c">
</div>
<div id="outline-container-org2904b34" class="outline-3">
<h3 id="org2904b34"><a href="#org2904b34"><a href="20220427215330-github_actions.html#ID-2d35ac9e-554a-4142-bba7-3c614cbfe4c4">GitHub Actions</a>でビルドする</a></h3>
<div class="outline-text-3" id="text-org2904b34">
<p>
<a href="20220212141124-ci.html#ID-eaf6ed04-7927-4a16-ba94-fbb9f6e76166">CI</a>によるコンテナビルドには、&#x2013;cache-from を使って、レジストリに送信したイメージから各ステージのキャッシュを取得していく方法と、CIのキャッシュ機能を使う方法の2つがある。
</p>

<p>
レジストリからキャッシュを取る方法には弱点がある。
</p>

<ul class="org-ul">
<li>キャッシュが登録イメージの1つしかない。たとえば異なるブランチでキャッシュが更新されると、キャッシュが失われる</li>
<li>&#x2013;mount=type=&#x2026;のcacheが、pushイメージには含まれない</li>
<li>ステージごとにキャッシュ通信(取得+送信)をするが、オーバーヘッドが大きい</li>
<li>イメージに含めることができるキャッシュ(inline cache)には、minモードしか適用できない。つまりキャッシュに制限がある <a href="https://github.com/moby/buildkit#--export-cache-options">moby/buildkit: concurrent, cache-efficient, and Dockerfile-agnostic builder toolkit</a></li>
</ul>

<p>
のため、CIのキャッシュ機能を使うのが現実的か。複数のキャッシュ…ブランチごと、Gemfileのハッシュ値ごとでハッシュを保持できるためキャッシュがヒットしやすい。キャッシュはひとまとめで保存され、レジストリへの送信イメージは利用イメージだけになる。
</p>
</div>
</div>
<div id="outline-container-orgecb8188" class="outline-3">
<h3 id="orgecb8188"><a href="#orgecb8188">RUN &#x2013;mount=type=&#x2026;オプション</a></h3>
<div class="outline-text-3" id="text-orgecb8188">
<p>
ビルド時にだけアクセスできる、cacheマウントを利用できる。マウントと言うが、ホストマシンとは関係ない。マウントディレクトリはビルド後削除されるため、イメージサイズにも優しい。
<a href="https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/syntax.md">https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/syntax.md</a>
</p>

<pre class="example">
RUN --mount=type=cache,target=/root/.cache/go-build go build
</pre>

<p>
たとえばpackage.jsonに変更があったときも途中から再開できる。ビルドキャッシュがヒットする/しないのゼロイチでなくなる。
</p>
</div>
</div>
<div id="outline-container-org41dc056" class="outline-3">
<h3 id="org41dc056"><a href="#org41dc056">rake assets:precompile高速化</a></h3>
<div class="outline-text-3" id="text-org41dc056">
<ul class="org-ul">
<li>public/assets</li>
<li>tmp/cache/assets</li>
</ul>

<p>
をキャッシュしておくことで高速化できる。
</p>
</div>
</div>
<div id="outline-container-orgd453757" class="outline-3">
<h3 id="orgd453757"><a href="#orgd453757">ビルドキャッシュをレジストリに保存し、CI環境でキャッシュを使ってビルドする</a></h3>
<div class="outline-text-3" id="text-orgd453757">
<p>
レジストリのキャッシュを利用してビルドできる。これによって、キャッシュがローカル環境に保持されない<a href="20220212141124-ci.html#ID-eaf6ed04-7927-4a16-ba94-fbb9f6e76166">CI</a>環境などでもキャッシュを利用して高速にビルドできる。
</p>

<p>
ポイントは&#x2013;build-argと&#x2013;cache-from。
&#x2013;build-argでメタ情報を含めてビルドする。このイメージをpushしておくことで、次回からキャッシュを利用できる。
&#x2013;cache-fromによってレジストリにある指定イメージからキャッシュを取得してビルドする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>&#x2013;cache-from と &#x2013;build-arg BUILDKIT_INLINE_CACHE=1</label><pre class="src src-shell">docker build --target build -t ghcr.io/kijimad/roam-build:master --cache-from ghcr.io/kijimad/roam-build:master --build-arg <span class="org-variable-name">BUILDKIT_INLINE_CACHE</span>=1 .
docker push ghcr.io/kijimad/roam-build:master
</pre>
</div>
</div>
</div>
<div id="outline-container-org7f8b023" class="outline-3">
<h3 id="org7f8b023"><a href="#org7f8b023">本番用yarn buildの例</a></h3>
<div class="outline-text-3" id="text-org7f8b023">
<p>
本番用にコンパクトにビルドする場合の例。
node_modulesはいらなくて、ビルド成果物だけあればよい。
ステージを分けることで、意味が明確になり、サイズも小さくできる(高速化)。
</p>

<div class="org-src-container">
<pre class="src src-dockerfile">COPY package.json $HOME/
COPY front/ $HOME/front/ # front にはビルド対象のjs, tsファイルが配置されている想定。サブモジュールを導入している場合、package.jsonは階層上に複数あるため、COPYしておく必要がある

RUN npm install

COPY babel.config.js $HOME/
COPY tsconfig.json $HOME/
COPY webpack.config.js $HOME/

RUN yarn run build
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>ビルド成果物だけを配置</label><pre class="src src-dockerfile">COPY --from=rails-yarn-build $HOME/public/webpack/ $HOME/public/webpack/
</pre>
</div>
</div>
</div>
<div id="outline-container-orgba0cb8c" class="outline-3">
<h3 id="orgba0cb8c"><a href="#orgba0cb8c">Rails開発のMy docker-compose</a></h3>
<div class="outline-text-3" id="text-orgba0cb8c">
<p>
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>開発をすべてdockerでやる想定。
一発ですべてが準備され、クリーンな環境を構築する。bundle install やyarn install など、立ち上げ続ける前提でないコマンドも含まれる。そのコマンドだけ再度実行したいときは <code>docker-compose restart bundle</code> などとする。
</p>

<p>
元ネタ: foremのdocker-compose.yml。
</p>
<ul class="org-ul">
<li><a href="https://github.com/forem/forem">https://github.com/forem/forem</a></li>
</ul>

<p>
↓あとはdockerizeを設定すれば完璧か。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>docker-compose.yml</label><pre class="src src-yaml"># 共通のimage名: app
# imageのワーキングディレクトリ: /app
version: '3.7'

services:
  mysql:
    image: mysql:latest
    ports:
      - '${MYSQL_PORT:-3306}:3306'
    environment:
      # DBクライアントでの接続時に必要なので明示する
      MYSQL_DATABASE: develop
      MYSQL_ROOT_PASSWORD: root
      MYSQL_USER: user
      MYSQL_PASSWORD: password
      MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
    volumes:
      - 'mysql-data:/var/lib/mysql'

  redis:
    image: redis:latest
    ports:
      - '${REDIS_PORT:-6379}:6379'

  memcached:
    image: memcached:latest
    ports:
      - '${MEMCACHED_PORT:-11212}:11211'

  rails:
    image: app
    environment:
      RAILS_ENV: development
      REDIS_URL: 'redis://redis:6379'
      MEMCACHED: 'memcached:11211'
      DATABASE_URL: 'mysql2://root@mysql:3306'
    depends_on:
      - mysql
      - redis
      - memcached
      - bundle
      - yarn
      - seed
    command: bash -c 'bundle exec rails s -b 0.0.0.0'
    volumes:
      - .:/app:delegated # delegatedで高速化
      - gem_data:/usr/local/bundle:delegated # package系は永続化して最初からinstallにならないようにする
      - node_modules:/app/node_modules:delegated
    ports:
      - '3000:3000'

  webpack:
    image: app
    environment:
      NODE_ENV: development
      WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
    command: bash -c 'yarn watch'
    volumes:
      - .:/app:delegated
      - node_modules:/app/node_modules:delegated
    ports:
      - 8080:8080

  sidekiq:
    image: app
    command: bash -c 'bundle exec sidekiq -C config/sidekiq.yml'
    environment:
      REDIS_URL: 'redis://redis:6379'
      DATABASE_URL: 'mysql2://root@mysql:3306'
    volumes:
      - .:/app:delegated
      - gem_data:/usr/local/bundle:delegated
    links:
      - mysql
      - redis

  bundle:
    image: app
    environment:
      RAILS_ENV: development
    volumes:
      - .:/app:delegated
      - gem_data:/usr/local/bundle:delegated
    command: bash -c "bundle install --jobs 8" # マシンがいくつ並列処理できるかは`$ getconf _NPROCESSORS_ONLN` で調べられる

  yarn:
    image: app
    environment:
      NODE_ENV: development
    volumes:
      - .:/app:delegated
      - node_modules:/app/node_modules:delegated
    command: bash -c "yarn install"

  seed:
    image: app
    environment:
      DATABASE_URL: 'mysql2://root@mysql:3306'
    volumes:
      - .:/app:delegated
      - gem_data:/usr/local/bundle:delegated
    command: bash -c "rake db:seed_fu"

volumes:
  gem_data:
  node_modules:
  mysql_data:
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>entrypoint.sh</label><pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">! /bin/</span><span class="org-keyword">bash</span>

<span class="org-builtin">set</span> -e

<span class="org-keyword">if</span> [ -f tmp/pids/server.pid ]; <span class="org-keyword">then</span>
  rm -f tmp/pids/server.pid
<span class="org-keyword">fi</span>

cat &lt;&lt; EOF

<span class="org-sh-heredoc">  &#9617;&#9617;&#9604;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9604;&#9616;&#9608;&#9604;&#9604;&#9604;&#9604;&#9608;&#9612;&#9617;</span>
<span class="org-sh-heredoc">  &#9617;&#9617;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9612;&#9600;&#9600;&#9608;&#9608;&#9600;&#9600;&#9617;&#9617;</span>
<span class="org-sh-heredoc">  &#9617;&#9617;&#9608;&#9608;&#9608;&#9608;&#9604;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9604;&#9604;&#9608;&#9612;&#9617;&#9617;&#9617;&#9617;</span>
<span class="org-sh-heredoc">  &#9617;&#9617;&#9604;&#9604;&#9604;&#9604;&#9604;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9600; &#9617;&#9617;&#9617;&#9617;</span>

<span class="org-sh-heredoc">EOF</span>

<span class="org-keyword">exec</span> <span class="org-string">"$@"</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-orgbee6a89" class="outline-3">
<h3 id="orgbee6a89"><a href="#orgbee6a89">docker service再起動</a></h3>
<div class="outline-text-3" id="text-orgbee6a89">
<p>
おかしくなったときの再起動。
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo service docker restart
</pre>
</div>
</div>
</div>
<div id="outline-container-org0aadadc" class="outline-3">
<h3 id="org0aadadc"><a href="#org0aadadc">コンテナ掃除関係</a></h3>
<div class="outline-text-3" id="text-org0aadadc">
<p>
<a href="https://qiita.com/shisama/items/48e2eaf1dc356568b0d7">コマンドでDockerコンテナを停止・削除、イメージの削除をする - Qiita</a>
</p>

<div class="org-src-container">
<pre class="src src-shell">docker stop $(docker ps -q) <span class="org-comment-delimiter"># </span><span class="org-comment">&#20840;&#12467;&#12531;&#12486;&#12490;&#20572;&#27490;</span>
docker rm $(docker ps -q -a) <span class="org-comment-delimiter"># </span><span class="org-comment">&#20840;&#12467;&#12531;&#12486;&#12490;&#21066;&#38500;</span>
docker rmi $(docker images -q) <span class="org-comment-delimiter"># </span><span class="org-comment">&#20840;&#12452;&#12513;&#12540;&#12472;&#21066;&#38500;:</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4b27ccd" class="outline-3">
<h3 id="org4b27ccd"><a href="#org4b27ccd">ディスク使用率がとんでもないことになっていたとき</a></h3>
<div class="outline-text-3" id="text-org4b27ccd">
<p>
ディスク使用率がほぼ100％になっていた。占めているほとんどはDocker関係のようだった。
イメージは削除するようにしてたが、ほかにも色々あるよう。
</p>

<p>
専用のページがある。
<a href="https://docs.docker.com/config/pruning/">https://docs.docker.com/config/pruning/</a>
</p>

<p>
非常に多くのゴミがありそうだったので、多少再pullに時間がかかることを許容してすべて削除することにした。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>手っ取り早くすべて消す。警告が出る</label><pre class="src src-shell">docker system prune
</pre>
</div>

<p>
ゴリゴリbuildして試しているときは、気をつけたほうがよさそう。
</p>

<p>
キャッシュ削除だけ行う。この場合が多そう。
</p>
<div class="org-src-container">
<pre class="src src-shell">docker builder prune
</pre>
</div>
</div>
</div>
<div id="outline-container-org2009081" class="outline-3">
<h3 id="org2009081"><a href="#org2009081">entrypoint.sh</a></h3>
<div class="outline-text-3" id="text-org2009081">
<p>
公式Docker Imageでよく用いられる、コンテナ起動時に実行するスクリプト。
公式のイメージのままで、初回起動時に実行したいフックとして記述できる。
</p>

<p>
例(Dockerfile): <a href="https://github.com/tzumby/rails-on-kubernetes/blob/master/Dockerfile">rails-on-kubernetes/Dockerfile at master · tzumby/rails-on-kubernetes</a>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Dockerfileの末尾で取り込む</label><pre class="src src-shell">ADD . /myapp

COPY docker-entrypoint.sh /usr/local/bin

ENTRYPOINT [<span class="org-string">"docker-entrypoint.sh"</span>]
</pre>
</div>

<p>
例(entrypoint.sh): <a href="https://github.com/tzumby/rails-on-kubernetes/blob/master/docker-entrypoint.sh">rails-on-kubernetes/docker-entrypoint.sh at master · tzumby/rails-on-kubernetes</a>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>entrypoint.sh $@は引数</label><pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>

<span class="org-builtin">set</span> -e

<span class="org-keyword">if</span> [ -f tmp/pids/server.pid ]; <span class="org-keyword">then</span>
  rm tmp/pids/server.pid
<span class="org-keyword">fi</span>

<span class="org-builtin">echo</span> <span class="org-string">"Waiting for Postgres to start..."</span>
<span class="org-keyword">while</span> <span class="org-negation-char">!</span> nc -z postgres 5432; <span class="org-keyword">do</span> sleep 0.1; <span class="org-keyword">done</span>
<span class="org-builtin">echo</span> <span class="org-string">"Postgres is up"</span>

<span class="org-builtin">echo</span> <span class="org-string">"Waiting for Redis to start..."</span>
<span class="org-keyword">while</span> <span class="org-negation-char">!</span> nc -z redis 6379; <span class="org-keyword">do</span> sleep 0.1; <span class="org-keyword">done</span>
<span class="org-builtin">echo</span> <span class="org-string">"Redis is up - execuring command"</span>

<span class="org-keyword">exec</span> bundle exec <span class="org-string">"$@"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge902806" class="outline-3">
<h3 id="orge902806"><a href="#orge902806">docker-composeとdocker</a></h3>
<div class="outline-text-3" id="text-orge902806">
<p>
docker-composeは自動でタグ名をつけてくれたり、マウントしてくれたり、dockerコマンドよりややこしくなりにくい。
単に開発環境として使っているだけでは、ほとんどdocker-composeで事足りる。
が、docker-composeへ依存しているということで、docker-compose関係ない別の文脈で使おうとすると途端に動かなくなる。本質的にdocker-composeはコンテナ間の関係性を記述しているだけで、コンテナ自体を表現しているわけではない。
</p>

<p>
本当にdockerコンテナとしての正しい使い方をしているかテストするには、コンテナを複数のデプロイやCIで利用してみるのがよい。同じ流れで簡単にできたのなら正しい。簡単にできないなら何かが間違っている。
</p>
</div>
</div>
<div id="outline-container-org03a9501" class="outline-3">
<h3 id="org03a9501"><a href="#org03a9501">よく使うdockerオプション</a></h3>
<div class="outline-text-3" id="text-org03a9501">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>例</label><pre class="src src-shell">docker run --rm -v <span class="org-string">"$PWD/"</span>:/roam -w /roam ghcr.io/kijimad/roam:master sh deploy.sh
</pre>
</div>

<p>
<code>--rm</code> : コマンド実行後にコンテナを削除する
<code>-v</code>: ホストマシンにマウントする。左がホストマシン、右がコンテナ内。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>-itの意味: 対話モード</label><pre class="src src-shell">docker run --rm -it ghcr.io/kijimad/roam:master
</pre>
</div>
<p>
-it はttyオプション。インタラクティブなシェルを作成する。つけないと、一瞬で消える。
</p>
</div>
</div>
<div id="outline-container-orgcb10434" class="outline-3">
<h3 id="orgcb10434"><a href="#orgcb10434">buildkitをオンにする</a></h3>
<div class="outline-text-3" id="text-orgcb10434">
<p>
環境変数をオンにすることで、新しい機能が使えるようになる。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>shell</label><pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">COMPOSE_DOCKER_CLI_BUILD</span>=1
<span class="org-builtin">export</span> <span class="org-variable-name">DOCKER_BUILDKIT</span>=1
docker build .
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd0fdf30" class="outline-3">
<h3 id="orgd0fdf30"><a href="#orgd0fdf30">docker-composeでマウントしたときにnode_modulesが消える問題</a></h3>
<div class="outline-text-3" id="text-orgd0fdf30">
<ol class="org-ol">
<li>npm install するコンテナを作成</li>
<li>コンテナをマウント</li>
<li>ホストマシンにないnode_modulesは消える</li>
<li>エラー</li>
</ol>

<p>
なので、node_modulesもマウントする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>dockerコマンドの場合。-v を2つで指定する</label><pre class="src src-shell">docker run --rm -v <span class="org-string">"$PWD"</span>:/roam -v /roam/node_modules ghcr.io/kijimad/roam_lint:master make textlint
</pre>
</div>

<p>
<a href="https://rara-world.com/dockerfile-node-modules/">https://rara-world.com/dockerfile-node-modules/</a> に書いてあった。
</p>
</div>
</div>
<div id="outline-container-org0c19574" class="outline-3">
<h3 id="org0c19574"><a href="#org0c19574">dockleでセキュリティチェック</a></h3>
<div class="outline-text-3" id="text-org0c19574">
<p>
dockleというツールでイメージをチェックできる。
<a href="https://github.com/goodwithtech/dockle">goodwithtech/dockle: Container Image Linter for Security, Helping build the Best-Practice Docker Image, Easy to start</a>
</p>

<p>
自前のイメージにかけるとたくさん見つかった。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>実行してみた</label><pre class="src src-shell">$ dockle ghcr.io/kijimad/roam:4f3296b
FATAL   - DKL-DI-0001: Avoid sudo command
        * Avoid sudo<span class="org-keyword"> in</span> container : /bin/sh -c yum -y update &amp;&amp;     yum -y install         yum-utils
      gcc         gcc-c++         make         openssl-devel         openssh-server         readline
nuplot
WARN    - CIS-DI-0001: Create a user for the container
        * Last user should not be root
INFO    - CIS-DI-0005: Enable Content trust for Docker
        * export <span class="org-variable-name">DOCKER_CONTENT_TRUST</span>=1 before docker pull/build
INFO    - CIS-DI-0006: Add HEALTHCHECK instruction to the container image
        * not found HEALTHCHECK statement
INFO    - CIS-DI-0008: Confirm safety of setuid/setgid files
        * setgid file: g--x--x--x usr/libexec/openssh/ssh-keysign
        * setuid file: urwxr-xr-x usr/sbin/pam_timestamp_check
        * setuid file: urwxr-xr-x usr/bin/mount
        * setgid file: grwx--x--x usr/libexec/utempter/utempter
        * setuid file: urwxr-xr-x usr/bin/chage
        * setuid file: urwxr-xr-x usr/bin/su
        * setuid file: urwxr-x--- usr/libexec/dbus-1/dbus-daemon-launch-helper
        * setuid file: urwxr-xr-x usr/sbin/unix_chkpwd
        * setuid file: u--x--x--x usr/bin/sudo
        * setgid file: g--x--x--x usr/bin/ssh-agent
        * setuid file: urwxr-xr-x usr/bin/umount
        * setuid file: urwxr-xr-x usr/bin/gpasswd
        * setuid file: urwxr-xr-x usr/bin/newgrp
        * setgid file: grwxr-xr-x usr/bin/write
INFO    - DKL-LI-0003: Only put necessary files
        * Suspicious directory : roam/.git
        * Suspicious directory : usr/local/plugins/ruby-build/.git
        * Suspicious directory : usr/local/plugins/ruby-build/test/tmp
        * Suspicious directory : tmp
        * unnecessary file : roam/docker-compose.yml
        * unnecessary file : roam/Dockerfile
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbe74f32" class="outline-3">
<h3 id="orgbe74f32"><a href="#orgbe74f32">pushスクリプト</a></h3>
<div class="outline-text-3" id="text-orgbe74f32">
<p>
<a href="https://www.amazon.co.jp/dp/B01N0SS6NF/ref=dp-kindle-redirect?_encoding=UTF8&amp;btkr=1">Amazon.co.jp: Deploying Rails with Docker, Kubernetes and ECS (English Edition) eBook : Acuña, Pablo: Foreign Language Books</a> に載ってたスクリプト。書いてリポジトリに入れておくとスムーズにビルドやプッシュができる。
レジストリ・ユーザ名・リポジトリを適宜変える。
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>

<span class="org-variable-name">LC</span>=$(git rev-parse --short HEAD)
docker build -t ghcr.io/kijimad/webapp:${<span class="org-variable-name">LC</span>} .
docker push ghcr.io/kijimad/webapp:${<span class="org-variable-name">LC</span>}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgaafa97e" class="outline-3">
<h3 id="orgaafa97e"><a href="#orgaafa97e">実行後にコンテナ削除</a></h3>
<div class="outline-text-3" id="text-orgaafa97e">
<p>
docker run するとコンテナ内に入れるが、作ったコンテナはそのままになる。
実行後に削除して欲しい場合は、 <code>docker --rm webapp /bin/sh</code> などrmオプションを使う。
</p>
</div>
</div>
<div id="outline-container-org284d134" class="outline-3">
<h3 id="org284d134"><a href="#org284d134">コンテナ間の接続はサービス名を用いる</a></h3>
<div class="outline-text-3" id="text-org284d134">
<p>
コンテナ間の接続をしようとして、このようなエラーが出た。
</p>
<blockquote>
<p>
Error connecting to Redis on 127.0.0.1:6379 (Errno::ECONNREFUSED)
</p>
</blockquote>

<p>
127.0&#x2026;とあることから、コンテナ内のアドレスを見に行ってる。
コンテナ間での通信には、サービス名のアドレスを追加する必要がある。
</p>
</div>
</div>
<div id="outline-container-org2e48235" class="outline-3">
<h3 id="org2e48235"><a href="#org2e48235">rootユーザでファイル作成しないようにする</a></h3>
<div class="outline-text-3" id="text-org2e48235">
<p>
Dockerコンテナ内でファイルを作成すると、ownerがrootになり編集や削除ができず面倒。
Dockerの内部ではユーザid(uid)やグループid(gid)がホストと異なる。idがホストマシンと合わないためrootとして実行されたことになる、よう。
</p>

<p>
安易な解決策としては、権限をホストユーザに変更すれば問題ない。
とはいえ、コンテナ内のサービスが新しくファイルを作るたび(たとえばマイグレーションファイル生成)に実行するのは面倒。
<a href="https://docs.docker.com/samples/rails/">If you are running Docker on Linux, the files rails new created are owned by root.</a>
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>権限変更</label><pre class="src src-shell">sudo chown -R $<span class="org-variable-name">USER</span>:$<span class="org-variable-name">USER</span> .
</pre>
</div>

<p>
解決策としてはいくつか種類があるようなのだが、とりあえずできた。
サービスのvolumesにユーザ情報をマウントする。:roは読み取り専用(read onlyか)。
これでidの照合元がホストと同じになる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>docker-compose.yml</label><pre class="src src-yaml">volumes:
  - .:/rails
</pre>
</div>

<p>
あとはidを環境変数経由で渡せば、コンテナ内でもホストのユーザが実行したことになる。
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo docker run -u <span class="org-string">"$(id -u $USER):$(id -g $USER)"</span> rails /bin/sh
sudo docker-compose run -u <span class="org-string">"$(id -u $USER):$(id -g $USER)"</span> rails /bin/sh
</pre>
</div>

<p>
overrideがある場合、このようになる(長すぎ)。
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run -u <span class="org-string">"$(id -u $USER):$(id -g $USER)"</span> rails /bin/sh
</pre>
</div>

<p>
<a href="https://blog.amedama.jp/entry/docker-container-host-same-user">Docker コンテナ内で Docker ホストと同じユーザを使う - CUBE SUGAR CONTAINER</a>
</p>
</div>
</div>
<div id="outline-container-org26f891a" class="outline-3">
<h3 id="org26f891a"><a href="#org26f891a">Docker Hub</a></h3>
<div class="outline-text-3" id="text-org26f891a">
<p>
Dockerイメージをインターネット上にアップロードできるスペース。
個別にビルドしなくてよくなるためDocker関連の全工程が高速化する。テスト、ローカル、デプロイ…。
</p>
</div>
</div>
<div id="outline-container-org0059070" class="outline-3">
<h3 id="org0059070"><a href="#org0059070">マルチステージビルドとは</a></h3>
<div class="outline-text-3" id="text-org0059070">
<p>
サイトをDockerデプロイにしたり、CIをDockerで行うとき。
複数の環境が関係する場合、マルチステージビルドを行うとキャッシュが効くため高速化できる。
</p>

<ul class="org-ul">
<li>Linux関連のイメージ</li>
<li><a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a>関連のイメージ</li>
<li>node関連のイメージ</li>
<li><a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>アプリのイメージ</li>
</ul>

<p>
のように。
Linux → <a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a> + node → <a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a> という依存関係になる。
</p>
</div>
</div>
<div id="outline-container-org089ce72" class="outline-3">
<h3 id="org089ce72"><a href="#org089ce72">Dockerfileは何か</a></h3>
<div class="outline-text-3" id="text-org089ce72">
<p>
Dockrfileはイメージを作る。(image build)
docker-compose upは↑で作られたイメージを元にコンテナを作り起動までする。そのなかアプリケーションを走らせて開発する。
</p>

<p>
image構築 → コンテナ構築 → コンテナ起動 という流れ。
</p>

<p>
コンテナの作り方には2種類ある。
</p>
<ul class="org-ul">
<li>自作する必要があるものは↑Dockerfileで作る</li>
<li>既存コンテナ(<a href="20210829232020-mysql.html#ID-7dab097c-60ba-43b9-949f-c58bf3151aa8">MySQL</a>とか)はイメージをダウンロードする</li>
</ul>
</div>
</div>
<div id="outline-container-org57a6123" class="outline-3">
<h3 id="org57a6123"><a href="#org57a6123">コンテナ内でコマンド実行する</a></h3>
<div class="outline-text-3" id="text-org57a6123">
<p>
コンテナ内部で実行したいコマンドがあるときにやりたいこと、たとえば<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>だと、gemfileが新しくなったときにbundle installしたい。
</p>

<p>
runは新しくコンテナを作成し、内部でコマンドを実行する。サービス名はdocker-compose.ymlから取っている。つまり立ち上がっているコンテナ名は関係ないのに注意。何も指定してない場合、docker-compose.ymlからサービス名を決定する。ほかのファイルの場合には-fオプションが必要。外部で永続化される…volumeが指定されてるような処理(bundle install)とか、データベース関係はいいのだが、その他は永続化されないので注意。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>run</label><pre class="src src-shell">docker-compose run {&#12469;&#12540;&#12499;&#12473;&#21517;} {shell&#12467;&#12510;&#12531;&#12489;}
</pre>
</div>

<p>
execはコンテナを再利用してコマンドを実行する。高速。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>exec</label><pre class="src src-shell">docker-compose exec {&#12469;&#12540;&#12499;&#12473;&#21517;} {shell&#12467;&#12510;&#12531;&#12489;}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd0d8342" class="outline-3">
<h3 id="orgd0d8342"><a href="#orgd0d8342">キャッシュを使わずにbuildする</a></h3>
<div class="outline-text-3" id="text-orgd0d8342">
<div class="org-src-container">
<pre class="src src-shell">docker-compose build --no-cache
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc227697" class="outline-3">
<h3 id="orgc227697"><a href="#orgc227697">立ち上げと停止</a></h3>
<div class="outline-text-3" id="text-orgc227697">
<div class="org-src-container">
<pre class="src src-shell">docker-compose up --build -d <span class="org-comment-delimiter"># </span><span class="org-comment">&#12467;&#12531;&#12486;&#12490;&#20316;&#25104;&#12377;&#12427;</span>
docker-compose down
</pre>
</div>
</div>
</div>
<div id="outline-container-orgffac63c" class="outline-3">
<h3 id="orgffac63c"><a href="#orgffac63c">docker外に公開する</a></h3>
<div class="outline-text-3" id="text-orgffac63c">
<p>
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>
Dockerfileで。
</p>
<div class="org-src-container">
<pre class="src src-shell">CMD bundle exec rails server -b 0.0.0.0
</pre>
</div>

<p>
などと書いておくと、外部(Docker外)からアクセスできるようになる。-b 0.0.0.0 がないと別のネットワークからアクセスが不可。コンテナを超えると別のネットワーク扱いになるのでこの記述が必要。
</p>
</div>
</div>
<div id="outline-container-orgea677c6" class="outline-3">
<h3 id="orgea677c6"><a href="#orgea677c6">ポート指定する</a></h3>
<div class="outline-text-3" id="text-orgea677c6">
<p>
どっちだったか忘れる。
左が公開、右がコンテナ内。だからブラウザでポート8000アクセスできるようになる。
</p>
<div class="org-src-container">
<pre class="src src-shell">docker run -p 8000:3000 -it bdd92ace66ec
</pre>
</div>
</div>
</div>
<div id="outline-container-org6aefec4" class="outline-3">
<h3 id="org6aefec4"><a href="#org6aefec4">ログを確認する</a></h3>
<div class="outline-text-3" id="text-org6aefec4">
<div class="org-src-container">
<pre class="src src-shell">docker ps -a <span class="org-comment-delimiter"># </span><span class="org-comment">id&#30906;&#35469;</span>
docker logs 1111... <span class="org-comment-delimiter"># </span><span class="org-comment">id&#12434;&#20837;&#12428;&#12427;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdd6a4bc" class="outline-3">
<h3 id="orgdd6a4bc"><a href="#orgdd6a4bc">イメージを削除する</a></h3>
<div class="outline-text-3" id="text-orgdd6a4bc">
<p>
使ってないイメージを削除する。
</p>
<div class="org-src-container">
<pre class="src src-shell">docker images prone
</pre>
</div>

<p>
一気に全部削除する。
</p>
<div class="org-src-container">
<pre class="src src-shell">docker stop $(docker ps -q)
docker rm $(docker ps -aq)
docker rmi $(docker images -q)
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgf43f5f1" class="outline-2">
<h2 id="orgf43f5f1"><a href="#orgf43f5f1">Tasks</a></h2>
<div class="outline-text-2" id="text-orgf43f5f1">
</div>
<div id="outline-container-org940de49" class="outline-3">
<h3 id="org940de49"><a href="#org940de49"><span class="todo TODO">TODO</span> コンテナはどういう仕組みか&#xa0;&#xa0;&#xa0;<span class="tag"><span class="DontKnow">DontKnow</span></span></a></h3>
<div class="outline-text-3" id="text-org940de49">
<p>
仮想化をどうやっているか、なぜ独立した環境にできるのか知らない。
</p>

<p>
解説は↓にある。非常にわかりやすい。<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>のミニマル実装もある。
</p>
<ul class="org-ul">
<li><a href="https://kaminashi-developer.hatenablog.jp/entry/dive-into-swamp-container-scratch">【Go言語】自作コンテナ沼。スクラッチでミニDockerを作ろう - カミナシ エンジニアブログ</a></li>
</ul>

<p>
dockerの構成。
</p>

<ul class="org-ul">
<li>Docker Host
<ul class="org-ul">
<li>Docker Daemon</li>
<li>Container</li>
<li>Images</li>
<li>Network</li>
</ul></li>
<li>Docker client
<ul class="org-ul">
<li>build, pull, runとか</li>
</ul></li>
</ul>

<p>
network, container, image, volumesはCli経由でDocker daemonの機能を呼び出す。
コンテナを一言で言うと「 システムから分離されたプロセス 」。Linux上でunshareコマンドを打つことにより、最速でコンテナを作成できる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>最低限のコンテナ。この立ち上がったプロセスがコンテナ</label><pre class="src src-shell">$ sudo unshare -u /bin/bash
<span class="org-comment-delimiter"># </span><span class="org-comment">&#12518;&#12540;&#12470;&#12364;root&#12395;&#12394;&#12387;&#12383;</span>
$ hostname newhost &amp;&amp; hostname
-&gt; newhost
<span class="org-comment-delimiter"># </span><span class="org-comment">&#12507;&#12473;&#12488;&#21517;&#12434;&#22793;&#26356;&#12375;&#12383;</span>
$ which emacs
-&gt; /usr/bin/emacs <span class="org-comment-delimiter"># </span><span class="org-comment">unshare&#12375;&#12390;&#12394;&#12356;&#29366;&#24907;&#12384;&#12392;Emacs&#12399;guix&#12487;&#12451;&#12524;&#12463;&#12488;&#12522;&#21270;&#12395;&#20837;&#12387;&#12390;&#12356;&#12427;&#12398;&#12391;&#12289;&#30906;&#12363;&#12395;&#29872;&#22659;&#12364;&#21029;&#12395;&#12394;&#12387;&#12390;&#12356;&#12427;</span>
</pre>
</div>

<p>
コンテナに必要な<a href="20220108110637-linux.html#ID-7a81eb7c-8e2b-400a-b01a-8fa597ea527a">Linux</a>の機能3つ。
</p>

<ul class="org-ul">
<li>Namespace
<ul class="org-ul">
<li>プロセスはそれぞれでNamespaceを持っている。unshareはプロセスを分離させNamespaceを作成した</li>
</ul></li>
<li>Control Group
<ul class="org-ul">
<li>アプリケーションを特定のリソースセットに制限する。メモリの最大利用数や、プロセス最大実行数を制限できる</li>
<li><code>cat /sys/fs/cgroup/cpuset/cpuset.cpus</code></li>
</ul></li>
<li>File System
<ul class="org-ul">
<li>親からマウントされたFile Systemに関するデータのコピーを取得し、親と同じデータ構造へのポインタを取得して変更できるようにする</li>
<li>cat <code>/proc/mounts</code></li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgdf87960" class="outline-3">
<h3 id="orgdf87960"><a href="#orgdf87960"><span class="todo TODO">TODO</span> <a href="https://www.youtube.com/watch?v=HPuvDm8IC-4">Golang UK Conf. 2016 - Liz Rice - What is a container, really? Let&rsquo;s write one in Go from scratch - YouTube</a></a></h3>
<div class="outline-text-3" id="text-orgdf87960">
<p>
コンテナランタイムを使わずに<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>でコンテナを作ることで、コンテナとは何かを学ぶ。
</p>
</div>
</div>
<div id="outline-container-orgaaafb40" class="outline-3">
<h3 id="orgaaafb40"><a href="#orgaaafb40"><span class="todo TODO">TODO</span> <a href="https://gihyo.jp/book/2020/978-4-297-11837-2">イラストでわかる DockerとKubernetes：書籍案内｜技術評論社</a></a></h3>
<div class="outline-text-3" id="text-orgaaafb40">
<p>
仕組みの説明。
</p>
</div>
</div>
<div id="outline-container-org0286855" class="outline-3">
<h3 id="org0286855"><a href="#org0286855"><span class="todo TODO">TODO</span> <a href="https://dev.classmethod.jp/articles/container-journey/">「コンテナジャーニー」〜明日から速攻始めるAWSでのコンテナ導入運用〜 #cmdevio2018 | DevelopersIO</a></a></h3>
<div class="outline-text-3" id="text-org0286855">
<p>
現実的な導入ステップ。
</p>
</div>
</div>
<div id="outline-container-org59cee83" class="outline-3">
<h3 id="org59cee83"><a href="#org59cee83"><span class="todo TODO">TODO</span> <a href="https://qiita.com/tatsurou313/items/ad86da1bb9e8e570b6fa">BuildKitによりDockerとDocker Composeで外部キャッシュを使った効率的なビルドをする方法 - Qiita</a></a></h3>
<div class="outline-text-3" id="text-org59cee83">
<p>
BuildKitの解説。
</p>
</div>
</div>
<div id="outline-container-org3782506" class="outline-3">
<h3 id="org3782506"><a href="#org3782506"><span class="todo TODO">TODO</span> <a href="https://www.slideshare.net/zembutsu/dockerfile-bestpractices-19-and-advice">Dockerfileを改善するためのBest Practice 2019年版</a></a></h3>
</div>
<div id="outline-container-orgc40808c" class="outline-3">
<h3 id="orgc40808c"><a href="#orgc40808c"><span class="todo TODO">TODO</span> ゴミファイルができないようにする</a></h3>
<div class="outline-text-3" id="text-orgc40808c">
<p>
キャッシュや履歴関係がroot権限でできるので、削除が面倒＋コンテナを作るのが邪魔される。
</p>

<ul class="org-ul">
<li>できないようにする</li>
<li>自動削除するようにする</li>
</ul>
</div>
</div>
<div id="outline-container-orgad9b3ed" class="outline-3">
<h3 id="orgad9b3ed"><a href="#orgad9b3ed"><span class="todo TODO">TODO</span> Nginx, UnicornをDocker化</a></h3>
<div class="outline-text-3" id="text-orgad9b3ed">
<p>

</p>
</div>
</div>
<div id="outline-container-org1c1c628" class="outline-3">
<h3 id="org1c1c628"><a href="#org1c1c628">Rails開発 Docker環境化<code>[7/9]</code></a></h3>
<div class="outline-text-3" id="text-org1c1c628">
<p>
仕事をLinuxで行えるようにする。基本的なところはカバーしたが、一部できないものがある状態。
</p>
</div>

<div id="outline-container-org607ef90" class="outline-4">
<h4 id="org607ef90"><a href="#org607ef90"><span class="todo TODO">TODO</span> rails c内で日本語が含まれると失敗する</a></h4>
</div>
<div id="outline-container-orge520c59" class="outline-4">
<h4 id="orge520c59"><a href="#orge520c59"><span class="todo TODO">TODO</span> CapybaraでJavascriptをオンにしたときsystem specが失敗する</a></h4>
<div class="outline-text-4" id="text-orge520c59">
<p>
js: trueのときだけ。
</p>
</div>
</div>
<div id="outline-container-orgd8ccdcd" class="outline-4">
<h4 id="orgd8ccdcd"><a href="#orgd8ccdcd"><span class="done DONE">DONE</span> migration時にschemaに変な差分が出る</a></h4>
<div class="outline-text-4" id="text-orgd8ccdcd">
<p>
DB設定がおかしいようだ。
</p>
</div>
</div>
<div id="outline-container-org706a6e8" class="outline-4">
<h4 id="org706a6e8"><a href="#org706a6e8"><span class="done DONE">DONE</span> 非同期処理の動作確認</a></h4>
<div class="outline-text-4" id="text-org706a6e8">
<p>
redis, sidekiqが本当に動いてるかわからない。
letter openerを見る限り、できてない。
</p>

<p>
追加した。
</p>
</div>
</div>
<div id="outline-container-orge92b4d1" class="outline-4">
<h4 id="orge92b4d1"><a href="#orge92b4d1"><span class="done DONE">DONE</span> dockerがrootユーザでファイルを生成する問題</a></h4>
<div class="outline-text-4" id="text-orge92b4d1">
<p>
生成したファイルがroot権限になってしまう。
だからbundle installを実行すると、その後は通常ユーザでは編集できなくなる。
面倒だし、migrationとか明らかにダメな気がする。
</p>

<p>
簡単な解決策と環境変数によって解決する方法を調べた。
</p>
</div>
</div>
<div id="outline-container-org140f243" class="outline-4">
<h4 id="org140f243"><a href="#org140f243"><span class="done DONE">DONE</span> 基本コマンド</a></h4>
<div class="outline-text-4" id="text-org140f243">
<p>
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>部分をDocker化する。表示はまったく問題なさそう。
リロードするとちゃんとローカルの変更が反映される。
</p>

<p>
最初にルートファイルのdockerfileでベースイメージをビルドして、名前を付ける。
</p>
<div class="org-src-container">
<pre class="src src-shell">docker build . -t app
</pre>
</div>

<p>
各コンテナでは↑で作成したベースイメージappを用いる。
イメージを使う代わりに <code>build .</code> でも可能だが、各コンテナがイメージをビルドする(中身は同じ)ので遅くごちゃつく。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>docker-compose.yml</label><pre class="src src-yaml">rails:
  image: app
  environment:
    RAILS_ENV: development
    REDIS_URL: redis://redis:6379
    MEMCACHED_URL: memcached://memcached:11211
    SKIP_RECAPTCHA: "true"
    MEMCACHED_HOST: memcached
    MEMCACHED: memcached:11211
    WEBPACKER_DEV_SERVER_HOST: webpack
    CHROME_HOST_NAME: http://selenium_chrome:4444/wd/hub
  ports:
    - 3000:3000
  stdin_open: true
  tty: true
  command: bash -c "rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -b '0.0.0.0'"
  volumes:
    - .:/rails
    - /etc/passwd:/etc/passwd:ro # Linux用
    - /etc/group:/etc/group:ro # Linux用
  depends_on:
    - mysql

sidekiq:
  image: app
  command: bundle exec sidekiq
  links:
    - mysql
    - redis

webpack:
  image: app
  environment:
    NODE_ENV: development
    RAILS_ENV: development
    WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
  command: yarn watch
  volumes:
    - .:/rails
    - /etc/passwd:/etc/passwd:ro # Linux用
    - /etc/group:/etc/group:ro # Linux用
  ports:
    - 8080:8080
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>コンテナ作成 + 立ち上げ</label><pre class="src src-shell">sudo docker-compose up --build
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>再起動</label><pre class="src src-shell">docker-compose {service} restart
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>railsはサービス名。以下を好きなコマンドに変える</label><pre class="src src-shell">docker-compose run rails bundle exec rails c
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>bundle install</label><pre class="src src-shell">docker-compose run rails bundle install
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>テストを実行する</label><pre class="src src-shell">docker-compose run rails bundle exec bin/rspec spec/requests/top/top_spec.rb
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>コンテナ内のshellに入ってみる</label><pre class="src src-shell">docker-compose run rails /bin/bash
</pre>
</div>
</div>
</div>
<div id="outline-container-org1dbd49c" class="outline-4">
<h4 id="org1dbd49c"><a href="#org1dbd49c"><span class="done DONE">DONE</span> docker-compose.ymlのオーバーライド</a></h4>
<div class="outline-text-4" id="text-org1dbd49c">
<p>
個人で微妙に設定が異なることもある。
Dockerでやるのはミドルウェアだけとか、<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>もすべてやる、といったような。
そのときはgitignoreを指定したymlを指定して起動する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>後から読み込まれた設定ファイルで上書きされる</label><pre class="src src-shell">docker-compose -f docker-compose.yml -f docker-compose-app.override.yml up
</pre>
</div>

<p>
もちろん一般性があるならgit管理にするのがベストだが、人によって構成が異なるので仕方ない。とくにMacだと速度に問題あるため、<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>は<a href="20210805005543-docker.html#ID-1658782a-d331-464b-9fd7-1f8233b8b7f8">Docker</a>で立ち上げないのが多数派。
</p>

<p>
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>サービスをoverride.ymlに、それ以外のミドルウェアサービスをdocker-compose.ymlに書いてる場合は、明示する必要がある。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>overrideしたときのbundle install。-f指定が必要。</label><pre class="src src-shell">docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run rails bundle install
</pre>
</div>

<p>
docker-compose runする場合も-fオプションが必要。
runはコンテナを新しく作る…つまりymlを見てるので、指定が必要なのである。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span>model specを実行する</label><pre class="src src-shell">docker-compose -f docker-compose.yml -f docker-compose-app.override.yml exec rails bundle exec rspec --options ./.rspec ./spec/models/user_spec.rb
</pre>
</div>

<p>
↑いちいちクソ長いコマンドを打つのは苦痛なので、shellに入って作業すると楽。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>shellに入る</label><pre class="src src-shell">sudo docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run rails /bin/sh
</pre>
</div>
</div>
</div>
<div id="outline-container-org53dce76" class="outline-4">
<h4 id="org53dce76"><a href="#org53dce76"><span class="done DONE">DONE</span> DBのGUIツールとの接続</a></h4>
<div class="outline-text-4" id="text-org53dce76">
<p>
Linux用のsqlectronがよさそう。が、上手く<a href="20210829232020-mysql.html#ID-7dab097c-60ba-43b9-949f-c58bf3151aa8">MySQL</a>と接続できない
docker-compose.ymlで <code>MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'</code> を追加すると入れるように。
パスワードを指定してるとログインできない。
</p>

<p>
だがこのsqlectron、表示テーブルでの編集ができないので値を書き換えるのに非常に不便。
別のを使ったほうがいいだろう。
</p>
</div>
</div>
<div id="outline-container-orgc3ae525" class="outline-4">
<h4 id="orgc3ae525"><a href="#orgc3ae525"><span class="done DONE">DONE</span> yarnができてない</a></h4>
<div class="outline-text-4" id="text-orgc3ae525">
<ul class="org-ul">
<li>ポートを合わせる</li>
<li>webpack.config.jsにhostを加える</li>
</ul>

<p>
が必要。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span>docker-compose.yml</label><pre class="src src-yaml">webpack:
  build: .
  environment:
    NODE_ENV: development
    RAILS_ENV: development
    WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
  command: yarn watch
  volumes:
    - .:/rails
  ports:
    - 8080:8080
  depends_on:
    - rails
</pre>
</div>

<p>
ホットリロードできるのを確認。
hostを加える必要があった。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span>webpack.config.js</label><pre class="src src-json">devServer: {
  contentBase: path.join(__dirname, 'app/assets/javascripts'),
  allowedHosts: ['.lvh.me'],
  host: '0.0.0.0',
},
</pre>
</div>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc7c784d" class="outline-2">
<h2 id="orgc7c784d"><a href="#orgc7c784d">Archives</a></h2>
<div class="outline-text-2" id="text-orgc7c784d">
</div>
<div id="outline-container-org27e3b83" class="outline-3">
<h3 id="org27e3b83"><a href="#org27e3b83"><span class="done DONE">DONE</span> <a href="https://www.forcia.com/blog/002273.html">社内のDockerfileのベストプラクティスを公開します│FORCIA CUBE│フォルシア株式会社</a></a></h3>
<div class="outline-text-3" id="text-org27e3b83">
<p>
非常に詳しい情報。
</p>
</div>
</div>
<div id="outline-container-orgf868ff5" class="outline-3">
<h3 id="orgf868ff5"><a href="#orgf868ff5"><span class="done DONE">DONE</span> タスクを簡単に実行する方法を調べる</a></h3>
<div class="outline-text-3" id="text-orgf868ff5">
<p>
<a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs</a>拡張あるいは、Makefile的なのにまとめる。
</p>

<p>
ありがちなbundle-installなどはdocker-composeにワンショットのコマンドを書くことで、定形コマンドを実行することが少なくなった。自動で動かしたいやつはこれでOK。コマンドはdockerだから特殊ということはなく、ローカルと同じようにやれば良い。
</p>
</div>
</div>
</div>
<div id="outline-container-org8e6bf5c" class="outline-2">
<h2 id="org8e6bf5c"><a href="#org8e6bf5c">References</a></h2>
<div class="outline-text-2" id="text-org8e6bf5c">
</div>
<div id="outline-container-org0ac826a" class="outline-3">
<h3 id="org0ac826a"><a href="#org0ac826a"><a href="https://containers.gitbook.io/build-containers-the-hard-way/">Build Containers the Hard Way (WIP) - Build Containers the Hard Way</a></a></h3>
<div class="outline-text-3" id="text-org0ac826a">
<p>
コンテナ技術の低レイヤーの仕組み。
</p>
</div>
</div>
<div id="outline-container-org2cadab7" class="outline-3">
<h3 id="org2cadab7"><a href="#org2cadab7"><a href="https://github.com/docker-slim/docker-slim">docker-slim/docker-slim: DockerSlim (docker-slim): Don&rsquo;t change anything in your Docker container image and minify it by up to 30x (and for compiled languages even more) making it secure too! (free and open source)</a></a></h3>
<div class="outline-text-3" id="text-org2cadab7">
<p>
dockerイメージを分析してスリムにするツール。
</p>
</div>
</div>
<div id="outline-container-orgea07ae8" class="outline-3">
<h3 id="orgea07ae8"><a href="#orgea07ae8"><a href="https://github.com/wagoodman/dive">wagoodman/dive: A tool for exploring each layer in a docker image</a></a></h3>
<div class="outline-text-3" id="text-orgea07ae8">
<p>
dockerのレイヤーごとにイメージを調査できるツール。
</p>
</div>
</div>
<div id="outline-container-org559d42b" class="outline-3">
<h3 id="org559d42b"><a href="#org559d42b"><a href="https://www.redhat.com/ja/topics/containers/what-is-docker">Docker とは - 解説、メリット、できること | Red Hat</a></a></h3>
<div class="outline-text-3" id="text-org559d42b">
<p>
わかりやすい概要。
</p>
</div>
</div>
<div id="outline-container-org47ffaab" class="outline-3">
<h3 id="org47ffaab"><a href="#org47ffaab"><a href="https://ja.wikipedia.org/wiki/Docker">Docker - Wikipedia</a></a></h3>
<div class="outline-text-3" id="text-org47ffaab">
<p>
ソフトウェアのわかりやすい説明。
</p>
</div>
</div>
<div id="outline-container-org5fa4fad" class="outline-3">
<h3 id="org5fa4fad"><a href="#org5fa4fad"><a href="https://github.com/phusion/passenger-docker">phusion/passenger-docker: Docker base images for Ruby, Python, Node.js and Meteor web apps</a></a></h3>
<div class="outline-text-3" id="text-org5fa4fad">
<p>
Web開発用の扱いやすいDockerイメージ。
</p>
</div>
</div>
<div id="outline-container-orge2d7719" class="outline-3">
<h3 id="orge2d7719"><a href="#orge2d7719"><a href="https://12factor.net/">The Twelve-Factor App</a></a></h3>
<div class="outline-text-3" id="text-orge2d7719">
<p>
SaaS開発の方法論。
日本語訳もあった。<a href="https://12factor.net/ja/">The Twelve-Factor App （日本語訳）</a>
</p>
</div>
</div>
<div id="outline-container-orgca42fe9" class="outline-3">
<h3 id="orgca42fe9"><a href="#orgca42fe9"><a href="https://docs.docker.jp/pdf-download.html">Docker ドキュメント日本語版 PDF ダウンロード — Docker-docs-ja 19.03 ドキュメント</a></a></h3>
<div class="outline-text-3" id="text-orgca42fe9">
<p>
Dockerのドキュメント。
</p>
</div>
</div>
<div id="outline-container-orgb760297" class="outline-3">
<h3 id="orgb760297"><a href="#orgb760297"><a href="https://kotaroooo0-dev.hatenablog.com/entry/2020/08/06/012316">キャッシュのためにDockerビルドで中間イメージをタグ付けしレジストリにPushする - 🤖</a></a></h3>
<div class="outline-text-3" id="text-orgb760297">
<p>
キャッシュの書き方。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
