<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-08-25 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 228: 実行時のアドレスの使い方が逆に見える</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 228: 実行時のアドレスの使い方が逆に見える</h1>

<div id="outline-container-orgde22ec9" class="outline-2">
<h2 id="orgde22ec9"><a href="#orgde22ec9">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-orgde22ec9">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="off"><input type='checkbox' /> &lt;署名&gt;</li>
</ul></li>
</ul>

<ul class="org-ul">
<li>レビュー
<ul class="org-ul">
<li class="off"><input type='checkbox' /> &lt;署名&gt;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org18e2f4c" class="outline-2">
<h2 id="org18e2f4c"><a href="#org18e2f4c">概要</a></h2>
<div class="outline-text-2" id="text-org18e2f4c">
<p>
C言語で実行時のアドレス位置と、アセンブリの位置で違いがあるように見えたので確かめる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>変数の番地を表示する</label><pre class="src src-C"><span class="org-type">int</span> <span class="org-function-name">main</span>() {
  <span class="org-type">char</span> <span class="org-variable-name">base</span> = 0;
  <span class="org-type">char</span> <span class="org-variable-name">a</span> = <span class="org-string">'a'</span>;
  <span class="org-type">char</span> <span class="org-variable-name">b</span> = <span class="org-string">'b'</span>;
  <span class="org-type">char</span> <span class="org-variable-name">c</span> = <span class="org-string">'c'</span>;

  printf(<span class="org-string">"%p: base\n"</span>, &amp;base);
  printf(<span class="org-string">"%p: a\n"</span>, &amp;a);
  printf(<span class="org-string">"%p: b\n"</span>, &amp;b);
  printf(<span class="org-string">"%p: c\n"</span>, &amp;c);
}
</pre>
</div>

<pre class="example">
0x7fffa55f0a84: base
0x7fffa55f0a85: a
0x7fffa55f0a86: b
0x7fffa55f0a87: c
</pre>

<p>
つまり、↓このようになっているように見える。コードで変数を初期化した順番とアドレスの順番が一致している。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>先に書いた変数(base)が低位アドレスとなる</label><pre class="src src-shell">^&#30058;&#22320;&#23567;(&#20302;)

| ...84: base |
| ...85: a |
| ...86: b |
| ...87: c |

<span class="org-function-name">v&#30058;&#22320;&#22823;</span>(&#39640;)
</pre>
</div>

<p>
いっぽう、アセンブリで見る。
</p>

<iframe width="800px" height="200px" src="https://godbolt.org/e#g:!((g:!((g:!((h:codeEditor,i:(filename:'1',fontScale:14,fontUsePx:'0',j:1,lang:___c,selection:(endColumn:2,endLineNumber:6,positionColumn:2,positionLineNumber:6,selectionStartColumn:2,selectionStartLineNumber:6,startColumn:2,startLineNumber:6),source:'int+main()+%7B%0A++++char+base+%3D+1%3B%0A++++char+a+%3D+!'a!'%3B%0A++++char+b+%3D+!'b!'%3B%0A++++char+c+%3D+!'c!'%3B%0A%7D'),l:'5',n:'1',o:'C+source+%231',t:'0')),k:50,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:compiler,i:(compiler:cclang1701,filters:(b:'0',binary:'1',binaryObject:'1',commentOnly:'0',debugCalls:'1',demangle:'0',directives:'0',execute:'1',intel:'1',libraryCode:'0',trim:'0',verboseDemangling:'0'),flagsViewOpen:'1',fontScale:14,fontUsePx:'0',j:1,lang:___c,libs:!(),options:'',overrides:!(),selection:(endColumn:1,endLineNumber:1,positionColumn:1,positionLineNumber:1,selectionStartColumn:1,selectionStartLineNumber:1,startColumn:1,startLineNumber:1),source:1),l:'5',n:'0',o:'+x86-64+clang+17.0.1+(Editor+%231)',t:'0')),k:50,l:'4',n:'0',o:'',s:0,t:'0')),l:'2',n:'0',o:'',t:'0')),version:4"></iframe>

<p>
つまり、アセンブリでは↓こう格納されそうに見える。コードで変数を初期化した順番とアドレスの順番は逆順になる。スタックの成長する方向であり、納得できる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>先に書いた変数(base)が高位アドレスとなる</label><pre class="src src-shell">^&#30058;&#22320;&#23567;(&#20302;)

| rbp-4: c |
| rbp-3: b |
| rbp-2: a |
| rbp-1: base  |

<span class="org-function-name">v&#30058;&#22320;&#22823;</span>(&#39640;)
</pre>
</div>

<p>
実行して確認したアドレスと、アセンブリのアドレスの順番が、逆になっているように見える。これはなぜなのだろう。
</p>

<p>
いくつか調べるなかで、箇所は不明だが環境依存であると考えた。
</p>

<ul class="org-ul">
<li><a href="https://brain.cc.kogakuin.ac.jp/~kanamaru/lecture/prog1/08-03.html">第八回-03 メインメモリとアドレス</a>の例では、同じようなコードだが、アドレスの順番が高位アドレス→低位アドレスとなっている</li>
<li><a href="https://paiza.io/projects/P_5GA1AKodgUoRjfhdY3_A?language=c">ブラウザでプログラミング・実行ができる「オンライン実行環境」| paiza.IO</a>で実行するとアドレスの順番が高位アドレス→低位アドレスとなっている。paizaではclangを使っているようだ</li>
<li>手元で <code>clang</code> でコンパイルすると高位アドレス→低位アドレスになる。gccでコンパイルすると低位アドレス→高位アドレスになる</li>
<li>Compiler Explorerでgcc, clangを入れ替えてみたが順序は変わらず</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>clangでコンパイルして実行した結果。先に書いた変数が高位アドレスとなる</label><pre class="src src-shell">0x7ffe71de7317: base
0x7ffe71de7316: a
0x7ffe71de7315: b
0x7ffe71de7314: c

--------------------
^&#30058;&#22320;&#23567;(&#20302;)

| ...14: c |
| ...15: b |
| ...16: a |
| ...17: base |

<span class="org-function-name">v&#30058;&#22320;&#22823;</span>(&#39640;)
</pre>
</div>

<p>
手元のgccでアセンブラを見てみると、(低)base, a, b, c(高)順のアドレスになっているのを確認できた。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>手元のgccで-Sオプションを使って出力した</label><pre class="src src-asm">        <span class="org-keyword">.file</span>   <span class="org-string">"main.c"</span>
        <span class="org-keyword">.text</span>
        <span class="org-keyword">.section</span>        .rodata
<span class="org-function-name">.LC0</span>:
        <span class="org-keyword">.string</span> <span class="org-string">"%p: base\n"</span>
<span class="org-function-name">.LC1</span>:
        <span class="org-keyword">.string</span> <span class="org-string">"%p: a\n"</span>
<span class="org-function-name">.LC2</span>:
        <span class="org-keyword">.string</span> <span class="org-string">"%p: b\n"</span>
<span class="org-function-name">.LC3</span>:
        <span class="org-keyword">.string</span> <span class="org-string">"%p: c\n"</span>
        <span class="org-keyword">.text</span>
        <span class="org-keyword">.globl</span>  main
        <span class="org-keyword">.type</span>   main, @function
<span class="org-function-name">main</span>:
<span class="org-function-name">.LFB0</span>:
        <span class="org-keyword">.cfi_startproc</span>
        <span class="org-keyword">endbr64</span>
        <span class="org-keyword">pushq</span>   <span class="org-variable-name">%rbp</span>
        <span class="org-keyword">.cfi_def_cfa_offset</span> 16
        <span class="org-keyword">.cfi_offset</span> 6, -16
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rsp</span>, <span class="org-variable-name">%rbp</span>
        <span class="org-keyword">.cfi_def_cfa_register</span> 6
        <span class="org-keyword">subq</span>    $16, <span class="org-variable-name">%rsp</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%fs</span>:40, <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, -8(<span class="org-variable-name">%rbp</span>)
        <span class="org-keyword">xorl</span>    <span class="org-variable-name">%eax</span>, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">movb</span>    $0, -12(<span class="org-variable-name">%rbp</span>)  <span class="org-comment-delimiter">; </span><span class="org-comment">&#128072;</span>
        <span class="org-keyword">movb</span>    $97, -11(<span class="org-variable-name">%rbp</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">&#128072;</span>
        <span class="org-keyword">movb</span>    $98, -10(<span class="org-variable-name">%rbp</span>) <span class="org-comment-delimiter">; </span><span class="org-comment">&#128072;</span>
        <span class="org-keyword">movb</span>    $99, -9(<span class="org-variable-name">%rbp</span>)  <span class="org-comment-delimiter">; </span><span class="org-comment">&#128072;</span>
        <span class="org-keyword">leaq</span>    -12(<span class="org-variable-name">%rbp</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rsi</span>
        <span class="org-keyword">leaq</span>    .LC0(<span class="org-variable-name">%rip</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rdi</span>
        <span class="org-keyword">movl</span>    $0, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">call</span>    printf@PLT
        <span class="org-keyword">leaq</span>    -11(<span class="org-variable-name">%rbp</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rsi</span>
        <span class="org-keyword">leaq</span>    .LC1(<span class="org-variable-name">%rip</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rdi</span>
        <span class="org-keyword">movl</span>    $0, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">call</span>    printf@PLT
        <span class="org-keyword">leaq</span>    -10(<span class="org-variable-name">%rbp</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rsi</span>
        <span class="org-keyword">leaq</span>    .LC2(<span class="org-variable-name">%rip</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rdi</span>
        <span class="org-keyword">movl</span>    $0, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">call</span>    printf@PLT
        <span class="org-keyword">leaq</span>    -9(<span class="org-variable-name">%rbp</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rsi</span>
        <span class="org-keyword">leaq</span>    .LC3(<span class="org-variable-name">%rip</span>), <span class="org-variable-name">%rax</span>
        <span class="org-keyword">movq</span>    <span class="org-variable-name">%rax</span>, <span class="org-variable-name">%rdi</span>
        <span class="org-keyword">movl</span>    $0, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">call</span>    printf@PLT
        <span class="org-keyword">movl</span>    $0, <span class="org-variable-name">%eax</span>
        <span class="org-keyword">movq</span>    -8(<span class="org-variable-name">%rbp</span>), <span class="org-variable-name">%rdx</span>
        <span class="org-keyword">subq</span>    <span class="org-variable-name">%fs</span>:40, <span class="org-variable-name">%rdx</span>
        <span class="org-keyword">je</span>      .L3
        <span class="org-keyword">call</span>    __stack_chk_fail@PLT
<span class="org-function-name">.L3</span>:
        <span class="org-keyword">leave</span>
        <span class="org-keyword">.cfi_def_cfa</span> 7, 8
        <span class="org-keyword">ret</span>
        <span class="org-keyword">.cfi_endproc</span>
<span class="org-function-name">.LFE0</span>:
        <span class="org-keyword">.size</span>   main, .-main
        <span class="org-keyword">.ident</span>  <span class="org-string">"GCC: (Ubuntu 11.4.0-1ubuntu1~22.04) 11.4.0"</span>
        <span class="org-keyword">.section</span>        .note.GNU-stack,<span class="org-string">""</span>,@progbits
        <span class="org-keyword">.section</span>        .note.gnu.property,<span class="org-string">"a"</span>
        <span class="org-keyword">.align</span> 8
        <span class="org-keyword">.long</span>   1f - 0f
        <span class="org-keyword">.long</span>   4f - 1f
        <span class="org-keyword">.long</span>   5
<span class="org-function-name">0</span>:
        <span class="org-keyword">.string</span> <span class="org-string">"GNU"</span>
<span class="org-function-name">1</span>:
        <span class="org-keyword">.align</span> 8
        <span class="org-keyword">.long</span>   0xc0000002
        <span class="org-keyword">.long</span>   3f - 2f
<span class="org-function-name">2</span>:
        <span class="org-keyword">.long</span>   0x3
<span class="org-function-name">3</span>:
        <span class="org-keyword">.align</span> 8
<span class="org-function-name">4</span>:

  <span class="org-keyword">--------------------------------</span>
  <span class="org-keyword">|-12</span>(<span class="org-variable-name">%rbp</span>): base |
  <span class="org-keyword">|-11</span>(<span class="org-variable-name">%rbp</span>): a |
  <span class="org-keyword">|-10</span>(<span class="org-variable-name">%rbp</span>): b |
  <span class="org-keyword">|</span> -9(<span class="org-variable-name">%rbp</span>): c |
</pre>
</div>

<p>
つまり、コードで変数を初期化した順番と、アドレスの順番は必ずしも逆にはならないことがある。なぜそうなるのかは、いつか調べる。
</p>
</div>
</div>

<div id="outline-container-org4f90880" class="outline-2">
<h2 id="org4f90880"><a href="#org4f90880">関連</a></h2>
<div class="outline-text-2" id="text-org4f90880">
<p>
なし。
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
