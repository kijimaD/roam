<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-10-20 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>C language</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "center",
        displayIndent: "0em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "TeX"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "TeX"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "right",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">C language</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgd483a31">概要</a></li>
<li><a href="#orgdba2e85">Memo</a>
<ul>
<li><a href="#orgf316c16">ラインエディタedのメイン関数</a></li>
<li><a href="#orgd93f4f4">シグナル</a></li>
<li><a href="#orge0e2d00">shellのノード定義</a></li>
<li><a href="#orgab8f2df">バイナリツリー</a></li>
<li><a href="#org4facc59">ハッシュテーブルエントリに複数の要素を格納する</a></li>
<li><a href="#orge17b58c">循環リスト実装</a></li>
<li><a href="#orgda709c4">リスト処理</a></li>
<li><a href="#org9e7f38e">配列定義</a></li>
<li><a href="#orgb28bb5c">データの内部構造を表現する</a></li>
<li><a href="#org42cae81">多態の実装</a></li>
<li><a href="#org141d964">共用体の使用例</a></li>
<li><a href="#org64d07cc">構造体の使用例</a></li>
<li><a href="#org68d1145">strlenの実装</a></li>
<li><a href="#orgdd6b432">無限ループのイディオム</a></li>
<li><a href="#orgc092cde">配列変数は先頭の要素へのポインタ</a></li>
<li><a href="#orgf5c3c02">引数の渡し方</a></li>
</ul>
</li>
<li><a href="#org031be61">Tasks</a>
<ul>
<li><a href="#org2057364"><span class="todo TODO">TODO</span> 総合目次 - 苦しんで覚えるC言語</a></li>
<li><a href="#org9b2689a"><span class="todo TODO">TODO</span> O&rsquo;Reilly Japan - Head First C</a></li>
</ul>
</li>
<li><a href="#org1ccce1d">Reference</a>
<ul>
<li><a href="#orgb5ea0a4">徹底解剖「G1GC」実装編</a></li>
<li><a href="#org3e2ee36">６さいからのプログラミング</a></li>
<li><a href="#org10cb9a4">Language C FAQ</a></li>
<li><a href="#org4dc2062">P2137R0: Goals and priorities for C++</a></li>
<li><a href="#org693eae2">杉浦とソフトウェア開発</a></li>
<li><a href="#org55d0ffb">Bjarne Stroustrup インタビュー (？)</a></li>
</ul>
</li>
<li><a href="#org642dd38">Archives</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgd483a31" class="outline-2">
<h2 id="orgd483a31"><a href="#orgd483a31">概要</a></h2>
<div class="outline-text-2" id="text-orgd483a31">
<p>
C言語は汎用の<a href="20210509101246-programming_language.html#ID-868ac56a-2d42-48d7-ab7f-7047c85a8f39">Programming Language</a>。
OS、プログラミング言語、ハードウェアとの接続といった基盤的な部分で使われる。
</p>

<p>
たとえば…。
</p>
<ul class="org-ul">
<li><a href="20220108110637-linux.html#ID-7a81eb7c-8e2b-400a-b01a-8fa597ea527a">Linux</a></li>
<li><a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a></li>
<li><a href="20210725134208-python.html#ID-a6c9c9ad-d9b1-4e13-8992-75d8590e464c">Python</a></li>
<li><a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs</a>(<a href="20210509122633-emacs_lisp.html#ID-c7e81fac-9f8b-4538-9851-21d4ff3c2b08">Emacs Lisp</a>以外の部分)</li>
</ul>

<p>
現在基盤として使われている多くのプログラムがCで書かれていて、<a href="20210926150327-oss.html#ID-bb71747d-8599-4aee-b747-13cb44c05773">OSS</a>として公開されている。別の言語で書くにしても、既存の巨大なコード群を参考にできるのは大きな利点。
</p>
</div>
</div>
<div id="outline-container-orgdba2e85" class="outline-2">
<h2 id="orgdba2e85"><a href="#orgdba2e85">Memo</a></h2>
<div class="outline-text-2" id="text-orgdba2e85">
</div>
<div id="outline-container-orgf316c16" class="outline-3">
<h3 id="orgf316c16"><a href="#orgf316c16">ラインエディタedのメイン関数</a></h3>
<div class="outline-text-3" id="text-orgf316c16">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>割り込み処理などを見ることができる</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/bin/ed/main.c#L113
</pre>
</div>

<div class="results" id="org8b89220">
<p>
main(int ac, char *av[])
</p>

</div>
</div>
</div>

<div id="outline-container-orgd93f4f4" class="outline-3">
<h3 id="orgd93f4f4"><a href="#orgd93f4f4">シグナル</a></h3>
<div class="outline-text-3" id="text-orgd93f4f4">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>シグナルによって中断を検知する</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/games/arithmetic/arithmetic.c#L156-L162
</pre>
</div>

<div class="results" id="org81122af">
<p>
<i>* Handle interrupt character.  Print score and exit. *</i>
static void
intr(int dummy __unused)
{
	showstats(1);
	exit(0);
}
</p>

</div>
</div>
</div>

<div id="outline-container-orge0e2d00" class="outline-3">
<h3 id="orge0e2d00"><a href="#orge0e2d00">shellのノード定義</a></h3>
<div class="outline-text-3" id="text-orge0e2d00">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/bin/sh/nodetypes#L56-L61
</pre>
</div>

<div class="results" id="orgaf31cd4">
<p>
NCMD ncmd			# a simple command
	type	  int
	backgnd	  int			# set to run command in background
	args	  nodeptr		# the arguments
	redirect  nodeptr		# list of file redirections
	lineno	  int
</p>

</div>
</div>
</div>

<div id="outline-container-orgab8f2df" class="outline-3">
<h3 id="orgab8f2df"><a href="#orgab8f2df">バイナリツリー</a></h3>
<div class="outline-text-3" id="text-orgab8f2df">
<p>
バイナリツリーの中にはleft, rightを持つものがあり、leftは小さい、rightは大きいとしてノードの順番を決定する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>バイナリツリーの定義。各ノードはほかのノードを最高2つまで持つことができる</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/external/bsd/libbind/dist/include/isc/tree.h#L44-L49
</pre>
</div>

<div class="results" id="org658b15d">
<p>
typedef	struct tree_s {
		tree_t  data;
		struct tree_s *left, *right;
		short		bal;
	}
	tree;
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>ツリー内の要素を再帰的に検索する</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/external/bsd/libbind/dist/isc/tree.c#L105-L130
</pre>
</div>

<div class="results" id="org38f4c58">
<p>
tree_t
tree_srch(tree **ppr_tree, int (*pfi_compare)(tree_t, tree_t), tree_t p_user) {
	ENTER(&ldquo;tree_srch&rdquo;)
</p>

<p>
if (*ppr_tree) {
	int i_comp = (*pfi_compare)(p_user, (**ppr_tree).data);
</p>

<p>
if (i_comp &gt; 0)
	RET(tree_srch(&amp;(**ppr_tree).right,
		      pfi_compare,
		      p_user))
</p>

<p>
if (i_comp &lt; 0)
	RET(tree_srch(&amp;(**ppr_tree).left,
		      pfi_compare,
		      p_user))
</p>

<p>
	<i>* not higher, not lower&#x2026; this must be the one.
	 *</i>
	RET((**ppr_tree).data)
}
</p>

<p>
	<i>* grounded. NOT found.
	 *</i>
	RET(NULL)
}
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>系統的にツリーをたどる</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/external/bsd/libbind/dist/isc/tree.c#L155-L169
</pre>
</div>

<div class="results" id="orgcf5c450">
<p>
int
tree_trav(tree **ppr_tree, int (*pfi_uar)(tree_t)) {
	ENTER(&ldquo;tree_trav&rdquo;)
</p>

<p>
if (!*ppr_tree)
	RET(TRUE)
</p>

<p>
	if (!tree_trav(&amp;(**ppr_tree).left, pfi_uar))
		RET(FALSE)
	if (!(*pfi_uar)((**ppr_tree).data))
		RET(FALSE)
	if (!tree_trav(&amp;(**ppr_tree).right, pfi_uar))
		RET(FALSE)
	RET(TRUE)
}
</p>

</div>

<ul class="org-ul">
<li>ツリーは言語構造の表現ができる</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>lintでの例</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/usr.bin/xlint/lint1/lint1.h#L284-L305
</pre>
</div>

<div class="results" id="orgacaebe3">
<p>
typedef	struct tnode {
	op_t tn_op;		<i>* operator *</i>
	type_t <b>tn_type;	/</b> type <b>/
	bool	tn_lvalue:1;	/</b> node is lvalue <b>/
	bool	tn_cast:1;	/</b> if tn_op == CVT, it&rsquo;s an explicit cast */
	bool	tn_parenthesized:1;
	bool	tn_sys:1;	/* in strict bool mode, allow mixture between
</p>
<ul class="org-ul">
<li>bool and scalar, for code from system</li>
<li>headers that may be a mixture between</li>
<li>scalar types and bool</li>
</ul>
<p>
				 <b>/
	bool	tn_system_dependent:1; /</b> depends on sizeof or offsetof */
	union {
		struct {
			struct	tnode <b>_tn_left;	/</b> (left) operand <b>/
			struct	tnode *_tn_right;	/</b> right operand */
		} tn_s;
		sym_t <b>_tn_sym;	/</b> symbol if op <code>= NAME */
		val_t	*_tn_val;	/* value if op =</code> CON <b>/
		strg_t *_tn_string;	/</b> string if op == STRING */
	} tn_u;
} tnode_t;
</p>

</div>
</div>
</div>

<div id="outline-container-org4facc59" class="outline-3">
<h3 id="org4facc59"><a href="#org4facc59">ハッシュテーブルエントリに複数の要素を格納する</a></h3>
<div class="outline-text-3" id="text-org4facc59">
<p>
シンボルテーブルの構築によく使われる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/games/battlestar/parse.c#L75-L84
</pre>
</div>

<div class="results" id="org3839ddf">
<p>
static struct wlist *
lookup(const char   *s)
{
	struct wlist *wp;
</p>

<p>
	for (wp = hashtab[hash(s)]; wp != NULL; wp = wp-&gt;next)
		if (*s <code>= *wp-&gt;string &amp;&amp; strcmp(s, wp-&gt;string) =</code> 0)
			return wp;
	return NULL;
}
</p>

</div>
</div>
</div>

<div id="outline-container-orge17b58c" class="outline-3">
<h3 id="orge17b58c"><a href="#orge17b58c">循環リスト実装</a></h3>
<div class="outline-text-3" id="text-orge17b58c">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>終端がないので、forを使えない。最初の要素を保存して、同じ要素にあたるまでループする</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/bin/csh/lex.c#L176-L189
</pre>
</div>

<div class="results" id="org0d65eee">
<p>
prlex(FILE *fp, struct wordent *sp0)
{
    struct wordent *sp;
</p>

<p>
    sp = sp0-&gt;next;
    for (;;) {
	(void)fprintf(fp, &ldquo;%s&rdquo;, vis_str(sp-&gt;word));
	sp = sp-&gt;next;
	if (sp == sp0)
	    break;
	if (sp-&gt;word[0] != &rsquo;\n&rsquo;)
	    (void) fputc(&rsquo; &rsquo;, fp);
    }
}
</p>

</div>
</div>
</div>

<div id="outline-container-orgda709c4" class="outline-3">
<h3 id="orgda709c4"><a href="#orgda709c4">リスト処理</a></h3>
<div class="outline-text-3" id="text-orgda709c4">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>host_listを定義</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/usr.bin/rup/rup.c#L63-L70
</pre>
</div>

<div class="results" id="org70ded40">
<p>
static struct host_list {
	struct host_list *next;
	int family;
	union {
		struct in6_addr _addr6;
		struct in_addr _addr4;
	} addr;
} *hosts;
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>リストを辿りforで処理する</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/usr.bin/rup/rup.c#L79-L105
</pre>
</div>

<div class="results" id="org88d922a">
<p>
search_host(struct sockaddr *sa)
{
	struct host_list *hp;
</p>

<p>
if (!hosts)
	return 0;
</p>

<p>
	for (hp = hosts; hp != NULL; hp = hp-&gt;next) {
		switch (hp-&gt;family) {
		case AF_INET6:
			if (!memcmp(&amp;hp-&gt;addr6,
			    &amp;((struct sockaddr_in6 *)(void *)sa)-&gt;sin6_addr,
			    sizeof (struct in6_addr)))
				return 1;
			break;
		case AF_INET:
			if (!memcmp(&amp;hp-&gt;addr4,
			    &amp;((struct sockaddr_in *)(void *)sa)-&gt;sin_addr,
			    sizeof (struct in_addr)))
				return 1;
			break;
		default:
			break;
		}
	}
	return 0;
}
</p>

</div>

<p>
nextという要素を持つ構造体は1方向リスト連結リストのノードを定義する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>nextを追加して辿れるようにする</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/usr.bin/rup/rup.c#L108-L134
</pre>
</div>

<div class="results" id="org7b7ce9e">
<p>
remember_host(struct sockaddr *sa)
{
	struct host_list *hp;
</p>

<p>
	if ((hp = malloc(sizeof(struct host_list))) == NULL) {
		err(1, &ldquo;malloc&rdquo;);
		<i>* NOTREACHED *</i>
	}
	hp-&gt;family = sa-&gt;sa_family;
	hp-&gt;next = hosts;
	switch (sa-&gt;sa_family) {
	case AF_INET6:
		(void)memcpy(&amp;hp-&gt;addr6,
		    &amp;((struct sockaddr_in6 *)(void *)sa)-&gt;sin6_addr,
		    sizeof (struct in6_addr));
		break;
	case AF_INET:
		(void)memcpy(&amp;hp-&gt;addr4,
		    &amp;((struct sockaddr_in *)(void *)sa)-&gt;sin_addr,
		    sizeof (struct in_addr));
		break;
	default:
		errx(1, &ldquo;unknown address family&rdquo;);
		<i>* NOTREACHED *</i>
	}
	hosts = hp;
}
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>ダブル連結リストから要素epを削除</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/usr.bin/telnet/commands.c#L1700-L1716
</pre>
</div>

<div class="results" id="org601c7b7">
<p>
struct env_lst *
env_undefine(const char *var, char *d)
{
	struct env_lst *ep;
</p>

<p>
	if ((ep = env_find(var)) != NULL) {
		ep-&gt;prev-&gt;next = ep-&gt;next;
		if (ep-&gt;next)
			ep-&gt;next-&gt;prev = ep-&gt;prev;
		if (ep-&gt;var)
			free(ep-&gt;var);
		if (ep-&gt;value)
			free(ep-&gt;value);
		free(ep);
	}
	return NULL;
}
</p>

</div>
</div>
</div>

<div id="outline-container-org9e7f38e" class="outline-3">
<h3 id="org9e7f38e"><a href="#org9e7f38e">配列定義</a></h3>
<div class="outline-text-3" id="text-org9e7f38e">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>配列要素があらかじめわかっている場合の初期化</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/lib/libc/time/localtime.c#L869-L871
</pre>
</div>

<div class="results" id="org3e08eab">
<p>
static const int	year_lengths[2] = {
	DAYSPERNYEAR, DAYSPERLYEAR
};
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>通常の年と潤年の日数</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/lib/libc/time/localtime.c#L864-L867
</pre>
</div>

<div class="results" id="orgf6631e1">
<p>
static const int	mon_lengths[2][MONSPERYEAR] = {
	{ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 },
	{ 31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 }
};
</p>

</div>
</div>
</div>

<div id="outline-container-orgb28bb5c" class="outline-3">
<h3 id="orgb28bb5c"><a href="#orgb28bb5c">データの内部構造を表現する</a></h3>
<div class="outline-text-3" id="text-orgb28bb5c">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>tarが各ファイルの情報を表現するために使用する構造体</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/external/bsd/file/dist/src/tar.h#L53-L71
</pre>
</div>

<div class="results" id="orgf9275f5">
<p>
union record {
	unsigned char	charptr[RECORDSIZE];
	struct header {
		char	name[NAMSIZ];
		char	mode[8];
		char	uid[8];
		char	gid[8];
		char	size[12];
		char	mtime[12];
		char	chksum[8];
		char	linkflag;
		char	linkname[NAMSIZ];
		char	magic[8];
		char	uname[TUNMLEN];
		char	gname[TGNMLEN];
		char	devmajor[8];
		char	devminor[8];
	} header;
};
</p>

</div>
</div>
</div>
<div id="outline-container-org42cae81" class="outline-3">
<h3 id="org42cae81"><a href="#org42cae81">多態の実装</a></h3>
<div class="outline-text-3" id="text-org42cae81">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>データの種類を定義。名前にtypeをつける慣例</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/include/rpc/rpc_msg.h#L54-L57
</pre>
</div>

<div class="results" id="org5de5d98">
<p>
enum msg_type {
	CALL=0,
	REPLY=1
};
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 17: </span>msg_typeで2つの型が識別される</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/include/rpc/rpc_msg.h#L149-L155
</pre>
</div>

<div class="results" id="orga067ce3">
<p>
struct rpc_msg {
	uint32_t  rm_xid;
	enum msg_type  rm_direction;
	union {
		struct call_body RM_cmb;
		struct reply_body RM_rmb;
	} ru;
</p>

</div>
</div>
</div>

<div id="outline-container-org141d964" class="outline-3">
<h3 id="org141d964"><a href="#org141d964">共用体の使用例</a></h3>
<div class="outline-text-3" id="text-org141d964">
<p>
共用体はメモリを共用し、節約するために用いる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>mallocのコードから</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/lib/libbsdmalloc/malloc.c#L75-L89
</pre>
</div>

<div class="results" id="orgb3baed0">
<p>
union	overhead {
	union	overhead <b>ov_next;	/</b> when free */
	struct {
		u_char ovu_magic;	<i>* magic number *</i>
		u_char ovu_index;	<i>* bucket # *</i>
#ifdef RCHECK
		u_short ovu_rmagic;	<i>* range magic number *</i>
		u_long ovu_size;	<i>* actual block size *</i>
#endif
	} ovu;
#define	ov_magic ovu.ovu_magic
#define	ov_index ovu.ovu_index
#define	ov_rmagic ovu.ovu_rmagic
#define	ov_size  ovu.ovu_size
};
</p>

</div>

<p>
空き状態と専有状態を同時にとることはないので、同じメモリ空間を共用できる。
</p>
</div>
</div>

<div id="outline-container-org64d07cc" class="outline-3">
<h3 id="org64d07cc"><a href="#org64d07cc">構造体の使用例</a></h3>
<div class="outline-text-3" id="text-org64d07cc">
<p>
外部媒体のデータ構造を表現するために構造体が用いられる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>ネットワークインターフェースカードのコマンドブロックのデータ構造</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/sys/dev/ic/i82557reg.h#L147-L151
</pre>
</div>

<div class="results" id="org2fb0167">
<p>
struct fxp_cb_nop {
	volatile uint16_t cb_status;
	volatile uint16_t cb_command;
	volatile uint32_t link_addr;
};
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>TCPパケットヘッダの定義</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/external/bsd/tcpdump/dist/tcp.h#L37-L47
</pre>
</div>

<div class="results" id="org9287ea9">
<p>
struct tcphdr {
	uint16_t th_sport;		<i>* source port *</i>
	uint16_t th_dport;		<i>* destination port *</i>
	tcp_seq  th_seq;			<i>* sequence number *</i>
	tcp_seq  th_ack;			<i>* acknowledgement number *</i>
	uint8_t  th_offx2;		<i>* data offset, rsvd *</i>
	uint8_t  th_flags;
	uint16_t th_win;			<i>* window *</i>
	uint16_t th_sum;			<i>* checksum *</i>
	uint16_t th_urp;			<i>* urgent pointer *</i>
} UNALIGNED;
</p>

</div>

<p>
構造体にメソッドやプロパティに相当する定義をすることで、オブジェクト風に使える。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>オブジェクト指向的に使う</label><pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/sys/sys/domain.h#L55-L93
</pre>
</div>

<div class="results" id="orgc28d726">
<p>
struct	domain {
	int	dom_family;		<i>* AF_xxx *</i>
	const char <b>dom_name;
	void	(*dom_init)		/</b> initialize domain data structures */
			(void);
	int	(<b>dom_externalize)	/</b> externalize access rights */
			(struct mbuf <b>, struct lwp *, int);
	void	(*dom_dispose)		/</b> dispose of internalized rights */
			(struct mbuf *);
	const struct protosw <b>dom_protosw, *dom_protoswNPROTOSW;
	int	(*dom_rtattach)		/</b> initialize routing table <b>/
			(rtbl_t *</b>, int);
	int	dom_rtoffset;		<i>* an arg to rtattach, in bits *</i>
	int	dom_maxrtkey;		<i>* for routing layer *</i>
	void	(<b>dom_if_up)		/</b> ifnet brought up */
			(struct ifnet <b>);
	void	(*dom_if_down)		/</b> ifnet brought down */
			(struct ifnet <b>);
	void	*(*dom_ifattach)	/</b> attach af-dependent data on ifnet */
			(struct ifnet <b>);
	void	(*dom_ifdetach)		/</b> detach af-dependent data on ifnet */
			(struct ifnet *, void *);
	void	(*dom_if_link_state_change)
			(struct ifnet *, int);
	const void *(*dom_sockaddr_const_addr)(const struct sockaddr *,
					       socklen_t *);
	void	*(*dom_sockaddr_addr)(struct sockaddr *, socklen_t *);
	int	(*dom_sockaddr_cmp)(const struct sockaddr *,
	                            const struct sockaddr *);
	struct sockaddr *(*dom_sockaddr_externalize)(struct sockaddr *,
	                                             socklen_t,
						     const struct sockaddr *);
	const struct sockaddr <b>dom_sa_any;
	struct ifqueue *dom_ifqueues[2]; /</b> ifqueue for domain */
	STAILQ_ENTRY(domain) dom_link;
	struct	mowner dom_mowner;
	uint_fast8_t dom_sa_cmpofs;
	uint_fast8_t dom_sa_cmplen;
};
</p>

</div>
</div>
</div>

<div id="outline-container-org68d1145" class="outline-3">
<h3 id="org68d1145"><a href="#org68d1145">strlenの実装</a></h3>
<div class="outline-text-3" id="text-org68d1145">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/kd-collective/NetBSD/blob/89341ae2e1875e7f91cefa9b1dcc0e4549edcde0/common/lib/libc/string/strlen.c#L49-L56
</pre>
</div>

<div class="results" id="orgfdb2b70">
<p>
strlen(const char *str)
{
	const char *s;
</p>

<p>
	for (s = str; *s; ++s)
		continue;
	return(s - str);
}
</p>

</div>

<p>
ポインタを文字列の終端に達するまでインクリメントして、先頭のアドレスを差し引く。
</p>
<div class="org-src-container">
<pre class="src src-C"><span class="org-preprocessor">#include</span> <span class="org-string">&lt;stdio.h&gt;</span>
<span class="org-preprocessor">#include</span> <span class="org-string">&lt;string.h&gt;</span>
<span class="org-type">int</span> <span class="org-function-name">test_strlen</span>(<span class="org-type">char</span> *<span class="org-variable-name">str</span>) # str&#12399;&#20808;&#38957;&#12398;&#12450;&#12489;&#12524;&#12473;
{
  <span class="org-type">char</span> *<span class="org-variable-name">s</span>;

  <span class="org-keyword">for</span> (s = str; *s; ++s)
    <span class="org-keyword">continue</span>; # &#35201;&#32032;&#12398;&#25968;&#12384;&#12369;&#12452;&#12531;&#12463;&#12522;&#12513;&#12531;&#12488;
  <span class="org-keyword">return</span>(s - str); # &#36914;&#12435;&#12384;&#20998;&#12434;&#27714;&#12417;&#12427;
}
</pre>
</div>

<div class="results" id="orga8d369b">

</div>
</div>
</div>

<div id="outline-container-orgdd6b432" class="outline-3">
<h3 id="orgdd6b432"><a href="#orgdd6b432">無限ループのイディオム</a></h3>
<div class="outline-text-3" id="text-orgdd6b432">
<p>
無限ループの書き方。条件を指定しない。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/kd-collective/emacs/blob/d983e080e027bd7b680b1e40ccfa0c71d6a3cd94/lib-src/emacsclient.c#L275-L286
</pre>
</div>

<div class="results" id="orgf44e77a">
<p>
for (;;)
  {
    char *buf = malloc (buf_size);
    if (!buf)
      return NULL;
    if (getcwd (buf, buf_size) == buf)
      return buf;
    free (buf);
    if (errno != ERANGE || buf_size == bufsize_max)
      return NULL;
    buf_size = buf_size &lt;= bufsize_max / 2 ? 2 * buf_size : bufsize_max;
  }
</p>

</div>
</div>
</div>

<div id="outline-container-orgc092cde" class="outline-3">
<h3 id="orgc092cde"><a href="#orgc092cde">配列変数は先頭の要素へのポインタ</a></h3>
<div class="outline-text-3" id="text-orgc092cde">
<p>
配列変数には先頭の要素へのポインタが入っていて、インデックスをその分ずらすことで要素を取得できる。配列が0から始まるのはそのため。
</p>

<ul class="org-ul">
<li>最初の要素は、*doses もしくは doses[0] で取得できる。</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>等価なさまざまな表記</label><pre class="src src-C"><span class="org-type">doses</span>[3] == *(doses + 3) == *(3 + doses) == 3[doses]
</pre>
</div>

<div class="results" id="orgfcb3582">

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>ポインタをずらすことで、文字列をスキップできる</label><pre class="src src-C"><span class="org-type">void</span> <span class="org-function-name">skip</span>(<span class="org-type">char</span> *<span class="org-variable-name">msg</span>)
{
  puts(msg + 6);
}
<span class="org-type">char</span> *<span class="org-variable-name">msg_from_amy</span> = <span class="org-string">"Dont call me"</span>;
<span class="org-function-name">skip</span>(msg_from_amy);
</pre>
</div>

<div class="results" id="org3b6b0b5">
<p>
all me
</p>

</div>
</div>
</div>

<div id="outline-container-orgf5c3c02" class="outline-3">
<h3 id="orgf5c3c02"><a href="#orgf5c3c02">引数の渡し方</a></h3>
<div class="outline-text-3" id="text-orgf5c3c02">
<p>
関数呼び出しのとき、デフォルトは値渡しで、コピーされた値が使用される。コピーされるので、呼び出し元の引数の値は変化しない。変化させたいときは、参照を渡す必要がある。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>main内で座標を保持して、移動するための関数で座標を変化させるような場合、参照渡しでないといけない。</label><pre class="src src-C"><span class="org-type">void</span> <span class="org-function-name">move</span>(<span class="org-type">int</span> *<span class="org-variable-name">lat</span>, <span class="org-type">int</span> *<span class="org-variable-name">lon</span>) {
  *lat = *lat + 1; <span class="org-comment-delimiter">// </span><span class="org-comment">&#24341;&#25968;&#12391;&#28193;&#12373;&#12428;&#12383;lat&#12395;&#12399;&#12513;&#12514;&#12522;&#12450;&#12489;&#12524;&#12473;&#12364;&#20837;&#12387;&#12390;&#12356;&#12427;&#12398;&#12391;&#12289;&#26684;&#32013;&#12375;&#12390;&#12356;&#12427;&#20516;&#12434;&#35501;&#12415;&#36796;&#12416;&#12383;&#12417;&#12395;*&#12434;&#20351;&#12358;&#12290;</span>
  *lon = *lon + 1;
}

<span class="org-type">int</span> <span class="org-function-name">main</span>() {
  <span class="org-type">int</span> <span class="org-variable-name">latitude</span> = 32;
  <span class="org-type">int</span> <span class="org-variable-name">longitude</span> = 64;
  move(&amp;latitude, &amp;longitude); <span class="org-comment-delimiter">// </span><span class="org-comment">&#21442;&#29031;&#12434;&#28193;&#12377;&#12290;&#21442;&#29031;&#12391;&#12394;&#12356;&#22580;&#21512;&#12289;&#21336;&#12394;&#12427;&#20516;&#12398;&#12467;&#12500;&#12540;&#12392;&#12394;&#12387;&#12390;&#12289;move()&#20869;&#12391;&#20840;&#12367;&#38306;&#20418;&#12394;&#12356;&#12525;&#12540;&#12459;&#12523;&#22793;&#25968;&#12398;&#20516;&#12364;&#22793;&#12431;&#12427;&#12384;&#12369;&#12395;&#12394;&#12427;&#12290;main()&#20869;&#12398;&#20516;&#12399;&#22793;&#12431;&#12425;&#12394;&#12356;&#12290;</span>
  printf(<span class="org-string">"&#20572;&#27490;...&#29694;&#22312;&#20301;&#32622;&#65306;[%i, %i]\n"</span>, latitude, longitude);
  <span class="org-keyword">return</span> 0;
}
</pre>
</div>

<div class="results" id="org7e0e300">
<p>
停止&#x2026;現在位置：[33, 65]
</p>

</div>

<p>
渡したメモリ位置を更新する関数といえる。
</p>
</div>
</div>
</div>
<div id="outline-container-org031be61" class="outline-2">
<h2 id="org031be61"><a href="#org031be61">Tasks</a></h2>
<div class="outline-text-2" id="text-org031be61">
</div>
<div id="outline-container-org2057364" class="outline-3">
<h3 id="org2057364"><a href="#org2057364"><span class="todo TODO">TODO</span> <a href="https://9cguide.appspot.com/">総合目次 - 苦しんで覚えるC言語</a></a></h3>
<div class="outline-text-3" id="text-org2057364">
<p>
WEB版の入門書。
</p>
</div>
</div>
<div id="outline-container-org9b2689a" class="outline-3">
<h3 id="org9b2689a"><a href="#org9b2689a"><span class="todo TODO">TODO</span> <a href="https://www.oreilly.co.jp/books/9784873116099/">O&rsquo;Reilly Japan - Head First C</a>&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Read">Read</span></span></a></h3>
<div class="outline-text-3" id="text-org9b2689a">
<ul class="org-ul">
<li>41, 59, 67, 103, 105</li>
</ul>
<p>
楽しい入門書。
</p>
</div>
</div>
</div>
<div id="outline-container-org1ccce1d" class="outline-2">
<h2 id="org1ccce1d"><a href="#org1ccce1d">Reference</a></h2>
<div class="outline-text-2" id="text-org1ccce1d">
</div>
<div id="outline-container-orgb5ea0a4" class="outline-3">
<h3 id="orgb5ea0a4"><a href="#orgb5ea0a4"><a href="http://www.narihiro.info/g1gc-impl-book/">徹底解剖「G1GC」実装編</a></a></h3>
<div class="outline-text-3" id="text-orgb5ea0a4">
<p>
GCの実装の解説。
</p>
</div>
</div>
<div id="outline-container-org3e2ee36" class="outline-3">
<h3 id="org3e2ee36"><a href="#org3e2ee36"><a href="https://kuina.ch/l6prog">６さいからのプログラミング</a></a></h3>
<div class="outline-text-3" id="text-org3e2ee36">
<p>
C言語のチュートリアル。
</p>
</div>
</div>
<div id="outline-container-org10cb9a4" class="outline-3">
<h3 id="org10cb9a4"><a href="#org10cb9a4"><a href="http://www.kouno.jp/home/c_faq/">Language C FAQ</a></a></h3>
<div class="outline-text-3" id="text-org10cb9a4">
<p>
日本語版。
</p>
</div>
</div>
<div id="outline-container-org4dc2062" class="outline-3">
<h3 id="org4dc2062"><a href="#org4dc2062"><a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2020/p2137r0.html">P2137R0: Goals and priorities for C++</a></a></h3>
<div class="outline-text-3" id="text-org4dc2062">
<p>
C++の提案書。
</p>
</div>
</div>
<div id="outline-container-org693eae2" class="outline-3">
<h3 id="org693eae2"><a href="#org693eae2"><a href="http://www.nurs.or.jp/~sug/soft/index.htm">杉浦とソフトウェア開発</a></a></h3>
<div class="outline-text-3" id="text-org693eae2">
<p>
なんだかすごい人。
</p>
</div>
</div>
<div id="outline-container-org55d0ffb" class="outline-3">
<h3 id="org55d0ffb"><a href="#org55d0ffb"><a href="http://www.kh.rim.or.jp/~nagamura/misc/stroustrup-interview.html">Bjarne Stroustrup インタビュー (？)</a></a></h3>
<div class="outline-text-3" id="text-org55d0ffb">
<p>
C++の開発者へのインタビュー。
</p>
</div>
</div>
</div>
<div id="outline-container-org642dd38" class="outline-2">
<h2 id="org642dd38"><a href="#org642dd38">Archives</a></h2>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
