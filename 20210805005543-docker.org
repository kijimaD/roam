:PROPERTIES:
:ID:       1658782a-d331-464b-9fd7-1f8233b8b7f8
:header-args+: :wrap :results raw
:END:
#+title: Docker

* æ¦‚è¦
Dockerã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å„ªã‚ŒãŸä»®æƒ³ç’°å¢ƒã‚’ä½œã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€‚
å¾—ã‚‰ã‚Œã‚‹å¯æ¬æ€§ã«ã‚ˆã£ã¦ã€ä½œæˆã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é–‹ç™ºã«ãŠã‘ã‚‹å„ã‚¹ãƒ†ãƒ¼ã‚¸(ãƒ†ã‚¹ãƒˆã€ãƒ“ãƒ«ãƒ‰ã€ãƒªãƒªãƒ¼ã‚¹â€¦)ã§é©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ãã®æ„å‘³ã§[[id:eaf6ed04-7927-4a16-ba94-fbb9f6e76166][CI]], [[id:2c4cb3a7-7a8a-4a3b-88c2-2c5e69515764][CD]]ã®åŸºç¤çš„ãªæŠ€è¡“ã¨ãªã£ã¦ã„ã‚‹ã€‚
* Memo
** ã‚µãƒ¼ãƒ“ã‚¹åã‚’ã¤ã‘ã‚‹ã¨ç®¡ç†ãŒä¾¿åˆ©
ã‚µãƒ¼ãƒ“ã‚¹åã‚’ã¤ã‘ã¦èµ·å‹•ã™ã‚‹ã¨ã€åå‰ã‚’æŒ‡å®šã—ã¦æ­¢ã‚ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

#+caption: ã‚µãƒ¼ãƒ“ã‚¹ã«åå‰ã‚’ã¤ã‘ã¦èµ·å‹•ã™ã‚‹
#+begin_src shell
docker run -d -p 80:80 --name webserver nginx
#+end_src

#+caption: åå‰ã‚’æŒ‡å®šã—ã¦æ­¢ã‚ã‚‹
#+begin_src shell
docker stop webserver
#+end_src

** Dockeræœ¬ä½“ã®ãƒ“ãƒ«ãƒ‰æ–¹æ³•

- [[https://github.com/moby/moby][moby/moby: Moby Project]]
- æ‰‹å…ƒã«cloneã—ã¦ã„ã‚‹å‰æ

#+caption: ç”Ÿæˆ
#+begin_src shell
  sudo make build # environment
  sudo make binary # binary
  sudo chown -R $USER:$USER . # ãªãã¦ã‚‚ã„ã„
#+end_src

ã™ã‚‹ã¨ã€bundlesåŒ–ã«å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã€‚ã‚ã¨ã¯ãƒ“ãƒ«ãƒ‰ã—ãŸã‚‚ã®ã§ãƒ‡ãƒ¼ãƒ¢ãƒ³ã‚’èµ·å‹•ã™ã‚‹ã€‚

#+begin_src shell
  sudo service docker stop # ç¾çŠ¶ãƒ‡ãƒ¼ãƒ¢ãƒ³åœæ­¢
  sudo ./bundles/binary-daemon/dockerd
#+end_src

** docker buildã®ãƒ‡ãƒãƒƒã‚°

buildã§ã©ã“ã¾ã§æˆåŠŸã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºã‹ã‚ã‚‹ãŸã‚ã«ã€ã‚³ãƒãƒ³ãƒ‰ã‚’ä»•è¾¼ã¿ãŸã„ã“ã¨ãŒã‚ã‚‹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯å‡ºåŠ›ã•ã‚Œãªã„ã®ã§ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€‚

#+caption: --progress plainã‚’ä½¿ã†ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹ã¨å®Ÿè¡Œã•ã‚Œãªã„
#+begin_src shell
docker build . --progress plain --no-cache -t test
#+end_src

** ãƒ­ã‚°ã‚’è¿½å¾“ã•ã›ã‚‹
#+begin_src shell
docker-compose logs -f
#+end_src

-dã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯ãƒ­ã‚°ãŒå‡ºãªã„ã®ã§ä½¿ã£ã¦ã“ãªã‹ã£ãŸã€‚ã“ã‚Œã«ã‚ˆã£ã¦å’æ¥­ã§ãã‚‹ã€‚
** ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¨ãƒã‚¦ãƒ³ãƒˆã®é•ã„
- ãƒœãƒªãƒ¥ãƒ¼ãƒ  :: ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–ã§ãã‚‹å ´æ‰€ã®ã“ã¨
- ãƒã‚¦ãƒ³ãƒˆ :: ã‚³ãƒ³ãƒ†ãƒŠã«ãƒ›ã‚¹ãƒˆã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã“ã¨

ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ãƒã‚¦ãƒ³ãƒˆã—ãªã„ã¨ã€ä½¿ãˆã‚‹ã‚ˆã†ã«ã¯ãªã‚‰ãªã„ã€‚docker-composeã®volumesã§ã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¨ã„ã„ã¤ã¤æ›¸ãæ–¹ã«ã‚ˆã£ã¦ãƒã‚¦ãƒ³ãƒˆã—ã¦ãã‚Œã‚‹ã€‚

- [[https://qiita.com/gounx2/items/23b0dc8b8b95cc629f32][Dockerã€ãƒœãƒªãƒ¥ãƒ¼ãƒ (Volume)ã«ã¤ã„ã¦çœŸé¢ç›®ã«èª¿ã¹ãŸ - Qiita]]
** ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒ›ã‚¹ãƒˆã®ãƒãƒ¼ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
docker-composeã§ã‚³ãƒ³ãƒ†ãƒŠå´ã‹ã‚‰ãƒ›ã‚¹ãƒˆã®ãƒãƒ¼ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã€‚

#+begin_src yaml
    container:
      extra_hosts:
        - "host.docker.internal:host-gateway"
#+end_src

ã‚ã¨ã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚³ãƒ¼ãƒ‰å´ã§ã€ ~host.docker.internal:{ãƒ›ã‚¹ãƒˆã®ãƒãƒ¼ãƒˆç•ªå·}~ ã¨ã™ã‚‹ã“ã¨ã§ãƒ›ã‚¹ãƒˆã®ãƒãƒ¼ãƒˆã¸ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

** dockerãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®ä»•çµ„ã¿                                    :DontKnow:
:LOGBOOK:
CLOCK: [2022-10-16 Sun 15:38]--[2022-10-16 Sun 16:03] =>  0:25
:END:
- [[https://www.youtube.com/watch?v=bKFMS5C4CG0][Docker networking is CRAZY!! (you NEED to learn it) - YouTube]]
** Got permission deniedã‚¨ãƒ©ãƒ¼
dockerãŒsudoæ¨©é™ä»¥å¤–ã§å®Ÿè¡Œã§ããªããªã‚‹ã¨ããŒã‚ã‚‹ã€‚

#+begin_quote
  $ docker ps
  Got permission denied while trying to connect to the Docker daemon socket
#+end_quote

ã“ã‚Œã¯ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãŒdockeræ¨©é™ã‚’æŒã£ã¦ã„ãªã„ã‹ã‚‰ã€‚

#+caption: ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ã«dockeræ¨©é™ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
#+begin_src shell
sudo gpasswd -a $(whoami) docker
id $(whoami) # dockerãŒè¿½åŠ ã•ã‚ŒãŸã®ã‚’ç¢ºèªã™ã‚‹
#+end_src

ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚ã¨ã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã€‚sudoãªã—ã§dockerã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¦ã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚

- [[https://tech.librastudio.co.jp/entry/index.php/2018/07/14/post-1924/][dockerã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã®ã€ŒGot permission denied while trying to connect to the Docker daemon socketã€ - Libra Studio Log]]

** [[id:2d35ac9e-554a-4142-bba7-3c614cbfe4c4][GitHub Actions]]ã§ãƒ“ãƒ«ãƒ‰ã™ã‚‹
[[id:eaf6ed04-7927-4a16-ba94-fbb9f6e76166][CI]]ã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ãƒŠãƒ“ãƒ«ãƒ‰ã«ã¯ã€--cache-from ã‚’ä½¿ã£ã¦ã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«é€ä¿¡ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰å„ã‚¹ãƒ†ãƒ¼ã‚¸ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—ã—ã¦ã„ãæ–¹æ³•ã¨ã€CIã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’ä½¿ã†æ–¹æ³•ã®2ã¤ãŒã‚ã‚‹ã€‚

ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–ã‚‹æ–¹æ³•ã«ã¯å¼±ç‚¹ãŒã‚ã‚‹ã€‚

- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç™»éŒ²ã‚¤ãƒ¡ãƒ¼ã‚¸ã®1ã¤ã—ã‹ãªã„ã€‚ãŸã¨ãˆã°ç•°ãªã‚‹ãƒ–ãƒ©ãƒ³ãƒã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ›´æ–°ã•ã‚Œã‚‹ã¨ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¤±ã‚ã‚Œã‚‹
- --mount=type=...ã®cacheãŒã€pushã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã¯å«ã¾ã‚Œãªã„
- ã‚¹ãƒ†ãƒ¼ã‚¸ã”ã¨ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥é€šä¿¡(å–å¾—+é€ä¿¡)ã‚’ã™ã‚‹ãŒã€ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰ãŒå¤§ãã„
- ã‚¤ãƒ¡ãƒ¼ã‚¸ã«å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥(inline cache)ã«ã¯ã€minãƒ¢ãƒ¼ãƒ‰ã—ã‹é©ç”¨ã§ããªã„ã€‚ã¤ã¾ã‚Šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«åˆ¶é™ãŒã‚ã‚‹[[https://github.com/moby/buildkit#--export-cache-options][moby/buildkit: concurrent, cache-efficient, and Dockerfile-agnostic builder toolkit]]

ã®ãŸã‚ã€CIã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã‚’ä½¿ã†ã®ãŒç¾å®Ÿçš„ã‹ã€‚è¤‡æ•°ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥â€¦ãƒ–ãƒ©ãƒ³ãƒã”ã¨ã€Gemfileã®ãƒãƒƒã‚·ãƒ¥å€¤ã”ã¨ã§ãƒãƒƒã‚·ãƒ¥ã‚’ä¿æŒã§ãã‚‹ãŸã‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ã‚„ã™ã„ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ã²ã¨ã¾ã¨ã‚ã§ä¿å­˜ã•ã‚Œã€ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸ã®é€ä¿¡ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯åˆ©ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã ã‘ã«ãªã‚‹ã€‚
** RUN --mount=type=...ã‚ªãƒ—ã‚·ãƒ§ãƒ³
ãƒ“ãƒ«ãƒ‰æ™‚ã«ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€cacheãƒã‚¦ãƒ³ãƒˆã‚’åˆ©ç”¨ã§ãã‚‹ã€‚ãƒã‚¦ãƒ³ãƒˆã¨è¨€ã†ãŒã€ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã¨ã¯é–¢ä¿‚ãªã„ã€‚ãƒã‚¦ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ãƒ“ãƒ«ãƒ‰å¾Œå‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã«ã‚‚å„ªã—ã„ã€‚
https://github.com/moby/buildkit/blob/master/frontend/dockerfile/docs/syntax.md

#+begin_src
RUN --mount=type=cache,target=/root/.cache/go-build go build
#+end_src

ãŸã¨ãˆã°package.jsonã«å¤‰æ›´ãŒã‚ã£ãŸã¨ãã‚‚é€”ä¸­ã‹ã‚‰å†é–‹ã§ãã‚‹ã€‚ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã™ã‚‹/ã—ãªã„ã®ã‚¼ãƒ­ã‚¤ãƒã§ãªããªã‚‹ã€‚
** rake assets:precompileé«˜é€ŸåŒ–
- public/assets
- tmp/cache/assets

ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦ãŠãã“ã¨ã§é«˜é€ŸåŒ–ã§ãã‚‹ã€‚
** ãƒ“ãƒ«ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ä¿å­˜ã—ã€CIç’°å¢ƒã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã£ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹
ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã€‚ã“ã‚Œã«ã‚ˆã£ã¦ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã«ä¿æŒã•ã‚Œãªã„[[id:eaf6ed04-7927-4a16-ba94-fbb9f6e76166][CI]]ç’°å¢ƒãªã©ã§ã‚‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã—ã¦é«˜é€Ÿã«ãƒ“ãƒ«ãƒ‰ã§ãã‚‹ã€‚

ãƒã‚¤ãƒ³ãƒˆã¯--build-argã¨--cache-fromã€‚
--build-argã§ãƒ¡ã‚¿æƒ…å ±ã‚’å«ã‚ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã€‚ã“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’pushã—ã¦ãŠãã“ã¨ã§ã€æ¬¡å›ã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã§ãã‚‹ã€‚
--cache-fromã«ã‚ˆã£ã¦ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«ã‚ã‚‹æŒ‡å®šã‚¤ãƒ¡ãƒ¼ã‚¸ã‹ã‚‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å–å¾—ã—ã¦ãƒ“ãƒ«ãƒ‰ã™ã‚‹ã€‚

#+caption: --cache-from ã¨ --build-arg BUILDKIT_INLINE_CACHE=1
#+begin_src shell
  docker build --target build -t ghcr.io/kijimad/roam-build:master --cache-from ghcr.io/kijimad/roam-build:master --build-arg BUILDKIT_INLINE_CACHE=1 .
  docker push ghcr.io/kijimad/roam-build:master
#+end_src
** æœ¬ç•ªç”¨yarn buildã®ä¾‹
æœ¬ç•ªç”¨ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã«ãƒ“ãƒ«ãƒ‰ã™ã‚‹å ´åˆã®ä¾‹ã€‚
node_modulesã¯ã„ã‚‰ãªãã¦ã€ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã ã‘ã‚ã‚Œã°ã‚ˆã„ã€‚
ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’åˆ†ã‘ã‚‹ã“ã¨ã§ã€æ„å‘³ãŒæ˜ç¢ºã«ãªã‚Šã€ã‚µã‚¤ã‚ºã‚‚å°ã•ãã§ãã‚‹(é«˜é€ŸåŒ–)ã€‚

#+begin_src dockerfile
  COPY package.json $HOME/
  COPY front/ $HOME/front/ # front ã«ã¯ãƒ“ãƒ«ãƒ‰å¯¾è±¡ã®js, tsãƒ•ã‚¡ã‚¤ãƒ«ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹æƒ³å®šã€‚ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å°å…¥ã—ã¦ã„ã‚‹å ´åˆã€package.jsonã¯éšå±¤ä¸Šã«è¤‡æ•°ã‚ã‚‹ãŸã‚ã€COPYã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹

  RUN npm install

  COPY babel.config.js $HOME/
  COPY tsconfig.json $HOME/
  COPY webpack.config.js $HOME/

  RUN yarn run build
#+end_src

#+caption: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã ã‘ã‚’é…ç½®
#+begin_src dockerfile
COPY --from=rails-yarn-build $HOME/public/webpack/ $HOME/public/webpack/
#+end_src
** Railsé–‹ç™ºã®My docker-compose
[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]é–‹ç™ºã‚’ã™ã¹ã¦dockerã§ã‚„ã‚‹æƒ³å®šã€‚
ä¸€ç™ºã§ã™ã¹ã¦ãŒæº–å‚™ã•ã‚Œã€ã‚¯ãƒªãƒ¼ãƒ³ãªç’°å¢ƒã‚’æ§‹ç¯‰ã™ã‚‹ã€‚bundle install ã‚„yarn install ãªã©ã€ç«‹ã¡ä¸Šã’ç¶šã‘ã‚‹å‰æã§ãªã„ã‚³ãƒãƒ³ãƒ‰ã‚‚å«ã¾ã‚Œã‚‹ã€‚ãã®ã‚³ãƒãƒ³ãƒ‰ã ã‘å†åº¦å®Ÿè¡Œã—ãŸã„ã¨ãã¯ ~docker-compose restart bundle~ ãªã©ã¨ã™ã‚‹ã€‚

å…ƒãƒã‚¿: foremã®docker-compose.ymlã€‚
- https://github.com/forem/forem

â†“ã‚ã¨ã¯dockerizeã‚’è¨­å®šã™ã‚Œã°å®Œç’§ã‹ã€‚
#+caption: docker-compose.yml
#+begin_src yaml
  # å…±é€šã®imageå: app
  # imageã®ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: /app
  version: '3.7'

  services:
    mysql:
      image: mysql:latest
      ports:
        - '${MYSQL_PORT:-3306}:3306'
      environment:
        # DBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§ã®æ¥ç¶šæ™‚ã«å¿…è¦ãªã®ã§æ˜ç¤ºã™ã‚‹
        MYSQL_DATABASE: develop
        MYSQL_ROOT_PASSWORD: root
        MYSQL_USER: user
        MYSQL_PASSWORD: password
        MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'
      volumes:
        - 'mysql-data:/var/lib/mysql'

    redis:
      image: redis:latest
      ports:
        - '${REDIS_PORT:-6379}:6379'

    memcached:
      image: memcached:latest
      ports:
        - '${MEMCACHED_PORT:-11212}:11211'

    rails:
      image: app
      environment:
        RAILS_ENV: development
        REDIS_URL: 'redis://redis:6379'
        MEMCACHED: 'memcached:11211'
        DATABASE_URL: 'mysql2://root@mysql:3306'
      depends_on:
        - mysql
        - redis
        - memcached
        - bundle
        - yarn
        - seed
      command: bash -c 'bundle exec rails s -b 0.0.0.0'
      volumes:
        - .:/app:delegated # delegatedã§é«˜é€ŸåŒ–
        - gem_data:/usr/local/bundle:delegated # packageç³»ã¯æ°¸ç¶šåŒ–ã—ã¦æœ€åˆã‹ã‚‰installã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹
        - node_modules:/app/node_modules:delegated
      ports:
        - '3000:3000'

    webpack:
      image: app
      environment:
        NODE_ENV: development
        WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
      command: bash -c 'yarn watch'
      volumes:
        - .:/app:delegated
        - node_modules:/app/node_modules:delegated
      ports:
        - 8080:8080

    sidekiq:
      image: app
      command: bash -c 'bundle exec sidekiq -C config/sidekiq.yml'
      environment:
        REDIS_URL: 'redis://redis:6379'
        DATABASE_URL: 'mysql2://root@mysql:3306'
      volumes:
        - .:/app:delegated
        - gem_data:/usr/local/bundle:delegated
      links:
        - mysql
        - redis

    bundle:
      image: app
      environment:
        RAILS_ENV: development
      volumes:
        - .:/app:delegated
        - gem_data:/usr/local/bundle:delegated
      command: bash -c "bundle install --jobs 8" # ãƒã‚·ãƒ³ãŒã„ãã¤ä¸¦åˆ—å‡¦ç†ã§ãã‚‹ã‹ã¯`$ getconf _NPROCESSORS_ONLN` ã§èª¿ã¹ã‚‰ã‚Œã‚‹

    yarn:
      image: app
      environment:
        NODE_ENV: development
      volumes:
        - .:/app:delegated
        - node_modules:/app/node_modules:delegated
      command: bash -c "yarn install"

    seed:
      image: app
      environment:
        DATABASE_URL: 'mysql2://root@mysql:3306'
      volumes:
        - .:/app:delegated
        - gem_data:/usr/local/bundle:delegated
      command: bash -c "rake db:seed_fu"

  volumes:
    gem_data:
    node_modules:
    mysql_data:
#+end_src

#+caption: entrypoint.sh
#+begin_src shell
  #! /bin/bash

  set -e

  if [ -f tmp/pids/server.pid ]; then
    rm -f tmp/pids/server.pid
  fi

  cat << EOF

    â–‘â–‘â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–â–ˆâ–„â–„â–„â–„â–ˆâ–Œâ–‘
    â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–Œâ–€â–€â–ˆâ–ˆâ–€â–€â–‘â–‘
    â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–„â–„â–ˆâ–Œâ–‘â–‘â–‘â–‘
    â–‘â–‘â–„â–„â–„â–„â–„â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–€ â–‘â–‘â–‘â–‘

  EOF

  exec "$@"

#+end_src
** docker serviceå†èµ·å‹•
ãŠã‹ã—ããªã£ãŸã¨ãã®å†èµ·å‹•ã€‚
#+begin_src shell
sudo service docker restart
#+end_src
** ã‚³ãƒ³ãƒ†ãƒŠæƒé™¤é–¢ä¿‚
[[https://qiita.com/shisama/items/48e2eaf1dc356568b0d7][ã‚³ãƒãƒ³ãƒ‰ã§Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤ã‚’ã™ã‚‹ - Qiita]]

#+begin_src shell
docker stop $(docker ps -q) # å…¨ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
docker rm $(docker ps -q -a) # å…¨ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
docker rmi $(docker images -q) # å…¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤:
#+end_src
** ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒã¨ã‚“ã§ã‚‚ãªã„ã“ã¨ã«ãªã£ã¦ã„ãŸã¨ã
ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒã»ã¼100ï¼…ã«ãªã£ã¦ã„ãŸã€‚å ã‚ã¦ã„ã‚‹ã»ã¨ã‚“ã©ã¯Dockeré–¢ä¿‚ã®ã‚ˆã†ã ã£ãŸã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŸãŒã€ã»ã‹ã«ã‚‚è‰²ã€…ã‚ã‚‹ã‚ˆã†ã€‚

å°‚ç”¨ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã€‚
https://docs.docker.com/config/pruning/

éå¸¸ã«å¤šãã®ã‚´ãƒŸãŒã‚ã‚Šãã†ã ã£ãŸã®ã§ã€å¤šå°‘å†pullã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ã‚’è¨±å®¹ã—ã¦ã™ã¹ã¦å‰Šé™¤ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚
#+caption: æ‰‹ã£å–ã‚Šæ—©ãã™ã¹ã¦æ¶ˆã™ã€‚è­¦å‘ŠãŒå‡ºã‚‹
#+begin_src shell
docker system prune
#+end_src

ã‚´ãƒªã‚´ãƒªbuildã—ã¦è©¦ã—ã¦ã„ã‚‹ã¨ãã¯ã€æ°—ã‚’ã¤ã‘ãŸã»ã†ãŒã‚ˆã•ãã†ã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã ã‘è¡Œã†ã€‚ã“ã®å ´åˆãŒå¤šãã†ã€‚
#+begin_src shell
docker builder prune
#+end_src
** entrypoint.sh
å…¬å¼Docker Imageã§ã‚ˆãç”¨ã„ã‚‰ã‚Œã‚‹ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
å…¬å¼ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã¾ã¾ã§ã€åˆå›èµ·å‹•æ™‚ã«å®Ÿè¡Œã—ãŸã„ãƒ•ãƒƒã‚¯ã¨ã—ã¦è¨˜è¿°ã§ãã‚‹ã€‚

ä¾‹(Dockerfile): [[https://github.com/tzumby/rails-on-kubernetes/blob/master/Dockerfile][rails-on-kubernetes/Dockerfile at master Â· tzumby/rails-on-kubernetes]]
#+caption: Dockerfileã®æœ«å°¾ã§å–ã‚Šè¾¼ã‚€
#+begin_src shell
ADD . /myapp

COPY docker-entrypoint.sh /usr/local/bin

ENTRYPOINT ["docker-entrypoint.sh"]
#+end_src

ä¾‹(entrypoint.sh): [[https://github.com/tzumby/rails-on-kubernetes/blob/master/docker-entrypoint.sh][rails-on-kubernetes/docker-entrypoint.sh at master Â· tzumby/rails-on-kubernetes]]
#+caption: entrypoint.sh $@ã¯å¼•æ•°
#+begin_src shell
#!/bin/sh

set -e

if [ -f tmp/pids/server.pid ]; then
  rm tmp/pids/server.pid
fi

echo "Waiting for Postgres to start..."
while ! nc -z postgres 5432; do sleep 0.1; done
echo "Postgres is up"

echo "Waiting for Redis to start..."
while ! nc -z redis 6379; do sleep 0.1; done
echo "Redis is up - execuring command"

exec bundle exec "$@"
#+end_src
** docker-composeã¨docker
docker-composeã¯è‡ªå‹•ã§ã‚¿ã‚°åã‚’ã¤ã‘ã¦ãã‚ŒãŸã‚Šã€ãƒã‚¦ãƒ³ãƒˆã—ã¦ãã‚ŒãŸã‚Šã€dockerã‚³ãƒãƒ³ãƒ‰ã‚ˆã‚Šã‚„ã‚„ã“ã—ããªã‚Šã«ãã„ã€‚
å˜ã«é–‹ç™ºç’°å¢ƒã¨ã—ã¦ä½¿ã£ã¦ã„ã‚‹ã ã‘ã§ã¯ã€ã»ã¨ã‚“ã©docker-composeã§äº‹è¶³ã‚Šã‚‹ã€‚
ãŒã€docker-composeã¸ä¾å­˜ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã€docker-composeé–¢ä¿‚ãªã„åˆ¥ã®æ–‡è„ˆã§ä½¿ãŠã†ã¨ã™ã‚‹ã¨é€”ç«¯ã«å‹•ã‹ãªããªã‚‹ã€‚æœ¬è³ªçš„ã«docker-composeã¯ã‚³ãƒ³ãƒ†ãƒŠé–“ã®é–¢ä¿‚æ€§ã‚’è¨˜è¿°ã—ã¦ã„ã‚‹ã ã‘ã§ã€ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã‚’è¡¨ç¾ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚

æœ¬å½“ã«dockerã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦ã®æ­£ã—ã„ä½¿ã„æ–¹ã‚’ã—ã¦ã„ã‚‹ã‹ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’è¤‡æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„CIã§åˆ©ç”¨ã—ã¦ã¿ã‚‹ã®ãŒã‚ˆã„ã€‚åŒã˜æµã‚Œã§ç°¡å˜ã«ã§ããŸã®ãªã‚‰æ­£ã—ã„ã€‚ç°¡å˜ã«ã§ããªã„ãªã‚‰ä½•ã‹ãŒé–“é•ã£ã¦ã„ã‚‹ã€‚
** ã‚ˆãä½¿ã†dockerã‚ªãƒ—ã‚·ãƒ§ãƒ³
#+caption: ä¾‹
#+begin_src shell
docker run --rm -v "$PWD/":/roam -w /roam ghcr.io/kijimad/roam:master sh deploy.sh
#+end_src

~--rm~ : ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã™ã‚‹
~-v~: ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã€‚å·¦ãŒãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã€å³ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã€‚

#+caption: -itã®æ„å‘³: å¯¾è©±ãƒ¢ãƒ¼ãƒ‰
#+begin_src shell
docker run --rm -it ghcr.io/kijimad/roam:master
#+end_src
-it ã¯ttyã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ã‚§ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚ã¤ã‘ãªã„ã¨ã€ä¸€ç¬ã§æ¶ˆãˆã‚‹ã€‚
** buildkitã‚’ã‚ªãƒ³ã«ã™ã‚‹
ç’°å¢ƒå¤‰æ•°ã‚’ã‚ªãƒ³ã«ã™ã‚‹ã“ã¨ã§ã€æ–°ã—ã„æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
#+caption: shell
#+begin_src shell
  export COMPOSE_DOCKER_CLI_BUILD=1
  export DOCKER_BUILDKIT=1
  docker build .
#+end_src
** docker-composeã§ãƒã‚¦ãƒ³ãƒˆã—ãŸã¨ãã«node_modulesãŒæ¶ˆãˆã‚‹å•é¡Œ
1. npm install ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
2. ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒã‚¦ãƒ³ãƒˆ
3. ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãªã„node_modulesã¯æ¶ˆãˆã‚‹
4. ã‚¨ãƒ©ãƒ¼

ãªã®ã§ã€node_modulesã‚‚ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã€‚

#+caption: docker-compose.yml
#+begin_export yaml
volumes:
  - .:/contaier # ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦ãƒã‚¦ãƒ³ãƒˆã€‚ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãªã„ã®ã¯æ¶ˆãˆã‚‹
  - /container/node_modules
#+end_export

#+caption: dockerã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã€‚-v ã‚’2ã¤ã§æŒ‡å®šã™ã‚‹
#+begin_src shell
docker run --rm -v "$PWD":/roam -v /roam/node_modules ghcr.io/kijimad/roam_lint:master make textlint
#+end_src

https://rara-world.com/dockerfile-node-modules/ ã«æ›¸ã„ã¦ã‚ã£ãŸã€‚
** dockleã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
dockleã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã€‚
[[https://github.com/goodwithtech/dockle][goodwithtech/dockle: Container Image Linter for Security, Helping build the Best-Practice Docker Image, Easy to start]]

è‡ªå‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‹ã‘ã‚‹ã¨ãŸãã•ã‚“è¦‹ã¤ã‹ã£ãŸã€‚
#+caption: å®Ÿè¡Œã—ã¦ã¿ãŸ
#+begin_src shell
$ dockle ghcr.io/kijimad/roam:4f3296b
FATAL   - DKL-DI-0001: Avoid sudo command
        ,* Avoid sudo in container : /bin/sh -c yum -y update &&     yum -y install         yum-utils
      gcc         gcc-c++         make         openssl-devel         openssh-server         readline
nuplot
WARN    - CIS-DI-0001: Create a user for the container
        ,* Last user should not be root
INFO    - CIS-DI-0005: Enable Content trust for Docker
        ,* export DOCKER_CONTENT_TRUST=1 before docker pull/build
INFO    - CIS-DI-0006: Add HEALTHCHECK instruction to the container image
        ,* not found HEALTHCHECK statement
INFO    - CIS-DI-0008: Confirm safety of setuid/setgid files
        ,* setgid file: g--x--x--x usr/libexec/openssh/ssh-keysign
        ,* setuid file: urwxr-xr-x usr/sbin/pam_timestamp_check
        ,* setuid file: urwxr-xr-x usr/bin/mount
        ,* setgid file: grwx--x--x usr/libexec/utempter/utempter
        ,* setuid file: urwxr-xr-x usr/bin/chage
        ,* setuid file: urwxr-xr-x usr/bin/su
        ,* setuid file: urwxr-x--- usr/libexec/dbus-1/dbus-daemon-launch-helper
        ,* setuid file: urwxr-xr-x usr/sbin/unix_chkpwd
        ,* setuid file: u--x--x--x usr/bin/sudo
        ,* setgid file: g--x--x--x usr/bin/ssh-agent
        ,* setuid file: urwxr-xr-x usr/bin/umount
        ,* setuid file: urwxr-xr-x usr/bin/gpasswd
        ,* setuid file: urwxr-xr-x usr/bin/newgrp
        ,* setgid file: grwxr-xr-x usr/bin/write
INFO    - DKL-LI-0003: Only put necessary files
        ,* Suspicious directory : roam/.git
        ,* Suspicious directory : usr/local/plugins/ruby-build/.git
        ,* Suspicious directory : usr/local/plugins/ruby-build/test/tmp
        ,* Suspicious directory : tmp
        ,* unnecessary file : roam/docker-compose.yml
        ,* unnecessary file : roam/Dockerfile
#+end_src
** pushã‚¹ã‚¯ãƒªãƒ—ãƒˆ
[[https://www.amazon.co.jp/dp/B01N0SS6NF/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1][Amazon.co.jp: Deploying Rails with Docker, Kubernetes and ECS (English Edition) eBook : AcuÃ±a, Pablo: Foreign Language Books]]ã«è¼‰ã£ã¦ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚æ›¸ã„ã¦ãƒªãƒã‚¸ãƒˆãƒªã«å…¥ã‚Œã¦ãŠãã¨ã‚¹ãƒ ãƒ¼ã‚ºã«ãƒ“ãƒ«ãƒ‰ã‚„ãƒ—ãƒƒã‚·ãƒ¥ãŒã§ãã‚‹ã€‚
ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ»ãƒ¦ãƒ¼ã‚¶åãƒ»ãƒªãƒã‚¸ãƒˆãƒªã‚’é©å®œå¤‰ãˆã‚‹ã€‚
#+begin_src shell
  #!/bin/sh

  LC=$(git rev-parse --short HEAD)
  docker build -t ghcr.io/kijimad/webapp:${LC} .
  docker push ghcr.io/kijimad/webapp:${LC}
#+end_src
** å®Ÿè¡Œå¾Œã«ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
docker run ã™ã‚‹ã¨ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å…¥ã‚Œã‚‹ãŒã€ä½œã£ãŸã‚³ãƒ³ãƒ†ãƒŠã¯ãã®ã¾ã¾ã«ãªã‚‹ã€‚
å®Ÿè¡Œå¾Œã«å‰Šé™¤ã—ã¦æ¬²ã—ã„å ´åˆã¯ã€ ~docker --rm webapp /bin/sh~ ãªã©rmã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã€‚
** ã‚³ãƒ³ãƒ†ãƒŠé–“ã®æ¥ç¶šã¯ã‚µãƒ¼ãƒ“ã‚¹åã‚’ç”¨ã„ã‚‹
ã‚³ãƒ³ãƒ†ãƒŠé–“ã®æ¥ç¶šã‚’ã—ã‚ˆã†ã¨ã—ã¦ã€ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã€‚
#+caption: sidekiq -> redisã¸æ¥ç¶šã—ãŸã„
#+begin_quote
Error connecting to Redis on 127.0.0.1:6379 (Errno::ECONNREFUSED)
#+end_quote

127.0...ã¨ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã«è¡Œã£ã¦ã‚‹ã€‚
ã‚³ãƒ³ãƒ†ãƒŠé–“ã§ã®é€šä¿¡ã«ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹åã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

#+caption: redis://redis:6379/15
#+begin_export yaml
  worker:
    build: .
    command: bundle exec sidekiq
    environment:
      REDIS_URL: redis://redis:6379/15 ï¼ƒ<---åˆ¥ã®redisã‚³ãƒ³ãƒ†ãƒŠã¸ã®æ¥ç¶š
    volumes:
      - .:/app
    links:
      - mysql
      - redis
#+end_export
** rootãƒ¦ãƒ¼ã‚¶ã§ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã—ãªã„ã‚ˆã†ã«ã™ã‚‹
Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨ã€ownerãŒrootã«ãªã‚Šç·¨é›†ã‚„å‰Šé™¤ãŒã§ããšé¢å€’ã€‚
Dockerã®å†…éƒ¨ã§ã¯ãƒ¦ãƒ¼ã‚¶id(uid)ã‚„ã‚°ãƒ«ãƒ¼ãƒ—id(gid)ãŒãƒ›ã‚¹ãƒˆã¨ç•°ãªã‚‹ã€‚idãŒãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã¨åˆã‚ãªã„ãŸã‚rootã¨ã—ã¦å®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã«ãªã‚‹ã€ã‚ˆã†ã€‚

å®‰æ˜“ãªè§£æ±ºç­–ã¨ã—ã¦ã¯ã€æ¨©é™ã‚’ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ã«å¤‰æ›´ã™ã‚Œã°å•é¡Œãªã„ã€‚
ã¨ã¯ã„ãˆã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ–°ã—ããƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ãŸã³(ãŸã¨ãˆã°ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ)ã«å®Ÿè¡Œã™ã‚‹ã®ã¯é¢å€’ã€‚
[[https://docs.docker.com/samples/rails/][If you are running Docker on Linux, the files rails new created are owned by root.]]
#+caption: æ¨©é™å¤‰æ›´
#+begin_src shell
  sudo chown -R $USER:$USER .
#+end_src

è§£æ±ºç­–ã¨ã—ã¦ã¯ã„ãã¤ã‹ç¨®é¡ãŒã‚ã‚‹ã‚ˆã†ãªã®ã ãŒã€ã¨ã‚Šã‚ãˆãšã§ããŸã€‚
ã‚µãƒ¼ãƒ“ã‚¹ã®volumesã«ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã€‚:roã¯èª­ã¿å–ã‚Šå°‚ç”¨(read onlyã‹)ã€‚
ã“ã‚Œã§idã®ç…§åˆå…ƒãŒãƒ›ã‚¹ãƒˆã¨åŒã˜ã«ãªã‚‹ã€‚

#+caption: docker-compose.yml
#+begin_src yaml
  volumes:
    - /etc/passwd:/etc/passwd:ro
    - /etc/group:/etc/group:ro
#+end_src

ã‚ã¨ã¯idã‚’ç’°å¢ƒå¤‰æ•°çµŒç”±ã§æ¸¡ã›ã°ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚‚ãƒ›ã‚¹ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãŒå®Ÿè¡Œã—ãŸã“ã¨ã«ãªã‚‹ã€‚
#+begin_src shell
  sudo docker run -u "$(id -u $USER):$(id -g $USER)" rails /bin/sh
  sudo docker-compose run -u "$(id -u $USER):$(id -g $USER)" rails /bin/sh
#+end_src

overrideãŒã‚ã‚‹å ´åˆã€ã“ã®ã‚ˆã†ã«ãªã‚‹(é•·ã™ã)ã€‚
#+begin_src shell
sudo docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run -u "$(id -u $USER):$(id -g $USER)" rails /bin/sh
#+end_src

[[https://blog.amedama.jp/entry/docker-container-host-same-user][Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ Docker ãƒ›ã‚¹ãƒˆã¨åŒã˜ãƒ¦ãƒ¼ã‚¶ã‚’ä½¿ã† - CUBE SUGAR CONTAINER]]
** Docker Hub
Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã€‚
å€‹åˆ¥ã«ãƒ“ãƒ«ãƒ‰ã—ãªãã¦ã‚ˆããªã‚‹ãŸã‚Dockeré–¢é€£ã®å…¨å·¥ç¨‹ãŒé«˜é€ŸåŒ–ã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã€ãƒ‡ãƒ—ãƒ­ã‚¤â€¦ã€‚
** ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¨ã¯
ã‚µã‚¤ãƒˆã‚’Dockerãƒ‡ãƒ—ãƒ­ã‚¤ã«ã—ãŸã‚Šã€CIã‚’Dockerã§è¡Œã†ã¨ãã€‚
è¤‡æ•°ã®ç’°å¢ƒãŒé–¢ä¿‚ã™ã‚‹å ´åˆã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ããŸã‚é«˜é€ŸåŒ–ã§ãã‚‹ã€‚

- Linuxé–¢é€£ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
- [[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]]é–¢é€£ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
- nodeé–¢é€£ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
- [[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ¡ãƒ¼ã‚¸

ã®ã‚ˆã†ã«ã€‚
Linux â†’ [[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]] + node â†’ [[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã¨ã„ã†ä¾å­˜é–¢ä¿‚ã«ãªã‚‹ã€‚
** Dockerfileã¯ä½•ã‹
Dockrfileã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹ã€‚(image build)
docker-compose upã¯â†‘ã§ä½œã‚‰ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…ƒã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚Šèµ·å‹•ã¾ã§ã™ã‚‹ã€‚ãã®ãªã‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ°ã‚‰ã›ã¦é–‹ç™ºã™ã‚‹ã€‚

imageæ§‹ç¯‰ â†’ ã‚³ãƒ³ãƒ†ãƒŠæ§‹ç¯‰ â†’ ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹• ã¨ã„ã†æµã‚Œã€‚

ã‚³ãƒ³ãƒ†ãƒŠã®ä½œã‚Šæ–¹ã«ã¯2ç¨®é¡ã‚ã‚‹ã€‚
- è‡ªä½œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‚ã®ã¯â†‘Dockerfileã§ä½œã‚‹
- æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠ([[id:7dab097c-60ba-43b9-949f-c58bf3151aa8][MySQL]]ã¨ã‹)ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
** ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã™ã‚‹
ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã§å®Ÿè¡Œã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã¨ãã«ã‚„ã‚ŠãŸã„ã“ã¨ã€ãŸã¨ãˆã°[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã ã¨ã€gemfileãŒæ–°ã—ããªã£ãŸã¨ãã«bundle installã—ãŸã„ã€‚

runã¯æ–°ã—ãã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã€å†…éƒ¨ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ã‚µãƒ¼ãƒ“ã‚¹åã¯docker-compose.ymlã‹ã‚‰å–ã£ã¦ã„ã‚‹ã€‚ã¤ã¾ã‚Šç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠåã¯é–¢ä¿‚ãªã„ã®ã«æ³¨æ„ã€‚ä½•ã‚‚æŒ‡å®šã—ã¦ãªã„å ´åˆã€docker-compose.ymlã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ±ºå®šã™ã‚‹ã€‚ã»ã‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã«ã¯-fã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€‚å¤–éƒ¨ã§æ°¸ç¶šåŒ–ã•ã‚Œã‚‹â€¦volumeãŒæŒ‡å®šã•ã‚Œã¦ã‚‹ã‚ˆã†ãªå‡¦ç†(bundle install)ã¨ã‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢ä¿‚ã¯ã„ã„ã®ã ãŒã€ãã®ä»–ã¯æ°¸ç¶šåŒ–ã•ã‚Œãªã„ã®ã§æ³¨æ„ã€‚

#+caption: run
#+begin_src shell
  docker-compose run {ã‚µãƒ¼ãƒ“ã‚¹å} {shellã‚³ãƒãƒ³ãƒ‰}
#+end_src

execã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’å†åˆ©ç”¨ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚é«˜é€Ÿã€‚
#+caption: exec
#+begin_src shell
  docker-compose exec {ã‚µãƒ¼ãƒ“ã‚¹å} {shellã‚³ãƒãƒ³ãƒ‰}
#+end_src
** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšã«buildã™ã‚‹
#+begin_src shell
  docker-compose build --no-cache
#+end_src
** ç«‹ã¡ä¸Šã’ã¨åœæ­¢
#+begin_src shell
docker-compose up --build -d # ã‚³ãƒ³ãƒ†ãƒŠä½œæˆã™ã‚‹
docker-compose down
#+end_src
** dockerå¤–ã«å…¬é–‹ã™ã‚‹
[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]
Dockerfileã§ã€‚
#+begin_src shell
  CMD bundle exec rails server -b 0.0.0.0
#+end_src

ãªã©ã¨æ›¸ã„ã¦ãŠãã¨ã€å¤–éƒ¨(Dockerå¤–)ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚-b 0.0.0.0 ãŒãªã„ã¨åˆ¥ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãŒä¸å¯ã€‚ã‚³ãƒ³ãƒ†ãƒŠã‚’è¶…ãˆã‚‹ã¨åˆ¥ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ‰±ã„ã«ãªã‚‹ã®ã§ã“ã®è¨˜è¿°ãŒå¿…è¦ã€‚
** ãƒãƒ¼ãƒˆæŒ‡å®šã™ã‚‹
ã©ã£ã¡ã ã£ãŸã‹å¿˜ã‚Œã‚‹ã€‚
å·¦ãŒå…¬é–‹ã€å³ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã€‚ã ã‹ã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒ¼ãƒˆ8000ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
#+begin_src shell
  docker run -p 8000:3000 -it bdd92ace66ec
#+end_src
** ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹
#+begin_src shell
docker ps -a # idç¢ºèª
docker logs 1111... # idã‚’å…¥ã‚Œã‚‹
#+end_src
** ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹
ä½¿ã£ã¦ãªã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹ã€‚
#+begin_src shell
  docker images prone
#+end_src

ä¸€æ°—ã«å…¨éƒ¨å‰Šé™¤ã™ã‚‹ã€‚
#+begin_src shell
  docker stop $(docker ps -q)
  docker rm $(docker ps -aq)
  docker rmi $(docker images -q)
#+end_src
** ã‚³ãƒ³ãƒ†ãƒŠã®å¤§ã¾ã‹ãªä»•çµ„ã¿
CLOSED: [2022-09-17 Sat 21:55]
:LOGBOOK:
CLOCK: [2022-08-07 Sun 12:05]--[2022-08-07 Sun 12:30] =>  0:25
:END:
ä»®æƒ³åŒ–ã‚’ã©ã†ã‚„ã£ã¦ã„ã‚‹ã‹ã€ãªãœç‹¬ç«‹ã—ãŸç’°å¢ƒã«ã§ãã‚‹ã®ã‹çŸ¥ã‚‰ãªã„ã€‚

è§£èª¬ã¯â†“ã«ã‚ã‚‹ã€‚éå¸¸ã«ã‚ã‹ã‚Šã‚„ã™ã„ã€‚[[id:7cacbaa3-3995-41cf-8b72-58d6e07468b1][Go]]ã®ãƒŸãƒ‹ãƒãƒ«å®Ÿè£…ã‚‚ã‚ã‚‹ã€‚
- [[https://kaminashi-developer.hatenablog.jp/entry/dive-into-swamp-container-scratch][ã€Goè¨€èªã€‘è‡ªä½œã‚³ãƒ³ãƒ†ãƒŠæ²¼ã€‚ã‚¹ã‚¯ãƒ©ãƒƒãƒã§ãƒŸãƒ‹Dockerã‚’ä½œã‚ã† - ã‚«ãƒŸãƒŠã‚· ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒ–ãƒ­ã‚°]]

dockerã®æ§‹æˆã€‚

- Docker Host
  - Docker Daemon
  - Container
  - Images
  - Network
- Docker client
  - build, pull, runã¨ã‹

network, container, image, volumesã¯CliçµŒç”±ã§Docker daemonã®æ©Ÿèƒ½ã‚’å‘¼ã³å‡ºã™ã€‚
ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€è¨€ã§è¨€ã†ã¨ã€Œ ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰åˆ†é›¢ã•ã‚ŒãŸãƒ—ãƒ­ã‚»ã‚¹ ã€ã€‚Linuxä¸Šã§unshareã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã“ã¨ã«ã‚ˆã‚Šã€æœ€é€Ÿã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã§ãã‚‹ã€‚

#+caption: æœ€ä½é™ã®ã‚³ãƒ³ãƒ†ãƒŠã€‚ã“ã®ç«‹ã¡ä¸ŠãŒã£ãŸãƒ—ãƒ­ã‚»ã‚¹ãŒã‚³ãƒ³ãƒ†ãƒŠ
#+begin_src shell
  $ sudo unshare -u /bin/bash
  # ãƒ¦ãƒ¼ã‚¶ãŒrootã«ãªã£ãŸ
  $ hostname newhost && hostname
  -> newhost
  # ãƒ›ã‚¹ãƒˆåã‚’å¤‰æ›´ã—ãŸ
  $ which emacs
  -> /usr/bin/emacs # unshareã—ã¦ãªã„çŠ¶æ…‹ã ã¨Emacsã¯guixãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåŒ–ã«å…¥ã£ã¦ã„ã‚‹ã®ã§ã€ç¢ºã‹ã«ç’°å¢ƒãŒåˆ¥ã«ãªã£ã¦ã„ã‚‹
#+end_src

ã‚³ãƒ³ãƒ†ãƒŠã«å¿…è¦ãª[[id:7a81eb7c-8e2b-400a-b01a-8fa597ea527a][Linux]]ã®æ©Ÿèƒ½3ã¤ã€‚

- Namespace
  - ãƒ—ãƒ­ã‚»ã‚¹ã¯ãã‚Œãã‚Œã§Namespaceã‚’æŒã£ã¦ã„ã‚‹ã€‚unshareã¯ãƒ—ãƒ­ã‚»ã‚¹ã‚’åˆ†é›¢ã•ã›Namespaceã‚’ä½œæˆã—ãŸ
- Control Group
  - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç‰¹å®šã®ãƒªã‚½ãƒ¼ã‚¹ã‚»ãƒƒãƒˆã«åˆ¶é™ã™ã‚‹ã€‚ãƒ¡ãƒ¢ãƒªã®æœ€å¤§åˆ©ç”¨æ•°ã‚„ã€ãƒ—ãƒ­ã‚»ã‚¹æœ€å¤§å®Ÿè¡Œæ•°ã‚’åˆ¶é™ã§ãã‚‹
  - ~cat /sys/fs/cgroup/cpuset/cpuset.cpus~
- File System
  - è¦ªã‹ã‚‰ãƒã‚¦ãƒ³ãƒˆã•ã‚ŒãŸFile Systemã«é–¢ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã‚³ãƒ”ãƒ¼ã‚’å–å¾—ã—ã€è¦ªã¨åŒã˜ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¸ã®ãƒã‚¤ãƒ³ã‚¿ã‚’å–å¾—ã—ã¦å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  - cat ~/proc/mounts~
** ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒ›ã‚¹ãƒˆã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
docker-compose cp ãŒä½¿ãˆã‚‹ã€‚dockerã‚³ãƒãƒ³ãƒ‰ã¨é•ã£ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠIDã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒãªã„ã€‚

ã‚³ãƒ³ãƒ†ãƒŠ â†’ ãƒ›ã‚¹ãƒˆã§ã‚‚ã€ãƒ›ã‚¹ãƒˆ â†’ ã‚³ãƒ³ãƒ†ãƒŠã§ã‚‚ã€å…¥ã‚Œæ›¿ãˆã¦ä½¿ãˆã‚‹ã€‚å½“ç„¶ã€ã‚³ãƒ³ãƒ†ãƒŠã¯å‰ã‚‚ã£ã¦èµ·å‹•ã—ã¦ãŠãå¿…è¦ãŒã‚ã‚‹ã€‚

#+caption: docker compose cp [service]:[ã‚³ãƒ”ãƒ¼å…ƒpath] [ã‚³ãƒ”ãƒ¼å…ˆpath]
#+begin_src shell
docker compose cp doc:/usr/share/nginx/html ./
#+end_src
* Tasks
** TODO [[https://qiita.com/Surgo/items/709a07d68c6eafbad267][Docker ã¨ LXC - Qiita]]
ã‚³ãƒ³ãƒ†ãƒŠã®LXCã¨ã¯ãªã«ã‹ã‚’è§£èª¬ã€‚
** TODO [[https://kayanaka.hatenablog.com/entry/2019/10/31/233902][Dockerã‚³ãƒ³ãƒ†ãƒŠã®/var/lib/docker/overlayé…ä¸‹ã®å®¹é‡ãŒå¤§ãããªã£ã¦èµ·å‹•ã§ããªã„äº‹è±¡ã«é­é‡ã—ãŸã®ã§å‘¨è¾ºçŸ¥è­˜ã‚’èª¿ã¹ãŸã€‚ - èšŠå¸³ã®ä¸­ã®æ—¥è¨˜]]
overlayã®ã‚ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã€‚äº‹è±¡ã‚’ç†è§£ã™ã‚‹ãŸã‚ã«ã¯ã€ä»•çµ„ã¿ã‚’ç†è§£ã—ã¦ã„ãªã‘ã‚Œã°ã„ã‘ãªã„ã€‚
** TODO docker ignoreã®ä»•çµ„ã¿                                     :DontKnow:
ã©ã†ã‚„ã£ã¦ignoreã—ã¦ã„ã‚‹ã®ã ã‚ã†ã‹ã€‚

#+begin_src git-permalink
https://github.com/kd-collective/buildkit/blob/37d54ebc592a54db8764911eb320d02d2260c5e6/frontend/dockerfile/dockerignore/dockerignore.go#L13
#+end_src

#+RESULTS:
#+begin_results
// ReadAll reads a .dockerignore file and returns the list of file patterns
#+end_results

- ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ãƒ‘ã‚¹ã®ã‚¹ãƒ©ã‚¤ã‚¹ã‚’å‡ºã—ã¦ã„ã‚‹ã ã‘

** TODO Dockerfileã®ãƒ‘ãƒ¼ã‚µéƒ¨åˆ†ã‚’èª­ã‚€                               :DontKnow:
ã©ã†ã‚„ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã‹èª¿ã¹ã‚‹ã€‚

ã“ã®ã¸ã‚“ã€‚

#+begin_src git-permalink
https://github.com/kd-collective/moby/blob/924edb948c2731df3b77697a8fcc85da3f6eef57/builder/dockerfile/copy.go#L1
#+end_src
** TODO [[https://www.youtube.com/watch?v=HPuvDm8IC-4][Golang UK Conf. 2016 - Liz Rice - What is a container, really? Let's write one in Go from scratch - YouTube]]
ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ã‚ãšã«[[id:7cacbaa3-3995-41cf-8b72-58d6e07468b1][Go]]ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã¨ã¯ä½•ã‹ã‚’å­¦ã¶ã€‚
** TODO [[https://gihyo.jp/book/2020/978-4-297-11837-2][ã‚¤ãƒ©ã‚¹ãƒˆã§ã‚ã‹ã‚‹ Dockerã¨Kubernetesï¼šæ›¸ç±æ¡ˆå†…ï½œæŠ€è¡“è©•è«–ç¤¾]]
ä»•çµ„ã¿ã®èª¬æ˜ã€‚
** TODO [[https://dev.classmethod.jp/articles/container-journey/][ã€Œã‚³ãƒ³ãƒ†ãƒŠã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼ã€ã€œæ˜æ—¥ã‹ã‚‰é€Ÿæ”»å§‹ã‚ã‚‹AWSã§ã®ã‚³ãƒ³ãƒ†ãƒŠå°å…¥é‹ç”¨ã€œ #cmdevio2018 | DevelopersIO]]
ç¾å®Ÿçš„ãªå°å…¥ã‚¹ãƒ†ãƒƒãƒ—ã€‚
* Archives
** DONE ã‚¿ã‚¹ã‚¯ã‚’ç°¡å˜ã«å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã‚‹
CLOSED: [2022-08-07 Sun 17:58]
[[id:1ad8c3d5-97ba-4905-be11-e6f2626127ad][Emacs]]æ‹¡å¼µã‚ã‚‹ã„ã¯ã€Makefileçš„ãªã®ã«ã¾ã¨ã‚ã‚‹ã€‚

ã‚ã‚ŠãŒã¡ãªbundle-installãªã©ã¯docker-composeã«ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆã®ã‚³ãƒãƒ³ãƒ‰ã‚’æ›¸ãã“ã¨ã§ã€å®šå½¢ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒå°‘ãªããªã£ãŸã€‚è‡ªå‹•ã§å‹•ã‹ã—ãŸã„ã‚„ã¤ã¯ã“ã‚Œã§OKã€‚ã‚³ãƒãƒ³ãƒ‰ã¯dockerã ã‹ã‚‰ç‰¹æ®Šã¨ã„ã†ã“ã¨ã¯ãªãã€ãƒ­ãƒ¼ã‚«ãƒ«ã¨åŒã˜ã‚ˆã†ã«ã‚„ã‚Œã°è‰¯ã„ã€‚
** DONE Dockerãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¿ã‚¤ãƒä¿®æ­£
CLOSED: [2022-09-19 Mon 19:10]
:LOGBOOK:
CLOCK: [2022-09-19 Mon 17:32]--[2022-09-19 Mon 17:57] =>  0:25
:END:

- https://github.com/zembutsu/docs.docker.jp/pull/402

** DONE èª¤å­—ã‚’ä¿®æ­£ã™ã‚‹
CLOSED: [2023-02-18 Sat 13:01]
[[https://docs.docker.jp/glossary.html][ç”¨èªé›† â€” Docker-docs-ja 20.10 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]] PRã‚’é€ã‚‹ã€‚

- ãªãŠã€ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ç¾¤ã¯
- ãƒ“ãƒ«ãƒ‰ï¼ˆbuildï¼‰ã¨ã¯ã€ ã‚’ä½¿ã£ã¦ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ§‹ç¯‰ã™ã‚‹å·¥ç¨‹ã§ã™ã€‚
- ã‚¤ãƒ¡ãƒ¼ã‚¸æ§‹ç¯‰ã«å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ã„ã¦ã‚ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ç¾¤ã§ã™
- ãŸã‚ã«ã€ ã‚³ãƒ”ãƒ¼ã‚ªãƒ³ãƒ©ã‚¤ãƒˆ æŠ€è¡“ã¨ ã‚’ä½¿ã„ã¾ã™
- ãƒ™ã‚¹ãƒˆãªè§£æ±ºä½œã§ã™ã€‚
- ENTRYPOINT` ã« /bin/sh ã¾
- ãƒ¦ãƒ‹ã‚ªãƒ³ãƒ»ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ã‚·ã‚¹ãƒ†ãƒ ã§çµèªã™ã‚‹ãŸã‚ã« æŠ€è¡“ã‚’ä½¿ã„
** DONE ã‚´ãƒŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã§ããªã„ã‚ˆã†ã«ã™ã‚‹
CLOSED: [2023-02-18 Sat 23:40]

ã¨ã‚Šã‚ãˆãšã€ğŸ‘‡ã§ã‚ˆã„ã€‚

#+begin_src shell
  sudo chown -R $USER:$USER .
#+end_src

ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„å±¥æ­´é–¢ä¿‚ãŒrootæ¨©é™ã§ã§ãã‚‹ã®ã§ã€å‰Šé™¤ãŒé¢å€’ï¼‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹ã®ãŒé‚ªé­”ã•ã‚Œã‚‹ã€‚

- ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
- è‡ªå‹•å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
** DONE Railsé–‹ç™º Dockerç’°å¢ƒåŒ–[9/9]
CLOSED: [2023-03-07 Tue 00:29]
:LOGBOOK:
CLOCK: [2021-12-14 Tue 22:49]--[2021-12-15 Wed 00:40] =>  1:51
:END:
ä»•äº‹ã‚’Linuxã§è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚åŸºæœ¬çš„ãªã¨ã“ã‚ã¯ã‚«ãƒãƒ¼ã—ãŸãŒã€ä¸€éƒ¨ã§ããªã„ã‚‚ã®ãŒã‚ã‚‹çŠ¶æ…‹ã€‚

*** CLOSE rails cå†…ã§æ—¥æœ¬èªãŒå«ã¾ã‚Œã‚‹ã¨å¤±æ•—ã™ã‚‹
CLOSED: [2023-03-07 Tue 00:29]
ä½•ã‹ãŠã‹ã—ããªã‚‹ã€‚
*** CLOSE Capybaraã§Javascriptã‚’ã‚ªãƒ³ã«ã—ãŸã¨ãsystem specãŒå¤±æ•—ã™ã‚‹
CLOSED: [2023-03-07 Tue 00:29]
js: trueã®ã¨ãã ã‘ã€‚
*** DONE migrationæ™‚ã«schemaã«å¤‰ãªå·®åˆ†ãŒå‡ºã‚‹
CLOSED: [2022-08-07 Sun 17:59]
DBè¨­å®šãŒãŠã‹ã—ã„ã‚ˆã†ã ã€‚
*** DONE éåŒæœŸå‡¦ç†ã®å‹•ä½œç¢ºèª
CLOSED: [2022-01-12 Wed 23:08]
:LOGBOOK:
CLOCK: [2022-01-12 Wed 23:02]--[2022-01-12 Wed 23:08] =>  0:06
CLOCK: [2022-01-12 Wed 22:32]--[2022-01-12 Wed 22:57] =>  0:25
:END:
redis, sidekiqãŒæœ¬å½“ã«å‹•ã„ã¦ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã€‚
letter openerã‚’è¦‹ã‚‹é™ã‚Šã€ã§ãã¦ãªã„ã€‚

è¿½åŠ ã—ãŸã€‚
*** DONE dockerãŒrootãƒ¦ãƒ¼ã‚¶ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹å•é¡Œ
CLOSED: [2021-12-25 Sat 23:51]
ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒrootæ¨©é™ã«ãªã£ã¦ã—ã¾ã†ã€‚
ã ã‹ã‚‰bundle installã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãã®å¾Œã¯é€šå¸¸ãƒ¦ãƒ¼ã‚¶ã§ã¯ç·¨é›†ã§ããªããªã‚‹ã€‚
é¢å€’ã ã—ã€migrationã¨ã‹æ˜ã‚‰ã‹ã«ãƒ€ãƒ¡ãªæ°—ãŒã™ã‚‹ã€‚

ç°¡å˜ãªè§£æ±ºç­–ã¨ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã£ã¦è§£æ±ºã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ãŸã€‚
*** DONE åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰
CLOSED: [2021-12-20 Mon 22:57]
[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]éƒ¨åˆ†ã‚’DockeråŒ–ã™ã‚‹ã€‚è¡¨ç¤ºã¯ã¾ã£ãŸãå•é¡Œãªã•ãã†ã€‚
ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã¡ã‚ƒã‚“ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã€‚

æœ€åˆã«ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®dockerfileã§ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã€åå‰ã‚’ä»˜ã‘ã‚‹ã€‚
#+begin_src shell
  docker build . -t app
#+end_src

å„ã‚³ãƒ³ãƒ†ãƒŠã§ã¯â†‘ã§ä½œæˆã—ãŸãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸appã‚’ç”¨ã„ã‚‹ã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ä»£ã‚ã‚Šã« ~build .~ ã§ã‚‚å¯èƒ½ã ãŒã€å„ã‚³ãƒ³ãƒ†ãƒŠãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹(ä¸­èº«ã¯åŒã˜)ã®ã§é…ãã”ã¡ã‚ƒã¤ãã€‚

#+caption: docker-compose.yml
#+begin_src yaml
  rails:
    image: app
    environment:
      RAILS_ENV: development
      REDIS_URL: redis://redis:6379
      MEMCACHED_URL: memcached://memcached:11211
      SKIP_RECAPTCHA: "true"
      MEMCACHED_HOST: memcached
      MEMCACHED: memcached:11211
      WEBPACKER_DEV_SERVER_HOST: webpack
      CHROME_HOST_NAME: http://selenium_chrome:4444/wd/hub
    ports:
      - 3000:3000
    stdin_open: true
    tty: true
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -b '0.0.0.0'"
    volumes:
      - .:/rails
      - /etc/passwd:/etc/passwd:ro # Linuxç”¨
      - /etc/group:/etc/group:ro # Linuxç”¨
    depends_on:
      - mysql

  sidekiq:
    image: app
    command: bundle exec sidekiq
    links:
      - mysql
      - redis

  webpack:
    image: app
    environment:
      NODE_ENV: development
      RAILS_ENV: development
      WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
    command: yarn watch
    volumes:
      - .:/rails
      - /etc/passwd:/etc/passwd:ro # Linuxç”¨
      - /etc/group:/etc/group:ro # Linuxç”¨
    ports:
      - 8080:8080
#+end_src

#+caption: ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ + ç«‹ã¡ä¸Šã’
#+begin_src shell
  sudo docker-compose up --build
#+end_src

#+caption: å†èµ·å‹•
#+begin_src shell
  docker-compose {service} restart
#+end_src

#+caption: railsã¯ã‚µãƒ¼ãƒ“ã‚¹åã€‚ä»¥ä¸‹ã‚’å¥½ããªã‚³ãƒãƒ³ãƒ‰ã«å¤‰ãˆã‚‹
#+begin_src shell
  docker-compose run rails bundle exec rails c
#+end_src

#+caption: bundle install
#+begin_src shell
  docker-compose run rails bundle install
#+end_src

#+caption: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
#+begin_src shell
  docker-compose run rails bundle exec bin/rspec spec/requests/top/top_spec.rb
#+end_src

#+caption: ã‚³ãƒ³ãƒ†ãƒŠå†…ã®shellã«å…¥ã£ã¦ã¿ã‚‹
#+begin_src shell
  docker-compose run rails /bin/bash
#+end_src
*** DONE docker-compose.ymlã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
CLOSED: [2021-12-20 Mon 22:57]
å€‹äººã§å¾®å¦™ã«è¨­å®šãŒç•°ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã€‚
Dockerã§ã‚„ã‚‹ã®ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã ã‘ã¨ã‹ã€[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã‚‚ã™ã¹ã¦ã‚„ã‚‹ã€ã¨ã„ã£ãŸã‚ˆã†ãªã€‚
ãã®ã¨ãã¯gitignoreã‚’æŒ‡å®šã—ãŸymlã‚’æŒ‡å®šã—ã¦èµ·å‹•ã™ã‚‹ã€‚

#+caption: å¾Œã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ä¸Šæ›¸ãã•ã‚Œã‚‹
#+begin_src shell
  docker-compose -f docker-compose.yml -f docker-compose-app.override.yml up
#+end_src

ã‚‚ã¡ã‚ã‚“ä¸€èˆ¬æ€§ãŒã‚ã‚‹ãªã‚‰gitç®¡ç†ã«ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã ãŒã€äººã«ã‚ˆã£ã¦æ§‹æˆãŒç•°ãªã‚‹ã®ã§ä»•æ–¹ãªã„ã€‚ã¨ãã«Macã ã¨é€Ÿåº¦ã«å•é¡Œã‚ã‚‹ãŸã‚ã€[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã¯[[id:1658782a-d331-464b-9fd7-1f8233b8b7f8][Docker]]ã§ç«‹ã¡ä¸Šã’ãªã„ã®ãŒå¤šæ•°æ´¾ã€‚

[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã‚µãƒ¼ãƒ“ã‚¹ã‚’override.ymlã«ã€ãã‚Œä»¥å¤–ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚µãƒ¼ãƒ“ã‚¹ã‚’docker-compose.ymlã«æ›¸ã„ã¦ã‚‹å ´åˆã¯ã€æ˜ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
#+caption: overrideã—ãŸã¨ãã®bundle installã€‚-fæŒ‡å®šãŒå¿…è¦ã€‚
#+begin_src shell
  docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run rails bundle install
#+end_src

docker-compose runã™ã‚‹å ´åˆã‚‚-fã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€‚
runã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’æ–°ã—ãä½œã‚‹â€¦ã¤ã¾ã‚Šymlã‚’è¦‹ã¦ã‚‹ã®ã§ã€æŒ‡å®šãŒå¿…è¦ãªã®ã§ã‚ã‚‹ã€‚

#+caption: model specã‚’å®Ÿè¡Œã™ã‚‹
#+begin_src shell
  docker-compose -f docker-compose.yml -f docker-compose-app.override.yml exec rails bundle exec rspec --options ./.rspec ./spec/models/user_spec.rb
#+end_src

â†‘ã„ã¡ã„ã¡ã‚¯ã‚½é•·ã„ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã®ã¯è‹¦ç—›ãªã®ã§ã€shellã«å…¥ã£ã¦ä½œæ¥­ã™ã‚‹ã¨æ¥½ã€‚
#+caption: shellã«å…¥ã‚‹
#+begin_src shell
  sudo docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run rails /bin/sh
#+end_src
*** DONE DBã®GUIãƒ„ãƒ¼ãƒ«ã¨ã®æ¥ç¶š
CLOSED: [2021-12-17 Fri 20:58]
Linuxç”¨ã®sqlectronãŒã‚ˆã•ãã†ã€‚ãŒã€ä¸Šæ‰‹ã[[id:7dab097c-60ba-43b9-949f-c58bf3151aa8][MySQL]]ã¨æ¥ç¶šã§ããªã„
docker-compose.ymlã§ ~MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'~ ã‚’è¿½åŠ ã™ã‚‹ã¨å…¥ã‚Œã‚‹ã‚ˆã†ã«ã€‚
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¦ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã€‚

ã ãŒã“ã®sqlectronã€è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®ç·¨é›†ãŒã§ããªã„ã®ã§å€¤ã‚’æ›¸ãæ›ãˆã‚‹ã®ã«éå¸¸ã«ä¸ä¾¿ã€‚
åˆ¥ã®ã‚’ä½¿ã£ãŸã»ã†ãŒã„ã„ã ã‚ã†ã€‚
*** DONE yarnãŒã§ãã¦ãªã„
CLOSED: [2021-12-17 Fri 20:58]
- ãƒãƒ¼ãƒˆã‚’åˆã‚ã›ã‚‹
- webpack.config.jsã«hostã‚’åŠ ãˆã‚‹

ãŒå¿…è¦ã€‚

#+caption: docker-compose.yml
#+begin_src yaml
  webpack:
    build: .
    environment:
      NODE_ENV: development
      RAILS_ENV: development
      WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
    command: yarn watch
    volumes:
      - .:/rails
    ports:
      - 8080:8080
    depends_on:
      - rails
#+end_src

ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã®ã‚’ç¢ºèªã€‚
hostã‚’åŠ ãˆã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚
#+caption: webpack.config.js
#+begin_src json
  devServer: {
    contentBase: path.join(__dirname, 'app/assets/javascripts'),
    allowedHosts: ['.lvh.me'],
    host: '0.0.0.0',
  },
#+end_src
** DONE [[https://tatsu-zine.com/books/linux-container-book][Linux Container Bookã€å§”è¨—ã€‘ - é”äººå‡ºç‰ˆä¼š]]
CLOSED: [2023-03-12 Sun 23:35]
:LOGBOOK:
CLOCK: [2023-03-12 Sun 00:42]--[2023-03-12 Sun 01:07] =>  0:25
CLOCK: [2023-03-11 Sat 14:24]--[2023-03-11 Sat 14:49] =>  0:25
CLOCK: [2023-03-11 Sat 13:18]--[2023-03-11 Sat 13:43] =>  0:25
CLOCK: [2023-03-07 Tue 00:29]--[2023-03-07 Tue 00:54] =>  0:25
:END:

ã‚³ãƒ³ãƒ†ãƒŠã®è§£èª¬ã€‚å¾ŒåŠã¯ç†è§£ã§ãã¦ãªã„ã€‚ã¾ãŸå¿…è¦ãªã¨ãã«èª­ã‚€ã€‚

- ~$ sudo mount --bind dir1 dir2~ ã¿ãŸã„ã«ã€ãƒã‚¤ãƒ³ãƒ‰ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ãŒå­˜åœ¨ã™ã‚‹
- Namespace(åå‰ç©ºé–“)ã¯ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠã®éš”é›¢ã•ã‚ŒãŸç©ºé–“ã‚’ä½œã‚Šå‡ºã™ã€‚ç‹¬ç«‹ã•ã›ãŸã„ãƒªã‚½ãƒ¼ã‚¹ã«ã‚ˆã£ã¦ã„ãã¤ã‹ã®æ©Ÿèƒ½ãŒã‚ã‚‹
- Dockerã®åˆæœŸã¯ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ããªã‹ã£ãŸ
- ã‚«ãƒ¼ãƒãƒ«ã§setnsãŒã™ã¹ã¦ã®Namespaceã«å¯¾ã—ã¦å‹•ä½œã™ã‚‹ã‚ˆã†ã«ãªã£ã¦ã‹ã‚‰ã€docker execã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸ
- Mount Namespaceã¯[[id:7a81eb7c-8e2b-400a-b01a-8fa597ea527a][Linux]]ã‚«ãƒ¼ãƒãƒ«ã«æœ€åˆã«å®Ÿè£…ã•ã‚ŒãŸNamespace(2002å¹´)
  - ã‚ã‚‹Namespaceã”ã¨ã«ç•°ãªã‚‹ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã®ä¸€è¦§ã‚’æŒã¦ã‚‹
  - ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒã‚¦ãƒ³ãƒˆæ“ä½œã‚’è¡Œã£ãŸå ´åˆã§ã‚‚ã€ãã®ãƒã‚¦ãƒ³ãƒˆã¯ãƒ›ã‚¹ãƒˆOSã‚„ä»–ã®ã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰è¦‹ãˆãªã„ã‚ˆã†ã«ã§ãã‚‹
  - ~$ cat /proc/self/mounts~ ã§ãƒã‚¦ãƒ³ãƒˆçŠ¶æ³ã‚’ç¢ºèªã§ãã‚‹
  - ãƒã‚¦ãƒ³ãƒˆãƒ—ãƒ­ãƒ‘ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    - ãƒã‚¦ãƒ³ãƒˆãŒã»ã‹ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§åæ˜ ã•ã‚Œã‚‹ã‹ã€åæ˜ ã•ã‚Œãªã„ã‹

* References
** [[https://qiita.com/hichika/items/9b96634d471246359e66][å€‹äººçš„docker composeãŠã™ã™ã‚tips6é¸ - Qiita]]
tipsã€‚

- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
** [[https://sunday-morning.app/posts/2020-05-06-extension-fields-docker-compose][Extension fieldsã‚’ä½¿ã£ã¦docker-composeã®ã‚³ãƒ³ãƒ†ãƒŠè¨­å®šã‚’å…±é€šåŒ–ã™ã‚‹]]
å…±é€šåŒ–è¨­å®šã€‚

- ~x-~ ã‚’ã‚µãƒ¼ãƒ“ã‚¹åã«ã¤ã‘ã‚‹ã¨ç„¡è¦–ã•ã‚Œã‚‹

** [[https://techracho.bpsinc.jp/hachi8833/2020_02_07/87447][docker-compose.ymlã®ä¸­ã§å€¤ã‚’ä½¿ã„å›ã™æ–¹æ³•ï½œTechRacho by BPSæ ªå¼ä¼šç¤¾]]
ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã®ä½¿ã„æ–¹ã€‚
** [[https://aton-kish.github.io/blog/post/2020/10/04/docker-compose-rm/][Docker Composeã®ä¸€éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã ã‘Up/Downã™ã‚‹ | Nota]]
æ–¹æ³•ã€‚
** [[https://github.com/Haxxnet/Compose-Examples][Haxxnet/Compose-Examples: Various Docker Compose examples of selfhosted FOSS and proprietary projects.]]
docker-composeé›†ã€‚
** [[https://qiita.com/okdyy75/items/a707989bd6bdd7bdb490][GitHub Actionã‚’ä½¿ã£ã¦è‡ªå‰Dockerå†…ã§è‡ªå‹•ãƒ†ã‚¹ãƒˆ - Qiita]]
github actionsã§docker-composeã‚’ä½¿ã†ä¾‹ã€‚
** [[https://containers.gitbook.io/build-containers-the-hard-way/][Build Containers the Hard Way (WIP) - Build Containers the Hard Way]]
ã‚³ãƒ³ãƒ†ãƒŠæŠ€è¡“ã®ä½ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ä»•çµ„ã¿ã€‚
** [[https://github.com/docker-slim/docker-slim][docker-slim/docker-slim: DockerSlim (docker-slim): Don't change anything in your Docker container image and minify it by up to 30x (and for compiled languages even more) making it secure too! (free and open source)]]
dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’åˆ†æã—ã¦ã‚¹ãƒªãƒ ã«ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã€‚
** [[https://github.com/wagoodman/dive][wagoodman/dive: A tool for exploring each layer in a docker image]]
dockerã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã”ã¨ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èª¿æŸ»ã§ãã‚‹ãƒ„ãƒ¼ãƒ«ã€‚
** [[https://www.redhat.com/ja/topics/containers/what-is-docker][Docker ã¨ã¯ - è§£èª¬ã€ãƒ¡ãƒªãƒƒãƒˆã€ã§ãã‚‹ã“ã¨ | Red Hat]]
ã‚ã‹ã‚Šã‚„ã™ã„æ¦‚è¦ã€‚
** [[https://ja.wikipedia.org/wiki/Docker][Docker - Wikipedia]]
ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã®ã‚ã‹ã‚Šã‚„ã™ã„èª¬æ˜ã€‚
** [[https://github.com/phusion/passenger-docker][phusion/passenger-docker: Docker base images for Ruby, Python, Node.js and Meteor web apps]]
Webé–‹ç™ºç”¨ã®æ‰±ã„ã‚„ã™ã„Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚
** [[https://12factor.net/][The Twelve-Factor App]]
SaaSé–‹ç™ºã®æ–¹æ³•è«–ã€‚
æ—¥æœ¬èªè¨³ã‚‚ã‚ã£ãŸã€‚[[https://12factor.net/ja/][The Twelve-Factor App ï¼ˆæ—¥æœ¬èªè¨³ï¼‰]]
** [[https://docs.docker.jp/pdf-download.html][Docker ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ—¥æœ¬èªç‰ˆ PDF ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â€” Docker-docs-ja 19.03 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]]
Dockerã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚
** [[https://kotaroooo0-dev.hatenablog.com/entry/2020/08/06/012316][ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãŸã‚ã«Dockerãƒ“ãƒ«ãƒ‰ã§ä¸­é–“ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¿ã‚°ä»˜ã‘ã—ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«Pushã™ã‚‹ - ğŸ¤–]]
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ›¸ãæ–¹ã€‚
** [[https://www.forcia.com/blog/002273.html][ç¤¾å†…pã®Dockerfileã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å…¬é–‹ã—ã¾ã™â”‚FORCIA CUBEâ”‚ãƒ•ã‚©ãƒ«ã‚·ã‚¢æ ªå¼ä¼šç¤¾]]
CLOSED: [2022-02-11 Fri 18:27]
éå¸¸ã«è©³ã—ã„æƒ…å ±ã€‚
** [[https://qiita.com/tatsurou313/items/ad86da1bb9e8e570b6fa][BuildKitã«ã‚ˆã‚ŠDockerã¨Docker Composeã§å¤–éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã£ãŸåŠ¹ç‡çš„ãªãƒ“ãƒ«ãƒ‰ã‚’ã™ã‚‹æ–¹æ³• - Qiita]]
BuildKitã®è§£èª¬ã€‚
** [[https://www.slideshare.net/zembutsu/dockerfile-bestpractices-19-and-advice][Dockerfileã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã®Best Practice 2019å¹´ç‰ˆ]]
ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã€‚
