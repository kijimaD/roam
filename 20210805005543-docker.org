:PROPERTIES:
:ID:       1658782a-d331-464b-9fd7-1f8233b8b7f8
:END:
#+title: Docker

* æ¦‚è¦
Dockerã¯ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å„ªã‚ŒãŸä»®æƒ³ç’°å¢ƒã‚’ä½œã‚‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€‚
å¾—ã‚‰ã‚Œã‚‹å¯æ¬æ€§ã«ã‚ˆã£ã¦ã€ä½œæˆã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é–‹ç™ºã«ãŠã‘ã‚‹å„ã‚¹ãƒ†ãƒ¼ã‚¸(ãƒ†ã‚¹ãƒˆã€ãƒ“ãƒ«ãƒ‰ã€ãƒªãƒªãƒ¼ã‚¹â€¦)ã§é©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ãã®æ„å‘³ã§[[id:eaf6ed04-7927-4a16-ba94-fbb9f6e76166][CI]], [[id:2c4cb3a7-7a8a-4a3b-88c2-2c5e69515764][CD]]ã®åŸºç¤çš„ãªæŠ€è¡“ã¨ãªã£ã¦ã„ã‚‹ã€‚
* Memo
** å†èµ·å‹•
sudo service docker restart
** ã‚³ãƒ³ãƒ†ãƒŠæƒé™¤é–¢ä¿‚
[[https://qiita.com/shisama/items/48e2eaf1dc356568b0d7][ã‚³ãƒãƒ³ãƒ‰ã§Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤ã€ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‰Šé™¤ã‚’ã™ã‚‹ - Qiita]]

#+begin_src shell
docker stop $(docker ps -q) # å…¨ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
docker rm $(docker ps -q -a) # å…¨ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
docker rmi $(docker images -q) # å…¨ã‚¤ãƒ¡ãƒ¼ã‚¸å‰Šé™¤:
#+end_src
** ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒã¨ã‚“ã§ã‚‚ãªã„ã“ã¨ã«ãªã£ã¦ã„ãŸã¨ã
ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒã»ã¼100ï¼…ã«ãªã£ã¦ã„ãŸã€‚å ã‚ã¦ã„ã‚‹ã»ã¨ã‚“ã©ã¯Dockeré–¢ä¿‚ã®ã‚ˆã†ã ã£ãŸã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã—ã¦ãŸãŒã€ã»ã‹ã«ã‚‚è‰²ã€…ã‚ã‚‹ã‚ˆã†ã€‚

å°‚ç”¨ã®ãƒšãƒ¼ã‚¸ãŒã‚ã‚‹ã€‚
https://docs.docker.com/config/pruning/

éå¸¸ã«å¤šãã®ã‚´ãƒŸãŒã‚ã‚Šãã†ã ã£ãŸã®ã§ã€å¤šå°‘å†pullã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ã‚’è¨±å®¹ã—ã¦ã™ã¹ã¦å‰Šé™¤ã™ã‚‹ã“ã¨ã«ã—ãŸã€‚
#+caption: æ‰‹ã£å–ã‚Šæ—©ãã™ã¹ã¦æ¶ˆã™ã€‚è­¦å‘ŠãŒå‡ºã‚‹
#+begin_src shell
docker system prune
#+end_src

ã‚´ãƒªã‚´ãƒªbuildã—ã¦è©¦ã—ã¦ã„ã‚‹ã¨ãã¯ã€æ°—ã‚’ã¤ã‘ãŸã»ã†ãŒã‚ˆã•ãã†ã€‚

ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã ã‘è¡Œã†ã€‚ã“ã®å ´åˆãŒå¤šãã†ã€‚
#+begin_src shell
docker builder prune
#+end_src
** entrypoint.sh
å…¬å¼Docker Imageã§ã‚ˆãç”¨ã„ã‚‰ã‚Œã‚‹ã€ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•æ™‚ã«å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚
å…¬å¼ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã¾ã¾ã§ã€åˆå›èµ·å‹•æ™‚ã«å®Ÿè¡Œã—ãŸã„ãƒ•ãƒƒã‚¯ã¨ã—ã¦è¨˜è¿°ã§ãã‚‹ã€‚

ä¾‹(Dockerfile): [[https://github.com/tzumby/rails-on-kubernetes/blob/master/Dockerfile][rails-on-kubernetes/Dockerfile at master Â· tzumby/rails-on-kubernetes]]
#+caption: Dockerfileã®æœ«å°¾ã§å–ã‚Šè¾¼ã‚€
#+begin_src shell
ADD . /myapp

COPY docker-entrypoint.sh /usr/local/bin

ENTRYPOINT ["docker-entrypoint.sh"]
#+end_src

ä¾‹(entrypoint.sh): [[https://github.com/tzumby/rails-on-kubernetes/blob/master/docker-entrypoint.sh][rails-on-kubernetes/docker-entrypoint.sh at master Â· tzumby/rails-on-kubernetes]]
#+caption: entrypoint.sh $@ã¯å¼•æ•°
#+begin_src shell
#!/bin/sh

set -e

if [ -f tmp/pids/server.pid ]; then
  rm tmp/pids/server.pid
fi

echo "Waiting for Postgres to start..."
while ! nc -z postgres 5432; do sleep 0.1; done
echo "Postgres is up"

echo "Waiting for Redis to start..."
while ! nc -z redis 6379; do sleep 0.1; done
echo "Redis is up - execuring command"

exec bundle exec "$@"
#+end_src
** docker-composeã¨docker
docker-composeã¯è‡ªå‹•ã§ã‚¿ã‚°åã‚’ã¤ã‘ã¦ãã‚ŒãŸã‚Šã€ãƒã‚¦ãƒ³ãƒˆã—ã¦ãã‚ŒãŸã‚Šã€dockerã‚³ãƒãƒ³ãƒ‰ã‚ˆã‚Šã‚„ã‚„ã“ã—ããªã‚Šã«ãã„ã€‚
å˜ã«é–‹ç™ºç’°å¢ƒã¨ã—ã¦ä½¿ã£ã¦ã„ã‚‹ã ã‘ã§ã¯ã€ã»ã¨ã‚“ã©docker-composeã§äº‹è¶³ã‚Šã‚‹ã€‚
ãŒã€docker-composeã¸ä¾å­˜ã—ã¦ã„ã‚‹ã¨ã„ã†ã“ã¨ã§ã€docker-composeé–¢ä¿‚ãªã„åˆ¥ã®æ–‡è„ˆã§ä½¿ãŠã†ã¨ã™ã‚‹ã¨é€”ç«¯ã«å‹•ã‹ãªããªã‚‹ã€‚æœ¬è³ªçš„ã«docker-composeã¯ã‚³ãƒ³ãƒ†ãƒŠé–“ã®é–¢ä¿‚æ€§ã‚’è¨˜è¿°ã—ã¦ã„ã‚‹ã ã‘ã§ã€ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã‚’è¡¨ç¾ã—ã¦ã„ã‚‹ã‚ã‘ã§ã¯ãªã„ã€‚

æœ¬å½“ã«dockerã‚³ãƒ³ãƒ†ãƒŠã¨ã—ã¦ã®æ­£ã—ã„ä½¿ã„æ–¹ã‚’ã—ã¦ã„ã‚‹ã‹ãƒ†ã‚¹ãƒˆã™ã‚‹ã«ã¯ã€ã‚³ãƒ³ãƒ†ãƒŠã‚’è¤‡æ•°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚„CIã§åˆ©ç”¨ã—ã¦ã¿ã‚‹ã®ãŒã‚ˆã„ã€‚åŒã˜æµã‚Œã§ç°¡å˜ã«ã§ããŸã®ãªã‚‰æ­£ã—ã„ã€‚ç°¡å˜ã«ã§ããªã„ãªã‚‰ä½•ã‹ãŒé–“é•ã£ã¦ã„ã‚‹ã€‚
** ã‚ˆãä½¿ã†dockerã‚ªãƒ—ã‚·ãƒ§ãƒ³
#+caption: ä¾‹
#+begin_src shell
docker run --rm -v "$PWD/":/roam -w /roam ghcr.io/kijimad/roam:master sh deploy.sh
#+end_src

~--rm~ : ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œå¾Œã«ã‚³ãƒ³ãƒ†ãƒŠã‚’å‰Šé™¤ã™ã‚‹
~-v~: ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã€‚å·¦ãŒãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã€å³ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã€‚

#+caption: -itã®æ„å‘³: å¯¾è©±ãƒ¢ãƒ¼ãƒ‰
#+begin_src shell
docker run --rm -it ghcr.io/kijimad/roam:master
#+end_src
-it ã¯ttyã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªã‚·ã‚§ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚ã¤ã‘ãªã„ã¨ã€ä¸€ç¬ã§æ¶ˆãˆã‚‹ã€‚
** buildkitã‚’ã‚ªãƒ³ã«ã™ã‚‹
ç’°å¢ƒå¤‰æ•°ã‚’ã‚ªãƒ³ã«ã™ã‚‹ã“ã¨ã§ã€æ–°ã—ã„æ©Ÿèƒ½ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
#+caption: shell
#+begin_src shell
  export COMPOSE_DOCKER_CLI_BUILD=1
  export DOCKER_BUILDKIT=1
  docker build .
#+end_src
** docker-composeã§ãƒã‚¦ãƒ³ãƒˆã—ãŸã¨ãã«node_modulesãŒæ¶ˆãˆã‚‹å•é¡Œ
1. npm install ã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
2. ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒã‚¦ãƒ³ãƒˆ
3. ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãªã„node_modulesã¯æ¶ˆãˆã‚‹
4. ã‚¨ãƒ©ãƒ¼

ãªã®ã§ã€node_modulesã‚‚ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã€‚

#+caption: docker-compose.yml
#+begin_export yaml
volumes:
  - .:/contaier # ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã™ã¹ã¦ãƒã‚¦ãƒ³ãƒˆã€‚ãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã«ãªã„ã®ã¯æ¶ˆãˆã‚‹
  - /container/node_modules
#+end_export

#+caption: dockerã‚³ãƒãƒ³ãƒ‰ã®å ´åˆã€‚-v ã‚’2ã¤ã§æŒ‡å®šã™ã‚‹
#+begin_src shell
docker run --rm -v "$PWD":/roam -v /roam/node_modules ghcr.io/kijimad/roam_lint:master make textlint
#+end_src

https://rara-world.com/dockerfile-node-modules/ ã«æ›¸ã„ã¦ã‚ã£ãŸã€‚
** dockleã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
dockleã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒã‚§ãƒƒã‚¯ã§ãã‚‹ã€‚
[[https://github.com/goodwithtech/dockle][goodwithtech/dockle: Container Image Linter for Security, Helping build the Best-Practice Docker Image, Easy to start]]

è‡ªå‰ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã«ã‹ã‘ã‚‹ã¨ãŸãã•ã‚“è¦‹ã¤ã‹ã£ãŸã€‚
#+caption: å®Ÿè¡Œã—ã¦ã¿ãŸ
#+begin_src shell
$ dockle ghcr.io/kijimad/roam:4f3296b
FATAL   - DKL-DI-0001: Avoid sudo command
        ,* Avoid sudo in container : /bin/sh -c yum -y update &&     yum -y install         yum-utils
      gcc         gcc-c++         make         openssl-devel         openssh-server         readline
nuplot
WARN    - CIS-DI-0001: Create a user for the container
        ,* Last user should not be root
INFO    - CIS-DI-0005: Enable Content trust for Docker
        ,* export DOCKER_CONTENT_TRUST=1 before docker pull/build
INFO    - CIS-DI-0006: Add HEALTHCHECK instruction to the container image
        ,* not found HEALTHCHECK statement
INFO    - CIS-DI-0008: Confirm safety of setuid/setgid files
        ,* setgid file: g--x--x--x usr/libexec/openssh/ssh-keysign
        ,* setuid file: urwxr-xr-x usr/sbin/pam_timestamp_check
        ,* setuid file: urwxr-xr-x usr/bin/mount
        ,* setgid file: grwx--x--x usr/libexec/utempter/utempter
        ,* setuid file: urwxr-xr-x usr/bin/chage
        ,* setuid file: urwxr-xr-x usr/bin/su
        ,* setuid file: urwxr-x--- usr/libexec/dbus-1/dbus-daemon-launch-helper
        ,* setuid file: urwxr-xr-x usr/sbin/unix_chkpwd
        ,* setuid file: u--x--x--x usr/bin/sudo
        ,* setgid file: g--x--x--x usr/bin/ssh-agent
        ,* setuid file: urwxr-xr-x usr/bin/umount
        ,* setuid file: urwxr-xr-x usr/bin/gpasswd
        ,* setuid file: urwxr-xr-x usr/bin/newgrp
        ,* setgid file: grwxr-xr-x usr/bin/write
INFO    - DKL-LI-0003: Only put necessary files
        ,* Suspicious directory : roam/.git
        ,* Suspicious directory : usr/local/plugins/ruby-build/.git
        ,* Suspicious directory : usr/local/plugins/ruby-build/test/tmp
        ,* Suspicious directory : tmp
        ,* unnecessary file : roam/docker-compose.yml
        ,* unnecessary file : roam/Dockerfile
#+end_src
** pushã‚¹ã‚¯ãƒªãƒ—ãƒˆ
[[https://www.amazon.co.jp/dp/B01N0SS6NF/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1][Amazon.co.jp: Deploying Rails with Docker, Kubernetes and ECS (English Edition) eBook : AcuÃ±a, Pablo: Foreign Language Books]] ã«è¼‰ã£ã¦ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆã€‚æ›¸ã„ã¦ãƒªãƒã‚¸ãƒˆãƒªã«å…¥ã‚Œã¦ãŠãã¨ã‚¹ãƒ ãƒ¼ã‚ºã«ãƒ“ãƒ«ãƒ‰ã‚„ãƒ—ãƒƒã‚·ãƒ¥ãŒã§ãã‚‹ã€‚
ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ»ãƒ¦ãƒ¼ã‚¶åãƒ»ãƒªãƒã‚¸ãƒˆãƒªã‚’é©å®œå¤‰ãˆã‚‹ã€‚
#+begin_src shell
  #!/bin/sh

  LC=$(git rev-parse --short HEAD)
  docker build -t ghcr.io/kijimad/webapp:${LC} .
  docker push ghcr.io/kijimad/webapp:${LC}
#+end_src
** å®Ÿè¡Œå¾Œã«ã‚³ãƒ³ãƒ†ãƒŠå‰Šé™¤
docker run ã™ã‚‹ã¨ã‚³ãƒ³ãƒ†ãƒŠå†…ã«å…¥ã‚Œã‚‹ãŒã€ä½œã£ãŸã‚³ãƒ³ãƒ†ãƒŠã¯ãã®ã¾ã¾ã«ãªã‚‹ã€‚
å®Ÿè¡Œå¾Œã«å‰Šé™¤ã—ã¦æ¬²ã—ã„å ´åˆã¯ã€ ~docker --rm webapp /bin/sh~ ãªã©rmã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä½¿ã†ã€‚
** ã‚³ãƒ³ãƒ†ãƒŠé–“ã®æ¥ç¶šã¯ã‚µãƒ¼ãƒ“ã‚¹åã‚’ç”¨ã„ã‚‹
ã‚³ãƒ³ãƒ†ãƒŠé–“ã®æ¥ç¶šã‚’ã—ã‚ˆã†ã¨ã—ã¦ã€ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸã€‚
#+caption: sidekiq -> redisã¸æ¥ç¶šã—ãŸã„
#+begin_quote
Error connecting to Redis on 127.0.0.1:6379 (Errno::ECONNREFUSED)
#+end_quote

127.0...ã¨ã‚ã‚‹ã“ã¨ã‹ã‚‰ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¦‹ã«è¡Œã£ã¦ã‚‹ã€‚
ã‚³ãƒ³ãƒ†ãƒŠé–“ã§ã®é€šä¿¡ã«ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹åã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

#+caption: redis://redis:6379/15
#+begin_export yaml
  worker:
    build: .
    command: bundle exec sidekiq
    environment:
      REDIS_URL: redis://redis:6379/15 ï¼ƒ<---åˆ¥ã®redisã‚³ãƒ³ãƒ†ãƒŠã¸ã®æ¥ç¶š
    volumes:
      - .:/app
    links:
      - mysql
      - redis
#+end_export
** rootãƒ¦ãƒ¼ã‚¶ã§ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆã—ãªã„ã‚ˆã†ã«ã™ã‚‹
Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨ã€ownerãŒrootã«ãªã‚Šç·¨é›†ã‚„å‰Šé™¤ãŒã§ããšé¢å€’ã€‚
Dockerã®å†…éƒ¨ã§ã¯ãƒ¦ãƒ¼ã‚¶id(uid)ã‚„ã‚°ãƒ«ãƒ¼ãƒ—id(gid)ãŒãƒ›ã‚¹ãƒˆã¨ç•°ãªã‚‹ã€‚idãŒãƒ›ã‚¹ãƒˆãƒã‚·ãƒ³ã¨åˆã‚ãªã„ãŸã‚rootã¨ã—ã¦å®Ÿè¡Œã•ã‚ŒãŸã“ã¨ã«ãªã‚‹ã€ã‚ˆã†ã€‚

å®‰æ˜“ãªè§£æ±ºç­–ã¨ã—ã¦ã¯ã€æ¨©é™ã‚’ãƒ›ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ã«å¤‰æ›´ã™ã‚Œã°å•é¡Œãªã„ã€‚
ã¨ã¯ã„ãˆã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ã‚µãƒ¼ãƒ“ã‚¹ãŒæ–°ã—ããƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ãŸã³(ãŸã¨ãˆã°ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ)ã«å®Ÿè¡Œã™ã‚‹ã®ã¯é¢å€’ã€‚
[[https://docs.docker.com/samples/rails/][If you are running Docker on Linux, the files rails new created are owned by root.]]
#+caption: æ¨©é™å¤‰æ›´
#+begin_src shell
  sudo chown -R $USER:$USER .
#+end_src

è§£æ±ºç­–ã¨ã—ã¦ã¯ã„ãã¤ã‹ç¨®é¡ãŒã‚ã‚‹ã‚ˆã†ãªã®ã ãŒã€ã¨ã‚Šã‚ãˆãšã§ããŸã€‚
ã‚µãƒ¼ãƒ“ã‚¹ã®volumesã«ãƒ¦ãƒ¼ã‚¶æƒ…å ±ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ã€‚:roã¯èª­ã¿å–ã‚Šå°‚ç”¨(read onlyã‹)ã€‚
ã“ã‚Œã§idã®ç…§åˆå…ƒãŒãƒ›ã‚¹ãƒˆã¨åŒã˜ã«ãªã‚‹ã€‚

#+caption: docker-compose.yml
#+begin_src yaml
  volumes:
    - .:/rails
#+end_src

ã‚ã¨ã¯idã‚’ç’°å¢ƒå¤‰æ•°çµŒç”±ã§æ¸¡ã›ã°ã€ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚‚ãƒ›ã‚¹ãƒˆã®ãƒ¦ãƒ¼ã‚¶ãŒå®Ÿè¡Œã—ãŸã“ã¨ã«ãªã‚‹ã€‚
#+begin_src shell
  sudo docker run -u "$(id -u $USER):$(id -g $USER)" rails /bin/sh
  sudo docker-compose run -u "$(id -u $USER):$(id -g $USER)" rails /bin/sh
#+end_src

overrideãŒã‚ã‚‹å ´åˆã€ã“ã®ã‚ˆã†ã«ãªã‚‹(é•·ã™ã)ã€‚
#+begin_src shell
sudo docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run -u "$(id -u $USER):$(id -g $USER)" rails /bin/sh
#+end_src

[[https://blog.amedama.jp/entry/docker-container-host-same-user][Docker ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ Docker ãƒ›ã‚¹ãƒˆã¨åŒã˜ãƒ¦ãƒ¼ã‚¶ã‚’ä½¿ã† - CUBE SUGAR CONTAINER]]
** Docker Hub
Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆä¸Šã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã‚¹ãƒšãƒ¼ã‚¹ã€‚
å€‹åˆ¥ã«ãƒ“ãƒ«ãƒ‰ã—ãªãã¦ã‚ˆããªã‚‹ãŸã‚Dockeré–¢é€£ã®å…¨å·¥ç¨‹ãŒé«˜é€ŸåŒ–ã™ã‚‹ã€‚ãƒ†ã‚¹ãƒˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã€ãƒ‡ãƒ—ãƒ­ã‚¤â€¦ã€‚
** ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã¨ã¯
ã‚µã‚¤ãƒˆã‚’Dockerãƒ‡ãƒ—ãƒ­ã‚¤ã«ã—ãŸã‚Šã€CIã‚’Dockerã§è¡Œã†ã¨ãã€‚
è¤‡æ•°ã®ç’°å¢ƒãŒé–¢ä¿‚ã™ã‚‹å ´åˆã€ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ããŸã‚é«˜é€ŸåŒ–ã§ãã‚‹ã€‚

- Linuxé–¢é€£ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
- [[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]]é–¢é€£ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
- nodeé–¢é€£ã®ã‚¤ãƒ¡ãƒ¼ã‚¸
- [[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã‚¢ãƒ—ãƒªã®ã‚¤ãƒ¡ãƒ¼ã‚¸

ã®ã‚ˆã†ã«ã€‚
Linux â†’ [[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]] + node â†’ [[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]] ã¨ã„ã†ä¾å­˜é–¢ä¿‚ã«ãªã‚‹ã€‚
** Dockerfileã¯ä½•ã‹
Dockrfileã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½œã‚‹ã€‚(image build)
docker-compose upã¯â†‘ã§ä½œã‚‰ã‚ŒãŸã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å…ƒã«ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚Šèµ·å‹•ã¾ã§ã™ã‚‹ã€‚ãã®ãªã‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ°ã‚‰ã›ã¦é–‹ç™ºã™ã‚‹ã€‚

imageæ§‹ç¯‰ â†’ ã‚³ãƒ³ãƒ†ãƒŠæ§‹ç¯‰ â†’ ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹• ã¨ã„ã†æµã‚Œã€‚

ã‚³ãƒ³ãƒ†ãƒŠã®ä½œã‚Šæ–¹ã«ã¯2ç¨®é¡ã‚ã‚‹ã€‚
- è‡ªä½œã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‚ã®ã¯â†‘Dockerfileã§ä½œã‚‹
- æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠ([[id:7dab097c-60ba-43b9-949f-c58bf3151aa8][MySQL]]ã¨ã‹)ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
** ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã™ã‚‹
ã‚³ãƒ³ãƒ†ãƒŠå†…éƒ¨ã§å®Ÿè¡Œã—ãŸã„ã‚³ãƒãƒ³ãƒ‰ãŒã‚ã‚‹ã¨ãã«ã‚„ã‚ŠãŸã„ã“ã¨ã€ãŸã¨ãˆã°[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã ã¨ã€gemfileãŒæ–°ã—ããªã£ãŸã¨ãã«bundle installã—ãŸã„ã€‚

runã¯æ–°ã—ãã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆã—ã€å†…éƒ¨ã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ã‚µãƒ¼ãƒ“ã‚¹åã¯docker-compose.ymlã‹ã‚‰å–ã£ã¦ã„ã‚‹ã€‚ã¤ã¾ã‚Šç«‹ã¡ä¸ŠãŒã£ã¦ã„ã‚‹ã‚³ãƒ³ãƒ†ãƒŠåã¯é–¢ä¿‚ãªã„ã®ã«æ³¨æ„ã€‚ä½•ã‚‚æŒ‡å®šã—ã¦ãªã„å ´åˆã€docker-compose.ymlã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹åã‚’æ±ºå®šã™ã‚‹ã€‚ã»ã‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã«ã¯-fã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€‚å¤–éƒ¨ã§æ°¸ç¶šåŒ–ã•ã‚Œã‚‹â€¦volumeãŒæŒ‡å®šã•ã‚Œã¦ã‚‹ã‚ˆã†ãªå‡¦ç†(bundle install)ã¨ã‹ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢ä¿‚ã¯ã„ã„ã®ã ãŒã€ãã®ä»–ã¯æ°¸ç¶šåŒ–ã•ã‚Œãªã„ã®ã§æ³¨æ„ã€‚

#+caption: run
#+begin_src shell
  docker-compose run {ã‚µãƒ¼ãƒ“ã‚¹å} {shellã‚³ãƒãƒ³ãƒ‰}
#+end_src

execã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’å†åˆ©ç”¨ã—ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã€‚é«˜é€Ÿã€‚
#+caption: exec
#+begin_src shell
  docker-compose exec {ã‚µãƒ¼ãƒ“ã‚¹å} {shellã‚³ãƒãƒ³ãƒ‰}
#+end_src
** ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã‚ãšã«buildã™ã‚‹
#+begin_src shell
  docker-compose build --no-cache
#+end_src
** ç«‹ã¡ä¸Šã’ã¨åœæ­¢
#+begin_src shell
docker-compose up --build -d # ã‚³ãƒ³ãƒ†ãƒŠä½œæˆã™ã‚‹
docker-compose down
#+end_src
** dockerå¤–ã«å…¬é–‹ã™ã‚‹
[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]
Dockerfileã§ã€‚
#+begin_src shell
  CMD bundle exec rails server -b 0.0.0.0
#+end_src

ãªã©ã¨æ›¸ã„ã¦ãŠãã¨ã€å¤–éƒ¨(Dockerå¤–)ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚-b 0.0.0.0 ãŒãªã„ã¨åˆ¥ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãŒä¸å¯ã€‚ã‚³ãƒ³ãƒ†ãƒŠã‚’è¶…ãˆã‚‹ã¨åˆ¥ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ‰±ã„ã«ãªã‚‹ã®ã§ã“ã®è¨˜è¿°ãŒå¿…è¦ã€‚
** ãƒãƒ¼ãƒˆæŒ‡å®šã™ã‚‹
ã©ã£ã¡ã ã£ãŸã‹å¿˜ã‚Œã‚‹ã€‚
å·¦ãŒå…¬é–‹ã€å³ãŒã‚³ãƒ³ãƒ†ãƒŠå†…ã€‚ã ã‹ã‚‰ãƒ–ãƒ©ã‚¦ã‚¶ã§ãƒãƒ¼ãƒˆ8000ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
#+begin_src shell
  docker run -p 8000:3000 -it bdd92ace66ec
#+end_src
** ãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹
#+begin_src shell
docker ps -a # idç¢ºèª
docker logs 1111... # idã‚’å…¥ã‚Œã‚‹
#+end_src
** ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹
ä½¿ã£ã¦ãªã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã™ã‚‹ã€‚
#+begin_src shell
  docker images prone
#+end_src

ä¸€æ°—ã«å…¨éƒ¨å‰Šé™¤ã™ã‚‹ã€‚
#+begin_src shell
  docker stop $(docker ps -q)
  docker rm $(docker ps -aq)
  docker rmi $(docker images -q)
#+end_src
* Tasks
** TODO [[https://www.youtube.com/watch?v=HPuvDm8IC-4][Golang UK Conf. 2016 - Liz Rice - What is a container, really? Let's write one in Go from scratch - YouTube]]
ã‚³ãƒ³ãƒ†ãƒŠãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’ä½¿ã‚ãšã«[[id:7cacbaa3-3995-41cf-8b72-58d6e07468b1][Go]]ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹ã“ã¨ã§ã€ã‚³ãƒ³ãƒ†ãƒŠã¨ã¯ä½•ã‹ã‚’å­¦ã¶ã€‚
** TODO [[https://gihyo.jp/book/2020/978-4-297-11837-2][ã‚¤ãƒ©ã‚¹ãƒˆã§ã‚ã‹ã‚‹ Dockerã¨Kubernetesï¼šæ›¸ç±æ¡ˆå†…ï½œæŠ€è¡“è©•è«–ç¤¾]]
ä»•çµ„ã¿ã®èª¬æ˜ã€‚
** TODO [[https://dev.classmethod.jp/articles/container-journey/][ã€Œã‚³ãƒ³ãƒ†ãƒŠã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼ã€ã€œæ˜æ—¥ã‹ã‚‰é€Ÿæ”»å§‹ã‚ã‚‹AWSã§ã®ã‚³ãƒ³ãƒ†ãƒŠå°å…¥é‹ç”¨ã€œ #cmdevio2018 | DevelopersIO]]
ç¾å®Ÿçš„ãªå°å…¥ã‚¹ãƒ†ãƒƒãƒ—ã€‚
** TODO [[https://qiita.com/tatsurou313/items/ad86da1bb9e8e570b6fa][BuildKitã«ã‚ˆã‚ŠDockerã¨Docker Composeã§å¤–éƒ¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã£ãŸåŠ¹ç‡çš„ãªãƒ“ãƒ«ãƒ‰ã‚’ã™ã‚‹æ–¹æ³• - Qiita]]
BuildKitã®è§£èª¬ã€‚
** TODO [[https://www.slideshare.net/zembutsu/dockerfile-bestpractices-19-and-advice][Dockerfileã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã®Best Practice 2019å¹´ç‰ˆ]]
** TODO ã‚¿ã‚¹ã‚¯ã‚’ç°¡å˜ã«å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ã‚‹
[[id:1ad8c3d5-97ba-4905-be11-e6f2626127ad][Emacs]]æ‹¡å¼µã‚ã‚‹ã„ã¯ã€Makefileçš„ãªã®ã«ã¾ã¨ã‚ã‚‹ã€‚
** TODO ã‚´ãƒŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã§ããªã„ã‚ˆã†ã«ã™ã‚‹
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚„å±¥æ­´é–¢ä¿‚ãŒrootæ¨©é™ã§ã§ãã‚‹ã®ã§ã€å‰Šé™¤ãŒé¢å€’ï¼‹ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œã‚‹ã®ãŒé‚ªé­”ã•ã‚Œã‚‹ã€‚

- ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
- è‡ªå‹•å‰Šé™¤ã™ã‚‹ã‚ˆã†ã«ã™ã‚‹
** TODO Nginx, Unicornã‚’DockeråŒ–
:LOGBOOK:
CLOCK: [2022-02-11 Fri 18:25]--[2022-02-11 Fri 18:50] =>  0:25
CLOCK: [2022-02-04 Fri 10:15]--[2022-02-04 Fri 10:40] =>  0:25
:END:
<2022-02-28 Mon>
** Rails Dockerç’°å¢ƒåŒ–[6/9]
:LOGBOOK:
CLOCK: [2021-12-14 Tue 22:49]--[2021-12-15 Wed 00:40] =>  1:51
:END:
ä»•äº‹ã‚’Linuxã§è¡Œãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
*** TODO rails cå†…ã§æ—¥æœ¬èªãŒå«ã¾ã‚Œã‚‹ã¨å¤±æ•—ã™ã‚‹
*** TODO JS system specãŒå¤±æ•—ã™ã‚‹
js: trueã®ã¨ãã ã‘ã€‚
*** TODO migrationæ™‚ã«schemaã«å¤‰ãªå·®åˆ†ãŒå‡ºã‚‹
DBè¨­å®šãŒãŠã‹ã—ã„ã‚ˆã†ã ã€‚
*** DONE éåŒæœŸå‡¦ç†ã®å‹•ä½œç¢ºèª
CLOSED: [2022-01-12 Wed 23:08]
:LOGBOOK:
CLOCK: [2022-01-12 Wed 23:02]--[2022-01-12 Wed 23:08] =>  0:06
CLOCK: [2022-01-12 Wed 22:32]--[2022-01-12 Wed 22:57] =>  0:25
:END:
redis, sidekiqãŒæœ¬å½“ã«å‹•ã„ã¦ã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã€‚
letter openerã‚’è¦‹ã‚‹é™ã‚Šã€ã§ãã¦ãªã„ã€‚

è¿½åŠ ã—ãŸã€‚
*** DONE [#A] dockerãŒrootãƒ¦ãƒ¼ã‚¶ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã™ã‚‹å•é¡Œ
CLOSED: [2021-12-25 Sat 23:51]
ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒrootæ¨©é™ã«ãªã£ã¦ã—ã¾ã†ã€‚
ã ã‹ã‚‰bundle installã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãã®å¾Œã¯é€šå¸¸ãƒ¦ãƒ¼ã‚¶ã§ã¯ç·¨é›†ã§ããªããªã‚‹ã€‚
é¢å€’ã ã—ã€migrationã¨ã‹æ˜ã‚‰ã‹ã«ãƒ€ãƒ¡ãªæ°—ãŒã™ã‚‹ã€‚

ç°¡å˜ãªè§£æ±ºç­–ã¨ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã£ã¦è§£æ±ºã™ã‚‹æ–¹æ³•ã‚’èª¿ã¹ãŸã€‚
*** DONE åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰
CLOSED: [2021-12-20 Mon 22:57]
[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]éƒ¨åˆ†ã‚’DockeråŒ–ã™ã‚‹ã€‚è¡¨ç¤ºã¯ã¾ã£ãŸãå•é¡Œãªã•ãã†ã€‚
ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ã¡ã‚ƒã‚“ã¨ãƒ­ãƒ¼ã‚«ãƒ«ã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã€‚

æœ€åˆã«ãƒ«ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®dockerfileã§ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã€åå‰ã‚’ä»˜ã‘ã‚‹ã€‚
#+begin_src shell
  docker build . -t app
#+end_src

å„ã‚³ãƒ³ãƒ†ãƒŠã§ã¯â†‘ã§ä½œæˆã—ãŸãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸appã‚’ç”¨ã„ã‚‹ã€‚
ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†ä»£ã‚ã‚Šã« ~build .~ ã§ã‚‚å¯èƒ½ã ãŒã€å„ã‚³ãƒ³ãƒ†ãƒŠãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã™ã‚‹(ä¸­èº«ã¯åŒã˜)ã®ã§é…ãã”ã¡ã‚ƒã¤ãã€‚

#+caption: docker-compose.yml
#+begin_src yaml
  rails:
    image: app
    environment:
      RAILS_ENV: development
      REDIS_URL: redis://redis:6379
      MEMCACHED_URL: memcached://memcached:11211
      SKIP_RECAPTCHA: "true"
      MEMCACHED_HOST: memcached
      MEMCACHED: memcached:11211
      WEBPACKER_DEV_SERVER_HOST: webpack
      CHROME_HOST_NAME: http://selenium_chrome:4444/wd/hub
    ports:
      - 3000:3000
    stdin_open: true
    tty: true
    command: bash -c "rm -f tmp/pids/server.pid && bundle exec rails s -b '0.0.0.0'"
    volumes:
      - .:/rails
      - /etc/passwd:/etc/passwd:ro # Linuxç”¨
      - /etc/group:/etc/group:ro # Linuxç”¨
    depends_on:
      - mysql

  worker:
    image: app
    command: bundle exec sidekiq
    links:
      - mysql
      - redis

  webpack:
    image: app
    build: .
    tty: true
    environment:
      NODE_ENV: development
      RAILS_ENV: development
      WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
    command: yarn watch
    volumes:
      - .:/rails
      - /etc/passwd:/etc/passwd:ro # Linuxç”¨
      - /etc/group:/etc/group:ro # Linuxç”¨
    ports:
      - 8080:8080
#+end_src

#+caption: ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ + ç«‹ã¡ä¸Šã’
#+begin_src shell
  sudo docker-compose up --build
#+end_src

#+caption: å†èµ·å‹•
#+begin_src shell
  docker-compose {service} restart
#+end_src

#+caption: railsã¯ã‚µãƒ¼ãƒ“ã‚¹åã€‚ä»¥ä¸‹ã‚’å¥½ããªã‚³ãƒãƒ³ãƒ‰ã«å¤‰ãˆã‚‹
#+begin_src shell
  docker-compose run rails bundle exec rails c
#+end_src

#+caption: bundle install
#+begin_src shell
  docker-compose run rails bundle install
#+end_src

#+caption: ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹
#+begin_src shell
  docker-compose run rails bundle exec bin/rspec spec/requests/top/top_spec.rb
#+end_src

#+caption: ã‚³ãƒ³ãƒ†ãƒŠå†…ã®shellã«å…¥ã£ã¦ã¿ã‚‹
#+begin_src shell
  docker-compose run rails /bin/bash
#+end_src
*** DONE docker-compose.ymlã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
CLOSED: [2021-12-20 Mon 22:57]
å€‹äººã§å¾®å¦™ã«è¨­å®šãŒç•°ãªã‚‹ã“ã¨ã‚‚ã‚ã‚‹ã€‚
Dockerã§ã‚„ã‚‹ã®ã¯ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã ã‘ã¨ã‹ã€[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã‚‚ã™ã¹ã¦ã‚„ã‚‹ã€ã¨ã„ã£ãŸã‚ˆã†ãªã€‚
ãã®ã¨ãã¯gitignoreã‚’æŒ‡å®šã—ãŸymlã‚’æŒ‡å®šã—ã¦èµ·å‹•ã™ã‚‹ã€‚

#+caption: å¾Œã‹ã‚‰èª­ã¿è¾¼ã¾ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ä¸Šæ›¸ãã•ã‚Œã‚‹
#+begin_src shell
  docker-compose -f docker-compose.yml -f docker-compose-app.override.yml up
#+end_src

ã‚‚ã¡ã‚ã‚“ä¸€èˆ¬æ€§ãŒã‚ã‚‹ãªã‚‰gitç®¡ç†ã«ã™ã‚‹ã®ãŒãƒ™ã‚¹ãƒˆã ãŒã€äººã«ã‚ˆã£ã¦æ§‹æˆãŒç•°ãªã‚‹ã®ã§ä»•æ–¹ãªã„ã€‚ã¨ãã«Macã ã¨é€Ÿåº¦ã«å•é¡Œã‚ã‚‹ãŸã‚ã€[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã¯[[id:1658782a-d331-464b-9fd7-1f8233b8b7f8][Docker]]ã§ç«‹ã¡ä¸Šã’ãªã„ã®ãŒå¤šæ•°æ´¾ã€‚

[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]ã‚µãƒ¼ãƒ“ã‚¹ã‚’override.ymlã«ã€ãã‚Œä»¥å¤–ã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚µãƒ¼ãƒ“ã‚¹ã‚’docker-compose.ymlã«æ›¸ã„ã¦ã‚‹å ´åˆã¯ã€æ˜ç¤ºã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
#+caption: overrideã—ãŸã¨ãã®bundle installã€‚-fæŒ‡å®šãŒå¿…è¦ã€‚
#+begin_src shell
  docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run rails bundle install
#+end_src

docker-compose runã™ã‚‹å ´åˆã‚‚-fã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå¿…è¦ã€‚
runã¯ã‚³ãƒ³ãƒ†ãƒŠã‚’æ–°ã—ãä½œã‚‹â€¦ã¤ã¾ã‚Šymlã‚’è¦‹ã¦ã‚‹ã®ã§ã€æŒ‡å®šãŒå¿…è¦ãªã®ã§ã‚ã‚‹ã€‚

#+caption: model specã‚’å®Ÿè¡Œã™ã‚‹
#+begin_src shell
  docker-compose -f docker-compose.yml -f docker-compose-app.override.yml exec rails bundle exec rspec --options ./.rspec ./spec/models/user_spec.rb
#+end_src

â†‘ã„ã¡ã„ã¡ã‚¯ã‚½é•·ã„ã‚³ãƒãƒ³ãƒ‰ã‚’æ‰“ã¤ã®ã¯è‹¦ç—›ãªã®ã§ã€shellã«å…¥ã£ã¦ä½œæ¥­ã™ã‚‹ã¨æ¥½ã€‚
#+caption: shellã«å…¥ã‚‹
#+begin_src shell
  sudo docker-compose -f docker-compose.yml -f docker-compose-app.override.yml run rails /bin/sh
#+end_src
*** DONE DBã®GUIãƒ„ãƒ¼ãƒ«ã¨ã®æ¥ç¶š
CLOSED: [2021-12-17 Fri 20:58]
Linuxç”¨ã®sqlectronãŒã‚ˆã•ãã†ã€‚ãŒã€ä¸Šæ‰‹ã[[id:7dab097c-60ba-43b9-949f-c58bf3151aa8][MySQL]]ã¨æ¥ç¶šã§ããªã„
docker-compose.ymlã§ ~MYSQL_ALLOW_EMPTY_PASSWORD: 'yes'~ ã‚’è¿½åŠ ã™ã‚‹ã¨å…¥ã‚Œã‚‹ã‚ˆã†ã«ã€‚
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æŒ‡å®šã—ã¦ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„ã€‚

ã ãŒã“ã®sqlectronã€è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ«ã§ã®ç·¨é›†ãŒã§ããªã„ã®ã§å€¤ã‚’æ›¸ãæ›ãˆã‚‹ã®ã«éå¸¸ã«ä¸ä¾¿ã€‚
åˆ¥ã®ã‚’ä½¿ã£ãŸã»ã†ãŒã„ã„ã ã‚ã†ã€‚
*** DONE yarnãŒã§ãã¦ãªã„
CLOSED: [2021-12-17 Fri 20:58]
- ãƒãƒ¼ãƒˆã‚’åˆã‚ã›ã‚‹
- webpack.config.jsã«hostã‚’åŠ ãˆã‚‹

ãŒå¿…è¦ã€‚

#+caption: docker-compose.yml
#+begin_src yaml
  webpack:
    build: .
    environment:
      NODE_ENV: development
      RAILS_ENV: development
      WEBPACKER_DEV_SERVER_HOST: 0.0.0.0
    command: yarn watch
    volumes:
      - .:/rails
    ports:
      - 8080:8080
    depends_on:
      - rails
#+end_src

ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ã§ãã‚‹ã®ã‚’ç¢ºèªã€‚
hostã‚’åŠ ãˆã‚‹å¿…è¦ãŒã‚ã£ãŸã€‚
#+caption: webpack.config.js
#+begin_src json
  devServer: {
    contentBase: path.join(__dirname, 'app/assets/javascripts'),
    allowedHosts: ['.lvh.me'],
    host: '0.0.0.0',
  },
#+end_src
* Archives
** DONE [[https://www.forcia.com/blog/002273.html][ç¤¾å†…ã®Dockerfileã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å…¬é–‹ã—ã¾ã™â”‚FORCIA CUBEâ”‚ãƒ•ã‚©ãƒ«ã‚·ã‚¢æ ªå¼ä¼šç¤¾]]
CLOSED: [2022-02-11 Fri 18:27]
éå¸¸ã«è©³ã—ã„æƒ…å ±ã€‚
* References
** [[https://www.redhat.com/ja/topics/containers/what-is-docker][Docker ã¨ã¯ - è§£èª¬ã€ãƒ¡ãƒªãƒƒãƒˆã€ã§ãã‚‹ã“ã¨ | Red Hat]]
ã‚ã‹ã‚Šã‚„ã™ã„æ¦‚è¦ã€‚
** [[https://ja.wikipedia.org/wiki/Docker][Docker - Wikipedia]]
ä¼æ¥­ã¨ã—ã¦ã®Dockerã€‚
** [[https://github.com/phusion/passenger-docker][phusion/passenger-docker: Docker base images for Ruby, Python, Node.js and Meteor web apps]]
Webé–‹ç™ºç”¨ã®æ‰±ã„ã‚„ã™ã„Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚
** [[https://12factor.net/][The Twelve-Factor App]]
SaaSé–‹ç™ºã®æ–¹æ³•è«–ã€‚
æ—¥æœ¬èªè¨³ã‚‚ã‚ã£ãŸã€‚[[https://12factor.net/ja/][The Twelve-Factor App ï¼ˆæ—¥æœ¬èªè¨³ï¼‰]]
** [[https://docs.docker.jp/pdf-download.html][Docker ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ—¥æœ¬èªç‰ˆ PDF ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ â€” Docker-docs-ja 19.03 ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]]
Dockerã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚
** [[https://kotaroooo0-dev.hatenablog.com/entry/2020/08/06/012316][ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãŸã‚ã«Dockerãƒ“ãƒ«ãƒ‰ã§ä¸­é–“ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ã‚¿ã‚°ä»˜ã‘ã—ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã«Pushã™ã‚‹ - ğŸ¤–]]
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ›¸ãæ–¹ã€‚
