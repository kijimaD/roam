<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-01-14 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rails</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">Rails</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org43ab779">概要</a></li>
<li><a href="#org37285c2">Memo</a>
<ul>
<li><a href="#org8c465fd">集計時のN+1回避</a></li>
<li><a href="#org678e354">エラー表示</a></li>
<li><a href="#orgd771fce">viewでcontrollerクラスの情報を得る</a></li>
<li><a href="#org0964da5">定義ジャンプ</a></li>
<li><a href="#org0f997af">mailerはキューにためられるので、Serializationできない値は渡すとエラーになる</a></li>
<li><a href="#orgc952dd8">join先のテーブルでwhere</a></li>
<li><a href="#org3724485">Docker サンプル</a></li>
<li><a href="#orgc421ab4">依存関係一切なくrails newする</a></li>
<li><a href="#org2fa53b4">factoryがないモデルを検知するタスク</a></li>
<li><a href="#orgb6dcdf8">レコードがないテーブルを検知するタスク</a></li>
<li><a href="#org9d377d6">seed_fu内でfactory botを使う</a></li>
<li><a href="#orgcf27a38">rakeタスク</a></li>
<li><a href="#org9d36338">非同期処理</a></li>
<li><a href="#orgbd08ab5">preload, eager_load, includes</a></li>
<li><a href="#org52dc7de">RailsのOSS</a></li>
<li><a href="#org17c5e53">ルーティングのファイルと名前空間を切り出す</a></li>
<li><a href="#org64d0121">時間関係</a></li>
<li><a href="#orgf4c3f82">ネストしたトランザクション</a></li>
<li><a href="#orge866cbc">Fakerでboolean生成</a></li>
<li><a href="#org1fecdeb">マイグレーションでカラムの型を変える</a></li>
<li><a href="#org9c7e47a">便利なデバッガweb-console</a></li>
<li><a href="#orgaab8923">update_atを更新しない</a></li>
<li><a href="#org401a5cd">save(validate: false)</a></li>
<li><a href="#org6434d4a">presence: trueなのにnilがあるレコードを検知する</a></li>
<li><a href="#org888132d">バックエンドエンジニアというときの正確なスコープ</a></li>
<li><a href="#orgd244b2b">テストによるスマートな画像確認</a></li>
<li><a href="#orga924b65">オートロードするgem: zeitwerk</a></li>
<li><a href="#org7aaf478">デフォルトスコープを無視できるreorder</a></li>
<li><a href="#org3b60492">開発用データの用意</a></li>
<li><a href="#org93369b1">ALTER TABLEは重い</a></li>
<li><a href="#org74e246a">テーブル名にプレフィクスを設定する</a></li>
<li><a href="#org3b12c53">Rails環境でバッチ処理する</a></li>
<li><a href="#org9b336e1">routesの制約</a></li>
<li><a href="#org07334b0">大量のroutes変更を楽に確認する</a></li>
<li><a href="#orgdb29fb3">create_or_find_by</a></li>
<li><a href="#org3c67aa1">使われてないファイルを検索する</a></li>
<li><a href="#org71d3ad9">Rubyバージョンアップデート</a></li>
<li><a href="#org16abb81">新規作成時はform表示しない</a></li>
<li><a href="#org1fd2797">一部アクションだけvalidation</a></li>
<li><a href="#orgb9c1aa3">便利な日付操作</a></li>
<li><a href="#org84c44ef">安全に関連カラムを追加する</a></li>
<li><a href="#org95877a8">関連カラムを安全に変更する</a></li>
<li><a href="#org885bdab">カラム名を安全に変更する</a></li>
<li><a href="#org4069ec1">テーブル名を安全に変更する</a></li>
<li><a href="#orgc6db01b">modelのログを保持する</a></li>
<li><a href="#org92c1030">サロゲートキー</a></li>
<li><a href="#org35dd6d1">ロールバックできないマイグレーションであることを明示する</a></li>
<li><a href="#org01e187b">null制約を追加しつつdefault設定</a></li>
<li><a href="#orgdb2b4ff">migrationファイルによる不整合解消タスク</a></li>
<li><a href="#orge9fcaa8">unscopedでdefault_scopeを無効化</a></li>
<li><a href="#org1a7fed1">inverse_ofで双方向の不整合を防ぐ</a></li>
<li><a href="#org75f64e2">リレーションの不整合を検知する</a></li>
<li><a href="#org47953f8">クエリ高速化</a></li>
<li><a href="#org7fa2ea9">Migrationファイルをまとめて高速化する</a></li>
<li><a href="#orgbef752a">Gemfileで環境指定する</a></li>
<li><a href="#org7ab0f14">論理削除と物理削除</a></li>
<li><a href="#org1e21a94">find、find_by、whereの違い</a></li>
<li><a href="#org5ab5f70">acts_as_list</a></li>
<li><a href="#org2b1366c">テーブル名と名前空間</a></li>
<li><a href="#org395decb">pluck</a></li>
<li><a href="#org6b52325">まとめて処理して高速化</a></li>
<li><a href="#orgb7b9b68">該当レコード数が莫大な場合</a></li>
<li><a href="#org33a3aee">並列処理の例</a></li>
<li><a href="#org42db2ab">開発に便利なページ</a></li>
<li><a href="#orgb4fd75a">開発環境でしか使えないメソッドが存在する</a></li>
<li><a href="#org0e82802">rails console -s</a></li>
<li><a href="#orga88a7ef">rails cできないとき</a></li>
<li><a href="#orgde2c482">system specでTCP error がでるとき</a></li>
<li><a href="#orga3c6c47">seed_fuのlint</a></li>
<li><a href="#orge376815">どのメソッドか調べる</a></li>
<li><a href="#org9f29d2d">DBリセット</a></li>
<li><a href="#org36ece52">デイリーでやること</a></li>
<li><a href="#org85780c4">scope</a></li>
<li><a href="#org0901599">validation</a></li>
<li><a href="#org58d8ff5">ネストしたvalidateは反応しない</a></li>
<li><a href="#org079df79">N+1問題</a></li>
<li><a href="#orgb8fb97d">子のデータが存在するとき関連削除しないようにする</a></li>
<li><a href="#org548ff14">文字列で返ってくる真偽値をbooleanオブジェクトに変換する</a></li>
<li><a href="#org625bbd3">slimで条件分岐</a></li>
<li><a href="#org2cc7863">migration例</a></li>
</ul>
</li>
<li><a href="#org89e237d">Tasks</a>
<ul>
<li><a href="#orga7993f7"><span class="todo TODO">TODO</span> マイグレーションはどうやっているか</a></li>
<li><a href="#orgc57570f"><span class="todo TODO">TODO</span> Railsは起動時に何をしているか</a></li>
<li><a href="#org85819d9"><span class="todo TODO">TODO</span> ECRデプロイ</a></li>
<li><a href="#orgf3eeef3"><span class="todo TODO">TODO</span> 実行時のwaringをエラーとして検出させるオプションを見つける</a></li>
<li><a href="#orgebd89aa"><span class="todo TODO">TODO</span> Rails + GraphQL + TypeScript + React + Apollo | egghead.io</a></li>
<li><a href="#org74afab4"><span class="todo TODO">TODO</span> Advanced Rails Recipes</a></li>
<li><a href="#orgea9ce52"><span class="todo TODO">TODO</span> クソコード動画「Userクラス」で考える技術的負債解消の観点/DXD2021</a></li>
<li><a href="#orgd30376a"><span class="todo TODO">TODO</span> Ruby on Rails ガイド：体系的に Rails を学ぼう</a></li>
<li><a href="#org5278a38"><span class="todo TODO">TODO</span> Understanding Factory Bot syntax by coding your own Factory Bot - Code with Jason</a></li>
<li><a href="#orgaec25fa"><span class="todo TODO">TODO</span> Tips文書化</a></li>
</ul>
</li>
<li><a href="#orga2e151a">Archives</a>
<ul>
<li><a href="#orga46cd21"><span class="done DONE">DONE</span> 誤字</a></li>
<li><a href="#orgfc947fa"><span class="done DONE">DONE</span> Rails+React（SPA）TODOアプリチュートリアル【0から学ぶ】</a></li>
<li><a href="#orgd7863ab"><span class="done CLOSE">CLOSE</span> loggerを自動オン</a></li>
<li><a href="#org54cd27d"><span class="done DONE">DONE</span> 【Rails】graphql-rubyでAPIを作成 - Qiita -実行</a></li>
<li><a href="#org948796c"><span class="done CLOSE">CLOSE</span> Amazon.co.jp: Deploying Rails with Docker, Kubernetes and ECS (English Edition) eBook : Acuña, Pablo: Foreign Language Books</a></li>
<li><a href="#orgf45cfc3"><span class="done DONE">DONE</span> RailsとPumaの関係性</a></li>
</ul>
</li>
<li><a href="#org5d9950e">References</a>
<ul>
<li><a href="#orga865521">thoughtbot/ruby-science: The reference for writing fantastic Rails applications</a></li>
<li><a href="#orgbaef26b">なぜrailsの本番環境ではUnicorn,Nginxを使うのか? 　~ Rack,Unicorn,Nginxの連携について ~【Ruby On Railsでwebサービス運営】 - Qiita</a></li>
<li><a href="#org2ad2a9f">docker - How to run Capybara tests using Selenium &amp; Chrome in a Dockerised Rails environment on a Mac - Stack Overflow</a></li>
<li><a href="#org6138225">Active Model の基礎 - Railsガイド</a></li>
<li><a href="#orga617cf0">永久保存版！？伊藤さん式・Railsアプリのアップグレード手順 - Qiita</a></li>
<li><a href="#orga68dda0">DHH流のルーティングで得られるメリットと、取り入れる上でのポイント - KitchHike Tech Blog</a></li>
<li><a href="#org665a36b">ankane/strong_migrations: Catch unsafe migrations in development</a></li>
<li><a href="#org00cecf8">reg-suit によるビジュアルリグレッションテストで Rails アプリの CSS 改善サイクルが回り始めた話 - Speee DEVELOPER BLOG</a></li>
<li><a href="#org1098aeb">Only My Rails Way</a></li>
<li><a href="#orga0a4805">Ruby on Rails Discussions - Ruby on Rails Discussions</a></li>
<li><a href="#org3db0cda">Railsエンジニアのためのウェブセキュリティ入門</a></li>
<li><a href="#org57ec33b">Rails開発者が採用面接で聞かれる想定Q&amp;A 53問（翻訳）｜TechRacho by BPS株式会社</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org43ab779" class="outline-2">
<h2 id="org43ab779"><a href="#org43ab779">概要</a></h2>
<div class="outline-text-2" id="text-org43ab779">
<p>
Railsは<a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a>でWEBサイトを作るためのフレームワーク。
</p>
</div>
</div>
<div id="outline-container-org37285c2" class="outline-2">
<h2 id="org37285c2"><a href="#org37285c2">Memo</a></h2>
<div class="outline-text-2" id="text-org37285c2">
</div>
<div id="outline-container-org8c465fd" class="outline-3">
<h3 id="org8c465fd"><a href="#org8c465fd">集計時のN+1回避</a></h3>
<div class="outline-text-3" id="text-org8c465fd">
<p>
異なる条件の複数の件数を表示したいとき。たとえば↓レコードで、Receiptsに載っているproductの数ごとに集計したい。
</p>

<ul class="org-ul">
<li>最終型</li>
</ul>
<table>


<colgroup>
<col  class="org-left">

<col  class="org-right">
</colgroup>
<tbody>
<tr>
<td class="org-left">products.name</td>
<td class="org-right">count</td>
</tr>

<tr>
<td class="org-left">おにぎり</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-left">お茶</td>
<td class="org-right">1</td>
</tr>
</tbody>
</table>



<ul class="org-ul">
<li>Receipts</li>
</ul>
<table>


<colgroup>
<col  class="org-right">

<col  class="org-right">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-right">id</td>
<td class="org-right">product_id</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">1</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">2</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>Products</li>
</ul>
<table>


<colgroup>
<col  class="org-right">

<col  class="org-left">
</colgroup>
<tbody>
<tr>
<td class="org-right">id</td>
<td class="org-left">name</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">おにぎり</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">お茶</td>
</tr>
</tbody>
</table>

<p>
こうやって書くと明らかにSQLのgroup関数を使おう、となる。が、実際のコードでは気づかずに条件を変えてeachで繰り返す…としてN+1にしてしまうことがある。こうする。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">Receipt</span>.group(<span class="org-type">Product</span>.arel_table[<span class="org-constant">:id</span>]).count
</pre>
</div>

<p>
このようなハッシュテーブルを返す。
</p>

<div class="org-src-container">
<pre class="src src-json">// product_id =&gt; count
{
  1=&gt;2,
  2=&gt;1
}
</pre>
</div>

<p>
product_idがわかっているので、あとはProductをfindして名前を引けばいい。
</p>
</div>
</div>

<div id="outline-container-org678e354" class="outline-3">
<h3 id="org678e354"><a href="#org678e354">エラー表示</a></h3>
<div class="outline-text-3" id="text-org678e354">
<p>
ブラウザでのエラー表示は、configで設定できる。
デフォルトのproduction, sandbox, stagingではfalseになっていて、エラーは表示されない。
これらの環境で表示するには、↓を加える。
</p>
<div class="org-src-container">
<pre class="src src-shell">config.consider_all_requests_local = true
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd771fce" class="outline-3">
<h3 id="orgd771fce"><a href="#orgd771fce">viewでcontrollerクラスの情報を得る</a></h3>
<div class="outline-text-3" id="text-orgd771fce">
<p>
たまに必要なことがある。
controllerオブジェクトが柔軟な感じ。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>viewファイル</label><pre class="src src-ruby">controller.class <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; #&lt;Admin::UserController&gt;</span>
controller_name <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; users</span>
controller_path <span class="org-comment-delimiter"># </span><span class="org-comment">=&gt; admin/users</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>controllerが特定のmoduleをincludeしているか判定</label><pre class="src src-ruby">controller.class.included_modules.include?(<span class="org-type">User</span>::concern)
</pre>
</div>
</div>
</div>
<div id="outline-container-org0964da5" class="outline-3">
<h3 id="org0964da5"><a href="#org0964da5">定義ジャンプ</a></h3>
<div class="outline-text-3" id="text-org0964da5">
<p>
<a href="20210508234743-emacs.html#ID-1ad8c3d5-97ba-4905-be11-e6f2626127ad">Emacs</a>から定義ジャンプしたい。
ほかの言語やフレームワークだと<a href="20220305121848-lsp.html#ID-eb807577-cd69-478c-8f82-264243c67354">LSP</a>だのを使えばいいが、Railsではどうするのかよくわからない。
TAGSファイルを生成して使う。
</p>

<div class="org-src-container">
<pre class="src src-shell">gem install ripper-tags
ripper-tags -e -R -f TAGS
</pre>
</div>

<p>
あとは、C-. で生成したタグを指定すればOK。
</p>

<p>
gemも定義ジャンプ対象にしたい場合、作業ディレクトリ内にgemのソースコードを置けばよい。
</p>
<div class="org-src-container">
<pre class="src src-shell">bundle install --path vendor/bundle
</pre>
</div>

<p>
<a href="https://qiita.com/arakaji/items/0cdfa843a0e0233df153">Railsアプリ内をEmacsで自由にタグジャンプ! - Qiita</a>
</p>
</div>
</div>
<div id="outline-container-org0f997af" class="outline-3">
<h3 id="org0f997af"><a href="#org0f997af">mailerはキューにためられるので、Serializationできない値は渡すとエラーになる</a></h3>
<div class="outline-text-3" id="text-org0f997af">
<p>
SerializationErrorになる。
メーラーに対して、シリアライゼーションできないオブジェクトは渡すことができない。
Railsから<a href="20220420225811-redis.html#ID-48b99bce-05ce-49af-921d-1e321e5a4f8b">Redis</a>に渡されるが、<a href="20220420225811-redis.html#ID-48b99bce-05ce-49af-921d-1e321e5a4f8b">Redis</a>はkey-value storeの形でないと保存できないから。
<a href="https://github.com/rails/rails/issues/18519">Mail and deliver_later doesn&rsquo;t work with date argument · Issue #18519 · rails/rails</a>
</p>
</div>
</div>
<div id="outline-container-orgc952dd8" class="outline-3">
<h3 id="orgc952dd8"><a href="#orgc952dd8">join先のテーブルでwhere</a></h3>
<div class="outline-text-3" id="text-orgc952dd8">
<p>
A -&lt; B -&lt; C -&lt; D みたいな関係。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>mergeで関連テーブル先で条件を絞れる</label><pre class="src src-ruby">a = <span class="org-type">A</span>.joins(<span class="org-constant">b:</span> [<span class="org-constant">c:</span> <span class="org-constant">:d</span>])
      .where(<span class="org-constant">a:</span> { <span class="org-constant">flag_a:</span> <span class="org-constant">true</span> })
      .merge(<span class="org-type">D</span>.where(<span class="org-constant">flag_d:</span> <span class="org-constant">true</span>))
</pre>
</div>

<p>
同じ意味のダサい書き方。
</p>
<div class="org-src-container">
<pre class="src src-ruby">a = a.joins(<span class="org-constant">b:</span> [<span class="org-constant">c:</span> <span class="org-constant">:d</span>])
      .where(<span class="org-constant">a:</span> { <span class="org-constant">flag_a:</span> <span class="org-constant">true</span> })
      .where(<span class="org-constant">d:</span> { <span class="org-constant">flag_d:</span> <span class="org-constant">true</span> })
</pre>
</div>
</div>
</div>
<div id="outline-container-org3724485" class="outline-3">
<h3 id="org3724485"><a href="#org3724485"><a href="20210805005543-docker.html#ID-1658782a-d331-464b-9fd7-1f8233b8b7f8">Docker</a> サンプル</a></h3>
<div class="outline-text-3" id="text-org3724485">
<p>
開発用環境のサンプル。サクっと起動したい用。
プロジェクトのあちこちで使ってるので、どこかにまとめた方がよさそうだな。
</p>

<pre class="example">
FROM phusion/passenger-ruby27:latest

WORKDIR /tmp

ADD Gemfile /tmp/
ADD Gemfile.lock /tmp/
RUN gem update --system
RUN bundle install

COPY . /home/app/webapp
RUN usermod -u 1000 app
RUN chown -R app:app /home/app/webapp
WORKDIR /home/app/webapp

RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
</pre>

<p>
かぶり防止のため3001番ポートの方を変えてブラウザアクセスする。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>docker-compose.yml</label><pre class="src src-yaml">version: '3'

services:
  rails:
    container_name: rails
    build: .
    command: bash -c 'rm -f tmp/pids/server.pid &amp;&amp; bundle exec rails s -b 0.0.0.0'
    volumes:
      - .:/home/app/webapp
    ports:
      - "3001:3000"
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc421ab4" class="outline-3">
<h3 id="orgc421ab4"><a href="#orgc421ab4">依存関係一切なくrails newする</a></h3>
<div class="outline-text-3" id="text-orgc421ab4">
<p>
公式のrailsコンテナ内でrails newすればよい。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>依存がない作成方法。user周りは権限問題のため⚠一行</label><pre class="src src-shell">docker run -it --rm --user <span class="org-string">"$(id -u):$(id -g)"</span> -v <span class="org-string">"$PWD"</span>:/usr/src/app -w /usr/src/app rails rails new --skip-bundle --api --database postgresql .
</pre>
</div>

<p>
依存がないbundle install。
ruby:2.7.5イメージで走らせる。
</p>
<div class="org-src-container">
<pre class="src src-shell">docker run --rm -v <span class="org-string">"$PWD"</span>:/usr/src/app -w /usr/src/app ruby:2.7.5 bundle install
</pre>
</div>
</div>
</div>

<div id="outline-container-org2fa53b4" class="outline-3">
<h3 id="org2fa53b4"><a href="#org2fa53b4">factoryがないモデルを検知するタスク</a></h3>
<div class="outline-text-3" id="text-org2fa53b4">
<p>
factoryはテストで使うので、fixtureほど忘れることはない。作り忘れたり、過去もので漏れているものがたまにあるので検知する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>rakeタスクファイルにて</label><pre class="src src-ruby"><span class="org-builtin">require</span> <span class="org-string">"factory_bot_rails"</span>
<span class="org-builtin">include</span> <span class="org-type">FactoryBot</span>::<span class="org-type">Syntax</span>::<span class="org-type">Methods</span>
<span class="org-builtin">include</span> <span class="org-type">ActionDispatch</span>::<span class="org-type">TestProcess</span> <span class="org-comment-delimiter">#  </span><span class="org-comment"># fixture_file_upload&#12513;&#12477;&#12483;&#12489;&#12391;&#12456;&#12521;&#12540;&#12395;&#12394;&#12427;&#12383;&#12417;&#24517;&#35201;&#12290;</span>

task <span class="org-constant">factory:</span> <span class="org-constant">:environment</span> <span class="org-keyword">do</span>
    msg = []
    errors = []

    <span class="org-type">Rails</span>.application.eager_load!
    <span class="org-type">ApplicationRecord</span>.subclasses.each <span class="org-keyword">do</span> |model|
      <span class="org-keyword">begin</span>
        create(model.name.underscore.gsub(<span class="org-string">%r{/}</span>, <span class="org-string">'_'</span>)) <span class="org-comment-delimiter"># </span><span class="org-comment">factory&#12398;&#12513;&#12477;&#12483;&#12489;</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">UserPayment -&gt; user_payment</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">admin/user_payment -&gt; admin_user_payment</span>
      <span class="org-keyword">rescue</span> =&gt; e
        errors &lt;&lt; e <span class="org-keyword">if</span> e.class == <span class="org-type">KeyError</span>
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>

    <span class="org-builtin">puts</span> errors

    <span class="org-builtin">raise</span> <span class="org-string">'&#30331;&#37682;&#12373;&#12428;&#12390;&#12394;&#12356;factory&#12364;&#12354;&#12426;&#12414;&#12377;'</span> <span class="org-keyword">if</span> errors
  <span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb6dcdf8" class="outline-3">
<h3 id="orgb6dcdf8"><a href="#orgb6dcdf8">レコードがないテーブルを検知するタスク</a></h3>
<div class="outline-text-3" id="text-orgb6dcdf8">
<p>
fixtureの作り忘れなどよくあるので、seedを実行したあとにチェックするタスクを走らせるとよい。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>rakeタスクファイルにて</label><pre class="src src-ruby">task <span class="org-constant">lint:</span> <span class="org-constant">:environment</span> <span class="org-keyword">do</span>
  msg = []
  invalid = <span class="org-constant">false</span>

  <span class="org-type">Rails</span>.application.eager_load!
  <span class="org-type">ApplicationRecord</span>.subclasses.each <span class="org-keyword">do</span> |model|
    msg &lt;&lt; <span class="org-string">"</span><span class="org-variable-name">#{model.name}</span><span class="org-string"> =&gt; </span><span class="org-variable-name">#{model.count}</span><span class="org-string">"</span>
    invalid = <span class="org-constant">true</span> <span class="org-keyword">if</span> model.count.zero?
  <span class="org-keyword">end</span>

  <span class="org-builtin">puts</span> msg

  <span class="org-builtin">raise</span> <span class="org-string">'&#12524;&#12467;&#12540;&#12489;&#12364;&#12394;&#12356;&#12486;&#12540;&#12502;&#12523;&#12364;&#12354;&#12426;&#12414;&#12377;'</span> <span class="org-keyword">if</span> invalid
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9d377d6" class="outline-3">
<h3 id="org9d377d6"><a href="#org9d377d6">seed_fu内でfactory botを使う</a></h3>
<div class="outline-text-3" id="text-org9d377d6">
<p>
SeedFu.seedを実行するコンテキストでrequire, includeしておけばメソッドが使える。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 9: </span>rakeタスクファイル</label><pre class="src src-ruby"><span class="org-builtin">require</span> <span class="org-string">"factory_bot_rails"</span>
<span class="org-builtin">include</span> <span class="org-type">FactoryBot</span>::<span class="org-type">Syntax</span>::<span class="org-type">Methods</span>
<span class="org-builtin">include</span> <span class="org-type">ActionDispatch</span>::<span class="org-type">TestProcess</span>
<span class="org-type">SeedFu</span>.quiet = <span class="org-constant">true</span>

task <span class="org-constant">lint:</span> <span class="org-constant">:environment</span> <span class="org-keyword">do</span>
  <span class="org-type">SeedFu</span>.seed(<span class="org-string">"db/fixtures/</span><span class="org-variable-name">#{env}</span><span class="org-string">"</span>)
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcf27a38" class="outline-3">
<h3 id="orgcf27a38"><a href="#orgcf27a38">rakeタスク</a></h3>
<div class="outline-text-3" id="text-orgcf27a38">
<p>
rakeタスクは、普通ターミナルから実行するが、ほかから実行したいときがある(テストとか)。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 10: </span>rails_helper.rbにて</label><pre class="src src-ruby">config.before(<span class="org-constant">:each</span>) <span class="org-keyword">do</span>
  <span class="org-type">Rake</span>.application.tasks.each(&amp;<span class="org-constant">:reenable</span>)
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 11: </span>テスト上にて実行する</label><pre class="src src-ruby"><span class="org-type">Rake</span>.application[<span class="org-string">'namespace:command'</span>].invoke
</pre>
</div>

<p>
のようにして、実行できる。
</p>
</div>
</div>
<div id="outline-container-org9d36338" class="outline-3">
<h3 id="org9d36338"><a href="#org9d36338">非同期処理</a></h3>
<div class="outline-text-3" id="text-org9d36338">
<p>
Webにおける非同期処理はメールとか、外部とのAPI連携とか、比較的時間のかかる処理で用いられている。
とりあえず画面を返し、待たせないようにする。
</p>

<p>
sidekiqは非同期タスクワーカー。
<a href="20220420225811-redis.html#ID-48b99bce-05ce-49af-921d-1e321e5a4f8b">Redis</a>はインメモリデータベース。
</p>

<p>
たとえばRails上でメールを送る処理が走る時、railsはそのタスクをredisに送り、保持する(キューする)。sidekiqは、キューされたタスクを順次処理していく。
クラウドサービスの<a href="20220420225811-redis.html#ID-48b99bce-05ce-49af-921d-1e321e5a4f8b">Redis</a>を用いることで、ダウンしても未処理のジョブを失わない。
</p>
</div>
</div>
<div id="outline-container-orgbd08ab5" class="outline-3">
<h3 id="orgbd08ab5"><a href="#orgbd08ab5">preload, eager_load, includes</a></h3>
<div class="outline-text-3" id="text-orgbd08ab5">
<p>
ややこしいがパフォーマンスを考える上で必要なので理解しておく。
</p>

<ul class="org-ul">
<li><a href="https://tech.stmn.co.jp/entry/2020/11/30/145159">preload、eager_load、includesの挙動を理解して使い分ける - stmn tech blog</a></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">メソッド</th>
<th scope="col" class="org-left">キャッシュ</th>
<th scope="col" class="org-left">クエリ</th>
<th scope="col" class="org-left">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">joins</td>
<td class="org-left">しない</td>
<td class="org-left">単数</td>
<td class="org-left">絞り込み</td>
</tr>

<tr>
<td class="org-left">eager_load</td>
<td class="org-left">する</td>
<td class="org-left">単数</td>
<td class="org-left">キャッシュと絞り込み</td>
</tr>

<tr>
<td class="org-left">preload</td>
<td class="org-left">する</td>
<td class="org-left">複数</td>
<td class="org-left">キャッシュ</td>
</tr>

<tr>
<td class="org-left">includes</td>
<td class="org-left">する</td>
<td class="org-left">場合による</td>
<td class="org-left">キャッシュ、必要なら絞り込み</td>
</tr>
</tbody>
</table>

<blockquote>
<p>
そのテーブルとのJOINを禁止したいケースではpreloadを指定し、JOINしても問題なくてとりあえずeager loadingしたい場合はincludesを使い、必ずJOINしたい場合はeager_loadを使いましょう。
</p>
</blockquote>

<ul class="org-ul">
<li><a href="https://qiita.com/ryosuketter/items/097556841ec8e1b2940f">ActiveRecordのincludesは使わずにpreloadとeager_loadを使い分ける理由 - Qiita</a></li>
</ul>

<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">メソッド</th>
<th scope="col" class="org-left">SQL(クエリ)</th>
<th scope="col" class="org-left">キャッシュ</th>
<th scope="col" class="org-left">アソシエーション先のデータ参照</th>
<th scope="col" class="org-left">デメリット</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">joins</td>
<td class="org-left">INNER JOIN</td>
<td class="org-left">しない</td>
<td class="org-left">できる</td>
<td class="org-left">N+1問題</td>
</tr>

<tr>
<td class="org-left">preload</td>
<td class="org-left">JOINせずそれぞれSELECT</td>
<td class="org-left">する</td>
<td class="org-left">できない</td>
<td class="org-left">IN句大きくなりがち</td>
</tr>

<tr>
<td class="org-left">eager_load</td>
<td class="org-left">LEFT JOIN</td>
<td class="org-left">する</td>
<td class="org-left">できる</td>
<td class="org-left">LEFT JOINなので、相手が存在しなくても全部ロードしてしまう</td>
</tr>

<tr>
<td class="org-left">includes</td>
<td class="org-left">場合による</td>
<td class="org-left">する</td>
<td class="org-left">できる</td>
<td class="org-left">ただしく理解してないと挙動がコントロールできない</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li>preload
<ul class="org-ul">
<li>多対多のアソシエーションの場合
<ul class="org-ul">
<li><a href="20210725100835-sql.html#ID-8b69b8d4-1612-4dc5-8412-96b431fdd101">SQL</a>を分割して取得するため、レスポンスタイムが早くなるため</li>
</ul></li>
<li>アソシエーション先のデータ参照ができない</li>
<li>データ量が大きいと、メモリを圧迫する可能性がある</li>
</ul></li>

<li>eager_load
<ul class="org-ul">
<li>1対1あるいはN対1のアソシエーションをJOINする場合</li>
<li>JOIN先のテーブルを参照したい場合</li>
</ul></li>

<li>joins
<ul class="org-ul">
<li>メモリの使用量を必要最低限に抑えたい場合</li>
<li>JOINした先のデータを参照せず、絞り込み結果だけが必要な場合</li>
</ul></li>

<li>includes
<ul class="org-ul">
<li>なるべく使わない方がいい</li>
<li>条件によってpreloadとeager_loadを振り分ける</li>
</ul></li>

<li><a href="https://qiita.com/k0kubun/items/80c5a5494f53bb88dc58">ActiveRecordのjoinsとpreloadとincludesとeager_loadの違い - Qiita</a></li>
</ul>
</div>
</div>
<div id="outline-container-org52dc7de" class="outline-3">
<h3 id="org52dc7de"><a href="#org52dc7de">Railsの<a href="20210926150327-oss.html#ID-bb71747d-8599-4aee-b747-13cb44c05773">OSS</a></a></h3>
<div class="outline-text-3" id="text-org52dc7de">
<p>
Railsをどう書くかの参考になりそうなリポジトリ。
</p>

<ul class="org-ul">
<li><a href="https://github.com/gitlabhq/gitlabhq">gitlabhq/gitlabhq: GitLab CE Mirror | Please open new issues in our issue tracker on GitLab.com</a></li>
<li><a href="https://github.com/rubygems/rubygems.org">rubygems/rubygems.org: The Ruby community&rsquo;s gem hosting service.</a></li>
<li><a href="https://github.com/discourse/discourse">discourse/discourse: A platform for community discussion. Free, open, simple.</a></li>
<li><a href="https://github.com/mastodon/mastodon">mastodon/mastodon: Your self-hosted, globally interconnected microblogging community</a></li>
<li><a href="https://github.com/diaspora/diaspora">diaspora/diaspora: A privacy-aware, distributed, open source social network.</a></li>
<li><a href="https://github.com/forem/forem">forem/forem: For empowering community 🌱</a></li>
</ul>
</div>
</div>
<div id="outline-container-org17c5e53" class="outline-3">
<h3 id="org17c5e53"><a href="#org17c5e53">ルーティングのファイルと名前空間を切り出す</a></h3>
<div class="outline-text-3" id="text-org17c5e53">
<p>
<a href="https://qiita.com/sibakenY/items/973fbe635a7f91ae105c">Railsのルーティングをdrawを使ってまとめる - Qiita</a>
</p>

<p>
ファイル読み込みでルーティングのDSLを評価するメソッドを作る。
これによって、ファイルで名前空間を分割できる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 12: </span>config/initializers/draw_routes.rb</label><pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">DrawRoute</span>
  <span class="org-type">RoutesNotFound</span> = <span class="org-type">Class</span>.new(<span class="org-type">StandardError</span>)

  <span class="org-keyword">def</span> <span class="org-function-name">draw</span>(routes_name)
    drawn_any = draw_route(routes_name)

    drawn_any || <span class="org-builtin">raise</span>(<span class="org-type">RoutesNotFound</span>, <span class="org-string">"Cannot find </span><span class="org-variable-name">#{routes_name}</span><span class="org-string">"</span>)
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">route_path</span>(routes_name)
    <span class="org-type">Rails</span>.root.join(routes_name)
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">draw_route</span>(routes_name)
    path = route_path(<span class="org-string">"config/routes/</span><span class="org-variable-name">#{routes_name}</span><span class="org-string">.rb"</span>)
    <span class="org-keyword">if</span> <span class="org-type">File</span>.exist?(path)
      instance_eval(<span class="org-type">File</span>.read(path))
      <span class="org-constant">true</span>
    <span class="org-keyword">else</span>
      <span class="org-constant">false</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-type">ActionDispatch</span>::<span class="org-type">Routing</span>::<span class="org-type">Mapper</span>.prepend <span class="org-type">DrawRoute</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 13: </span>config/routes/admin.rb</label><pre class="src src-ruby">namespace <span class="org-constant">:admin</span> <span class="org-keyword">do</span>
  resources <span class="org-constant">:users</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 14: </span>routes.rb</label><pre class="src src-ruby"><span class="org-type">Rails</span>.application.routes.draw <span class="org-keyword">do</span>
  draw <span class="org-constant">:admin</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org64d0121" class="outline-3">
<h3 id="org64d0121"><a href="#org64d0121">時間関係</a></h3>
<div class="outline-text-3" id="text-org64d0121">
<p>
<a href="https://qiita.com/jnchito/items/cae89ee43c30f5d6fa2c">RubyとRailsにおけるTime, Date, DateTime, TimeWithZoneの違い - Qiita</a>
</p>
</div>
</div>
<div id="outline-container-orgf4c3f82" class="outline-3">
<h3 id="orgf4c3f82"><a href="#orgf4c3f82">ネストしたトランザクション</a></h3>
<div class="outline-text-3" id="text-orgf4c3f82">
<p>
ネストしたトランザクションでは内側のロールバックが、無視されるケースがある。
トランザクションを再利用するため。
なので、トランザクションを再利用しないように明示すればよい。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">ActiveRecord</span>::<span class="org-type">Base</span>.transaction(<span class="org-constant">joinable:</span> <span class="org-constant">false</span>, <span class="org-constant">requires_new:</span> <span class="org-constant">true</span>) <span class="org-keyword">do</span>
  <span class="org-comment-delimiter"># </span><span class="org-comment">inner code</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
<a href="https://qiita.com/jnchito/items/930575c18679a5dbe1a0">【翻訳】ActiveRecordにおける、ネストしたトランザクションの落とし穴 - Qiita</a>
<a href="https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html">ActiveRecord::Transactions::ClassMethods</a>
</p>
</div>
</div>
<div id="outline-container-orge866cbc" class="outline-3">
<h3 id="orge866cbc"><a href="#orge866cbc">Fakerでboolean生成</a></h3>
<div class="outline-text-3" id="text-orge866cbc">
<p>
↓以下2つは同じ意味。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 15: </span>fakerで</label><pre class="src src-rb">Faker::Boolean.boolean
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 16: </span>sampleで</label><pre class="src src-ruby">[<span class="org-constant">true</span>, <span class="org-constant">false</span>].sample
</pre>
</div>
</div>
</div>
<div id="outline-container-org1fecdeb" class="outline-3">
<h3 id="org1fecdeb"><a href="#org1fecdeb">マイグレーションでカラムの型を変える</a></h3>
<div class="outline-text-3" id="text-org1fecdeb">
<p>
usersのdeleted_atカラムをinteger型 から datetime型に変える例。
</p>

<ol class="org-ol">
<li>一時カラムを作ってそこで値を作成する</li>
<li>旧カラムを削除する</li>
<li>一時カラムの名前を変えて新カラムにする</li>
</ol>

<p>
<code>ActiveRecord::Base.connection.execute(sql)</code> を使うと生の<a href="20210725100835-sql.html#ID-8b69b8d4-1612-4dc5-8412-96b431fdd101">SQL</a>を実行できる。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">up</span>
  connection.execute <span class="org-string">'ALTER TABLE users ADD deleted_at_tmp datetime'</span>
  connection.execute <span class="org-string">'UPDATE users SET deleted_at_tmp = FROM_UNIXTIME(deleted_at)'</span>
  connection.execute <span class="org-string">'ALTER TABLE users DROP COLUMN deleted_at'</span>
  connection.execute <span class="org-string">'ALTER TABLE users CHANGE deleted_at_tmp deleted_at datetime'</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9c7e47a" class="outline-3">
<h3 id="org9c7e47a"><a href="#org9c7e47a">便利なデバッガweb-console</a></h3>
<div class="outline-text-3" id="text-org9c7e47a">
<p>
view内でブレークポイントを設定し、ブラウザ上でコンソールを立ち上げることができるライブラリ。
Railsにデフォルトで入っている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 18: </span>任意のview, controllerに追加する</label><pre class="src src-html">&lt;% console %&gt;
</pre>
</div>

<p>
あとは該当箇所にブラウザでアクセスするとコンソールが立ち上がる。
再実行性がないので、テストでやるのが一番だとは感じる。
</p>
</div>
</div>
<div id="outline-container-orgaab8923" class="outline-3">
<h3 id="orgaab8923"><a href="#orgaab8923">update_atを更新しない</a></h3>
<div class="outline-text-3" id="text-orgaab8923">
<p>
バッチ処理でいじった場合は更新するとよくないことがある。
</p>

<ul class="org-ul">
<li><a href="https://ohbarye.hatenablog.jp/entry/2016/08/02/213444">更新時に updated_at, created_at を更新しない - valid,invalid</a></li>
</ul>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-comment-delimiter"># </span><span class="org-comment">Active Record &#12524;&#12505;&#12523;</span>
<span class="org-type">ActiveRecord</span>::<span class="org-type">Base</span>.record_timestamps = <span class="org-constant">false</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">&#12514;&#12487;&#12523;&#12398;&#12415;</span>
<span class="org-type">User</span>.record_timestamps = <span class="org-constant">false</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">&#12452;&#12531;&#12473;&#12479;&#12531;&#12473;&#12398;&#12415;</span>
user.record_timestamps = <span class="org-constant">false</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org401a5cd" class="outline-3">
<h3 id="org401a5cd"><a href="#org401a5cd">save(validate: false)</a></h3>
<div class="outline-text-3" id="text-org401a5cd">
<p>
バリデーションが不要なとき、 <code>user.save!(validate: false)</code> とすると無効化できる。
データを不整合を直したいけどほかのバリデーションにかかる、ようなときに使う。
</p>

<p>
あるいは <code>assign_attribute</code> でもよい。
</p>
</div>
</div>
<div id="outline-container-org6434d4a" class="outline-3">
<h3 id="org6434d4a"><a href="#org6434d4a">presence: trueなのにnilがあるレコードを検知する</a></h3>
<div class="outline-text-3" id="text-org6434d4a">
<p>
モデルバリデーションがかかっていても、既存のレコードはnilを含む可能性がある。
モデルバリデーションは入出力のみ監視する。だから既存レコードに残っている可能性がある。
この場合、編集できなくて不便。検知してテーブルにも制約をかけると安全になる。DBバリデーションは、既存レコードにも入ってないことを保証できる。
</p>

<p>
直にテーブルの制約を辿る方法がわからないのでレコードを探索する感じになった。レコードがたくさんある環境で実行すると検知できる。全部辿るのでクソ重い。
</p>
<div class="org-src-container">
<pre class="src src-ruby">msgs = {}

<span class="org-type">Rails</span>.application.eager_load!
<span class="org-type">ApplicationRecord</span>.subclasses.each <span class="org-keyword">do</span> |model|
  presence_validates = model.validators.select { |v| v.class.to_s.include?(<span class="org-string">'ActiveRecord::Validations::PresenceValidator'</span>) }
  presence_validates.each <span class="org-keyword">do</span> |presence_validate|
    model.all.find_each <span class="org-keyword">do</span> |record|
      msgs[<span class="org-string">"</span><span class="org-variable-name">#{record.class}</span><span class="org-string"> </span><span class="org-variable-name">#{presence_validate.attributes.first}</span><span class="org-string">"</span>] = <span class="org-string">'&#10060; presence: true&#12354;&#12427;&#12398;&#12395;nil&#12524;&#12467;&#12540;&#12489;&#12364;&#12354;&#12427;&gt;&lt;'</span> <span class="org-keyword">unless</span> record.send(presence_validate.attributes.first)
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

pp msgs.sort <span class="org-comment-delimiter">#  </span><span class="org-comment">[["User name", "&#10060; presence: true&#12354;&#12427;&#12398;&#12395;nil&#12524;&#12467;&#12540;&#12489;&#12364;&#12354;&#12427;&gt;&lt;"]]</span>
</pre>
</div>

<p>
まずnilをなくす。それからテーブルのバリデーションを追加する。
</p>
</div>
</div>
<div id="outline-container-org888132d" class="outline-3">
<h3 id="org888132d"><a href="#org888132d">バックエンドエンジニアというときの正確なスコープ</a></h3>
<div class="outline-text-3" id="text-org888132d">
<p>
APIサーバとしての利用、バックとフロントの分割が主流になっている。
採用者がRailsのバックエンド開発者を探している、というときはAPI開発経験がある人材を探しているといえる。
</p>
</div>
</div>
<div id="outline-container-orgd244b2b" class="outline-3">
<h3 id="orgd244b2b"><a href="#orgd244b2b">テストによるスマートな画像確認</a></h3>
<div class="outline-text-3" id="text-orgd244b2b">
<p>
system specでスクショをとって確認する。
わざわざ用意して確認しない。
</p>

<p>
TDDを徹底し、一切ブラウザ確認せずにプロダクトを開発した、という偉人もいる。
</p>
</div>
</div>
<div id="outline-container-orga924b65" class="outline-3">
<h3 id="orga924b65"><a href="#orga924b65">オートロードするgem: zeitwerk</a></h3>
<div class="outline-text-3" id="text-orga924b65">
<p>
zeitwerkはオートロードするgem。Rails 6で使われている。
Railsでrequireしなくていいのはこれを使っているから。
<a href="https://github.com/fxn/zeitwerk">fxn/zeitwerk: Efficient and thread-safe code loader for Ruby</a>
</p>
</div>
</div>
<div id="outline-container-org7aaf478" class="outline-3">
<h3 id="org7aaf478"><a href="#org7aaf478">デフォルトスコープを無視できるreorder</a></h3>
<div class="outline-text-3" id="text-org7aaf478">
<p>
デフォルトスコープを無視できる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 19: </span>updated_atをソートに使う</label><pre class="src src-ruby"><span class="org-type">User</span>.order(<span class="org-constant">:id</span>).reorder(<span class="org-constant">:updated_at</span>)
</pre>
</div>
</div>
</div>

<div id="outline-container-org3b60492" class="outline-3">
<h3 id="org3b60492"><a href="#org3b60492">開発用データの用意</a></h3>
<div class="outline-text-3" id="text-org3b60492">
<p>
開発用データにはいくつかの方法がある。
</p>

<ul class="org-ul">
<li>seedデータで用意する。毎回必要なときにresetして開発する
<ul class="org-ul">
<li>クリーンな環境で再現性が高い開発を行える。</li>
<li>早い</li>
</ul></li>

<li>本番データに近いデータで行う
<ul class="org-ul">
<li>デザインや性能の問題に気づきやすい</li>
<li>ユースケースがイメージしやすい</li>
<li>データの準備が楽</li>
<li>整合性のメンテナンスが必要</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org93369b1" class="outline-3">
<h3 id="org93369b1"><a href="#org93369b1">ALTER TABLEは重い</a></h3>
<div class="outline-text-3" id="text-org93369b1">
<p>
テーブルのコピーを作るので重い。
bulk: trueをつけるとALTER TABLEをまとめるので高速になる。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">up</span>
  change_table <span class="org-constant">:legal_engine_forms</span>, <span class="org-constant">bulk:</span> <span class="org-constant">true</span> <span class="org-keyword">do</span> |t|
    ...
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org74e246a" class="outline-3">
<h3 id="org74e246a"><a href="#org74e246a">テーブル名にプレフィクスを設定する</a></h3>
<div class="outline-text-3" id="text-org74e246a">
<p>
特定の機能に対して、関係したテーブルを複数つくるとき、プレフィクスのような形でモデル名やテーブル名を決めることがある。
admin_user、admin_page、admin_permissionとか。
こうすることの問題点: 衝突を避けるためにmodel名とテーブル名が長くなる。ディレクトリも見にくくなる。一語だとまだいいのだが、複数名になるとつらくなる。
</p>

<p>
解決のためには、moduleを定義し、内部でtable_name_prefixを設定するといい。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 20: </span>modelにて</label><pre class="src src-ruby"><span class="org-keyword">module</span> <span class="org-type">Admin</span>
  <span class="org-keyword">def</span> <span class="org-keyword">self</span>.<span class="org-function-name">table_name_prefix</span>
    <span class="org-string">'admin_'</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-keyword">module</span> <span class="org-type">Admin</span>
  <span class="org-keyword">class</span> <span class="org-type">User</span> &lt; <span class="org-type">ApplicationRecord</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
こうするとモデル名はAdmin::Userで、テーブル名はadmin_usersになりわかりやすい。
</p>
</div>
</div>
<div id="outline-container-org3b12c53" class="outline-3">
<h3 id="org3b12c53"><a href="#org3b12c53">Rails環境でバッチ処理する</a></h3>
<div class="outline-text-3" id="text-org3b12c53">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 21: </span>Rails環境でのクラスを実行できる</label><pre class="src src-ruby">rails runner <span class="org-string">"User.first"</span>
rails r <span class="org-string">"User.first"</span>
</pre>
</div>

<p>
サービスクラス化したコマンドを実行するときに使える。
</p>
</div>
</div>
<div id="outline-container-org9b336e1" class="outline-3">
<h3 id="org9b336e1"><a href="#org9b336e1">routesの制約</a></h3>
<div class="outline-text-3" id="text-org9b336e1">
<div class="org-src-container">
<pre class="src src-ruby">constraints(-&gt; (req) { req.env[<span class="org-string">"HTTP_USER_AGENT"</span>] =~ <span class="org-string">/iPhone/</span> }) <span class="org-keyword">do</span>
  resources <span class="org-constant">:iphones</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
<a href="https://api.rubyonrails.org/v6.0.2/classes/ActionDispatch/Routing/Mapper/Scoping.html#method-i-constraints-label-Dynamic+request+matching">ActionDispatch::Routing::Mapper::Scoping</a>
</p>
</div>
</div>
<div id="outline-container-org07334b0" class="outline-3">
<h3 id="org07334b0"><a href="#org07334b0">大量のroutes変更を楽に確認する</a></h3>
<div class="outline-text-3" id="text-org07334b0">
<p>
redirect設定やリファクタリングでroutesを大量に変更して、挙動の変更を追いたい場合。
rails routesの結果のdiffを取れば、楽に確認できる。
</p>
</div>
</div>
<div id="outline-container-orgdb29fb3" class="outline-3">
<h3 id="orgdb29fb3"><a href="#orgdb29fb3">create_or_find_by</a></h3>
<div class="outline-text-3" id="text-orgdb29fb3">
<p>
データベースのユニーク制約を使って作成、できなければ初めの1件を取得する。
find_or_create_byでは作成されるまでに別プロセスによって作成されている可能性があったので、その問題を解決した処理。
<code>create_or_find_by!</code> はエラーの時に例外が発生する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 22: </span>データベースのユニーク制約を使って作成、できなければ初めの1件を取得</label><pre class="src src-ruby"><span class="org-type">User</span>.create_or_find_by(<span class="org-constant">name:</span> <span class="org-string">'aaa'</span>)
</pre>
</div>

<p>
<a href="https://railsdoc.com/page/create_or_find_by">create_or_find_by | Railsドキュメント</a>
</p>
</div>
</div>
<div id="outline-container-org3c67aa1" class="outline-3">
<h3 id="org3c67aa1"><a href="#org3c67aa1">使われてないファイルを検索する</a></h3>
<div class="outline-text-3" id="text-org3c67aa1">
<p>
assetsは相対パスが利用されないので絶対パスで検索してヒットしなければ未使用と判断できる、とのこと。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 23: </span>検査タスクの例</label><pre class="src src-ruby">namespace <span class="org-constant">:assets</span> <span class="org-keyword">do</span>
  desc <span class="org-string">'prune needless image file'</span>
  task <span class="org-string">'prune:images'</span> =&gt; <span class="org-constant">:environment</span> <span class="org-keyword">do</span>
    base = <span class="org-type">Rails</span>.root.join(<span class="org-string">'app/assets/images/'</span>)

    <span class="org-type">Dir</span>[<span class="org-type">Rails</span>.root.join(<span class="org-string">'app/assets/images/**/*.{jpg,jpeg,gif,png,svg}'</span>)].each <span class="org-keyword">do</span> |path|
      target_path = path.to_s.gsub(<span class="org-string">/</span><span class="org-variable-name">#{base}</span><span class="org-string">/</span>, <span class="org-string">''</span>)
      <span class="org-builtin">puts</span> <span class="org-string">"execute: git grep '</span><span class="org-variable-name">#{target_path}</span><span class="org-string">'"</span>
      res = <span class="org-string">`git grep '</span><span class="org-variable-name">#{target_path}</span><span class="org-string">'`</span>

      <span class="org-keyword">if</span> res.empty?
        <span class="org-builtin">puts</span> <span class="org-string">"execute: rm </span><span class="org-variable-name">#{path}</span><span class="org-string">"</span>
        <span class="org-type">FileUtils</span>.rm path
        <span class="org-builtin">puts</span> <span class="org-string">'=&gt; removed'</span>
      <span class="org-keyword">else</span>
        <span class="org-builtin">puts</span> <span class="org-string">'=&gt; used somewhere'</span>
      <span class="org-keyword">end</span>

      puts
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org71d3ad9" class="outline-3">
<h3 id="org71d3ad9"><a href="#org71d3ad9"><a href="20210509095513-ruby.html#ID-cfd092c4-1bb2-43d3-88b1-9f647809e546">Ruby</a>バージョンアップデート</a></h3>
<div class="outline-text-3" id="text-org71d3ad9">
<p>
超強い人が言っていたメモ。
コマンドを組み合わせて一気に置換して検討していく。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 24: </span>2.6.5 -&gt; 2.7.1に全体を置換する</label><pre class="src src-shell">git grep -l <span class="org-string">'2\.6\.5'</span> | xargs sed -i <span class="org-string">'s/2\.6\.5/2.7.1/g'</span>
</pre>
</div>
<p>
vendor/bundle を削除して、bundle install。
マイナーバージョンを変更した場合は .rubocop.yml の RUBY_VERSION を修正(parser gemの指定)。
</p>
</div>
</div>
<div id="outline-container-org16abb81" class="outline-3">
<h3 id="org16abb81"><a href="#org16abb81">新規作成時はform表示しない</a></h3>
<div class="outline-text-3" id="text-org16abb81">
<p>
formを共通化しているようなとき。
このカラムはedit時のみ出したい、というようなことがある。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 25: </span>new時persistされてないので表示されない</label><pre class="src src-ruby">form_for <span class="org-keyword">do</span> |f|
  f.number_field <span class="org-constant">:position</span> <span class="org-keyword">if</span> <span class="org-variable-name">@content_category</span>.persisted?
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org1fd2797" class="outline-3">
<h3 id="org1fd2797"><a href="#org1fd2797">一部アクションだけvalidation</a></h3>
<div class="outline-text-3" id="text-org1fd2797">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 26: </span>onでアクションを指定できる。</label><pre class="src src-ruby">validates <span class="org-constant">:user_id</span>, <span class="org-constant">presence:</span> <span class="org-constant">true</span>, <span class="org-constant">:on</span> =&gt; <span class="org-constant">:create</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb9c1aa3" class="outline-3">
<h3 id="orgb9c1aa3"><a href="#orgb9c1aa3">便利な日付操作</a></h3>
<div class="outline-text-3" id="text-orgb9c1aa3">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 27: </span>Time.zone</label><pre class="src src-ruby"><span class="org-type">Time</span>.zone.yesterday
<span class="org-type">Time</span>.zone.today.ago(7.days)
</pre>
</div>

<p>
<a href="https://qiita.com/mmmm/items/efda48f1ac0267c95c29">Railsでの日付操作でよく使うものまとめ - Qiita</a>
</p>
</div>
</div>
<div id="outline-container-org84c44ef" class="outline-3">
<h3 id="org84c44ef"><a href="#org84c44ef">安全に関連カラムを追加する</a></h3>
<div class="outline-text-3" id="text-org84c44ef">
<p>
Blogにuser_idを後から追加したい、みたいなとき。User -&lt; Blog。
最初にnullableで外部キーを作成する。
</p>

<p>
次に、新規作成時にmodelでvalidationをかける。
すると既存レコードの外部キーはnull、新しくできるレコードは外部キーありという状態になる。
外部キーなしが増えることはない。移行をする。
nullのレコードがゼロになってから外部キー制約をつけて関連カラム追加完了。
</p>
</div>
</div>
<div id="outline-container-org95877a8" class="outline-3">
<h3 id="org95877a8"><a href="#org95877a8">関連カラムを安全に変更する</a></h3>
<div class="outline-text-3" id="text-org95877a8">
<p>
レコードがすでに入っているテーブルの関連を変更する場合。
たとえば、blogs &gt;- somethings &gt;- users を blogs &gt;- users というような。somethingsテーブルは何もしてないので削除したい、とする。
何も考えずにやると、一気にすべてを切り替えることになりがち。
</p>

<p>
悪い例を示す。
</p>
<ol class="org-ol">
<li><p>
最初に関連カラムを変更する。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 28: </span>modelファイルで関連変更</label><pre class="src src-ruby">belongs_to <span class="org-constant">:user</span> <span class="org-comment-delimiter"># </span><span class="org-comment">&#26087; belongs_to :something</span>
</pre>
</div></li>
<li>旧関連を使ってたアプリケーション側をすべて変更する。MVCすべて。</li>
<li>新しい関連カラムは空で、旧データを移行しないといけない。移行は↑のデプロイと同時にしないと不整合になる。デプロイと移行スクリプトの間の変更は無視されるから。</li>
<li>1~3をまとめて一気にリリースする</li>
</ol>

<p>
ということで、大量な複数層の変更をぶっつけ本番でしないといけなくなる。途中で嫌になるだろうし、運が悪ければミスって大変なことになる。
</p>

<p>
ではどうするか。根本的なアイデアは、2つの関連を同時に保持しておくことだ。
同時に持っておけば、大丈夫なことを確認してから関連を変更するだけでいい。そうやって遅延させることで、一気にいろいろな変更をしなくてよくなる。
</p>

<p>
具体的にどうやるか。良い例。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 29: </span>modelのbefore_saveでオンデマンドコピー</label><pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Blog</span> &lt; <span class="org-type">ApplicationRecord</span>
  before_save <span class="org-keyword">do</span>
    <span class="org-keyword">self</span>.user_id ||= something.user_id
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
としておくと、保存時にblog.user_idとblog.something.user_idの両方に関連がコピーされる。somethingsを経由しないでよくなる。
</p>

<p>
既存データについても処理を追加しておく。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 30: </span>modelにメソッドを作っておく</label><pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">User</span> &lt; <span class="org-type">ApplicationRecord</span>
  <span class="org-keyword">def</span> <span class="org-function-name">migrate</span>
    <span class="org-keyword">self</span>.user_id ||= something.user_id
    save!
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
<p>
そして、全Userでmigrateを実行すれば既存データにも新しいカラムが入る。
</p>

<p>
既存データと新しく作成されるレコードをおさえたので、新旧2つの関連カラムは完全に同等になる。
ここまででマージ、リリースする。
問題ないことを確認したあとで、新旧カラムが使える状態を活かしてアプリケーション側の変更…実際の関連の変更をやる(一番の目的の箇所)。
ここまででマージ、リリースする。
</p>

<p>
その後、移行処理とカラムを削除して片付ければ完了。(あるいは移行処理は前の時点で消す)
関連カラムだけでなく、何かカラムを移すときにはすべて同様にできる。
</p>

<p>
実際のタスクでは、migration処理をする箇所は複数になるので前もって調査が必要。
</p>
</div>
</div>
<div id="outline-container-org885bdab" class="outline-3">
<h3 id="org885bdab"><a href="#org885bdab">カラム名を安全に変更する</a></h3>
<div class="outline-text-3" id="text-org885bdab">
<p>
カラム名変更とアプリケーション側の変更を分け、変更範囲を狭める。
alias_attributeを追加する。すると、新しいカラム名でもアクセスできるようになる。
依存しているほかのアプリケーションの変更をする(new_user_idに書き換える)。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 31: </span>modelファイルにて、追加</label><pre class="src src-ruby">alias_attribute <span class="org-constant">:new_user_id</span>, <span class="org-constant">:typo_user_id</span>
</pre>
</div>

<p>
それらを書き換えたらマージ、リリースする。
その後、カラム名を書き換えるマイグレーションを作成する。使っている箇所はないので安全に変更できる。
マイグレーション後、alias_attributeを削除する。
</p>
</div>
</div>
<div id="outline-container-org4069ec1" class="outline-3">
<h3 id="org4069ec1"><a href="#org4069ec1">テーブル名を安全に変更する</a></h3>
<div class="outline-text-3" id="text-org4069ec1">
<p>
最初にmodel クラス名を変更し、テーブルの参照先に変更前のものを設定する。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Blog_After</span> &lt; <span class="org-type">ApplicationRecord</span>
  <span class="org-keyword">self</span>.table_name = <span class="org-constant">:blog_before</span>
<span class="org-keyword">end</span>
</pre>
</div>
<p>
すると、アプリケーション側だけの変更で、DBの変更はない状態で動作上の変更はなくなる。
次にアプリケーションの、ほかの依存している箇所を修正する。
ここまで1つのPRにする。
</p>

<p>
テストが通ったりリリースできたら、テーブル名変更のマイグレーションを作成し、modelでのtable_name設定を削除するPRをつくる。
安全に変更が完了する。
テーブルの変更と、アプリケーションの変更を同時にやらないと安全だし分割できてすっきりする。
</p>
</div>
</div>
<div id="outline-container-orgc6db01b" class="outline-3">
<h3 id="orgc6db01b"><a href="#orgc6db01b">modelのログを保持する</a></h3>
<div class="outline-text-3" id="text-orgc6db01b">
<p>
<a href="https://github.com/paper-trail-gem/paper_trail">paper-trail-gem/paper_trail: Track changes to your rails models</a>
変更や差分、変更時の何らかの情報(つまり、作業者とか)を保存、閲覧できる。
</p>

<p>
<a href="https://github.com/ankit1910/paper_trail-globalid">ankit1910/paper_trail-globalid: An extension to paper_trail, using this you can fetch actual object who was responsible for this change</a>
paper_trailの拡張。変更したか取得できるようになる。
</p>
</div>
</div>
<div id="outline-container-org92c1030" class="outline-3">
<h3 id="org92c1030"><a href="#org92c1030">サロゲートキー</a></h3>
<div class="outline-text-3" id="text-org92c1030">
<p>
Railsでいうところの <code>id</code> のこと。Rails5 からはbigintで設定されている。
主キーとして使う人工的な値、というのがポイント。
</p>

<p>
<a href="https://e-words.jp/w/%E3%82%B5%E3%83%AD%E3%82%B2%E3%83%BC%E3%83%88%E3%82%AD%E3%83%BC.html">サロゲートキー（surrogate key）とは - IT用語辞典 e-Words</a>
</p>
<blockquote>
<p>
サロゲートキーとは、データベースのテーブルの主キーとして、自動割り当ての連続した通し番号のように、利用者や記録する対象とは直接関係のない人工的な値を用いること。また、そのために設けられたカラムのこと。
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org35dd6d1" class="outline-3">
<h3 id="org35dd6d1"><a href="#org35dd6d1">ロールバックできないマイグレーションであることを明示する</a></h3>
<div class="outline-text-3" id="text-org35dd6d1">
<p>
たいていの場合はコメントでロールバックできないなどと書けばよいが、rollbackが破壊的な動作になる場合があるのでdownに書く。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 32: </span>ActiveRecord::IrreversibleMigration</label><pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">down</span>
  <span class="org-builtin">raise</span> <span class="org-type">ActiveRecord</span>::<span class="org-type">IrreversibleMigration</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org01e187b" class="outline-3">
<h3 id="org01e187b"><a href="#org01e187b">null制約を追加しつつdefault設定</a></h3>
<div class="outline-text-3" id="text-org01e187b">
<p>
<a href="https://qiita.com/akinov/items/852fe789fe98a44350a9">Railsのmigrationで後からNULL制約を設定する - Qiita</a>
</p>

<p>
null制約追加には、 <code>change_column_null</code> を使う。
null制約だけ追加すると変更前にnullだったレコードでエラーになってしまうので、同時にdefaultを設定するとよい。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 33: </span>null制約 + default設定</label><pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">ChangePointColumnOnPost</span> &lt; <span class="org-type">ActiveRecord</span>::<span class="org-type">Migration</span>[5.2]
  <span class="org-keyword">def</span> <span class="org-function-name">change</span>
    change_column_null <span class="org-constant">:posts</span>, <span class="org-constant">:point</span>, <span class="org-constant">false</span>, 0
    change_column_default <span class="org-constant">:posts</span>, <span class="org-constant">:point</span>, <span class="org-constant">from:</span> <span class="org-constant">nil</span>, <span class="org-constant">to:</span> 0
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 34: </span>↑falseはnullオプション</label><pre class="src src-ruby">change_column_null(table_name, column_name, null, default = <span class="org-constant">nil</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgdb2b4ff" class="outline-3">
<h3 id="orgdb2b4ff"><a href="#orgdb2b4ff">migrationファイルによる不整合解消タスク</a></h3>
<div class="outline-text-3" id="text-orgdb2b4ff">
<p>
migrationファイルは一部DSLが扱われるだけで普通のrubyファイルと変わらない。
データベースの不整合を解消することにも使える。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">def</span> <span class="org-function-name">up</span>
  <span class="org-type">Blog</span>.unscoped.where(<span class="org-constant">user_id:</span> <span class="org-constant">nil</span>).delete_all
<span class="org-keyword">end</span>
</pre>
</div>
<p>
というように。
環境別にconsoleでコマンドを実行する必要がないので便利。
</p>
</div>
</div>
<div id="outline-container-orge9fcaa8" class="outline-3">
<h3 id="orge9fcaa8"><a href="#orge9fcaa8">unscopedでdefault_scopeを無効化</a></h3>
<div class="outline-text-3" id="text-orge9fcaa8">
<p>
<code>unscoped</code> はdefault_scopeを無効化する。
<a href="https://apidock.com/rails/ActiveRecord/Base/unscoped/class">unscoped (ActiveRecord::Base) - APIdock</a>
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 36: </span>自動でpublishedの条件が発行されていることがわかる</label><pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Post</span> &lt; <span class="org-type">ActiveRecord</span>::<span class="org-type">Base</span>
  <span class="org-keyword">def</span> <span class="org-keyword">self</span>.<span class="org-function-name">default_scope</span>
    where <span class="org-constant">:published</span> =&gt; <span class="org-constant">true</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>

<span class="org-type">Post</span>.all          <span class="org-comment-delimiter"># </span><span class="org-comment">Fires "SELECT * FROM posts WHERE published = true"</span>
<span class="org-type">Post</span>.unscoped.all <span class="org-comment-delimiter"># </span><span class="org-comment">Fires "SELECT * FROM posts"</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 37: </span>default_scopeの条件がなくなる</label><pre class="src src-ruby"><span class="org-type">Post</span>.unscoped {
  <span class="org-type">Post</span>.limit(10) <span class="org-comment-delimiter"># </span><span class="org-comment">Fires "SELECT * FROM posts LIMIT 10"</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org1a7fed1" class="outline-3">
<h3 id="org1a7fed1"><a href="#org1a7fed1">inverse_ofで双方向の不整合を防ぐ</a></h3>
<div class="outline-text-3" id="text-org1a7fed1">
<p>
<a href="https://qiita.com/itp926/items/9cac175d3b35945b8f7e">inverse_of について - Qiita</a>
</p>

<p>
双方向の関連付けの不整合を防ぐ関連オプション。belongs_to, has_many等ではデフォルトでオンになっているよう。
</p>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">Category</span>
  has_many <span class="org-constant">:blog</span>
<span class="org-keyword">end</span>

<span class="org-keyword">class</span> <span class="org-type">Order</span>
  belongs_to <span class="org-constant">:category</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 39: </span>不整合</label><pre class="src src-ruby">c = <span class="org-type">Category</span>.first
b = c.orders.first

c.title = <span class="org-string">"change"</span>
c.title == b.category.title <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt; false &#20516;&#12399;&#30064;&#12394;&#12427;</span>
c.equal? b.category <span class="org-comment-delimiter">#</span><span class="org-comment">=&gt; false &#21516;&#12376;&#12458;&#12502;&#12472;&#12455;&#12463;&#12488;&#12391;&#12394;&#12356;</span>
</pre>
</div>
<p>
inverse_ofを使うと同じオブジェクトを使うようになる。
</p>
</div>
</div>
<div id="outline-container-org75f64e2" class="outline-3">
<h3 id="org75f64e2"><a href="#org75f64e2">リレーションの不整合を検知する</a></h3>
<div class="outline-text-3" id="text-org75f64e2">
<p>
よくわからない。
全部辿る方法は色々応用が効きそう。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 40: </span>不整合検知タスク</label><pre class="src src-ruby">desc <span class="org-string">'&#22806;&#37096;&#12461;&#12540;&#12398;&#25972;&#21512;&#24615;&#12434;&#26908;&#35388;&#12377;&#12427;'</span>
task <span class="org-constant">extract_mismatch_records:</span> <span class="org-constant">:environment</span> <span class="org-keyword">do</span>
  <span class="org-type">Rails</span>.application.eager_load!

  <span class="org-type">ApplicationRecord</span>.subclasses.each <span class="org-keyword">do</span> |model|
    model.reflections.select { |_, reflection| reflection.is_a?(<span class="org-type">ActiveRecord</span>::<span class="org-type">Reflection</span>::<span class="org-type">BelongsToReflection</span>) }.each <span class="org-keyword">do</span> |name, reflection|
      model_name = model.model_name.human
      foreign_key = reflection.options[<span class="org-constant">:foreign_key</span>] || <span class="org-string">"</span><span class="org-variable-name">#{name}</span><span class="org-string">_id"</span>

      <span class="org-keyword">unless</span> model.columns.any? { |column| column.name == foreign_key.to_s }
        <span class="org-builtin">puts</span> <span class="org-string">"&#128162; </span><span class="org-variable-name">#{model_name}</span><span class="org-string"> &#12395;&#12399; </span><span class="org-variable-name">#{foreign_key}</span><span class="org-string"> &#12501;&#12451;&#12540;&#12523;&#12489;&#12364;&#12354;&#12426;&#12414;&#12379;&#12435;"</span>
        <span class="org-keyword">next</span>
      <span class="org-keyword">end</span>

      parent_model_class_name = reflection.options[<span class="org-constant">:class_name</span>] || reflection.name.to_s.classify
      parent_model = parent_model_class_name.safe_constantize

      <span class="org-keyword">unless</span> parent_model
        <span class="org-builtin">puts</span> <span class="org-string">"&#128162; </span><span class="org-variable-name">#{model_name}</span><span class="org-string"> &#12364;&#20381;&#23384;&#12375;&#12390;&#12356;&#12427; </span><span class="org-variable-name">#{parent_model_class_name}</span><span class="org-string"> &#12399;&#21442;&#29031;&#12391;&#12365;&#12414;&#12379;&#12435;"</span>
        <span class="org-keyword">next</span>
      <span class="org-keyword">end</span>

      parent_model_name = parent_model.model_name.human

      <span class="org-keyword">begin</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">NOTE: &#35242;&#12486;&#12540;&#12502;&#12523;&#12398;ID&#12392;&#12375;&#12390;&#23384;&#22312;&#12375;&#12394;&#12356;&#22806;&#37096;&#12461;&#12540;&#12398;&#25968;&#12434;&#29031;&#20250;</span>
        relation = model.unscoped.where.not(foreign_key =&gt; parent_model.unscoped.select(<span class="org-constant">:id</span>)).where.not(foreign_key =&gt; <span class="org-constant">nil</span>)
        sql = relation.to_sql
        count = relation.count

        <span class="org-keyword">if</span> count.zero?
          <span class="org-builtin">puts</span> <span class="org-string">"&#128161; </span><span class="org-variable-name">#{model_name}</span><span class="org-string"> &#12398; </span><span class="org-variable-name">#{parent_model_name}</span><span class="org-string"> &#12398;&#22806;&#37096;&#12461;&#12540;&#12399;&#25972;&#21512;&#24615;&#12364;&#20445;&#35388;&#12373;&#12428;&#12390;&#12356;&#12414;&#12377;"</span> <span class="org-keyword">unless</span> <span class="org-type">ENV</span>[<span class="org-string">'ONLY_FAILURE'</span>]
        <span class="org-keyword">else</span>
          <span class="org-builtin">puts</span> <span class="org-string">"&#128163; </span><span class="org-variable-name">#{model_name}</span><span class="org-string"> &#12398; </span><span class="org-variable-name">#{parent_model_name}</span><span class="org-string"> &#12398;&#22806;&#37096;&#12461;&#12540;&#12391;&#19981;&#27491;&#12394;&#12461;&#12540;&#12364; </span><span class="org-variable-name">#{count}</span><span class="org-string"> &#20214; &#35373;&#23450;&#12373;&#12428;&#12390;&#12356;&#12414;&#12377;"</span>
        <span class="org-keyword">end</span>

        <span class="org-keyword">if</span> <span class="org-type">ENV</span>[<span class="org-string">'DEBUG'</span>]
          <span class="org-builtin">puts</span> <span class="org-string">"=&gt; </span><span class="org-variable-name">#{sql}</span><span class="org-string">\n"</span>
          puts
        <span class="org-keyword">end</span>
      <span class="org-keyword">rescue</span> <span class="org-type">StandardError</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">NOTE: &#12510;&#12473;&#12479;&#12487;&#12540;&#12479;&#12398;&#22580;&#21512;&#12399;&#12473;&#12461;&#12483;&#12503;</span>
        <span class="org-builtin">puts</span> <span class="org-string">"&#127539; </span><span class="org-variable-name">#{model_name}</span><span class="org-string"> &#12398; </span><span class="org-variable-name">#{parent_model_name}</span><span class="org-string"> &#12398;&#25972;&#21512;&#24615;&#12398;&#26908;&#35388;&#12434;&#12473;&#12461;&#12483;&#12503;&#12375;&#12414;&#12375;&#12383;"</span> <span class="org-keyword">unless</span> <span class="org-type">ENV</span>[<span class="org-string">'ONLY_FAILURE'</span>]
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
Reflectionクラスはアソシエーション関係のmoduleのよう。
<a href="https://github.com/kd-collective/rails/blob/f132be462b957ea4cd8b72bf9e7be77a184a887b/activerecord/lib/active_record/reflection.rb#L49">https://github.com/kd-collective/rails/blob/f132be462b957ea4cd8b72bf9e7be77a184a887b/activerecord/lib/active_record/reflection.rb#L49</a>
</p>

<blockquote>
<p>
Reflection enables the ability to examine the associations and aggregations of Active Record classes and objects. This information, for example, can be used in a form builder that takes an Active Record object and creates input fields for all of the attributes depending on their type and displays the associations to other objects.
</p>

<p>
Reflectionを使用すると、Active Recordのクラスやオブジェクトの関連付けや集計を調べることができます。この情報は、例えば、Active Recordオブジェクトを受け取り、その型に応じてすべての属性の入力フィールドを作成します。他のオブジェクトとの関連を表示するフォームビルダーで使用できます。
</p>
</blockquote>

<p>
Reflectionに関する記事。
<a href="https://qiita.com/kkyouhei/items/067d5bb8d79c71f1646b">Railsのコードを読む アソシエーションについて - Qiita</a>
</p>
</div>
</div>
<div id="outline-container-org47953f8" class="outline-3">
<h3 id="org47953f8"><a href="#org47953f8">クエリ高速化</a></h3>
<div class="outline-text-3" id="text-org47953f8">
<p>
ネストしてクエリを発行してるときは何かがおかしい。
</p>

<ul class="org-ul">
<li>parent_category -&gt; category -&gt; blog のような構造</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 41: </span>ひどいクエリメソッド</label><pre class="src src-ruby">parent_categories.each <span class="org-keyword">do</span> |parent_category|
  parent_category.categories.each <span class="org-keyword">do</span> |category|
    category.blogs.each <span class="org-keyword">do</span> |blog|
      <span class="org-variable-name">@content</span> &lt;&lt; blog.content
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<ul class="org-ul">
<li>parent_category -&gt; category -&gt; blog</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 42: </span>joins</label><pre class="src src-ruby"><span class="org-type">Blog</span>.joins(<span class="org-constant">categories:</span> category)
  .merge(<span class="org-type">Category</span>.where(<span class="org-constant">parent_category:</span> parent_large_categories))
</pre>
</div>
</div>
</div>
<div id="outline-container-org7fa2ea9" class="outline-3">
<h3 id="org7fa2ea9"><a href="#org7fa2ea9">Migrationファイルをまとめて高速化する</a></h3>
<div class="outline-text-3" id="text-org7fa2ea9">
<p>
Migrationファイルは変更しないのが基本だが、数が多い場合、 <code>rails migrate:reset</code> に時間がかかる。
</p>

<p>
db/schema.rbの内容を、最新のタイムスタンプのマイグレーションにコピーする。
</p>

<ul class="org-ul">
<li>つまり現在のDB状況が、そのまま1つのmigrationとなる。DSLが同じなので問題ない。</li>
<li>migrationのタイムスタンプは既に実行済みのため、動作に影響しない。</li>
</ul>
</div>
</div>
<div id="outline-container-orgbef752a" class="outline-3">
<h3 id="orgbef752a"><a href="#orgbef752a">Gemfileで環境指定する</a></h3>
<div class="outline-text-3" id="text-orgbef752a">
<p>
Gemfileのgroupキーワードは、指定環境でしかインストールしないことを示す。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 43: </span>developmentでしかインストールされない</label><pre class="src src-ruby">group <span class="org-constant">:development</span> <span class="org-keyword">do</span>
  gem <span class="org-string">'annotate'</span>, <span class="org-builtin">require</span>: <span class="org-constant">false</span>
<span class="org-keyword">end</span>
</pre>
</div>

<p>
なので環境を指定せずにテストを実行したとき、gem not foundが出る。実行されたのがdevelopment環境で、テストのgemが読み込まれてないから。 <code>RAILS_ENV=test</code> がついているか確認する。
</p>
</div>
</div>
<div id="outline-container-org7ab0f14" class="outline-3">
<h3 id="org7ab0f14"><a href="#org7ab0f14">論理削除と物理削除</a></h3>
<div class="outline-text-3" id="text-org7ab0f14">
<p>
論理削除は削除したときレコードを削除するのではなく、フラグをトグルするもの。
逆に物理削除はレコードから削除すること。
</p>

<p>
論理削除のメリットは、データが戻せること。
</p>

<p>
が、データベースの運用的に、後から問題となることの方が多い。
</p>

<ul class="org-ul">
<li>削除フラグを付け忘れると事故になる。削除したはずなのに表示したり、計算に入れたりしてしまう</li>
<li>データが多くなるためパフォーマンスが悪くなる</li>
</ul>

<p>
Railsではgem act_as_paranoidを使って簡単に論理削除処理を追加できる。deleted_atカラムを論理削除を管理するフラグとして用いる。
</p>
</div>
</div>
<div id="outline-container-org1e21a94" class="outline-3">
<h3 id="org1e21a94"><a href="#org1e21a94">find、find_by、whereの違い</a></h3>
<div class="outline-text-3" id="text-org1e21a94">
<p>
<a href="https://qiita.com/tsuchinoko_run/items/f3926caaec461cfa1ca3">find、find_by、whereの違い - Qiita</a>
</p>

<dl class="org-dl">
<dt>find</dt><dd>各モデルのidを検索キーとしてデータを取得するメソッド。モデルインスタンスが返る</dd>
<dt>find_by</dt><dd>id以外をキーとして検索。複数あった場合は最初だけ取る。モデルインスタンスが返る。</dd>
<dt>where</dt><dd>id以外をキーとして検索。モデルインスタンスの入った配列が返る。</dd>
</dl>
</div>
</div>
<div id="outline-container-org5ab5f70" class="outline-3">
<h3 id="org5ab5f70"><a href="#org5ab5f70">acts_as_list</a></h3>
<div class="outline-text-3" id="text-org5ab5f70">
<p>
acts_as_listは順番を管理するgem。
<a href="https://github.com/brendon/acts_as_list">brendon/acts_as_list: An ActiveRecord plugin for managing lists.</a>
</p>

<p>
順番の生成と、操作を可能にする。
modelに順番カラムを指定すると、create時に自動で番号が格納される。
逆にフォームで番号格納しているとそれが優先して入るため自動採番されない。
new時には番号フォームを表示しないなどが必要。
</p>
</div>
</div>
<div id="outline-container-org2b1366c" class="outline-3">
<h3 id="org2b1366c"><a href="#org2b1366c">テーブル名と名前空間</a></h3>
</div>
<div id="outline-container-org395decb" class="outline-3">
<h3 id="org395decb"><a href="#org395decb">pluck</a></h3>
<div class="outline-text-3" id="text-org395decb">
<p>
<code>pluck</code> は、各レコードを丸ごとオブジェクトとしてとってくるのではなく、引数で指定したカラムのみの <b>配列</b> で返すメソッド。
<a href="https://railsdoc.com/page/model_pluck">pluck | Railsドキュメント</a>
</p>

<p>
<code>select</code> はカラム指定というところは同じだがオブジェクトを返す。
</p>
</div>
</div>
<div id="outline-container-org6b52325" class="outline-3">
<h3 id="org6b52325"><a href="#org6b52325">まとめて処理して高速化</a></h3>
<div class="outline-text-3" id="text-org6b52325">
<p>
1つ1つ処理するのではなくて、同時に複数のレコードを処理することで高速化する。
</p>
</div>
</div>
<div id="outline-container-orgb7b9b68" class="outline-3">
<h3 id="orgb7b9b68"><a href="#orgb7b9b68">該当レコード数が莫大な場合</a></h3>
<div class="outline-text-3" id="text-orgb7b9b68">
<p>
メモリに全体を展開するのでなく、ある数ずつ展開してメモリ消費を抑える。
</p>

<p>
<a href="https://railsdoc.com/page/find_each">find_each | Railsドキュメント</a> &#x2026; 1件ずつ処理。
<a href="https://railsdoc.com/page/find_in_batches">find_in_batches | Railsドキュメント</a> &#x2026; 配列で処理。
</p>
</div>
</div>

<div id="outline-container-org33a3aee" class="outline-3">
<h3 id="org33a3aee"><a href="#org33a3aee">並列処理の例</a></h3>
<div class="outline-text-3" id="text-org33a3aee">
<p>
parallel gemによって。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 44: </span>例</label><pre class="src src-ruby"><span class="org-builtin">require</span> <span class="org-string">'parallel'</span>
result = <span class="org-type">Parallel</span>.each(1..10) <span class="org-keyword">do</span> |item|
    item ** 2
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org42db2ab" class="outline-3">
<h3 id="org42db2ab"><a href="#org42db2ab">開発に便利なページ</a></h3>
<div class="outline-text-3" id="text-org42db2ab">
<ul class="org-ul">
<li>/rails/info/routes
routes一覧。</li>
<li>/letter_opener(自分で設定する)
送信したメール一覧を見られる。
gemが入ってる場合。
<a href="https://github.com/ryanb/letter_opener">ryanb/letter_opener: Preview mail in the browser instead of sending.</a></li>
<li>rails/mailers/
Action Mailerのプレビューを見られる。
previewを準備しておくといちいち送信せずとも、ローカルでダミーが入った文面を確認できる。</li>
</ul>
</div>
</div>
<div id="outline-container-orgb4fd75a" class="outline-3">
<h3 id="orgb4fd75a"><a href="#orgb4fd75a">開発環境でしか使えないメソッドが存在する</a></h3>
<div class="outline-text-3" id="text-orgb4fd75a">
<p>
<code>class_name</code> は開発環境でしか使えない。
gemによってはそういうパターンで使えないことがあることに注意しておく。
</p>

<ul class="org-ul">
<li><a href="https://stackoverflow.com/questions/38776080/method-class-name-undefined-for-class-object-in-rails">https://stackoverflow.com/questions/38776080/method-class-name-undefined-for-class-object-in-rails</a></li>
</ul>
<blockquote>
<p>
class_name method is defined by yard gem. it works only development env.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org0e82802" class="outline-3">
<h3 id="org0e82802"><a href="#org0e82802">rails console -s</a></h3>
<div class="outline-text-3" id="text-org0e82802">
<p>
<code>rails console -s</code> としてconsole起動すると、sandbox-modeになりコンソール内のDB操作が終了時にリセットされる。
便利。
</p>
</div>
</div>
<div id="outline-container-orga88a7ef" class="outline-3">
<h3 id="orga88a7ef"><a href="#orga88a7ef">rails cできないとき</a></h3>
<div class="outline-text-3" id="text-orga88a7ef">
<p>
springはキャッシュを保存して次のコマンド実行を早くするgem。
テストも高速化できるので便利だが、たまに壊れて反映しなくなったりする。
</p>

<p>
まずspringを止めて確認する。
</p>
<div class="org-src-container">
<pre class="src src-shell">bundle exec spring stop
</pre>
</div>
</div>
</div>
<div id="outline-container-orgde2c482" class="outline-3">
<h3 id="orgde2c482"><a href="#orgde2c482">system specでTCP error がでるとき</a></h3>
<div class="outline-text-3" id="text-orgde2c482">
<p>
テストがある程度の長さを超えると、メモリの量が足りなくなってエラーを出す。
特にMacだと起こるよう。
</p>
<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">ulimit</span> -n 1024
</pre>
</div>
</div>
</div>
<div id="outline-container-orga3c6c47" class="outline-3">
<h3 id="orga3c6c47"><a href="#orga3c6c47">seed_fuのlint</a></h3>
<div class="outline-text-3" id="text-orga3c6c47">
<p>
走らせてエラーがないかチェックする。
</p>
<div class="org-src-container">
<pre class="src src-ruby">namespace <span class="org-constant">:db</span> <span class="org-keyword">do</span>
  namespace <span class="org-constant">:seed_fu</span> <span class="org-keyword">do</span>
    desc <span class="org-string">'Verify that all fixtures are valid'</span>
    task <span class="org-constant">lint:</span> <span class="org-constant">:environment</span> <span class="org-keyword">do</span>
      <span class="org-keyword">if</span> <span class="org-type">Rails</span>.env.test?
        conn = <span class="org-type">ActiveRecord</span>::<span class="org-type">Base</span>.connection

        <span class="org-string">%w[development test production]</span>.each <span class="org-keyword">do</span> |env|
          conn.transaction <span class="org-keyword">do</span>
            <span class="org-type">SeedFu</span>.seed(<span class="org-string">"db/fixtures/</span><span class="org-variable-name">#{env}</span><span class="org-string">"</span>)
            <span class="org-builtin">raise</span> <span class="org-type">ActiveRecord</span>::<span class="org-type">Rollback</span>
          <span class="org-keyword">end</span>
        <span class="org-keyword">end</span>
      <span class="org-keyword">else</span>
        <span class="org-builtin">system</span>(<span class="org-string">"bundle exec rails db:seed_fu:lint RAILS_ENV='test'"</span>)
        <span class="org-builtin">raise</span> <span class="org-keyword">if</span> <span class="org-builtin">$CHILD_STATUS</span>.exitstatus.nonzero?
      <span class="org-keyword">end</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orge376815" class="outline-3">
<h3 id="orge376815"><a href="#orge376815">どのメソッドか調べる</a></h3>
<div class="outline-text-3" id="text-orge376815">
<p>
どのgemのメソッドかわからないときに <code>source_location</code> が便利。
<a href="https://docs.ruby-lang.org/ja/latest/method/Method/i/source_location.html">https://docs.ruby-lang.org/ja/latest/method/Method/i/source_location.html</a>
</p>
<div class="org-src-container">
<pre class="src src-ruby">character.method(<span class="org-constant">:draw</span>).source_location
</pre>
</div>
</div>
</div>
<div id="outline-container-org9f29d2d" class="outline-3">
<h3 id="org9f29d2d"><a href="#org9f29d2d">DBリセット</a></h3>
<div class="outline-text-3" id="text-org9f29d2d">
<p>
環境を指定して、リセットを行う。
データの初期化にseed_fu gemを使っている。
</p>

<div class="org-src-container">
<pre class="src src-shell">bundle exec rails db:migrate:reset &amp;&amp; rails db:seed_fu
</pre>
</div>
</div>
</div>
<div id="outline-container-org36ece52" class="outline-3">
<h3 id="org36ece52"><a href="#org36ece52">デイリーでやること</a></h3>
<div class="outline-text-3" id="text-org36ece52">
<p>
gemのupdateやマイグレーションが起きたときにやる。
どこかで定型化して一気に実行するようにする。
</p>
<div class="org-src-container">
<pre class="src src-shell">git checkout develop &amp;&amp; bundle install &amp;&amp; bundle exec rails db:migrate
</pre>
</div>
</div>
</div>
<div id="outline-container-org85780c4" class="outline-3">
<h3 id="org85780c4"><a href="#org85780c4">scope</a></h3>
<div class="outline-text-3" id="text-org85780c4">
<p>
scopeはクラスメソッド的なやつ。
インスタンスには使えない。 <code>User.scope...</code>
<a href="https://railsguides.jp/active_record_querying.html#%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97">Active Record クエリインターフェイス - Railsガイド</a>
</p>

<blockquote>
<p>
スコープを設定することで、関連オブジェクトやモデルへのメソッド呼び出しとして参照される、よく使用されるクエリを指定することができます。
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org0901599" class="outline-3">
<h3 id="org0901599"><a href="#org0901599">validation</a></h3>
<div class="outline-text-3" id="text-org0901599">
<p>
<code>valid?</code> はAction Modelのバリデーションメソッド。
<a href="https://devdocs.io/rails~6.1/activemodel/validations#method-i-valid-3F">Ruby on Rails 6.1 / ActiveModel::Validations#valid? — DevDocs</a>
引っかかってたらfalseになる。
オーバーライドしてしまいそうになるメソッド名なのに注意。
</p>
</div>
</div>
<div id="outline-container-org58d8ff5" class="outline-3">
<h3 id="org58d8ff5"><a href="#org58d8ff5">ネストしたvalidateは反応しない</a></h3>
<div class="outline-text-3" id="text-org58d8ff5">
<p>
特定の条件だけで発動するvalidation + 条件。`with_options: if`内で`if`を使うと、中のif条件が優先して実行されるため、こう書く必要がある。
</p>
<div class="org-src-container">
<pre class="src src-ruby">validates <span class="org-constant">:term_date</span>, <span class="org-constant">date:</span> { <span class="org-constant">after:</span> <span class="org-builtin">proc</span> { <span class="org-type">Time</span>.zone.now } }, <span class="org-keyword">if</span>: <span class="org-builtin">proc</span> { |p| p.term_date? &amp;&amp; p.sellable?  }
</pre>
</div>
</div>
</div>
<div id="outline-container-org079df79" class="outline-3">
<h3 id="org079df79"><a href="#org079df79">N+1問題</a></h3>
<div class="outline-text-3" id="text-org079df79">
<p>
<a href="20210725100835-sql.html#ID-8b69b8d4-1612-4dc5-8412-96b431fdd101">SQL</a>がたくさん実行されて遅くなること。ループしているとレコードの数だけSQLが発行され、一気に遅くなる。
includesを使うと少ないSQLにまとめられる。
<a href="https://qiita.com/hirotakasasaki/items/e0be0b3fd7b0eb350327">https://qiita.com/hirotakasasaki/items/e0be0b3fd7b0eb350327</a>
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 45: </span>includesで関連テーブルをまとめて取得する</label><pre class="src src-ruby"><span class="org-type">Page</span>.includes(<span class="org-constant">:category</span>)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb8fb97d" class="outline-3">
<h3 id="orgb8fb97d"><a href="#orgb8fb97d">子のデータが存在するとき関連削除しないようにする</a></h3>
<div class="outline-text-3" id="text-orgb8fb97d">
<p>
<code>dependent: destroy</code> だと子のデータもすべて破壊して整合性を保つ。
それでは具合が悪いときもあるので、消さないようにする。
</p>
<div class="org-src-container">
<pre class="src src-ruby">has_many <span class="org-constant">:contents</span>, <span class="org-constant">dependent:</span> <span class="org-constant">:restrict_with_error</span>
</pre>
</div>

<p>
あるいは、外部キーをnull更新する方法もある(nullableであれば)。
</p>
<div class="org-src-container">
<pre class="src src-ruby">has_many <span class="org-constant">:contents</span>, <span class="org-constant">dependent:</span> <span class="org-constant">:nullify</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org548ff14" class="outline-3">
<h3 id="org548ff14"><a href="#org548ff14">文字列で返ってくる真偽値をbooleanオブジェクトに変換する</a></h3>
<div class="outline-text-3" id="text-org548ff14">
<p>
文字列で返ってくる真偽値を、booleanオブジェクトとして扱いとき。ActiveModelのmoduleを使用する。
言われてみるとDBでは文字列かをあまり意識せずに使える。
</p>
<div class="org-src-container">
<pre class="src src-ruby"><span class="org-type">ActiveModel</span>::<span class="org-type">Type</span>::<span class="org-type">Boolean</span>.new.cast(value) == <span class="org-constant">true</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org625bbd3" class="outline-3">
<h3 id="org625bbd3"><a href="#org625bbd3">slimで条件分岐</a></h3>
<div class="outline-text-3" id="text-org625bbd3">
<p>
<a href="https://qiita.com/mishiwata1015/items/407e924263d698ddeaae">【Rails】Slimで入れ子になっている要素の親タグのみを分岐させる - Qiita</a>
閉じタグがないため階層の上だけ条件分岐するためには特殊な書き方が必要になる。
</p>
- unless request.variant.present? && request.variant.include?(:phone)
  / PCでのみサイドバーに
  - args = [:section, class: 'sidebar']
- else
  / スマホではメインコンテンツに入れる
  - args = [:section]
= content_tag(*args)
</div>
</div>
<div id="outline-container-org2cc7863" class="outline-3">
<h3 id="org2cc7863"><a href="#org2cc7863">migration例</a></h3>
<div class="outline-text-3" id="text-org2cc7863">
<div class="org-src-container">
<pre class="src src-shell">$ rails g migration ChangeProductPrice
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">ChangeProductsPrice</span> &lt; <span class="org-type">ActiveRecord</span>::<span class="org-type">Migration</span>[7.0]
  <span class="org-keyword">def</span> <span class="org-function-name">up</span>
    change_table <span class="org-constant">:products</span> <span class="org-keyword">do</span> |t|
      t.change <span class="org-constant">:price</span>, <span class="org-constant">:string</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">down</span>
    change_table <span class="org-constant">:products</span> <span class="org-keyword">do</span> |t|
      t.change <span class="org-constant">:price</span>, <span class="org-constant">:integer</span>
    <span class="org-keyword">end</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">$ rails g migration AddNotNullOnBooks
</pre>
</div>

<div class="org-src-container">
<pre class="src src-ruby"><span class="org-keyword">class</span> <span class="org-type">AddNotNullOnBooks</span> &lt; <span class="org-type">ActiveRecord</span>::<span class="org-type">Migration</span>[6.0]
  <span class="org-keyword">def</span> <span class="org-function-name">up</span>
    change_column_null <span class="org-constant">:books</span>, <span class="org-constant">:user_id</span>, <span class="org-constant">false</span>
  <span class="org-keyword">end</span>

  <span class="org-keyword">def</span> <span class="org-function-name">down</span>
    change_column_null <span class="org-constant">:books</span>, <span class="org-constant">:user_id</span>, <span class="org-constant">true</span>
  <span class="org-keyword">end</span>
<span class="org-keyword">end</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org89e237d" class="outline-2">
<h2 id="org89e237d"><a href="#org89e237d">Tasks</a></h2>
<div class="outline-text-2" id="text-org89e237d">
</div>
<div id="outline-container-orga7993f7" class="outline-3">
<h3 id="orga7993f7"><a href="#orga7993f7"><span class="todo TODO">TODO</span> マイグレーションはどうやっているか&#xa0;&#xa0;&#xa0;<span class="tag"><span class="DontKnow">DontKnow</span></span></a></h3>
<div class="outline-text-3" id="text-orga7993f7">
<p>
マイグレーションを実行したとき、データベースに何が起こっているか。
</p>
</div>
</div>
<div id="outline-container-orgc57570f" class="outline-3">
<h3 id="orgc57570f"><a href="#orgc57570f"><span class="todo TODO">TODO</span> Railsは起動時に何をしているか&#xa0;&#xa0;&#xa0;<span class="tag"><span class="DontKnow">DontKnow</span></span></a></h3>
<div class="outline-text-3" id="text-orgc57570f">
<p>
Rails s とは実際何なのか。
</p>
</div>
</div>
<div id="outline-container-org85819d9" class="outline-3">
<h3 id="org85819d9"><a href="#org85819d9"><span class="todo TODO">TODO</span> ECRデプロイ</a></h3>
<div class="outline-text-3" id="text-org85819d9">
</div>
</div>
<div id="outline-container-orgf3eeef3" class="outline-3">
<h3 id="orgf3eeef3"><a href="#orgf3eeef3"><span class="todo TODO">TODO</span> 実行時のwaringをエラーとして検出させるオプションを見つける</a></h3>
</div>
<div id="outline-container-orgebd89aa" class="outline-3">
<h3 id="orgebd89aa"><a href="#orgebd89aa"><span class="todo TODO">TODO</span> <a href="https://egghead.io/blog/rails-graphql-typescript-react-apollo">Rails + GraphQL + TypeScript + React + Apollo | egghead.io</a></a></h3>
</div>
<div id="outline-container-org74afab4" class="outline-3">
<h3 id="org74afab4"><a href="#org74afab4"><span class="todo TODO">TODO</span> <a href="https://www.amazon.com/Advanced-Rails-Recipes-Mike-Clark/dp/0978739221">Advanced Rails Recipes</a></a></h3>
</div>
<div id="outline-container-orgea9ce52" class="outline-3">
<h3 id="orgea9ce52"><a href="#orgea9ce52"><span class="todo TODO">TODO</span> <a href="https://dxd2021.cto-a.org/program/time-table/b-3">クソコード動画「Userクラス」で考える技術的負債解消の観点/DXD2021</a></a></h3>
<div class="outline-text-3" id="text-orgea9ce52">
<p>
クソコードから学ぶ。
</p>
</div>
</div>
<div id="outline-container-orgd30376a" class="outline-3">
<h3 id="orgd30376a"><a href="#orgd30376a"><span class="todo TODO">TODO</span> <a href="https://railsguides.jp/">Ruby on Rails ガイド：体系的に Rails を学ぼう</a></a></h3>
<div class="outline-text-3" id="text-orgd30376a">
<p>
Rails のドキュメント。
</p>
</div>
</div>
<div id="outline-container-org5278a38" class="outline-3">
<h3 id="org5278a38"><a href="#org5278a38"><span class="todo TODO">TODO</span> <a href="https://www.codewithjason.com/understanding-factory-bot-syntax-coding-factory-bot/">Understanding Factory Bot syntax by coding your own Factory Bot - Code with Jason</a></a></h3>
<div class="outline-text-3" id="text-org5278a38">
<p>
Factory Botの作り方。
</p>
</div>
</div>
<div id="outline-container-orgaec25fa" class="outline-3">
<h3 id="orgaec25fa"><a href="#orgaec25fa"><span class="todo TODO">TODO</span> Tips文書化</a></h3>
<div class="outline-text-3" id="text-orgaec25fa">
<ul class="org-ul">
<li>5730</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga2e151a" class="outline-2">
<h2 id="orga2e151a"><a href="#orga2e151a">Archives</a></h2>
<div class="outline-text-2" id="text-orga2e151a">
</div>
<div id="outline-container-orga46cd21" class="outline-3">
<h3 id="orga46cd21"><a href="#orga46cd21"><span class="done DONE">DONE</span> 誤字</a></h3>
<div class="outline-text-3" id="text-orga46cd21">
<p>
<a href="https://github.com/carrierwaveuploader/carrierwave/blob/a3ffc5381e70a4014b61b27b35540aa3b945910d/README.md#retry-option-for-douwload-from-remote-location">https://github.com/carrierwaveuploader/carrierwave/blob/a3ffc5381e70a4014b61b27b35540aa3b945910d/README.md#retry-option-for-douwload-from-remote-location</a>
</p>

<p>
PR送信完了。一字だけ。
</p>
</div>
</div>
<div id="outline-container-orgfc947fa" class="outline-3">
<h3 id="orgfc947fa"><a href="#orgfc947fa"><span class="done DONE">DONE</span> <a href="https://zenn.dev/prune/books/0d7d6e3c5f0496">Rails+React（SPA）TODOアプリチュートリアル【0から学ぶ】</a></a></h3>
<div class="outline-text-3" id="text-orgfc947fa">
<p>
<a href="20210509095946-rails.html#ID-e04aa1a3-509c-45b2-ac64-53d69c961214">Rails</a>  + <a href="20210902220546-react.html#ID-dc50d818-d7d1-48a8-ad76-62ead617c670">React</a>の本。
</p>

<p>
ホットリロードができない。
</p>
</div>
</div>
<div id="outline-container-orgd7863ab" class="outline-3">
<h3 id="orgd7863ab"><a href="#orgd7863ab"><span class="done CLOSE">CLOSE</span> loggerを自動オン</a></h3>
<div class="outline-text-3" id="text-orgd7863ab">
<p>
Rails console。ENVで分岐すれば本番コンソールでログレベルを上げる、ということができるはず。
</p>
</div>
</div>
<div id="outline-container-org54cd27d" class="outline-3">
<h3 id="org54cd27d"><a href="#org54cd27d"><span class="done DONE">DONE</span> <a href="https://qiita.com/k-penguin-sato/items/07fef2f26fd6339e0e69">【Rails】graphql-rubyでAPIを作成 - Qiita</a> -実行</a></h3>
<div class="outline-text-3" id="text-org54cd27d">
<p>
<a href="20211030122204-graphql.html#ID-b4f456cf-d250-4877-ac4c-4b03144392f0">GraphQL</a>をrailsでやるチュートリアル。
</p>
</div>
</div>
<div id="outline-container-org948796c" class="outline-3">
<h3 id="org948796c"><a href="#org948796c"><span class="done CLOSE">CLOSE</span> <a href="https://www.amazon.co.jp/dp/B01N0SS6NF/ref=dp-kindle-redirect?_encoding=UTF8&amp;btkr=1">Amazon.co.jp: Deploying Rails with Docker, Kubernetes and ECS (English Edition) eBook : Acuña, Pablo: Foreign Language Books</a></a></h3>
<div class="outline-text-3" id="text-org948796c">
<ul class="org-ul">
<li>24, 51</li>
</ul>

<p>
KubernetesでRails deployまでやる本。
AWSデプロイコマンドの挙動が違い、バージョンを合わせても動かずよくわからなかったので断念。こういうのは新しい本を買うべきだな。ローカル環境minikubeでの動作は確認できた。
</p>
</div>
</div>
<div id="outline-container-orgf45cfc3" class="outline-3">
<h3 id="orgf45cfc3"><a href="#orgf45cfc3"><span class="done DONE">DONE</span> RailsとPumaの関係性&#xa0;&#xa0;&#xa0;<span class="tag"><span class="DontKnow">DontKnow</span></span></a></h3>
<div class="outline-text-3" id="text-orgf45cfc3">
<p>
2つの違いは何で、実際どのように、どの境界で処理しているのか。
</p>

<ul class="org-ul">
<li>rails: アプリケーション(ソースコード)</li>
<li>puma: アプリケーションサーバ。アプリケーションを動かしているもの</li>
</ul>

<blockquote>
<p>
まず、webリクエストはwebサーバーが受け取ります。そのリクエストがRailsで処理できるものであれば、webサーバーはリクエストに簡単な処理を加えてアプリケーションサーバーに渡します。アプリケーションサーバーはRackを使ってRailsアプリケーションに話しかけます。Railsアプリケーションがリクエストの処理を終えると、Railsはレスポンスをアプリケーションサーバーに返します。そして、webサーバーはあなたのアプリケーションを使っているユーザーにレスポンスを返します。
</p>
</blockquote>

<ul class="org-ul">
<li><a href="https://qiita.com/jnchito/items/3884f9a2ccc057f8f3a3">Rails開発におけるwebサーバーとアプリケーションサーバーの違い（翻訳） - Qiita</a></li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org5d9950e" class="outline-2">
<h2 id="org5d9950e"><a href="#org5d9950e">References</a></h2>
<div class="outline-text-2" id="text-org5d9950e">
</div>
<div id="outline-container-orga865521" class="outline-3">
<h3 id="orga865521"><a href="#orga865521"><a href="https://github.com/thoughtbot/ruby-science">thoughtbot/ruby-science: The reference for writing fantastic Rails applications</a></a></h3>
<div class="outline-text-3" id="text-orga865521">
<p>
ruby, railsのより良い書き方のガイド。
</p>
</div>
</div>
<div id="outline-container-orgbaef26b" class="outline-3">
<h3 id="orgbaef26b"><a href="#orgbaef26b"><a href="https://qiita.com/takahiro1127/items/fcb81753eaf381b4b33c">なぜrailsの本番環境ではUnicorn,Nginxを使うのか? 　~ Rack,Unicorn,Nginxの連携について ~【Ruby On Railsでwebサービス運営】 - Qiita</a></a></h3>
</div>
<div id="outline-container-org2ad2a9f" class="outline-3">
<h3 id="org2ad2a9f"><a href="#org2ad2a9f"><a href="https://stackoverflow.com/questions/61413196/how-to-run-capybara-tests-using-selenium-chrome-in-a-dockerised-rails-environm">docker - How to run Capybara tests using Selenium &amp; Chrome in a Dockerised Rails environment on a Mac - Stack Overflow</a></a></h3>
<div class="outline-text-3" id="text-org2ad2a9f">
<p>
dockerのseleniumで動かす方法。
</p>
</div>
</div>
<div id="outline-container-org6138225" class="outline-3">
<h3 id="org6138225"><a href="#org6138225"><a href="https://railsguides.jp/active_model_basics.html">Active Model の基礎 - Railsガイド</a></a></h3>
<div class="outline-text-3" id="text-org6138225">
<p>
モデルの説明。
</p>
</div>
</div>
<div id="outline-container-orga617cf0" class="outline-3">
<h3 id="orga617cf0"><a href="#orga617cf0"><a href="https://qiita.com/jnchito/items/0ee47108972a0e302caf">永久保存版！？伊藤さん式・Railsアプリのアップグレード手順 - Qiita</a></a></h3>
<div class="outline-text-3" id="text-orga617cf0">
<p>
アップデートの流れ。
</p>
</div>
</div>
<div id="outline-container-orga68dda0" class="outline-3">
<h3 id="orga68dda0"><a href="#orga68dda0"><a href="https://tech.kitchhike.com/entry/2017/03/07/190739">DHH流のルーティングで得られるメリットと、取り入れる上でのポイント - KitchHike Tech Blog</a></a></h3>
<div class="outline-text-3" id="text-orga68dda0">
<p>
ルーティングをどうするかの指針。
</p>
</div>
</div>
<div id="outline-container-org665a36b" class="outline-3">
<h3 id="org665a36b"><a href="#org665a36b"><a href="https://github.com/ankane/strong_migrations">ankane/strong_migrations: Catch unsafe migrations in development</a></a></h3>
<div class="outline-text-3" id="text-org665a36b">
<p>
READMEに安全なマイグレーションの説明がある。
</p>
</div>
</div>
<div id="outline-container-org00cecf8" class="outline-3">
<h3 id="org00cecf8"><a href="#org00cecf8"><a href="https://tech.speee.jp/entry/2020/06/30/110000">reg-suit によるビジュアルリグレッションテストで Rails アプリの CSS 改善サイクルが回り始めた話 - Speee DEVELOPER BLOG</a></a></h3>
<div class="outline-text-3" id="text-org00cecf8">
<p>
ビジュアルリグレッションテストの運用方法。
</p>
</div>
</div>
<div id="outline-container-org1098aeb" class="outline-3">
<h3 id="org1098aeb"><a href="#org1098aeb"><a href="https://zenn.dev/yukito0616/articles/d3b7032e9f1e90">Only My Rails Way</a></a></h3>
<div class="outline-text-3" id="text-org1098aeb">
<p>
Rails Wayの定義について。
</p>
</div>
</div>
<div id="outline-container-orga0a4805" class="outline-3">
<h3 id="orga0a4805"><a href="#orga0a4805"><a href="https://discuss.rubyonrails.org/">Ruby on Rails Discussions - Ruby on Rails Discussions</a></a></h3>
<div class="outline-text-3" id="text-orga0a4805">
<p>
Rails開発のディスカッション。
</p>
</div>
</div>
<div id="outline-container-org3db0cda" class="outline-3">
<h3 id="org3db0cda"><a href="#org3db0cda"><a href="https://www.slideshare.net/ockeghem/ruby-on-rails-security-142250872">Railsエンジニアのためのウェブセキュリティ入門</a></a></h3>
<div class="outline-text-3" id="text-org3db0cda">
<p>
わかりやすいスライド。
</p>
</div>
</div>
<div id="outline-container-org57ec33b" class="outline-3">
<h3 id="org57ec33b"><a href="#org57ec33b"><a href="https://techracho.bpsinc.jp/hachi8833/2020_05_13/91211">Rails開発者が採用面接で聞かれる想定Q&amp;A 53問（翻訳）｜TechRacho by BPS株式会社</a></a></h3>
<div class="outline-text-3" id="text-org57ec33b">
<p>
ちゃんとRailsガイドを読まないときついな。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
