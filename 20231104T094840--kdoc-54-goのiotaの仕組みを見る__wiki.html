<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-11-20T22:34:30Z -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 54: Goのiotaの仕組みを見る</title>
<meta name="author" content="kijimaD" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 54: Goのiotaの仕組みを見る</h1>
<p>
<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>言語にはiotaというキーワードがある。enum的なものを実現したいときによく使う機能で、整数を自動的に割り振ってくれる。
</p>

<p>
例えば、↓のように、Languageというグループとして定数をまとめて定義できる。実際に割り当てられている値が何か意識しなくてよい。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>enumを実現する</label><pre class="src src-go">type Language int
const (
        Japanese Language = iota
        English
        Chinese
)
</pre>
</div>

<p>
これをどうやっているのか、iotaの仕組みについて調べる。まず生成されるアセンブリコードを比較してみる↓。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>iotaを使うコード</label><pre class="src src-go-asm">package main
import "fmt"
func main() {
        const a = iota + 999
        fmt.Print(a)
}
</pre>
</div>

<div class="results" id="org4a0a237">
<p>
main.main STEXT size=114 args=0x0 locals=0x50 funcid=0x0 align=0x0
	0x0000 00000 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	TEXT	main.main(SB), ABIInternal, $80-0
	0x0000 00000 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	CMPQ	SP, 16(R14)
	0x0004 00004 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	PCDATA	$0, $-2
	0x0004 00004 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	JLS	107
	0x0006 00006 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	PCDATA	$0, $-1
	0x0006 00006 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	PUSHQ	BP
	0x0007 00007 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	MOVQ	SP, BP
	0x000a 00010 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	SUBQ	$72, SP
	0x000e 00014 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	FUNCDATA	$0, gclocals·g2BeySu+wFnoycgXfElmcg==(SB)
	0x000e 00014 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	FUNCDATA	$1, gclocals·/ydTHfVJHvKeH/UP4dRKSQ==(SB)
	0x000e 00014 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	FUNCDATA	$2, main.main.stkobj(SB)
	0x000e 00014 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVUPS	X15, main..autotmp_0+32(SP)
	0x0014 00020 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	LEAQ	main..autotmp_0+32(SP), AX
	0x0019 00025 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVQ	AX, main..autotmp_2+24(SP)
	0x001e 00030 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	TESTB	AL, (AX)
	0x0020 00032 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	LEAQ	type:int(SB), DX
	0x0027 00039 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVQ	DX, main..autotmp_0+32(SP)
	0x002c 00044 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	LEAQ	main..stmp_0(SB), DX
	0x0033 00051 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVQ	DX, main..autotmp_0+40(SP)
	0x0038 00056 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	TESTB	AL, (AX)
	0x003a 00058 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	JMP	60
	0x003c 00060 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVQ	AX, main..autotmp_1+48(SP)
	0x0041 00065 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVQ	$1, main..autotmp_1+56(SP)
	0x004a 00074 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVQ	$1, main..autotmp_1+64(SP)
	0x0053 00083 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVL	$1, BX
	0x0058 00088 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	MOVQ	BX, CX
	0x005b 00091 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	PCDATA	$1, $0
	0x005b 00091 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	NOP
	0x0060 00096 (/tmp/babel-ZDNznW/hxQ4Zh.go:5)	CALL	fmt.Print(SB)
	0x0065 00101 (/tmp/babel-ZDNznW/hxQ4Zh.go:6)	ADDQ	$72, SP
	0x0069 00105 (/tmp/babel-ZDNznW/hxQ4Zh.go:6)	POPQ	BP
	0x006a 00106 (/tmp/babel-ZDNznW/hxQ4Zh.go:6)	RET
	0x006b 00107 (/tmp/babel-ZDNznW/hxQ4Zh.go:6)	NOP
	0x006b 00107 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	PCDATA	$1, $-1
	0x006b 00107 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	PCDATA	$0, $-2
	0x006b 00107 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	CALL	runtime.morestack_noctxt(SB)
	0x0070 00112 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	PCDATA	$0, \(-1
	0x0070 00112 (/tmp/babel-ZDNznW/hxQ4Zh.go:3)	JMP	0
	0x0000 49 3b 66 10 76 65 55 48 89 e5 48 83 ec 48 44 0f  I;f.veUH..H..HD.
	0x0010 11 7c 24 20 48 8d 44 24 20 48 89 44 24 18 84 00  .|\) H.D$ H.D$&#x2026;
	0x0020 48 8d 15 00 00 00 00 48 89 54 24 20 48 8d 15 00  H&#x2026;&#x2026;H.T$ H&#x2026;
	0x0030 00 00 00 48 89 54 24 28 84 00 eb 00 48 89 44 24  &#x2026;H.T\((....H.D\)
	0x0040 30 48 c7 44 24 38 01 00 00 00 48 c7 44 24 40 01  0H.D\(8....H.D\)@.
	0x0050 00 00 00 bb 01 00 00 00 48 89 d9 0f 1f 44 00 00  &#x2026;&#x2026;..H&#x2026;.D..
	0x0060 e8 00 00 00 00 48 83 c4 48 5d c3 e8 00 00 00 00  &#x2026;..H..H]&#x2026;&#x2026;
	0x0070 eb 8e                                            ..
	rel 2+0 t=23 type:int+0
	rel 35+4 t=14 type:int+0
	rel 47+4 t=14 main..stmp_0+0
	rel 97+4 t=7 fmt.Print+0
	rel 108+4 t=7 runtime.morestack_noctxt+0
go:cuinfo.producer.main SDWARFCUINFO dupok size=0
	0x0000 2d 4e 20 2d 6c 20 72 65 67 61 62 69              -N -l regabi
go:cuinfo.packagename.main SDWARFCUINFO dupok size=0
	0x0000 6d 61 69 6e                                      main
main..inittask SNOPTRDATA size=8
	0x0000 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 0+0 t=81 fmt..inittask+0
main..stmp_0 SRODATA static size=8
	0x0000 e7 03 00 00 00 00 00 00                          &#x2026;&#x2026;..
runtime.nilinterequal·f SRODATA dupok size=8
	0x0000 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 0+8 t=1 runtime.nilinterequal+0
runtime.gcbits.0200000000000000 SRODATA dupok size=8
	0x0000 02 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
type:.namedata.*[1]interface {}- SRODATA dupok size=18
	0x0000 00 10 2a 5b 31 5d 69 6e 74 65 72 66 61 63 65 20  ..*[1]interface
	0x0010 7b 7d                                            {}
type:[1]interface {} SRODATA dupok size=72
	0x0000 10 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0010 6e 20 6a 3d 02 08 08 11 00 00 00 00 00 00 00 00  n j=&#x2026;&#x2026;&#x2026;&#x2026;
	0x0020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0030 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0040 01 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 24+8 t=1 runtime.nilinterequal·f+0
	rel 32+8 t=1 runtime.gcbits.0200000000000000+0
	rel 40+4 t=5 type:.namedata.*[1]interface {}-+0
	rel 44+4 t=-32763 type:*[1]interface {}+0
	rel 48+8 t=1 type:interface {}+0
	rel 56+8 t=1 type:[]interface {}+0
runtime.memequal64·f SRODATA dupok size=8
	0x0000 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 0+8 t=1 runtime.memequal64+0
runtime.gcbits.0100000000000000 SRODATA dupok size=8
	0x0000 01 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
type:*[1]interface {} SRODATA dupok size=56
	0x0000 08 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0010 a8 0e 57 36 08 08 08 36 00 00 00 00 00 00 00 00  ..W6&#x2026;6&#x2026;&#x2026;..
	0x0020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0030 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 24+8 t=1 runtime.memequal64·f+0
	rel 32+8 t=1 runtime.gcbits.0100000000000000+0
	rel 40+4 t=5 type:.namedata.*[1]interface {}-+0
	rel 48+8 t=1 type:[1]interface {}+0
type:.importpath.fmt. SRODATA dupok size=5
	0x0000 00 03 66 6d 74                                   ..fmt
gclocals·g2BeySu+wFnoycgXfElmcg== SRODATA dupok size=8
	0x0000 01 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
gclocals·/ydTHfVJHvKeH/UP4dRKSQ== SRODATA dupok size=9
	0x0000 01 00 00 00 06 00 00 00 00                       &#x2026;&#x2026;&#x2026;
main.main.stkobj SRODATA static size=24
	0x0000 01 00 00 00 00 00 00 00 d8 ff ff ff 10 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0010 10 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 20+4 t=5 runtime.gcbits.0200000000000000+0
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>iotaを使わずに同じ意味になるコード</label><pre class="src src-go-asm">package main
import "fmt"
func main() {
        fmt.Print(999)
}
</pre>
</div>

<div class="results" id="org8d186d7">
<p>
main.main STEXT size=114 args=0x0 locals=0x50 funcid=0x0 align=0x0
	0x0000 00000 (/tmp/babel-ZDNznW/voZLcz.go:3)	TEXT	main.main(SB), ABIInternal, $80-0
	0x0000 00000 (/tmp/babel-ZDNznW/voZLcz.go:3)	CMPQ	SP, 16(R14)
	0x0004 00004 (/tmp/babel-ZDNznW/voZLcz.go:3)	PCDATA	$0, $-2
	0x0004 00004 (/tmp/babel-ZDNznW/voZLcz.go:3)	JLS	107
	0x0006 00006 (/tmp/babel-ZDNznW/voZLcz.go:3)	PCDATA	$0, $-1
	0x0006 00006 (/tmp/babel-ZDNznW/voZLcz.go:3)	PUSHQ	BP
	0x0007 00007 (/tmp/babel-ZDNznW/voZLcz.go:3)	MOVQ	SP, BP
	0x000a 00010 (/tmp/babel-ZDNznW/voZLcz.go:3)	SUBQ	$72, SP
	0x000e 00014 (/tmp/babel-ZDNznW/voZLcz.go:3)	FUNCDATA	$0, gclocals·g2BeySu+wFnoycgXfElmcg==(SB)
	0x000e 00014 (/tmp/babel-ZDNznW/voZLcz.go:3)	FUNCDATA	$1, gclocals·/ydTHfVJHvKeH/UP4dRKSQ==(SB)
	0x000e 00014 (/tmp/babel-ZDNznW/voZLcz.go:3)	FUNCDATA	$2, main.main.stkobj(SB)
	0x000e 00014 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVUPS	X15, main..autotmp_0+32(SP)
	0x0014 00020 (/tmp/babel-ZDNznW/voZLcz.go:4)	LEAQ	main..autotmp_0+32(SP), AX
	0x0019 00025 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVQ	AX, main..autotmp_2+24(SP)
	0x001e 00030 (/tmp/babel-ZDNznW/voZLcz.go:4)	TESTB	AL, (AX)
	0x0020 00032 (/tmp/babel-ZDNznW/voZLcz.go:4)	LEAQ	type:int(SB), DX
	0x0027 00039 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVQ	DX, main..autotmp_0+32(SP)
	0x002c 00044 (/tmp/babel-ZDNznW/voZLcz.go:4)	LEAQ	main..stmp_0(SB), DX
	0x0033 00051 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVQ	DX, main..autotmp_0+40(SP)
	0x0038 00056 (/tmp/babel-ZDNznW/voZLcz.go:4)	TESTB	AL, (AX)
	0x003a 00058 (/tmp/babel-ZDNznW/voZLcz.go:4)	JMP	60
	0x003c 00060 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVQ	AX, main..autotmp_1+48(SP)
	0x0041 00065 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVQ	$1, main..autotmp_1+56(SP)
	0x004a 00074 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVQ	$1, main..autotmp_1+64(SP)
	0x0053 00083 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVL	$1, BX
	0x0058 00088 (/tmp/babel-ZDNznW/voZLcz.go:4)	MOVQ	BX, CX
	0x005b 00091 (/tmp/babel-ZDNznW/voZLcz.go:4)	PCDATA	$1, $0
	0x005b 00091 (/tmp/babel-ZDNznW/voZLcz.go:4)	NOP
	0x0060 00096 (/tmp/babel-ZDNznW/voZLcz.go:4)	CALL	fmt.Print(SB)
	0x0065 00101 (/tmp/babel-ZDNznW/voZLcz.go:5)	ADDQ	$72, SP
	0x0069 00105 (/tmp/babel-ZDNznW/voZLcz.go:5)	POPQ	BP
	0x006a 00106 (/tmp/babel-ZDNznW/voZLcz.go:5)	RET
	0x006b 00107 (/tmp/babel-ZDNznW/voZLcz.go:5)	NOP
	0x006b 00107 (/tmp/babel-ZDNznW/voZLcz.go:3)	PCDATA	$1, $-1
	0x006b 00107 (/tmp/babel-ZDNznW/voZLcz.go:3)	PCDATA	$0, $-2
	0x006b 00107 (/tmp/babel-ZDNznW/voZLcz.go:3)	CALL	runtime.morestack_noctxt(SB)
	0x0070 00112 (/tmp/babel-ZDNznW/voZLcz.go:3)	PCDATA	$0, \(-1
	0x0070 00112 (/tmp/babel-ZDNznW/voZLcz.go:3)	JMP	0
	0x0000 49 3b 66 10 76 65 55 48 89 e5 48 83 ec 48 44 0f  I;f.veUH..H..HD.
	0x0010 11 7c 24 20 48 8d 44 24 20 48 89 44 24 18 84 00  .|\) H.D$ H.D$&#x2026;
	0x0020 48 8d 15 00 00 00 00 48 89 54 24 20 48 8d 15 00  H&#x2026;&#x2026;H.T$ H&#x2026;
	0x0030 00 00 00 48 89 54 24 28 84 00 eb 00 48 89 44 24  &#x2026;H.T\((....H.D\)
	0x0040 30 48 c7 44 24 38 01 00 00 00 48 c7 44 24 40 01  0H.D\(8....H.D\)@.
	0x0050 00 00 00 bb 01 00 00 00 48 89 d9 0f 1f 44 00 00  &#x2026;&#x2026;..H&#x2026;.D..
	0x0060 e8 00 00 00 00 48 83 c4 48 5d c3 e8 00 00 00 00  &#x2026;..H..H]&#x2026;&#x2026;
	0x0070 eb 8e                                            ..
	rel 2+0 t=23 type:int+0
	rel 35+4 t=14 type:int+0
	rel 47+4 t=14 main..stmp_0+0
	rel 97+4 t=7 fmt.Print+0
	rel 108+4 t=7 runtime.morestack_noctxt+0
go:cuinfo.producer.main SDWARFCUINFO dupok size=0
	0x0000 2d 4e 20 2d 6c 20 72 65 67 61 62 69              -N -l regabi
go:cuinfo.packagename.main SDWARFCUINFO dupok size=0
	0x0000 6d 61 69 6e                                      main
main..inittask SNOPTRDATA size=8
	0x0000 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 0+0 t=81 fmt..inittask+0
main..stmp_0 SRODATA static size=8
	0x0000 e7 03 00 00 00 00 00 00                          &#x2026;&#x2026;..
runtime.nilinterequal·f SRODATA dupok size=8
	0x0000 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 0+8 t=1 runtime.nilinterequal+0
runtime.gcbits.0200000000000000 SRODATA dupok size=8
	0x0000 02 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
type:.namedata.*[1]interface {}- SRODATA dupok size=18
	0x0000 00 10 2a 5b 31 5d 69 6e 74 65 72 66 61 63 65 20  ..*[1]interface
	0x0010 7b 7d                                            {}
type:[1]interface {} SRODATA dupok size=72
	0x0000 10 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0010 6e 20 6a 3d 02 08 08 11 00 00 00 00 00 00 00 00  n j=&#x2026;&#x2026;&#x2026;&#x2026;
	0x0020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0030 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0040 01 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 24+8 t=1 runtime.nilinterequal·f+0
	rel 32+8 t=1 runtime.gcbits.0200000000000000+0
	rel 40+4 t=5 type:.namedata.*[1]interface {}-+0
	rel 44+4 t=-32763 type:*[1]interface {}+0
	rel 48+8 t=1 type:interface {}+0
	rel 56+8 t=1 type:[]interface {}+0
runtime.memequal64·f SRODATA dupok size=8
	0x0000 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 0+8 t=1 runtime.memequal64+0
runtime.gcbits.0100000000000000 SRODATA dupok size=8
	0x0000 01 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
type:*[1]interface {} SRODATA dupok size=56
	0x0000 08 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0010 a8 0e 57 36 08 08 08 36 00 00 00 00 00 00 00 00  ..W6&#x2026;6&#x2026;&#x2026;..
	0x0020 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0030 00 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 24+8 t=1 runtime.memequal64·f+0
	rel 32+8 t=1 runtime.gcbits.0100000000000000+0
	rel 40+4 t=5 type:.namedata.*[1]interface {}-+0
	rel 48+8 t=1 type:[1]interface {}+0
type:.importpath.fmt. SRODATA dupok size=5
	0x0000 00 03 66 6d 74                                   ..fmt
gclocals·g2BeySu+wFnoycgXfElmcg== SRODATA dupok size=8
	0x0000 01 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
gclocals·/ydTHfVJHvKeH/UP4dRKSQ== SRODATA dupok size=9
	0x0000 01 00 00 00 06 00 00 00 00                       &#x2026;&#x2026;&#x2026;
main.main.stkobj SRODATA static size=24
	0x0000 01 00 00 00 00 00 00 00 d8 ff ff ff 10 00 00 00  &#x2026;&#x2026;&#x2026;&#x2026;&#x2026;.
	0x0010 10 00 00 00 00 00 00 00                          &#x2026;&#x2026;..
	rel 20+4 t=5 runtime.gcbits.0200000000000000+0
</p>

</div>

<p>
↑これらは全く同じ結果になるので、iotaは事前に値を展開していることがわかる。Goではインスタンスや実行するまで値が決まらないものはconstに指定できないので、この動作は予想できる。少なくともGoアセンブリに変換する直前では単純なintになっているのだ。
</p>

<p>
コードを見てみる。↓constの宣言部分を処理する部分を見る。constはカッコを使ってグループで宣言でき、そのグループごとにループを回す。その1回分の処理が以下だ。グループごとにforループからとったindexがあって、enumの初期値に基づいてiotaの値がどうなるか計算している。だからiotaを1はじまりとかにできるわけ。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>func (check *Checker) declStmt(list []syntax.Decl) から</label><pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/2eca0b1e1663d826893b6b1fd8bd89da98e65d1e/src/cmd/compile/internal/types2/decl.go#L757-L765
</pre>
</div>

<div class="results" id="org04fed09">
<p>
case *syntax.ConstDecl:
	top := len(check.delayed)
</p>

<p>
// iota is the index of the current constDecl within the group
if first &lt; 0 || s.Group <code>= nil || list[index-1].(*syntax.ConstDecl).Group !</code> s.Group {
	first = index
	last = nil
}
iota := constant.MakeInt64(int64(index - first))
</p>

</div>

<p>
↓そして、作成したローカル変数iotaでconstを初期化する。対応した初期化式が与えられていれば、そちらで上書きする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>func (check *Checker) declStmt(list []syntax.Decl) から</label><pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/2eca0b1e1663d826893b6b1fd8bd89da98e65d1e/src/cmd/compile/internal/types2/decl.go#L781-L791
</pre>
</div>

<div class="results" id="orgea2bd7a">
<p>
for i, name := range s.NameList {
	obj := NewConst(name.Pos(), pkg, name.Value, nil, iota)
	lhs[i] = obj
</p>

<p>
var init syntax.Expr
if i &lt; len(values) {
	init = values[i]
}
</p>

<p>
	check.constDecl(obj, last.Type, init, inherited)
}
</p>

</div>

<p>
↓初期化式initを評価して、その結果を <code>x</code> に設定する。 <code>x</code> を使って、constの値を設定、初期化する。iotaキーワードが使われていれば初期化式initはnilのはずなので、評価が行われず <code>x</code> は変化しない。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>func (check *Checker) constDecl(obj *Const, typ, init syntax.Expr, inherited bool) から</label><pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/2eca0b1e1663d826893b6b1fd8bd89da98e65d1e/src/cmd/compile/internal/types2/decl.go#L400-L413
</pre>
</div>

<div class="results" id="orgb9af8c8">
<p>
var x operand
if init != nil {
	if inherited {
		<i>/ The initialization expression is inherited from a previous
		/</i> constant declaration, and (error) positions refer to that
		<i>/ expression and not the current constant declaration. Use
		/</i> the constant identifier position for any errors during
		<i>/ init expression evaluation since that is all we have
		/</i> (see issues go.dev/issue/42991, go.dev/issue/42992).
		check.errpos = obj.pos
	}
	check.expr(nil, &amp;x, init)
}
check.initConst(obj, &amp;x)
</p>

</div>

<p>
↓ <code>x</code> の値を使って値をセットする。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>func (check *Checker) initConst(lhs *Const, x *operand) から</label><pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/2eca0b1e1663d826893b6b1fd8bd89da98e65d1e/src/cmd/compile/internal/types2/assignments.go#L132
</pre>
</div>

<div class="results" id="org9c3168f">
<p>
lhs.val = x.val
</p>

</div>

<p>
↓ちなみにCheckerは、型チェックの状態を保持する構造体である。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>Checkerは型チェッカーである</label><pre class="src src-git-permalink">https://github.com/kd-collective/go/blob/2eca0b1e1663d826893b6b1fd8bd89da98e65d1e/src/cmd/compile/internal/types2/check.go#L91-L93
</pre>
</div>

<div class="results" id="org61ccc73">
<p>
<i>/ A Checker maintains the state of the type checker.
/</i> It must be created with NewChecker.
type Checker struct {
</p>

</div>

<p>
つまり、constにiotaキーワードを使った場合、型チェックの過程で実際の値が決まる、という感じになっている。
</p>

<p>
関連。
</p>
<ul class="org-ul">
<li><a href="20231103T214045--kdoc-53-goで独自定義のエラーをconstにする__wiki.html#ID-20231103T214045">KDOC 53: Goで独自定義のエラーをconstにする</a>ではconstのTipsを紹介している。</li>
</ul>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
