<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-05-06 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 172: 関数呼び出しで起きていること</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 172: 関数呼び出しで起きていること</h1>
<div id="outline-container-orgf6a1712" class="outline-2">
<h2 id="orgf6a1712"><a href="#orgf6a1712">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-orgf6a1712">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-06-01 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-06-05 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org21e14cb" class="outline-2">
<h2 id="org21e14cb"><a href="#org21e14cb">概要</a></h2>
<div class="outline-text-2" id="text-org21e14cb">
<p>
関数呼び出しを理解する。
</p>

<iframe width="800px" height="600px" src="https://godbolt.org/e#g:!((g:!((g:!((h:codeEditor,i:(filename:'1',fontScale:14,fontUsePx:'0',j:1,lang:___c,selection:(endColumn:18,endLineNumber:3,positionColumn:18,positionLineNumber:3,selectionStartColumn:18,selectionStartLineNumber:3,startColumn:18,startLineNumber:3),source:'/*+Type+your+code+here,+or+load+an+example.+*/%0Aint+my_add(int+a,+int+b)+%7B%0A++++return+a+%2B+b%3B%0A%7D%0A%0Avoid+main()+%7B%0A++++int+v+%3D+my_add(2,+3)%3B%0A%7D'),l:'5',n:'0',o:'C+source+%231',t:'0')),k:50,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:compiler,i:(compiler:cg141,filters:(b:'0',binary:'1',binaryObject:'1',commentOnly:'0',debugCalls:'1',demangle:'0',directives:'0',execute:'1',intel:'1',libraryCode:'0',trim:'0',verboseDemangling:'0'),flagsViewOpen:'1',fontScale:14,fontUsePx:'0',j:1,lang:___c,libs:!(),options:'',overrides:!(),selection:(endColumn:1,endLineNumber:1,positionColumn:1,positionLineNumber:1,selectionStartColumn:1,selectionStartLineNumber:1,startColumn:1,startLineNumber:1),source:1),l:'5',n:'0',o:'+x86-64+gcc+14.1+(Editor+%231)',t:'0')),k:50,l:'4',n:'0',o:'',s:0,t:'0')),l:'2',n:'0',o:'',t:'0')),version:4"></iframe>

<p>
1: 関数呼び出し時、呼び出し側。
</p>

<ul class="org-ul">
<li>rbpをスタックに保存して、呼び出し元に戻れるようにしておく</li>
<li>rbpのアドレスでrspをセットする</li>
<li>スタックフレームを初期化する。rspをrbp-16にして上に伸ばす</li>
<li>引数をレジスタにセットする</li>
<li>callする</li>
</ul>

<p>
2: 呼び出される側。
</p>

<ul class="org-ul">
<li>rbpをスタックに保存して、呼び出し元に戻れるようにしておく</li>
<li>rbpのアドレスでrspをセットする</li>
<li>元のレジスタの値をスタックフレームに保存する</li>
<li>スタックフレームからレジスタに値をセットする</li>
<li>演算する</li>
<li>先ほど保存したrbpを元に戻して、呼び出し元に戻る</li>
</ul>

<p>
3: 呼び出し側に戻る。
</p>

<ul class="org-ul">
<li>関数呼び出ししたとき返り値がレジスタに入っているので、スタックフレームに保存する</li>
<li>leaveでスタックフレームを破棄する。rspにrbpの値をコピーしてrspを復元 + スタックに保存したrbpのアドレスからrbpを復元</li>
</ul>

<p>
図。
</p>


<div id="orgb7a4426" class="figure">
<p><img src="./images/20240601-stack.drawio.svg" alt="20240601-stack.drawio.svg" class="org-svg">
</p>
<p><span class="figure-number">Figure 1: </span>スタックフレームの図</p>
</div>
</div>
</div>
<div id="outline-container-org54d8714" class="outline-2">
<h2 id="org54d8714"><a href="#org54d8714">メモ</a></h2>
<div class="outline-text-2" id="text-org54d8714">
<ul class="org-ul">
<li>main関数もretで元に戻る。どこに戻るのだろう</li>
</ul>
</div>
</div>
<div id="outline-container-org1bee450" class="outline-2">
<h2 id="org1bee450"><a href="#org1bee450">関連</a></h2>
<div class="outline-text-2" id="text-org1bee450">
<ul class="org-ul">
<li><a href="20240427T113714--kdoc-140-『自作エミュレータで学ぶx86アーキテクチャ』__book.html#ID-20240427T113714">KDOC 140: 『自作エミュレータで学ぶx86アーキテクチャ』</a>。で出てきた例を詳しく考えた</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
