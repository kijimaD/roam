<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2022-06-16 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Shell</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Ultra&display=swap" rel="stylesheet"><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">Shell</h1>

<div id="outline-container-orgea96009" class="outline-2">
<h2 id="orgea96009"><a href="#orgea96009">概要</a></h2>
<div class="outline-text-2" id="text-orgea96009">
<p>
シェルスクリプトはUnixシェルで使われる<a href="20210509101246-programming_language.html#ID-868ac56a-2d42-48d7-ab7f-7047c85a8f39">Programming Language</a>。
</p>
</div>
</div>
<div id="outline-container-org648d762" class="outline-2">
<h2 id="org648d762"><a href="#org648d762">Memo</a></h2>
<div class="outline-text-2" id="text-org648d762">
</div>
<div id="outline-container-org5213b74" class="outline-3">
<h3 id="org5213b74"><a href="#org5213b74">ファイルサイズのランキング</a></h3>
<div class="outline-text-3" id="text-org5213b74">
<p>
サイズ順に、最も大きい10ディレクトリを表示する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>-mはMB</label><pre class="src src-shell">du -m ./ | sort -n | tail -10
</pre>
</div>

<div class="results" id="orgb1bcbde">
<p>
47	./node_modules/nlcst-parse-japanese
47	./node_modules/nlcst-parse-japanese/node_modules
47	./node_modules/textlint-rule-ja-hiragana-fukushi
47	./node_modules/textlint-rule-ja-hiragana-fukushi/node_modules
47	./node_modules/textlint-rule-ja-hiragana-hojodoushi
47	./node_modules/textlint-rule-ja-hiragana-hojodoushi/node_modules
47	./node_modules/textlint-rule-ja-hiragana-keishikimeishi/node_modules
48	./node_modules/textlint-rule-ja-hiragana-keishikimeishi
350	./node_modules
391	./
</p>

</div>
</div>
</div>

<div id="outline-container-org28f01de" class="outline-3">
<h3 id="org28f01de"><a href="#org28f01de">エラー: 公開鍵を利用できないため、以下の署名は検証できませんでした を解決する</a></h3>
<div class="outline-text-3" id="text-org28f01de">
<p>
sudo apt-get updateしたとき、GPGエラーが出る解決法。
</p>

<blockquote>
<p>
GPG エラー: <a href="https://">https://</a>&#x2026;. focal InRelease: 公開鍵を利用できないため、以下の署名は検証できませんでした: NO_PUBKEY &#x2026;
</p>
</blockquote>

<p>
pubkeyを追加する。
</p>

<div class="org-src-container">
<pre class="src src-shell">sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys aaaaaa... <span class="org-comment-delimiter"># </span><span class="org-comment">aaaaaa...&#12395;&#12289;&#20844;&#38283;&#37749;&#12434;&#21033;&#29992;&#12391;&#12365;&#12394;&#12356;&#12383;&#12417;&#12289;&#20197;&#19979;&#12398;&#32626;&#21517;&#12399;&#26908;&#35388;&#12391;&#12365;&#12414;&#12379;&#12435;&#12391;&#12375;&#12383;: NO_PUBKEY ...&#8592; &#12434;&#20837;&#12428;&#12427;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3d30bc7" class="outline-3">
<h3 id="org3d30bc7"><a href="#org3d30bc7">cinnamonを再起動する</a></h3>
<div class="outline-text-3" id="text-org3d30bc7">
<p>
ウィンドウマネージャを再起動したいときがある。
</p>
<div class="org-src-container">
<pre class="src src-shell">cinnamon --replace
</pre>
</div>
</div>
</div>
<div id="outline-container-orgf0b2bf6" class="outline-3">
<h3 id="orgf0b2bf6"><a href="#orgf0b2bf6">sourceコマンド</a></h3>
<div class="outline-text-3" id="text-orgf0b2bf6">
<p>
sourceは環境変数関係を再読み込みするのによく使う。
<code>source ~~/.bashrc</code> みたいに。
</p>

<p>
bashでは、 <code>.</code> でもできる。
つまり、 <code>. ~~/.bashrc</code> と書いても同じ意味になる。
</p>
</div>
</div>
<div id="outline-container-orgc0f7fb3" class="outline-3">
<h3 id="orgc0f7fb3"><a href="#orgc0f7fb3">sshが切れた時に処理が止まらないようにする</a></h3>
<div class="outline-text-3" id="text-orgc0f7fb3">
<p>
nohupをつけて実行すると、SSHが切れても実行され続ける。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>ssh先のターミナルにて</label><pre class="src src-shell">nohup make long_job &amp;
</pre>
</div>

<p>
<a href="https://qiita.com/f0o0o/items/7f9dfaf3f7392c0ce52f">sshが切れた時に処理が止まらないようにする - Qiita</a>
</p>
</div>
</div>
<div id="outline-container-org637b1bf" class="outline-3">
<h3 id="org637b1bf"><a href="#org637b1bf">コマンドの実行と出力結果を記録する</a></h3>
<div class="outline-text-3" id="text-org637b1bf">
<p>
<code>script</code> コマンドが便利。
実行してオンになると、 <code>exit</code> するまでの履歴をファイルに保存できる。
</p>

<p>
<a href="https://staffblog.amelieff.jp/entry/2020/04/20/130000">簡単にコマンドの実行ログをファイルに記録する方法 - アメリエフの技術ブログ</a>
</p>
</div>
</div>
<div id="outline-container-org3c7d681" class="outline-3">
<h3 id="org3c7d681"><a href="#org3c7d681">踏み台を経由したssh</a></h3>
<div class="outline-text-3" id="text-org3c7d681">
<p>
普通にやると、2回sshコマンドを実行するので面倒。
configに記入しておいて、一度に実行する。
</p>

<pre class="example">
Host &lt;alias_name&gt;
  HostName &lt;target_server&gt;
  User &lt;target_user&gt;
  IdentityFile &lt;target_id_rsa&gt;
  ProxyCommand ssh -W %h:%p -i &lt;bastion_id_rsa&gt; -p &lt;bastion_port&gt; &lt;bastion_user&gt;@&lt;bastion_server&gt;
</pre>

<p>
<a href="https://qiita.com/hkak03key/items/3b0c4752bfbcc52e676d">踏み台サーバを飛び越えて一発で目的のサーバへsshする方法 - Qiita</a>
</p>
</div>
</div>
<div id="outline-container-org888e1ee" class="outline-3">
<h3 id="org888e1ee"><a href="#org888e1ee">input関係の設定を.bash_profile等でしてはいけない理由</a></h3>
<div class="outline-text-3" id="text-org888e1ee">
<p>
<a href="https://wiki.archlinux.jp/index.php/Fcitx#.E6.97.A5.E6.9C.AC.E8.AA.9E">Fcitx - ArchWiki</a>
</p>

<blockquote>
<p>
上記の設定を .bashrc でしないでください。.bashrc はインタラクティブな bash セッションを初期化するときに使われます。インタラクティブでないセッションや X セッションの初期化では用いられません。さらに、.bashrc で環境変数を設定すると、コマンドラインから実行した診断ツールに誤解を与えて、X セッションでは環境変数が使われていないのに正しく設定されているかのように表示されることがあります。
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org69b9992" class="outline-3">
<h3 id="org69b9992"><a href="#org69b9992">cronで通知する</a></h3>
<div class="outline-text-3" id="text-org69b9992">
<p>
cronで時報を通知したいけど、表示されないことがある。これはcronがCLI向けのコマンドであって、画面出力があることを想定してないから。
</p>

<p>
指定する。普通はこれでOK。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>GUIが関係するコマンドを実行するときはDISPLAY=:0をつける</label><pre class="src src-shell"><span class="org-builtin">export</span> <span class="org-variable-name">DISPLAY</span>=:0 &amp;&amp; notify-send <span class="org-string">"&#26178;&#22577;"</span> <span class="org-string">"$(date +\%H):00!"</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>実行ログを見る</label><pre class="src src-shell">cat /var/log/syslog
</pre>
</div>

<p>
<a href="20210905140122-exwm.html#ID-eb196529-bdbd-48c5-9d5b-a156fe5c2f41">EXWM</a> + dunstの環境でうまくいかなかった。
DBUS_SESSION_BUS_ADDRESSの設定が必要なよう。参考サイトをコピペすると通知できるようになった。
</p>
<div class="org-src-container">
<pre class="src src-shell">00 * * * * <span class="org-variable-name">DISPLAY</span>=:0 <span class="org-variable-name">DBUS_SESSION_BUS_ADDRESS</span>=unix:<span class="org-variable-name">path</span>=/run/user/1000/bus setpriv --euid=1000 notify-send <span class="org-string">"Timebot"</span> <span class="org-string">"$(date +\%H):00!"</span>
</pre>
</div>
<p>
<a href="https://bbs.archlinux.org/viewtopic.php?id=223050">Cannot run notify-send from cron job / Newbie Corner / Arch Linux Forums</a>
</p>
</div>
</div>
<div id="outline-container-orgb3c458a" class="outline-3">
<h3 id="orgb3c458a"><a href="#orgb3c458a">xargsで一括削除</a></h3>
<div class="outline-text-3" id="text-orgb3c458a">
<p>
TODO: xargsシリーズどこかにまとめたい。
</p>
<div class="org-src-container">
<pre class="src src-shell">find . -name <span class="org-string">"*.log"</span> | xargs rm -fv
</pre>
</div>

<p>
findでファイルのリストを作成して、xargsに渡す。
xargsはファイルを1つずつrmに渡す。
</p>

<p>
xargsにはdry-runモードがある。
</p>
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>pオプションがついてると生成コマンドを確認するだけで実行しない</label><pre class="src src-shell">find . -name <span class="org-string">"*.log"</span> | xargs -p rm -fv
</pre>
</div>

<p>
<a href="https://techblog.kyamanak.com/entry/2018/02/12/202256">【Linux】xargs コマンドの使い方がよく分からない - きゃまなかのブログ</a>
</p>
</div>
</div>
<div id="outline-container-org80c8520" class="outline-3">
<h3 id="org80c8520"><a href="#org80c8520">xargsでリポジトリ内一括置換</a></h3>
<div class="outline-text-3" id="text-org80c8520">
<p>
git grep、xargs、sedを組み合わせる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>リポジトリの2.6.5という文字列を2.7.1に置換する例</label><pre class="src src-shell">git grep -l <span class="org-string">'2\.6\.5'</span> | xargs sed -i <span class="org-string">'s/2\.6\.5/2.7.1/g'</span>
</pre>
</div>

<ul class="org-ul">
<li>git grepの <code>l</code> オプションはヒットしたファイル名を出力する。</li>
<li>xargsは標準出力からリストを読み込み、出力を次のコマンドの引数に渡すコマンド。</li>
<li>sedは置換。 <code>i</code> オプションは結果を画面出力しないオプション。 本来は <code>sed -i "s/aaa/bbb/s" Gemfile</code> みたいな順だが、xargsで自動で渡されている。</li>
</ul>
</div>
</div>
<div id="outline-container-org529c764" class="outline-3">
<h3 id="org529c764"><a href="#org529c764">一括git clone</a></h3>
<div class="outline-text-3" id="text-org529c764">
<p>
<a href="20210926103926-github.html#ID-6b889822-21f1-4a3e-9755-e3ca52fa0bc4">GitHub</a>から、
個人 or 組織のリポジトリをすべてダウンロードする方法。
</p>
<div class="org-src-container">
<pre class="src src-shell">curl https://api.github.com/users/{USER}/repos?<span class="org-variable-name">per_page</span>=100 | jq .[].ssh_url | xargs -n 1 git clone
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">curl https://api.github.com/orgs/{ORG}/repos?<span class="org-variable-name">per_page</span>=100  | jq .[].ssh_url | xargs -n 1 git clone
</pre>
</div>

<p>
<code>?per_page=100</code> をつけないとデフォルトの30件しか取ってこないので注意。
100を超えるとページを指定する必要がある。
</p>

<ul class="org-ul">
<li><a href="https://tic40.hatenablog.com/entry/2018/03/26/073000">https://tic40.hatenablog.com/entry/2018/03/26/073000</a></li>
</ul>

<p>
参考に読む用リポジトリは、organizationにまとめておく。
ローカルですぐ閲覧できて便利。
</p>
</div>
</div>
<div id="outline-container-orgfceef1b" class="outline-3">
<h3 id="orgfceef1b"><a href="#orgfceef1b">Cinnamonのコントロールパネルを出す</a></h3>
<div class="outline-text-3" id="text-orgfceef1b">
<p>
これが起動できればサウンドやディスプレイ設定もできる。
</p>
<div class="org-src-container">
<pre class="src src-shell">cinnamon-settings
</pre>
</div>
</div>
</div>
<div id="outline-container-org398491d" class="outline-3">
<h3 id="org398491d"><a href="#org398491d">失敗時例外を出す</a></h3>
<div class="outline-text-3" id="text-org398491d">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span>

<span class="org-builtin">set</span> -e

<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
</pre>
</div>
<p>
というように、しておくと、実行時できなかったときにエラーメッセージを出す。
何も指定しないと、どこで失敗したのか把握するのが困難。
ローカル環境だといいのだが、CIだと確認コストがかかるので必ず指定しておくとよい。
</p>
</div>
</div>
<div id="outline-container-org4c78c11" class="outline-3">
<h3 id="org4c78c11"><a href="#org4c78c11">デバッグメッセージ出力</a></h3>
<div class="outline-text-3" id="text-org4c78c11">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">bash</span><span class="org-comment"> -x</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">...</span>
</pre>
</div>
<p>
-xをつけると評価結果を逐一出力する。
</p>
</div>
</div>
<div id="outline-container-org7a4aa25" class="outline-3">
<h3 id="org7a4aa25"><a href="#org7a4aa25">GNOMEの音量調整</a></h3>
<div class="outline-text-3" id="text-org7a4aa25">
<div class="org-src-container">
<pre class="src src-shell">pactl set-sink-volume @DEFAULT_SINK@ +5%
pactl set-sink-volume @DEFAULT_SINK@ -5%
</pre>
</div>
</div>
</div>
<div id="outline-container-org2802eb6" class="outline-3">
<h3 id="org2802eb6"><a href="#org2802eb6">カレントディレクトリ行数カウント</a></h3>
<div class="outline-text-3" id="text-org2802eb6">
<div class="org-src-container">
<pre class="src src-shell">wc -l <span class="org-sh-quoted-exec">`find ./ -name '*.el'`</span>
</pre>
</div>

<p>
別解。
</p>
<div class="org-src-container">
<pre class="src src-shell">git ls-files *.org | xargs wc -c | sort -n
</pre>
</div>
</div>
</div>
<div id="outline-container-org086f077" class="outline-3">
<h3 id="org086f077"><a href="#org086f077">ディレクトリの全ファイルで実行する</a></h3>
<div class="outline-text-3" id="text-org086f077">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-keyword">for</span> file<span class="org-keyword"> in</span> <span class="org-sh-quoted-exec">`\find ./src -name '*.py'`</span>;
<span class="org-keyword">do</span>
<span class="org-builtin">echo</span> $<span class="org-variable-name">file</span>
python $<span class="org-variable-name">file</span> | sed -e s/.*[0-9]m// &gt;&gt; ./docs/query.org
<span class="org-keyword">done</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org3abe6ab" class="outline-3">
<h3 id="org3abe6ab"><a href="#org3abe6ab">port検索する</a></h3>
<div class="outline-text-3" id="text-org3abe6ab">
<p>
port already in used. が出たとき。
</p>

<p>
プロセスを探す。
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo lsof -i:5432
</pre>
</div>

<p>
ポートを使ってるプロセスを削除する。
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo lsof -t -i tcp:5432 | sudo xargs kill -9
</pre>
</div>
</div>
</div>
<div id="outline-container-org6e40c43" class="outline-3">
<h3 id="org6e40c43"><a href="#org6e40c43">LinuxでWindowsのブートメディアを作成する</a></h3>
<div class="outline-text-3" id="text-org6e40c43">
<p>
woeusbというパッケージをインストールして行う。
</p>
<div class="org-src-container">
<pre class="src src-shell">sudo add-apt-repository ppa:tomtomtom/woeusb
sudo apt update &amp;&amp; sudo apt install woeusb-frontend-wxgtk
</pre>
</div>
<p>
<a href="https://www.omgubuntu.co.uk/2017/06/create-bootable-windows-10-usb-ubuntu">https://www.omgubuntu.co.uk/2017/06/create-bootable-windows-10-usb-ubuntu</a>
</p>
</div>
</div>
<div id="outline-container-orgaf5075c" class="outline-3">
<h3 id="orgaf5075c"><a href="#orgaf5075c">aptコマンド</a></h3>
<div class="outline-text-3" id="text-orgaf5075c">
<p>
aptはdebian系ディストリビューションで用いられるパッケージマネージャ。
</p>
<ul class="org-ul">
<li>パッケージ検索</li>
</ul>
<div class="org-src-container">
<pre class="src src-shell">apt search libffi
</pre>
</div>
</div>
</div>
<div id="outline-container-orge151d84" class="outline-3">
<h3 id="orge151d84"><a href="#orge151d84">suspendする</a></h3>
<div class="outline-text-3" id="text-orge151d84">
<p>
コマンドでサスペンドする方法。
</p>

<p>
Ubuntuのとき。
</p>
<div class="org-src-container">
<pre class="src src-shell">systemctl suspend
</pre>
</div>

<p>
GNU Guixのとき。
</p>
<div class="org-src-container">
<pre class="src src-shell">loginctl suspend
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb87a1fb" class="outline-3">
<h3 id="orgb87a1fb"><a href="#orgb87a1fb">プロセスを止める</a></h3>
<div class="outline-text-3" id="text-orgb87a1fb">
<p>
簡単に検索、killできる。
</p>
<div class="org-src-container">
<pre class="src src-shell">pgrep firefox
pkill firefox
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org87f17fa" class="outline-2">
<h2 id="org87f17fa"><a href="#org87f17fa">References</a></h2>
<div class="outline-text-2" id="text-org87f17fa">
</div>
<div id="outline-container-org84504cd" class="outline-3">
<h3 id="org84504cd"><a href="#org84504cd"><a href="https://github.com/stedolan/jq">stedolan/jq: Command-line JSON processor</a></a></h3>
<div class="outline-text-3" id="text-org84504cd">
<p>
jsonを扱う便利コマンド。
</p>
</div>
</div>
</div>
<div id="outline-container-orgf1f9305" class="outline-2">
<h2 id="orgf1f9305"><a href="#orgf1f9305">Tasks</a></h2>
<div class="outline-text-2" id="text-orgf1f9305">
</div>
<div id="outline-container-orgf6305e6" class="outline-3">
<h3 id="orgf6305e6"><a href="#orgf6305e6"><span class="todo TODO">TODO</span> <a href="https://www.itmedia.co.jp/enterprise/articles/0811/20/news019.html">インストール済みUbuntuのクローンを新しいハードディスクに作成する：Linux Hacks（1/2 ページ） - ITmedia エンタープライズ</a></a></h3>
<div class="outline-text-3" id="text-orgf6305e6">
<p>
まとめておく。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
