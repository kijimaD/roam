:properties:
:ID: 20240421T010312
:mtime:    20250626233011
:ctime:    20241028101410
:end:
#+title:      KDOC 138: Goãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©ã®ä½¿ã„æ–¹ã‚’è¦‹ã‚‹
#+date:       [2024-04-21 Sun 01:03]
#+filetags:   :wiki:
#+identifier: 20240421T010312

* ã“ã®æ–‡æ›¸ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- ä½œæˆ
  - [X] 2024-04-28 è²´å³¶
- ãƒ¬ãƒ“ãƒ¥ãƒ¼
  - [X] 2024-05-06 è²´å³¶

* æ¦‚è¦
Goã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©ã€ ~pprof~ ã‚’ä½¿ã†æ‰‹é †ã‚’æ›¸ãã€‚

* èƒŒæ™¯
[[id:7cacbaa3-3995-41cf-8b72-58d6e07468b1][Go]]ã‚’ä½¿ã£ã¦ã‚²ãƒ¼ãƒ é–‹ç™ºã™ã‚‹éç¨‹ã§ã€ã„ã¤ã®ã¾ã«ã‹ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ã—ã¦ã„ãŸã®ã‚’ç™ºè¦‹ã—ãŸã€‚åŸå› ã‚’æ¢ã‚‹ãŸã‚ã«ã€ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©ã‚’ä½¿ã£ã¦åŸå› ç®‡æ‰€ã‚’ç‰¹å®šã§ããŸã€‚å¼·åŠ›ãªèª¿æŸ»æ–¹æ³•ãªã®ã§ã€ã„ã¤ã§ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

* æ‰‹é †
~pprof~ ã®èµ·å‹•ã‚„å–å¾—æ–¹æ³•ã«ã¯ã„ãã¤ã‹ã®çµ„ã¿åˆã‚ã›ãŒã‚ã‚‹ã€‚çµ„ã¿åˆã‚ã›ã‚‹è‡ªç”±åº¦ãŒé«˜ã„ã®ã¯ã„ã„ãŒã€ã‚„ã‚„ã¨ã£ã¤ãã¥ã‚‰ã„ã€‚ã‚‚ã£ã¨ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ã«è¦‹ãˆã‚‹çµ„ã¿åˆã‚ã›ã ã‘ã‚’æ›¸ãã€‚

** 1. ã‚³ãƒ¼ãƒ‰ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©ã‚’åŸ‹ã‚è¾¼ã‚€

ç„¡åã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚µãƒ¼ãƒã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ©ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒè¿½åŠ ã•ã‚Œã‚‹ã€‚

#+caption: ç„¡åã‚¤ãƒ³ãƒãƒ¼ãƒˆã¨ã‚µãƒ¼ãƒã®èµ·å‹•
#+begin_src go
  package main
  import _ "net/http/pprof"

  func main() {
          _ = http.ListenAndServe("localhost:6060", nil)
  }
#+end_src

** 2. å®Ÿè¡Œã™ã‚‹

åŸ‹ã‚è¾¼ã‚“ã ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ã—ã¦å®Ÿè¡Œã™ã‚‹ã¨ã€â†“ã®ã‚ˆã†ãªãƒ‘ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

#+begin_src shell
  http://localhost:6060/debug/pprof/
  http://localhost:6060/debug/pprof/allocs?debug=1
  http://localhost:6060/debug/pprof/block?debug=1
  http://localhost:6060/debug/pprof/cmdline?debug=1
  http://localhost:6060/debug/pprof/goroutine?debug=1
  http://localhost:6060/debug/pprof/heap?debug=1
  http://localhost:6060/debug/pprof/mutex?debug=1
  http://localhost:6060/debug/pprof/profile?debug=1
  http://localhost:6060/debug/pprof/threadcreate?debug=1
#+end_

  ,#+caption: /debug/pprof/allocsã‚’è¦‹ã¦ã¿ã‚‹
  ,#+begin_src
  heap profile: 51: 49689536 [177: 61751432] @ heap/8192
  4: 21135360 [4: 21135360] @ 0x76ba45 0x86a96f 0x8b24e5 0x8b1fa5 0x8b1e2f 0x8bbba8 0x8bf9d2 0x913465 0x7578fd 0x757b4e 0x75423b 0x9132b0 0x913294 0x913c8d 0x4423db 0x475481
  #	0x76ba44	image.NewAlpha+0x64								/usr/local/go/src/image/image.go:711
  #	0x86a96e	github.com/golang/freetype/truetype.NewFace+0x38e				/home/orange/go/pkg/mod/github.com/golang/freetype@v0.0.0-20170609003504-e2365dfdc4a0/truetype/face.go:206
  #	0x8b24e4	github.com/kijimaD/ruins/lib/engine/loader.processTextData+0x1a4		/home/orange/Project/ruins/lib/engine/loader/entity.go:231
  #	0x8b1fa4	github.com/kijimaD/ruins/lib/engine/loader.processComponentsListData+0x84	/home/orange/Project/ruins/lib/engine/loader/entity.go:110
  #	0x8b1e2e	github.com/kijimaD/ruins/lib/engine/loader.LoadEngineComponents+0x20e		/home/orange/Project/ruins/lib/engine/loader/entity.go:101
  #	0x8bbba7	github.com/kijimaD/ruins/lib/loader.PreloadEntities+0xe7			/home/orange/Project/ruins/lib/loader/loader.go:49
  #	0x8bf9d1	github.com/kijimaD/ruins/lib/game.InitWorld+0x471				/home/orange/Project/ruins/lib/game/game.go:97
  #	0x913464	github.com/kijimaD/ruins/lib/cmd.runPlay+0x124					/home/orange/Project/ruins/lib/cmd/play.go:43
  #	0x7578fc	github.com/urfave/cli/v2.(*Command).Run+0x9dc					/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/command.go:279
  #	0x757b4d	github.com/urfave/cli/v2.(*Command).Run+0xc2d					/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/command.go:272
  #	0x75423a	github.com/urfave/cli/v2.(*App).RunContext+0x5da				/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/app.go:337
  #	0x9132af	github.com/urfave/cli/v2.(*App).Run+0x2f					/home/orange/go/pkg/mod/github.com/urfave/cli/v2@v2.27.1/app.go:311
  #	0x913293	github.com/kijimaD/ruins/lib/cmd.RunMainApp+0x13				/home/orange/Project/ruins/lib/cmd/cmd.go:39
  #	0x913c8c	main.main+0x2c									/home/orange/Project/ruins/main.go:19
  #	0x4423da	runtime.main+0x2ba
#+end_src

** 3. ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åé›†ã™ã‚‹

ç”Ÿã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¯äººãŒè¦‹ã‚‹ã‚‚ã®ã§ã¯ãªã„ã€‚ ~pprof~ ã®åé›†ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦å¯è¦–åŒ–ã™ã‚‹ã€‚ã‚ˆãã‚ã‹ã‚‰ãªã„ãƒã‚¤ãƒ³ãƒˆã ãŒã€èµ·å‹•ä¸­ã®ã‚³ãƒãƒ³ãƒ‰ã¨åŒã˜ãƒã‚¤ãƒŠãƒªãŒå¿…è¦ã€‚ã“ã®ãƒã‚¤ãƒŠãƒªã‹ã‚‰ã‚³ãƒ¼ãƒ‰ä½ç½®ãªã©ã®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã‚‹ã®ã ã‚ã†ã‹ã€‚

#+begin_src shell
  # ãƒ“ãƒ«ãƒ‰
  $ go build . -o aaaa
  # ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«åé›†ã‚’å®Ÿè¡Œã™ã‚‹
  $ go tool pprof aaaa "http://localhost:6060/debug/pprof/profile?seconds=10"
#+end_src

â†‘ä¾‹ã§ã¯10ç§’é–“ã€èµ·å‹•ä¸­ã®ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰æƒ…å ±ã‚’åé›†ã™ã‚‹ã€‚

#+caption: å®Ÿè¡Œçµæœ
#+begin_src shell
  Fetching profile over HTTP from http://localhost:6060/debug/pprof/profile?seconds=10
  Saved profile in /home/orange/pprof/pprof.ruins.samples.cpu.008.pb.gz
  File: ruins
  Build ID: ab4fa2d3d6018e82aed20efe4b4d08193ee45510
  Type: cpu
  Time: Apr 27, 2024 at 4:00pm (JST)
  Duration: 10.16s, Total samples = 1.64s (16.15%)
  Entering interactive mode (type "help" for commands, "o" for options)
  (pprof) # ğŸ‘ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
#+end_src

10ç§’é–“å¾…ã£ã¦ã€ ~pprof~ ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå‡ºã‚Œã°æˆåŠŸã€‚å…¥åŠ›å¾…ã¡ã«ãªã‚‹ã€‚ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã¯ã€ã“ã“ã§ã‚°ãƒ©ãƒ•ç”»åƒã‚’è¡¨ç¤ºã§ããŸã‚Šã™ã‚‹ã€‚

** 4. ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¦‹ã‚‹

~pprof~ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒå‡ºã¦ã„ã‚‹çŠ¶æ…‹ã§ã€ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦çµæœã‚’å¾—ã‚‹ã€‚

#+caption: å¤§ãã„é †ã«è¡¨ç¤ºã™ã‚‹
#+begin_src shell
  (pprof) top
Showing nodes accounting for 1070ms, 65.24% of 1640ms total
Showing top 10 nodes out of 236
      flat  flat%   sum%        cum   cum%
     520ms 31.71% 31.71%      560ms 34.15%  runtime.cgocall
     320ms 19.51% 51.22%      320ms 19.51%  runtime.futex
      30ms  1.83% 53.05%       30ms  1.83%  github.com/golang/freetype/truetype.(*Font).scale (inline)
      30ms  1.83% 54.88%      130ms  7.93%  github.com/golang/freetype/truetype.(*GlyphBuf).Load
      30ms  1.83% 56.71%      120ms  7.32%  github.com/hajimehoshi/ebiten/v2/internal/atlas.(*Image).drawTriangles
      30ms  1.83% 58.54%       30ms  1.83%  github.com/hajimehoshi/ebiten/v2/internal/shaderir.(*Program).FilterUniformVariables
      30ms  1.83% 60.37%      240ms 14.63%  runtime.findRunnable
      30ms  1.83% 62.20%       30ms  1.83%  runtime.pMask.read (inline)
      30ms  1.83% 64.02%       30ms  1.83%  runtime/internal/syscall.Syscall6
      20ms  1.22% 65.24%       20ms  1.22%  github.com/golang/freetype/truetype.(*GlyphBuf).loadSimple
#+end_src

ã“ã‚Œã«ã‚ˆã£ã¦ã€ã‚³ãƒ¼ãƒ‰ã®ã©ã®éƒ¨åˆ†ã§ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¶ˆè²»ã—ã¦ã„ã‚‹ã‹ãŒã‚ã‹ã‚‹ã€‚

* é–¢é€£
- [[id:20240420T224401][KDOC 137: ç°¡å˜ã«ãƒ—ãƒ­ã‚»ã‚¹ã®ä½¿ç”¨ãƒ¡ãƒ¢ãƒªã‚’ç¢ºèªã™ã‚‹]]ã€‚ã§ç¢ºã‹ã«ãƒªãƒ¼ã‚¯ã—ã¦ã„ã‚‹ã“ã¨ã‚’ã–ã£ãã‚Šèª¿ã¹ãŸã€‚ã•ã‚‰ã«åŸå› ã‚’çµã‚‹
- [[id:20231128T074518][KDOC 59: ECSã‚’ä½¿ã£ã¦ã‚µãƒ³ãƒ—ãƒ«ã‚²ãƒ¼ãƒ ã‚’ä½œã‚‹]]ã€‚ã®éç¨‹ã§èª¿ã¹ã‚‹ã®ã«ä½¿ã£ãŸ
