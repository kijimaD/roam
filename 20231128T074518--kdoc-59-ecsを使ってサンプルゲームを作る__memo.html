<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-05-07 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KDOC 59: ECSを使ってサンプルゲームを作る</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">KDOC 59: ECSを使ってサンプルゲームを作る</h1>
<p>
<a href="20230930175757-entitycomponentsystem.html#ID-dc45bd7d-b8c4-47ef-ae84-c548f81c50bb">EntityComponentSystem</a>を使って、サンプルゲームを作る。
</p>

<iframe width="560" height="315" src="https://kijimad.github.io/ruins/"></iframe>

<p>
実際のゲーム画面。ウィンドウにフォーカスして方向キーで操作できる。
</p>

<ul class="org-ul">
<li>リポジトリ。<a href="https://github.com/kijimaD/ruins">kijimaD/ruins</a></li>
</ul>

<div id="outline-container-orge37fcf4" class="outline-2">
<h2 id="orge37fcf4"><a href="#orge37fcf4">方針</a></h2>
<div class="outline-text-2" id="text-orge37fcf4">
<p>
まずストーリー抜きで、RPGとしてゲームが成立するようにする。
</p>
</div>
</div>

<div id="outline-container-org142777f" class="outline-2">
<h2 id="org142777f"><a href="#org142777f">Tasks</a></h2>
<div class="outline-text-2" id="text-org142777f">
</div>
<div id="outline-container-org7234323" class="outline-3">
<h3 id="org7234323"><a href="#org7234323"><span class="todo TODO">TODO</span> カメラ移動を追加する</a></h3>
<div class="outline-text-3" id="text-org7234323">
<p>
後からやると大変そうなので今のうちにやっておく。
</p>

<ul class="org-ul">
<li>置物はgrid elementにしたほうが楽そうな感じがしてきた。いちいち座標で持っているのが扱いにくい。また別の問題は起きそうだが&#x2026;</li>
<li>グリッドの方が生成もしやすいしな</li>
<li>でもグリッドだと、グリッドごとでしか配置できない。壁とかはそれでいいが、プレイヤーや敵はそうではない。描画で2つ必要になるのは微妙そうな</li>
</ul>
</div>
</div>

<div id="outline-container-orge236a11" class="outline-3">
<h3 id="orge236a11"><a href="#orge236a11"><span class="todo TODO">TODO</span> 階層を追加する</a></h3>
<div class="outline-text-3" id="text-orge236a11">
<p>
ステージの初期化と、階層移動できるようにする。
</p>

<ul class="org-ul">
<li>現状はフロアの概念がない。ステートに入ったときに1フロア分初期化してるだけ</li>
<li><a href="https://ebitengine.org/ja/examples/isometric.html">https://ebitengine.org/ja/examples/isometric.html</a> が参考になりそう</li>
</ul>
</div>
</div>

<div id="outline-container-org69cc3f5" class="outline-3">
<h3 id="org69cc3f5"><a href="#org69cc3f5"><span class="todo TODO">TODO</span> 視覚影でスプライトが隠れているのを直す</a></h3>
<div class="outline-text-3" id="text-org69cc3f5">
<p>
近くのライトで見られるようにしたが、微妙だ。
</p>

<ul class="org-ul">
<li>壁の向こう側が見える
<ul class="org-ul">
<li>対策のため1マス分だけ照らすようにしたが、変だ</li>
</ul></li>
<li>やはり、直接視界が当たった部分はフラグをもたせて表示するのがよさそう
<ul class="org-ul">
<li>個別のタイルごとにあるので、新しくコンポーネントを作ったほうがよさそう</li>
<li><code>IsHide</code> とか</li>
</ul></li>
<li>ここに時間かけてもしょうがないから後回しか</li>
</ul>
</div>
</div>

<div id="outline-container-org4f42f9a" class="outline-3">
<h3 id="org4f42f9a"><a href="#org4f42f9a"><span class="todo TODO">TODO</span> 描画の優先順を指定できるようにする</a></h3>
<div class="outline-text-3" id="text-org4f42f9a">
<p>
ワープパッドとキャラでは、キャラを上に表示する。
</p>

<ul class="org-ul">
<li>キャラクター
<ul class="org-ul">
<li>キャラクター同士は重ならない</li>
</ul></li>
<li>ワープパッド
<ul class="org-ul">
<li>同士は重ならない</li>
</ul></li>
<li>フィールドのアイテム
<ul class="org-ul">
<li>同士は重ならない</li>
</ul></li>
<li>これは、SpriteRenderに設定してよさそうか。タイルの種別ごとに設定できれば問題ないよな</li>
<li>SpriteRenderはengineにあるので、移動させてからいじるか&#x2026;</li>
</ul>
</div>
</div>
<div id="outline-container-org0348698" class="outline-3">
<h3 id="org0348698"><a href="#org0348698"><span class="todo TODO">TODO</span> levelを消す</a></h3>
<div class="outline-text-3" id="text-org0348698">
<p>
普通のgameComponent(engineではないほう)でlevelを実装してから、消す感じでいいか。参考になりそうだから消してない。
</p>
</div>
</div>
<div id="outline-container-org78b66ba" class="outline-3">
<h3 id="org78b66ba"><a href="#org78b66ba"><span class="todo TODO">TODO</span> レイキャスト範囲を狭くする</a></h3>
<div class="outline-text-3" id="text-org78b66ba">
<p>
今後オブジェクトを増やすたびに重くなるので。
</p>

<p>
ある程度狭い範囲に、不可視オブジェクトを配置するとどうだろう。今、ステージのまわりに配置しているやつ。
</p>

<ul class="org-ul">
<li>NPCを追加したときに、競合しないか。つまりほかの視界をもつオブジェクトとの兼ね合いをどうするかの問題はある
<ul class="org-ul">
<li>それぞれのエンティティごとに競合しない形であれば、よさそうか</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-org803d65d" class="outline-3">
<h3 id="org803d65d"><a href="#org803d65d"><span class="todo TODO">TODO</span> engine コンポーネントを移す</a></h3>
<div class="outline-text-3" id="text-org803d65d">
<p>
分かれてるのがやりづらい。分け方が利用側からすると不明瞭。ただloaderまわりが大変そう。
</p>

<ul class="org-ul">
<li>うむむ、共通のものはengine部分にあったほうがよい感じもしてきた</li>
<li>依存しないためにinterfaceになるが</li>
<li>SpriteSheet componentsは移せない。engineのResourceで定義されているから。依存してしまう
<ul class="org-ul">
<li>resourceごと移動するか&#x2026;</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgdf94e81" class="outline-3">
<h3 id="orgdf94e81"><a href="#orgdf94e81"><span class="todo TODO">TODO</span> いったんクリアできるようにする</a></h3>
<div class="outline-text-3" id="text-orgdf94e81">
<p>
戦闘抜きで、全体を作る。
</p>

<ul class="org-ul">
<li>ステージは手動で作っておき、それをランダムに選ぶ</li>
<li>将来的に複数のステージ生成手法から選べるようにしておく</li>
</ul>
</div>
</div>
<div id="outline-container-org2f85560" class="outline-3">
<h3 id="org2f85560"><a href="#org2f85560"><span class="todo TODO">TODO</span> 階層移動できるようにする</a></h3>
<div class="outline-text-3" id="text-org2f85560">
<ul class="org-ul">
<li>触れた判定できるようにする</li>
<li>触れたときにイベントを発火する</li>
</ul>
</div>
</div>
<div id="outline-container-orgdfbf50e" class="outline-3">
<h3 id="orgdfbf50e"><a href="#orgdfbf50e"><span class="todo TODO">TODO</span> 階層設計</a></h3>
<div class="outline-text-3" id="text-orgdfbf50e">
<p>
ランダムだと難しそうなのでとりあえずは手動か。
</p>

<p>
どうやって内外を判定すればいいのだろう。
</p>
</div>
</div>
<div id="outline-container-org1091585" class="outline-3">
<h3 id="org1091585"><a href="#org1091585"><span class="todo TODO">TODO</span> 汎用の選択コンテナを作成する</a></h3>
<div class="outline-text-3" id="text-org1091585">
<p>
メニューなど、なにかを一覧して選択するのは多く使うので、作っておきたい。
</p>

<p>
メニュー。
</p>

<ul class="org-ul">
<li>選択肢のリスト</li>
<li>現在選択中の番号を示す変数</li>
</ul>

<p>
ゲージ。
</p>

<ul class="org-ul">
<li>HP</li>
<li>レベル</li>
<li>名前</li>
</ul>

<p>
どうやればいいのだろうか。
</p>

<ul class="org-ul">
<li>構造体で作っておいて、後で代入できるようにしとくといいのでは。あとその構造体に親子関係を作るメソッドを作ると。</li>
</ul>

<div class="org-src-container">
<pre class="src src-go">type aa struct {
        root ui.Container
        desc ui.Container
        list ui.Container
}

func (aa *aa) assemble {
        aa.root.AddChild(aa.desc)
        aa.root.AddChild(aa.list)
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org1db07b8" class="outline-3">
<h3 id="org1db07b8"><a href="#org1db07b8"><span class="todo TODO">TODO</span> リアルタイムなローグライクがよさそう</a></h3>
<div class="outline-text-3" id="text-org1db07b8">
<ul class="org-ul">
<li>フィールドは<a href="https://ebitengine.org/en/examples/raycasting.html">Ray Casting - Ebitengine</a>という感じ</li>
<li>タイルごとにターン制で動くという感じでない。細かく移動できる</li>
<li>自分が動いたら時間が進行する</li>
<li>シンボルエンカウントで、回避する方法がある。煙幕的な</li>
<li>電力と燃料がある
<ul class="org-ul">
<li>電力は短期的なスタミナ。フィールドでダッシュ、煙幕、掘削で減る。有利に進められるが、時間での制限がある</li>
<li>燃料は、腹減り度。電力を使うと早く消費する。なくなるとゲームオーバーになる。移動で減る</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd3e560d" class="outline-3">
<h3 id="orgd3e560d"><a href="#orgd3e560d"><span class="todo TODO">TODO</span> 合成のレアリティスコア</a></h3>
<div class="outline-text-3" id="text-orgd3e560d">
<p>
性能にスコアをつけ、結果的に出来上がったものに対してレアリティランクをつけるとよさそう。
</p>
</div>
</div>
<div id="outline-container-orge9a93ff" class="outline-3">
<h3 id="orge9a93ff"><a href="#orge9a93ff"><span class="todo TODO">TODO</span> イベント部分の設計</a></h3>
<div class="outline-text-3" id="text-orge9a93ff">
<p>
1章のうろつきをどうするか考える。
</p>

<ul class="org-ul">
<li>ローグライト形式にすると物語に関してあまり考えなくてよい
<ul class="org-ul">
<li>繰り返しのゲームプレイに変化をつけやすい</li>
<li>設定とかが伝わりにくい可能性がある</li>
<li>Tipsという形式でオプショナルに読めればよさそう</li>
<li>Tipsだと自然に紹介できなさそうな感じもする</li>
<li>あまり物語性はない</li>
<li>物語部分は背景やSEつきのメッセージ形式で良い</li>
</ul></li>
<li>行けるところはランダムで選ばれた4つにする
<ul class="org-ul">
<li>行った回数によってイベントが起こる</li>
<li>背反なイベントがある</li>
<li>回数を重ねることで仲間になったりアイテムがもらえたりする
<ul class="org-ul">
<li>例</li>
<li>市場 x 2 =&gt; 整備士が仲間になる</li>
<li>広場 x 2 =&gt; 回復薬がもらえる</li>
</ul></li>
<li>単調な感じもする</li>
</ul></li>
<li>イベントによって仲間になったり、アイテムが増えたり、ステータスが変動したりする</li>
</ul>
</div>
</div>

<div id="outline-container-org648adc9" class="outline-3">
<h3 id="org648adc9"><a href="#org648adc9"><span class="todo TODO">TODO</span> アイテム使用・削除をsystem化する</a></h3>
<div class="outline-text-3" id="text-org648adc9">
<p>
wantsToUseエンティティを生成して、そのエンティティをsystemでキャッチする。
</p>

<p>
直接削除すると共通処理が追加しにくかったりする。
</p>

<p>
共通の関数化するだけでよさそうな感じもする。実行順とかがややこしくなるのかな。メッセージを伝える用のエンティティをいちいち作るのが面倒なんだよな。コードも増える。
</p>
</div>
</div>

<div id="outline-container-org7e29325" class="outline-3">
<h3 id="org7e29325"><a href="#org7e29325"><span class="todo TODO">TODO</span> モジュール分けする</a></h3>
<div class="outline-text-3" id="text-org7e29325">
<p>
名前がかぶってややこしいものは分ける。
</p>

<ul class="org-ul">
<li>system</li>
<li>app</li>
<li>message engine</li>
</ul>
</div>
</div>
<div id="outline-container-org7d8f18f" class="outline-3">
<h3 id="org7d8f18f"><a href="#org7d8f18f"><span class="todo TODO">TODO</span> 味方一覧表示を共通化する</a></h3>
<div class="outline-text-3" id="text-org7d8f18f">
<p>
いろんなところで使いそうかつ、複数のパーツで構成されているので作成が面倒なので。
</p>
</div>
</div>

<div id="outline-container-orgff1c6ad" class="outline-3">
<h3 id="orgff1c6ad"><a href="#orgff1c6ad"><span class="todo TODO">TODO</span> ステート切り替えが怪しい部分がある</a></h3>
<div class="outline-text-3" id="text-orgff1c6ad">
<p>
特にpopしている部分。
</p>

<ul class="org-ul">
<li>pushで、文字があると重なる</li>
<li>popしたときにOnStartは走らないので、前の画面を削除するのはダメ</li>
</ul>
</div>
</div>

<div id="outline-container-org7e3b9ce" class="outline-3">
<h3 id="org7e3b9ce"><a href="#org7e3b9ce"><span class="todo TODO">TODO</span> 図形 or 画像描画の方法を考える</a></h3>
<div class="outline-text-3" id="text-org7e3b9ce">
<p>
UIのために図形描画したい。どうするか。画像を用意すればよいが、いい感じにやるためにはどうすればいいか。
</p>
</div>
</div>

<div id="outline-container-org42c4dda" class="outline-3">
<h3 id="org42c4dda"><a href="#org42c4dda"><span class="todo TODO">TODO</span> 生成をランダム化する</a></h3>
<div class="outline-text-3" id="text-org42c4dda">
<p>
ある程度ランダム化したい。プレイヤー、モンスター、ワープゲートの出る位置をバラけさせる。
</p>
</div>
</div>

<div id="outline-container-org01e06a5" class="outline-3">
<h3 id="org01e06a5"><a href="#org01e06a5"><span class="todo TODO">TODO</span> 暗闇を追加する</a></h3>
<div class="outline-text-3" id="text-org01e06a5">
<p>
未探検の部分は暗くなる。
</p>
</div>
</div>

<div id="outline-container-orga5db907" class="outline-3">
<h3 id="orga5db907"><a href="#orga5db907"><span class="todo TODO">TODO</span> 照明を追加する</a></h3>
<div class="outline-text-3" id="text-orga5db907">
<p>
照明がある部分は色が変わる。
</p>
</div>
</div>

<div id="outline-container-orgf1e60dd" class="outline-3">
<h3 id="orgf1e60dd"><a href="#orgf1e60dd"><span class="todo TODO">TODO</span> キャラクタを生成する</a></h3>
<div class="outline-text-3" id="text-orgf1e60dd">
<p>
味方/敵を生成する。
</p>
</div>
</div>

<div id="outline-container-org4455e15" class="outline-3">
<h3 id="org4455e15"><a href="#org4455e15"><span class="todo TODO">TODO</span> タイルの種類を増やす</a></h3>
<div class="outline-text-3" id="text-org4455e15">
<p>
見た目がよくないので、2種類の通常フロアを用意する。
</p>

<p>
ステージ作成が少し面倒になるか。2種類のタイルの違いをファイルに書き出したくないな。勝手に判断して入れてくれるのが一番良い。壁が隣接してたら〜とか。
</p>
</div>
</div>

<div id="outline-container-orge91d227" class="outline-3">
<h3 id="orge91d227"><a href="#orge91d227"><span class="todo TODO">TODO</span> ゲームループカウントをグローバル化する</a></h3>
<div class="outline-text-3" id="text-orge91d227">
<p>
数えてメッセージのアニメーションさせる用。汎用的なのでグローバルでやってよさそう。アニメーションのためのもっとよい方法がある可能性はある。ちゃんと調べないとな…。
</p>
</div>
</div>

<div id="outline-container-org858fc67" class="outline-3">
<h3 id="org858fc67"><a href="#org858fc67"><span class="todo TODO">TODO</span> アニメーションのやり方を考える</a></h3>
<div class="outline-text-3" id="text-org858fc67">
<p>
どうやっているのだろう。
</p>
</div>
</div>
<div id="outline-container-org8c08850" class="outline-3">
<h3 id="org8c08850"><a href="#org8c08850"><span class="todo TODO">TODO</span> 階の生成方法を考える</a></h3>
<div class="outline-text-3" id="text-org8c08850">
<ul class="org-ul">
<li>ランダム選択の一般階層
<ul class="org-ul">
<li>ダンジョンによって選ばれやすさに偏りがある</li>
<li>5の倍数の場合は帰還ワープも出す</li>
<li>すべてのマップに帰還ワープを設定しておく</li>
</ul></li>
<li>ボスの階層
<ul class="org-ul">
<li>特殊マップ</li>
<li>固定</li>
</ul></li>
</ul>
</div>
</div>

<div id="outline-container-orgebf7f65" class="outline-3">
<h3 id="orgebf7f65"><a href="#orgebf7f65"><span class="todo TODO">TODO</span> メッセージシステムのパッケージを切り出す</a></h3>
<div class="outline-text-3" id="text-orgebf7f65">
<p>
今は1パッケージに入っていてわかりにくい。
</p>
</div>
</div>
</div>
<div id="outline-container-org662e3ae" class="outline-2">
<h2 id="org662e3ae"><a href="#org662e3ae">Archives</a></h2>
<div class="outline-text-2" id="text-org662e3ae">
</div>
<div id="outline-container-org79dfe87" class="outline-3">
<h3 id="org79dfe87"><a href="#org79dfe87"><span class="done DONE">DONE</span> メッセージ表示できるようにする</a></h3>
<div class="outline-text-3" id="text-org79dfe87">
<p>
<a href="https://github.com/x-hgg-x/sokoban-go">x-hgg-x/sokoban-go</a>を使って小さいサンプルを作る。
</p>
</div>
</div>
<div id="outline-container-orgdbd98a2" class="outline-3">
<h3 id="orgdbd98a2"><a href="#orgdbd98a2"><span class="done DONE">DONE</span> メッセージシステムのリファクタ</a></h3>
<div class="outline-text-3" id="text-orgdbd98a2">
<p>
使いにくいので直す。
</p>
</div>
</div>
<div id="outline-container-orgd1c685d" class="outline-3">
<h3 id="orgd1c685d"><a href="#orgd1c685d"><span class="done DONE">DONE</span> メッセージシステムに自動改行を入れる</a></h3>
<div class="outline-text-3" id="text-orgd1c685d">
<p>
飛び出すのを防ぐ。
</p>
</div>
</div>
<div id="outline-container-org92b13ce" class="outline-3">
<h3 id="org92b13ce"><a href="#org92b13ce"><span class="done DONE">DONE</span> ファイルを埋め込む</a></h3>
<div class="outline-text-3" id="text-org92b13ce">
<p>
デプロイで扱いやすいように。
</p>
</div>
</div>

<div id="outline-container-org7aa5f04" class="outline-3">
<h3 id="org7aa5f04"><a href="#org7aa5f04"><span class="done DONE">DONE</span> CI設定</a></h3>
<div class="outline-text-3" id="text-org7aa5f04">
<p>
テストとビルドとデプロイする。
</p>

<p>
デプロイしたけど、ブラウザで表示できてないな。
</p>
</div>
</div>
<div id="outline-container-org1b8fa6b" class="outline-3">
<h3 id="org1b8fa6b"><a href="#org1b8fa6b"><span class="done DONE">DONE</span> フィールドで動けるようにする</a></h3>
<div class="outline-text-3" id="text-org1b8fa6b">
<ul class="org-ul">
<li>テキストで地図を読み込む</li>
<li>コンポーネントを作る</li>
<li>地図を表示する</li>
<li>移動できるようにする</li>
</ul>

<p>
実行時エラーになる。表示できない。インターフェースが取り出せないよう。
</p>

<ul class="org-ul">
<li>コンポーネントの初期化を忘れていた</li>
<li>LoadLevel()によって読み込んだComponentListをAddEntities()-&gt;AddEntityComponent()に渡す。が、AddEntitiesで失敗する。テキストで読み込んだ内容をreflectでオブジェクト化するときに、新しく作成したコンポーネントを初期化するのに失敗している</li>
<li>ecsComponentListを調べてみよう
<ul class="org-ul">
<li>ecvでGameが入ってない</li>
<li>world.Components.Game</li>
</ul></li>
<li>sokoban-go では main.goのw.InitWorld(&amp;gc.Components{})の時点でworld.Components.Gameがセットされている</li>
</ul>
</div>
</div>
<div id="outline-container-org6745933" class="outline-3">
<h3 id="org6745933"><a href="#org6745933"><span class="done DONE">DONE</span> マップを表示できるようにする</a></h3>
<div class="outline-text-3" id="text-org6745933">
<p>
表示する。
</p>
</div>
</div>
<div id="outline-container-orge5cf371" class="outline-3">
<h3 id="orge5cf371"><a href="#orge5cf371"><span class="done DONE">DONE</span> 階数を移動できるようにする</a></h3>
<div class="outline-text-3" id="text-orge5cf371">
<p>
1階からはじまって、次の階層に移動する。
</p>

<p>
ワープホール。
</p>
</div>
</div>
<div id="outline-container-org8ded8da" class="outline-3">
<h3 id="org8ded8da"><a href="#org8ded8da"><span class="done DONE">DONE</span> クロスコンパイルする</a></h3>
<div class="outline-text-3" id="text-org8ded8da">
<p>
一応CIに設定して保証しておく。
</p>
</div>
</div>
<div id="outline-container-org4221b73" class="outline-3">
<h3 id="org4221b73"><a href="#org4221b73"><span class="done DONE">DONE</span> メッセージが飛び出すのを直す</a></h3>
<div class="outline-text-3" id="text-org4221b73">
<p>
ステート遷移イベントを作る。
</p>
</div>
</div>
<div id="outline-container-orgaab1fab" class="outline-3">
<h3 id="orgaab1fab"><a href="#orgaab1fab"><span class="done DONE">DONE</span> 次の階をランダムに選択する</a></h3>
<div class="outline-text-3" id="text-orgaab1fab">
<p>
一覧からランダムに選択する。
</p>
</div>
</div>
<div id="outline-container-orgfc658be" class="outline-3">
<h3 id="orgfc658be"><a href="#orgfc658be"><span class="done DONE">DONE</span> HomeStateを作成する</a></h3>
<div class="outline-text-3" id="text-orgfc658be">
<p>
ゲームプレイの基軸になるメニュー。
</p>
</div>
</div>
<div id="outline-container-org0549faf" class="outline-3">
<h3 id="org0549faf"><a href="#org0549faf"><span class="done DONE">DONE</span> 脱出できるようにする</a></h3>
<div class="outline-text-3" id="text-org0549faf">
<p>
脱出階層で脱出できるようにする。
</p>
</div>
</div>
<div id="outline-container-orgbee6507" class="outline-3">
<h3 id="orgbee6507"><a href="#orgbee6507"><span class="done DONE">DONE</span> 背景を設定する</a></h3>
<div class="outline-text-3" id="text-orgbee6507">
<p>
背景を追加する。スプライトはあるけど、同じでいいのか。いや、スプライトは1枚の画像を分割するものだから、同じ感じでは扱えないな。変えるとsystemも変えないといけない。面倒なのでとりあえずいいか。
</p>
</div>
</div>
<div id="outline-container-org77f2266" class="outline-3">
<h3 id="org77f2266"><a href="#org77f2266"><span class="done DONE">DONE</span> サブメニュー追加</a></h3>
<div class="outline-text-3" id="text-org77f2266">
<p>
拠点メニューにはサブメニューがある。どうやるか考える。
</p>

<ul class="org-ul">
<li>別stateでやる
<ul class="org-ul">
<li>大量にstateができるのどうなのという感じ。背景コンポーネントとかも同じ感じで準備しないといけない</li>
</ul></li>
<li>リファレンスではどうやっているのだろう。ポーズでは、後ろを透明に表示しつつ、メニューを表示している。あれと同じようなことができないか
<ul class="org-ul">
<li>ポーズメニューでは、OnStopでポーズメニューのエンティティのみを削除しているようだ。ほかのstateでは、すべてのエンティティを削除することが異なる</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org8a4747b" class="outline-3">
<h3 id="org8a4747b"><a href="#org8a4747b"><span class="done DONE">DONE</span> pauseステート作成</a></h3>
<div class="outline-text-3" id="text-org8a4747b">
<p>
デバッグで便利なので。
</p>
</div>
</div>
<div id="outline-container-orgfe13214" class="outline-3">
<h3 id="orgfe13214"><a href="#orgfe13214"><span class="done DONE">DONE</span> アイテムを生成する</a></h3>
<div class="outline-text-3" id="text-orgfe13214">
<p>
アイテムを追加する。
</p>

<ul class="org-ul">
<li>item
<ul class="org-ul">
<li>consumable</li>
<li>name</li>
<li>description</li>
</ul></li>
</ul>

<p>
まずそれぞれのコンポーネントの雛形をファイルで作成する。
</p>

<ul class="org-ul">
<li>items
<ul class="org-ul">
<li>entityA
<ul class="org-ul">
<li>componentA(consumable)</li>
<li>componentB(weight)</li>
</ul></li>
<li>entityB
<ul class="org-ul">
<li>componentA(consumable)</li>
<li>componentB(weight)</li>
</ul></li>
</ul></li>
</ul>

<p>
で、そのデータを読み込んでエンティティとコンポーネントを生成する関数を作る。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>engineも作らないといけない</label><pre class="src src-go">componentList := loader.EntityComponentList{}
// engineとgameは同数でなければならない。分割されているのが面倒だな…
componentList.Engine = append(componentList.Engine, loader.EngineComponentList{})
componentList.Game = append(componentList.Game, gloader.GameComponentList{
	Item: &amp;gc.Item{},
})
loader.AddEntities(world, componentList)
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>元ネタ</label><pre class="src src-rust">pub fn spawn_named_item(
</pre>
</div>
</div>
</div>
<div id="outline-container-orge08ca03" class="outline-3">
<h3 id="orge08ca03"><a href="#orge08ca03"><span class="done DONE">DONE</span> UI設計</a></h3>
<div class="outline-text-3" id="text-orge08ca03">
<p>
いちいちゲーム画面見るのもアレなので、書いておく。
</p>
</div>
</div>
<div id="outline-container-orge613d05" class="outline-3">
<h3 id="orge613d05"><a href="#orge613d05"><span class="done DONE">DONE</span> UIエンティティだけを消す</a></h3>
<div class="outline-text-3" id="text-orge613d05">
<p>
DeleteAllEntitiesでステート切り替え時のUIリセットをしている。entitiesが全部消えるので、困る。ほとんどの場合、UIだけをリセットすればよさそう。
</p>

<p>
UIコンポーネントと、UIコンポーネントを消す関数を作ればよさそう。
</p>
</div>
</div>
<div id="outline-container-org0588972" class="outline-3">
<h3 id="org0588972"><a href="#org0588972"><span class="done DONE">DONE</span> 各メニューを作成する</a></h3>
<div class="outline-text-3" id="text-org0588972">
<p>
仮の内容で全部作る。
</p>
</div>
</div>
<div id="outline-container-orgbabdfca" class="outline-3">
<h3 id="orgbabdfca"><a href="#orgbabdfca"><span class="done DONE">DONE</span> アイテムを使う</a></h3>
<div class="outline-text-3" id="text-orgbabdfca">
<ul class="org-ul">
<li>キャラクタを作る</li>
<li>ステータスを作る</li>
<li>影響を与えられるようにする</li>
<li>memo
<ul class="org-ul">
<li>可変のアイテムリストについて、選択中の印をつける必要がある</li>
<li>選択中の座標をとってきて、選択印の位置を変化させればいいのかな</li>
</ul></li>

<li>ゲーム
<ul class="org-ul">
<li>戦車にしたいけど、戦闘システムがややこしくなる</li>
<li>合成とかで各自の装備メインにしたいんだよな</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org5e9c8cf" class="outline-3">
<h3 id="org5e9c8cf"><a href="#org5e9c8cf"><span class="done DONE">DONE</span> アイテムを選択して使えるようにする</a></h3>
<div class="outline-text-3" id="text-org5e9c8cf">
<p>
今は固定にしている。
</p>
</div>
</div>
<div id="outline-container-org106cae0" class="outline-3">
<h3 id="org106cae0"><a href="#org106cae0"><span class="done DONE">DONE</span> アイテムリストをebitenUIで作る</a></h3>
<div class="outline-text-3" id="text-org106cae0">
<p>
いい感じに、スクロールできるようにする。
</p>
</div>
</div>
<div id="outline-container-orgc5ed4a6" class="outline-3">
<h3 id="orgc5ed4a6"><a href="#orgc5ed4a6"><span class="done DONE">DONE</span> サイドメニューを表示する</a></h3>
<div class="outline-text-3" id="text-orgc5ed4a6">
<p>
性能を表示するサイドパネル。
</p>

<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> メニューバーが太いのを直す</li>
</ul>
</div>
</div>
<div id="outline-container-orgd7882bd" class="outline-3">
<h3 id="orgd7882bd"><a href="#orgd7882bd"><span class="done DONE">DONE</span> UIをリロードせずに反映できるようにする</a></h3>
<div class="outline-text-3" id="text-orgd7882bd">
<p>
アイテムを使用したときにUIをリロードしているが、スクロール位置が元へ戻ってしまうのでリロードしないようにする。
</p>

<p>
また、表示ジャンルの切替もあるので、リロードすると保持しなくて困る。
</p>
</div>
</div>
<div id="outline-container-org19e5e2a" class="outline-3">
<h3 id="org19e5e2a"><a href="#org19e5e2a"><span class="done DONE">DONE</span> ebitenUIを使う</a></h3>
<div class="outline-text-3" id="text-org19e5e2a">
<p>
使う。
</p>
</div>
</div>
<div id="outline-container-orgaf0f166" class="outline-3">
<h3 id="orgaf0f166"><a href="#orgaf0f166"><span class="done DONE">DONE</span> アイテムに対するアクションを選べるようにする</a></h3>
<div class="outline-text-3" id="text-orgaf0f166">
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 使う</li>
<li class="on"><input type='checkbox' checked='checked' /> 捨てる</li>
<li class="on"><input type='checkbox' checked='checked' /> キャンセル</li>

<li>ebitenUIを組み込もうとしている
<ul class="org-ul">
<li>うまくUpdateできてないからか、windowが開けない</li>
<li>今の構造だと、作成したuiをDrawとUpdateの2つができない
<ul class="org-ul">
<li>UIもコンポーネント</li>
</ul></li>
</ul></li>
<li>ebitenUIだとキーボード志向にしにくそう
<ul class="org-ul">
<li>いや対応できるか</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org076bb93" class="outline-3">
<h3 id="org076bb93"><a href="#org076bb93"><span class="done DONE">DONE</span> メッセージシステムの命令追加</a></h3>
<div class="outline-text-3" id="text-org076bb93">
<p>
背景とか。
</p>

<ul class="org-ul">
<li>文字列に開始の合図がないから、識別子との判断ができてないみたい</li>
<li>画像を重ねる順番を指定できない</li>
<li>倉庫番のポーズではできてるからできそう
<ul class="org-ul">
<li>ただポーズは表示順が後なので&#x2026;。明らかにポーズ画面は後だ。メッセージシステムの場合は背景が後で変わる可能性がある。</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org0510352" class="outline-3">
<h3 id="org0510352"><a href="#org0510352"><span class="done DONE">DONE</span> インベントリメニューでpanicになる</a></h3>
<div class="outline-text-3" id="text-org0510352">
<p>
別のステートに遷移したあと、再び戻ってクリックするとエラーになる。
</p>

<ul class="org-ul">
<li>アイテム選択</li>
<li>「使う」クリックでpanic</li>
<li>partyContainerの数が2つずつ増えているようだ</li>
<li>1度しか付与されないようにしたら解決した</li>
</ul>
</div>
</div>
<div id="outline-container-org99cb0c1" class="outline-3">
<h3 id="org99cb0c1"><a href="#org99cb0c1"><span class="done DONE">DONE</span> アイテムを使う対象を選べるようにする</a></h3>
<div class="outline-text-3" id="text-org99cb0c1">
<ul class="org-ul">
<li>回復薬の場合は1人の味方を選ぶ</li>
<li>回復スプレーの場合は全員を選択している画面になる</li>
<li>ロケット弾の場合は1人の敵を選ぶ</li>
<li>決めること
<ul class="org-ul">
<li>使う対象
<ul class="org-ul">
<li>敵</li>
<li>味方</li>
<li>なし</li>
</ul></li>
<li>対象数
<ul class="org-ul">
<li>単数</li>
<li>複数</li>
</ul></li>
<li>使う場面
<ul class="org-ul">
<li>戦闘中のみと制限されるものがある</li>
<li>戦闘中</li>
<li>フィールド / 拠点</li>
</ul></li>
</ul></li>

<li>パーティ一覧を表示する</li>
<li>選択したときに適用する</li>
<li>ProvidesHealingがあるものは自動で仲間対象でも良い、が</li>
</ul>
</div>
</div>
<div id="outline-container-org4d489e1" class="outline-3">
<h3 id="org4d489e1"><a href="#org4d489e1"><span class="done DONE">DONE</span> ゲーム設計</a></h3>
<div class="outline-text-3" id="text-org4d489e1">
<p>
どうするか。
</p>
</div>
</div>
<div id="outline-container-orgc360a8d" class="outline-3">
<h3 id="orgc360a8d"><a href="#orgc360a8d"><span class="done DONE">DONE</span> UIのリファクタ</a></h3>
<div class="outline-text-3" id="text-orgc360a8d">
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 統一感をもって扱えるようにする</li>
<li class="on"><input type='checkbox' checked='checked' /> 説明文とメニューの間隔を空ける</li>
<li>resourceに各UI(idle, hover, pressed)を初期化しておく</li>
<li>参考コードを見てどうやっているかを調べる</li>
<li>完璧でなくてよい。やっても成果が見えなくて辛いので、次をやるか</li>
<li>UI間に依存があって、思ったよりきれいに書けなかった感</li>
<li>まあ、アイテム画面と同じスタイルで別のメニューを表示したくなったら考えればいい</li>
</ul>
</div>
</div>
<div id="outline-container-org217c113" class="outline-3">
<h3 id="org217c113"><a href="#org217c113"><span class="done DONE">DONE</span> 武器を追加する</a></h3>
<div class="outline-text-3" id="text-org217c113">
<p>
使うアイテムとは別枠で表示できる。
</p>

<ul class="org-ul">
<li>武器名</li>
<li>元となった武器名</li>
<li>攻撃力</li>
<li>命中</li>
<li>攻撃回数</li>
<li>属性
<ul class="org-ul">
<li>拳銃</li>
<li>小銃</li>
<li>刀剣</li>
</ul></li>
</ul>

<p>
武器の性能にはばらつきがある。種類によってベースがある。ばらつきやすさが違う。
</p>

<p>
メニューをトグルさせるためにどうするか。既存のchildを削除して、再度追加すればいいか。
</p>
</div>
</div>
<div id="outline-container-org189857b" class="outline-3">
<h3 id="org189857b"><a href="#org189857b"><span class="done DONE">DONE</span> 素材を追加する</a></h3>
<div class="outline-text-3" id="text-org189857b">
<ul class="org-ul">
<li>素材は表示が違う。個数を表示することになっている。どうするか</li>
<li>素材はグローバルに個数カウントできればよい。そのへんはほかのエンティティと事情が違う</li>
<li>表示方法を変えないといけないがどうするか
<ul class="org-ul">
<li>しょせん中のテキストが違うだけ</li>
</ul></li>
<li class="off"><input type='checkbox' /> 素材を追加する
<ul class="org-ul">
<li>素材は個数カウント。エンティティを追加する必要はあるか。単なるmapでもよい</li>
<li>ただ、同じtomlで生成できるほうがわかりやすい。nameとdescriptionあるし</li>
</ul></li>
</ul>

<p>
インターフェースから考える。
</p>

<div class="org-src-container">
<pre class="src src-go">// tomlにあるものはカウント0で初期化される

material.GetCount("ガラクタ") // =&gt; 3
material.IncCount("ガラクタ", 1)
material.DeclCount("小さな花", 1)
</pre>
</div>
</div>
</div>
<div id="outline-container-org9caa057" class="outline-3">
<h3 id="org9caa057"><a href="#org9caa057"><span class="done DONE">DONE</span> 合成画面を作る</a></h3>
<div class="outline-text-3" id="text-org9caa057">
<p>
まず画面を作って、そこから共通化していけばいいか。
</p>

<ul class="org-ul">
<li>装備画面</li>
<li>合成画面</li>
<li>使用画面</li>
</ul>

<p>
これらは似たようなUIを持つ。
</p>

<ul class="org-ul">
<li>カテゴリ選択</li>
<li>アイテムメニュー(左)
<ul class="org-ul">
<li>中身の取得ロジックは異なる</li>
<li>中に入るデータの種類が違うということ</li>
</ul></li>
<li>性能メニュー(右)</li>
</ul>

<p>
あたりは共通。ボタンのアクションが違うくらいか。
</p>

<p>
合成に必要なもの。
</p>

<ul class="org-ul">
<li>レシピ
<ul class="org-ul">
<li>素材の種類と個数</li>
<li>鉄の剣 = <code>[{鉄くず,2}, {木の棒,1}]</code></li>
</ul></li>
<li class="on"><input type='checkbox' checked='checked' /> レシピを表示する</li>
<li class="on"><input type='checkbox' checked='checked' /> 合成する関数を作成する
<ul class="org-ul">
<li>アイテム名からベースアイテムを作成する</li>
<li>加工する</li>
</ul></li>
<li class="off"><input type='checkbox' /> レシピをもとに作成できるようにする
<ul class="org-ul">
<li>所持数量とレシピを比較して満たしていると合成が選択できる</li>
<li>合成を選択すると、所持数量を減らし該当アイテムを追加する</li>
</ul></li>
</ul>

<div class="org-src-container">
<pre class="src src-go">gc := Craft("ハンドガン", 4) ecs.Entity // 品名、合成オプション
Spawn(gc, spawntype.OnBackpack)
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb799007" class="outline-3">
<h3 id="orgb799007"><a href="#orgb799007"><span class="done DONE">DONE</span> アイテムUIまわりをリファクタする</a></h3>
<div class="outline-text-3" id="text-orgb799007">
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> グローバル変数を構造体のフィールドに移す</li>
</ul>

<p>
合成とか装備品変更とか、よく似たUIで別画面を作ることになる。別で作ってたら大変なことになる。再利用するためにはどうすればよいか。
</p>
</div>
</div>
<div id="outline-container-org0c2e8c8" class="outline-3">
<h3 id="org0c2e8c8"><a href="#org0c2e8c8"><span class="done DONE">DONE</span> 乗り物をどうするか</a></h3>
<div class="outline-text-3" id="text-org0c2e8c8">
<p>
結論、小さなSFチックな機械を導入する。戦闘には参加しないがサポートする。知能は持たない。
</p>

<p>
パーティ全体を強化できるようなのがあると面白そうに思える。乗り物はそういう強化が自然にできて面白い。人だけだとつけ外し要素がない。ただし、戦車だとシステムが複雑になる可能性がある。アイテム合成が生きないような。
</p>

<ul class="org-ul">
<li>ドローンやタレットとか、自律的な何か</li>
<li>戦闘で交じるのはややこしくて困る</li>
<li>非戦闘な乗り物ってないな</li>
<li>歩数制限のもっともな理由がほしい
<ul class="org-ul">
<li>燃料とか食べ物の類</li>
</ul></li>
<li>小さなSFチックな機械を導入する。それがないと遺跡に入れない的な。いろいろ効果をつけられる</li>
<li>戦車は逆に敵が強くなるとかの理由をつけて遺跡に入らない。戦闘が面倒になるので</li>
</ul>
</div>
</div>
<div id="outline-container-orgc18d4b8" class="outline-3">
<h3 id="orgc18d4b8"><a href="#orgc18d4b8"><span class="done DONE">DONE</span> タイル移動でなくするか</a></h3>
<div class="outline-text-3" id="text-orgc18d4b8">
<p>
いやでもアニメーションやリアルタイムとなると大変そうだから、タイル移動のままがよさそう。
</p>

<p>
あまりローグライクさせる意味はなさそう。敵を避けにくい。banbandonを参考にして自由移動にするか。
</p>
</div>
</div>
<div id="outline-container-org1f69c7c" class="outline-3">
<h3 id="org1f69c7c"><a href="#org1f69c7c"><span class="done DONE">DONE</span> 一貫させるためインターフェースを定義する</a></h3>
<div class="outline-text-3" id="text-org1f69c7c">
<p>
stateごとにコードがバラバラで、直していくのが辛い。
</p>

<p>
一部共通部分もあるが、違う部分も多いので、しょうがないところではある。
</p>

<p>
インターフェース化して、ある程度同じにするか。とはいえ、アイテム画面がそこまで種類多いかと言われるとそうでもない。3、4個だからあまり神経質にならなくてもいい。
</p>
</div>
</div>
<div id="outline-container-org7a33225" class="outline-3">
<h3 id="org7a33225"><a href="#org7a33225"><span class="done DONE">DONE</span> 武器コンポーネントに属性を追加する</a></h3>
<div class="outline-text-3" id="text-org7a33225">
<ul class="org-ul">
<li>火炎(耐火)</li>
<li>電気(耐電)</li>
<li>光力(耐光)</li>
</ul>

<p>
だとそのまますぎるか。光は異色だが、SFらしさを出すのに良い。ややこしいのであまり属性を増やしたくない。冷気(耐冷)を追加した。
</p>

<p>
時代背景的に、SFではない。でも合成するとSFになるよな。SFよりの現代、でよいか。
</p>
</div>
</div>
<div id="outline-container-org8415685" class="outline-3">
<h3 id="org8415685"><a href="#org8415685"><span class="done DONE">DONE</span> アイテム種別に防具を追加する</a></h3>
<div class="outline-text-3" id="text-org8415685">
<ul class="org-ul">
<li>消耗品</li>
<li>武器</li>
<li>防具</li>
<li>素材</li>
</ul>

<p>
で、種別が揃う。
</p>
</div>
</div>
<div id="outline-container-orgda9fb9b" class="outline-3">
<h3 id="orgda9fb9b"><a href="#orgda9fb9b"><span class="done DONE">DONE</span> 武器種別を追加する</a></h3>
<div class="outline-text-3" id="text-orgda9fb9b">
<p>
剣とか銃とか。
</p>
</div>
</div>
<div id="outline-container-orgb4c978e" class="outline-3">
<h3 id="orgb4c978e"><a href="#orgb4c978e"><span class="done DONE">DONE</span> 合成画面をリファクタする</a></h3>
<div class="outline-text-3" id="text-orgb4c978e">
<p>
書き直す。
</p>
</div>
</div>
<div id="outline-container-orgd2fe964" class="outline-3">
<h3 id="orgd2fe964"><a href="#orgd2fe964"><span class="done DONE">DONE</span> 装備画面を作る</a></h3>
<div class="outline-text-3" id="text-orgd2fe964">
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> スロットを作成する
<ul class="org-ul">
<li>コードから装備させる</li>
</ul></li>
<li class="on"><input type='checkbox' checked='checked' /> 装備画面を作成する
<ul class="org-ul">
<li>スロット表示画面。各キャラごと</li>
</ul></li>
<li class="on"><input type='checkbox' checked='checked' /> 選択画面を作成する
<ul class="org-ul">
<li>ここで選択したものが前で選択したスロットに装備される</li>
<li>モードをどう表現するか。これをstateとしてやるのはやりすぎな気もする</li>
<li>選択モードとだけしとけばいいか</li>
<li>選択モードだと、左側を武器リストにする。スライダーがあるから、全く同じにならなそうだな</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org0aa19d2" class="outline-3">
<h3 id="org0aa19d2"><a href="#org0aa19d2"><span class="done DONE">DONE</span> enumのバリデーション</a></h3>
<div class="outline-text-3" id="text-org0aa19d2">
<p>
楽にバリデーションできる書き方にする。
</p>
</div>
</div>
<div id="outline-container-orge52bacc" class="outline-3">
<h3 id="orge52bacc"><a href="#orge52bacc"><span class="done DONE">DONE</span> カメラ追加</a></h3>
<div class="outline-text-3" id="text-orge52bacc">
<p>
今はそのまま表示してる。プレイヤーの位置に追従してステージの一部だけを表示したい。
</p>

<p>
とりあえず、仮で追加した。
</p>
</div>
</div>
<div id="outline-container-org0b5bf75" class="outline-3">
<h3 id="org0b5bf75"><a href="#org0b5bf75"><span class="done CLOSE">CLOSE</span> UIと分離したい</a></h3>
<div class="outline-text-3" id="text-org0b5bf75">
<p>
完全にUIと一体化しているのでよくわからなくなる。
</p>

<ul class="org-ul">
<li>UIを保持する構造体</li>
<li>UIで表示されているボタンに設定されたイベントがトリガーされて、ECSクエリを実行して表示を切り替えたり追加したりする</li>
<li>stateはviewだと考えてよさそうな感じがする</li>
<li>データストアと直にやりとりしてるわけじゃないからいいのか。UIの変更だけだな</li>
</ul>
</div>
</div>
<div id="outline-container-orgd76382c" class="outline-3">
<h3 id="orgd76382c"><a href="#orgd76382c"><span class="done DONE">DONE</span> 装備画面のリファクタ</a></h3>
<div class="outline-text-3" id="text-orgd76382c">
<p>
汚いので直す。
</p>

<p>
どこから直せばいいのかよくわからないな。
</p>
</div>
</div>
<div id="outline-container-orgc056fd2" class="outline-3">
<h3 id="orgc056fd2"><a href="#orgc056fd2"><span class="done DONE">DONE</span> ステータスを追加する</a></h3>
<div class="outline-text-3" id="text-orgc056fd2">
<p>
生命力とか、力とか。
</p>
</div>
</div>
<div id="outline-container-orgad0fc9a" class="outline-3">
<h3 id="orgad0fc9a"><a href="#orgad0fc9a"><span class="done DONE">DONE</span> 装備でステータスを変更する</a></h3>
<div class="outline-text-3" id="text-orgad0fc9a">
<p>
防具を装備すると防御力が上がるなど。
</p>

<ul class="org-ul">
<li>キャラ固有のステータスは、Attributes
<ul class="org-ul">
<li>キャラごとに固有の値をもつ</li>
<li>装備によって上がることがある</li>
</ul></li>
<li>防御力はどうするか
<ul class="org-ul">
<li>キャラごとに固有の値をもたない。装備がなければみんな0となる</li>
</ul></li>
<li>防御力以外が上がることもある。武器、防具どちらでも。
<ul class="org-ul">
<li>器用さ+1などのステータス値</li>
<li>火耐性+20%などの属性耐性</li>
<li>頑丈+1、貫通+2などのスキル</li>
<li>「救護」「乱射」などの行動追加</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6b586bb" class="outline-3">
<h3 id="org6b586bb"><a href="#org6b586bb"><span class="done DONE">DONE</span> 説明図を書く</a></h3>
<div class="outline-text-3" id="text-org6b586bb">
<p>
見返してみるとけっこういい図がある。概念整理する。
</p>
</div>
</div>
<div id="outline-container-orgf093b51" class="outline-3">
<h3 id="orgf093b51"><a href="#orgf093b51"><span class="done DONE">DONE</span> 回復薬を割合回復にする</a></h3>
<div class="outline-text-3" id="text-orgf093b51">
<ul class="org-ul">
<li>固定値ではないようにする</li>
<li>割合回復の仕組みは作ったので、回復薬に適用する</li>
<li>components, raw, effect をいい感じにしていく作業。大体同じ構造体になる</li>
<li>直にeffectを追加するのはよくないかもな。アイテムと共通に、いったんcomponentsを渡してeffectに変換させるようにする</li>
</ul>
</div>
</div>
<div id="outline-container-org72fbcd6" class="outline-3">
<h3 id="org72fbcd6"><a href="#org72fbcd6"><span class="done DONE">DONE</span> 戦闘部分の設計</a></h3>
<div class="outline-text-3" id="text-org72fbcd6">
<p>
未知の部分。どうするか。
</p>

<ul class="org-ul">
<li>デッキ型にすると面白そうだなあ
<ul class="org-ul">
<li>取れる行動が毎回異なる</li>
<li>マイナス行動は手札を圧迫する</li>
<li>カードには消費コストが設定されているから、強いものを選べばいいというわけでもない</li>
<li>ターンに行動カードは1枚選ぶ</li>
<li>デッキに1枚しか設定されてないと、それしか出なくないか。10枚登録固定にすればいいか</li>
</ul></li>

<li>白瀬
<ul class="org-ul">
<li>行動カード
<ul class="org-ul">
<li>マシンガン(sp2) by 装備武器</li>
<li>防御(シールド装備, sp1)</li>
<li>回復(体力回復, アイテム消費) by 所持スキル</li>
<li>乱射(攻撃回数1.5倍, sp1) by 装備</li>
<li>狙撃(待ち時間1.5倍+攻撃力2倍, sp2) by 所持スキル</li>
</ul></li>
<li>パッシブスキル
<ul class="org-ul">
<li>連携LV2(連携率1.4倍) by 所持スキル</li>
<li>射撃LV1(命中率1.1倍, 射撃武器の攻撃力1.1倍) by 所持スキル</li>
</ul></li>
</ul></li>
<li>ピエロ
<ul class="org-ul">
<li>行動カード
<ul class="org-ul">
<li>レーザーブレード(装備武器, sp2)</li>
<li>高出力(炎属性, sp2) by 装備</li>
<li>応援 by 固有行動</li>
</ul></li>
</ul></li>
<li>選択
<ul class="org-ul">
<li>基本攻撃(白瀬)</li>
<li>基本攻撃(ピエロ)</li>
</ul></li>
</ul>

<p>
デッキ。
</p>

<p>
参考。
</p>

<ul class="org-ul">
<li>デッキは共通のことが多いようだ
<ul class="org-ul">
<li>特定の人ばかり攻撃することにならないのだろうか</li>
<li>チームとは別に、人ごとの行動力もある</li>
<li>同じターンで複数行動はコスト増加する</li>
<li>コスト増加しないものもある</li>
<li>ドローしなくても使えるものがある</li>
</ul></li>
<li>ターンごとに行動力が回復する。戦闘ごとにリセット</li>
<li>カードのストックはできない
<ul class="org-ul">
<li>毎回同じにならない</li>
</ul></li>
<li>カードの入手はランダム</li>
<li>装備が2枠ある</li>
<li>戦闘と関係ないサポートキャラが1人いる</li>
</ul>

<p>
それをふまえて。
</p>

<ul class="org-ul">
<li>調整が難しいので、もっとシンプルなルールがよさそう</li>
<li>ランダム制はそこまでなくてよい</li>
<li>頭脳や運というよりはRPG的な、レベル上げて準備すれば勝てる要素強めにしたい</li>
<li>カスタム性を高めたい</li>
<li>アイテムのアップグレード要素はなし</li>
<li>特殊攻撃がついたカードはどう扱うか。あるなしどっちもほしい
<ul class="org-ul">
<li>2枚生成させるか</li>
<li>合成結果は複数になることがある</li>
<li>アイテム取得全般が、複数あるのを考慮しておく</li>
<li>ある武器に対して、アクションが複数選べるというのが自然だ</li>
<li>アクションは、他のカードを強化するカードでよさそう</li>
</ul></li>
<li>カードとアクションは変えたいんだよな</li>
<li>防具とかどうする
<ul class="org-ul">
<li>基本パラメータは変わらないでいいのか</li>
<li>デッキに含めるとパラメータUPでよさそう</li>
</ul></li>
<li>カードは直に入手できるのか、合成で入手するのか
<ul class="org-ul">
<li>ダンジョン内で入手したやつを試せたほうがよさそう</li>
<li>制限ともいえるが&#x2026;</li>
<li>入手は完全ランダム。1度入手すると合成で複数手に入れやすい</li>
</ul></li>
</ul>

<p>
実装。
</p>

<ul class="org-ul">
<li>じつはEffectと同じように、組み合わせてエンティティにしておけばいいだけか
<ul class="org-ul">
<li>アクションカードは攻撃を与える性質や、回復する性質がついていればよい。あと対象が敵か味方か、単数か</li>
<li>ブーストカードは、変化させる内容を保持していればよい。あと対象が敵か味方か、単数か</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org83a979f" class="outline-3">
<h3 id="org83a979f"><a href="#org83a979f"><span class="done DONE">DONE</span> UpdateSpecに渡すComponentsの更新を忘れる</a></h3>
<div class="outline-text-3" id="text-org83a979f">
<p>
オートで全コンポーネントを対象にすればよさそう。
</p>

<p>
componentListに渡せばよい。
</p>
</div>
</div>

<div id="outline-container-org5033c2c" class="outline-3">
<h3 id="org5033c2c"><a href="#org5033c2c"><span class="done DONE">DONE</span> 防具ジャンルを消す</a></h3>
<div class="outline-text-3" id="text-org5033c2c">
<p>
あまり区分けする必要はなさそうか。あの正方形のUIにすれば、混ざって入っていてもあまり違和感はない。
</p>

<p>
ただ、合成のときは分けたい感じも。
</p>

<ul class="org-ul">
<li>アイテム
<ul class="org-ul">
<li>消耗品</li>
<li>売却アイテム</li>
<li>防具</li>
</ul></li>
<li>手札
<ul class="org-ul">
<li>アクションカード</li>
<li>サポートカード</li>
</ul></li>
</ul>

<p>
メモ。
</p>

<ul class="org-ul">
<li>なぜかInBackpackの条件で、結果に入らない
<ul class="org-ul">
<li>装備してるせいだった&#x2026;</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org6beff6f" class="outline-3">
<h3 id="org6beff6f"><a href="#org6beff6f"><span class="done CLOSE">CLOSE</span> アイテム以外でeffectをトリガーする方法</a></h3>
<div class="outline-text-3" id="text-org6beff6f">
<p>
今はまだ、アイテムトリガーしかない。AddItemで、コンポーネントに分解されてそれぞれEffectのキューに入り、実行される。
</p>

<p>
ただ、今後全回復とか、アイテム以外で何かしたいときが増える。そのときはどうするか。
</p>
</div>
</div>
<div id="outline-container-orgeee747f" class="outline-3">
<h3 id="orgeee747f"><a href="#orgeee747f"><span class="done DONE">DONE</span> メインメニューを開いているとCPU使用率が爆増する</a></h3>
<div class="outline-text-3" id="text-orgeee747f">
<p>
リークしている。
</p>

<ul class="org-ul">
<li>フィールド画面でも起こるな</li>
<li>ほかの画面では起こらない。どうもメニューの仕組みを使っているところで起きてそう</li>
</ul>

<div class="org-src-container">
<pre class="src src-shell">ps aux | head -n 1
</pre>
</div>

<pre class="example">
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
</pre>

<ul class="org-ul">
<li>ほかの画面でも、タブを切り替えたときなどに発生する。生成した画面を生成できてないんだろうな</li>
<li>RemoveChildren()で、表示されなくはなっているけど、それがガベージコレクションされてない</li>
<li>プロファイラの設定した</li>
<li>LoadFont()設定があると、残り続けるな。ないと、残らない</li>
<li>ずっとコンテナの親子関係に問題があると考えていた(RemoveChildrenまわり)けど、そうではなかった</li>
<li>Faceまわりを毎回初期化してたのを、リソース構造体に保存して、それを使うようにしたら解決した</li>
<li>なんだかよくわからないな</li>
<li>相変わらず微妙に増えてるように見えるが、freeされてるようにも見える</li>
</ul>
</div>
</div>
<div id="outline-container-org5117a1c" class="outline-3">
<h3 id="org5117a1c"><a href="#org5117a1c"><span class="done DONE">DONE</span> 画像回帰テスト</a></h3>
<div class="outline-text-3" id="text-org5117a1c">
<p>
コマンドで各ステートの画像を取れるようにする。
</p>
</div>
</div>
<div id="outline-container-orgc6dcb6e" class="outline-3">
<h3 id="orgc6dcb6e"><a href="#orgc6dcb6e"><span class="done DONE">DONE</span> メモリリークをCIで検知したい</a></h3>
<div class="outline-text-3" id="text-orgc6dcb6e">
<p>
まあパフォーマンスを画面表示してるし、わかるだろう。
</p>

<p>
一定期間起動して、一定になるか確かめるとよさそう。
</p>
</div>
</div>
<div id="outline-container-org9d45467" class="outline-3">
<h3 id="org9d45467"><a href="#org9d45467"><span class="done DONE">DONE</span> ホーム画面をクリック対応する</a></h3>
<div class="outline-text-3" id="text-org9d45467">
<p>
キーボードはとりあえずなくした。
</p>

<p>
今はキーボードでしか移動できない。
</p>

<p>
でもキーボード移動も残したい。
</p>
</div>
</div>
<div id="outline-container-orgad87f8c" class="outline-3">
<h3 id="orgad87f8c"><a href="#orgad87f8c"><span class="done DONE">DONE</span> Ray Castingを参考にしてフィールドの原型を作る</a></h3>
<div class="outline-text-3" id="text-orgad87f8c">
<ul class="org-ul">
<li>Ray Castingを原型に動くものを作る</li>
<li>やりたいことに近い。<a href="https://al-ro.github.io/projects/raycasting/">2D Ray Casting</a></li>
<li>ban-ban-donを参考にして各システムを実装する</li>
<li>特に目新しいことはなく、移動に関しては完全に参考にして作成できるように見える</li>
</ul>

<p>
ゲーム的。
</p>

<ul class="org-ul">
<li>動かしてみて、難易度的に難しい割に、そんなに移動にゲーム性生まれなくないかと感じた</li>
<li>不可視の範囲を作るのがそこまで面白いかと言われるとビミョー</li>
<li>ほかのサンプルでは興味深く見えた。距離をつけてないから、明るすぎるためか</li>
<li>シューティング要素はないからな。単なる追いかけっこが面白いかというと…ミンサガとかのイメージが近い。避けるためのスキルを使う</li>
<li>お宝探し感は楽しい</li>
<li>リアルタイムだと、シューティングの劣化版にしかならない。自分が動くと相手も動く形式であればよさそう。じっくり考えて駆け引きにする</li>
</ul>

<p>
実装。
</p>

<ul class="org-ul">
<li>三角形をグラデーションにすればよさそう</li>
<li>jsの方ではどうやってるか
<ul class="org-ul">
<li>単にfillをグラデーションで設定してるだけに見える</li>
</ul></li>
<li>画像
<ul class="org-ul">
<li>背景</li>
<li>影</li>
<li>三角</li>
</ul></li>
</ul>

<p>
ECSとの兼ね合い。
</p>

<ul class="org-ul">
<li>システムにしていきたいが、描画とかは厳しそうに見える。少なくとも1タイルごとに1エンティティとかにはできない</li>
<li>描画以外はECSにしていく</li>
<li>なんだか難しすぎるように見えるけど、どうなのだろう</li>
<li>たくさんの構造体をstateに書くのは違う。が、いじりたい状態フィールドがある</li>
</ul>
</div>
</div>
<div id="outline-container-org3bd7420" class="outline-3">
<h3 id="org3bd7420"><a href="#org3bd7420"><span class="done DONE">DONE</span> フィールドの背景を全体に設定する</a></h3>
<div class="outline-text-3" id="text-org3bd7420">
<p>
敷き詰めたい。
</p>

<ul class="org-ul">
<li>やっぱりVRTで失敗するな</li>
<li>手元で動かすと発生しないのはなぜなんだろうな</li>
</ul>
</div>
</div>
<div id="outline-container-org8077e21" class="outline-3">
<h3 id="org8077e21"><a href="#org8077e21"><span class="done DONE">DONE</span> コンポーネントを移動する</a></h3>
<div class="outline-text-3" id="text-org8077e21">
<p>
移動する。
</p>

<ul class="org-ul">
<li>メニューを透過できないな。真っ暗になる。fieldだとできるのはなぜだろう</li>
<li>スプライトを表示できない。何も表示されない
<ul class="org-ul">
<li>geoMで位置を指定してないせいだった</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org43c3de8" class="outline-3">
<h3 id="org43c3de8"><a href="#org43c3de8"><span class="done DONE">DONE</span> 影描画をsystemでやる</a></h3>
<div class="outline-text-3" id="text-org43c3de8">
<p>
元の仕組みとは異なるため、調整が必要。
</p>

<ul class="org-ul">
<li>真っ黒になるな</li>
<li>レイも見えないので、間違ってるようだ</li>
<li>視点と同じ位置にあるために、全部真っ暗になっている説</li>
<li>外すと、いくつかのrayがおかしくなっていて失敗する
<ul class="org-ul">
<li>特定の点がおかしいようだ</li>
</ul></li>
<li>外周の壁がなくて、交点がないrayがあったせいだった</li>
</ul>
</div>
</div>
<div id="outline-container-org6996132" class="outline-3">
<h3 id="org6996132"><a href="#org6996132"><span class="done DONE">DONE</span> フィールド描画をECS化する</a></h3>
<div class="outline-text-3" id="text-org6996132">
<ul class="org-ul">
<li>まず影は置いておく</li>
<li>プレイヤー部分を色塗りできた</li>
<li>スプライトを表示するにはどうすればいいのだろう</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span><a href="https://github.com/kijimaD/ruins/blob/aa3088cfd9b52885ee6c5cd71cc7d2bed8495027/lib/loader/level.go#L358-L367">https://github.com/kijimaD/ruins/blob/aa3088cfd9b52885ee6c5cd71cc7d2bed8495027/lib/loader/level.go#L358-L367</a> ワープホールのsprite</label><pre class="src src-go">func createWarpNextEntity(componentList *loader.EntityComponentList, gameSpriteSheet *ec.SpriteSheet, line, col int) {
	componentList.Engine = append(componentList.Engine, loader.EngineComponentList{
		SpriteRender: &amp;ec.SpriteRender{SpriteSheet: gameSpriteSheet, SpriteNumber: warpNextSpriteNumber},
		Transform:    &amp;ec.Transform{},
	})
	componentList.Game = append(componentList.Game, GameComponentList{
		Warp:        &amp;gc.Warp{Mode: gc.WarpModeNext},
		GridElement: &amp;gc.GridElement{Line: line, Col: col},
	})
}
</pre>
</div>

<ul class="org-ul">
<li>スプライトシートは、起動時にtomlがロードされResourceの構造体に入れられる。ステート名をキーにして別々になっている
<ul class="org-ul">
<li>フィールドは &ldquo;field&rdquo; に、まとめて入っている</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb4ce896" class="outline-3">
<h3 id="orgb4ce896"><a href="#orgb4ce896"><span class="done DONE">DONE</span> とりあえずの背景を設定する</a></h3>
<div class="outline-text-3" id="text-orgb4ce896">
<p>
Menuをなくしたとき、非表示にしてた。戻す。
</p>
</div>
</div>
<div id="outline-container-org1ff5e05" class="outline-3">
<h3 id="org1ff5e05"><a href="#org1ff5e05"><span class="done DONE">DONE</span> 壁を通過できないようにする</a></h3>
<div class="outline-text-3" id="text-org1ff5e05">
<ul class="org-ul">
<li>rectの中に入れないようにする。</li>
<li>線として持っておく必要はなくて、点4つだけを持っていればいい</li>
<li>ただそれだとステージの壁を自動生成しづらくなるのだが&#x2026;</li>
<li>範囲内のオブジェクトに対して衝突判定する</li>
<li>すべてのフィールド上オブジェクトは、中心のx, yをもつ。その中心と合わせてスプライトを配置し、4つの点を衝突判定に使う
<ul class="org-ul">
<li>この方式はキャラクターや敵、飾りオブジェクトには良いが、壁を配置するときには不適当だ。1点ではなくて、4点を指定したいだろう</li>
<li>ピクセル単位で配置できなくてもよくて、50ピクセルごととかでよさそう。こうするとテキストファイルでマップを作成できる。壁は50ピクセル正方形で囲って表現する</li>
<li>オブジェクト数が大変なことになりそうな懸念。視界をもつキャラごとにあるわけで。とはいえ、視界を限ればそんなでもなさそうな気も。オブジェクト数は多くなるが、そういうもんだろう。</li>
<li>2次元配列の問題に落とし込めることは重要に見える</li>
<li>壁は近傍8タイルで座標を変化させればいい。縦に並んでいれば横は細くするみたいな</li>
</ul></li>
</ul>

<pre class="example">
spawnWall(1, 1) // (1, 1)に壁を生成
spawnPlayer(2, 2)
spawnObject("岩", 20, 20)
spawnObject("花", 30, 30)
spawnWarp(40, 50)
</pre>

<pre class="example">
############
#          #
#          #
/          #
############
</pre>

<ul class="org-ul">
<li>現状のraycastの構造を、1点だけ保持するように修正しようとしているが、よくわからない</li>
<li>プレイヤーや壁の描画を先にやればよいのでは。影は一度忘れる</li>
</ul>
</div>
</div>
<div id="outline-container-orgaad9252" class="outline-3">
<h3 id="orgaad9252"><a href="#orgaad9252"><span class="done DONE">DONE</span> 壁テクスチャが影で隠れないようにする</a></h3>
<div class="outline-text-3" id="text-orgaad9252">
<p>
今は影に隠されている。影側で表示しようとすると、影の中にあるときもテクスチャが表示されてしまって微妙。
</p>

<ul class="org-ul">
<li>視界側でブレンドするとよさそう。いやでも、視界に入れば影になっていても見えてしまうのは同じか</li>
<li>テクスチャ 影 ほかのテクスチャ 影</li>
<li>テクスチャの描画優先度が距離によって変わればいいのかな。大変そうだ</li>
<li>rayブレンド時に、スプライトも追加してやればいいかな</li>
<li>ぐちゃぐちゃになったのでいったんもどす</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>memo(できてない)</label><pre class="src src-go">// rayが命中しているかで、分岐させないといけない
// raysのindex 2,3をrectに含んでいれば命中しているということになる
world.Manager.Join(
	gameComponents.Position,
	gameComponents.SpriteRender,
	gameComponents.BlockView,
).Visit(ecs.Visit(func(entity ecs.Entity) {
	oPos := gameComponents.Position.Get(entity).(*gc.Position)
	oSprite := gameComponents.SpriteRender.Get(entity).(*ec.SpriteRender)
	spriteWidth := oSprite.SpriteSheet.Sprites[oSprite.SpriteNumber].Width
	spriteHeight := oSprite.SpriteSheet.Sprites[oSprite.SpriteNumber].Height

	if !entity.HasComponent(gameComponents.Player) {
		x1 := float64(oPos.X - spriteWidth/2)
		x2 := float64(oPos.X + spriteWidth/2)
		y1 := float64(oPos.Y - spriteHeight/2)
		y2 := float64(oPos.Y + spriteHeight/2)
		for _, r := range rays {
			// x1 == r.X2
			if (x1 &lt; r.X2 &amp;&amp; x2 &lt; r.X2) || (y1 &lt; r.Y2 &amp;&amp; y2 &lt; r.Y2) {
				drawRect(shadowImage, blackImage, float32(oPos.X-16), float32(oPos.Y-16), 32, 32, opt)
			}

			// if x1 &lt; r.X2 || x2 == r.X2 || y1 == r.Y2 || y2 == r.Y2 {
			// drawRect(shadowImage, blackImage, float32(oPos.X-16), float32(oPos.Y-16), 32, 32, opt)
			// }
		}
	}
}))
</pre>
</div>

<ul class="org-ul">
<li>rayを飛ばして判定しているところで、エンティティにフラグを立てればよさそう
<ul class="org-ul">
<li>とすると、エンティティ単位でしか影を切り替えられなくなるな。ちょっと見えていてもテクスチャを全部表示するか、全部視界に入れないと表示しなくなる。微妙</li>
</ul></li>
<li>近づいた影を消せばよさそう</li>
</ul>
</div>
</div>
<div id="outline-container-org0ee628c" class="outline-3">
<h3 id="org0ee628c"><a href="#org0ee628c"><span class="done DONE">DONE</span> 旧フィールドまわりを消す</a></h3>
<div class="outline-text-3" id="text-org0ee628c">
<ul class="org-ul">
<li>componentsもいらないものがある</li>
<li>prefabもいらなくなる</li>
<li>levelまわりうつすのは、新しいものができてからでよさそう。参考になるからな</li>
</ul>
</div>
</div>
<div id="outline-container-orgb9581d4" class="outline-3">
<h3 id="orgb9581d4"><a href="#orgb9581d4"><span class="done DONE">DONE</span> state名のフィールドという名前をリネームする</a></h3>
<div class="outline-text-3" id="text-orgb9581d4">
<p>
構造体のフィールドとかと同じになるので、あまりよくない命名に思えてきた。dungeonとかだろうか。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
