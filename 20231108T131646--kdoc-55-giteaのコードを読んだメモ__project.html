<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-11-15 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 55: giteaのコードを読んだメモ</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 55: giteaのコードを読んだメモ</h1>

<div id="outline-container-org0498e41" class="outline-2">
<h2 id="org0498e41"><a href="#org0498e41"><span class="done DONE">DONE</span> プロジェクトステータス</a></h2>
<div class="outline-text-2" id="text-org0498e41">
<p>
プロジェクトは終了である。
</p>
</div>
</div>

<div id="outline-container-orgb2ff3f9" class="outline-2">
<h2 id="orgb2ff3f9"><a href="#orgb2ff3f9">概要</a></h2>
<div class="outline-text-2" id="text-orgb2ff3f9">
<p>
<a href="https://github.com/go-gitea/gitea">go-gitea/gitea</a>を読んだメモ。バックエンドは<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>で書かれている。
</p>
</div>
</div>

<div id="outline-container-org020c219" class="outline-2">
<h2 id="org020c219"><a href="#org020c219">memo</a></h2>
<div class="outline-text-2" id="text-org020c219">
</div>
<div id="outline-container-org2e624c6" class="outline-3">
<h3 id="org2e624c6"><a href="#org2e624c6">コンパイル</a></h3>
<div class="outline-text-3" id="text-org2e624c6">
<p>
コンパイルしている部分。タスク名が動的になっていてわかりにくい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/Makefile#L788-L789
</pre>
</div>

<div class="results" id="orgc8bc2c4">
<p>
$(EXECUTABLE): $(GO_SOURCES) \((TAGS_PREREQ)
	CGO_CFLAGS="\)(CGO_CFLAGS)&ldquo; $(GO) build $(GOFLAGS) \((EXTRA_GOFLAGS) -tags '\)(TAGS)&rsquo; -ldflags &lsquo;-s -w $(LDFLAGS)&rsquo; -o $@
</p>

</div>
</div>
</div>

<div id="outline-container-org785abd7" class="outline-3">
<h3 id="org785abd7"><a href="#org785abd7">routerを起動している部分</a></h3>
<div class="outline-text-3" id="text-org785abd7">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/web.go#L211
</pre>
</div>

<div class="results" id="orga009788">
<p>
webRoutes := routers.NormalRoutes()
</p>

</div>
</div>
</div>

<div id="outline-container-org20b3fcc" class="outline-3">
<h3 id="org20b3fcc"><a href="#org20b3fcc">DB設定部分</a></h3>
<div class="outline-text-3" id="text-org20b3fcc">
<p>
setting packageにまとめられている。パッケージで変数化されている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>database</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/0999721c7b4d124c1f14bbd067acdcf767542abb/modules/setting/database.go#L27-L28
</pre>
</div>

<div class="results" id="org940d68a">
<p>
// Database holds the database settings
Database = struct {
</p>

</div>

<p>
変数はグローバル変数にしつつ↑、セットはパッケージ内の関数でやる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/setting/database.go#L59-L65
</pre>
</div>

<div class="results" id="org2737e83">
<p>
func loadDBSetting(rootCfg ConfigProvider) {
	sec := rootCfg.Section(&ldquo;database&rdquo;)
	Database.Type = DatabaseType(sec.Key(&ldquo;DB_TYPE&rdquo;).String())
</p>

<p>
Database.Host = sec.Key(&ldquo;HOST&rdquo;).String()
Database.Name = sec.Key(&ldquo;NAME&rdquo;).String()
Database.User = sec.Key(&ldquo;USER&rdquo;).String()
</p>

</div>
</div>
</div>

<div id="outline-container-orgeabaf6e" class="outline-3">
<h3 id="orgeabaf6e"><a href="#orgeabaf6e">DB初期化部分</a></h3>
<div class="outline-text-3" id="text-orgeabaf6e">
<p>
routerでのDBの初期化は↓でやっている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L132-L133
</pre>
</div>

<div class="results" id="orgec88cd7">
<p>
// InitEngine initializes the xorm.Engine and sets it as db.DefaultContext
func InitEngine(ctx context.Context) error {
</p>

</div>

<p>
InitEngineの中でデータベースを初期化する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>InitEngine(ctx context.Context) error 内で実行する</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L134
</pre>
</div>

<div class="results" id="org42a3c27">
<p>
xormEngine, err := newXORMEngine()
</p>

</div>

<p>
InitEngineの中でSetDefaultEngine()して初期化したデータベースをDefaultContextに設定する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<div class="results" id="org72f4fed">
<p>
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</p>

</div>

<p>
セットできているかの確認文。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/init.go#L136
</pre>
</div>

<div class="results" id="org1ba8f8b">
<p>
mustInitCtx(ctx, common.InitDBEngine)
</p>

</div>
</div>
</div>

<div id="outline-container-orgffd6d24" class="outline-3">
<h3 id="orgffd6d24"><a href="#orgffd6d24">変数default contextに設定する</a></h3>
<div class="outline-text-3" id="text-orgffd6d24">
<p>
設定している部分。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<div class="results" id="org0515529">
<p>
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</p>

</div>

<p>
テストとかではdefault contextを使って、dbを簡単に起動している。そうでない部分では、起動時に明示して上書きしているようだ。
</p>
</div>
</div>

<div id="outline-container-orgeca2585" class="outline-3">
<h3 id="orgeca2585"><a href="#orgeca2585">APIContextをセットしている部分</a></h3>
<div class="outline-text-3" id="text-orgeca2585">
<p>
DBのデータなどはcontext.APIContextで伝達している。APIContextにはBaseが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>APIContextの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L28-L43
</pre>
</div>

<div class="results" id="org8681e13">
<p>
// APIContext is a specific context for API service
type APIContext struct {
	*Base
</p>

<p>
Cache cache.Cache
</p>

<p>
Doer        *user_model.User // current signed-in user
IsSigned    bool
IsBasicAuth bool
</p>

<p>
ContextUser *user_model.User // the user which is being visited, in most cases it differs from Doer
</p>

<p>
	Repo    *Repository
	Org     *APIOrganization
	Package *Package
}
</p>

</div>

<p>
Baseにはcontext.Contextが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Baseの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/base.go#L31-L44
</pre>
</div>

<div class="results" id="org24f150b">
<p>
type Base struct {
	originCtx     context.Context
	contextValues []contextValuePair
</p>

<p>
Resp ResponseWriter
Req  *http.Request
</p>

<p>
<i>/ Data is prepared by ContextDataStore middleware, this field only refers to the pre-created/prepared ContextData.
/</i> Although it&rsquo;s mainly used for MVC templates, sometimes it&rsquo;s also used to pass data between middlewares/handler
Data middleware.ContextData
</p>

<p>
	// Locale is mainly for Web context, although the API context also uses it in some cases: message response, form validation
	Locale translation.Locale
}
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L223
</pre>
</div>

<div class="results" id="org718bcad">
<p>
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
</p>

</div>
</div>
</div>

<div id="outline-container-org26f0a5f" class="outline-3">
<h3 id="org26f0a5f"><a href="#org26f0a5f">contextからdbインスタンスを取り出す</a></h3>
<div class="outline-text-3" id="text-org26f0a5f">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/admin/task.go#L56
</pre>
</div>

<div class="results" id="org11f5297">
<p>
has, err := db.GetEngine(ctx).ID(task.RepoID).Get(&amp;repo)
</p>

</div>
</div>
</div>

<div id="outline-container-org0078b33" class="outline-3">
<h3 id="org0078b33"><a href="#org0078b33">DBコンテキストは異なる</a></h3>
<div class="outline-text-3" id="text-org0078b33">
<p>
DBのためだけにありそう。defaultContextが入るのはこれ。contextを構造体に埋め込むのはよくないとされている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L29-L34
</pre>
</div>

<div class="results" id="orgf288c1d">
<p>
// Context represents a db context
type Context struct {
	context.Context
	e           Engine
	transaction bool
}
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>クエリを走らせるためのcontext</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L14-L16
</pre>
</div>

<div class="results" id="org0e48944">
<p>
<i>/ DefaultContext is the default context to run xorm queries in
/</i> will be overwritten by Init with HammerContext
var DefaultContext context.Context
</p>

</div>

<p>
context.Contextはインターフェースなので、DefaultContextにはdb.Contextが入る。
</p>

<p>
このDBコンテキストは、Engine()を実装しているのでEnginedインターフェースを満たす。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L67-L90
</pre>
</div>

<div class="results" id="org06ca5f6">
<p>
// Engined structs provide an Engine
type Engined interface {
	Engine() Engine
}
</p>

<p>
// GetEngine will get a db Engine from this context or return an Engine restricted to this context
func GetEngine(ctx context.Context) Engine {
	if e := getEngine(ctx); e != nil {
		return e
	}
	return x.Context(ctx)
}
</p>

<p>
// getEngine will get a db Engine from this context or return nil
func getEngine(ctx context.Context) Engine {
	if engined, ok := ctx.(Engined); ok {
		return engined.Engine()
	}
	enginedInterface := ctx.Value(enginedContextKey)
	if enginedInterface != nil {
		return enginedInterface.(Engined).Engine()
	}
	return nil
}
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L49-L52
</pre>
</div>

<div class="results" id="org9da9471">
<p>
// Engine returns db engine
func (ctx *Context) Engine() Engine {
	return ctx.e
}
</p>

</div>
</div>
</div>

<div id="outline-container-org5dace5b" class="outline-3">
<h3 id="org5dace5b"><a href="#org5dace5b">DBオブジェクト宣言</a></h3>
<div class="outline-text-3" id="text-org5dace5b">
<p>
xormのオブジェクト作成はxorm.NewEngine()で行う。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>func newXORMEngine() (*xorm.Engine, error) で実行している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L107
</pre>
</div>

<div class="results" id="org1d7049a">
<p>
engine, err = xorm.NewEngine(&ldquo;postgresschema&rdquo;, connStr)
</p>

</div>
</div>
</div>

<div id="outline-container-org0b9f29d" class="outline-3">
<h3 id="org0b9f29d"><a href="#org0b9f29d">テストで、どうやってDefaultContextをセットしているか</a></h3>
<div class="outline-text-3" id="text-org0b9f29d">
<p>
テストでたくさん使っている。便利だ。これはいつセットされているか。
</p>

<p>
最初にunittest.PrepareTestDatabase()する。この中でDefaultContextに対してクエリが実行されている。そのあとDefaultContextを直に取得して実行する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/actions/runner_token_test.go#L16-L18
</pre>
</div>

<div class="results" id="org9007f25">
<p>
assert.NoError(t, unittest.PrepareTestDatabase())
token := unittest.AssertExistsAndLoadBean(t, &amp;ActionRunnerToken{ID: 3})
expectedToken, err := GetLatestRunnerToken(db.DefaultContext, 1, 0)
</p>

</div>

<p>
dbはcontextのvalueで持つべきじゃないらしい。リクエストスコープでないから。ダメじゃんと思ったけれども、contextの内部で持ってるわけではなく構造体で持ってるからいいのか。
</p>
</div>
</div>

<div id="outline-container-orgea08cb3" class="outline-3">
<h3 id="orgea08cb3"><a href="#orgea08cb3">APIコンテキストはどうやって生成しているか</a></h3>
<div class="outline-text-3" id="text-orgea08cb3">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>リクエスト時の普通のcontextから、APIContextを生成している部分</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L243
</pre>
</div>

<div class="results" id="org323f5aa">
<p>
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
			defer baseCleanUp()
</p>

<p>
ctx.Base.AppendContextValue(apiContextKey, ctx)
ctx.Base.AppendContextValueFunc(git.RepositoryContextKey, func() any { return ctx.Repo.GitRepo })
</p>

<p>
<i>/ If request sends files, parse them here otherwise the Query() can&rsquo;t be parsed and the CsrfToken will be invalid.
if ctx.Req.Method <code>= "POST" &amp;&amp; strings.Contains(ctx.Req.Header.Get("Content-Type"), "multipart/form-data") {
				if err :</code> ctx.Req.ParseMultipartForm(setting.Attachment.MaxSize &lt;&lt; 20); err != nil &amp;&amp; !strings.Contains(err.Error(), &ldquo;EOF&rdquo;) { /</i> 32MB max size
		ctx.InternalServerError(err)
		return
	}
}
</p>

<p>
httpcache.SetCacheControlInHeader(ctx.Resp.Header(), 0, &ldquo;no-transform&rdquo;)
ctx.Resp.Header().Set(`X-Frame-Options`, setting.CORSConfig.XFrameOptions)
</p>

<p>
			next.ServeHTTP(ctx.Resp, ctx.Req)
		})
	}
}
</p>

</div>

<p>
ミドルウェアとして登録されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/api/v1/api.go#L807
</pre>
</div>

<div class="results" id="org38a9665">
<p>
m.Use(context.APIContexter())
</p>

</div>

<p>
DB関係なくないか。どこでセットされているか。
</p>

<p>
トランザクションコンテキストは必要。なぜ。
</p>
</div>
</div>

<div id="outline-container-org68df140" class="outline-3">
<h3 id="org68df140"><a href="#org68df140">マイグレーションコマンド</a></h3>
<div class="outline-text-3" id="text-org68df140">
<p>
マイグレーションはタスクで行う。あるいは、Webの起動時にも関数が用意されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/migrate.go#L25
</pre>
</div>

<div class="results" id="orgc815ac6">
<p>
func runMigrate(ctx *cli.Context) error {
</p>

</div>
</div>
</div>

<div id="outline-container-org6d39e76" class="outline-3">
<h3 id="org6d39e76"><a href="#org6d39e76">テスト時にどうやってDB初期化されているか</a></h3>
<div class="outline-text-3" id="text-org6d39e76">
<ul class="org-ul">
<li>マイグレーション</li>
<li>DefaultContext初期化</li>
</ul>

<p>
が必要なはずだが見当たらない。
</p>

<p>
unittest.PrepareTestDatabase() を見るが、そのときにはすでにDefaultContextからDBが取得できている。
</p>

<p>
各test packageにあるtest_main.goにある、TestMain関数内でunittest.MainTest()している。MainTest内でDBを初期化してる。テスト時に必ず実行される。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>初期化している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/unittest/testdb.go#L73
</pre>
</div>

<div class="results" id="org86f26bf">
<p>
func MainTest(m *testing.M, testOpts &#x2026;*TestOptions) {
</p>

</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
