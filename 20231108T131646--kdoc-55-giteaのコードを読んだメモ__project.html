<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-11-26 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 55: giteaのコードを読んだメモ</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 55: giteaのコードを読んだメモ</h1>

<div id="outline-container-orga382329" class="outline-2">
<h2 id="orga382329"><a href="#orga382329"><span class="done DONE">DONE</span> プロジェクトステータス</a></h2>
<div class="outline-text-2" id="text-orga382329">
<p>
プロジェクトは終了である。
</p>
</div>
</div>

<div id="outline-container-orgd260bb5" class="outline-2">
<h2 id="orgd260bb5"><a href="#orgd260bb5">概要</a></h2>
<div class="outline-text-2" id="text-orgd260bb5">
<p>
<a href="https://github.com/go-gitea/gitea">go-gitea/gitea</a>を読んだメモ。バックエンドは<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>で書かれている。
</p>
</div>
</div>

<div id="outline-container-org0cd324f" class="outline-2">
<h2 id="org0cd324f"><a href="#org0cd324f">memo</a></h2>
<div class="outline-text-2" id="text-org0cd324f">
</div>
<div id="outline-container-orgcd9a26d" class="outline-3">
<h3 id="orgcd9a26d"><a href="#orgcd9a26d">コンパイル</a></h3>
<div class="outline-text-3" id="text-orgcd9a26d">
<p>
コンパイルしている部分。タスク名が動的になっていてわかりにくい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/Makefile#L788-L789
</pre>
</div>

<pre class="example">
$(EXECUTABLE): $(GO_SOURCES) $(TAGS_PREREQ)
	CGO_CFLAGS="$(CGO_CFLAGS)" $(GO) build $(GOFLAGS) $(EXTRA_GOFLAGS) -tags '$(TAGS)' -ldflags '-s -w $(LDFLAGS)' -o $@
</pre>
</div>
</div>

<div id="outline-container-orgcb03419" class="outline-3">
<h3 id="orgcb03419"><a href="#orgcb03419">routerを起動している部分</a></h3>
<div class="outline-text-3" id="text-orgcb03419">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/web.go#L211
</pre>
</div>

<pre class="example">
webRoutes := routers.NormalRoutes()
</pre>
</div>
</div>

<div id="outline-container-org23822fb" class="outline-3">
<h3 id="org23822fb"><a href="#org23822fb">DB設定部分</a></h3>
<div class="outline-text-3" id="text-org23822fb">
<p>
setting packageにまとめられている。パッケージで変数化されている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>database</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/0999721c7b4d124c1f14bbd067acdcf767542abb/modules/setting/database.go#L27-L28
</pre>
</div>

<pre class="example">
// Database holds the database settings
Database = struct {
</pre>

<p>
変数はグローバル変数にしつつ↑、セットはパッケージ内の関数でやる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/setting/database.go#L59-L65
</pre>
</div>

<pre class="example">
func loadDBSetting(rootCfg ConfigProvider) {
	sec := rootCfg.Section("database")
	Database.Type = DatabaseType(sec.Key("DB_TYPE").String())

	Database.Host = sec.Key("HOST").String()
	Database.Name = sec.Key("NAME").String()
	Database.User = sec.Key("USER").String()
</pre>
</div>
</div>

<div id="outline-container-org5aaaf33" class="outline-3">
<h3 id="org5aaaf33"><a href="#org5aaaf33">DB初期化部分</a></h3>
<div class="outline-text-3" id="text-org5aaaf33">
<p>
routerでのDBの初期化は↓でやっている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L132-L133
</pre>
</div>

<pre class="example">
// InitEngine initializes the xorm.Engine and sets it as db.DefaultContext
func InitEngine(ctx context.Context) error {
</pre>

<p>
InitEngineの中でデータベースを初期化する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>InitEngine(ctx context.Context) error 内で実行する</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L134
</pre>
</div>

<pre class="example">
xormEngine, err := newXORMEngine()
</pre>

<p>
InitEngineの中でSetDefaultEngine()して初期化したデータベースをDefaultContextに設定する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<pre class="example">
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</pre>

<p>
セットできているかの確認文。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/init.go#L136
</pre>
</div>

<pre class="example">
mustInitCtx(ctx, common.InitDBEngine)
</pre>
</div>
</div>

<div id="outline-container-org285f4d5" class="outline-3">
<h3 id="org285f4d5"><a href="#org285f4d5">変数default contextに設定する</a></h3>
<div class="outline-text-3" id="text-org285f4d5">
<p>
設定している部分。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<pre class="example">
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</pre>

<p>
テストとかではdefault contextを使って、dbを簡単に起動している。そうでない部分では、起動時に明示して上書きしているようだ。
</p>
</div>
</div>

<div id="outline-container-orgf2588a9" class="outline-3">
<h3 id="orgf2588a9"><a href="#orgf2588a9">APIContextをセットしている部分</a></h3>
<div class="outline-text-3" id="text-orgf2588a9">
<p>
DBのデータなどはcontext.APIContextで伝達している。APIContextにはBaseが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>APIContextの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L28-L43
</pre>
</div>

<pre class="example">
// APIContext is a specific context for API service
type APIContext struct {
	*Base

	Cache cache.Cache

	Doer        *user_model.User // current signed-in user
	IsSigned    bool
	IsBasicAuth bool

	ContextUser *user_model.User // the user which is being visited, in most cases it differs from Doer

	Repo    *Repository
	Org     *APIOrganization
	Package *Package
}
</pre>

<p>
Baseにはcontext.Contextが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Baseの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/base.go#L31-L44
</pre>
</div>

<pre class="example">
type Base struct {
	originCtx     context.Context
	contextValues []contextValuePair

	Resp ResponseWriter
	Req  *http.Request

	// Data is prepared by ContextDataStore middleware, this field only refers to the pre-created/prepared ContextData.
	// Although it's mainly used for MVC templates, sometimes it's also used to pass data between middlewares/handler
	Data middleware.ContextData

	// Locale is mainly for Web context, although the API context also uses it in some cases: message response, form validation
	Locale translation.Locale
}
</pre>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L223
</pre>
</div>

<pre class="example">
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
</pre>
</div>
</div>

<div id="outline-container-orga329cd7" class="outline-3">
<h3 id="orga329cd7"><a href="#orga329cd7">contextからdbインスタンスを取り出す</a></h3>
<div class="outline-text-3" id="text-orga329cd7">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/admin/task.go#L56
</pre>
</div>

<pre class="example">
has, err := db.GetEngine(ctx).ID(task.RepoID).Get(&amp;repo)
</pre>
</div>
</div>

<div id="outline-container-org026c33b" class="outline-3">
<h3 id="org026c33b"><a href="#org026c33b">DBコンテキストは異なる</a></h3>
<div class="outline-text-3" id="text-org026c33b">
<p>
DBのためだけにありそう。defaultContextが入るのはこれ。contextを構造体に埋め込むのはよくないとされている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L29-L34
</pre>
</div>

<pre class="example">
// Context represents a db context
type Context struct {
	context.Context
	e           Engine
	transaction bool
}
</pre>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>クエリを走らせるためのcontext</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L14-L16
</pre>
</div>

<pre class="example">
// DefaultContext is the default context to run xorm queries in
// will be overwritten by Init with HammerContext
var DefaultContext context.Context
</pre>

<p>
context.Contextはインターフェースなので、DefaultContextにはdb.Contextが入る。
</p>

<p>
このDBコンテキストは、Engine()を実装しているのでEnginedインターフェースを満たす。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L67-L90
</pre>
</div>

<pre class="example">
// Engined structs provide an Engine
type Engined interface {
	Engine() Engine
}

// GetEngine will get a db Engine from this context or return an Engine restricted to this context
func GetEngine(ctx context.Context) Engine {
	if e := getEngine(ctx); e != nil {
		return e
	}
	return x.Context(ctx)
}

// getEngine will get a db Engine from this context or return nil
func getEngine(ctx context.Context) Engine {
	if engined, ok := ctx.(Engined); ok {
		return engined.Engine()
	}
	enginedInterface := ctx.Value(enginedContextKey)
	if enginedInterface != nil {
		return enginedInterface.(Engined).Engine()
	}
	return nil
}
</pre>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L49-L52
</pre>
</div>

<pre class="example">
// Engine returns db engine
func (ctx *Context) Engine() Engine {
	return ctx.e
}
</pre>
</div>
</div>

<div id="outline-container-org1d049d6" class="outline-3">
<h3 id="org1d049d6"><a href="#org1d049d6">DBオブジェクト宣言</a></h3>
<div class="outline-text-3" id="text-org1d049d6">
<p>
xormのオブジェクト作成はxorm.NewEngine()で行う。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>func newXORMEngine() (*xorm.Engine, error) で実行している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L107
</pre>
</div>

<pre class="example">
engine, err = xorm.NewEngine("postgresschema", connStr)
</pre>
</div>
</div>

<div id="outline-container-org5ba6392" class="outline-3">
<h3 id="org5ba6392"><a href="#org5ba6392">テストで、どうやってDefaultContextをセットしているか</a></h3>
<div class="outline-text-3" id="text-org5ba6392">
<p>
テストでたくさん使っている。便利だ。これはいつセットされているか。
</p>

<p>
最初にunittest.PrepareTestDatabase()する。この中でDefaultContextに対してクエリが実行されている。そのあとDefaultContextを直に取得して実行する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/actions/runner_token_test.go#L16-L18
</pre>
</div>

<pre class="example">
assert.NoError(t, unittest.PrepareTestDatabase())
token := unittest.AssertExistsAndLoadBean(t, &amp;ActionRunnerToken{ID: 3})
expectedToken, err := GetLatestRunnerToken(db.DefaultContext, 1, 0)
</pre>

<p>
dbはcontextのvalueで持つべきじゃないらしい。リクエストスコープでないから。ダメじゃんと思ったけれども、contextの内部で持ってるわけではなく構造体で持ってるからいいのか。
</p>
</div>
</div>

<div id="outline-container-org960c649" class="outline-3">
<h3 id="org960c649"><a href="#org960c649">APIコンテキストはどうやって生成しているか</a></h3>
<div class="outline-text-3" id="text-org960c649">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>リクエスト時の普通のcontextから、APIContextを生成している部分</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L243
</pre>
</div>

<pre class="example">
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
			defer baseCleanUp()

			ctx.Base.AppendContextValue(apiContextKey, ctx)
			ctx.Base.AppendContextValueFunc(git.RepositoryContextKey, func() any { return ctx.Repo.GitRepo })

			// If request sends files, parse them here otherwise the Query() can't be parsed and the CsrfToken will be invalid.
			if ctx.Req.Method == "POST" &amp;&amp; strings.Contains(ctx.Req.Header.Get("Content-Type"), "multipart/form-data") {
				if err := ctx.Req.ParseMultipartForm(setting.Attachment.MaxSize &lt;&lt; 20); err != nil &amp;&amp; !strings.Contains(err.Error(), "EOF") { // 32MB max size
					ctx.InternalServerError(err)
					return
				}
			}

			httpcache.SetCacheControlInHeader(ctx.Resp.Header(), 0, "no-transform")
			ctx.Resp.Header().Set(`X-Frame-Options`, setting.CORSConfig.XFrameOptions)

			next.ServeHTTP(ctx.Resp, ctx.Req)
		})
	}
}
</pre>

<p>
ミドルウェアとして登録されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/api/v1/api.go#L807
</pre>
</div>

<pre class="example">
m.Use(context.APIContexter())
</pre>

<p>
DB関係なくないか。どこでセットされているか。
</p>

<p>
トランザクションコンテキストは必要。なぜ。
</p>
</div>
</div>

<div id="outline-container-org21771c6" class="outline-3">
<h3 id="org21771c6"><a href="#org21771c6">マイグレーションコマンド</a></h3>
<div class="outline-text-3" id="text-org21771c6">
<p>
マイグレーションはタスクで行う。あるいは、Webの起動時にも関数が用意されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/migrate.go#L25
</pre>
</div>

<pre class="example">
func runMigrate(ctx *cli.Context) error {
</pre>
</div>
</div>

<div id="outline-container-orgcca7f08" class="outline-3">
<h3 id="orgcca7f08"><a href="#orgcca7f08">テスト時にどうやってDB初期化されているか</a></h3>
<div class="outline-text-3" id="text-orgcca7f08">
<ul class="org-ul">
<li>マイグレーション</li>
<li>DefaultContext初期化</li>
</ul>

<p>
が必要なはずだが見当たらない。
</p>

<p>
unittest.PrepareTestDatabase() を見るが、そのときにはすでにDefaultContextからDBが取得できている。
</p>

<p>
各test packageにあるtest_main.goにある、TestMain関数内でunittest.MainTest()している。MainTest内でDBを初期化してる。テスト時に必ず実行される。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>初期化している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/unittest/testdb.go#L73
</pre>
</div>

<pre class="example">
func MainTest(m *testing.M, testOpts ...*TestOptions) {
</pre>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
