<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-11-02 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 55: giteaのコードを読んだメモ</title>
<meta name="author" content="root" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css' /><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 55: giteaのコードを読んだメモ</h1>
<p>
<a href="https://github.com/go-gitea/gitea">go-gitea/gitea</a>を読んだメモ。バックエンドは<a href="20210911113057-go.html#ID-7cacbaa3-3995-41cf-8b72-58d6e07468b1">Go</a>で書かれている。
</p>

<div id="outline-container-org4882e68" class="outline-2">
<h2 id="org4882e68"><a href="#org4882e68">memo</a></h2>
<div class="outline-text-2" id="text-org4882e68">
</div>
<div id="outline-container-org76fd42d" class="outline-3">
<h3 id="org76fd42d"><a href="#org76fd42d">コンパイル</a></h3>
<div class="outline-text-3" id="text-org76fd42d">
<p>
コンパイルしている部分。タスク名が動的になっていてわかりにくい。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/Makefile#L788-L789
</pre>
</div>

<div class="results" id="org452c07a">
<p>
$(EXECUTABLE): $(GO_SOURCES) \((TAGS_PREREQ)
	CGO_CFLAGS="\)(CGO_CFLAGS)&ldquo; $(GO) build $(GOFLAGS) \((EXTRA_GOFLAGS) -tags '\)(TAGS)&rsquo; -ldflags &lsquo;-s -w $(LDFLAGS)&rsquo; -o $@
</p>

</div>
</div>
</div>

<div id="outline-container-org745b66b" class="outline-3">
<h3 id="org745b66b"><a href="#org745b66b">routerを起動している部分</a></h3>
<div class="outline-text-3" id="text-org745b66b">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/web.go#L211
</pre>
</div>

<div class="results" id="org7600b04">
<p>
webRoutes := routers.NormalRoutes()
</p>

</div>
</div>
</div>

<div id="outline-container-org454a111" class="outline-3">
<h3 id="org454a111"><a href="#org454a111">DB設定部分</a></h3>
<div class="outline-text-3" id="text-org454a111">
<p>
setting packageにまとめられている。パッケージで変数化されている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>database</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/0999721c7b4d124c1f14bbd067acdcf767542abb/modules/setting/database.go#L27-L28
</pre>
</div>

<div class="results" id="org11b708d">
<p>
// Database holds the database settings
Database = struct {
</p>

</div>

<p>
変数はグローバル変数にしつつ↑、セットはパッケージ内の関数でやる。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/setting/database.go#L59-L65
</pre>
</div>

<div class="results" id="orgeb46934">
<p>
func loadDBSetting(rootCfg ConfigProvider) {
	sec := rootCfg.Section(&ldquo;database&rdquo;)
	Database.Type = DatabaseType(sec.Key(&ldquo;DB_TYPE&rdquo;).String())
</p>

<p>
Database.Host = sec.Key(&ldquo;HOST&rdquo;).String()
Database.Name = sec.Key(&ldquo;NAME&rdquo;).String()
Database.User = sec.Key(&ldquo;USER&rdquo;).String()
</p>

</div>
</div>
</div>

<div id="outline-container-orgc2ae6ad" class="outline-3">
<h3 id="orgc2ae6ad"><a href="#orgc2ae6ad">DB初期化部分</a></h3>
<div class="outline-text-3" id="text-orgc2ae6ad">
<p>
routerでのDBの初期化は↓でやっている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L132-L133
</pre>
</div>

<div class="results" id="orge1eeefa">
<p>
// InitEngine initializes the xorm.Engine and sets it as db.DefaultContext
func InitEngine(ctx context.Context) error {
</p>

</div>

<p>
InitEngineの中でデータベースを初期化する。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>InitEngine(ctx context.Context) error 内で実行する</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L134
</pre>
</div>

<div class="results" id="orgbdd80d6">
<p>
xormEngine, err := newXORMEngine()
</p>

</div>

<p>
InitEngineの中でSetDefaultEngine()して初期化したデータベースをDefaultContextに設定する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<div class="results" id="orge131001">
<p>
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</p>

</div>

<p>
セットできているかの確認文。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/init.go#L136
</pre>
</div>

<div class="results" id="orgcb127d8">
<p>
mustInitCtx(ctx, common.InitDBEngine)
</p>

</div>
</div>
</div>

<div id="outline-container-orgaa3342c" class="outline-3">
<h3 id="orgaa3342c"><a href="#orgaa3342c">変数default contextに設定する</a></h3>
<div class="outline-text-3" id="text-orgaa3342c">
<p>
設定している部分。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L153-L160
</pre>
</div>

<div class="results" id="org0d4c6ba">
<p>
// SetDefaultEngine sets the default engine for db
func SetDefaultEngine(ctx context.Context, eng *xorm.Engine) {
	x = eng
	DefaultContext = &amp;Context{
		Context: ctx,
		e:       x,
	}
}
</p>

</div>

<p>
テストとかではdefault contextを使って、dbを簡単に起動している。そうでない部分では、起動時に明示して上書きしているようだ。
</p>
</div>
</div>

<div id="outline-container-org1cc81d5" class="outline-3">
<h3 id="org1cc81d5"><a href="#org1cc81d5">APIContextをセットしている部分</a></h3>
<div class="outline-text-3" id="text-org1cc81d5">
<p>
DBのデータなどはcontext.APIContextで伝達している。APIContextにはBaseが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>APIContextの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L28-L43
</pre>
</div>

<div class="results" id="org658cbc5">
<p>
// APIContext is a specific context for API service
type APIContext struct {
	*Base
</p>

<p>
Cache cache.Cache
</p>

<p>
Doer        *user_model.User // current signed-in user
IsSigned    bool
IsBasicAuth bool
</p>

<p>
ContextUser *user_model.User // the user which is being visited, in most cases it differs from Doer
</p>

<p>
	Repo    *Repository
	Org     *APIOrganization
	Package *Package
}
</p>

</div>

<p>
Baseにはcontext.Contextが埋め込まれている。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Baseの定義</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/base.go#L31-L44
</pre>
</div>

<div class="results" id="orgff9c133">
<p>
type Base struct {
	originCtx     context.Context
	contextValues []contextValuePair
</p>

<p>
Resp ResponseWriter
Req  *http.Request
</p>

<p>
<i>/ Data is prepared by ContextDataStore middleware, this field only refers to the pre-created/prepared ContextData.
/</i> Although it&rsquo;s mainly used for MVC templates, sometimes it&rsquo;s also used to pass data between middlewares/handler
Data middleware.ContextData
</p>

<p>
	// Locale is mainly for Web context, although the API context also uses it in some cases: message response, form validation
	Locale translation.Locale
}
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L223
</pre>
</div>

<div class="results" id="org52ba004">
<p>
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
</p>

</div>
</div>
</div>

<div id="outline-container-orgedce98f" class="outline-3">
<h3 id="orgedce98f"><a href="#orgedce98f">contextからdbインスタンスを取り出す</a></h3>
<div class="outline-text-3" id="text-orgedce98f">
<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/admin/task.go#L56
</pre>
</div>

<div class="results" id="org4b70cd0">
<p>
has, err := db.GetEngine(ctx).ID(task.RepoID).Get(&amp;repo)
</p>

</div>
</div>
</div>

<div id="outline-container-org027d93c" class="outline-3">
<h3 id="org027d93c"><a href="#org027d93c">DBコンテキストは異なる</a></h3>
<div class="outline-text-3" id="text-org027d93c">
<p>
DBのためだけにありそう。defaultContextが入るのはこれ。contextを構造体に埋め込むのはよくないとされている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L29-L34
</pre>
</div>

<div class="results" id="orgea2ce17">
<p>
// Context represents a db context
type Context struct {
	context.Context
	e           Engine
	transaction bool
}
</p>

</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>クエリを走らせるためのcontext</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L14-L16
</pre>
</div>

<div class="results" id="orgf80b717">
<p>
<i>/ DefaultContext is the default context to run xorm queries in
/</i> will be overwritten by Init with HammerContext
var DefaultContext context.Context
</p>

</div>

<p>
context.Contextはインターフェースなので、DefaultContextにはdb.Contextが入る。
</p>

<p>
このDBコンテキストは、Engine()を実装しているのでEnginedインターフェースを満たす。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L67-L90
</pre>
</div>

<div class="results" id="org31d194c">
<p>
// Engined structs provide an Engine
type Engined interface {
	Engine() Engine
}
</p>

<p>
// GetEngine will get a db Engine from this context or return an Engine restricted to this context
func GetEngine(ctx context.Context) Engine {
	if e := getEngine(ctx); e != nil {
		return e
	}
	return x.Context(ctx)
}
</p>

<p>
// getEngine will get a db Engine from this context or return nil
func getEngine(ctx context.Context) Engine {
	if engined, ok := ctx.(Engined); ok {
		return engined.Engine()
	}
	enginedInterface := ctx.Value(enginedContextKey)
	if enginedInterface != nil {
		return enginedInterface.(Engined).Engine()
	}
	return nil
}
</p>

</div>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/context.go#L49-L52
</pre>
</div>

<div class="results" id="orge22c9fb">
<p>
// Engine returns db engine
func (ctx *Context) Engine() Engine {
	return ctx.e
}
</p>

</div>
</div>
</div>

<div id="outline-container-org2598856" class="outline-3">
<h3 id="org2598856"><a href="#org2598856">DBオブジェクト宣言</a></h3>
<div class="outline-text-3" id="text-org2598856">
<p>
xormのオブジェクト作成はxorm.NewEngine()で行う。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>func newXORMEngine() (*xorm.Engine, error) で実行している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/db/engine.go#L107
</pre>
</div>

<div class="results" id="org846a04e">
<p>
engine, err = xorm.NewEngine(&ldquo;postgresschema&rdquo;, connStr)
</p>

</div>
</div>
</div>

<div id="outline-container-org3c1c7a3" class="outline-3">
<h3 id="org3c1c7a3"><a href="#org3c1c7a3">テストで、どうやってDefaultContextをセットしているか</a></h3>
<div class="outline-text-3" id="text-org3c1c7a3">
<p>
テストでたくさん使っている。便利だ。これはいつセットされているか。
</p>

<p>
最初にunittest.PrepareTestDatabase()する。この中でDefaultContextに対してクエリが実行されている。そのあとDefaultContextを直に取得して実行する。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/actions/runner_token_test.go#L16-L18
</pre>
</div>

<div class="results" id="org1d8374a">
<p>
assert.NoError(t, unittest.PrepareTestDatabase())
token := unittest.AssertExistsAndLoadBean(t, &amp;ActionRunnerToken{ID: 3})
expectedToken, err := GetLatestRunnerToken(db.DefaultContext, 1, 0)
</p>

</div>

<p>
dbはcontextのvalueで持つべきじゃないらしい。リクエストスコープでないから。ダメじゃんと思ったけれども、contextの内部で持ってるわけではなく構造体で持ってるからいいのか。
</p>
</div>
</div>

<div id="outline-container-orgac37052" class="outline-3">
<h3 id="orgac37052"><a href="#orgac37052">APIコンテキストはどうやって生成しているか</a></h3>
<div class="outline-text-3" id="text-orgac37052">
<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 7: </span>リクエスト時の普通のcontextから、APIContextを生成している部分</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/modules/context/api.go#L213-L243
</pre>
</div>

<div class="results" id="org11375dd">
<p>
// APIContexter returns apicontext as middleware
func APIContexter() func(http.Handler) http.Handler {
	return func(next http.Handler) http.Handler {
		return http.HandlerFunc(func(w http.ResponseWriter, req *http.Request) {
			base, baseCleanUp := NewBaseContext(w, req)
			ctx := &amp;APIContext{
				Base:  base,
				Cache: mc.GetCache(),
				Repo:  &amp;Repository{PullRequest: &amp;PullRequest{}},
				Org:   &amp;APIOrganization{},
			}
			defer baseCleanUp()
</p>

<p>
ctx.Base.AppendContextValue(apiContextKey, ctx)
ctx.Base.AppendContextValueFunc(git.RepositoryContextKey, func() any { return ctx.Repo.GitRepo })
</p>

<p>
<i>/ If request sends files, parse them here otherwise the Query() can&rsquo;t be parsed and the CsrfToken will be invalid.
if ctx.Req.Method <code>= "POST" &amp;&amp; strings.Contains(ctx.Req.Header.Get("Content-Type"), "multipart/form-data") {
				if err :</code> ctx.Req.ParseMultipartForm(setting.Attachment.MaxSize &lt;&lt; 20); err != nil &amp;&amp; !strings.Contains(err.Error(), &ldquo;EOF&rdquo;) { /</i> 32MB max size
		ctx.InternalServerError(err)
		return
	}
}
</p>

<p>
httpcache.SetCacheControlInHeader(ctx.Resp.Header(), 0, &ldquo;no-transform&rdquo;)
ctx.Resp.Header().Set(`X-Frame-Options`, setting.CORSConfig.XFrameOptions)
</p>

<p>
			next.ServeHTTP(ctx.Resp, ctx.Req)
		})
	}
}
</p>

</div>

<p>
ミドルウェアとして登録されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/routers/api/v1/api.go#L807
</pre>
</div>

<div class="results" id="org332e6f7">
<p>
m.Use(context.APIContexter())
</p>

</div>

<p>
DB関係なくないか。どこでセットされているか。
</p>

<p>
トランザクションコンテキストは必要。なぜ。
</p>
</div>
</div>

<div id="outline-container-org98f9bff" class="outline-3">
<h3 id="org98f9bff"><a href="#org98f9bff">マイグレーションコマンド</a></h3>
<div class="outline-text-3" id="text-org98f9bff">
<p>
マイグレーションはタスクで行う。あるいは、Webの起動時にも関数が用意されている。
</p>

<div class="org-src-container">
<pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/cmd/migrate.go#L25
</pre>
</div>

<div class="results" id="orga0e6087">
<p>
func runMigrate(ctx *cli.Context) error {
</p>

</div>
</div>
</div>

<div id="outline-container-org1db59da" class="outline-3">
<h3 id="org1db59da"><a href="#org1db59da">テスト時にどうやってDB初期化されているか</a></h3>
<div class="outline-text-3" id="text-org1db59da">
<ul class="org-ul">
<li>マイグレーション</li>
<li>DefaultContext初期化</li>
</ul>

<p>
が必要なはずだが見当たらない。
</p>

<p>
unittest.PrepareTestDatabase() を見るが、そのときにはすでにDefaultContextからDBが取得できている。
</p>

<p>
各test packageにあるtest_main.goにある、TestMain関数内でunittest.MainTest()している。MainTest内でDBを初期化してる。テスト時に必ず実行される。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 8: </span>初期化している</label><pre class="src src-git-permalink">https://github.com/go-gitea/gitea/blob/8ef169a173c24e5ab57de8d6638bb6786e378a3d/models/unittest/testdb.go#L73
</pre>
</div>

<div class="results" id="orgf87bceb">
<p>
func MainTest(m *testing.M, testOpts &#x2026;*TestOptions) {
</p>

</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
