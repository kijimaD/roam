<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2023-09-18 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SQL</title>
<meta name="generator" content="Org mode">
<meta name="author" content="root">
<link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css' /><link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css'><link rel='stylesheet' href='../css/site.css' /><link rel='stylesheet' href='../roam/css/code.css' /><link rel='stylesheet' href='css/site.css' /><link rel='stylesheet' href='css/code.css' />
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content">
<h1 class="title">SQL</h1>

<div id="outline-container-orge407116" class="outline-2">
<h2 id="orge407116"><a href="#orge407116">概要</a></h2>
<div class="outline-text-2" id="text-orge407116">
<p>
SQLは、データベースを操作するための言語。RDMS(<a href="20210829232020-mysql.html#ID-7dab097c-60ba-43b9-949f-c58bf3151aa8">MySQL</a>, <a href="20210905195215-postgresql.html#ID-752d725e-b834-4784-8110-c58f89bd4fa2">PostgreSQL</a>)の種類によって実装・挙動が微妙に異なる。
</p>

<ul class="org-ul">
<li>Wikipedia: <a href="https://ja.wikipedia.org/wiki/SQL">https://ja.wikipedia.org/wiki/SQL</a></li>
</ul>
</div>
</div>
<div id="outline-container-org55e6016" class="outline-2">
<h2 id="org55e6016"><a href="#org55e6016">Tasks</a></h2>
<div class="outline-text-2" id="text-org55e6016">
</div>
<div id="outline-container-orgd5f8501" class="outline-3">
<h3 id="orgd5f8501"><a href="#orgd5f8501"><span class="todo TODO">TODO</span> <a href="https://www.oreilly.co.jp/books/9784873115894/">O&rsquo;Reilly Japan - SQLアンチパターン</a></a></h3>
<div class="outline-text-3" id="text-orgd5f8501">
<p>
データベース開発におけるアンチパターンを紹介している。
</p>
</div>
</div>
<div id="outline-container-org62a1f37" class="outline-3">
<h3 id="org62a1f37"><a href="#org62a1f37"><span class="todo TODO">TODO</span> 達人に学ぶSQL 徹底指南書</a></h3>
<div class="outline-text-3" id="text-org62a1f37">
<ul class="org-ul">
<li><a href="https://www.amazon.co.jp/s?k=sql&amp;__mk_ja_JP=%E3%82%AB%E3%82%BF%E3%82%AB%E3%83%8A&amp;ref=nb_sb_noss">Amazon.co.jp : sql</a></li>
</ul>
</div>
</div>
<div id="outline-container-org5b537ba" class="outline-3">
<h3 id="org5b537ba"><a href="#org5b537ba"><span class="todo TODO">TODO</span> <a href="https://www.amazon.co.jp/%E5%A4%B1%E6%95%97%E3%81%8B%E3%82%89%E5%AD%A6%E3%81%B6RDB%E3%81%AE%E6%AD%A3%E3%81%97%E3%81%84%E6%AD%A9%E3%81%8D%E6%96%B9-Software-Design-plus-%E6%9B%BD%E6%A0%B9/dp/4297104083">失敗から学ぶRDBの正しい歩き方 (Software Design plus) | 曽根 壮大 |本 | 通販 | Amazon</a></a></h3>
<div class="outline-text-3" id="text-org5b537ba">
<p>
アンチパターンを知っておくとよい。
</p>
</div>
</div>
</div>
<div id="outline-container-org9d1803b" class="outline-2">
<h2 id="org9d1803b"><a href="#org9d1803b">Memo</a></h2>
<div class="outline-text-2" id="text-org9d1803b">
</div>
<div id="outline-container-orge5f5d84" class="outline-3">
<h3 id="orge5f5d84"><a href="#orge5f5d84">プロセス一覧を見る</a></h3>
<div class="outline-text-3" id="text-orge5f5d84">
<p>
SQLで、DB関連の情報を得ることができる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>プロセスの一覧を取得する</label><pre class="src src-sql">show processlist;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgeb0d981" class="outline-3">
<h3 id="orgeb0d981"><a href="#orgeb0d981">LinuxでのDB閲覧/操作ツール</a></h3>
<div class="outline-text-3" id="text-orgeb0d981">
<p>
Macでは、Sequel Pro が多いはず。
Linuxでは、DBeaver が有力のよう。
</p>

<p>
インストールページ。
<a href="https://dbeaver.io/download/">Download | DBeaver Community</a>
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>snapでダウンロード</label><pre class="src src-shell">sudo snap install dbeaver-ce
</pre>
</div>

<p>
↑snapだとバージョンが古く、エラーが出た。最初のローディング画面は出るが、それ以降が何も表示されない。
</p>
<blockquote>
<p>
org.eclipse.swt.SWTException: Graphic is disposed
</p>
</blockquote>

<p>
↓このissueと同じ状況に見える。
<a href="https://github.com/dbeaver/dbeaver/issues/8319">https://github.com/dbeaver/dbeaver/issues/8319</a>
</p>

<p>
公式サイトからdebファイルをダウンロードして入れると、無事起動した。
<a href="https://dbeaver.io/download/">Download | DBeaver Community</a>
</p>

<ul class="org-ul">
<li>レコード編集機能がある
<ul class="org-ul">
<li>表示レコードをそのままいじれる機能。</li>
<li>DBeaverのほかにsqlelectronもいい感じだったのだが、カラムから編集できる機能がないのは致命的で使うのを見送った。</li>
</ul></li>
<li>ER図を自動生成してくれる
<ul class="org-ul">
<li>関連できたりできなかったりだが、最初から入ってるのはありがたい。</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org193f4c3" class="outline-3">
<h3 id="org193f4c3"><a href="#org193f4c3">正規表現</a></h3>
<div class="outline-text-3" id="text-org193f4c3">
<p>
<code>~</code> で正規表現が使える。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">select</span> *
<span class="org-keyword">from</span> customer
<span class="org-keyword">where</span> status_cd ~ <span class="org-string">'^[A-F]'</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd02b391" class="outline-3">
<h3 id="orgd02b391"><a href="#orgd02b391">カラムにない項目で集計する</a></h3>
<div class="outline-text-3" id="text-orgd02b391">
<p>
重複してださい方法。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#20154;&#21475;&#38542;&#32026;&#12372;&#12392;&#12395;&#22320;&#26041;&#21517;&#12395;&#20877;&#20998;&#39006;&#12377;&#12427;</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> population &lt; 100 <span class="org-keyword">THEN</span> <span class="org-string">'01'</span>
       <span class="org-keyword">WHEN</span> population &gt;= 100 <span class="org-keyword">AND</span> population &lt; 200 <span class="org-keyword">THEN</span> <span class="org-string">'02'</span>
       <span class="org-keyword">WHEN</span> population &gt;= 200 <span class="org-keyword">AND</span> population &lt; 300 <span class="org-keyword">THEN</span> <span class="org-string">'03'</span>
       <span class="org-keyword">WHEN</span> population &gt;= 300 <span class="org-keyword">THEN</span> <span class="org-string">'04'</span>
       <span class="org-keyword">ELSE</span> <span class="org-keyword">NULL</span> <span class="org-keyword">END</span> <span class="org-keyword">AS</span> pop_class,
       <span class="org-builtin">COUNT</span>(*) <span class="org-keyword">AS</span> cnt
  <span class="org-keyword">FROM</span> PopTbl
 <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> <span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> population &lt; 100 <span class="org-keyword">THEN</span> <span class="org-string">'01'</span>
          <span class="org-keyword">WHEN</span> population &gt;= 100 <span class="org-keyword">AND</span> population &lt; 200 <span class="org-keyword">THEN</span> <span class="org-string">'02'</span>
          <span class="org-keyword">WHEN</span> population &gt;= 200 <span class="org-keyword">AND</span> population &lt; 300 <span class="org-keyword">THEN</span> <span class="org-string">'03'</span>
          <span class="org-keyword">WHEN</span> population &gt;= 300 <span class="org-keyword">THEN</span> <span class="org-string">'04'</span>
          <span class="org-keyword">ELSE</span> <span class="org-keyword">NULL</span> <span class="org-keyword">END</span>;
</pre>
</div>

<p>
DBによっては名前をつけて参照できる。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- &#30476;&#21517;&#12434;&#22320;&#26041;&#21517;&#12395;&#20998;&#39006;&#12377;&#12427;</span>
<span class="org-keyword">SELECT</span> <span class="org-keyword">CASE</span> pref_name
       <span class="org-keyword">WHEN</span> <span class="org-string">'&#24499;&#23798;'</span> <span class="org-keyword">THEN</span> <span class="org-string">'&#22235;&#22269;'</span>
       <span class="org-keyword">WHEN</span> <span class="org-string">'&#39321;&#24029;'</span> <span class="org-keyword">THEN</span> <span class="org-string">'&#22235;&#22269;'</span>
       <span class="org-keyword">WHEN</span> <span class="org-string">'&#24859;&#23195;'</span> <span class="org-keyword">THEN</span> <span class="org-string">'&#22235;&#22269;'</span>
       <span class="org-keyword">WHEN</span> <span class="org-string">'&#39640;&#30693;'</span> <span class="org-keyword">THEN</span> <span class="org-string">'&#22235;&#22269;'</span>
       <span class="org-keyword">WHEN</span> <span class="org-string">'&#31119;&#23713;'</span> <span class="org-keyword">THEN</span> <span class="org-string">'&#20061;&#24030;'</span>
       <span class="org-keyword">WHEN</span> <span class="org-string">'&#20304;&#36032;'</span> <span class="org-keyword">THEN</span> <span class="org-string">'&#20061;&#24030;'</span>
       <span class="org-keyword">WHEN</span> <span class="org-string">'&#38263;&#23822;'</span> <span class="org-keyword">THEN</span> <span class="org-string">'&#20061;&#24030;'</span>
       <span class="org-keyword">ELSE</span> <span class="org-string">'&#12381;&#12398;&#20182;'</span> <span class="org-keyword">END</span> <span class="org-keyword">AS</span> district,
       <span class="org-builtin">SUM</span>(population)
  <span class="org-keyword">FROM</span> PopTbl
 <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> district;
</pre>
</div>
</div>
</div>
<div id="outline-container-org60dd9b5" class="outline-3">
<h3 id="org60dd9b5"><a href="#org60dd9b5">条件を指定して集計する</a></h3>
<div class="outline-text-3" id="text-org60dd9b5">
<p>
where句で異なる条件を記述して2回SQLを発行するような場面。
</p>
<div class="org-src-container">
<pre class="src src-sql">  <span class="org-comment">-- &#30007;&#24615;&#12398;&#20154;&#21475;</span>
<span class="org-keyword">SELECT</span> pref_name,
       population
  <span class="org-keyword">FROM</span> PopTbl2
 <span class="org-keyword">WHERE</span> sex = <span class="org-string">'1'</span>;

<span class="org-comment">-- &#22899;&#24615;&#12398;&#20154;&#21475;</span>
<span class="org-keyword">SELECT</span> pref_name,
       population
  <span class="org-keyword">FROM</span> PopTbl2
 <span class="org-keyword">WHERE</span> sex = <span class="org-string">'2'</span>;

</pre>
</div>

<p>
case句で便利に書くとこう。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">SELECT</span> pref_name,
  <span class="org-comment">-- &#30007;&#24615;&#12398;&#20154;&#21475;</span>
       <span class="org-builtin">SUM</span>(<span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> sex = <span class="org-string">'1'</span> <span class="org-keyword">THEN</span> population <span class="org-keyword">ELSE</span> 0 <span class="org-keyword">END</span>) <span class="org-keyword">AS</span> cnt_m,
  <span class="org-comment">-- &#22899;&#24615;&#12398;&#20154;&#21475;</span>
       <span class="org-builtin">SUM</span>(<span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> sex = <span class="org-string">'2'</span> <span class="org-keyword">THEN</span> population <span class="org-keyword">ELSE</span> 0 <span class="org-keyword">END</span>) <span class="org-keyword">AS</span> cnt_f
  <span class="org-keyword">FROM</span> PopTbl2
 <span class="org-keyword">GROUP</span> <span class="org-keyword">BY</span> pref_name;
</pre>
</div>
<p>
SUM関数を必要性をチェックしてみる。
</p>
</div>
</div>
<div id="outline-container-org4582f68" class="outline-3">
<h3 id="org4582f68"><a href="#org4582f68">複数の列の条件関係を定義する</a></h3>
<div class="outline-text-3" id="text-org4582f68">
<p>
CHECK制約。
</p>

<p>
↓条件法。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CONSTRAINT</span> check_salary <span class="org-keyword">CHECK</span>
  (<span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> sex = <span class="org-string">'2'</span>
    <span class="org-keyword">THEN</span> <span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> salary &lt;= 200000
      <span class="org-keyword">THEN</span> 1 <span class="org-keyword">ELSE</span> 0 <span class="org-keyword">END</span>
  <span class="org-keyword">ELSE</span> 1 <span class="org-keyword">END</span> = 1)
</pre>
</div>

<p>
↓論理積。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">CONSTRAINT</span> CHECK_salary <span class="org-keyword">CHECK</span>
  (sex = <span class="org-string">'2'</span> <span class="org-keyword">AND</span> salary &lt;= 200000)
</pre>
</div>

<p>
条件法はゆるい。
</p>
</div>
</div>
<div id="outline-container-orgd948256" class="outline-3">
<h3 id="orgd948256"><a href="#orgd948256">UPDATEの順番で結果が変わるとき</a></h3>
<div class="outline-text-3" id="text-orgd948256">
<p>
1回目のupdateをした結果、2回目の条件に入ってしまうような場合。
caseをつかって1度に処理しないといけない。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-keyword">UPDATE</span> Personnel
   <span class="org-keyword">SET</span> salary = <span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> salary &gt;= 300000
       <span class="org-keyword">THEN</span> salary * 0.9
       <span class="org-keyword">WHEN</span> salary &gt;= 250000 <span class="org-keyword">AND</span> salary &lt; 280000
       <span class="org-keyword">THEN</span> salary * 1.2
       <span class="org-keyword">ELSE</span> salary <span class="org-keyword">END</span>;
</pre>
</div>

<p>
主キーを入れ替えることもできる。普通にUPDATE3回だと退避させる必要があるが、whenだと一気にできる。
</p>
<div class="org-src-container">
<pre class="src src-sql"><span class="org-comment">-- CASE&#24335;&#12391;&#20027;&#12461;&#12540;&#12434;&#20837;&#12428;&#26367;&#12360;&#12427;</span>
<span class="org-keyword">UPDATE</span> SomeTable
   <span class="org-keyword">SET</span> p_key = <span class="org-keyword">CASE</span> <span class="org-keyword">WHEN</span> p_key = <span class="org-string">'a'</span>
       <span class="org-keyword">THEN</span> <span class="org-string">'b'</span>
       <span class="org-keyword">WHEN</span> p_key = <span class="org-string">'b'</span>
       <span class="org-keyword">THEN</span> <span class="org-string">'a'</span>
       <span class="org-keyword">ELSE</span> p_key <span class="org-keyword">END</span>
       <span class="org-keyword">WHERE</span> p_key <span class="org-keyword">IN</span> (<span class="org-string">'a'</span>, <span class="org-string">'b'</span>);
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgfc7ad1e" class="outline-2">
<h2 id="orgfc7ad1e"><a href="#orgfc7ad1e">Refences</a></h2>
<div class="outline-text-2" id="text-orgfc7ad1e">
</div>
<div id="outline-container-org9ec23df" class="outline-3">
<h3 id="org9ec23df"><a href="#org9ec23df"><a href="https://use-the-index-luke.com/">SQL Indexing and Tuning e-Book for developers: Use The Index, Luke covers Oracle, MySQL, PostgreSQL, SQL Server, &#x2026;</a></a></h3>
<div class="outline-text-3" id="text-org9ec23df">
<p>
データベースのパフォーマンスの説明。
</p>
</div>
</div>
<div id="outline-container-org7b56d38" class="outline-3">
<h3 id="org7b56d38"><a href="#org7b56d38"><a href="https://sqlzoo.net/wiki/SQL_Tutorial">SQLZOO</a></a></h3>
<div class="outline-text-3" id="text-org7b56d38">
<p>
SQLの練習ができるサイト。
</p>
</div>
</div>
<div id="outline-container-org1d26223" class="outline-3">
<h3 id="org1d26223"><a href="#org1d26223"><a href="https://data.world/">data.world | The Cloud-Native Data Catalog</a></a></h3>
<div class="outline-text-3" id="text-org1d26223">
<p>
サンプルのデータを使って、SQLの練習ができる。
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"/>
</div>
</body>
</html>
