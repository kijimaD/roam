:PROPERTIES:
:ID:       e04aa1a3-509c-45b2-ac64-53d69c961214
:END:
#+title: Rails
* æ¦‚è¦
Railsã¯[[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]]ã§WEBã‚µã‚¤ãƒˆã‚’ä½œã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚
* Memo
** é›†è¨ˆæ™‚ã®N+1å›é¿
ç•°ãªã‚‹æ¡ä»¶ã®è¤‡æ•°ã®ä»¶æ•°ã‚’è¡¨ç¤ºã—ãŸã„ã¨ãã€‚ãŸã¨ãˆã°â†“ãƒ¬ã‚³ãƒ¼ãƒ‰ã§ã€Receiptsã«è¼‰ã£ã¦ã„ã‚‹productã®æ•°ã”ã¨ã«é›†è¨ˆã—ãŸã„ã€‚

- æœ€çµ‚å‹
| products.name | count |
| ãŠã«ãã‚Š      |     2 |
| ãŠèŒ¶          |     1 |



- Receipts
| id | product_id |   |
|  1 |          1 |   |
|  2 |          1 |   |
|  3 |          2 |   |

- Products
| id | name     |
|  1 | ãŠã«ãã‚Š |
|  2 | ãŠèŒ¶     |

ã“ã†ã‚„ã£ã¦æ›¸ãã¨æ˜ã‚‰ã‹ã«SQLã®groupé–¢æ•°ã‚’ä½¿ãŠã†ã€ã¨ãªã‚‹ã€‚ãŒã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯æ°—ã¥ã‹ãšã«æ¡ä»¶ã‚’å¤‰ãˆã¦eachã§ç¹°ã‚Šè¿”ã™â€¦ã¨ã—ã¦N+1ã«ã—ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚‹ã€‚ã“ã†ã™ã‚‹ã€‚

#+begin_src ruby
  Receipt.group(Product.arel_table[:id]).count
#+end_src

ã“ã®ã‚ˆã†ãªãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿”ã™ã€‚

#+begin_src json
// product_id => count
{
  1=>2,
  2=>1
}
#+end_src

product_idãŒã‚ã‹ã£ã¦ã„ã‚‹ã®ã§ã€ã‚ã¨ã¯Productã‚’findã—ã¦åå‰ã‚’å¼•ã‘ã°ã„ã„ã€‚

** ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã¯ã€configã§è¨­å®šã§ãã‚‹ã€‚
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®production, sandbox, stagingã§ã¯falseã«ãªã£ã¦ã„ã¦ã€ã‚¨ãƒ©ãƒ¼ã¯è¡¨ç¤ºã•ã‚Œãªã„ã€‚
ã“ã‚Œã‚‰ã®ç’°å¢ƒã§è¡¨ç¤ºã™ã‚‹ã«ã¯ã€â†“ã‚’åŠ ãˆã‚‹ã€‚
#+begin_src shell
config.consider_all_requests_local = true
#+end_src

** viewã§controllerã‚¯ãƒ©ã‚¹ã®æƒ…å ±ã‚’å¾—ã‚‹
ãŸã¾ã«å¿…è¦ãªã“ã¨ãŒã‚ã‚‹ã€‚
controllerã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒæŸ”è»Ÿãªæ„Ÿã˜ã€‚

#+caption: viewãƒ•ã‚¡ã‚¤ãƒ«
#+begin_src ruby
  controller.class # => #<Admin::UserController>
  controller_name # => users
  controller_path # => admin/users
#+end_src

#+caption: controllerãŒç‰¹å®šã®moduleã‚’includeã—ã¦ã„ã‚‹ã‹åˆ¤å®š
#+begin_src ruby
  controller.class.included_modules.include?(User::concern)
#+end_src
** å®šç¾©ã‚¸ãƒ£ãƒ³ãƒ—
[[id:1ad8c3d5-97ba-4905-be11-e6f2626127ad][Emacs]]ã‹ã‚‰å®šç¾©ã‚¸ãƒ£ãƒ³ãƒ—ã—ãŸã„ã€‚
ã»ã‹ã®è¨€èªã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã ã¨[[id:eb807577-cd69-478c-8f82-264243c67354][LSP]]ã ã®ã‚’ä½¿ãˆã°ã„ã„ãŒã€Railsã§ã¯ã©ã†ã™ã‚‹ã®ã‹ã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚
TAGSãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¦ä½¿ã†ã€‚

#+begin_src shell
  gem install ripper-tags
  ripper-tags -e -R -f TAGS
#+end_src

ã‚ã¨ã¯ã€C-. ã§ç”Ÿæˆã—ãŸã‚¿ã‚°ã‚’æŒ‡å®šã™ã‚Œã°OKã€‚

gemã‚‚å®šç¾©ã‚¸ãƒ£ãƒ³ãƒ—å¯¾è±¡ã«ã—ãŸã„å ´åˆã€ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã«gemã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ç½®ã‘ã°ã‚ˆã„ã€‚
#+begin_src shell
  bundle install --path vendor/bundle
#+end_src

[[https://qiita.com/arakaji/items/0cdfa843a0e0233df153][Railsã‚¢ãƒ—ãƒªå†…ã‚’Emacsã§è‡ªç”±ã«ã‚¿ã‚°ã‚¸ãƒ£ãƒ³ãƒ—! - Qiita]]
** mailerã¯ã‚­ãƒ¥ãƒ¼ã«ãŸã‚ã‚‰ã‚Œã‚‹ã®ã§ã€Serializationã§ããªã„å€¤ã¯æ¸¡ã™ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
SerializationErrorã«ãªã‚‹ã€‚
ãƒ¡ãƒ¼ãƒ©ãƒ¼ã«å¯¾ã—ã¦ã€ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã§ããªã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯æ¸¡ã™ã“ã¨ãŒã§ããªã„ã€‚
Railsã‹ã‚‰[[id:48b99bce-05ce-49af-921d-1e321e5a4f8b][Redis]]ã«æ¸¡ã•ã‚Œã‚‹ãŒã€[[id:48b99bce-05ce-49af-921d-1e321e5a4f8b][Redis]]ã¯key-value storeã®å½¢ã§ãªã„ã¨ä¿å­˜ã§ããªã„ã‹ã‚‰ã€‚
[[https://github.com/rails/rails/issues/18519][Mail and deliver_later doesn't work with date argument Â· Issue #18519 Â· rails/rails]]
** joinå…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§where
A -< B -< C -< D ã¿ãŸã„ãªé–¢ä¿‚ã€‚
#+caption: mergeã§é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«å…ˆã§æ¡ä»¶ã‚’çµã‚Œã‚‹
#+begin_src ruby
  a = A.joins(b: [c: :d])
        .where(a: { flag_a: true })
        .merge(D.where(flag_d: true))
#+end_src

åŒã˜æ„å‘³ã®ãƒ€ã‚µã„æ›¸ãæ–¹ã€‚
#+begin_src ruby
  a = a.joins(b: [c: :d])
        .where(a: { flag_a: true })
        .where(d: { flag_d: true })
#+end_src
** [[id:1658782a-d331-464b-9fd7-1f8233b8b7f8][Docker]]ã‚µãƒ³ãƒ—ãƒ«
é–‹ç™ºç”¨ç’°å¢ƒã®ã‚µãƒ³ãƒ—ãƒ«ã€‚ã‚µã‚¯ã£ã¨èµ·å‹•ã—ãŸã„ç”¨ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚ã¡ã“ã¡ã§ä½¿ã£ã¦ã‚‹ã®ã§ã€ã©ã“ã‹ã«ã¾ã¨ã‚ãŸã»ã†ãŒã‚ˆã•ãã†ã ãªã€‚

#+caption: Dockerfile
#+begin_src
FROM phusion/passenger-ruby27:latest

WORKDIR /tmp

ADD Gemfile /tmp/
ADD Gemfile.lock /tmp/
RUN gem update --system
RUN bundle install

COPY . /home/app/webapp
RUN usermod -u 1000 app
RUN chown -R app:app /home/app/webapp
WORKDIR /home/app/webapp

RUN apt-get clean && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
#+end_src

ã‹ã¶ã‚Šé˜²æ­¢ã®ãŸã‚3001ç•ªãƒãƒ¼ãƒˆã®æ–¹ã‚’å¤‰ãˆã¦ãƒ–ãƒ©ã‚¦ã‚¶ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€‚
#+caption: docker-compose.yml
#+begin_src yaml
version: '3'

services:
  rails:
    container_name: rails
    build: .
    command: bash -c 'rm -f tmp/pids/server.pid && bundle exec rails s -b 0.0.0.0'
    volumes:
      - .:/home/app/webapp
    ports:
      - "3001:3000"
#+end_src
** ä¾å­˜é–¢ä¿‚ä¸€åˆ‡ãªãrails newã™ã‚‹
å…¬å¼ã®railsã‚³ãƒ³ãƒ†ãƒŠå†…ã§rails newã™ã‚Œã°ã‚ˆã„ã€‚

#+caption: ä¾å­˜ãŒãªã„ä½œæˆæ–¹æ³•ã€‚userå‘¨ã‚Šã¯æ¨©é™å•é¡Œã®ãŸã‚âš ä¸€è¡Œ
#+begin_src shell
docker run -it --rm --user "$(id -u):$(id -g)" -v "$PWD":/usr/src/app -w /usr/src/app rails rails new --skip-bundle --api --database postgresql .
#+end_src

ä¾å­˜ãŒãªã„bundle installã€‚
ruby:2.7.5ã‚¤ãƒ¡ãƒ¼ã‚¸ã§èµ°ã‚‰ã›ã‚‹ã€‚
#+begin_src shell
docker run --rm -v "$PWD":/usr/src/app -w /usr/src/app ruby:2.7.5 bundle install
#+end_src

** factoryãŒãªã„ãƒ¢ãƒ‡ãƒ«ã‚’æ¤œçŸ¥ã™ã‚‹ã‚¿ã‚¹ã‚¯
factoryã¯ãƒ†ã‚¹ãƒˆã§ä½¿ã†ã®ã§ã€fixtureã»ã©å¿˜ã‚Œã‚‹ã“ã¨ã¯ãªã„ã€‚ä½œã‚Šå¿˜ã‚ŒãŸã‚Šã€éå»ã‚‚ã®ã§æ¼ã‚Œã¦ã„ã‚‹ã‚‚ã®ãŒãŸã¾ã«ã‚ã‚‹ã®ã§æ¤œçŸ¥ã™ã‚‹ã€‚

#+caption: rakeã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¦
#+begin_src ruby
  require "factory_bot_rails"
  include FactoryBot::Syntax::Methods
  include ActionDispatch::TestProcess #  # fixture_file_uploadãƒ¡ã‚½ãƒƒãƒ‰ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ãŸã‚å¿…è¦ã€‚

  task factory: :environment do
      msg = []
      errors = []

      Rails.application.eager_load!
      ApplicationRecord.subclasses.each do |model|
        begin
          create(model.name.underscore.gsub(%r{/}, '_')) # factoryã®ãƒ¡ã‚½ãƒƒãƒ‰
          # UserPayment -> user_payment
          # admin/user_payment -> admin_user_payment
        rescue => e
          errors << e if e.class == KeyError
        end
      end

      puts errors

      raise 'ç™»éŒ²ã•ã‚Œã¦ãªã„factoryãŒã‚ã‚Šã¾ã™' if errors
    end
#+end_src
** ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ¤œçŸ¥ã™ã‚‹ã‚¿ã‚¹ã‚¯
fixtureã®ä½œã‚Šå¿˜ã‚Œãªã©ã‚ˆãã‚ã‚‹ã®ã§ã€seedã‚’å®Ÿè¡Œã—ãŸã‚ã¨ã«ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’èµ°ã‚‰ã›ã‚‹ã¨ã‚ˆã„ã€‚

#+caption: rakeã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¦
#+begin_src ruby
  task lint: :environment do
    msg = []
    invalid = false

    Rails.application.eager_load!
    ApplicationRecord.subclasses.each do |model|
      msg << "#{model.name} => #{model.count}"
      invalid = true if model.count.zero?
    end

    puts msg

    raise 'ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãªã„ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Šã¾ã™' if invalid
  end
#+end_src
** seed_fuå†…ã§factory botã‚’ä½¿ã†
SeedFu.seedã‚’å®Ÿè¡Œã™ã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã§require, includeã—ã¦ãŠã‘ã°ãƒ¡ã‚½ãƒƒãƒ‰ãŒä½¿ãˆã‚‹ã€‚
#+caption: rakeã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«
#+begin_src ruby
  require "factory_bot_rails"
  include FactoryBot::Syntax::Methods
  include ActionDispatch::TestProcess
  SeedFu.quiet = true

  task lint: :environment do
    SeedFu.seed("db/fixtures/#{env}")
  end
#+end_src
** rakeã‚¿ã‚¹ã‚¯
rakeã‚¿ã‚¹ã‚¯ã¯ã€æ™®é€šã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰å®Ÿè¡Œã™ã‚‹ãŒã€ã»ã‹ã‹ã‚‰å®Ÿè¡Œã—ãŸã„ã¨ããŒã‚ã‚‹(ãƒ†ã‚¹ãƒˆã¨ã‹)ã€‚

#+caption: rails_helper.rbã«ã¦
#+begin_src ruby
  config.before(:each) do
    Rake.application.tasks.each(&:reenable)
  end
#+end_src

#+caption: ãƒ†ã‚¹ãƒˆä¸Šã«ã¦å®Ÿè¡Œã™ã‚‹
#+begin_src ruby
  Rake.application['namespace:command'].invoke
#+end_src

ã®ã‚ˆã†ã«ã—ã¦ã€å®Ÿè¡Œã§ãã‚‹ã€‚
** éåŒæœŸå‡¦ç†
Webã«ãŠã‘ã‚‹éåŒæœŸå‡¦ç†ã¯ãƒ¡ãƒ¼ãƒ«ã¨ã‹ã€å¤–éƒ¨ã¨ã®APIé€£æºã¨ã‹ã€æ¯”è¼ƒçš„æ™‚é–“ã®ã‹ã‹ã‚‹å‡¦ç†ã§ç”¨ã„ã‚‰ã‚Œã¦ã„ã‚‹ã€‚
ã¨ã‚Šã‚ãˆãšç”»é¢ã‚’è¿”ã—ã€å¾…ãŸã›ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚

sidekiqã¯éåŒæœŸã‚¿ã‚¹ã‚¯ãƒ¯ãƒ¼ã‚«ãƒ¼ã€‚
[[id:48b99bce-05ce-49af-921d-1e321e5a4f8b][Redis]]ã¯ã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€‚

ãŸã¨ãˆã°Railsä¸Šã§ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚‹å‡¦ç†ãŒèµ°ã‚‹ã¨ãã€railsã¯ãã®ã‚¿ã‚¹ã‚¯ã‚’redisã«é€ã‚Šã€ä¿æŒã™ã‚‹(ã‚­ãƒ¥ãƒ¼ã™ã‚‹)ã€‚sidekiqã¯ã€ã‚­ãƒ¥ãƒ¼ã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã‚’é †æ¬¡å‡¦ç†ã—ã¦ã„ãã€‚
ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ã®[[id:48b99bce-05ce-49af-921d-1e321e5a4f8b][Redis]]ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ãƒ€ã‚¦ãƒ³ã—ã¦ã‚‚æœªå‡¦ç†ã®ã‚¸ãƒ§ãƒ–ã‚’å¤±ã‚ãªã„ã€‚
** preload, eager_load, includes
ã‚„ã‚„ã“ã—ã„ãŒãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’è€ƒãˆã‚‹ã†ãˆã§å¿…è¦ãªã®ã§ç†è§£ã—ã¦ãŠãã€‚

- [[https://tech.stmn.co.jp/entry/2020/11/30/145159][preloadã€eager_loadã€includesã®æŒ™å‹•ã‚’ç†è§£ã—ã¦ä½¿ã„åˆ†ã‘ã‚‹ - stmn tech blog]]

| ãƒ¡ã‚½ãƒƒãƒ‰   | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ã‚¯ã‚¨ãƒª     | ç”¨é€”                         |
|------------+------------+------------+------------------------------|
| joins      | ã—ãªã„     | å˜æ•°       | çµã‚Šè¾¼ã¿                     |
| eager_load | ã™ã‚‹       | å˜æ•°       | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨çµã‚Šè¾¼ã¿         |
| preload    | ã™ã‚‹       | è¤‡æ•°       | ã‚­ãƒ£ãƒƒã‚·ãƒ¥                   |
| includes   | ã™ã‚‹       | å ´åˆã«ã‚ˆã‚‹ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€å¿…è¦ãªã‚‰çµã‚Šè¾¼ã¿ |

#+begin_quote
ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã®JOINã‚’ç¦æ­¢ã—ãŸã„ã‚±ãƒ¼ã‚¹ã§ã¯preloadã‚’æŒ‡å®šã—ã€JOINã—ã¦ã‚‚å•é¡Œãªãã¦ã¨ã‚Šã‚ãˆãšeager loadingã—ãŸã„å ´åˆã¯includesã‚’ä½¿ã„ã€å¿…ãšJOINã—ãŸã„å ´åˆã¯eager_loadã‚’ä½¿ã„ã¾ã—ã‚‡ã†ã€‚
#+end_quote

- [[https://qiita.com/ryosuketter/items/097556841ec8e1b2940f][ActiveRecordã®includesã¯ä½¿ã‚ãšã«preloadã¨eager_loadã‚’ä½¿ã„åˆ†ã‘ã‚‹ç†ç”± - Qiita]]

| ãƒ¡ã‚½ãƒƒãƒ‰   | SQL(ã‚¯ã‚¨ãƒª)            | ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å…ˆã®ãƒ‡ãƒ¼ã‚¿å‚ç…§ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ                                                |
|------------+------------------------+------------+--------------------------------+-----------------------------------------------------------|
| joins      | INNER JOIN             | ã—ãªã„     | ã§ãã‚‹                         | N+1å•é¡Œ                                                   |
| preload    | JOINã›ãšãã‚Œãã‚ŒSELECT | ã™ã‚‹       | ã§ããªã„                       | INå¥å¤§ãããªã‚ŠãŒã¡                                        |
| eager_load | LEFT JOIN              | ã™ã‚‹       | ã§ãã‚‹                         | LEFT JOINãªã®ã§ã€ç›¸æ‰‹ãŒå­˜åœ¨ã—ãªãã¦ã‚‚å…¨éƒ¨ãƒ­ãƒ¼ãƒ‰ã—ã¦ã—ã¾ã† |
| includes   | å ´åˆã«ã‚ˆã‚‹             | ã™ã‚‹       | ã§ãã‚‹                         | ãŸã ã—ãç†è§£ã—ã¦ãªã„ã¨æŒ™å‹•ãŒã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã§ããªã„          |

- preload
  - å¤šå¯¾å¤šã®ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆ
    - [[id:8b69b8d4-1612-4dc5-8412-96b431fdd101][SQL]]ã‚’åˆ†å‰²ã—ã¦å–å¾—ã™ã‚‹ãŸã‚ã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¿ã‚¤ãƒ ãŒæ—©ããªã‚‹ãŸã‚
  - ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³å…ˆã®ãƒ‡ãƒ¼ã‚¿å‚ç…§ãŒã§ããªã„
  - ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤§ãã„ã¨ã€ãƒ¡ãƒ¢ãƒªã‚’åœ§è¿«ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹

- eager_load
  - 1å¯¾1ã‚ã‚‹ã„ã¯Nå¯¾1ã®ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã‚’JOINã™ã‚‹å ´åˆ
  - JOINå…ˆã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã—ãŸã„å ´åˆ

- joins
  - ãƒ¡ãƒ¢ãƒªã®ä½¿ç”¨é‡ã‚’å¿…è¦æœ€ä½é™ã«æŠ‘ãˆãŸã„å ´åˆ
  - JOINã—ãŸå…ˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å‚ç…§ã›ãšã€çµã‚Šè¾¼ã¿çµæœã ã‘ãŒå¿…è¦ãªå ´åˆ

- includes
  - ãªã‚‹ã¹ãä½¿ã‚ãªã„ã»ã†ãŒã„ã„
  - æ¡ä»¶ã«ã‚ˆã£ã¦preloadã¨eager_loadã‚’æŒ¯ã‚Šåˆ†ã‘ã‚‹

- [[https://qiita.com/k0kubun/items/80c5a5494f53bb88dc58][ActiveRecordã®joinsã¨preloadã¨includesã¨eager_loadã®é•ã„ - Qiita]]
** Railsã®[[id:bb71747d-8599-4aee-b747-13cb44c05773][OSS]]
Railsã‚’ã©ã†æ›¸ãã‹ã®å‚è€ƒã«ãªã‚Šãã†ãªãƒªãƒã‚¸ãƒˆãƒªã€‚

- [[https://github.com/gitlabhq/gitlabhq][gitlabhq/gitlabhq: GitLab CE Mirror | Please open new issues in our issue tracker on GitLab.com]]
- [[https://github.com/rubygems/rubygems.org][rubygems/rubygems.org: The Ruby community's gem hosting service.]]
- [[https://github.com/discourse/discourse][discourse/discourse: A platform for community discussion. Free, open, simple.]]
- [[https://github.com/mastodon/mastodon][mastodon/mastodon: Your self-hosted, globally interconnected microblogging community]]
- [[https://github.com/diaspora/diaspora][diaspora/diaspora: A privacy-aware, distributed, open source social network.]]
- [[https://github.com/forem/forem][forem/forem: For empowering community ğŸŒ±]]
** ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨åå‰ç©ºé–“ã‚’åˆ‡ã‚Šå‡ºã™
[[https://qiita.com/sibakenY/items/973fbe635a7f91ae105c][Railsã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’drawã‚’ä½¿ã£ã¦ã¾ã¨ã‚ã‚‹ - Qiita]]

ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®DSLã‚’è©•ä¾¡ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã‚‹ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã§åå‰ç©ºé–“ã‚’åˆ†å‰²ã§ãã‚‹ã€‚

#+caption: config/initializers/draw_routes.rb
#+begin_src ruby
module DrawRoute
  RoutesNotFound = Class.new(StandardError)

  def draw(routes_name)
    drawn_any = draw_route(routes_name)

    drawn_any || raise(RoutesNotFound, "Cannot find #{routes_name}")
  end

  def route_path(routes_name)
    Rails.root.join(routes_name)
  end

  def draw_route(routes_name)
    path = route_path("config/routes/#{routes_name}.rb")
    if File.exist?(path)
      instance_eval(File.read(path))
      true
    else
      false
    end
  end
end

ActionDispatch::Routing::Mapper.prepend DrawRoute
#+end_src

#+caption: config/routes/admin.rb
#+begin_src ruby
  namespace :admin do
    resources :users
  end
#+end_src

#+caption: routes.rb
#+begin_src ruby
  Rails.application.routes.draw do
    draw :admin
  end
#+end_src
** æ™‚é–“é–¢ä¿‚
[[https://qiita.com/jnchito/items/cae89ee43c30f5d6fa2c][Rubyã¨Railsã«ãŠã‘ã‚‹Time, Date, DateTime, TimeWithZoneã®é•ã„ - Qiita]]
** ãƒã‚¹ãƒˆã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
ãƒã‚¹ãƒˆã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯å†…å´ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒã€ç„¡è¦–ã•ã‚Œã‚‹ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã€‚
ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†åˆ©ç”¨ã™ã‚‹ãŸã‚ã€‚
ãªã®ã§ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†åˆ©ç”¨ã—ãªã„ã‚ˆã†ã«æ˜ç¤ºã™ã‚Œã°ã‚ˆã„ã€‚

#+begin_src ruby
ActiveRecord::Base.transaction(joinable: false, requires_new: true) do
  # inner code
end
#+end_src

[[https://qiita.com/jnchito/items/930575c18679a5dbe1a0][ã€ç¿»è¨³ã€‘ActiveRecordã«ãŠã‘ã‚‹ã€ãƒã‚¹ãƒˆã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®è½ã¨ã—ç©´ - Qiita]]
[[https://api.rubyonrails.org/classes/ActiveRecord/Transactions/ClassMethods.html][ActiveRecord::Transactions::ClassMethods]]
** Fakerã§booleanç”Ÿæˆ

â†“ä»¥ä¸‹2ã¤ã¯åŒã˜æ„å‘³ã€‚

#+caption: fakerã§
#+begin_src rb
  Faker::Boolean.boolean
#+end_src

#+caption: sampleã§
#+begin_src ruby
  [true, false].sample
#+end_src
** ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚«ãƒ©ãƒ ã®å‹ã‚’å¤‰ãˆã‚‹
usersã®deleted_atã‚«ãƒ©ãƒ ã‚’integerå‹ ã‹ã‚‰ datetimeå‹ã«å¤‰ãˆã‚‹ä¾‹ã€‚

1. ä¸€æ™‚ã‚«ãƒ©ãƒ ã‚’ä½œã£ã¦ãã“ã§å€¤ã‚’ä½œæˆã™ã‚‹
2. æ—§ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ã™ã‚‹
3. ä¸€æ™‚ã‚«ãƒ©ãƒ ã®åå‰ã‚’å¤‰ãˆã¦æ–°ã‚«ãƒ©ãƒ ã«ã™ã‚‹

~ActiveRecord::Base.connection.execute(sql)~ ã‚’ä½¿ã†ã¨ç”Ÿã®[[id:8b69b8d4-1612-4dc5-8412-96b431fdd101][SQL]]ã‚’å®Ÿè¡Œã§ãã‚‹ã€‚

#+caption:
#+begin_src ruby
  def up
    connection.execute 'ALTER TABLE users ADD deleted_at_tmp datetime'
    connection.execute 'UPDATE users SET deleted_at_tmp = FROM_UNIXTIME(deleted_at)'
    connection.execute 'ALTER TABLE users DROP COLUMN deleted_at'
    connection.execute 'ALTER TABLE users CHANGE deleted_at_tmp deleted_at datetime'
  end
#+end_src
** ä¾¿åˆ©ãªãƒ‡ãƒãƒƒã‚¬web-console
viewå†…ã§ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç«‹ã¡ä¸Šã’ã‚‹ã“ã¨ãŒã§ãã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã€‚
Railsã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å…¥ã£ã¦ã„ã‚‹ã€‚

#+caption: ä»»æ„ã®view, controllerã«è¿½åŠ ã™ã‚‹
#+begin_src html
<% console %>
#+end_src

ã‚ã¨ã¯è©²å½“ç®‡æ‰€ã«ãƒ–ãƒ©ã‚¦ã‚¶ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒç«‹ã¡ä¸ŠãŒã‚‹ã€‚
å†å®Ÿè¡Œæ€§ãŒãªã„ã®ã§ã€ãƒ†ã‚¹ãƒˆã§ã‚„ã‚‹ã®ãŒä¸€ç•ªã ã¨ã¯æ„Ÿã˜ã‚‹ã€‚
** update_atã‚’æ›´æ–°ã—ãªã„
CLOSED: [2023-01-08 Sun 09:41]
ãƒãƒƒãƒå‡¦ç†ã§ã„ã˜ã£ãŸå ´åˆã¯æ›´æ–°ã™ã‚‹ã¨ã‚ˆããªã„ã“ã¨ãŒã‚ã‚‹ã€‚

- [[https://ohbarye.hatenablog.jp/entry/2016/08/02/213444][æ›´æ–°æ™‚ã« updated_at, created_at ã‚’æ›´æ–°ã—ãªã„ - valid,invalid]]

#+begin_src ruby
# Active Record ãƒ¬ãƒ™ãƒ«
ActiveRecord::Base.record_timestamps = false

# ãƒ¢ãƒ‡ãƒ«ã®ã¿
User.record_timestamps = false

# ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ã¿
user.record_timestamps = false
#+end_src

** save(validate: false)
ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸è¦ãªã¨ãã€ ~user.save!(validate: false)~ ã¨ã™ã‚‹ã¨ç„¡åŠ¹åŒ–ã§ãã‚‹ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚’ä¸æ•´åˆã‚’ç›´ã—ãŸã„ã‘ã©ã»ã‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‹ã‹ã‚‹ã€ã‚ˆã†ãªã¨ãã«ä½¿ã†ã€‚

ã‚ã‚‹ã„ã¯ ~assign_attribute~ ã§ã‚‚ã‚ˆã„ã€‚
** presence: trueãªã®ã«nilãŒã‚ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œçŸ¥ã™ã‚‹
ãƒ¢ãƒ‡ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‹ã‹ã£ã¦ã„ã¦ã‚‚ã€æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯nilã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
ãƒ¢ãƒ‡ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯å…¥å‡ºåŠ›ã®ã¿ç›£è¦–ã™ã‚‹ã€‚ã ã‹ã‚‰æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã«æ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
ã“ã®å ´åˆã€ç·¨é›†ã§ããªãã¦ä¸ä¾¿ã€‚æ¤œçŸ¥ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚åˆ¶ç´„ã‚’ã‹ã‘ã‚‹ã¨å®‰å…¨ã«ãªã‚‹ã€‚DBãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã‚‚å…¥ã£ã¦ãªã„ã“ã¨ã‚’ä¿è¨¼ã§ãã‚‹ã€‚

ç›´ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ¶ç´„ã‚’è¾¿ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„ã®ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¢ç´¢ã™ã‚‹æ„Ÿã˜ã«ãªã£ãŸã€‚ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãŸãã•ã‚“ã‚ã‚‹ç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã¨æ¤œçŸ¥ã§ãã‚‹ã€‚å…¨éƒ¨è¾¿ã‚‹ã®ã§ã‚¯ã‚½é‡ã„ã€‚
#+begin_src ruby
  msgs = {}

  Rails.application.eager_load!
  ApplicationRecord.subclasses.each do |model|
    presence_validates = model.validators.select { |v| v.class.to_s.include?('ActiveRecord::Validations::PresenceValidator') }
    presence_validates.each do |presence_validate|
      model.all.find_each do |record|
        msgs["#{record.class} #{presence_validate.attributes.first}"] = 'âŒ presence: trueã‚ã‚‹ã®ã«nilãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹><' unless record.send(presence_validate.attributes.first)
      end
    end
  end

  pp msgs.sort #  [["User name", "âŒ presence: trueã‚ã‚‹ã®ã«nilãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹><"]]
#+end_src

ã¾ãšnilã‚’ãªãã™ã€‚ãã‚Œã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã€‚
** ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã„ã†ã¨ãã®æ­£ç¢ºãªã‚¹ã‚³ãƒ¼ãƒ—
APIã‚µãƒ¼ãƒã¨ã—ã¦ã®åˆ©ç”¨ã€ãƒãƒƒã‚¯ã¨ãƒ•ãƒ­ãƒ³ãƒˆã®åˆ†å‰²ãŒä¸»æµã«ãªã£ã¦ã„ã‚‹ã€‚
æ¡ç”¨è€…ãŒRailsã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºè€…ã‚’æ¢ã—ã¦ã„ã‚‹ã€ã¨ã„ã†ã¨ãã¯APIé–‹ç™ºçµŒé¨“ãŒã‚ã‚‹äººæã‚’æ¢ã—ã¦ã„ã‚‹ã¨ã„ãˆã‚‹ã€‚
** ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚¹ãƒãƒ¼ãƒˆãªç”»åƒç¢ºèª
system specã§ã‚¹ã‚¯ã‚·ãƒ§ã‚’ã¨ã£ã¦ç¢ºèªã™ã‚‹ã€‚
ã‚ã–ã‚ã–ç”¨æ„ã—ã¦ç¢ºèªã—ãªã„ã€‚

TDDã‚’å¾¹åº•ã—ã€ä¸€åˆ‡ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèªã›ãšã«ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’é–‹ç™ºã—ãŸã€ã¨ã„ã†å‰äººã‚‚ã„ã‚‹ã€‚
** ã‚ªãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‰ã™ã‚‹gem: zeitwerk
zeitwerkã¯ã‚ªãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‰ã™ã‚‹gemã€‚Rails 6ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚
Railsã§requireã—ãªãã¦ã„ã„ã®ã¯ã“ã‚Œã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ã‚‰ã€‚
[[https://github.com/fxn/zeitwerk][fxn/zeitwerk: Efficient and thread-safe code loader for Ruby]]
** ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç„¡è¦–ã§ãã‚‹reorder
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç„¡è¦–ã§ãã‚‹ã€‚

#+caption: updated_atã‚’ã‚½ãƒ¼ãƒˆã«ä½¿ã†
#+begin_src ruby
  User.order(:id).reorder(:updated_at)
#+end_src

** é–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ã®ç”¨æ„
é–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ã«ã¯ã„ãã¤ã‹ã®æ–¹æ³•ãŒã‚ã‚‹ã€‚

- seedãƒ‡ãƒ¼ã‚¿ã§ç”¨æ„ã™ã‚‹ã€‚æ¯å›å¿…è¦ãªã¨ãã«resetã—ã¦é–‹ç™ºã™ã‚‹
  - ã‚¯ãƒªãƒ¼ãƒ³ãªç’°å¢ƒã§å†ç¾æ€§ãŒé«˜ã„é–‹ç™ºã‚’è¡Œãˆã‚‹ã€‚
  - æ—©ã„

- æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã«è¿‘ã„ãƒ‡ãƒ¼ã‚¿ã§è¡Œã†
  - ãƒ‡ã‚¶ã‚¤ãƒ³ã‚„æ€§èƒ½ã®å•é¡Œã«æ°—ã¥ãã‚„ã™ã„
  - ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„
  - ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒæ¥½
  - æ•´åˆæ€§ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦
** ALTER TABLEã¯é‡ã„
ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œã‚‹ã®ã§é‡ã„ã€‚
bulk: trueã‚’ã¤ã‘ã‚‹ã¨ALTER TABLEã‚’ã¾ã¨ã‚ã‚‹ã®ã§é«˜é€Ÿã«ãªã‚‹ã€‚
#+begin_src ruby
  def up
    change_table :legal_engine_forms, bulk: true do |t|
      ...
    end
  end
#+end_src
** ãƒ†ãƒ¼ãƒ–ãƒ«åã«ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã‚’è¨­å®šã™ã‚‹
ç‰¹å®šã®æ©Ÿèƒ½ã«å¯¾ã—ã¦ã€é–¢ä¿‚ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¤‡æ•°ã¤ãã‚‹ã¨ãã€ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã®ã‚ˆã†ãªå½¢ã§ãƒ¢ãƒ‡ãƒ«åã‚„ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æ±ºã‚ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
admin_userã€admin_pageã€admin_permissionã¨ã‹ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã®å•é¡Œç‚¹: è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã«modelåã¨ãƒ†ãƒ¼ãƒ–ãƒ«åãŒé•·ããªã‚‹ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚è¦‹ã«ãããªã‚‹ã€‚ä¸€èªã ã¨ã¾ã ã„ã„ã®ã ãŒã€è¤‡æ•°åã«ãªã‚‹ã¨ã¤ã‚‰ããªã‚‹ã€‚

è§£æ±ºã®ãŸã‚ã«ã¯ã€moduleã‚’å®šç¾©ã—ã€å†…éƒ¨ã§table_name_prefixã‚’è¨­å®šã™ã‚‹ã¨ã„ã„ã€‚

#+caption: modelã«ã¦
#+begin_src ruby
  module Admin
    def self.table_name_prefix
      'admin_'
    end
  end

  module Admin
    class User < ApplicationRecord
    end
  end
#+end_src

ã“ã†ã™ã‚‹ã¨ãƒ¢ãƒ‡ãƒ«åã¯Admin::Userã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«åã¯admin_usersã«ãªã‚Šã‚ã‹ã‚Šã‚„ã™ã„ã€‚
** Railsç’°å¢ƒã§ãƒãƒƒãƒå‡¦ç†ã™ã‚‹
#+caption: Railsç’°å¢ƒã§ã®ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè¡Œã§ãã‚‹
#+begin_src ruby
  rails runner "User.first"
  rails r "User.first"
#+end_src

ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹åŒ–ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«ä½¿ãˆã‚‹ã€‚
** routesã®åˆ¶ç´„
#+begin_src ruby
constraints(-> (req) { req.env["HTTP_USER_AGENT"] =~ /iPhone/ }) do
  resources :iphones
end
#+end_src

[[https://api.rubyonrails.org/v6.0.2/classes/ActionDispatch/Routing/Mapper/Scoping.html#method-i-constraints-label-Dynamic+request+matching][ActionDispatch::Routing::Mapper::Scoping]]
** å¤§é‡ã®routeså¤‰æ›´ã‚’æ¥½ã«ç¢ºèªã™ã‚‹
redirectè¨­å®šã‚„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§routesã‚’å¤§é‡ã«å¤‰æ›´ã—ã¦ã€æŒ™å‹•ã®å¤‰æ›´ã‚’è¿½ã„ãŸã„å ´åˆã€‚
rails routesã®çµæœã®diffã‚’å–ã‚Œã°ã€æ¥½ã«ç¢ºèªã§ãã‚‹ã€‚
** create_or_find_by
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ä½¿ã£ã¦ä½œæˆã€ã§ããªã‘ã‚Œã°åˆã‚ã®1ä»¶ã‚’å–å¾—ã™ã‚‹ã€‚
find_or_create_byã§ã¯ä½œæˆã•ã‚Œã‚‹ã¾ã§ã«åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã£ãŸã®ã§ã€ãã®å•é¡Œã‚’è§£æ±ºã—ãŸå‡¦ç†ã€‚
~create_or_find_by!~ ã¯ã‚¨ãƒ©ãƒ¼ã®æ™‚ã«ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã€‚

#+caption: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ä½¿ã£ã¦ä½œæˆã€ã§ããªã‘ã‚Œã°åˆã‚ã®1ä»¶ã‚’å–å¾—
#+begin_src ruby
  User.create_or_find_by(name: 'aaa')
#+end_src

[[https://railsdoc.com/page/create_or_find_by][create_or_find_by | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]]
** ä½¿ã‚ã‚Œã¦ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã™ã‚‹
assetsã¯ç›¸å¯¾ãƒ‘ã‚¹ãŒåˆ©ç”¨ã•ã‚Œãªã„ã®ã§çµ¶å¯¾ãƒ‘ã‚¹ã§æ¤œç´¢ã—ã¦ãƒ’ãƒƒãƒˆã—ãªã‘ã‚Œã°æœªä½¿ç”¨ã¨åˆ¤æ–­ã§ãã‚‹ã€ã¨ã®ã“ã¨ã€‚
#+caption: æ¤œæŸ»ã‚¿ã‚¹ã‚¯ã®ä¾‹
#+begin_src ruby
namespace :assets do
  desc 'prune needless image file'
  task 'prune:images' => :environment do
    base = Rails.root.join('app/assets/images/')

    Dir[Rails.root.join('app/assets/images/**/*.{jpg,jpeg,gif,png,svg}')].each do |path|
      target_path = path.to_s.gsub(/#{base}/, '')
      puts "execute: git grep '#{target_path}'"
      res = `git grep '#{target_path}'`

      if res.empty?
        puts "execute: rm #{path}"
        FileUtils.rm path
        puts '=> removed'
      else
        puts '=> used somewhere'
      end

      puts
    end
  end
end
#+end_src
** [[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]]ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
è¶…å¼·ã„äººãŒè¨€ã£ã¦ã„ãŸãƒ¡ãƒ¢ã€‚
ã‚³ãƒãƒ³ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã¦ä¸€æ°—ã«ç½®æ›ã—ã¦æ¤œè¨ã—ã¦ã„ãã€‚
#+caption: 2.6.5 -> 2.7.1ã«å…¨ä½“ã‚’ç½®æ›ã™ã‚‹
#+begin_src shell
git grep -l '2\.6\.5' | xargs sed -i 's/2\.6\.5/2.7.1/g'
#+end_src
vendor/bundle ã‚’å‰Šé™¤ã—ã¦ã€bundle installã€‚
ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ .rubocop.yml ã® RUBY_VERSION ã‚’ä¿®æ­£(parser gemã®æŒ‡å®š)ã€‚
** æ–°è¦ä½œæˆæ™‚ã¯formè¡¨ç¤ºã—ãªã„
formã‚’å…±é€šåŒ–ã—ã¦ã„ã‚‹ã‚ˆã†ãªã¨ãã€‚
ã“ã®ã‚«ãƒ©ãƒ ã¯editæ™‚ã®ã¿å‡ºã—ãŸã„ã€ã¨ã„ã†ã‚ˆã†ãªã“ã¨ãŒã‚ã‚‹ã€‚
#+caption: newæ™‚persistã•ã‚Œã¦ãªã„ã®ã§è¡¨ç¤ºã•ã‚Œãªã„
#+begin_src ruby
  form_for do |f|
    f.number_field :position if @content_category.persisted?
  end
#+end_src
** ä¸€éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã ã‘validation
#+caption: onã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã€‚
#+begin_src ruby
validates :user_id, presence: true, :on => :create
#+end_src
** ä¾¿åˆ©ãªæ—¥ä»˜æ“ä½œ
#+caption: Time.zone
#+begin_src ruby
Time.zone.yesterday
Time.zone.today.ago(7.days)
#+end_src

[[https://qiita.com/mmmm/items/efda48f1ac0267c95c29][Railsã§ã®æ—¥ä»˜æ“ä½œã§ã‚ˆãä½¿ã†ã‚‚ã®ã¾ã¨ã‚ - Qiita]]
** å®‰å…¨ã«é–¢é€£ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹
Blogã«user_idã‚’å¾Œã‹ã‚‰è¿½åŠ ã—ãŸã„ã€ã¿ãŸã„ãªã¨ãã€‚User -< Blogã€‚
æœ€åˆã«nullableã§å¤–éƒ¨ã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹ã€‚

æ¬¡ã«ã€æ–°è¦ä½œæˆæ™‚ã«modelã§validationã‚’ã‹ã‘ã‚‹ã€‚
ã™ã‚‹ã¨æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å¤–éƒ¨ã‚­ãƒ¼ã¯nullã€æ–°ã—ãã§ãã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯å¤–éƒ¨ã‚­ãƒ¼ã‚ã‚Šã¨ã„ã†çŠ¶æ…‹ã«ãªã‚‹ã€‚
å¤–éƒ¨ã‚­ãƒ¼ãªã—ãŒå¢—ãˆã‚‹ã“ã¨ã¯ãªã„ã€‚ç§»è¡Œã‚’ã™ã‚‹ã€‚
nullã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚¼ãƒ­ã«ãªã£ã¦ã‹ã‚‰å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ã¤ã‘ã¦é–¢é€£ã‚«ãƒ©ãƒ è¿½åŠ å®Œäº†ã€‚
** é–¢é€£ã‚«ãƒ©ãƒ ã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹
ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã™ã§ã«å…¥ã£ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢é€£ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€‚
ãŸã¨ãˆã°ã€blogs >- somethings >- users ã‚’ blogs >- users ã¨ã„ã†ã‚ˆã†ãªã€‚somethingsãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä½•ã‚‚ã—ã¦ãªã„ã®ã§å‰Šé™¤ã—ãŸã„ã€ã¨ã™ã‚‹ã€‚
ä½•ã‚‚è€ƒãˆãšã«ã‚„ã‚‹ã¨ã€ä¸€æ°—ã«ã™ã¹ã¦ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã«ãªã‚ŠãŒã¡ã€‚

æ‚ªã„ä¾‹ã‚’ç¤ºã™ã€‚
1. æœ€åˆã«é–¢é€£ã‚«ãƒ©ãƒ ã‚’å¤‰æ›´ã™ã‚‹ã€‚
  #+caption: modelãƒ•ã‚¡ã‚¤ãƒ«ã§é–¢é€£å¤‰æ›´
  #+begin_src ruby
   belongs_to :user # æ—§ belongs_to :something
  #+end_src
2. æ—§é–¢é€£ã‚’ä½¿ã£ã¦ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã‚’ã™ã¹ã¦å¤‰æ›´ã™ã‚‹ã€‚MVCã™ã¹ã¦ã€‚
3. æ–°ã—ã„é–¢é€£ã‚«ãƒ©ãƒ ã¯ç©ºã§ã€æ—§ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã—ãªã„ã¨ã„ã‘ãªã„ã€‚ç§»è¡Œã¯â†‘ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨åŒæ™‚ã«ã—ãªã„ã¨ä¸æ•´åˆã«ãªã‚‹ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®é–“ã®å¤‰æ›´ã¯ç„¡è¦–ã•ã‚Œã‚‹ã‹ã‚‰ã€‚
4. 1~3ã‚’ã¾ã¨ã‚ã¦ä¸€æ°—ã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹

ã¨ã„ã†ã“ã¨ã§ã€å¤§é‡ãªè¤‡æ•°å±¤ã®å¤‰æ›´ã‚’ã¶ã£ã¤ã‘æœ¬ç•ªã§ã—ãªã„ã¨ã„ã‘ãªããªã‚‹ã€‚é€”ä¸­ã§å«Œã«ãªã‚‹ã ã‚ã†ã—ã€é‹ãŒæ‚ªã‘ã‚Œã°ãƒŸã‚¹ã£ã¦å¤§å¤‰ãªã“ã¨ã«ãªã‚‹ã€‚

ã§ã¯ã©ã†ã™ã‚‹ã‹ã€‚æ ¹æœ¬çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã€2ã¤ã®é–¢é€£ã‚’åŒæ™‚ã«ä¿æŒã—ã¦ãŠãã“ã¨ã ã€‚
åŒæ™‚ã«æŒã£ã¦ãŠã‘ã°ã€å¤§ä¸ˆå¤«ãªã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é–¢é€£ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ã„ã„ã€‚ãã†ã‚„ã£ã¦é…å»¶ã•ã›ã‚‹ã“ã¨ã§ã€ä¸€æ°—ã«ã„ã‚ã„ã‚ãªå¤‰æ›´ã‚’ã—ãªãã¦ã‚ˆããªã‚‹ã€‚

å…·ä½“çš„ã«ã©ã†ã‚„ã‚‹ã‹ã€‚è‰¯ã„ä¾‹ã€‚
#+caption: modelã®before_saveã§ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã‚³ãƒ”ãƒ¼
#+begin_src ruby
  class Blog < ApplicationRecord
    before_save do
      self.user_id ||= something.user_id
    end
  end
#+end_src

ã¨ã—ã¦ãŠãã¨ã€ä¿å­˜æ™‚ã«blog.user_idã¨blog.something.user_idã®ä¸¡æ–¹ã«é–¢é€£ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã€‚somethingsã‚’çµŒç”±ã—ãªã„ã§ã‚ˆããªã‚‹ã€‚

æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã‚‚å‡¦ç†ã‚’è¿½åŠ ã—ã¦ãŠãã€‚
#+caption: modelã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã£ã¦ãŠã
#+begin_src ruby
  class User < ApplicationRecord
    def migrate
      self.user_id ||= something.user_id
      save!
    end
  end
#+end_src
ãã—ã¦ã€å…¨Userã§migrateã‚’å®Ÿè¡Œã™ã‚Œã°æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã‚‚æ–°ã—ã„ã‚«ãƒ©ãƒ ãŒå…¥ã‚‹ã€‚

æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨æ–°ã—ãä½œæˆã•ã‚Œã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãŠã•ãˆãŸã®ã§ã€æ–°æ—§2ã¤ã®é–¢é€£ã‚«ãƒ©ãƒ ã¯å®Œå…¨ã«åŒç­‰ã«ãªã‚‹ã€‚
ã“ã“ã¾ã§ã§ãƒãƒ¼ã‚¸ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã€‚
å•é¡Œãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã‚ã¨ã§ã€æ–°æ—§ã‚«ãƒ©ãƒ ãŒä½¿ãˆã‚‹çŠ¶æ…‹ã‚’æ´»ã‹ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å¤‰æ›´â€¦å®Ÿéš›ã®é–¢é€£ã®å¤‰æ›´ã‚’ã‚„ã‚‹(ä¸€ç•ªã®ç›®çš„ã®ç®‡æ‰€)ã€‚
ã“ã“ã¾ã§ã§ãƒãƒ¼ã‚¸ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã€‚

ãã®å¾Œã€ç§»è¡Œå‡¦ç†ã¨ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ã—ã¦ç‰‡ä»˜ã‘ã‚Œã°å®Œäº†ã€‚(ã‚ã‚‹ã„ã¯ç§»è¡Œå‡¦ç†ã¯å‰ã®æ™‚ç‚¹ã§æ¶ˆã™)
é–¢é€£ã‚«ãƒ©ãƒ ã ã‘ã§ãªãã€ä½•ã‹ã‚«ãƒ©ãƒ ã‚’ç§»ã™ã¨ãã«ã¯ã™ã¹ã¦åŒæ§˜ã«ã§ãã‚‹ã€‚

å®Ÿéš›ã®ã‚¿ã‚¹ã‚¯ã§ã¯ã€migrationå‡¦ç†ã‚’ã™ã‚‹ç®‡æ‰€ã¯è¤‡æ•°ã«ãªã‚‹ã®ã§å‰ã‚‚ã£ã¦èª¿æŸ»ãŒå¿…è¦ã€‚
** ã‚«ãƒ©ãƒ åã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹
ã‚«ãƒ©ãƒ åå¤‰æ›´ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å¤‰æ›´ã‚’åˆ†ã‘ã€å¤‰æ›´ç¯„å›²ã‚’ç‹­ã‚ã‚‹ã€‚
alias_attributeã‚’è¿½åŠ ã™ã‚‹ã€‚ã™ã‚‹ã¨ã€æ–°ã—ã„ã‚«ãƒ©ãƒ åã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ä¾å­˜ã—ã¦ã„ã‚‹ã»ã‹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’ã™ã‚‹(new_user_idã«æ›¸ãæ›ãˆã‚‹)ã€‚
#+caption: modelãƒ•ã‚¡ã‚¤ãƒ«ã«ã¦ã€è¿½åŠ 
#+begin_src ruby
alias_attribute :new_user_id, :typo_user_id
#+end_src

ãã‚Œã‚‰ã‚’æ›¸ãæ›ãˆãŸã‚‰ãƒãƒ¼ã‚¸ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã€‚
ãã®å¾Œã€ã‚«ãƒ©ãƒ åã‚’æ›¸ãæ›ãˆã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚ä½¿ã£ã¦ã„ã‚‹ç®‡æ‰€ã¯ãªã„ã®ã§å®‰å…¨ã«å¤‰æ›´ã§ãã‚‹ã€‚
ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã€alias_attributeã‚’å‰Šé™¤ã™ã‚‹ã€‚
** ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹
æœ€åˆã«model ã‚¯ãƒ©ã‚¹åã‚’å¤‰æ›´ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‚ç…§å…ˆã«å¤‰æ›´å‰ã®ã‚‚ã®ã‚’è¨­å®šã™ã‚‹ã€‚
#+begin_src ruby
  class Blog_After < ApplicationRecord
    self.table_name = :blog_before
  end
#+end_src
ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã ã‘ã®å¤‰æ›´ã§ã€DBã®å¤‰æ›´ã¯ãªã„çŠ¶æ…‹ã§å‹•ä½œä¸Šã®å¤‰æ›´ã¯ãªããªã‚‹ã€‚
æ¬¡ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã€ã»ã‹ã®ä¾å­˜ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’ä¿®æ­£ã™ã‚‹ã€‚
ã“ã“ã¾ã§1ã¤ã®PRã«ã™ã‚‹ã€‚

ãƒ†ã‚¹ãƒˆãŒé€šã£ãŸã‚Šãƒªãƒªãƒ¼ã‚¹ã§ããŸã‚‰ã€ãƒ†ãƒ¼ãƒ–ãƒ«åå¤‰æ›´ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€modelã§ã®table_nameè¨­å®šã‚’å‰Šé™¤ã™ã‚‹PRã‚’ã¤ãã‚‹ã€‚
å®‰å…¨ã«å¤‰æ›´ãŒå®Œäº†ã™ã‚‹ã€‚
ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’åŒæ™‚ã«ã‚„ã‚‰ãªã„ã¨å®‰å…¨ã ã—åˆ†å‰²ã§ãã¦ã™ã£ãã‚Šã™ã‚‹ã€‚
** modelã®ãƒ­ã‚°ã‚’ä¿æŒã™ã‚‹
[[https://github.com/paper-trail-gem/paper_trail][paper-trail-gem/paper_trail: Track changes to your rails models]]
å¤‰æ›´ã‚„å·®åˆ†ã€å¤‰æ›´æ™‚ã®ä½•ã‚‰ã‹ã®æƒ…å ±(ã¤ã¾ã‚Šã€ä½œæ¥­è€…ã¨ã‹)ã‚’ä¿å­˜ã€é–²è¦§ã§ãã‚‹ã€‚

[[https://github.com/ankit1910/paper_trail-globalid][ankit1910/paper_trail-globalid: An extension to paper_trail, using this you can fetch actual object who was responsible for this change]]
paper_trailã®æ‹¡å¼µã€‚å¤‰æ›´ã—ãŸã‹å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
** ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚­ãƒ¼
Railsã§ã„ã†ã¨ã“ã‚ã® ~id~ ã®ã“ã¨ã€‚Rails5 ã‹ã‚‰ã¯bigintã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚
ä¸»ã‚­ãƒ¼ã¨ã—ã¦ä½¿ã†äººå·¥çš„ãªå€¤ã€ã¨ã„ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆã€‚

[[https://e-words.jp/w/%E3%82%B5%E3%83%AD%E3%82%B2%E3%83%BC%E3%83%88%E3%82%AD%E3%83%BC.html][ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚­ãƒ¼ï¼ˆsurrogate keyï¼‰ã¨ã¯ - ITç”¨èªè¾å…¸ e-Words]]
#+begin_quote
ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚­ãƒ¼ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼ã¨ã—ã¦ã€è‡ªå‹•å‰²ã‚Šå½“ã¦ã®é€£ç¶šã—ãŸé€šã—ç•ªå·ã®ã‚ˆã†ã«ã€åˆ©ç”¨è€…ã‚„è¨˜éŒ²ã™ã‚‹å¯¾è±¡ã¨ã¯ç›´æ¥é–¢ä¿‚ã®ãªã„äººå·¥çš„ãªå€¤ã‚’ç”¨ã„ã‚‹ã“ã¨ã€‚ã¾ãŸã€ãã®ãŸã‚ã«è¨­ã‘ã‚‰ã‚ŒãŸã‚«ãƒ©ãƒ ã®ã“ã¨ã€‚
#+end_quote
** ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ããªã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹
ãŸã„ã¦ã„ã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ããªã„ãªã©ã¨æ›¸ã‘ã°ã‚ˆã„ãŒã€rollbackãŒç ´å£Šçš„ãªå‹•ä½œã«ãªã‚‹å ´åˆãŒã‚ã‚‹ã®ã§downã«æ›¸ãã€‚
#+caption: ActiveRecord::IrreversibleMigration
#+begin_src ruby
  def down
    raise ActiveRecord::IrreversibleMigration
  end
#+end_src
** nullåˆ¶ç´„ã‚’è¿½åŠ ã—ã¤ã¤defaultè¨­å®š
[[https://qiita.com/akinov/items/852fe789fe98a44350a9][Railsã®migrationã§å¾Œã‹ã‚‰NULLåˆ¶ç´„ã‚’è¨­å®šã™ã‚‹ - Qiita]]

nullåˆ¶ç´„è¿½åŠ ã«ã¯ã€ ~change_column_null~ ã‚’ä½¿ã†ã€‚
nullåˆ¶ç´„ã ã‘è¿½åŠ ã™ã‚‹ã¨å¤‰æ›´å‰ã«nullã ã£ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€åŒæ™‚ã«defaultã‚’è¨­å®šã™ã‚‹ã¨ã‚ˆã„ã€‚

#+caption: nullåˆ¶ç´„ + defaultè¨­å®š
#+begin_src ruby
class ChangePointColumnOnPost < ActiveRecord::Migration[5.2]
  def change
    change_column_null :posts, :point, false, 0
    change_column_default :posts, :point, from: nil, to: 0
  end
end
#+end_src

#+caption: â†‘falseã¯nullã‚ªãƒ—ã‚·ãƒ§ãƒ³
#+begin_src ruby
  change_column_null(table_name, column_name, null, default = nil)
#+end_src
** migrationãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ä¸æ•´åˆè§£æ¶ˆã‚¿ã‚¹ã‚¯
migrationãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸€éƒ¨DSLãŒæ‰±ã‚ã‚Œã‚‹ã ã‘ã§æ™®é€šã®rubyãƒ•ã‚¡ã‚¤ãƒ«ã¨å¤‰ã‚ã‚‰ãªã„ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸æ•´åˆã‚’è§£æ¶ˆã™ã‚‹ã“ã¨ã«ã‚‚ä½¿ãˆã‚‹ã€‚

#+caption:
#+begin_src ruby
  def up
    Blog.unscoped.where(user_id: nil).delete_all
  end
#+end_src
ã¨ã„ã†ã‚ˆã†ã«ã€‚
ç’°å¢ƒåˆ¥ã«consoleã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒãªã„ã®ã§ä¾¿åˆ©ã€‚
** unscopedã§default_scopeã‚’ç„¡åŠ¹åŒ–
~unscoped~ ã¯default_scopeã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚
[[https://apidock.com/rails/ActiveRecord/Base/unscoped/class][unscoped (ActiveRecord::Base) - APIdock]]

#+caption: è‡ªå‹•ã§publishedã®æ¡ä»¶ãŒç™ºè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹
#+begin_src ruby
  class Post < ActiveRecord::Base
    def self.default_scope
      where :published => true
    end
  end

  Post.all          # Fires "SELECT * FROM posts WHERE published = true"
  Post.unscoped.all # Fires "SELECT * FROM posts"
#+end_src

#+caption: default_scopeã®æ¡ä»¶ãŒãªããªã‚‹
#+begin_src ruby
  Post.unscoped {
    Post.limit(10) # Fires "SELECT * FROM posts LIMIT 10"
  }
#+end_src
** inverse_ofã§åŒæ–¹å‘ã®ä¸æ•´åˆã‚’é˜²ã
[[https://qiita.com/itp926/items/9cac175d3b35945b8f7e][inverse_of ã«ã¤ã„ã¦ - Qiita]]

åŒæ–¹å‘ã®é–¢é€£ä»˜ã‘ã®ä¸æ•´åˆã‚’é˜²ãé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚belongs_to, has_manyç­‰ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ªãƒ³ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã€‚

#+caption:
#+begin_src ruby
  class Category
    has_many :blog
  end

  class Order
    belongs_to :category
  end
#+end_src

#+caption: ä¸æ•´åˆ
#+begin_src ruby
  c = Category.first
  b = c.orders.first

  c.title = "change"
  c.title == b.category.title #=> false å€¤ã¯ç•°ãªã‚‹
  c.equal? b.category #=> false åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãªã„
#+end_src
inverse_ofã‚’ä½¿ã†ã¨åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã†ã‚ˆã†ã«ãªã‚‹ã€‚
** ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸æ•´åˆã‚’æ¤œçŸ¥ã™ã‚‹
ã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚
å…¨éƒ¨è¾¿ã‚‹æ–¹æ³•ã¯è‰²ã€…å¿œç”¨ãŒåŠ¹ããã†ã€‚

#+caption: ä¸æ•´åˆæ¤œçŸ¥ã‚¿ã‚¹ã‚¯
#+begin_src ruby
desc 'å¤–éƒ¨ã‚­ãƒ¼ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹'
task extract_mismatch_records: :environment do
  Rails.application.eager_load!

  ApplicationRecord.subclasses.each do |model|
    model.reflections.select { |_, reflection| reflection.is_a?(ActiveRecord::Reflection::BelongsToReflection) }.each do |name, reflection|
      model_name = model.model_name.human
      foreign_key = reflection.options[:foreign_key] || "#{name}_id"

      unless model.columns.any? { |column| column.name == foreign_key.to_s }
        puts "ğŸ’¢ #{model_name} ã«ã¯ #{foreign_key} ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“"
        next
      end

      parent_model_class_name = reflection.options[:class_name] || reflection.name.to_s.classify
      parent_model = parent_model_class_name.safe_constantize

      unless parent_model
        puts "ğŸ’¢ #{model_name} ãŒä¾å­˜ã—ã¦ã„ã‚‹ #{parent_model_class_name} ã¯å‚ç…§ã§ãã¾ã›ã‚“"
        next
      end

      parent_model_name = parent_model.model_name.human

      begin
        # NOTE: è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã®IDã¨ã—ã¦å­˜åœ¨ã—ãªã„å¤–éƒ¨ã‚­ãƒ¼ã®æ•°ã‚’ç…§ä¼š
        relation = model.unscoped.where.not(foreign_key => parent_model.unscoped.select(:id)).where.not(foreign_key => nil)
        sql = relation.to_sql
        count = relation.count

        if count.zero?
          puts "ğŸ’¡ #{model_name} ã® #{parent_model_name} ã®å¤–éƒ¨ã‚­ãƒ¼ã¯æ•´åˆæ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ã¾ã™" unless ENV['ONLY_FAILURE']
        else
          puts "ğŸ’£ #{model_name} ã® #{parent_model_name} ã®å¤–éƒ¨ã‚­ãƒ¼ã§ä¸æ­£ãªã‚­ãƒ¼ãŒ #{count} ä»¶ è¨­å®šã•ã‚Œã¦ã„ã¾ã™"
        end

        if ENV['DEBUG']
          puts "=> #{sql}\n"
          puts
        end
      rescue StandardError
        # NOTE: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        puts "ğŸˆ³ #{model_name} ã® #{parent_model_name} ã®æ•´åˆæ€§ã®æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ" unless ENV['ONLY_FAILURE']
      end
    end
  end
end
#+end_src

Reflectionã‚¯ãƒ©ã‚¹ã¯ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³é–¢ä¿‚ã®moduleã®ã‚ˆã†ã€‚
https://github.com/kd-collective/rails/blob/f132be462b957ea4cd8b72bf9e7be77a184a887b/activerecord/lib/active_record/reflection.rb#L49

#+begin_quote
Reflection enables the ability to examine the associations and aggregations of Active Record classes and objects. This information, for example, can be used in a form builder that takes an Active Record object and creates input fields for all of the attributes depending on their type and displays the associations to other objects.

Reflectionã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Active Recordã®ã‚¯ãƒ©ã‚¹ã‚„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é–¢é€£ä»˜ã‘ã‚„é›†è¨ˆã‚’èª¿ã¹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æƒ…å ±ã¯ã€ä¾‹ãˆã°ã€Active Recordã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã€ãã®å‹ã«å¿œã˜ã¦ã™ã¹ã¦ã®å±æ€§ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã®é–¢é€£ã‚’è¡¨ç¤ºã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ã§ä½¿ç”¨ã§ãã¾ã™ã€‚
#+end_quote

Reflectionã«é–¢ã™ã‚‹è¨˜äº‹ã€‚
[[https://qiita.com/kkyouhei/items/067d5bb8d79c71f1646b][Railsã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ - Qiita]]
** ã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–
ãƒã‚¹ãƒˆã—ã¦ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã—ã¦ã‚‹ã¨ãã¯ä½•ã‹ãŒãŠã‹ã—ã„ã€‚

- parent_category -> category -> blog ã®ã‚ˆã†ãªæ§‹é€ 

#+caption: ã²ã©ã„ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰
#+begin_src ruby
  parent_categories.each do |parent_category|
    parent_category.categories.each do |category|
      category.blogs.each do |blog|
        @content << blog.content
      end
    end
  end
#+end_src

- parent_category -> category -> blog

#+caption: joins
#+begin_src ruby
  Blog.joins(categories: category)
    .merge(Category.where(parent_category: parent_large_categories))
#+end_src
** Migrationãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦é«˜é€ŸåŒ–ã™ã‚‹
Migrationãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤‰æ›´ã—ãªã„ã®ãŒåŸºæœ¬ã ãŒã€æ•°ãŒå¤šã„å ´åˆã€ ~rails migrate:reset~ ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚

db/schema.rbã®å†…å®¹ã‚’ã€æœ€æ–°ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚

- ã¤ã¾ã‚Šç¾åœ¨ã®DBçŠ¶æ³ãŒã€ãã®ã¾ã¾1ã¤ã®migrationã¨ãªã‚‹ã€‚DSLãŒåŒã˜ãªã®ã§å•é¡Œãªã„ã€‚
- migrationã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯ã™ã§ã«å®Ÿè¡Œæ¸ˆã¿ã®ãŸã‚ã€å‹•ä½œã«å½±éŸ¿ã—ãªã„ã€‚
** Gemfileã§ç’°å¢ƒæŒ‡å®šã™ã‚‹
Gemfileã®groupã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€æŒ‡å®šç’°å¢ƒã§ã—ã‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªã„ã“ã¨ã‚’ç¤ºã™ã€‚

#+caption: developmentã§ã—ã‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œãªã„
#+begin_src ruby
  group :development do
    gem 'annotate', require: false
  end
#+end_src

ãªã®ã§ç’°å¢ƒã‚’æŒ‡å®šã›ãšã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸã¨ãã€gem not foundãŒå‡ºã‚‹ã€‚å®Ÿè¡Œã•ã‚ŒãŸã®ãŒdevelopmentç’°å¢ƒã§ã€ãƒ†ã‚¹ãƒˆã®gemãŒèª­ã¿è¾¼ã¾ã‚Œã¦ãªã„ã‹ã‚‰ã€‚ ~RAILS_ENV=test~ ãŒã¤ã„ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚
** è«–ç†å‰Šé™¤ã¨ç‰©ç†å‰Šé™¤
è«–ç†å‰Šé™¤ã¯å‰Šé™¤ã—ãŸã¨ããƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ã®ã§ã¯ãªãã€ãƒ•ãƒ©ã‚°ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ã‚‚ã®ã€‚
é€†ã«ç‰©ç†å‰Šé™¤ã¯ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‰Šé™¤ã™ã‚‹ã“ã¨ã€‚

è«–ç†å‰Šé™¤ã®ãƒ¡ãƒªãƒƒãƒˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒæˆ»ã›ã‚‹ã“ã¨ã€‚

ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é‹ç”¨çš„ã«ã€å¾Œã‹ã‚‰å•é¡Œã¨ãªã‚‹ã“ã¨ã®æ–¹ãŒå¤šã„ã€‚

- å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘å¿˜ã‚Œã‚‹ã¨äº‹æ•…ã«ãªã‚‹ã€‚å‰Šé™¤ã—ãŸã¯ãšãªã®ã«è¡¨ç¤ºã—ãŸã‚Šã€è¨ˆç®—ã«å…¥ã‚ŒãŸã‚Šã—ã¦ã—ã¾ã†
- ãƒ‡ãƒ¼ã‚¿ãŒå¤šããªã‚‹ãŸã‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªããªã‚‹

Railsã§ã¯gem act_as_paranoidã‚’ä½¿ã£ã¦ç°¡å˜ã«è«–ç†å‰Šé™¤å‡¦ç†ã‚’è¿½åŠ ã§ãã‚‹ã€‚deleted_atã‚«ãƒ©ãƒ ã‚’è«–ç†å‰Šé™¤ã‚’ç®¡ç†ã™ã‚‹ãƒ•ãƒ©ã‚°ã¨ã—ã¦ç”¨ã„ã‚‹ã€‚
** findã€find_byã€whereã®é•ã„
[[https://qiita.com/tsuchinoko_run/items/f3926caaec461cfa1ca3][findã€find_byã€whereã®é•ã„ - Qiita]]

- find :: å„ãƒ¢ãƒ‡ãƒ«ã®idã‚’æ¤œç´¢ã‚­ãƒ¼ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€‚ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¿”ã‚‹
- find_by :: idä»¥å¤–ã‚’ã‚­ãƒ¼ã¨ã—ã¦æ¤œç´¢ã€‚è¤‡æ•°ã‚ã£ãŸå ´åˆã¯æœ€åˆã ã‘å–ã‚‹ã€‚ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¿”ã‚‹ã€‚
- where :: idä»¥å¤–ã‚’ã‚­ãƒ¼ã¨ã—ã¦æ¤œç´¢ã€‚ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å…¥ã£ãŸé…åˆ—ãŒè¿”ã‚‹ã€‚
** acts_as_list
acts_as_listã¯é †ç•ªã‚’ç®¡ç†ã™ã‚‹gemã€‚
[[https://github.com/brendon/acts_as_list][brendon/acts_as_list: An ActiveRecord plugin for managing lists.]]

é †ç•ªã®ç”Ÿæˆã¨ã€æ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹ã€‚
modelã«é †ç•ªã‚«ãƒ©ãƒ ã‚’æŒ‡å®šã™ã‚‹ã¨ã€createæ™‚ã«è‡ªå‹•ã§ç•ªå·ãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚
é€†ã«ãƒ•ã‚©ãƒ¼ãƒ ã§ç•ªå·æ ¼ç´ã—ã¦ã„ã‚‹ã¨ãã‚ŒãŒå„ªå…ˆã—ã¦å…¥ã‚‹ãŸã‚è‡ªå‹•æ¡ç•ªã•ã‚Œãªã„ã€‚
newæ™‚ã«ã¯ç•ªå·ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ãªã„ãªã©ãŒå¿…è¦ã€‚
** ãƒ†ãƒ¼ãƒ–ãƒ«åã¨åå‰ç©ºé–“
** pluck
~pluck~ ã¯ã€å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸¸ã”ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã¨ã£ã¦ãã‚‹ã®ã§ã¯ãªãã€å¼•æ•°ã§æŒ‡å®šã—ãŸã‚«ãƒ©ãƒ ã®ã¿ã® *é…åˆ—* ã§è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
[[https://railsdoc.com/page/model_pluck][pluck | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]]

~select~ ã¯ã‚«ãƒ©ãƒ æŒ‡å®šã¨ã„ã†ã¨ã“ã‚ã¯åŒã˜ã ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã€‚
** ã¾ã¨ã‚ã¦å‡¦ç†ã—ã¦é«˜é€ŸåŒ–
1ã¤1ã¤å‡¦ç†ã™ã‚‹ã®ã§ã¯ãªãã¦ã€åŒæ™‚ã«è¤‡æ•°ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ã“ã¨ã§é«˜é€ŸåŒ–ã™ã‚‹ã€‚
** è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãŒè«å¤§ãªå ´åˆ
ãƒ¡ãƒ¢ãƒªã«å…¨ä½“ã‚’å±•é–‹ã™ã‚‹ã®ã§ãªãã€ã‚ã‚‹æ•°ãšã¤å±•é–‹ã—ã¦ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚’æŠ‘ãˆã‚‹ã€‚

[[https://railsdoc.com/page/find_each][find_each | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]] ... 1ä»¶ãšã¤å‡¦ç†ã€‚
[[https://railsdoc.com/page/find_in_batches][find_in_batches | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]] ... é…åˆ—ã§å‡¦ç†ã€‚

** ä¸¦åˆ—å‡¦ç†ã®ä¾‹
parallel gemã«ã‚ˆã£ã¦ã€‚
#+caption: ä¾‹
#+begin_src ruby
  require 'parallel'
  result = Parallel.each(1..10) do |item|
      item ** 2
  end
#+end_src
** é–‹ç™ºã«ä¾¿åˆ©ãªãƒšãƒ¼ã‚¸
- /rails/info/routes
  routesä¸€è¦§ã€‚
- /letter_opener(è‡ªåˆ†ã§è¨­å®šã™ã‚‹)
  é€ä¿¡ã—ãŸãƒ¡ãƒ¼ãƒ«ä¸€è¦§ã‚’è¦‹ã‚‰ã‚Œã‚‹ã€‚
  gemãŒå…¥ã£ã¦ã‚‹å ´åˆã€‚
  [[https://github.com/ryanb/letter_opener][ryanb/letter_opener: Preview mail in the browser instead of sending.]]
- rails/mailers/
  Action Mailerã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‰ã‚Œã‚‹ã€‚
  previewã‚’æº–å‚™ã—ã¦ãŠãã¨ã„ã¡ã„ã¡é€ä¿¡ã›ãšã¨ã‚‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ€ãƒŸãƒ¼ãŒå…¥ã£ãŸæ–‡é¢ã‚’ç¢ºèªã§ãã‚‹ã€‚
** é–‹ç™ºç’°å¢ƒã§ã—ã‹ä½¿ãˆãªã„ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã™ã‚‹
~class_name~ ã¯é–‹ç™ºç’°å¢ƒã§ã—ã‹ä½¿ãˆãªã„ã€‚
gemã«ã‚ˆã£ã¦ã¯ãã†ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä½¿ãˆãªã„ã“ã¨ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãŠãã€‚

- https://stackoverflow.com/questions/38776080/method-class-name-undefined-for-class-object-in-rails
#+begin_quote
class_name method is defined by yard gem. it works only development env.
#+end_quote
** rails console -s
~rails console -s~ ã¨ã—ã¦consoleèµ·å‹•ã™ã‚‹ã¨ã€sandbox-modeã«ãªã‚Šã‚³ãƒ³ã‚½ãƒ¼ãƒ«å†…ã®DBæ“ä½œãŒçµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã€‚
ä¾¿åˆ©ã€‚
** rails cã§ããªã„ã¨ã
springã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ã¦æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚’æ—©ãã™ã‚‹gemã€‚
ãƒ†ã‚¹ãƒˆã‚‚é«˜é€ŸåŒ–ã§ãã‚‹ã®ã§ä¾¿åˆ©ã ãŒã€ãŸã¾ã«å£Šã‚Œã¦åæ˜ ã—ãªããªã£ãŸã‚Šã™ã‚‹ã€‚

ã¾ãšspringã‚’æ­¢ã‚ã¦ç¢ºèªã™ã‚‹ã€‚
#+begin_src shell
  bundle exec spring stop
#+end_src
** system specã§TCP error ãŒã§ã‚‹ã¨ã
ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ç¨‹åº¦ã®é•·ã•ã‚’è¶…ãˆã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªã®é‡ãŒè¶³ã‚Šãªããªã£ã¦ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ã€‚
ç‰¹ã«Macã ã¨èµ·ã“ã‚‹ã‚ˆã†ã€‚
#+begin_src shell
  ulimit -n 1024
#+end_src
** seed_fuã®lint
èµ°ã‚‰ã›ã¦ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
#+begin_src ruby
namespace :db do
  namespace :seed_fu do
    desc 'Verify that all fixtures are valid'
    task lint: :environment do
      if Rails.env.test?
        conn = ActiveRecord::Base.connection

        %w[development test production].each do |env|
          conn.transaction do
            SeedFu.seed("db/fixtures/#{env}")
            raise ActiveRecord::Rollback
          end
        end
      else
        system("bundle exec rails db:seed_fu:lint RAILS_ENV='test'")
        raise if $CHILD_STATUS.exitstatus.nonzero?
      end
    end
  end
end
#+end_src
** ã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‹èª¿ã¹ã‚‹
ã©ã®gemã®ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚ã‹ã‚‰ãªã„ã¨ãã« ~source_location~ ãŒä¾¿åˆ©ã€‚
https://docs.ruby-lang.org/ja/latest/method/Method/i/source_location.html
#+begin_src ruby
  character.method(:draw).source_location
#+end_src
** DBãƒªã‚»ãƒƒãƒˆ
ç’°å¢ƒã‚’æŒ‡å®šã—ã¦ã€ãƒªã‚»ãƒƒãƒˆã‚’è¡Œã†ã€‚
ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã«seed_fu gemã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚

#+begin_src shell
  bundle exec rails db:migrate:reset && rails db:seed_fu
#+end_src
** ãƒ‡ã‚¤ãƒªãƒ¼ã§ã‚„ã‚‹ã“ã¨
gemã®updateã‚„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·ããŸã¨ãã«ã‚„ã‚‹ã€‚
ã©ã“ã‹ã§å®šå‹åŒ–ã—ã¦ä¸€æ°—ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
#+begin_src shell
  git checkout develop && bundle install && bundle exec rails db:migrate
#+end_src
** scope
scopeã¯ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰çš„ãªã‚„ã¤ã€‚
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ä½¿ãˆãªã„ã€‚ ~User.scope...~
[[https://railsguides.jp/active_record_querying.html#%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97][Active Record ã‚¯ã‚¨ãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ - Railsã‚¬ã‚¤ãƒ‰]]

#+begin_quote
ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€é–¢é€£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã¨ã—ã¦å‚ç…§ã•ã‚Œã‚‹ã€ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
#+end_quote
** validation
~valid?~ ã¯Action Modelã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
[[https://devdocs.io/rails~6.1/activemodel/validations#method-i-valid-3F][Ruby on Rails 6.1 / ActiveModel::Validations#valid? â€” DevDocs]]
å¼•ã£ã‹ã‹ã£ã¦ãŸã‚‰falseã«ãªã‚‹ã€‚
ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã—ã¾ã„ãã†ã«ãªã‚‹ãƒ¡ã‚½ãƒƒãƒ‰åãªã®ã«æ³¨æ„ã€‚
** ãƒã‚¹ãƒˆã—ãŸvalidateã¯åå¿œã—ãªã„
 ç‰¹å®šã®æ¡ä»¶ã ã‘ã§ç™ºå‹•ã™ã‚‹validation + æ¡ä»¶ã€‚`with_options: if`å†…ã§`if`ã‚’ä½¿ã†ã¨ã€ä¸­ã®ifæ¡ä»¶ãŒå„ªå…ˆã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã†æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚
#+begin_src ruby
  validates :term_date, date: { after: proc { Time.zone.now } }, if: proc { |p| p.term_date? && p.sellable?  }
#+end_src
** N+1å•é¡Œ
[[id:8b69b8d4-1612-4dc5-8412-96b431fdd101][SQL]]ãŒãŸãã•ã‚“å®Ÿè¡Œã•ã‚Œã¦é…ããªã‚‹ã“ã¨ã€‚ãƒ«ãƒ¼ãƒ—ã—ã¦ã„ã‚‹ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ•°ã ã‘SQLãŒç™ºè¡Œã•ã‚Œã€ä¸€æ°—ã«é…ããªã‚‹ã€‚
includesã‚’ä½¿ã†ã¨å°‘ãªã„SQLã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹ã€‚
https://qiita.com/hirotakasasaki/items/e0be0b3fd7b0eb350327

#+caption: includesã§é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã¾ã¨ã‚ã¦å–å¾—ã™ã‚‹
#+begin_src ruby
  Page.includes(:category)
#+end_src
** å­ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã¨ãé–¢é€£å‰Šé™¤ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
~dependent: destroy~ ã ã¨å­ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã™ã¹ã¦ç ´å£Šã—ã¦æ•´åˆæ€§ã‚’ä¿ã¤ã€‚
ãã‚Œã§ã¯å…·åˆãŒæ‚ªã„ã¨ãã‚‚ã‚ã‚‹ã®ã§ã€æ¶ˆã•ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
#+begin_src ruby
  has_many :contents, dependent: :restrict_with_error
#+end_src

ã‚ã‚‹ã„ã¯ã€å¤–éƒ¨ã‚­ãƒ¼ã‚’nullæ›´æ–°ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹(nullableã§ã‚ã‚Œã°)ã€‚
#+begin_src ruby
  has_many :contents, dependent: :nullify
#+end_src
** æ–‡å­—åˆ—ã§è¿”ã£ã¦ãã‚‹çœŸå½å€¤ã‚’booleanã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹
æ–‡å­—åˆ—ã§è¿”ã£ã¦ãã‚‹çœŸå½å€¤ã‚’ã€booleanã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ‰±ã„ã¨ãã€‚ActiveModelã®moduleã‚’ä½¿ç”¨ã™ã‚‹ã€‚
è¨€ã‚ã‚Œã¦ã¿ã‚‹ã¨DBã§ã¯æ–‡å­—åˆ—ã‹ã‚’ã‚ã¾ã‚Šæ„è­˜ã›ãšã«ä½¿ãˆã‚‹ã€‚
#+begin_src ruby
  ActiveModel::Type::Boolean.new.cast(value) == true
#+end_src
** slimã§æ¡ä»¶åˆ†å²
[[https://qiita.com/mishiwata1015/items/407e924263d698ddeaae][ã€Railsã€‘Slimã§å…¥ã‚Œå­ã«ãªã£ã¦ã„ã‚‹è¦ç´ ã®è¦ªã‚¿ã‚°ã®ã¿ã‚’åˆ†å²ã•ã›ã‚‹ - Qiita]]
é–‰ã˜ã‚¿ã‚°ãŒãªã„ãŸã‚éšå±¤ã®ä¸Šã ã‘æ¡ä»¶åˆ†å²ã™ã‚‹ãŸã‚ã«ã¯ç‰¹æ®Šãªæ›¸ãæ–¹ãŒå¿…è¦ã«ãªã‚‹ã€‚
#+begin_export html
- unless request.variant.present? && request.variant.include?(:phone)
  / PCã§ã®ã¿ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«
  - args = [:section, class: 'sidebar']
- else
  / ã‚¹ãƒãƒ›ã§ã¯ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å…¥ã‚Œã‚‹
  - args = [:section]
= content_tag(*args)
#+end_export
** migrationä¾‹
#+begin_src shell
  $ rails g migration ChangeProductPrice
#+end_src

#+begin_src ruby
  class ChangeProductsPrice < ActiveRecord::Migration[7.0]
    def up
      change_table :products do |t|
        t.change :price, :string
      end
    end

    def down
      change_table :products do |t|
        t.change :price, :integer
      end
    end
  end
#+end_src

#+begin_src shell
 $ rails g migration AddNotNullOnBooks
#+end_src

#+begin_src ruby
  class AddNotNullOnBooks < ActiveRecord::Migration[6.0]
    def up
      change_column_null :books, :user_id, false
    end

    def down
      change_column_null :books, :user_id, true
    end
  end
#+end_src
* Tasks
** TODO ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã©ã†ã‚„ã£ã¦ã„ã‚‹ã‹                           :DontKnow:
ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã—ãŸã¨ãã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä½•ãŒèµ·ã“ã£ã¦ã„ã‚‹ã‹ã€‚
** TODO Railsã¯èµ·å‹•æ™‚ã«ä½•ã‚’ã—ã¦ã„ã‚‹ã‹                                :DontKnow:
Rails s ã¨ã¯å®Ÿéš›ä½•ãªã®ã‹ã€‚
** TODO ECRãƒ‡ãƒ—ãƒ­ã‚¤
:LOGBOOK:
CLOCK: [2022-04-07 Thu 22:47]--[2022-04-07 Thu 23:12] =>  0:25
CLOCK: [2022-04-07 Thu 10:36]--[2022-04-07 Thu 11:01] =>  0:25
:END:
** TODO å®Ÿè¡Œæ™‚ã®waringã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ¤œå‡ºã•ã›ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¤ã‘ã‚‹
** TODO [[https://egghead.io/blog/rails-graphql-typescript-react-apollo][Rails + GraphQL + TypeScript + React + Apollo | egghead.io]]
** TODO [[https://www.amazon.com/Advanced-Rails-Recipes-Mike-Clark/dp/0978739221][Advanced Rails Recipes]]
** TODO [[https://dxd2021.cto-a.org/program/time-table/b-3][ã‚¯ã‚½ã‚³ãƒ¼ãƒ‰å‹•ç”»ã€ŒUserã‚¯ãƒ©ã‚¹ã€ã§è€ƒãˆã‚‹æŠ€è¡“çš„è² å‚µè§£æ¶ˆã®è¦³ç‚¹/DXD2021]]
ã‚¯ã‚½ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å­¦ã¶ã€‚
** TODO [[https://railsguides.jp/][Ruby on Rails ã‚¬ã‚¤ãƒ‰ï¼šä½“ç³»çš„ã« Rails ã‚’å­¦ã¼ã†]]
:LOGBOOK:
CLOCK: [2021-10-10 Sun 14:09]--[2021-10-10 Sun 14:43] =>  0:34
:END:
Rails ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚
** TODO [[https://www.codewithjason.com/understanding-factory-bot-syntax-coding-factory-bot/][Understanding Factory Bot syntax by coding your own Factory Bot - Code with Jason]]
Factory Botã®ä½œã‚Šæ–¹ã€‚
** TODO Tipsæ–‡æ›¸åŒ–
:LOGBOOK:
CLOCK: [2022-01-13 Thu 10:09]--[2022-01-13 Thu 10:34] =>  0:25
CLOCK: [2022-01-10 Mon 23:52]--[2022-01-11 Tue 00:17] =>  0:25
CLOCK: [2022-01-10 Mon 21:45]--[2022-01-10 Mon 22:10] =>  0:25
CLOCK: [2021-12-26 Sun 15:43]--[2021-12-26 Sun 17:40] =>  1:57
CLOCK: [2021-12-23 Thu 10:01]--[2021-12-23 Thu 10:56] =>  0:55
:END:
- 5730
* Archives
** DONE èª¤å­—
CLOSED: [2021-09-09 æœ¨ 09:18]
https://github.com/carrierwaveuploader/carrierwave/blob/a3ffc5381e70a4014b61b27b35540aa3b945910d/README.md#retry-option-for-douwload-from-remote-location

PRé€ä¿¡å®Œäº†ã€‚ä¸€å­—ã ã‘ã€‚
** DONE [[https://zenn.dev/prune/books/0d7d6e3c5f0496][Rails+Reactï¼ˆSPAï¼‰TODOã‚¢ãƒ—ãƒªãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€0ã‹ã‚‰å­¦ã¶ã€‘]]
CLOSED: [2022-01-15 Sat 21:23]
:LOGBOOK:
CLOCK: [2022-01-15 Sat 20:49]--[2022-01-15 Sat 21:14] =>  0:25
CLOCK: [2022-01-15 Sat 20:14]--[2022-01-15 Sat 20:39] =>  0:25
CLOCK: [2022-01-15 Sat 16:12]--[2022-01-15 Sat 16:37] =>  0:25
CLOCK: [2022-01-15 Sat 15:36]--[2022-01-15 Sat 16:01] =>  0:25
CLOCK: [2022-01-15 Sat 15:06]--[2022-01-15 Sat 15:31] =>  0:25
CLOCK: [2022-01-15 Sat 11:19]--[2022-01-15 Sat 11:44] =>  0:25
CLOCK: [2022-01-15 Sat 10:35]--[2022-01-15 Sat 11:00] =>  0:25
CLOCK: [2022-01-15 Sat 00:02]--[2022-01-15 Sat 00:27] =>  0:25
CLOCK: [2022-01-10 Mon 20:08]--[2022-01-10 Mon 20:33] =>  0:25
CLOCK: [2022-01-10 Mon 19:30]--[2022-01-10 Mon 19:55] =>  0:25
:END:
[[id:e04aa1a3-509c-45b2-ac64-53d69c961214][Rails]]  + [[id:dc50d818-d7d1-48a8-ad76-62ead617c670][React]]ã®æœ¬ã€‚

ãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ãŒã§ããªã„ã€‚
** CLOSE loggerã‚’è‡ªå‹•ã‚ªãƒ³
CLOSED: [2022-01-31 Mon 09:35]
Rails consoleã€‚ENVã§åˆ†å²ã™ã‚Œã°æœ¬ç•ªã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹ã€ã¨ã„ã†ã“ã¨ãŒã§ãã‚‹ã¯ãšã€‚
** DONE [[https://qiita.com/k-penguin-sato/items/07fef2f26fd6339e0e69][ã€Railsã€‘graphql-rubyã§APIã‚’ä½œæˆ - Qiita]] -å®Ÿè¡Œ
CLOSED: [2022-02-01 Tue 21:55] DEADLINE: <2022-02-25 Fri>
:LOGBOOK:
CLOCK: [2022-02-01 Tue 10:10]--[2022-02-01 Tue 10:35] =>  0:25
CLOCK: [2022-02-01 Tue 09:18]--[2022-02-01 Tue 09:43] =>  0:25
CLOCK: [2022-01-31 Mon 23:36]--[2022-02-01 Tue 00:01] =>  0:25
CLOCK: [2022-01-31 Mon 22:03]--[2022-01-31 Mon 22:28] =>  0:25
CLOCK: [2022-01-31 Mon 21:24]--[2022-01-31 Mon 21:49] =>  0:25
:END:
[[id:b4f456cf-d250-4877-ac4c-4b03144392f0][GraphQL]]ã‚’railsã§ã‚„ã‚‹ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã€‚
** CLOSE [[https://www.amazon.co.jp/dp/B01N0SS6NF/ref=dp-kindle-redirect?_encoding=UTF8&btkr=1][Amazon.co.jp: Deploying Rails with Docker, Kubernetes and ECS (English Edition) eBook : AcuÃ±a, Pablo: Foreign Language Books]]
CLOSED: [2022-01-29 Sat 11:16]
:LOGBOOK:
CLOCK: [2022-01-29 Sat 09:31]--[2022-01-29 Sat 09:56] =>  0:25
CLOCK: [2022-01-29 Sat 09:04]--[2022-01-29 Sat 09:29] =>  0:25
CLOCK: [2022-01-29 Sat 01:10]--[2022-01-29 Sat 01:36] =>  0:26
CLOCK: [2022-01-28 Fri 22:38]--[2022-01-28 Fri 23:03] =>  0:25
CLOCK: [2022-01-28 Fri 10:29]--[2022-01-28 Fri 10:54] =>  0:25
CLOCK: [2022-01-28 Fri 09:59]--[2022-01-28 Fri 10:24] =>  0:25
CLOCK: [2022-01-27 Thu 23:08]--[2022-01-27 Thu 23:33] =>  0:25
CLOCK: [2022-01-27 Thu 22:35]--[2022-01-27 Thu 23:00] =>  0:25
CLOCK: [2022-01-27 Thu 10:39]--[2022-01-27 Thu 11:04] =>  0:25
CLOCK: [2022-01-27 Thu 10:03]--[2022-01-27 Thu 10:28] =>  0:25
CLOCK: [2022-01-27 Thu 09:29]--[2022-01-27 Thu 09:54] =>  0:25
CLOCK: [2022-01-27 Thu 00:29]--[2022-01-27 Thu 00:54] =>  0:25
:END:
- 24, 51

Kubernetesã§Rails deployã¾ã§ã‚„ã‚‹æœ¬ã€‚
AWSãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã®æŒ™å‹•ãŒé•ã„ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’åˆã‚ã›ã¦ã‚‚å‹•ã‹ãšã‚ˆãã‚ã‹ã‚‰ãªã‹ã£ãŸã®ã§æ–­å¿µã€‚ã“ã†ã„ã†ã®ã¯æ–°ã—ã„æœ¬ã‚’è²·ã†ã¹ãã ãªã€‚ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒminikubeã§ã®å‹•ä½œã¯ç¢ºèªã§ããŸã€‚
** DONE Railsã¨Pumaã®é–¢ä¿‚æ€§                                      :DontKnow:
CLOSED: [2022-08-14 Sun 18:50]
2ã¤ã®é•ã„ã¯ä½•ã§ã€å®Ÿéš›ã©ã®ã‚ˆã†ã«ã€ã©ã®å¢ƒç•Œã§å‡¦ç†ã—ã¦ã„ã‚‹ã®ã‹ã€‚

- rails: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³(ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰)
- puma: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‹•ã‹ã—ã¦ã„ã‚‹ã‚‚ã®

#+begin_quote
ã¾ãšã€webãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯webã‚µãƒ¼ãƒãƒ¼ãŒå—ã‘å–ã‚Šã¾ã™ã€‚ãã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒRailsã§å‡¦ç†ã§ãã‚‹ã‚‚ã®ã§ã‚ã‚Œã°ã€webã‚µãƒ¼ãƒãƒ¼ã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ç°¡å˜ãªå‡¦ç†ã‚’åŠ ãˆã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã«æ¸¡ã—ã¾ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã¯Rackã‚’ä½¿ã£ã¦Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«è©±ã—ã‹ã‘ã¾ã™ã€‚Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å‡¦ç†ã‚’çµ‚ãˆã‚‹ã¨ã€Railsã¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã«è¿”ã—ã¾ã™ã€‚ãã—ã¦ã€webã‚µãƒ¼ãƒãƒ¼ã¯ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ã£ã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã—ã¾ã™ã€‚
#+end_quote

- [[https://qiita.com/jnchito/items/3884f9a2ccc057f8f3a3][Railsé–‹ç™ºã«ãŠã‘ã‚‹webã‚µãƒ¼ãƒãƒ¼ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã®é•ã„ï¼ˆç¿»è¨³ï¼‰ - Qiita]]

* References
** [[https://github.com/thoughtbot/ruby-science][thoughtbot/ruby-science: The reference for writing fantastic Rails applications]]
ruby, railsã®ã‚ˆã‚Šè‰¯ã„æ›¸ãæ–¹ã®ã‚¬ã‚¤ãƒ‰ã€‚
** [[https://qiita.com/takahiro1127/items/fcb81753eaf381b4b33c][ãªãœrailsã®æœ¬ç•ªç’°å¢ƒã§ã¯Unicorn,Nginxã‚’ä½¿ã†ã®ã‹? ã€€~ Rack,Unicorn,Nginxã®é€£æºã«ã¤ã„ã¦ ~ã€Ruby On Railsã§webã‚µãƒ¼ãƒ“ã‚¹é‹å–¶ã€‘ - Qiita]]
** [[https://stackoverflow.com/questions/61413196/how-to-run-capybara-tests-using-selenium-chrome-in-a-dockerised-rails-environm][docker - How to run Capybara tests using Selenium & Chrome in a Dockerised Rails environment on a Mac - Stack Overflow]]
dockerã®seleniumã§å‹•ã‹ã™æ–¹æ³•ã€‚
** [[https://railsguides.jp/active_model_basics.html][Active Model ã®åŸºç¤ - Railsã‚¬ã‚¤ãƒ‰]]
ãƒ¢ãƒ‡ãƒ«ã®èª¬æ˜ã€‚
** [[https://qiita.com/jnchito/items/0ee47108972a0e302caf][æ°¸ä¹…ä¿å­˜ç‰ˆï¼ï¼Ÿä¼Šè—¤ã•ã‚“å¼ãƒ»Railsã‚¢ãƒ—ãƒªã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹é † - Qiita]]
ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®æµã‚Œã€‚
** [[https://tech.kitchhike.com/entry/2017/03/07/190739][DHHæµã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§å¾—ã‚‰ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆã¨ã€å–ã‚Šå…¥ã‚Œã‚‹ä¸Šã§ã®ãƒã‚¤ãƒ³ãƒˆ - KitchHike Tech Blog]]
ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã©ã†ã™ã‚‹ã‹ã®æŒ‡é‡ã€‚
** [[https://github.com/ankane/strong_migrations][ankane/strong_migrations: Catch unsafe migrations in development]]
READMEã«å®‰å…¨ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®èª¬æ˜ãŒã‚ã‚‹ã€‚
** [[https://tech.speee.jp/entry/2020/06/30/110000][reg-suit ã«ã‚ˆã‚‹ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã§ Rails ã‚¢ãƒ—ãƒªã® CSS æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ãŒå›ã‚Šå§‹ã‚ãŸè©± - Speee DEVELOPER BLOG]]
ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®é‹ç”¨æ–¹æ³•ã€‚
** [[https://zenn.dev/yukito0616/articles/d3b7032e9f1e90][Only My Rails Way]]
Rails Wayã®å®šç¾©ã«ã¤ã„ã¦ã€‚
** [[https://discuss.rubyonrails.org/][Ruby on Rails Discussions - Ruby on Rails Discussions]]
Railsé–‹ç™ºã®ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã€‚
** [[https://www.slideshare.net/ockeghem/ruby-on-rails-security-142250872][Railsã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ãŸã‚ã®ã‚¦ã‚§ãƒ–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å…¥é–€]]
ã‚ã‹ã‚Šã‚„ã™ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã€‚
** [[https://techracho.bpsinc.jp/hachi8833/2020_05_13/91211][Railsé–‹ç™ºè€…ãŒæ¡ç”¨é¢æ¥ã§èã‹ã‚Œã‚‹æƒ³å®šQ&A 53å•ï¼ˆç¿»è¨³ï¼‰ï½œTechRacho by BPSæ ªå¼ä¼šç¤¾]]
ã¡ã‚ƒã‚“ã¨Railsã‚¬ã‚¤ãƒ‰ã‚’èª­ã¾ãªã„ã¨ãã¤ã„ãªã€‚
