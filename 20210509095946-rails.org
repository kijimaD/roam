:PROPERTIES:
:ID:       e04aa1a3-509c-45b2-ac64-53d69c961214
:END:
#+title: Rails
* æ¦‚è¦
Railsã¯[[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]]ã§WEBã‚µã‚¤ãƒˆã‚’ä½œã‚‹ãŸã‚ã®ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã€‚
* Memo
** update_atã‚’æ›´æ–°ã—ãªã„                                               :WIP:
ãƒãƒƒãƒå‡¦ç†ã§ã„ã˜ã£ãŸå ´åˆã¯æ›´æ–°ã™ã‚‹ã¨ã‚ˆããªã„ã“ã¨ãŒã‚ã‚‹ã€‚
** save(validation: false)
ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒä¸è¦ãªã¨ãã€ ~user.save!(validation: false)~ ã¨ã™ã‚‹ã¨ç„¡åŠ¹åŒ–ã§ãã‚‹ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚’æ•´åˆã™ã‚‹ã¨ãã«ä½¿ã†ã€‚
** presence: trueãªã®ã«nilãŒã‚ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¤œçŸ¥ã™ã‚‹
ãƒ¢ãƒ‡ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‹ã‹ã£ã¦ã„ã¦ã‚‚ã€æ—¢å­˜ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯nilã‚’å«ã‚€å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
ãƒ¢ãƒ‡ãƒ«ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯å…¥å‡ºåŠ›ã®ã¿ç›£è¦–ã™ã‚‹ã€‚ã ã‹ã‚‰æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã«æ®‹ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚
ã“ã®å ´åˆã€ç·¨é›†ã§ããªãã¦ä¸ä¾¿ã€‚æ¤œçŸ¥ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚‚åˆ¶ç´„ã‚’ã‹ã‘ã‚‹ã¨å®‰å…¨ã«ãªã‚‹ã€‚DBãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã‚‚å…¥ã£ã¦ãªã„ã“ã¨ã‚’ä¿è¨¼ã§ãã‚‹ã€‚

ç›´ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆ¶ç´„ã‚’è¾¿ã‚‹æ–¹æ³•ãŒã‚ã‹ã‚‰ãªã„ã®ã§ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æ¢ç´¢ã™ã‚‹æ„Ÿã˜ã«ãªã£ãŸã€‚ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒãŸãã•ã‚“ã‚ã‚‹ç’°å¢ƒã§å®Ÿè¡Œã™ã‚‹ã¨æ¤œçŸ¥ã§ãã‚‹ã€‚å…¨éƒ¨è¾¿ã‚‹ã®ã§ã‚¯ã‚½é‡ã„ã€‚
#+begin_src ruby
  msgs = {}

  Rails.application.eager_load!
  ApplicationRecord.subclasses.each do |model|
    presence_validates = model.validators.select { |v| v.class.to_s.include?('ActiveRecord::Validations::PresenceValidator') }
    presence_validates.each do |presence_validate|
      model.all.find_each do |record|
        msgs["#{record.class} #{presence_validate.attributes.first}"] = 'âŒ presence: trueã‚ã‚‹ã®ã«nilãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹><' unless record.send(presence_validate.attributes.first)
      end
    end
  end

  pp msgs.sort #  [["User name", "âŒ presence: trueã‚ã‚‹ã®ã«nilãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚‹><"]]
#+end_src

ã¾ãšnilã‚’ãªãã™ã€‚ãã‚Œã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã™ã‚‹ã€‚
** presenceã¨not nullã®é•ã„                                            :WIP:
** ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã„ã†ã¨ãã®æ­£ç¢ºãªã‚¹ã‚³ãƒ¼ãƒ—
APIã‚µãƒ¼ãƒã¨ã—ã¦ã®åˆ©ç”¨ã€ãƒãƒƒã‚¯ã¨ãƒ•ãƒ­ãƒ³ãƒˆã®åˆ†å‰²ãŒä¸»æµã«ãªã£ã¦ã„ã‚‹ã€‚
æ¡ç”¨è€…ãŒRailsã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºè€…ã‚’æ¢ã—ã¦ã„ã‚‹ã€ã¨ã„ã†ã¨ãã¯APIé–‹ç™ºçµŒé¨“ãŒã‚ã‚‹äººæã‚’æ¢ã—ã¦ã„ã‚‹ã¨ã„ãˆã‚‹ã€‚
** ãƒ†ã‚¹ãƒˆã«ã‚ˆã‚‹ã‚¹ãƒãƒ¼ãƒˆãªç”»åƒç¢ºèª
system specã§ã‚¹ã‚¯ã‚·ãƒ§ã‚’ã¨ã£ã¦ç¢ºèªã™ã‚‹ã€‚
ã‚ã–ã‚ã–ç”¨æ„ã—ã¦ç¢ºèªã—ãªã„ã€‚

TDDã‚’å¾¹åº•ã—ã€ä¸€åˆ‡ãƒ–ãƒ©ã‚¦ã‚¶ç¢ºèªã›ãšã«ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚’é–‹ç™ºã—ãŸã€ã¨ã„ã†å‰äººã‚‚ã„ã‚‹ã€‚
** ã‚ªãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‰ã™ã‚‹gem: zeitwerk
zeitwerkã¯ã‚ªãƒ¼ãƒˆãƒ­ãƒ¼ãƒ‰ã™ã‚‹gemã€‚Rails 6ã§ä½¿ã‚ã‚Œã¦ã„ã‚‹ã€‚
Railsã§requireã—ãªãã¦ã„ã„ã®ã¯ã“ã‚Œã‚’ä½¿ã£ã¦ã„ã‚‹ã‹ã‚‰ã€‚
[[https://github.com/fxn/zeitwerk][fxn/zeitwerk: Efficient and thread-safe code loader for Ruby]]
** reorder                                                             :WIP:
ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ã‚³ãƒ¼ãƒ—ã‚’ç„¡è¦–ã§ãã‚‹ã€‚
** é–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ã®ç”¨æ„
é–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ã«ã¯ã„ãã¤ã‹ã®æ–¹æ³•ãŒã‚ã‚‹ã€‚

- seedãƒ‡ãƒ¼ã‚¿ã§ç”¨æ„ã™ã‚‹ã€‚æ¯å›å¿…è¦ãªã¨ãã«resetã—ã¦é–‹ç™ºã™ã‚‹
  - ã‚¯ãƒªãƒ¼ãƒ³ãªç’°å¢ƒã§å†ç¾æ€§ãŒé«˜ã„é–‹ç™ºã‚’è¡Œãˆã‚‹ã€‚
  - æ—©ã„

- æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã«è¿‘ã„ãƒ‡ãƒ¼ã‚¿ã§è¡Œã†
  - ãƒ‡ã‚¶ã‚¤ãƒ³ã‚„æ€§èƒ½ã®å•é¡Œã«æ°—ã¥ãã‚„ã™ã„
  - ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„
  - ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ãŒæ¥½
  - æ•´åˆæ€§ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦
** ALTER TABLEã¯é‡ã„
ãƒ†ãƒ¼ãƒ–ãƒ«ã®ã‚³ãƒ”ãƒ¼ã‚’ä½œã‚‹ã®ã§é‡ã„ã€‚
bulk: trueã‚’ã¤ã‘ã‚‹ã¨ALTER TABLEã‚’ã¾ã¨ã‚ã‚‹ã®ã§é«˜é€Ÿã«ãªã‚‹ã€‚
#+begin_src ruby
  def up
    change_table :legal_engine_forms, bulk: true do |t|
      ...
    end
  end
#+end_src
** ãƒ†ãƒ¼ãƒ–ãƒ«åã«ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã‚’è¨­å®šã™ã‚‹
ç‰¹å®šã®æ©Ÿèƒ½ã«å¯¾ã—ã¦ã€é–¢ä¿‚ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¤‡æ•°ã¤ãã‚‹ã¨ãã€ãƒ—ãƒ¬ãƒ•ã‚£ã‚¯ã‚¹ã®ã‚ˆã†ãªå½¢ã§ãƒ¢ãƒ‡ãƒ«åã‚„ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’æ±ºã‚ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚
admin_userã€admin_pageã€admin_permissionã¨ã‹ã€‚
ã“ã†ã™ã‚‹ã“ã¨ã®å•é¡Œç‚¹: è¡çªã‚’é¿ã‘ã‚‹ãŸã‚ã«modelåã¨ãƒ†ãƒ¼ãƒ–ãƒ«åãŒé•·ããªã‚‹ã€‚ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚‚è¦‹ã«ãããªã‚‹ã€‚ä¸€èªã ã¨ã¾ã ã„ã„ã®ã ãŒã€è¤‡æ•°åã«ãªã‚‹ã¨ã¤ã‚‰ããªã‚‹ã€‚

è§£æ±ºã®ãŸã‚ã«ã¯ã€moduleã‚’å®šç¾©ã—ã€å†…éƒ¨ã§table_name_prefixã‚’è¨­å®šã™ã‚‹ã¨ã„ã„ã€‚

#+caption: modelã«ã¦
#+begin_src ruby
  module Admin
    def self.table_name_prefix
      'admin_'
    end
  end

  module Admin
    class User < ApplicationRecord
    end
  end
#+end_src

ã“ã†ã™ã‚‹ã¨ãƒ¢ãƒ‡ãƒ«åã¯Admin::Userã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«åã¯admin_usersã«ãªã‚Šã‚ã‹ã‚Šã‚„ã™ã„ã€‚
** Railsç’°å¢ƒã§ãƒãƒƒãƒå‡¦ç†ã™ã‚‹
#+caption: Railsç’°å¢ƒã§ã®ã‚¯ãƒ©ã‚¹ã‚’å®Ÿè¡Œã§ãã‚‹
#+begin_src ruby
  rails runner "User.first"
  rails r "User.first"
#+end_src

ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹åŒ–ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«ä½¿ãˆã‚‹ã€‚
** routesã®åˆ¶ç´„
#+begin_src ruby
constraints(-> (req) { req.env["HTTP_USER_AGENT"] =~ /iPhone/ }) do
  resources :iphones
end
#+end_src

[[https://api.rubyonrails.org/v6.0.2/classes/ActionDispatch/Routing/Mapper/Scoping.html#method-i-constraints-label-Dynamic+request+matching][ActionDispatch::Routing::Mapper::Scoping]]
** å¤§é‡ã®routeså¤‰æ›´ã‚’æ¥½ã«ç¢ºèªã™ã‚‹
redirectè¨­å®šã‚„ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã§routesã‚’å¤§é‡ã«å¤‰æ›´ã—ã¦ã€æŒ™å‹•ã®å¤‰æ›´ã‚’è¿½ã„ãŸã„å ´åˆã€‚
rails routesã®çµæœã®diffã‚’å–ã‚Œã°ã€æ¥½ã«ç¢ºèªã§ãã‚‹ã€‚
** create_or_find_by
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ä½¿ã£ã¦ä½œæˆã€ã§ããªã‘ã‚Œã°åˆã‚ã®1ä»¶ã‚’å–å¾—ã™ã‚‹ã€‚
find_or_create_byã§ã¯ä½œæˆã•ã‚Œã‚‹ã¾ã§ã«åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã£ã¦ä½œæˆã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã£ãŸã®ã§ã€ãã®å•é¡Œã‚’è§£æ±ºã—ãŸå‡¦ç†ã€‚
~create_or_find_by!~ ã¯ã‚¨ãƒ©ãƒ¼ã®æ™‚ã«ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹ã€‚

#+caption: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ä½¿ã£ã¦ä½œæˆã€ã§ããªã‘ã‚Œã°åˆã‚ã®1ä»¶ã‚’å–å¾—
#+begin_src ruby
  User.create_or_find_by(name: 'aaa')
#+end_src

[[https://railsdoc.com/page/create_or_find_by][create_or_find_by | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]]
** ä½¿ã‚ã‚Œã¦ãªã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ã™ã‚‹
assetsã¯ç›¸å¯¾ãƒ‘ã‚¹ãŒåˆ©ç”¨ã•ã‚Œãªã„ã®ã§çµ¶å¯¾ãƒ‘ã‚¹ã§æ¤œç´¢ã—ã¦ãƒ’ãƒƒãƒˆã—ãªã‘ã‚Œã°æœªä½¿ç”¨ã¨åˆ¤æ–­ã§ãã‚‹ã€ã¨ã®ã“ã¨ã€‚
#+caption: æ¤œæŸ»ã‚¿ã‚¹ã‚¯ã®ä¾‹
#+begin_src ruby
namespace :assets do
  desc 'prune needless image file'
  task 'prune:images' => :environment do
    base = Rails.root.join('app/assets/images/')

    Dir[Rails.root.join('app/assets/images/**/*.{jpg,jpeg,gif,png,svg}')].each do |path|
      target_path = path.to_s.gsub(/#{base}/, '')
      puts "execute: git grep '#{target_path}'"
      res = `git grep '#{target_path}'`

      if res.empty?
        puts "execute: rm #{path}"
        FileUtils.rm path
        puts '=> removed'
      else
        puts '=> used somewhere'
      end

      puts
    end
  end
end
#+end_src
** [[id:cfd092c4-1bb2-43d3-88b1-9f647809e546][Ruby]]ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ
è¶…å¼·ã„äººãŒè¨€ã£ã¦ã„ãŸãƒ¡ãƒ¢ã€‚
ã‚³ãƒãƒ³ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã¦ä¸€æ°—ã«ç½®æ›ã—ã¦æ¤œè¨ã—ã¦ã„ãã€‚
#+caption: 2.6.5 -> 2.7.1ã«å…¨ä½“ã‚’ç½®æ›ã™ã‚‹
#+begin_src shell
git grep -l '2\.6\.5' | xargs sed -i 's/2\.6\.5/2.7.1/g'
#+end_src
vendor/bundle ã‚’å‰Šé™¤ã—ã¦ã€bundle installã€‚
ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰æ›´ã—ãŸå ´åˆã¯ .rubocop.yml ã® RUBY_VERSION ã‚’ä¿®æ­£(parser gemã®æŒ‡å®š)ã€‚
** æ–°è¦ä½œæˆæ™‚ã¯formè¡¨ç¤ºã—ãªã„
formã‚’å…±é€šåŒ–ã—ã¦ã„ã‚‹ã‚ˆã†ãªã¨ãã€‚
ã“ã®ã‚«ãƒ©ãƒ ã¯editæ™‚ã®ã¿å‡ºã—ãŸã„ã€ã¨ã„ã†ã‚ˆã†ãªã“ã¨ãŒã‚ã‚‹ã€‚
#+caption: newæ™‚persistã•ã‚Œã¦ãªã„ã®ã§è¡¨ç¤ºã•ã‚Œãªã„
#+begin_src ruby
  form_for do |f|
    f.number_field :position if @content_category.persisted?
  end
#+end_src
** ä¸€éƒ¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã ã‘validation
#+caption: onã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŒ‡å®šã§ãã‚‹ã€‚
#+begin_src ruby
validates :user_id, presence: true, :on => :create
#+end_src
** ä¾¿åˆ©ãªæ—¥ä»˜æ“ä½œ
#+caption: Time.zone
#+begin_src ruby
Time.zone.yesterday
Time.zone.today.ago(7.days)
#+end_src

[[https://qiita.com/mmmm/items/efda48f1ac0267c95c29][Railsã§ã®æ—¥ä»˜æ“ä½œã§ã‚ˆãä½¿ã†ã‚‚ã®ã¾ã¨ã‚ - Qiita]]
** å®‰å…¨ã«é–¢é€£ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹
Blogã«user_idã‚’å¾Œã‹ã‚‰è¿½åŠ ã—ãŸã„ã€ã¿ãŸã„ãªã¨ãã€‚User -< Blogã€‚
æœ€åˆã«nullableã§å¤–éƒ¨ã‚­ãƒ¼ã‚’ä½œæˆã™ã‚‹ã€‚

æ¬¡ã«ã€æ–°è¦ä½œæˆæ™‚ã«modelã§validationã‚’ã‹ã‘ã‚‹ã€‚
ã™ã‚‹ã¨æ—¢å­˜ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å¤–éƒ¨ã‚­ãƒ¼ã¯nullã€æ–°ã—ãã§ãã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯å¤–éƒ¨ã‚­ãƒ¼ã‚ã‚Šã¨ã„ã†çŠ¶æ…‹ã«ãªã‚‹ã€‚
å¤–éƒ¨ã‚­ãƒ¼ãªã—ãŒå¢—ãˆã‚‹ã“ã¨ã¯ãªã„ã€‚ç§»è¡Œã‚’ã™ã‚‹ã€‚
nullã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚¼ãƒ­ã«ãªã£ã¦ã‹ã‚‰å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’ã¤ã‘ã¦é–¢é€£ã‚«ãƒ©ãƒ è¿½åŠ å®Œäº†ã€‚
** é–¢é€£ã‚«ãƒ©ãƒ ã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹
ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã™ã§ã«å…¥ã£ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢é€£ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã€‚
ãŸã¨ãˆã°ã€blogs >- somethings >- users ã‚’ blogs >- users ã¨ã„ã†ã‚ˆã†ãªã€‚somethingsãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä½•ã‚‚ã—ã¦ãªã„ã®ã§å‰Šé™¤ã—ãŸã„ã€ã¨ã™ã‚‹ã€‚
ä½•ã‚‚è€ƒãˆãšã«ã‚„ã‚‹ã¨ã€ä¸€æ°—ã«ã™ã¹ã¦ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã«ãªã‚ŠãŒã¡ã€‚

æ‚ªã„ä¾‹ã‚’ç¤ºã™ã€‚
1. æœ€åˆã«é–¢é€£ã‚«ãƒ©ãƒ ã‚’å¤‰æ›´ã™ã‚‹ã€‚
  #+caption: modelãƒ•ã‚¡ã‚¤ãƒ«ã§é–¢é€£å¤‰æ›´
  #+begin_src ruby
   belongs_to :user # æ—§ belongs_to :something
  #+end_src
2. æ—§é–¢é€£ã‚’ä½¿ã£ã¦ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã‚’ã™ã¹ã¦å¤‰æ›´ã™ã‚‹ã€‚MVCã™ã¹ã¦ã€‚
3. æ–°ã—ã„é–¢é€£ã‚«ãƒ©ãƒ ã¯ç©ºã§ã€æ—§ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã—ãªã„ã¨ã„ã‘ãªã„ã€‚ç§»è¡Œã¯â†‘ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨åŒæ™‚ã«ã—ãªã„ã¨ä¸æ•´åˆã«ãªã‚‹ã€‚ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã®é–“ã®å¤‰æ›´ã¯ç„¡è¦–ã•ã‚Œã‚‹ã‹ã‚‰ã€‚
4. 1~3ã‚’ã¾ã¨ã‚ã¦ä¸€æ°—ã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹

ã¨ã„ã†ã“ã¨ã§ã€å¤§é‡ãªè¤‡æ•°å±¤ã®å¤‰æ›´ã‚’ã¶ã£ã¤ã‘æœ¬ç•ªã§ã—ãªã„ã¨ã„ã‘ãªããªã‚‹ã€‚é€”ä¸­ã§å«Œã«ãªã‚‹ã ã‚ã†ã—ã€é‹ãŒæ‚ªã‘ã‚Œã°ãƒŸã‚¹ã£ã¦å¤§å¤‰ãªã“ã¨ã«ãªã‚‹ã€‚

ã§ã¯ã©ã†ã™ã‚‹ã‹ã€‚æ ¹æœ¬çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¯ã€2ã¤ã®é–¢é€£ã‚’åŒæ™‚ã«ä¿æŒã—ã¦ãŠãã“ã¨ã ã€‚
åŒæ™‚ã«æŒã£ã¦ãŠã‘ã°ã€å¤§ä¸ˆå¤«ãªã“ã¨ã‚’ç¢ºèªã—ã¦ã‹ã‚‰é–¢é€£ã‚’å¤‰æ›´ã™ã‚‹ã ã‘ã§ã„ã„ã€‚ãã†ã‚„ã£ã¦é…å»¶ã•ã›ã‚‹ã“ã¨ã§ã€ä¸€æ°—ã«ã„ã‚ã„ã‚ãªå¤‰æ›´ã‚’ã—ãªãã¦ã‚ˆããªã‚‹ã€‚

å…·ä½“çš„ã«ã©ã†ã‚„ã‚‹ã‹ã€‚è‰¯ã„ä¾‹ã€‚
#+caption: modelã®before_saveã§ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰ã‚³ãƒ”ãƒ¼
#+begin_src ruby
  class Blog < ApplicationRecord
    before_save do
      self.user_id ||= something.user_id
    end
  end
#+end_src

ã¨ã—ã¦ãŠãã¨ã€ä¿å­˜æ™‚ã«blog.user_idã¨blog.something.user_idã®ä¸¡æ–¹ã«é–¢é€£ãŒã‚³ãƒ”ãƒ¼ã•ã‚Œã‚‹ã€‚somethingsã‚’çµŒç”±ã—ãªã„ã§ã‚ˆããªã‚‹ã€‚

æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ã‚‚å‡¦ç†ã‚’è¿½åŠ ã—ã¦ãŠãã€‚
#+caption: modelã«ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½œã£ã¦ãŠã
#+begin_src ruby
  class User < ApplicationRecord
    def migrate
      self.user_id ||= something.user_id
      save!
    end
  end
#+end_src
ãã—ã¦ã€å…¨Userã§migrateã‚’å®Ÿè¡Œã™ã‚Œã°æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã«ã‚‚æ–°ã—ã„ã‚«ãƒ©ãƒ ãŒå…¥ã‚‹ã€‚

æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨æ–°ã—ãä½œæˆã•ã‚Œã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ãŠã•ãˆãŸã®ã§ã€æ–°æ—§2ã¤ã®é–¢é€£ã‚«ãƒ©ãƒ ã¯å®Œå…¨ã«åŒç­‰ã«ãªã‚‹ã€‚
ã“ã“ã¾ã§ã§ãƒãƒ¼ã‚¸ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã€‚
å•é¡Œãªã„ã“ã¨ã‚’ç¢ºèªã—ãŸã‚ã¨ã§ã€æ–°æ—§ã‚«ãƒ©ãƒ ãŒä½¿ãˆã‚‹çŠ¶æ…‹ã‚’æ´»ã‹ã—ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å¤‰æ›´â€¦å®Ÿéš›ã®é–¢é€£ã®å¤‰æ›´ã‚’ã‚„ã‚‹(ä¸€ç•ªã®ç›®çš„ã®ç®‡æ‰€)ã€‚
ã“ã“ã¾ã§ã§ãƒãƒ¼ã‚¸ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã€‚

ãã®å¾Œã€ç§»è¡Œå‡¦ç†ã¨ã‚«ãƒ©ãƒ ã‚’å‰Šé™¤ã—ã¦ç‰‡ä»˜ã‘ã‚Œã°å®Œäº†ã€‚(ã‚ã‚‹ã„ã¯ç§»è¡Œå‡¦ç†ã¯å‰ã®æ™‚ç‚¹ã§æ¶ˆã™)
é–¢é€£ã‚«ãƒ©ãƒ ã ã‘ã§ãªãã€ä½•ã‹ã‚«ãƒ©ãƒ ã‚’ç§»ã™ã¨ãã«ã¯ã™ã¹ã¦åŒæ§˜ã«ã§ãã‚‹ã€‚

å®Ÿéš›ã®ã‚¿ã‚¹ã‚¯ã§ã¯ã€migrationå‡¦ç†ã‚’ã™ã‚‹ç®‡æ‰€ã¯è¤‡æ•°ã«ãªã‚‹ã®ã§å‰ã‚‚ã£ã¦èª¿æŸ»ãŒå¿…è¦ã€‚
** ã‚«ãƒ©ãƒ åã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹
ã‚«ãƒ©ãƒ åå¤‰æ›´ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã®å¤‰æ›´ã‚’åˆ†ã‘ã€å¤‰æ›´ç¯„å›²ã‚’ç‹­ã‚ã‚‹ã€‚
alias_attributeã‚’è¿½åŠ ã™ã‚‹ã€‚ã™ã‚‹ã¨ã€æ–°ã—ã„ã‚«ãƒ©ãƒ åã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
ä¾å­˜ã—ã¦ã„ã‚‹ã»ã‹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’ã™ã‚‹(new_user_idã«æ›¸ãæ›ãˆã‚‹)ã€‚
#+caption: modelãƒ•ã‚¡ã‚¤ãƒ«ã«ã¦ã€è¿½åŠ 
#+begin_src ruby
alias_attribute :new_user_id, :typo_user_id
#+end_src

ãã‚Œã‚‰ã‚’æ›¸ãæ›ãˆãŸã‚‰ãƒãƒ¼ã‚¸ã€ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ã€‚
ãã®å¾Œã€ã‚«ãƒ©ãƒ åã‚’æ›¸ãæ›ãˆã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã™ã‚‹ã€‚ä½¿ã£ã¦ã„ã‚‹ç®‡æ‰€ã¯ãªã„ã®ã§å®‰å…¨ã«å¤‰æ›´ã§ãã‚‹ã€‚
ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã€alias_attributeã‚’å‰Šé™¤ã™ã‚‹ã€‚
** ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å®‰å…¨ã«å¤‰æ›´ã™ã‚‹
æœ€åˆã«model ã‚¯ãƒ©ã‚¹åã‚’å¤‰æ›´ã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‚ç…§å…ˆã«å¤‰æ›´å‰ã®ã‚‚ã®ã‚’è¨­å®šã™ã‚‹ã€‚
#+begin_src ruby
  class Blog_After < ApplicationRecord
    self.table_name = :blog_before
  end
#+end_src
ã™ã‚‹ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã ã‘ã®å¤‰æ›´ã§ã€DBã®å¤‰æ›´ã¯ãªã„çŠ¶æ…‹ã§å‹•ä½œä¸Šã®å¤‰æ›´ã¯ãªããªã‚‹ã€‚
æ¬¡ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã€ã»ã‹ã®ä¾å­˜ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’ä¿®æ­£ã™ã‚‹ã€‚
ã“ã“ã¾ã§1ã¤ã®PRã«ã™ã‚‹ã€‚

ãƒ†ã‚¹ãƒˆãŒé€šã£ãŸã‚Šãƒªãƒªãƒ¼ã‚¹ã§ããŸã‚‰ã€ãƒ†ãƒ¼ãƒ–ãƒ«åå¤‰æ›´ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œæˆã—ã€modelã§ã®table_nameè¨­å®šã‚’å‰Šé™¤ã™ã‚‹PRã‚’ã¤ãã‚‹ã€‚
å®‰å…¨ã«å¤‰æ›´ãŒå®Œäº†ã™ã‚‹ã€‚
ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´ã¨ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ã‚’åŒæ™‚ã«ã‚„ã‚‰ãªã„ã¨å®‰å…¨ã ã—åˆ†å‰²ã§ãã¦ã™ã£ãã‚Šã™ã‚‹ã€‚
** modelã®ãƒ­ã‚°ã‚’ä¿æŒã™ã‚‹
[[https://github.com/paper-trail-gem/paper_trail][paper-trail-gem/paper_trail: Track changes to your rails models]]
å¤‰æ›´ã‚„å·®åˆ†ã€å¤‰æ›´æ™‚ã®ä½•ã‚‰ã‹ã®æƒ…å ±(ã¤ã¾ã‚Šã€ä½œæ¥­è€…ã¨ã‹)ã‚’ä¿å­˜ã€é–²è¦§ã§ãã‚‹ã€‚

[[https://github.com/ankit1910/paper_trail-globalid][ankit1910/paper_trail-globalid: An extension to paper_trail, using this you can fetch actual object who was responsible for this change]]
paper_trailã®æ‹¡å¼µã€‚å¤‰æ›´ã—ãŸã‹å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
** ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚­ãƒ¼
Railsã§ã„ã†ã¨ã“ã‚ã® ~id~ ã®ã“ã¨ã€‚Rails5 ã‹ã‚‰ã¯bigintã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ã€‚
ä¸»ã‚­ãƒ¼ã¨ã—ã¦ä½¿ã†äººå·¥çš„ãªå€¤ã€ã¨ã„ã†ã®ãŒãƒã‚¤ãƒ³ãƒˆã€‚

[[https://e-words.jp/w/%E3%82%B5%E3%83%AD%E3%82%B2%E3%83%BC%E3%83%88%E3%82%AD%E3%83%BC.html][ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚­ãƒ¼ï¼ˆsurrogate keyï¼‰ã¨ã¯ - ITç”¨èªè¾å…¸ e-Words]]
#+begin_quote
ã‚µãƒ­ã‚²ãƒ¼ãƒˆã‚­ãƒ¼ã¨ã¯ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¸»ã‚­ãƒ¼ã¨ã—ã¦ã€è‡ªå‹•å‰²ã‚Šå½“ã¦ã®é€£ç¶šã—ãŸé€šã—ç•ªå·ã®ã‚ˆã†ã«ã€åˆ©ç”¨è€…ã‚„è¨˜éŒ²ã™ã‚‹å¯¾è±¡ã¨ã¯ç›´æ¥é–¢ä¿‚ã®ãªã„äººå·¥çš„ãªå€¤ã‚’ç”¨ã„ã‚‹ã“ã¨ã€‚ã¾ãŸã€ãã®ãŸã‚ã«è¨­ã‘ã‚‰ã‚ŒãŸã‚«ãƒ©ãƒ ã®ã“ã¨ã€‚
#+end_quote
** ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ããªã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹
ãŸã„ã¦ã„ã®å ´åˆã¯ã‚³ãƒ¡ãƒ³ãƒˆã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ããªã„ãªã©ã¨æ›¸ã‘ã°ã‚ˆã„ãŒã€rollbackãŒç ´å£Šçš„ãªå‹•ä½œã«ãªã‚‹å ´åˆãŒã‚ã‚‹ã®ã§downã«æ›¸ãã€‚
#+caption: ActiveRecord::IrreversibleMigration
#+begin_src ruby
  def down
    raise ActiveRecord::IrreversibleMigration
  end
#+end_src
** nullåˆ¶ç´„ã‚’è¿½åŠ ã—ã¤ã¤defaultè¨­å®š
[[https://qiita.com/akinov/items/852fe789fe98a44350a9][Railsã®migrationã§å¾Œã‹ã‚‰NULLåˆ¶ç´„ã‚’è¨­å®šã™ã‚‹ - Qiita]]

nullåˆ¶ç´„è¿½åŠ ã«ã¯ã€ ~change_column_null~ ã‚’ä½¿ã†ã€‚
nullåˆ¶ç´„ã ã‘è¿½åŠ ã™ã‚‹ã¨å¤‰æ›´å‰ã«nullã ã£ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã†ã®ã§ã€åŒæ™‚ã«defaultã‚’è¨­å®šã™ã‚‹ã¨ã‚ˆã„ã€‚

#+caption: nullåˆ¶ç´„ + defaultè¨­å®š
#+begin_src ruby
class ChangePointColumnOnPost < ActiveRecord::Migration[5.2]
  def change
    change_column_null :posts, :point, false, 0
    change_column_default :posts, :point, from: nil, to: 0
  end
end
#+end_src

#+caption: â†‘falseã¯nullã‚ªãƒ—ã‚·ãƒ§ãƒ³
#+begin_src ruby
  change_column_null(table_name, column_name, null, default = nil)
#+end_src
** migrationãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ä¸æ•´åˆè§£æ¶ˆã‚¿ã‚¹ã‚¯
migrationãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸€éƒ¨DSLãŒæ‰±ã‚ã‚Œã‚‹ã ã‘ã§æ™®é€šã®rubyãƒ•ã‚¡ã‚¤ãƒ«ã¨å¤‰ã‚ã‚‰ãªã„ã€‚
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ä¸æ•´åˆã‚’è§£æ¶ˆã™ã‚‹ã“ã¨ã«ã‚‚ä½¿ãˆã‚‹ã€‚

#+caption:
#+begin_src ruby
  def up
    Blog.unscoped.where(user_id: nil).delete_all
  end
#+end_src
ã¨ã„ã†ã‚ˆã†ã«ã€‚
ç’°å¢ƒåˆ¥ã«consoleã§ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒãªã„ã®ã§ä¾¿åˆ©ã€‚
** unscopedã§default_scopeã‚’ç„¡åŠ¹åŒ–
~unscoped~ ã¯default_scopeã‚’ç„¡åŠ¹åŒ–ã™ã‚‹ã€‚
[[https://apidock.com/rails/ActiveRecord/Base/unscoped/class][unscoped (ActiveRecord::Base) - APIdock]]

#+caption: è‡ªå‹•ã§publishedã®æ¡ä»¶ãŒç™ºè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹
#+begin_src ruby
  class Post < ActiveRecord::Base
    def self.default_scope
      where :published => true
    end
  end

  Post.all          # Fires "SELECT * FROM posts WHERE published = true"
  Post.unscoped.all # Fires "SELECT * FROM posts"
#+end_src

#+caption: default_scopeã®æ¡ä»¶ãŒãªããªã‚‹
#+begin_src ruby
  Post.unscoped {
    Post.limit(10) # Fires "SELECT * FROM posts LIMIT 10"
  }
#+end_src
** inverse_ofã§åŒæ–¹å‘ã®ä¸æ•´åˆã‚’é˜²ã
[[https://qiita.com/itp926/items/9cac175d3b35945b8f7e][inverse_of ã«ã¤ã„ã¦ - Qiita]]

åŒæ–¹å‘ã®é–¢é€£ä»˜ã‘ã®ä¸æ•´åˆã‚’é˜²ãé–¢é€£ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€‚belongs_to, has_manyç­‰ã§ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã‚ªãƒ³ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ã€‚

#+caption:
#+begin_src ruby
  class Category
    has_many :blog
  end

  class Order
    belongs_to :category
  end
#+end_src

#+caption: ä¸æ•´åˆ
#+begin_src ruby
  c = Category.first
  b = c.orders.first

  c.title = "change"
  c.title == b.category.title #=> false å€¤ã¯ç•°ãªã‚‹
  c.equal? b.category #=> false åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãªã„
#+end_src
inverse_ofã‚’ä½¿ã†ã¨åŒã˜ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ã†ã‚ˆã†ã«ãªã‚‹ã€‚
** ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä¸æ•´åˆã‚’æ¤œçŸ¥ã™ã‚‹
ã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚
å…¨éƒ¨è¾¿ã‚‹æ–¹æ³•ã¯è‰²ã€…å¿œç”¨ãŒåŠ¹ããã†ã€‚

#+caption: ä¸æ•´åˆæ¤œçŸ¥ã‚¿ã‚¹ã‚¯
#+begin_src ruby
desc 'å¤–éƒ¨ã‚­ãƒ¼ã®æ•´åˆæ€§ã‚’æ¤œè¨¼ã™ã‚‹'
task extract_mismatch_records: :environment do
  Rails.application.eager_load!

  ApplicationRecord.subclasses.each do |model|
    model.reflections.select { |_, reflection| reflection.is_a?(ActiveRecord::Reflection::BelongsToReflection) }.each do |name, reflection|
      model_name = model.model_name.human
      foreign_key = reflection.options[:foreign_key] || "#{name}_id"

      unless model.columns.any? { |column| column.name == foreign_key.to_s }
        puts "ğŸ’¢ #{model_name} ã«ã¯ #{foreign_key} ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“"
        next
      end

      parent_model_class_name = reflection.options[:class_name] || reflection.name.to_s.classify
      parent_model = parent_model_class_name.safe_constantize

      unless parent_model
        puts "ğŸ’¢ #{model_name} ãŒä¾å­˜ã—ã¦ã„ã‚‹ #{parent_model_class_name} ã¯å‚ç…§ã§ãã¾ã›ã‚“"
        next
      end

      parent_model_name = parent_model.model_name.human

      begin
        # NOTE: è¦ªãƒ†ãƒ¼ãƒ–ãƒ«ã®IDã¨ã—ã¦å­˜åœ¨ã—ãªã„å¤–éƒ¨ã‚­ãƒ¼ã®æ•°ã‚’ç…§ä¼š
        relation = model.unscoped.where.not(foreign_key => parent_model.unscoped.select(:id)).where.not(foreign_key => nil)
        sql = relation.to_sql
        count = relation.count

        if count.zero?
          puts "ğŸ’¡ #{model_name} ã® #{parent_model_name} ã®å¤–éƒ¨ã‚­ãƒ¼ã¯æ•´åˆæ€§ãŒä¿è¨¼ã•ã‚Œã¦ã„ã¾ã™" unless ENV['ONLY_FAILURE']
        else
          puts "ğŸ’£ #{model_name} ã® #{parent_model_name} ã®å¤–éƒ¨ã‚­ãƒ¼ã§ä¸æ­£ãªã‚­ãƒ¼ãŒ #{count} ä»¶ è¨­å®šã•ã‚Œã¦ã„ã¾ã™"
        end

        if ENV['DEBUG']
          puts "=> #{sql}\n"
          puts
        end
      rescue StandardError
        # NOTE: ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        puts "ğŸˆ³ #{model_name} ã® #{parent_model_name} ã®æ•´åˆæ€§ã®æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ" unless ENV['ONLY_FAILURE']
      end
    end
  end
end
#+end_src

Reflectionã‚¯ãƒ©ã‚¹ã¯ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³é–¢ä¿‚ã®moduleã®ã‚ˆã†ã€‚
https://github.com/kd-collective/rails/blob/f132be462b957ea4cd8b72bf9e7be77a184a887b/activerecord/lib/active_record/reflection.rb#L49

#+begin_quote
Reflection enables the ability to examine the associations and aggregations of Active Record classes and objects. This information, for example, can be used in a form builder that takes an Active Record object and creates input fields for all of the attributes depending on their type and displays the associations to other objects.

Reflectionã‚’ä½¿ç”¨ã™ã‚‹ã¨ã€Active Recordã®ã‚¯ãƒ©ã‚¹ã‚„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®é–¢é€£ä»˜ã‘ã‚„é›†è¨ˆã‚’èª¿ã¹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã®æƒ…å ±ã¯ã€ä¾‹ãˆã°ã€Active Recordã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å—ã‘å–ã‚Šã€ãã®å‹ã«å¿œã˜ã¦ã™ã¹ã¦ã®å±æ€§ã®å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆã—ã¾ã™ã€‚ä»–ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã®é–¢é€£ã‚’è¡¨ç¤ºã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãƒ“ãƒ«ãƒ€ãƒ¼ã§ä½¿ç”¨ã§ãã¾ã™ã€‚
#+end_quote

Reflectionã«é–¢ã™ã‚‹è¨˜äº‹ã€‚
[[https://qiita.com/kkyouhei/items/067d5bb8d79c71f1646b][Railsã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ - Qiita]]
** ã‚¯ã‚¨ãƒªé«˜é€ŸåŒ–
ãƒã‚¹ãƒˆã—ã¦ã‚¯ã‚¨ãƒªã‚’ç™ºè¡Œã—ã¦ã‚‹ã¨ãã¯ä½•ã‹ãŒãŠã‹ã—ã„ã€‚

- parent_category -> category -> blog ã®ã‚ˆã†ãªæ§‹é€ 

#+caption: ã²ã©ã„ã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰
#+begin_src ruby
  parent_categories.each do |parent_category|
    parent_category.categories.each do |category|
      category.blogs.each do |blog|
        @content << blog.content
      end
    end
  end
#+end_src

- parent_category -> category -> blog

#+caption: joins
#+begin_src ruby
  Blog.joins(categories: category)
    .merge(Category.where(parent_category: parent_large_categories))
#+end_src
** Migrationãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã¾ã¨ã‚ã¦é«˜é€ŸåŒ–ã™ã‚‹
Migrationãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤‰æ›´ã—ãªã„ã®ãŒåŸºæœ¬ã ãŒã€æ•°ãŒå¤šã„å ´åˆã€ ~rails migrate:reset~ ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã€‚

db/schema.rbã®å†…å®¹ã‚’ã€æœ€æ–°ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹ã€‚

- ã¤ã¾ã‚Šç¾åœ¨ã®DBçŠ¶æ³ãŒã€ãã®ã¾ã¾1ã¤ã®migrationã¨ãªã‚‹ã€‚DSLãŒåŒã˜ãªã®ã§å•é¡Œãªã„ã€‚
- migrationã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã¯æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ã®ãŸã‚ã€å‹•ä½œã«å½±éŸ¿ã—ãªã„ã€‚
** Gemfileã§ç’°å¢ƒæŒ‡å®šã™ã‚‹
Gemfileã®groupã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ã€æŒ‡å®šç’°å¢ƒã§ã—ã‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãªã„ã“ã¨ã‚’ç¤ºã™ã€‚

#+caption: developmentã§ã—ã‹ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œãªã„
#+begin_src ruby
  group :development do
    gem 'annotate', require: false
  end
#+end_src

ãªã®ã§ç’°å¢ƒã‚’æŒ‡å®šã›ãšã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ãŸã¨ãã€gem not foundãŒå‡ºã‚‹ã€‚å®Ÿè¡Œã•ã‚ŒãŸã®ãŒdevelopmentç’°å¢ƒã§ã€ãƒ†ã‚¹ãƒˆã®gemãŒèª­ã¿è¾¼ã¾ã‚Œã¦ãªã„ã‹ã‚‰ã€‚ ~RAILS_ENV=test~ ãŒã¤ã„ã¦ã„ã‚‹ã‹ç¢ºèªã™ã‚‹ã€‚
** è«–ç†å‰Šé™¤ã¨ç‰©ç†å‰Šé™¤
è«–ç†å‰Šé™¤ã¯å‰Šé™¤ã—ãŸã¨ããƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹ã®ã§ã¯ãªãã€ãƒ•ãƒ©ã‚°ã‚’ãƒˆã‚°ãƒ«ã™ã‚‹ã‚‚ã®ã€‚
é€†ã«ç‰©ç†å‰Šé™¤ã¯ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‰Šé™¤ã™ã‚‹ã“ã¨ã€‚

è«–ç†å‰Šé™¤ã®ãƒ¡ãƒªãƒƒãƒˆã¯ã€ãƒ‡ãƒ¼ã‚¿ãŒæˆ»ã›ã‚‹ã“ã¨ã€‚

ãŒã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®é‹ç”¨çš„ã«ã€å¾Œã‹ã‚‰å•é¡Œã¨ãªã‚‹ã“ã¨ã®æ–¹ãŒå¤šã„ã€‚

- å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚’ä»˜ã‘å¿˜ã‚Œã‚‹ã¨äº‹æ•…ã«ãªã‚‹ã€‚å‰Šé™¤ã—ãŸã¯ãšãªã®ã«è¡¨ç¤ºã—ãŸã‚Šã€è¨ˆç®—ã«å…¥ã‚ŒãŸã‚Šã—ã¦ã—ã¾ã†
- ãƒ‡ãƒ¼ã‚¿ãŒå¤šããªã‚‹ãŸã‚ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒæ‚ªããªã‚‹

Railsã§ã¯gem act_as_paranoidã‚’ä½¿ã£ã¦ç°¡å˜ã«è«–ç†å‰Šé™¤å‡¦ç†ã‚’è¿½åŠ ã§ãã‚‹ã€‚deleted_atã‚«ãƒ©ãƒ ã‚’è«–ç†å‰Šé™¤ã‚’ç®¡ç†ã™ã‚‹ãƒ•ãƒ©ã‚°ã¨ã—ã¦ç”¨ã„ã‚‹ã€‚
** findã€find_byã€whereã®é•ã„
[[https://qiita.com/tsuchinoko_run/items/f3926caaec461cfa1ca3][findã€find_byã€whereã®é•ã„ - Qiita]]

- find :: å„ãƒ¢ãƒ‡ãƒ«ã®idã‚’æ¤œç´¢ã‚­ãƒ¼ã¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ãƒ¡ã‚½ãƒƒãƒ‰ã€‚ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¿”ã‚‹
- find_by :: idä»¥å¤–ã‚’ã‚­ãƒ¼ã¨ã—ã¦æ¤œç´¢ã€‚è¤‡æ•°ã‚ã£ãŸå ´åˆã¯æœ€åˆã ã‘å–ã‚‹ã€‚ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¿”ã‚‹ã€‚
- where :: idä»¥å¤–ã‚’ã‚­ãƒ¼ã¨ã—ã¦æ¤œç´¢ã€‚ãƒ¢ãƒ‡ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å…¥ã£ãŸé…åˆ—ãŒè¿”ã‚‹ã€‚
** acts_as_list
acts_as_listã¯é †ç•ªã‚’ç®¡ç†ã™ã‚‹gemã€‚
[[https://github.com/brendon/acts_as_list][brendon/acts_as_list: An ActiveRecord plugin for managing lists.]]

é †ç•ªã®ç”Ÿæˆã¨ã€æ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹ã€‚
modelã«é †ç•ªã‚«ãƒ©ãƒ ã‚’æŒ‡å®šã™ã‚‹ã¨ã€createæ™‚ã«è‡ªå‹•ã§ç•ªå·ãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚
é€†ã«ãƒ•ã‚©ãƒ¼ãƒ ã§ç•ªå·æ ¼ç´ã—ã¦ã„ã‚‹ã¨ãã‚ŒãŒå„ªå…ˆã—ã¦å…¥ã‚‹ãŸã‚è‡ªå‹•æ¡ç•ªã•ã‚Œãªã„ã€‚
newæ™‚ã«ã¯ç•ªå·ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤ºã—ãªã„ãªã©ãŒå¿…è¦ã€‚
** ãƒ†ãƒ¼ãƒ–ãƒ«åã¨åå‰ç©ºé–“
** pluck
~pluck~ ã¯ã€å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¸¸ã”ã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ã¨ã£ã¦ãã‚‹ã®ã§ã¯ãªãã€å¼•æ•°ã§æŒ‡å®šã—ãŸã‚«ãƒ©ãƒ ã®ã¿ã® *é…åˆ—* ã§è¿”ã™ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
[[https://railsdoc.com/page/model_pluck][pluck | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]]

~select~ ã¯ã‚«ãƒ©ãƒ æŒ‡å®šã¨ã„ã†ã¨ã“ã‚ã¯åŒã˜ã ãŒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™ã€‚
** ã¾ã¨ã‚ã¦å‡¦ç†ã—ã¦é«˜é€ŸåŒ–
1ã¤1ã¤å‡¦ç†ã™ã‚‹ã®ã§ã¯ãªãã¦ã€åŒæ™‚ã«è¤‡æ•°ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‡¦ç†ã™ã‚‹ã“ã¨ã§é«˜é€ŸåŒ–ã™ã‚‹ã€‚
** è©²å½“ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãŒè«å¤§ãªå ´åˆ
ãƒ¡ãƒ¢ãƒªã«å…¨ä½“ã‚’å±•é–‹ã™ã‚‹ã®ã§ãªãã€ã‚ã‚‹æ•°ãšã¤å±•é–‹ã—ã¦ãƒ¡ãƒ¢ãƒªæ¶ˆè²»ã‚’æŠ‘ãˆã‚‹ã€‚

[[https://railsdoc.com/page/find_each][find_each | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]] ... 1ä»¶ãšã¤å‡¦ç†ã€‚
[[https://railsdoc.com/page/find_in_batches][find_in_batches | Railsãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ]] ... é…åˆ—ã§å‡¦ç†ã€‚

** ä¸¦åˆ—å‡¦ç†ã®ä¾‹
parallel gemã«ã‚ˆã£ã¦ã€‚
#+caption: ä¾‹
#+begin_src ruby
  require 'parallel'
  result = Parallel.each(1..10) do |item|
      item ** 2
  end
#+end_src
** é–‹ç™ºã«ä¾¿åˆ©ãªãƒšãƒ¼ã‚¸
- /rails/info/routes
  routesä¸€è¦§ã€‚
- /letter_opener(è‡ªåˆ†ã§è¨­å®šã™ã‚‹)
  é€ä¿¡ã—ãŸãƒ¡ãƒ¼ãƒ«ä¸€è¦§ã‚’è¦‹ã‚‰ã‚Œã‚‹ã€‚
  gemãŒå…¥ã£ã¦ã‚‹å ´åˆã€‚
  [[https://github.com/ryanb/letter_opener][ryanb/letter_opener: Preview mail in the browser instead of sending.]]
- rails/mailers/
  Action Mailerã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦‹ã‚‰ã‚Œã‚‹ã€‚
  previewã‚’æº–å‚™ã—ã¦ãŠãã¨ã„ã¡ã„ã¡é€ä¿¡ã›ãšã¨ã‚‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ€ãƒŸãƒ¼ãŒå…¥ã£ãŸæ–‡é¢ã‚’ç¢ºèªã§ãã‚‹ã€‚
** é–‹ç™ºç’°å¢ƒã§ã—ã‹ä½¿ãˆãªã„ãƒ¡ã‚½ãƒƒãƒ‰ãŒå­˜åœ¨ã™ã‚‹
~class_name~ ã¯é–‹ç™ºç’°å¢ƒã§ã—ã‹ä½¿ãˆãªã„ã€‚
gemã«ã‚ˆã£ã¦ã¯ãã†ã„ã†ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä½¿ãˆãªã„ã“ã¨ãŒã‚ã‚‹ã“ã¨ã«æ³¨æ„ã—ã¦ãŠãã€‚

- https://stackoverflow.com/questions/38776080/method-class-name-undefined-for-class-object-in-rails
#+begin_quote
class_name method is defined by yard gem. it works only development env.
#+end_quote
** rails console -s
~rails console -s~ ã¨ã—ã¦consoleèµ·å‹•ã™ã‚‹ã¨ã€sandbox-modeã«ãªã‚Šã‚³ãƒ³ã‚½ãƒ¼ãƒ«å†…ã®DBæ“ä½œãŒçµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã€‚
ä¾¿åˆ©ã€‚
** rails cã§ããªã„ã¨ã
springã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã—ã¦æ¬¡ã®ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œã‚’æ—©ãã™ã‚‹gemã€‚
ãƒ†ã‚¹ãƒˆã‚‚é«˜é€ŸåŒ–ã§ãã‚‹ã®ã§ä¾¿åˆ©ã ãŒã€ãŸã¾ã«å£Šã‚Œã¦åæ˜ ã—ãªããªã£ãŸã‚Šã™ã‚‹ã€‚

ã¾ãšspringã‚’æ­¢ã‚ã¦ç¢ºèªã™ã‚‹ã€‚
#+begin_src shell
  bundle exec spring stop
#+end_src
** system specã§TCP error ãŒã§ã‚‹ã¨ã
ãƒ†ã‚¹ãƒˆãŒã‚ã‚‹ç¨‹åº¦ã®é•·ã•ã‚’è¶…ãˆã‚‹ã¨ã€ãƒ¡ãƒ¢ãƒªã®é‡ãŒè¶³ã‚Šãªããªã£ã¦ã‚¨ãƒ©ãƒ¼ã‚’å‡ºã™ã€‚
ç‰¹ã«Macã ã¨èµ·ã“ã‚‹ã‚ˆã†ã€‚
#+begin_src shell
  ulimit -n 1024
#+end_src
** seed_fuã®lint
èµ°ã‚‰ã›ã¦ã‚¨ãƒ©ãƒ¼ãŒãªã„ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
#+begin_src ruby
namespace :db do
  namespace :seed_fu do
    desc 'Verify that all fixtures are valid'
    task lint: :environment do
      if Rails.env.test?
        conn = ActiveRecord::Base.connection

        %w[development test production].each do |env|
          conn.transaction do
            SeedFu.seed("db/fixtures/#{env}")
            raise ActiveRecord::Rollback
          end
        end
      else
        system("bundle exec rails db:seed_fu:lint RAILS_ENV='test'")
        raise if $CHILD_STATUS.exitstatus.nonzero?
      end
    end
  end
end
#+end_src
** ã©ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‹èª¿ã¹ã‚‹
ã©ã®gemã®ãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚ã‹ã‚‰ãªã„ã¨ãã« ~source_location~ ãŒä¾¿åˆ©ã€‚
https://docs.ruby-lang.org/ja/latest/method/Method/i/source_location.html
#+begin_src ruby
  character.method(:draw).source_location
#+end_src
** DBãƒªã‚»ãƒƒãƒˆ
ç’°å¢ƒã‚’æŒ‡å®šã—ã¦ã€ãƒªã‚»ãƒƒãƒˆã‚’è¡Œã†ã€‚
ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã«seed_fu gemã‚’ä½¿ã£ã¦ã„ã‚‹ã€‚

#+begin_src shell
  bundle exec rails db:migrate:reset && rails db:seed_fu
#+end_src
** ãƒ‡ã‚¤ãƒªãƒ¼ã§ã‚„ã‚‹ã“ã¨
gemã®updateã‚„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒèµ·ããŸã¨ãã«ã‚„ã‚‹ã€‚
ã©ã“ã‹ã§å®šå‹åŒ–ã—ã¦ä¸€æ°—ã«å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚
#+begin_src shell
  git checkout develop && bundle install && bundle exec rails db:migrate
#+end_src
** scope
scopeã¯ã‚¯ãƒ©ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰çš„ãªã‚„ã¤ã€‚
ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ä½¿ãˆãªã„ã€‚ ~User.scope...~
[[https://railsguides.jp/active_record_querying.html#%E3%82%B9%E3%82%B3%E3%83%BC%E3%83%97][Active Record ã‚¯ã‚¨ãƒªã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ - Railsã‚¬ã‚¤ãƒ‰]]

#+begin_quote
ã‚¹ã‚³ãƒ¼ãƒ—ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€é–¢é€£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚„ãƒ¢ãƒ‡ãƒ«ã¸ã®ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã¨ã—ã¦å‚ç…§ã•ã‚Œã‚‹ã€ã‚ˆãä½¿ç”¨ã•ã‚Œã‚‹ã‚¯ã‚¨ãƒªã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
#+end_quote
** validation
~valid?~ ã¯Action Modelã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã€‚
[[https://devdocs.io/rails~6.1/activemodel/validations#method-i-valid-3F][Ruby on Rails 6.1 / ActiveModel::Validations#valid? â€” DevDocs]]
å¼•ã£ã‹ã‹ã£ã¦ãŸã‚‰falseã«ãªã‚‹ã€‚
ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ã—ã¾ã„ãã†ã«ãªã‚‹ãƒ¡ã‚½ãƒƒãƒ‰åãªã®ã«æ³¨æ„ã€‚
** ãƒã‚¹ãƒˆã—ãŸvalidateã¯åå¿œã—ãªã„
 ç‰¹å®šã®æ¡ä»¶ã ã‘ã§ç™ºå‹•ã™ã‚‹validation + æ¡ä»¶ã€‚`with_options: if`å†…ã§`if`ã‚’ä½¿ã†ã¨ã€ä¸­ã®ifæ¡ä»¶ãŒå„ªå…ˆã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã†æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚
#+begin_src ruby
  validates :term_date, date: { after: proc { Time.zone.now } }, if: proc { |p| p.term_date? && p.sellable?  }
#+end_src
** N+1å•é¡Œ
[[id:8b69b8d4-1612-4dc5-8412-96b431fdd101][SQL]]ãŒãŸãã•ã‚“å®Ÿè¡Œã•ã‚Œã¦é…ããªã‚‹ã“ã¨ã€‚ãƒ«ãƒ¼ãƒ—ã—ã¦ã„ã‚‹ã¨ãƒ¬ã‚³ãƒ¼ãƒ‰ã®æ•°ã ã‘SQLãŒç™ºè¡Œã•ã‚Œã€ä¸€æ°—ã«é…ããªã‚‹ã€‚
includesã‚’ä½¿ã†ã¨å°‘ãªã„SQLã«ã¾ã¨ã‚ã‚‰ã‚Œã‚‹ã€‚
https://qiita.com/hirotakasasaki/items/e0be0b3fd7b0eb350327

#+caption: includesã§é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ã¾ã¨ã‚ã¦å–å¾—ã™ã‚‹
#+begin_src ruby
  Page.includes(:category)
#+end_src
** å­ã®ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹ã¨ãé–¢é€£å‰Šé™¤ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
~dependent: destroy~ ã ã¨å­ã®ãƒ‡ãƒ¼ã‚¿ã‚‚ã™ã¹ã¦ç ´å£Šã—ã¦æ•´åˆæ€§ã‚’ä¿ã¤ã€‚
ãã‚Œã§ã¯å…·åˆãŒæ‚ªã„ã¨ãã‚‚ã‚ã‚‹ã®ã§ã€æ¶ˆã•ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚
#+begin_src ruby
  has_many :contents, dependent: :restrict_with_error
#+end_src

ã‚ã‚‹ã„ã¯ã€å¤–éƒ¨ã‚­ãƒ¼ã‚’nullæ›´æ–°ã™ã‚‹æ–¹æ³•ã‚‚ã‚ã‚‹(nullableã§ã‚ã‚Œã°)ã€‚
#+begin_src ruby
  has_many :contents, dependent: :nullify
#+end_src
** æ–‡å­—åˆ—ã§è¿”ã£ã¦ãã‚‹çœŸå½å€¤ã‚’booleanã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã™ã‚‹
æ–‡å­—åˆ—ã§è¿”ã£ã¦ãã‚‹çœŸå½å€¤ã‚’ã€booleanã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦æ‰±ã„ã¨ãã€‚ActiveModelã®moduleã‚’ä½¿ç”¨ã™ã‚‹ã€‚
è¨€ã‚ã‚Œã¦ã¿ã‚‹ã¨DBã§ã¯æ–‡å­—åˆ—ã‹ã‚’ã‚ã¾ã‚Šæ„è­˜ã›ãšã«ä½¿ãˆã‚‹ã€‚
#+begin_src ruby
  ActiveModel::Type::Boolean.new.cast(value) == true
#+end_src
** slimã§æ¡ä»¶åˆ†å²
[[https://qiita.com/mishiwata1015/items/407e924263d698ddeaae][ã€Railsã€‘Slimã§å…¥ã‚Œå­ã«ãªã£ã¦ã„ã‚‹è¦ç´ ã®è¦ªã‚¿ã‚°ã®ã¿ã‚’åˆ†å²ã•ã›ã‚‹ - Qiita]]
é–‰ã˜ã‚¿ã‚°ãŒãªã„ãŸã‚éšå±¤ã®ä¸Šã ã‘æ¡ä»¶åˆ†å²ã™ã‚‹ãŸã‚ã«ã¯ç‰¹æ®Šãªæ›¸ãæ–¹ãŒå¿…è¦ã«ãªã‚‹ã€‚
#+begin_export html
- unless request.variant.present? && request.variant.include?(:phone)
  / PCã§ã®ã¿ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«
  - args = [:section, class: 'sidebar']
- else
  / ã‚¹ãƒãƒ›ã§ã¯ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã«å…¥ã‚Œã‚‹
  - args = [:section]
= content_tag(*args)
#+end_export
** migrationä¾‹
#+begin_src shell
  $ rails g migration ChangeProductPrice
#+end_src

#+begin_src ruby
  class ChangeProductsPrice < ActiveRecord::Migration[7.0]
    def up
      change_table :products do |t|
        t.change :price, :string
      end
    end

    def down
      change_table :products do |t|
        t.change :price, :integer
      end
    end
  end
#+end_src

#+begin_src shell
 $ rails g migration AddNotNullOnBooks
#+end_src

#+begin_src ruby
  class AddNotNullOnBooks < ActiveRecord::Migration[6.0]
    def up
      change_column_null :books, :user_id, false
    end

    def down
      change_column_null :books, :user_id, true
    end
  end
#+end_src
* Tasks
** TODO Advanced Rails Recipe
** TODO [[https://dxd2021.cto-a.org/program/time-table/b-3][ã‚¯ã‚½ã‚³ãƒ¼ãƒ‰å‹•ç”»ã€ŒUserã‚¯ãƒ©ã‚¹ã€ã§è€ƒãˆã‚‹æŠ€è¡“çš„è² å‚µè§£æ¶ˆã®è¦³ç‚¹/DXD2021]]
ã‚¯ã‚½ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å­¦ã¶ã€‚
** TODO loggerã‚’è‡ªå‹•ã‚ªãƒ³
Rails consoleã€‚ENVã§åˆ†å²ã™ã‚Œã°æœ¬ç•ªã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ãƒ­ã‚°ãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹ã€ã¨ã„ã†ã“ã¨ãŒã§ãã‚‹ã¯ãšã€‚
** TODO [[https://railsguides.jp/][Ruby on Rails ã‚¬ã‚¤ãƒ‰ï¼šä½“ç³»çš„ã« Rails ã‚’å­¦ã¼ã†]]
:LOGBOOK:
CLOCK: [2021-10-10 Sun 14:09]--[2021-10-10 Sun 14:43] =>  0:34
:END:
Rails ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€‚
** TODO [[https://www.codewithjason.com/understanding-factory-bot-syntax-coding-factory-bot/][Understanding Factory Bot syntax by coding your own Factory Bot - Code with Jason]]
Factory Botã®ä½œã‚Šæ–¹ã€‚
** TODO Tipsæ–‡æ›¸åŒ–
DEADLINE: <2021-12-26 Sun 22:50>
:LOGBOOK:
CLOCK: [2021-12-26 Sun 15:43]--[2021-12-26 Sun 17:40] =>  1:57
CLOCK: [2021-12-23 Thu 10:01]--[2021-12-23 Thu 10:56] =>  0:55
:END:
- 5730
* Archives
** DONE èª¤å­—
CLOSED: [2021-09-09 æœ¨ 09:18]
https://github.com/carrierwaveuploader/carrierwave/blob/a3ffc5381e70a4014b61b27b35540aa3b945910d/README.md#retry-option-for-douwload-from-remote-location

PRé€ä¿¡å®Œäº†ã€‚ä¸€å­—ã ã‘ã€‚
* References
** [[https://railsguides.jp/active_model_basics.html][Active Model ã®åŸºç¤ - Railsã‚¬ã‚¤ãƒ‰]]
ãƒ¢ãƒ‡ãƒ«ã®èª¬æ˜ã€‚
** [[https://qiita.com/jnchito/items/0ee47108972a0e302caf][æ°¸ä¹…ä¿å­˜ç‰ˆï¼ï¼Ÿä¼Šè—¤ã•ã‚“å¼ãƒ»Railsã‚¢ãƒ—ãƒªã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰æ‰‹é † - Qiita]]
ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®æµã‚Œã€‚
** [[https://tech.kitchhike.com/entry/2017/03/07/190739][DHHæµã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§å¾—ã‚‰ã‚Œã‚‹ãƒ¡ãƒªãƒƒãƒˆã¨ã€å–ã‚Šå…¥ã‚Œã‚‹ä¸Šã§ã®ãƒã‚¤ãƒ³ãƒˆ - KitchHike Tech Blog]]
ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ã©ã†ã™ã‚‹ã‹ã®æŒ‡é‡ã€‚
** [[https://github.com/ankane/strong_migrations][ankane/strong_migrations: Catch unsafe migrations in development]]
READMEã«å®‰å…¨ãªãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®èª¬æ˜ãŒã‚ã‚‹ã€‚
** [[https://tech.speee.jp/entry/2020/06/30/110000][reg-suit ã«ã‚ˆã‚‹ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã§ Rails ã‚¢ãƒ—ãƒªã® CSS æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ãŒå›ã‚Šå§‹ã‚ãŸè©± - Speee DEVELOPER BLOG]]
ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒªã‚°ãƒ¬ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆã®é‹ç”¨æ–¹æ³•ã€‚
** [[https://zenn.dev/yukito0616/articles/d3b7032e9f1e90][Only My Rails Way]]
Rails Wayã®å®šç¾©ã«ã¤ã„ã¦ã€‚
** [[https://discuss.rubyonrails.org/][Ruby on Rails Discussions - Ruby on Rails Discussions]]
Railsé–‹ç™ºã®ãƒ‡ã‚£ã‚¹ã‚«ãƒƒã‚·ãƒ§ãƒ³ã€‚
** [[https://www.slideshare.net/ockeghem/ruby-on-rails-security-142250872][Railsã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ãŸã‚ã®ã‚¦ã‚§ãƒ–ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å…¥é–€]]
ã‚ã‹ã‚Šã‚„ã™ã„ã‚¹ãƒ©ã‚¤ãƒ‰ã€‚
** [[https://techracho.bpsinc.jp/hachi8833/2020_05_13/91211][Railsé–‹ç™ºè€…ãŒæ¡ç”¨é¢æ¥ã§èã‹ã‚Œã‚‹æƒ³å®šQ&A 53å•ï¼ˆç¿»è¨³ï¼‰ï½œTechRacho by BPSæ ªå¼ä¼šç¤¾]]
ã¡ã‚ƒã‚“ã¨Railsã‚¬ã‚¤ãƒ‰ã‚’èª­ã¾ãªã„ã¨ãã¤ã„ãªã€‚
