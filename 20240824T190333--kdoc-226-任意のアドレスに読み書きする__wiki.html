<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-06-27T22:35:35Z -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KDOC 226: 任意のアドレスに読み書きする</title>
<meta name="author" content="kijimaD" />
<meta name="generator" content="Org Mode" />
<link rel='shortcut icon' type='image/x-icon' href='https://kijimad.github.io/roam/favicon.ico' /><link rel='stylesheet' href='https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css' media='print' onload='this.media="all"' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/site.css' /><link rel='stylesheet' href='https://kijimad.github.io/roam/css/code.css' /><link rel='preconnect' href='https://fonts.googleapis.com'><link rel='preconnect' href='https://fonts.gstatic.com' crossorigin><link href='https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+JP&display=swap' rel='stylesheet'>
</head>
<body>
<div id="preamble" class="status">
<div><div class="header"><div class="container"><div class="row"><div class="col-sm-12 col-md-12"><nav class="navbar navbar-light"/></div></div></div></div></div>
</div>
<div id="content" class="content">
<h1 class="title">KDOC 226: 任意のアドレスに読み書きする</h1>
<div id="outline-container-orgc99ba9d" class="outline-2">
<h2 id="orgc99ba9d"><a href="#orgc99ba9d">この文書のステータス</a></h2>
<div class="outline-text-2" id="text-orgc99ba9d">
<ul class="org-ul">
<li>作成
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-08-24 貴島</li>
</ul></li>
<li>レビュー
<ul class="org-ul">
<li class="on"><input type='checkbox' checked='checked' /> 2024-09-09 貴島</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org567fce1" class="outline-2">
<h2 id="org567fce1"><a href="#org567fce1">概要</a></h2>
<div class="outline-text-2" id="text-org567fce1">
<p>
メモリアドレスを直接指定して、値を読み書きしてみるコードを見る。
</p>

<iframe width="800px" height="200px" src="https://godbolt.org/e#g:!((g:!((g:!((h:codeEditor,i:(filename:'1',fontScale:14,fontUsePx:'0',j:1,lang:___c,selection:(endColumn:2,endLineNumber:6,positionColumn:2,positionLineNumber:6,selectionStartColumn:2,selectionStartLineNumber:6,startColumn:2,startLineNumber:6),source:'%23include+%3Cstdlib.h%3E%0A%0Aint+main()+%7B++++%0A++++*((int+*)+0x2b67)+%3D+(int)+111%3B%0A++++int+load+%3D+*((int+*)+0x2b67)%3B%0A%7D'),l:'5',n:'1',o:'C+source+%231',t:'0')),k:50,l:'4',n:'0',o:'',s:0,t:'0'),(g:!((h:compiler,i:(compiler:rv32-cgcctrunk,filters:(b:'0',binary:'1',binaryObject:'1',commentOnly:'0',debugCalls:'1',demangle:'0',directives:'0',execute:'1',intel:'1',libraryCode:'0',trim:'0',verboseDemangling:'0'),flagsViewOpen:'1',fontScale:14,fontUsePx:'0',j:1,lang:___c,libs:!(),options:'',overrides:!(),selection:(endColumn:1,endLineNumber:1,positionColumn:1,positionLineNumber:1,selectionStartColumn:1,selectionStartLineNumber:1,startColumn:1,startLineNumber:1),source:1),l:'5',n:'0',o:'+RISC-V+(32-bits)+gcc+(trunk)+(Editor+%231)',t:'0')),k:50,l:'4',n:'0',o:'',s:0,t:'0')),l:'2',n:'0',o:'',t:'0')),version:4"></iframe>

<p>
<code>0x2b67</code> アドレスに値 <code>111</code> を書き込み、後からアドレス直接指定で値を読み込むようなアセンブリが生成できている。
</p>

<p>
無効な範囲を指定すると、Segmentation Faultになり書き込みできない。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>無効な範囲を書き換えしてみると、メモリ保護機能によって Segmentation faultになる</label><pre class="src src-C"><span class="org-type">int</span> <span class="org-function-name">main</span>() {
  *((<span class="org-type">int</span> *) 0x0001) = (<span class="org-type">int</span>) 111;
}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span>変数のとりうる範囲は毎回変動する。正しい範囲を指定すると上書きできる</label><pre class="src src-C"><span class="org-type">int</span> <span class="org-function-name">main</span>() {
  <span class="org-type">int</span> <span class="org-variable-name">x</span> = 1;
  printf(<span class="org-string">"0x%08X: x -&gt; %i\n"</span>, &amp;x, x);
  *((<span class="org-type">int</span> *) &amp;x) = (<span class="org-type">int</span>) 999999;
  printf(<span class="org-string">"0x%08X: x -&gt; %i\n"</span>, &amp;x, x);
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">0x4423DD04: x -&gt; 1
0x4423DD04: x -&gt; 999999
</pre>
</div>

<p>
セグメント内なら、任意のメモリにアクセスできる。
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>セグメント内ならアドレスを指定して任意のメモリにアクセスできる。セグフォにならない範囲でintとして値を取得して調べた。マイナス方向には多く余地があるが、プラス方向には少ない</label><pre class="src src-C"><span class="org-type">int</span> <span class="org-function-name">main</span>() {
  <span class="org-type">int</span> <span class="org-variable-name">x</span> = 2;
  printf(<span class="org-string">"0x%08X: x -&gt; %i\n"</span>, &amp;x, x);
  <span class="org-type">int</span> <span class="org-variable-name">load1</span> = *((<span class="org-type">int</span> *) &amp;x-0x100000);
  <span class="org-type">int</span> <span class="org-variable-name">load2</span> = *((<span class="org-type">int</span> *) &amp;x+0x100);
  <span class="org-type">int</span> <span class="org-variable-name">load3</span> = *((<span class="org-type">int</span> *) &amp;x+0x2);
  printf(<span class="org-string">"load1(-0x100000): 0x%08X\n"</span>, load1);
  printf(<span class="org-string">"load2(+0x100): 0x%08X\n"</span>, load2);
  printf(<span class="org-string">"load3(+0x2): 0x%08X\n"</span>, load3);
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">0x9EBD7178: x -&gt; 2
load1(-0x100000): 0x00000000
load2(+0x100): 0x00001000
load3(+0x2): 0x00001000
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>直にアドレスを指定して取得する</label><pre class="src src-C"><span class="org-type">int</span> <span class="org-function-name">main</span>() {
  <span class="org-type">char</span> <span class="org-variable-name">base</span> = 0;
  <span class="org-type">char</span> <span class="org-variable-name">a</span> = <span class="org-string">'a'</span>;
  <span class="org-type">char</span> <span class="org-variable-name">b</span> = <span class="org-string">'b'</span>;
  <span class="org-type">char</span> <span class="org-variable-name">c</span> = <span class="org-string">'c'</span>;

  printf(<span class="org-string">"0x%08X: base\n"</span>, &amp;base);
  printf(<span class="org-string">"0x%08X: a\n"</span>, &amp;a);
  printf(<span class="org-string">"0x%08X: b\n"</span>, &amp;b);
  printf(<span class="org-string">"0x%08X: c\n"</span>, &amp;c);
  printf(<span class="org-string">"\n"</span>);
  printf(<span class="org-string">"a: 0x%08X\n"</span>, *((<span class="org-type">char</span> *) &amp;base+0x1));
  printf(<span class="org-string">"b: 0x%08X\n"</span>, *((<span class="org-type">char</span> *) &amp;base+0x2));
  printf(<span class="org-string">"c: 0x%08X\n"</span>, *((<span class="org-type">char</span> *) &amp;base+0x3));
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-nil">0x5FD01F44: base
0x5FD01F45: a
0x5FD01F46: b
0x5FD01F47: c

a: 0x00000061
b: 0x00000062
c: 0x00000063
</pre>
</div>
</div>
</div>
<div id="outline-container-org6f50867" class="outline-2">
<h2 id="org6f50867"><a href="#org6f50867">関連</a></h2>
<div class="outline-text-2" id="text-org6f50867">
<ul class="org-ul">
<li><a href="20240717T223527--kdoc-202-『30日でできる-os自作入門』__book.html#ID-20240717T223527">KDOC 202: 『30日でできる! OS自作入門』</a>。出てきたコードを確認した</li>
</ul>
</div>
</div>
<div id="outline-container-orgdbace80" class="outline-2">
<h2 id="orgdbace80"><a href="#orgdbace80">Backlinks</a></h2>
<div class="outline-text-2" id="text-orgdbace80">
<ul class="org-ul">
<li><a href="./20240825T193415--kdoc-228-変数を書いた順番とアドレスの関係はコンパイラによって異なる__wiki.html">KDOC 228: 変数を書いた順番とアドレスの関係はコンパイラによって異なる</a></li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<footer class="footer py-3"><div class="container"><div class="row "><div class="col-md-4"></div><div class="col-sm col-md"><nav class="navbar"><a class="nav-link text-secondary small px-0" href="./index.html">Insomnia</a><a class="nav-link text-secondary small px-0" href="./sitemap.html">Sitemap</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD/roam">Repository</a><a class="nav-link text-secondary small px-0" href="https://github.com/kijimaD">@kijimaD</a></nav></div><div class="col-md-4"></div></div></div></footer>
</div>
</body>
</html>
